{"version":3,"mappings":"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","names":["API_BASE_URL","API_KEY","getFtpHistory","userId","headers","response","renderLineChart","container","data","options","height","color","padTop","padBottom","padLeft","padRight","processedData","downsample","xValues","p","yValues","minX","maxX","minY","maxY","yRange","width","getX","val","getY","pathD","areaD","gridLines","yStep","i","y","startTimeStr","formatTime","midTimeStr","endTimeStr","svg","target","step","result","ms","totalSeconds","h","m","s","renderBarChart","barGap","availableWidth","barWidth","index","bars","x","labelStep","xLabels","date","label","emptyStats","getSummary","workout","currentWorkouts","trendMetric","renderPeriodStatistics","containerId","workouts","statsContainer","renderSummaryTable","renderTrendsChart","parent","card","now","startOfWeek","day","startOfLastWeek","endOfLastWeek","startOfMonth","startOfLastMonth","endOfLastMonth","startOfYear","periods","w","summary","buckets","stat","dur","renderCell","rows","v","formatDuration","row","e","updateChart","select","weeks","d","weekKey","getWeekKey","points","a","b","key","year","week","getDateFromWeek","title","dayNum","yearStart","weekNo","diff","cropWorkout","measurements","originalStartTime","newStartTime","newEndTime","start","end","filterMeasurements","croppedMeasurements","t","l","duration","modalSummary","calculateWorkoutSummary","first","last","currentPage","totalPages","dbAvailable","filterType","filterStartDate","filterEndDate","currentView","calendarDate","dataSource","initHistoryLogic","prevBtn","nextBtn","refreshBtn","typeFilter","dateStart","dateEnd","viewListBtn","viewCalendarBtn","viewAnalyticsBtn","listView","calendarView","analyticsView","prevMonthBtn","nextMonthBtn","sourceCloudBtn","sourceLocalBtn","setSource","checkDatabaseAvailability","setView","view","loadWorkouts","loadCalendar","loadAnalytics","handleFilterChange","historyButton","hasIndexedDB","isIndexedDBSupported","isDatabaseAvailable","updateSourceToggle","storedToWorkout","stored","listContainer","pageInfo","getCompletedWorkouts","total","listWorkouts","pagination","renderWorkoutCard","workoutId","viewWorkoutDetails","confirmDeleteWorkout","syncWorkout","error","message","cloudBtn","localBtn","localId","local","announce","createRes","createWorkout","formatDate","completeWorkout","markWorkoutSynced","statusClass","syncBtn","detailPanel","listPanel","getWorkout","renderWorkoutDetail","renderWorkoutCharts","exportWorkoutData","startCropTool","filename","jsonData","jsonBlob","jsonUrl","jsonLink","deleteWorkout","calendarGrid","monthLabel","monthNames","month","startDate","endDate","renderCalendar","renderMonthlyStats","firstDay","daysInMonth","empty","dayCell","wDate","dot","icon","today","totalWorkouts","totalDuration","acc","totalDistance","totalEnergy","prList","ftpHistory","renderAnalytics","renderPersonalRecords","renderTrainingLoad","renderPowerCurve","renderFitnessTrend","renderFtpHistory","renderPrHistory","maxPower","maxHr","longestRide","maxDistance","dateStr","createRow","value","id","weekNum","getWeekNumber","maxLoad","load","bests","durations","pad","maxWatts","formatDurationLabel","sec","sorted","tssMap","current","dataPoints","kCTL","kATL","ctl","atl","tss","chartW","chartH","maxVal","timeSpan","ctlPath","atlPath","history","maxFtp","minFtp","ftpRange","currX","prevY","currY","events","powerCurveBests","notable","labels","reversedEvents","refreshHistoryView","telemetryJson","startTimeIso","startTs","powerContainer","hrContainer","cadContainer","altContainer","validPoints","originalStart","originalEnd","currentStart","currentEnd","durationMs","sliderStart","sliderEnd","displayStart","displayEnd","displayDuration","chartContainer","renderPreview","updateUI","startOffset","endOffset","btn","saveCompletedWorkout","__vitePreload","n","HistoryView","template","content"],"ignoreList":[],"sources":["../../src/api/userClient.ts","../../src/ui/charts.ts","../../src/ui/statistics.ts","../../src/utils/cropWorkout.ts","../../src/ui/workoutHistory.ts","../../src/views/HistoryView.ts"],"sourcesContent":["/**\n * API client for user operations\n * Handles communication with the user API including FTP history\n *\n * @module userClient\n */\n\nconst API_BASE_URL: string = import.meta.env.VITE_API_URL || '';\nconst API_KEY: string | undefined = import.meta.env.VITE_API_KEY;\n\nexport interface FtpHistoryEntry {\n    id: string;\n    userId: string;\n    ftp: number;\n    source: string | null;\n    createdAt: string;\n}\n\nexport interface UserSettings {\n    theme?: 'light' | 'dark' | 'system';\n    units?: 'metric' | 'imperial';\n    notifications?: boolean;\n    ftp?: number;\n}\n\n/**\n * Get user FTP history\n */\nexport async function getFtpHistory(userId: string): Promise<FtpHistoryEntry[]> {\n    const headers: Record<string, string> = {\n        'Content-Type': 'application/json'\n    };\n\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n\n    const response = await fetch(`${API_BASE_URL}/api/users/${userId}/ftp-history`, {\n        headers\n    });\n\n    if (!response.ok) {\n        throw new Error(`Failed to fetch FTP history: ${response.statusText}`);\n    }\n\n    return response.json();\n}\n\n/**\n * Update user FTP\n */\nexport async function updateUserFtp(userId: string, ftp: number, source: string = 'manual'): Promise<{ ftp: number }> {\n    const headers: Record<string, string> = {\n        'Content-Type': 'application/json'\n    };\n\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n\n    const response = await fetch(`${API_BASE_URL}/api/users/${userId}/ftp`, {\n        method: 'PUT',\n        headers,\n        body: JSON.stringify({ ftp, source })\n    });\n\n    if (!response.ok) {\n        throw new Error(`Failed to update FTP: ${response.statusText}`);\n    }\n\n    return response.json();\n}\n","/**\n * Simple SVG Charting Library for Bike Power Tracker\n * \n * Renders lightweight SVG charts for workout analysis.\n * \n * @module ui/charts\n */\n\nexport interface Point {\n    x: number; // Timestamp or relative time\n    y: number; // Value\n}\n\nexport interface ChartOptions {\n    color?: string;\n    height?: number;\n    title?: string;\n    yLabel?: string;\n    xLabel?: string;\n    yMin?: number;\n    yMax?: number;\n}\n\n/**\n * Render a simple line chart into a container\n */\nexport function renderLineChart(container: HTMLElement, data: Point[], options: ChartOptions = {}): void {\n    if (!container) return;\n\n    // Configuration\n    const height = options.height || 200;\n    const color = options.color || 'var(--color-accent)';\n    const padTop = 20;\n    const padBottom = 30;\n    const padLeft = 40;\n    const padRight = 10;\n\n    // Handle empty data\n    if (!data || data.length < 2) {\n        container.innerHTML = `\n            <div style=\"\n                display:flex; \n                justify-content:center; \n                align-items:center; \n                height:${height}px; \n                color: var(--color-text-secondary);\n                background: var(--card-bg);\n                border-radius: 8px;\n            \">\n                No data available\n            </div>\n        `;\n        return;\n    }\n\n    // Downsample if too many points (limit to ~500 points for performance)\n    const processedData = downsample(data, 500);\n\n    // Get value ranges\n    const xValues = processedData.map(p => p.x);\n    const yValues = processedData.map(p => p.y);\n\n    const minX = Math.min(...xValues);\n    const maxX = Math.max(...xValues);\n    let minY = options.yMin ?? Math.min(...yValues);\n    let maxY = options.yMax ?? Math.max(...yValues);\n\n    // Add some headroom to Y axis\n    const yRange = maxY - minY;\n    if (yRange === 0) {\n        maxY += 10;\n        minY -= 10;\n    } else {\n        // If not fixed to 0, add padding. If usually 0-based (like power), kept 0.\n        if (options.yMin === undefined) {\n            // If data is far from 0, don't force 0, but add padding\n            minY -= yRange * 0.1;\n        }\n        maxY += yRange * 0.1;\n    }\n\n    // Get container width\n    const width = container.clientWidth || container.parentElement?.clientWidth || 600;\n\n    // Helper to map values to coordinates\n    const getX = (val: number) => padLeft + ((val - minX) / (maxX - minX)) * (width - padLeft - padRight);\n    const getY = (val: number) => height - padBottom - ((val - minY) / (maxY - minY)) * (height - padTop - padBottom);\n\n    // Generate Path\n    const pathD = `M ${processedData.map(p => `${getX(p.x).toFixed(1)},${getY(p.y).toFixed(1)}`).join(' L ')}`;\n\n    // Generate Area fill (optional, looks nice)\n    const areaD = `${pathD} L ${getX(processedData[processedData.length - 1].x).toFixed(1)},${height - padBottom} L ${getX(processedData[0].x).toFixed(1)},${height - padBottom} Z`;\n\n    // Generate Grid Lines\n    // Y-Axis: 5 lines\n    const gridLines = [];\n    const yStep = (maxY - minY) / 4;\n    for (let i = 0; i <= 4; i++) {\n        const val = minY + (i * yStep);\n        const y = getY(val);\n        gridLines.push(`\n            <line x1=\"${padLeft}\" y1=\"${y}\" x2=\"${width - padRight}\" y2=\"${y}\" stroke=\"var(--color-border)\" stroke-width=\"1\" stroke-dasharray=\"4\" opacity=\"0.5\" />\n            <text x=\"${padLeft - 5}\" y=\"${y + 4}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${Math.round(val)}</text>\n        `);\n    }\n\n    // X-Axis: Time labels (Start, Middle, End)\n    const startTimeStr = formatTime(0); // Relative time 0\n    const midTimeStr = formatTime((maxX - minX) / 2);\n    const endTimeStr = formatTime(maxX - minX);\n\n    // Construct SVG\n    const svg = `\n        <svg width=\"100%\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\" style=\"background: var(--card-bg); border-radius: 8px;\">\n            <defs>\n                <linearGradient id=\"chartGradient-${options.title?.replace(/\\s/g, '')}\" x1=\"0\" x2=\"0\" y1=\"0\" y2=\"1\">\n                    <stop offset=\"0%\" stop-color=\"${color}\" stop-opacity=\"0.2\"/>\n                    <stop offset=\"100%\" stop-color=\"${color}\" stop-opacity=\"0\"/>\n                </linearGradient>\n            </defs>\n\n            <!-- Grid -->\n            ${gridLines.join('')}\n\n            <!-- Axis Labels -->\n            <text x=\"${padLeft}\" y=\"${height - 10}\" text-anchor=\"start\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${startTimeStr}</text>\n            <text x=\"${width / 2}\" y=\"${height - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${midTimeStr}</text>\n            <text x=\"${width - padRight}\" y=\"${height - 10}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${endTimeStr}</text>\n\n            <!-- Data Area -->\n            <path d=\"${areaD}\" fill=\"url(#chartGradient-${options.title?.replace(/\\s/g, '')})\" stroke=\"none\" />\n            \n            <!-- Data Line -->\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"${color}\" stroke-width=\"2\" vector-effect=\"non-scaling-stroke\" />\n\n            <!-- Title -->\n            ${options.title ? `<text x=\"${width / 2}\" y=\"${15}\" text-anchor=\"middle\" font-weight=\"bold\" font-size=\"12\" fill=\"var(--color-text-primary)\">${options.title}</text>` : ''}\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n\n/**\n * Reduce approximate number of points to target using simple N-th sampling\n */\nfunction downsample(data: Point[], target: number): Point[] {\n    if (data.length <= target) return data;\n    const step = Math.ceil(data.length / target);\n    const result = [];\n    for (let i = 0; i < data.length; i += step) {\n        result.push(data[i]);\n    }\n    return result;\n}\n\n/**\n * Format milliseconds to HH:MM:SS or MM:SS\n */\nfunction formatTime(ms: number): string {\n    const totalSeconds = Math.floor(ms / 1000);\n    const h = Math.floor(totalSeconds / 3600);\n    const m = Math.floor((totalSeconds % 3600) / 60);\n    const s = totalSeconds % 60;\n\n    if (h > 0) {\n        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;\n    }\n    return `${m}:${s.toString().padStart(2, '0')}`;\n}\n\n/**\n * Render a simple bar chart into a container\n */\nexport function renderBarChart(container: HTMLElement, data: Point[], options: ChartOptions = {}): void {\n    if (!container) return;\n\n    // Configuration\n    const height = options.height || 200;\n    const color = options.color || 'var(--color-accent)';\n    const padTop = 30;\n    const padBottom = 30;\n    const padLeft = 40;\n    const padRight = 10;\n    const barGap = 4;\n\n    // Handle empty data\n    if (!data || data.length === 0) {\n        container.innerHTML = `\n            <div style=\"\n                display:flex; \n                justify-content:center; \n                align-items:center; \n                height:${height}px; \n                color: var(--color-text-secondary);\n                background: var(--card-bg);\n                border-radius: 8px;\n            \">\n                No data available\n            </div>\n        `;\n        return;\n    }\n\n    // Process Values\n    const yValues = data.map(p => p.y);\n    let maxY = options.yMax ?? (Math.max(...yValues) * 1.1); // 10% headroom\n    let minY = options.yMin ?? 0;\n\n    if (maxY === minY) maxY += 10;\n\n    // Get container width\n    const width = container.clientWidth || container.parentElement?.clientWidth || 600;\n\n    // Calculate bar dimensions\n    const availableWidth = width - padLeft - padRight;\n    // Ensure minimum bar width of 2px\n    const barWidth = Math.max(2, (availableWidth / data.length) - barGap);\n\n    const getX = (index: number) => padLeft + (index * (barWidth + barGap)) + (barGap / 2); // Center in slot\n    const getY = (val: number) => height - padBottom - ((val - minY) / (maxY - minY)) * (height - padTop - padBottom);\n\n    const bars = data.map((p, i) => {\n        const x = getX(i);\n        const y = getY(p.y);\n        const h = Math.max(0, (height - padBottom) - y); // Prevent negative height\n\n        // Don't render bars with 0 height or weird coordinates\n        if (h <= 0 || isNaN(y) || isNaN(h)) return '';\n\n        return `<rect x=\"${x.toFixed(1)}\" y=\"${y.toFixed(1)}\" width=\"${barWidth.toFixed(1)}\" height=\"${h.toFixed(1)}\" fill=\"${color}\" rx=\"2\" opacity=\"0.8\" />`;\n    });\n\n    // Generate Labels (simplified X axis labels)\n    // Reduce labels if too many\n    const maxLabels = 7;\n    const labelStep = Math.max(1, Math.floor(data.length / maxLabels));\n\n    const xLabels = data.map((p, i) => {\n        if (i % labelStep !== 0) return '';\n        // Date formatting based on X value (timestamp)\n        const date = new Date(p.x);\n        // Short date format DD/MM\n        const label = `${date.getDate()}/${date.getMonth() + 1}`;\n        const x = getX(i) + (barWidth / 2);\n        return `<text x=\"${x.toFixed(1)}\" y=\"${height - 5}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${label}</text>`;\n    });\n\n    // Generate Y Grid and Labels\n    const gridLines = [];\n    const yStep = (maxY - minY) / 4;\n    for (let i = 0; i <= 4; i++) {\n        const val = minY + (i * yStep);\n        const y = getY(val);\n        gridLines.push(`\n            <line x1=\"${padLeft}\" y1=\"${y}\" x2=\"${width - padRight}\" y2=\"${y}\" stroke=\"var(--color-border)\" stroke-width=\"1\" stroke-dasharray=\"4\" opacity=\"0.3\" />\n            <text x=\"${padLeft - 5}\" y=\"${y + 4}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${Math.round(val)}</text>\n        `);\n    }\n\n    const svg = `\n        <svg width=\"100%\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\" style=\"background: var(--card-bg); border-radius: 8px;\">\n            ${gridLines.join('')}\n            ${bars.join('')}\n            ${xLabels.join('')}\n            <!-- Axis Lines -->\n            <line x1=\"${padLeft}\" y1=\"${padTop}\" x2=\"${padLeft}\" y2=\"${height - padBottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${padLeft}\" y1=\"${height - padBottom}\" x2=\"${width - padRight}\" y2=\"${height - padBottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <!-- Title -->\n             ${options.title ? `<text x=\"${width / 2}\" y=\"15\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"bold\" fill=\"var(--color-text-primary)\">${options.title}</text>` : ''}\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n","/**\n * Statistics View Component\n * \n * Aggregates and renders workout statistics across different time periods.\n * \n * @module ui/statistics\n */\n\nimport type { Workout } from '../api/workoutClient.js';\nimport type { WorkoutSummary } from '../types/measurements.js';\nimport { formatDuration } from '../api/workoutClient.js';\nimport { renderBarChart, type Point } from './charts.js';\n\ninterface PeriodStats {\n    count: number;\n    distance: number;\n    duration: number;\n    elevation: number;\n    energy: number;\n\n    avgPower: number;\n    avgHr: number;\n    avgCadence: number;\n\n    weightedPowerSum: number; // for calculating avg power across varying durations\n    weightedHrSum: number;\n    weightedCadenceSum: number;\n    totalDurationForAvg: number;\n}\n\nconst emptyStats = (): PeriodStats => ({\n    count: 0,\n    distance: 0,\n    duration: 0,\n    elevation: 0,\n    energy: 0,\n    avgPower: 0,\n    avgHr: 0,\n    avgCadence: 0,\n    weightedPowerSum: 0,\n    weightedHrSum: 0,\n    weightedCadenceSum: 0,\n    totalDurationForAvg: 0\n});\n\nfunction getSummary(workout: Workout): Partial<WorkoutSummary> {\n    if (!workout.summary) return {};\n    if (typeof workout.summary === 'string') {\n        try {\n            return JSON.parse(workout.summary);\n        } catch {\n            return {};\n        }\n    }\n    return workout.summary as unknown as WorkoutSummary;\n}\n\n/**\n * State for the statistics view\n */\nlet currentWorkouts: Workout[] = [];\nlet trendMetric: 'distance' | 'duration' | 'energy' | 'count' = 'distance';\n\n/**\n * Main function to render statistics into a container\n */\nexport function renderPeriodStatistics(containerId: string, workouts: Workout[]): void {\n    const container = document.getElementById(containerId);\n    if (!container) return;\n\n    // Update state\n    currentWorkouts = workouts;\n\n    // Check if we already injected our specific container\n    let statsContainer = document.getElementById('periodStatsContainer');\n    if (!statsContainer) {\n        statsContainer = document.createElement('div');\n        statsContainer.id = 'periodStatsContainer';\n        statsContainer.style.display = 'grid';\n        statsContainer.style.gap = '16px';\n        statsContainer.style.marginBottom = '20px';\n\n        // Insert at the top of the analytics view\n        container.insertBefore(statsContainer, container.firstChild);\n    }\n\n    // 1. Render Summary Table Card\n    renderSummaryTable(statsContainer, workouts);\n\n    // 2. Render Trends Chart Card\n    renderTrendsChart(statsContainer);\n}\n\n/**\n * Render the summary comparison table\n */\nfunction renderSummaryTable(parent: HTMLElement, workouts: Workout[]): void {\n    let card = document.getElementById('statsTableCard');\n    if (!card) {\n        card = document.createElement('div');\n        card.id = 'statsTableCard';\n        card.className = 'card';\n        card.style.background = 'var(--card-bg)';\n        card.style.padding = '16px';\n        card.style.borderRadius = '8px';\n        card.style.border = '1px solid var(--color-border)';\n        parent.appendChild(card);\n    }\n\n    // Constants for periods\n    const now = new Date();\n\n    // Define time ranges\n    // This Week (starts Monday)\n    const startOfWeek = new Date(now);\n    const day = startOfWeek.getDay() || 7; // getDay returns 0 for Sunday\n    if (day !== 1) startOfWeek.setHours(-24 * (day - 1));\n    else startOfWeek.setHours(0, 0, 0, 0);\n    startOfWeek.setHours(0, 0, 0, 0);\n\n    const startOfLastWeek = new Date(startOfWeek);\n    startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);\n    const endOfLastWeek = new Date(startOfWeek);\n\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);\n\n    const startOfYear = new Date(now.getFullYear(), 0, 1);\n\n    // Buckets\n    const periods: Record<'thisWeek' | 'lastWeek' | 'thisMonth' | 'lastMonth' | 'thisYear', PeriodStats> = {\n        thisWeek: emptyStats(),\n        lastWeek: emptyStats(),\n        thisMonth: emptyStats(),\n        lastMonth: emptyStats(),\n        thisYear: emptyStats()\n    };\n\n    // Aggregate Data\n    workouts.forEach(w => {\n        const date = new Date(w.startTime);\n        const summary = getSummary(w);\n\n        // Determine which buckets this workout belongs to\n        const buckets: PeriodStats[] = [];\n\n        if (date >= startOfWeek) buckets.push(periods.thisWeek);\n        if (date >= startOfLastWeek && date < endOfLastWeek) buckets.push(periods.lastWeek);\n        if (date >= startOfMonth) buckets.push(periods.thisMonth);\n        if (date >= startOfLastMonth && date <= endOfLastMonth) buckets.push(periods.lastMonth);\n        if (date >= startOfYear) buckets.push(periods.thisYear);\n\n        // Add to buckets\n        buckets.forEach(stat => {\n            stat.count++;\n            stat.duration += (w.duration || 0);\n            stat.distance += (summary.totalDistance || 0);\n            stat.elevation += (summary.totalElevationGain || 0);\n\n            // Energy\n            if (summary.totalEnergy) {\n                stat.energy += summary.totalEnergy;\n            } else if (summary.avgPower && w.duration) {\n                stat.energy += (summary.avgPower * w.duration) / 1000;\n            }\n\n            // Weighted Averages\n            const dur = w.duration || 0;\n            if (dur > 0) {\n                if (summary.avgPower) stat.weightedPowerSum += summary.avgPower * dur;\n                if (summary.avgHeartrate) stat.weightedHrSum += summary.avgHeartrate * dur;\n                if (summary.avgCadence) stat.weightedCadenceSum += summary.avgCadence * dur;\n                stat.totalDurationForAvg += dur;\n            }\n        });\n    });\n\n    // Finalize Averages\n    Object.values(periods).forEach(stat => {\n        if (stat.totalDurationForAvg > 0) {\n            stat.avgPower = Math.round(stat.weightedPowerSum / stat.totalDurationForAvg);\n            stat.avgHr = Math.round(stat.weightedHrSum / stat.totalDurationForAvg);\n            stat.avgCadence = Math.round(stat.weightedCadenceSum / stat.totalDurationForAvg);\n        }\n    });\n\n    // Helpers\n    const renderCell = (val: string) =>\n        `<td style=\"padding: 8px; text-align: right; border-bottom: 1px solid var(--color-border);\">${val}</td>`;\n\n    const formatDist = (m: number) => (m / 1000).toFixed(1) + ' km';\n\n    interface RowDef {\n        label: string;\n        key: keyof PeriodStats;\n        fmt: (v: number) => string;\n    }\n\n    const rows: RowDef[] = [\n        { label: 'Workouts', key: 'count', fmt: (v: number) => v.toString() },\n        { label: 'Distance', key: 'distance', fmt: formatDist },\n        { label: 'Time', key: 'duration', fmt: (v: number) => formatDuration(v) },\n        { label: 'Elevation', key: 'elevation', fmt: (v: number) => v + ' m' },\n        { label: 'Avg Power', key: 'avgPower', fmt: (v: number) => v + ' W' },\n        { label: 'Avg HR', key: 'avgHr', fmt: (v: number) => v + ' bpm' },\n        { label: 'Energy', key: 'energy', fmt: (v: number) => Math.round(v) + ' kJ' },\n    ];\n\n    card.innerHTML = `\n        <h4 style=\"margin: 0 0 12px 0;\"> Period Statistics</h4>\n        <div style=\"overflow-x: auto;\">\n            <table style=\"width: 100%; border-collapse: collapse; font-size: 0.9em;\">\n                <thead>\n                    <tr style=\"background: var(--color-bg-secondary);\">\n                        <th style=\"text-align: left; padding: 8px; border-bottom: 2px solid var(--color-border);\">Metric</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Week</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border); color: var(--color-text-secondary);\">Last Week</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Month</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border); color: var(--color-text-secondary);\">Last Month</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Year</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${rows.map(row => `\n                        <tr>\n                            <td style=\"padding: 8px; font-weight: 500; border-bottom: 1px solid var(--color-border);\">${row.label}</td>\n                            ${renderCell(row.fmt(periods.thisWeek[row.key] as number))}\n                            ${renderCell(row.fmt(periods.lastWeek[row.key] as number))}\n                            ${renderCell(row.fmt(periods.thisMonth[row.key] as number))}\n                            ${renderCell(row.fmt(periods.lastMonth[row.key] as number))}\n                            ${renderCell(row.fmt(periods.thisYear[row.key] as number))}\n                        </tr>\n                    `).join('')}\n                </tbody>\n            </table>\n        </div>\n    `;\n}\n\n/**\n * Render the weekly trends chart\n */\nfunction renderTrendsChart(parent: HTMLElement): void {\n    let card = document.getElementById('statsChartCard');\n\n    // Create card if not exists\n    if (!card) {\n        card = document.createElement('div');\n        card.id = 'statsChartCard';\n        card.className = 'card';\n        card.style.background = 'var(--card-bg)';\n        card.style.padding = '16px';\n        card.style.borderRadius = '8px';\n        card.style.border = '1px solid var(--color-border)';\n\n        // Initial HTML structure with header and controls\n        card.innerHTML = `\n            <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;\">\n                <h4 style=\"margin: 0;\"> Weekly Trends (Last 12 Weeks)</h4>\n                <select id=\"trendMetricSelect\" style=\"padding: 4px; border-radius: 4px; border: 1px solid var(--color-border);\">\n                    <option value=\"distance\">Distance</option>\n                    <option value=\"duration\">Time</option>\n                    <option value=\"energy\">Energy</option>\n                    <option value=\"count\">Workouts</option>\n                </select>\n            </div>\n            <div id=\"trendChartContainer\" style=\"height: 200px;\"></div>\n        `;\n\n        parent.appendChild(card);\n\n        // Add event listener\n        const select = card.querySelector('#trendMetricSelect') as HTMLSelectElement;\n        select?.addEventListener('change', (e) => {\n            trendMetric = (e.target as HTMLSelectElement).value as typeof trendMetric;\n            updateChart();\n        });\n    }\n\n    updateChart();\n}\n\n/**\n * Update the chart content based on current state\n */\nfunction updateChart(): void {\n    const container = document.getElementById('trendChartContainer');\n    if (!container) return;\n\n    const select = document.getElementById('trendMetricSelect') as HTMLSelectElement | null;\n    if (select) select.value = trendMetric; // Sync UI\n\n    // Aggregate data by week for the last 12 weeks\n    const weeks: Record<string, number> = {};\n    const now = new Date();\n\n    // Initialize 12 weeks with 0\n    for (let i = 11; i >= 0; i--) {\n        const d = new Date(now);\n        d.setDate(d.getDate() - (i * 7));\n        const weekKey = getWeekKey(d);\n        weeks[weekKey] = 0;\n    }\n\n    // Fill data\n    currentWorkouts.forEach(w => {\n        const date = new Date(w.startTime);\n        const weekKey = getWeekKey(date);\n\n        if (weeks.hasOwnProperty(weekKey)) {\n            const summary = getSummary(w);\n\n            switch (trendMetric) {\n                case 'distance':\n                    weeks[weekKey] += (summary.totalDistance || 0) / 1000; // km\n                    break;\n                case 'duration':\n                    weeks[weekKey] += (w.duration || 0); // seconds\n                    break;\n                case 'energy':\n                    if (summary.totalEnergy) {\n                        weeks[weekKey] += summary.totalEnergy;\n                    } else if (summary.avgPower && w.duration) {\n                        weeks[weekKey] += (summary.avgPower * w.duration) / 1000;\n                    }\n                    break;\n                case 'count':\n                    weeks[weekKey] += 1;\n                    break;\n            }\n        }\n    });\n\n    // Convert to points\n    const points: Point[] = Object.entries(weeks)\n        .sort((a, b) => a[0].localeCompare(b[0]))\n        .map(([key, val]) => {\n            // weekKey is \"YYYY-Www\", parse to timestamp for x-axis\n            const [year, week] = key.split('-W').map(Number);\n            // Rough approximation of week start date for chart x-axis\n            const d = getDateFromWeek(year, week);\n            return { x: d.getTime(), y: val };\n        });\n\n    // Chart options\n    let title = '';\n\n    switch (trendMetric) {\n        case 'distance': title = 'Distance (km)'; break;\n        case 'duration': title = 'Time (hours)'; break; // Chart formatter might need update for hours?\n        case 'energy': title = 'Energy (kJ)'; break;\n        case 'count': title = 'Number of Workouts'; break;\n    }\n\n    // Special formatting for duration\n    if (trendMetric === 'duration') {\n        points.forEach(p => p.y = p.y / 3600); // Convert seconds to hours\n    }\n\n    renderBarChart(container, points, {\n        title,\n        height: 200,\n        color: 'var(--color-accent)'\n    });\n}\n\n/**\n * Get ISO week string \"YYYY-Www\"\n */\nfunction getWeekKey(date: Date): string {\n    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    const dayNum = d.getUTCDay() || 7;\n    d.setUTCDate(d.getUTCDate() + 4 - dayNum);\n    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    const weekNo = Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);\n    return `${d.getUTCFullYear()}-W${weekNo.toString().padStart(2, '0')}`;\n}\n\n/**\n * Get date object from year and week number\n */\nfunction getDateFromWeek(year: number, week: number): Date {\n    const d = new Date(year, 0, 1 + (week - 1) * 7);\n    const day = d.getDay();\n    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday\n    return new Date(d.setDate(diff));\n}","/**\n * Workout Cropping Utility\n * \n * Provides functionality to crop workout data (measurements) based on start and end timestamps.\n * Recalculates summary statistics after cropping.\n * \n * @module utils/cropWorkout\n */\n\nimport type { MeasurementsData, Measurement, GpsPoint, TreadmillMeasurement, LapMarker, WorkoutSummary } from '../types/measurements.js';\nimport { calculateWorkoutSummary, type WorkoutSummary as ModalWorkoutSummary } from '../ui/modal.js';\n\n/**\n * Result of a crop operation\n */\nexport interface CroppedWorkoutData {\n    startTime: number;\n    endTime: number;\n    duration: number;\n    measurements: MeasurementsData;\n    summary: WorkoutSummary;\n}\n\n/**\n * Crops workout measurements to a specific time range.\n * \n * @param measurements Original measurement data\n * @param originalStartTime The original start time of the workout (ms)\n * @param newStartTime New start time (ms) - absolute timestamp, must be >= originalStartTime\n * @param newEndTime New end time (ms) - absolute timestamp, must be <= originalEndTime\n * @returns Cropped measurements and recalculated summary\n */\nexport function cropWorkout(\n    measurements: MeasurementsData,\n    originalStartTime: number,\n    newStartTime: number,\n    newEndTime: number\n): CroppedWorkoutData {\n\n    // Ensure bounds are valid\n    const start = Math.max(originalStartTime, newStartTime);\n    const end = Math.max(start, newEndTime);\n\n    // Filter function for standard Measurement[]\n    const filterMeasurements = (data: Measurement[]) => {\n        return data.filter(m => m.timestamp >= start && m.timestamp <= end);\n    };\n\n    // Filter specific types\n    const croppedMeasurements: MeasurementsData = {\n        heartrate: filterMeasurements(measurements.heartrate || []),\n        power: filterMeasurements(measurements.power || []),\n        cadence: filterMeasurements(measurements.cadence || []),\n        speed: filterMeasurements(measurements.speed || []),\n        distance: filterMeasurements(measurements.distance || []),\n        altitude: filterMeasurements(measurements.altitude || []),\n        gps: (measurements.gps || []).filter((p: GpsPoint) => p.timestamp >= start && p.timestamp <= end),\n        treadmill: (measurements.treadmill || []).filter((t: TreadmillMeasurement) => t.timestamp >= start && t.timestamp <= end),\n        treadmillSpeed: filterMeasurements(measurements.treadmillSpeed || []),\n        laps: (measurements.laps || []).filter((l: LapMarker) => l.timestamp >= start && l.timestamp <= end)\n    };\n\n    // Calculate new duration (seconds)\n    const duration = Math.floor((end - start) / 1000);\n\n    // Recalculate summary using modal's calculator\n    const modalSummary: ModalWorkoutSummary = calculateWorkoutSummary(\n        start,\n        end,\n        {\n            power: croppedMeasurements.power,\n            heartrate: croppedMeasurements.heartrate,\n            cadence: croppedMeasurements.cadence\n        }\n    );\n\n    // Convert to standard flat WorkoutSummary\n    const summary: WorkoutSummary = {\n        startTime: start,\n        endTime: end,\n        totalDuration: duration,\n        avgPower: modalSummary.power.avg ?? undefined,\n        maxPower: modalSummary.power.max ?? undefined,\n        avgHeartrate: modalSummary.heartrate.avg ?? undefined,\n        maxHeartrate: modalSummary.heartrate.max ?? undefined,\n        avgCadence: modalSummary.cadence.avg ?? undefined,\n        maxCadence: modalSummary.cadence.max ?? undefined,\n        // Calculate energy\n        // modalSummary doesn't have energy?\n        // simple calculation: avgPower * duration (seconds) / 1000 = kJ\n        // But better: sum of (watts * delta_time)\n        // For now use avg:\n        // (avgWatts * seconds) / 1000 = kJ\n        // Wait, modalSummary doesn't seem to calculate energy in recent snippet.\n    };\n\n    if (summary.avgPower) {\n        // Estimate energy (kJ)\n        // Power is Watts (J/s). kJ = Watts * seconds / 1000\n        // Approximate using average power\n        // For better accuracy we should integrate, but this matches basic summary often\n        // Check if there is a 'totalEnergy' field in WorkoutSummary (types/measurements.ts doesn't show it but workoutHistory used it)\n        // types/measurements.ts doesn't show totalEnergy.\n        // ui/workoutHistory.ts used summary.totalEnergy.\n        // Let's check ui/workoutHistory.ts getSummary again.\n        // It said \"interface WorkoutSummary { ... totalEnergy?: number ... }\" inside workoutHistory.ts\n        // So the local interface has it.\n        // types/measurements.ts defines WorkoutSummary, does it have totalEnergy?\n        // I read lines 100-127 of types/measurements.ts and it DID NOT have totalEnergy.\n        // But ui/workoutHistory.ts uses it.\n        // So there's a disconnect.\n        // Calculate totalEnergy\n        summary.totalEnergy = Math.round((summary.avgPower * duration) / 1000);\n    }\n\n    // Add distance\n    if (croppedMeasurements.distance.length > 0) {\n        const first = croppedMeasurements.distance[0].value;\n        const last = croppedMeasurements.distance[croppedMeasurements.distance.length - 1].value;\n        summary.totalDistance = Math.max(0, last - first);\n    }\n\n    return {\n        startTime: start,\n        endTime: end,\n        duration,\n        measurements: croppedMeasurements,\n        summary\n    };\n}\n","/**\n * Workout History UI\n * \n * Displays saved workouts and allows viewing details.\n * \n * @module workoutHistory\n */\n\nimport {\n  isDatabaseAvailable,\n  listWorkouts,\n  getWorkout,\n  deleteWorkout,\n  createWorkout,\n  completeWorkout,\n  formatDuration,\n  formatDate,\n  type Workout,\n  type ListWorkoutsResponse,\n  type ListWorkoutsOptions,\n} from '../api/workoutClient.js';\nimport {\n  getCompletedWorkouts,\n  markWorkoutSynced,\n  isIndexedDBSupported,\n  type StoredWorkout\n} from '../storage/workoutStorage.js';\nimport { getFtpHistory, type FtpHistoryEntry } from '../api/userClient.js';\nimport { calculateWorkoutSummary } from './modal.js';\nimport { announce } from './accessibility.js';\nimport { renderLineChart } from './charts.js';\nimport { renderPeriodStatistics } from './statistics.js';\nimport { cropWorkout } from '../utils/cropWorkout.js';\nimport type { MeasurementsData } from '../types/measurements.js';\n\n/** Current pagination page */\nlet currentPage = 1;\n/** Total number of pages */\nlet totalPages = 1;\n/** Database availability flag */\nlet dbAvailable = false;\n\n/* Filter State */\nlet filterType = '';\nlet filterStartDate = '';\nlet filterEndDate = '';\n\n/* View State */\nlet currentView: 'list' | 'calendar' | 'analytics' = 'list';\nlet calendarDate = new Date(); // Points to current month\nlet dataSource: 'cloud' | 'local' = 'cloud';\n\n/**\n * Workout summary data from API\n */\ninterface WorkoutSummary {\n  avgPower?: number;\n  maxPower?: number;\n  normalizedPower?: number;\n  avgCadence?: number;\n  maxCadence?: number;\n  avgHeartrate?: number;\n  maxHeartrate?: number;\n  totalEnergy?: number;\n  totalDistance?: number;\n  sampleCount?: number;\n  powerCurve?: { duration: number; watts: number }[];\n  trainingLoad?: number;\n  intensityFactor?: number;\n}\n\n/**\n * Helper to safely parse summary\n */\nfunction getSummary(workout: Workout): WorkoutSummary {\n  if (!workout.summary) return {};\n  if (typeof workout.summary === 'string') {\n    try {\n      return JSON.parse(workout.summary);\n    } catch {\n      return {};\n    }\n  }\n  return workout.summary as unknown as WorkoutSummary;\n}\n\n/**\n * Initialize the workout history feature logic\n * NOTE: This should be called after the History View is mounted to DOM.\n */\nexport function initHistoryLogic(): void {\n  const prevBtn = document.getElementById('historyPrevPage') as HTMLButtonElement | null;\n  const nextBtn = document.getElementById('historyNextPage') as HTMLButtonElement | null;\n  const refreshBtn = document.getElementById('historyRefresh');\n\n  // Filters & Views\n  const typeFilter = document.getElementById('workoutTypeFilter') as HTMLSelectElement | null;\n  const dateStart = document.getElementById('workoutDateStart') as HTMLInputElement | null;\n  const dateEnd = document.getElementById('workoutDateEnd') as HTMLInputElement | null;\n  const viewListBtn = document.getElementById('viewListBtn');\n  const viewCalendarBtn = document.getElementById('viewCalendarBtn');\n  const viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');\n\n  const listView = document.getElementById('workoutListView');\n  const calendarView = document.getElementById('workoutCalendarView');\n  const analyticsView = document.getElementById('workoutAnalyticsView');\n\n  // Calendar Controls\n  const prevMonthBtn = document.getElementById('calendarPrevMonth');\n  const nextMonthBtn = document.getElementById('calendarNextMonth');\n\n  // Source Toggle\n  const sourceCloudBtn = document.getElementById('sourceCloudBtn');\n  const sourceLocalBtn = document.getElementById('sourceLocalBtn');\n\n  if (sourceCloudBtn && sourceLocalBtn) {\n    sourceCloudBtn.addEventListener('click', () => setSource('cloud'));\n    sourceLocalBtn.addEventListener('click', () => setSource('local'));\n  }\n\n  // Check if database is available on load\n  checkDatabaseAvailability();\n\n  // Toggle Views\n  const setView = (view: 'list' | 'calendar' | 'analytics') => {\n    currentView = view;\n\n    // Buttons\n    if (viewListBtn) {\n      viewListBtn.classList.toggle('active', view === 'list');\n      viewListBtn.setAttribute('aria-pressed', (view === 'list').toString());\n      viewListBtn.style.background = view === 'list' ? 'var(--color-bg-active)' : 'transparent';\n    }\n    if (viewCalendarBtn) {\n      viewCalendarBtn.classList.toggle('active', view === 'calendar');\n      viewCalendarBtn.setAttribute('aria-pressed', (view === 'calendar').toString());\n      viewCalendarBtn.style.background = view === 'calendar' ? 'var(--color-bg-active)' : 'transparent';\n    }\n    if (viewAnalyticsBtn) {\n      viewAnalyticsBtn.classList.toggle('active', view === 'analytics');\n      viewAnalyticsBtn.setAttribute('aria-pressed', (view === 'analytics').toString());\n      viewAnalyticsBtn.style.background = view === 'analytics' ? 'var(--color-bg-active)' : 'transparent';\n    }\n\n    // Panels\n    if (listView) listView.style.display = view === 'list' ? 'block' : 'none';\n    if (calendarView) calendarView.style.display = view === 'calendar' ? 'block' : 'none';\n    if (analyticsView) analyticsView.style.display = view === 'analytics' ? 'block' : 'none';\n\n    // Filters visibility (hide generic filters for analytics maybe? Keeping for now)\n  };\n\n  viewListBtn?.addEventListener('click', () => {\n    setView('list');\n    loadWorkouts();\n  });\n\n  viewCalendarBtn?.addEventListener('click', () => {\n    setView('calendar');\n    loadCalendar();\n  });\n\n  viewAnalyticsBtn?.addEventListener('click', () => {\n    setView('analytics');\n    loadAnalytics();\n  });\n\n  // Filter Change Listeners\n  const handleFilterChange = () => {\n    if (typeFilter) filterType = typeFilter.value;\n    if (dateStart) filterStartDate = dateStart.value;\n    if (dateEnd) filterEndDate = dateEnd.value;\n\n    currentPage = 1;\n\n    if (currentView === 'list') {\n      loadWorkouts();\n    } else if (currentView === 'calendar') {\n      loadCalendar();\n    } else if (currentView === 'analytics') {\n      loadAnalytics();\n    }\n  };\n\n  typeFilter?.addEventListener('change', handleFilterChange);\n  dateStart?.addEventListener('change', handleFilterChange);\n  dateEnd?.addEventListener('change', handleFilterChange);\n\n  // Calendar Navigation\n  prevMonthBtn?.addEventListener('click', () => {\n    calendarDate.setMonth(calendarDate.getMonth() - 1);\n    loadCalendar();\n  });\n\n  nextMonthBtn?.addEventListener('click', () => {\n    calendarDate.setMonth(calendarDate.getMonth() + 1);\n    loadCalendar();\n  });\n\n  // Pagination\n  prevBtn?.addEventListener('click', async () => {\n    if (currentPage > 1) {\n      currentPage--;\n      await loadWorkouts();\n    }\n  });\n\n  nextBtn?.addEventListener('click', async () => {\n    if (currentPage < totalPages) {\n      currentPage++;\n      await loadWorkouts();\n    }\n  });\n\n  // Refresh\n  refreshBtn?.addEventListener('click', async () => {\n    await loadWorkouts();\n  });\n}\n\n/**\n * Check if database features are available\n */\nasync function checkDatabaseAvailability(): Promise<void> {\n  const historyButton = document.getElementById('workoutHistoryButton') as HTMLButtonElement | null;\n  const hasIndexedDB = isIndexedDBSupported();\n\n  try {\n    dbAvailable = await isDatabaseAvailable();\n  } catch {\n    dbAvailable = false;\n  }\n\n  // Default to local if cloud is unavailable\n  if (!dbAvailable && hasIndexedDB) {\n    dataSource = 'local';\n    updateSourceToggle();\n  }\n\n  if (historyButton) {\n    historyButton.disabled = !(dbAvailable || hasIndexedDB);\n    historyButton.title = (dbAvailable || hasIndexedDB)\n      ? 'View workout history'\n      : 'History not available';\n  }\n}\n\n/**\n * Convert locally stored workout to Workout interface\n */\nfunction storedToWorkout(stored: StoredWorkout): Workout & { _synced?: boolean } {\n  const summary = calculateWorkoutSummary(\n    stored.startTime,\n    stored.lastUpdated,\n    stored.measurements\n  );\n\n  return {\n    id: stored.id,\n    title: 'Local Workout',\n    sport: 'cycling',\n    startTime: new Date(stored.startTime).toISOString(),\n    endTime: new Date(stored.lastUpdated).toISOString(),\n    duration: Math.round((stored.lastUpdated - stored.startTime) / 1000),\n    status: 'COMPLETED', // API status enum\n    summary: JSON.stringify(summary),\n    createdAt: new Date(stored.startTime).toISOString(),\n    updatedAt: new Date(stored.lastUpdated).toISOString(),\n    _synced: stored.synced\n  };\n}\n\n/**\n * Load and display workouts\n */\nasync function loadWorkouts(): Promise<void> {\n  const listContainer = document.getElementById('workoutList');\n  const pageInfo = document.getElementById('historyPageInfo');\n  const prevBtn = document.getElementById('historyPrevPage') as HTMLButtonElement | null;\n  const nextBtn = document.getElementById('historyNextPage') as HTMLButtonElement | null;\n\n  if (!listContainer) return;\n\n  // Show loading state\n  listContainer.innerHTML = '<div class=\"workout-loading\">Loading workouts...</div>';\n\n  try {\n    let workouts: (Workout & { _synced?: boolean })[] = [];\n\n    if (dataSource === 'local') {\n      const stored = await getCompletedWorkouts();\n      // TODO: Apply filters locally if needed\n      stored.sort((a, b) => b.startTime - a.startTime);\n\n      const total = stored.length;\n      totalPages = Math.ceil(total / 10) || 1;\n      const start = (currentPage - 1) * 10;\n      const pageItems = stored.slice(start, start + 10);\n\n      workouts = pageItems.map(storedToWorkout);\n\n      if (pageInfo) {\n        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${total} local)`;\n      }\n    } else {\n      const options: ListWorkoutsOptions = {\n        page: currentPage,\n        limit: 10\n      };\n\n      if (filterType) options.sport = filterType;\n      if (filterStartDate) options.startDate = new Date(filterStartDate);\n      if (filterEndDate) options.endDate = new Date(filterEndDate);\n\n      const result: ListWorkoutsResponse = await listWorkouts(options);\n      workouts = result.workouts;\n      const { pagination } = result;\n\n      totalPages = pagination.totalPages;\n\n      // Update pagination info\n      if (pageInfo) {\n        pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)`;\n      }\n    }\n\n    // Update pagination buttons\n    if (prevBtn) prevBtn.disabled = currentPage <= 1;\n    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;\n\n    // Render workouts\n    if (workouts.length === 0) {\n      listContainer.innerHTML = `\n        <div class=\"workout-empty\">\n          <p>No workouts found</p>\n          <p class=\"workout-empty-hint\">Start a workout to see it here!</p>\n        </div>\n      `;\n      return;\n    }\n\n    listContainer.innerHTML = workouts.map((workout) => renderWorkoutCard(workout)).join('');\n\n    // Add event listeners for workout cards\n    listContainer.querySelectorAll('.workout-card').forEach((card) => {\n      const workoutId = (card as HTMLElement).dataset.workoutId;\n      if (!workoutId) return;\n\n      // View details\n      card.querySelector('.workout-view-btn')?.addEventListener('click', (e: Event) => {\n        e.stopPropagation();\n        viewWorkoutDetails(workoutId);\n      });\n\n      // Delete\n      card.querySelector('.workout-delete-btn')?.addEventListener('click', (e: Event) => {\n        e.stopPropagation();\n        confirmDeleteWorkout(workoutId);\n      });\n\n      // Sync\n      card.querySelector('.workout-sync-btn')?.addEventListener('click', (e: Event) => {\n        e.stopPropagation();\n        syncWorkout(workoutId);\n      });\n    });\n  } catch (error) {\n    console.error('Failed to load workouts:', error);\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    listContainer.innerHTML = `\n      <div class=\"workout-error\">\n        <p>Failed to load workouts</p>\n        <p class=\"workout-error-detail\">${message}</p>\n      </div>\n    `;\n  }\n}\n\n/**\n * Switch data source and reload\n */\nfunction setSource(s: 'cloud' | 'local'): void {\n  if (dataSource === s) return;\n  dataSource = s;\n  updateSourceToggle();\n  currentPage = 1;\n  loadWorkouts();\n}\n\n/**\n * Update toggle UI\n */\nfunction updateSourceToggle(): void {\n  const cloudBtn = document.getElementById('sourceCloudBtn');\n  const localBtn = document.getElementById('sourceLocalBtn');\n\n  if (cloudBtn && localBtn) {\n    if (dataSource === 'cloud') {\n      cloudBtn.classList.add('active');\n      cloudBtn.setAttribute('aria-pressed', 'true');\n      cloudBtn.style.background = 'var(--color-bg-active)';\n\n      localBtn.classList.remove('active');\n      localBtn.setAttribute('aria-pressed', 'false');\n      localBtn.style.background = 'transparent';\n    } else {\n      localBtn.classList.add('active');\n      localBtn.setAttribute('aria-pressed', 'true');\n      localBtn.style.background = 'var(--color-bg-active)';\n\n      cloudBtn.classList.remove('active');\n      cloudBtn.setAttribute('aria-pressed', 'false');\n      cloudBtn.style.background = 'transparent';\n    }\n  }\n}\n\n/**\n * Sync a local workout to server\n */\nasync function syncWorkout(localId: string): Promise<void> {\n  const workouts = await getCompletedWorkouts();\n  const local = workouts.find(w => w.id === localId);\n  if (!local) return;\n\n  try {\n    announce('Syncing workout...', 'polite');\n\n    // 1. Create Workout on server\n    const createRes = await createWorkout({\n      streamName: `sync-${localId}`,\n      title: `Synced: ${formatDate(new Date(local.startTime))}`,\n      sport: 'cycling'\n    });\n\n    if (createRes.success && createRes.workout) {\n      // 2. Mark as complete (updates status to COMPLETED)\n      const completeRes = await completeWorkout(createRes.workout.id, false);\n\n      if (completeRes.success) {\n        await markWorkoutSynced(localId);\n        announce('Workout synced successfully', 'assertive');\n        await loadWorkouts();\n      } else {\n        throw new Error('Failed to complete workout on server');\n      }\n    }\n  } catch (e) {\n    console.error('Sync failed', e);\n    announce('Sync failed', 'assertive');\n  }\n}\n\n/**\n * Render a workout card\n */\nfunction renderWorkoutCard(workout: Workout & { _synced?: boolean }): string {\n  const statusClass = workout.status.toLowerCase();\n  const summary = getSummary(workout);\n\n  const isUnsynced = workout._synced === false;\n  const syncBtn = isUnsynced\n    ? `<button class=\"workout-sync-btn\" title=\"Upload to server\"> Sync</button>`\n    : (workout._synced === true ? `<span title=\"Synced\" style=\"margin-right:8px;\"></span>` : '');\n\n  return `\n    <div class=\"workout-card\" data-workout-id=\"${workout.id}\">\n      <div class=\"workout-card-header\">\n        <span class=\"workout-title\">${workout.title || 'Untitled Workout'}</span>\n        <span class=\"workout-status workout-status-${statusClass}\">${workout.status}</span>\n      </div>\n      <div class=\"workout-card-body\">\n        <div class=\"workout-date\">\n           ${formatDate(workout.startTime)}\n        </div>\n        <div class=\"workout-stats\">\n          ${workout.duration ? `<span class=\"workout-stat\"> ${formatDuration(workout.duration)}</span>` : ''}\n          ${summary.avgPower ? `<span class=\"workout-stat\"> ${summary.avgPower}W avg</span>` : ''}\n          ${summary.maxPower ? `<span class=\"workout-stat\"> ${summary.maxPower}W max</span>` : ''}\n          ${summary.avgHeartrate ? `<span class=\"workout-stat\"> ${summary.avgHeartrate} bpm</span>` : ''}\n          ${summary.totalEnergy ? `<span class=\"workout-stat\"> ${summary.totalEnergy} kJ</span>` : ''}\n        </div>\n      </div>\n      <div class=\"workout-card-actions\">\n        ${syncBtn}\n        <button class=\"workout-view-btn\" title=\"View details\"> View</button>\n        <button class=\"workout-delete-btn\" title=\"Delete workout\"></button>\n      </div>\n    </div>\n  `;\n}\n\n/**\n * View workout details in a detail panel\n */\nasync function viewWorkoutDetails(workoutId: string): Promise<void> {\n  const detailPanel = document.getElementById('workoutDetailPanel');\n  const listPanel = document.getElementById('workoutListPanel');\n\n  if (!detailPanel || !listPanel) return;\n\n  // Show detail panel\n  listPanel.style.display = 'none';\n  detailPanel.style.display = 'block';\n  detailPanel.innerHTML = '<div class=\"workout-loading\">Loading workout details...</div>';\n\n  try {\n    const workout = await getWorkout(workoutId, true);\n    detailPanel.innerHTML = renderWorkoutDetail(workout);\n\n    // Render Charts if telemetry exists\n    if (workout.telemetry) {\n      // Allow DOM to update first\n      requestAnimationFrame(() => {\n        renderWorkoutCharts(workout.telemetry!, workout.startTime);\n      });\n    }\n\n    // Back button\n    detailPanel.querySelector('.workout-back-btn')?.addEventListener('click', () => {\n      detailPanel.style.display = 'none';\n      listPanel.style.display = 'block';\n    });\n\n    // Export button\n    detailPanel.querySelector('.workout-export-btn')?.addEventListener('click', () => {\n      exportWorkoutData(workout);\n    });\n\n    // Crop button\n    detailPanel.querySelector('.workout-crop-btn')?.addEventListener('click', () => {\n      startCropTool(workout);\n    });\n  } catch (error) {\n    console.error('Failed to load workout details:', error);\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    detailPanel.innerHTML = `\n      <div class=\"workout-error\">\n        <p>Failed to load workout</p>\n        <p class=\"workout-error-detail\">${message}</p>\n        <button class=\"workout-back-btn\"> Back to list</button>\n      </div>\n    `;\n    detailPanel.querySelector('.workout-back-btn')?.addEventListener('click', () => {\n      detailPanel.style.display = 'none';\n      listPanel.style.display = 'block';\n    });\n  }\n}\n\n/**\n * Render workout detail view\n */\nfunction renderWorkoutDetail(workout: Workout): string {\n  const summary = getSummary(workout);\n  const statusClass = workout.status.toLowerCase();\n\n  return `\n    <div class=\"workout-detail\">\n      <div class=\"workout-detail-header\">\n        <button class=\"workout-back-btn\"> Back</button>\n        <h3>${workout.title || 'Untitled Workout'}</h3>\n        <span class=\"workout-status workout-status-${statusClass}\">${workout.status}</span>\n      </div>\n\n      <div class=\"workout-detail-meta\">\n        <div class=\"meta-item\">\n          <span class=\"meta-label\">Sport</span>\n          <span class=\"meta-value\">${workout.sport || 'cycling'}</span>\n        </div>\n        <div class=\"meta-item\">\n          <span class=\"meta-label\">Start Time</span>\n          <span class=\"meta-value\">${formatDate(workout.startTime)}</span>\n        </div>\n        ${workout.endTime ? `\n          <div class=\"meta-item\">\n            <span class=\"meta-label\">End Time</span>\n            <span class=\"meta-value\">${formatDate(workout.endTime)}</span>\n          </div>\n        ` : ''}\n        ${workout.duration ? `\n          <div class=\"meta-item\">\n            <span class=\"meta-label\">Duration</span>\n            <span class=\"meta-value\">${formatDuration(workout.duration)}</span>\n          </div>\n        ` : ''}\n      </div>\n\n      ${Object.keys(summary).length > 0 ? `\n        <div class=\"workout-detail-summary\">\n          <h4>Summary</h4>\n          <div class=\"summary-grid\">\n            ${summary.avgPower ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Power</span>\n                <span class=\"summary-value\">${summary.avgPower} W</span>\n              </div>\n            ` : ''}\n            ${summary.maxPower ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Max Power</span>\n                <span class=\"summary-value\">${summary.maxPower} W</span>\n              </div>\n            ` : ''}\n            ${summary.avgCadence ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Cadence</span>\n                <span class=\"summary-value\">${summary.avgCadence} rpm</span>\n              </div>\n            ` : ''}\n            ${summary.avgHeartrate ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Heart Rate</span>\n                <span class=\"summary-value\">${summary.avgHeartrate} bpm</span>\n              </div>\n            ` : ''}\n            ${summary.totalEnergy ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Total Energy</span>\n                <span class=\"summary-value\">${summary.totalEnergy} kJ</span>\n              </div>\n            ` : ''}\n          </div>\n        </div>\n      ` : ''}\n\n      ${workout.telemetry ? `\n        <div class=\"workout-detail-charts\">\n            <h4>Charts</h4>\n            <div id=\"wd-chart-power\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-hr\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-cadence\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-altitude\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n        </div>\n      ` : ''}\n\n      ${workout.description ? `\n        <div class=\"workout-detail-description\">\n          <h4>Notes</h4>\n          <p>${workout.description}</p>\n        </div>\n      ` : ''}\n\n      <div class=\"workout-detail-actions\">\n        ${workout.telemetry ? `\n          <button class=\"workout-action-btn workout-crop-btn\"> Crop</button>\n          <button class=\"workout-export-btn\"> Export Data</button>\n        ` : ''}\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Export workout data to files\n */\nfunction exportWorkoutData(workout: Workout): void {\n  const timestamp = new Date(workout.startTime).toISOString().replace(/[:.]/g, '-').slice(0, 19);\n  const filename = `workout-${timestamp}`;\n\n  const jsonData = {\n    id: workout.id,\n    title: workout.title,\n    sport: workout.sport,\n    startTime: workout.startTime,\n    endTime: workout.endTime,\n    duration: workout.duration,\n    summary: workout.summary,\n    telemetry: workout.telemetry,\n  };\n\n  const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });\n  const jsonUrl = URL.createObjectURL(jsonBlob);\n  const jsonLink = document.createElement('a');\n  jsonLink.href = jsonUrl;\n  jsonLink.download = `${filename}.json`;\n  jsonLink.click();\n  URL.revokeObjectURL(jsonUrl);\n}\n\n/**\n * Confirm and delete a workout\n */\nasync function confirmDeleteWorkout(workoutId: string): Promise<void> {\n  if (!confirm('Are you sure you want to delete this workout? This cannot be undone.')) {\n    return;\n  }\n\n  try {\n    await deleteWorkout(workoutId);\n    await loadWorkouts();\n  } catch (error) {\n    console.error('Failed to delete workout:', error);\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    alert(`Failed to delete workout: ${message}`);\n  }\n}\n\n/**\n * Check database availability (exported for other modules)\n */\nexport function getDatabaseAvailable(): boolean {\n  return dbAvailable;\n}\n\n/**\n * Load and display calendar view\n */\nasync function loadCalendar(): Promise<void> {\n  const calendarGrid = document.getElementById('workoutCalendarGrid');\n  const monthLabel = document.getElementById('calendarMonthLabel');\n\n  if (!calendarGrid || !monthLabel) return;\n\n  // Set month label\n  const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n  monthLabel.textContent = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;\n\n  // Show loading\n  calendarGrid.innerHTML = '<div style=\"grid-column: 1 / -1; text-align: center; padding: 20px;\">Loading calendar...</div>';\n\n  // Calculate start and end of month\n  const year = calendarDate.getFullYear();\n  const month = calendarDate.getMonth();\n  const startDate = new Date(year, month, 1);\n  const endDate = new Date(year, month + 1, 0, 23, 59, 59, 999);\n\n  try {\n    const options: ListWorkoutsOptions = {\n      startDate,\n      endDate,\n      limit: 1000 // Get all workouts for the month\n    };\n    if (filterType) options.sport = filterType;\n\n    const result = await listWorkouts(options);\n    const workouts = result.workouts;\n\n    renderCalendar(workouts);\n    renderMonthlyStats(workouts);\n  } catch (error) {\n    console.error('Failed to load calendar:', error);\n    calendarGrid.innerHTML = '<div style=\"grid-column: 1 / -1; text-align: center; color: var(--color-error);\">Failed to load calendar data</div>';\n  }\n}\n\n/**\n * Render the calendar grid\n */\nfunction renderCalendar(workouts: Workout[]): void {\n  const calendarGrid = document.getElementById('workoutCalendarGrid');\n  if (!calendarGrid) return;\n\n  calendarGrid.innerHTML = '';\n\n  // Add day headers\n  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n  days.forEach(day => {\n    const d = document.createElement('div');\n    d.textContent = day;\n    d.style.textAlign = 'center';\n    d.style.fontWeight = 'bold';\n    d.style.padding = '4px';\n    d.style.fontSize = '0.9em';\n    d.style.color = 'var(--color-text-secondary)';\n    calendarGrid.appendChild(d);\n  });\n\n  const year = calendarDate.getFullYear();\n  const month = calendarDate.getMonth();\n\n  // First day of the month\n  const firstDay = new Date(year, month, 1).getDay();\n  // Days in month\n  const daysInMonth = new Date(year, month + 1, 0).getDate();\n\n  // Empty cells for days before first of month\n  for (let i = 0; i < firstDay; i++) {\n    const empty = document.createElement('div');\n    calendarGrid.appendChild(empty);\n  }\n\n  // Days\n  for (let day = 1; day <= daysInMonth; day++) {\n    const dayCell = document.createElement('div');\n    dayCell.style.border = '1px solid var(--color-border)';\n    dayCell.style.borderRadius = '4px';\n    dayCell.style.minHeight = '60px';\n    dayCell.style.padding = '4px';\n    dayCell.style.background = 'var(--card-bg)';\n    dayCell.style.position = 'relative';\n\n    const dayNum = document.createElement('div');\n    dayNum.textContent = day.toString();\n    dayNum.style.fontSize = '0.8em';\n    dayNum.style.marginBottom = '4px';\n    dayCell.appendChild(dayNum);\n\n    // Find workouts for this day\n    const dayWorkouts = workouts.filter(w => {\n      const wDate = new Date(w.startTime);\n      return wDate.getDate() === day && wDate.getMonth() === month && wDate.getFullYear() === year;\n    });\n\n    dayWorkouts.forEach(w => {\n      const dot = document.createElement('div');\n      dot.title = `${w.title || 'Workout'} (${formatDuration(w.duration || 0)})`;\n      dot.style.fontSize = '0.7em';\n      dot.style.whiteSpace = 'nowrap';\n      dot.style.overflow = 'hidden';\n      dot.style.textOverflow = 'ellipsis';\n      dot.style.cursor = 'pointer';\n      dot.style.padding = '2px';\n      dot.style.marginTop = '2px';\n      dot.style.borderRadius = '2px';\n      dot.style.background = 'var(--color-bg-active)';\n      dot.style.color = 'var(--color-text-primary)';\n\n      // Icon based on sport\n      const icon = w.sport === 'running' ? '' : '';\n      dot.textContent = `${icon} ${formatDuration(w.duration || 0)}`;\n\n      dot.addEventListener('click', (e) => {\n        e.stopPropagation();\n        viewWorkoutDetails(w.id);\n      });\n\n      dayCell.appendChild(dot);\n    });\n\n    // Highlight today\n    const today = new Date();\n    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {\n      dayCell.style.borderColor = 'var(--color-accent)';\n      dayNum.style.fontWeight = 'bold';\n      dayNum.style.color = 'var(--color-accent)';\n    }\n\n    calendarGrid.appendChild(dayCell);\n  }\n}\n\n/**\n * Render monthly statistics\n */\nfunction renderMonthlyStats(workouts: Workout[]): void {\n  const statsContainer = document.getElementById('monthlyStats');\n  if (!statsContainer) return;\n\n  const totalWorkouts = workouts.length;\n  const totalDuration = workouts.reduce((acc, w) => acc + (w.duration || 0), 0);\n  const totalDistance = workouts.reduce((acc, w) => {\n    const summary = getSummary(w);\n    return acc + (summary.totalDistance || 0);\n  }, 0);\n  const totalEnergy = workouts.reduce((acc, w) => {\n    const summary = getSummary(w);\n    return acc + (summary.totalEnergy || 0);\n  }, 0);\n\n  statsContainer.innerHTML = `\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Workouts</div>\n            <div style=\"font-weight: bold;\">${totalWorkouts}</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Duration</div>\n            <div style=\"font-weight: bold;\">${formatDuration(totalDuration)}</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Distance</div>\n            <div style=\"font-weight: bold;\">${(totalDistance / 1000).toFixed(1)} km</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Energy</div>\n            <div style=\"font-weight: bold;\">${totalEnergy.toFixed(0)} kJ</div>\n        </div>\n    `;\n}\n\n/**\n * Load and display analytics\n */\nasync function loadAnalytics(): Promise<void> {\n  const analyticsView = document.getElementById('workoutAnalyticsView');\n  if (!analyticsView) return;\n\n  // Show loading\n  const prList = document.getElementById('prList');\n  if (prList) prList.innerHTML = '<div style=\"padding: 12px; text-align: center;\">Loading records...</div>';\n\n  try {\n    // Fetch all history (might be heavy, better to have a dedicated endpoint in future)\n    // For now, fetch with large limit but minimal fields? \n    // Unfortunately getWorkoutHistory fetches all summary fields.\n    // We can respect filters though.\n\n    const options: ListWorkoutsOptions = {\n      limit: 1000, // Reasonable cap\n    };\n    if (filterType) options.sport = filterType;\n    if (filterStartDate) options.startDate = new Date(filterStartDate);\n    if (filterEndDate) options.endDate = new Date(filterEndDate);\n\n    const result = await listWorkouts(options);\n    const workouts = result.workouts;\n\n    // Fetch FTP History if we have a user ID\n    let ftpHistory: FtpHistoryEntry[] = [];\n    if (workouts.length > 0 && workouts[0].userId) {\n      try {\n        ftpHistory = await getFtpHistory(workouts[0].userId);\n      } catch (e) {\n        console.warn('Failed to load FTP history', e);\n      }\n    }\n\n    renderAnalytics(workouts, ftpHistory);\n  } catch (error) {\n    console.error('Failed to load analytics:', error);\n    if (prList) prList.innerHTML = '<div style=\"color: var(--color-error); text-align: center;\">Failed to load data</div>';\n  }\n}\n\n/**\n * Render all analytics charts and stats\n */\nfunction renderAnalytics(workouts: Workout[], ftpHistory: FtpHistoryEntry[] = []): void {\n  renderPeriodStatistics('workoutAnalyticsView', workouts);\n  renderPersonalRecords(workouts);\n  renderTrainingLoad(workouts);\n  renderPowerCurve(workouts);\n  renderFitnessTrend(workouts);\n  renderFtpHistory(ftpHistory);\n  renderPrHistory(workouts);\n}\n\n/**\n * Render Personal Records\n */\nfunction renderPersonalRecords(workouts: Workout[]): void {\n  const container = document.getElementById('prList');\n  if (!container) return;\n\n  let maxPower = { val: 0, date: '', id: '' };\n  let maxHr = { val: 0, date: '', id: '' };\n  let longestRide = { val: 0, date: '', id: '' }; // Duration\n  let maxDistance = { val: 0, date: '', id: '' };\n\n  workouts.forEach(w => {\n    const summary = getSummary(w);\n    const dateStr = formatDate(w.startTime);\n\n    if (summary.maxPower && summary.maxPower > maxPower.val) {\n      maxPower = { val: summary.maxPower, date: dateStr, id: w.id };\n    }\n    if (summary.maxHeartrate && summary.maxHeartrate > maxHr.val) {\n      maxHr = { val: summary.maxHeartrate, date: dateStr, id: w.id };\n    }\n    if (w.duration && w.duration > longestRide.val) {\n      longestRide = { val: w.duration, date: dateStr, id: w.id };\n    }\n    if (summary.totalDistance && summary.totalDistance > maxDistance.val) {\n      maxDistance = { val: summary.totalDistance, date: dateStr, id: w.id };\n    }\n  });\n\n  const createRow = (label: string, value: string, date: string, id: string) => `\n        <div class=\"pr-row\" data-id=\"${id}\" style=\"display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border); cursor: pointer;\">\n            <div style=\"font-weight: 500;\">${label}</div>\n            <div style=\"text-align: right;\">\n                <div style=\"font-weight: bold; color: var(--color-accent);\">${value}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">${date}</div>\n            </div>\n        </div>\n    `;\n\n  container.innerHTML = `\n        ${maxPower.val > 0 ? createRow('Max Power (1s)', `${maxPower.val} W`, maxPower.date, maxPower.id) : ''}\n        ${maxHr.val > 0 ? createRow('Max Heart Rate', `${maxHr.val} bpm`, maxHr.date, maxHr.id) : ''}\n        ${longestRide.val > 0 ? createRow('Longest Duration', formatDuration(longestRide.val), longestRide.date, longestRide.id) : ''}\n        ${maxDistance.val > 0 ? createRow('Longest Distance', `${(maxDistance.val / 1000).toFixed(1)} km`, maxDistance.date, maxDistance.id) : ''}\n    `;\n\n  // Re-attach click listeners\n  container.querySelectorAll('.pr-row').forEach(row => {\n    row.addEventListener('click', () => {\n      const id = (row as HTMLElement).dataset.id;\n      if (id) viewWorkoutDetails(id);\n    });\n  });\n}\n\n/**\n * Render Training Load (Weekly TSS)\n */\nfunction renderTrainingLoad(workouts: Workout[]): void {\n  const container = document.getElementById('trainingLoadChart');\n  if (!container) return;\n\n  // Group by week\n  const weeks: Record<string, number> = {};\n  // Generate last 4 weeks keys\n  for (let i = 3; i >= 0; i--) {\n    const d = new Date();\n    d.setDate(d.getDate() - (i * 7));\n    const weekNum = getWeekNumber(d);\n    weeks[`${d.getFullYear()}-W${weekNum}`] = 0;\n  }\n\n  workouts.forEach(w => {\n    const summary = getSummary(w);\n    if (summary.trainingLoad) {\n      const date = new Date(w.startTime);\n      const key = `${date.getFullYear()}-W${getWeekNumber(date)}`;\n      if (weeks[key] !== undefined) {\n        weeks[key] += summary.trainingLoad;\n      }\n    }\n  });\n\n  const maxLoad = Math.max(...Object.values(weeks), 100); // Scale max\n\n  container.innerHTML = Object.entries(weeks).map(([week, load]) => {\n    const height = (load / maxLoad) * 100;\n    return `\n            <div style=\"display: flex; flex-direction: column; align-items: center; width: 20%;\">\n                <div style=\"font-size: 0.8em; font-weight: bold; margin-bottom: 4px;\">${Math.round(load)}</div>\n                <div style=\"width: 100%; height: 100px; display: flex; align-items: flex-end; justify-content: center;\">\n                    <div style=\"width: 80%; background: var(--color-accent); height: ${height}%; border-radius: 4px 4px 0 0; min-height: 4px;\"></div>\n                </div>\n                <div style=\"font-size: 0.7em; color: var(--color-text-secondary); margin-top: 4px;\">${week.split('-')[1]}</div>\n            </div>\n        `;\n  }).join('');\n}\n\nfunction getWeekNumber(d: Date): number {\n  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));\n  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n  return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);\n}\n\n/**\n * Render Power Curve (SVG Chart)\n */\nfunction renderPowerCurve(workouts: Workout[]): void {\n  const container = document.getElementById('powerCurveChart');\n  if (!container) return;\n\n  // Aggregate best power for each duration\n  const bests: Record<number, number> = {};\n  const durations = [1, 5, 10, 30, 60, 300, 1200, 3600];\n\n  workouts.forEach(w => {\n    const summary = getSummary(w);\n    if (summary.powerCurve) {\n      summary.powerCurve.forEach(p => {\n        if (!bests[p.duration] || p.watts > bests[p.duration]) {\n          bests[p.duration] = p.watts;\n        }\n      });\n    }\n    // Fallback for older workouts if we have maxPower (1s)\n    if (summary.maxPower && (!bests[1] || summary.maxPower > bests[1])) {\n      bests[1] = summary.maxPower;\n    }\n  });\n\n  if (Object.keys(bests).length === 0) {\n    container.innerHTML = '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">No power data available</div>';\n    return;\n  }\n\n  // Chart Dimensions\n  const width = container.clientWidth || 300;\n  const height = 200;\n  const pad = 30;\n\n  // Scales\n  const maxWatts = Math.max(...Object.values(bests)) * 1.1; // 10% overhead\n\n  const points = durations.map((d, i) => {\n    if (!bests[d]) return null;\n    const x = pad + (i * ((width - pad * 2) / (durations.length - 1)));\n    const y = height - pad - ((bests[d] / maxWatts) * (height - pad * 2));\n    return { x, y, val: bests[d], duration: d };\n  }).filter(p => p !== null);\n\n  if (points.length < 2) {\n    container.innerHTML = '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">Insufficient data points</div>';\n    return;\n  }\n\n  const pathD = `M ${points.map(p => `${p!.x},${p!.y}`).join(' L ')}`;\n\n  // SVG Content\n  const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad}\" y1=\"${pad}\" x2=\"${pad}\" y2=\"${height - pad}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad}\" y1=\"${height - pad}\" x2=\"${width - pad}\" y2=\"${height - pad}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- Path -->\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n            \n            <!-- Points -->\n            ${points.map(p => `\n                <circle cx=\"${p!.x}\" cy=\"${p!.y}\" r=\"4\" fill=\"var(--card-bg)\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n                <text x=\"${p!.x}\" y=\"${p!.y - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-primary)\">${p!.val}W</text>\n                <text x=\"${p!.x}\" y=\"${height - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${formatDurationLabel(p!.duration)}</text>\n            `).join('')}\n        </svg>\n    `;\n\n  container.innerHTML = svg;\n}\n\nfunction formatDurationLabel(sec: number): string {\n  if (sec < 60) return `${sec}s`;\n  if (sec < 3600) return `${sec / 60}m`;\n  return `${sec / 3600}h`;\n}\n\n/**\n * Render Fitness Trend (CTL/ATL)\n */\nfunction renderFitnessTrend(workouts: Workout[]): void {\n  const container = document.getElementById('fitnessTrendChart');\n  if (!container) return;\n\n  // Sort workouts by date ascending\n  const sorted = [...workouts].sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());\n\n  if (sorted.length < 2) {\n    container.innerHTML = '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">Not enough data for trend analysis</div>';\n    return;\n  }\n\n  // Daily TSS Map\n  const tssMap = new Map<string, number>();\n  sorted.forEach(w => {\n    const summary = getSummary(w);\n    if (summary.trainingLoad) {\n      const dateStr = new Date(w.startTime).toISOString().split('T')[0];\n      const current = tssMap.get(dateStr) || 0;\n      tssMap.set(dateStr, current + summary.trainingLoad);\n    }\n  });\n\n  // Calculate CTL/ATL day by day\n  const dataPoints: { date: Date, ctl: number, atl: number, tsb: number }[] = [];\n  const startDate = new Date(sorted[0].startTime);\n  const endDate = new Date(); // Today\n\n  // Constants\n  const kCTL = Math.exp(-1 / 42);\n  const kATL = Math.exp(-1 / 7);\n\n  let ctl = 0;\n  let atl = 0;\n\n  // Iterate day by day\n  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {\n    const dateStr = d.toISOString().split('T')[0];\n    const tss = tssMap.get(dateStr) || 0;\n\n    ctl = ctl * kCTL + tss * (1 - kCTL);\n    atl = atl * kATL + tss * (1 - kATL);\n\n    dataPoints.push({\n      date: new Date(d),\n      ctl,\n      atl,\n      tsb: ctl - atl\n    });\n  }\n\n  // Chart Dimensions\n  const width = container.clientWidth || 600;\n  const height = 250;\n  const pad = { top: 20, right: 30, bottom: 30, left: 40 };\n  const chartW = width - pad.left - pad.right;\n  const chartH = height - pad.top - pad.bottom;\n\n  // Scales\n  const maxVal = Math.max(...dataPoints.map(p => Math.max(p.ctl, p.atl))) * 1.1;\n\n  const timeSpan = endDate.getTime() - startDate.getTime();\n  if (timeSpan === 0) return;\n\n  const getX = (date: Date) => pad.left + ((date.getTime() - startDate.getTime()) / timeSpan) * chartW;\n  const getY = (val: number) => pad.top + chartH - ((val / maxVal) * chartH);\n\n  // Generate Paths\n  const ctlPath = 'M ' + dataPoints.map(p => `${getX(p.date)},${getY(p.ctl)}`).join(' L ');\n  const atlPath = 'M ' + dataPoints.map(p => `${getX(p.date)},${getY(p.atl)}`).join(' L ');\n\n  // SVG Content\n  const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad.left}\" y1=\"${pad.top}\" x2=\"${pad.left}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad.left}\" y1=\"${height - pad.bottom}\" x2=\"${width - pad.right}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- CTL Line (Fitness) - Blue -->\n            <path d=\"${ctlPath}\" fill=\"none\" stroke=\"#3b82f6\" stroke-width=\"2\" />\n            \n            <!-- ATL Line (Fatigue) - Pink/Purple -->\n            <path d=\"${atlPath}\" fill=\"none\" stroke=\"#ec4899\" stroke-width=\"2\" stroke-dasharray=\"4\" />\n            \n            <!-- Legend -->\n            <g transform=\"translate(${pad.left + 10}, ${pad.top})\">\n                <rect x=\"0\" y=\"0\" width=\"10\" height=\"10\" fill=\"#3b82f6\" />\n                <text x=\"15\" y=\"10\" font-size=\"12\" fill=\"var(--color-text-secondary)\">Fitness (CTL)</text>\n                \n                <rect x=\"100\" y=\"0\" width=\"10\" height=\"10\" fill=\"none\" stroke=\"#ec4899\" stroke-width=\"2\" stroke-dasharray=\"4\" />\n                <text x=\"115\" y=\"10\" font-size=\"12\" fill=\"var(--color-text-secondary)\">Fatigue (ATL)</text>\n            </g>\n\n            <!-- Latest Stats -->\n             <text x=\"${width - pad.right}\" y=\"${pad.top}\" text-anchor=\"end\" font-size=\"12\" fill=\"var(--color-text-primary)\">\n                CTL: ${Math.round(ctl)} | ATL: ${Math.round(atl)} | TSB: ${Math.round(ctl - atl)}\n            </text>\n        </svg>\n    `;\n\n  container.innerHTML = svg;\n}\n\n/**\n * Render FTP History Chart\n */\nfunction renderFtpHistory(history: FtpHistoryEntry[]): void {\n  const container = document.getElementById('ftpHistoryChart');\n  if (!container) return;\n\n  if (history.length === 0) {\n    container.innerHTML = '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">No FTP history available</div>';\n    return;\n  }\n\n  // Sort by date ascending\n  const sorted = [...history].sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());\n\n  // Chart Dimensions\n  const width = container.clientWidth || 600;\n  const height = 200;\n  const pad = { top: 20, right: 30, bottom: 30, left: 40 };\n  const chartW = width - pad.left - pad.right;\n  const chartH = height - pad.top - pad.bottom;\n\n  // Scales\n  const maxFtp = Math.max(...sorted.map(h => h.ftp)) * 1.1;\n  const minFtp = Math.max(0, Math.min(...sorted.map(h => h.ftp)) * 0.9);\n  const ftpRange = maxFtp - minFtp || 100; // avoid div by zero\n\n  const startDate = new Date(sorted[0].createdAt);\n  const endDate = new Date();\n  const timeSpan = endDate.getTime() - startDate.getTime();\n\n  const getX = (dateStr: string | Date) => {\n    const d = new Date(dateStr);\n    return pad.left + ((d.getTime() - startDate.getTime()) / timeSpan) * chartW;\n  };\n  const getY = (val: number) => pad.top + chartH - ((val - minFtp) / ftpRange) * chartH;\n\n  // Generate Path\n  let d = '';\n  if (sorted.length > 0) {\n    d = `M ${getX(sorted[0].createdAt)},${getY(sorted[0].ftp)}`;\n    for (let i = 1; i < sorted.length; i++) {\n      const currX = getX(sorted[i].createdAt);\n      const prevY = getY(sorted[i - 1].ftp);\n      const currY = getY(sorted[i].ftp);\n\n      // Step line: Horizontal then Vertical\n      d += ` L ${currX},${prevY} L ${currX},${currY}`;\n    }\n    // Extend to now\n    d += ` L ${width - pad.right},${getY(sorted[sorted.length - 1].ftp)}`;\n  }\n\n  // SVG Content\n  const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad.left}\" y1=\"${pad.top}\" x2=\"${pad.left}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad.left}\" y1=\"${height - pad.bottom}\" x2=\"${width - pad.right}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- FTP Line -->\n            <path d=\"${d}\" fill=\"none\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n            \n            <!-- Points -->\n            ${sorted.map(h => `\n                <circle cx=\"${getX(h.createdAt)}\" cy=\"${getY(h.ftp)}\" r=\"4\" fill=\"var(--card-bg)\" stroke=\"var(--color-accent)\" stroke-width=\"2\">\n                    <title>${h.ftp} W (${formatDate(h.createdAt)})</title>\n                </circle>\n                <text x=\"${getX(h.createdAt)}\" y=\"${getY(h.ftp) - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-primary)\">${h.ftp}</text>\n            `).join('')}\n\n            <!-- Axis Labels (simplified) -->\n            <text x=\"${pad.left}\" y=\"${height - 10}\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${formatDate(startDate)}</text>\n            <text x=\"${width - pad.right}\" y=\"${height - 10}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">Today</text>\n        </svg>\n    `;\n\n  container.innerHTML = svg;\n}\n\n/**\n * Render PR History (Chronological improvements)\n */\nfunction renderPrHistory(workouts: Workout[]): void {\n  const container = document.getElementById('prHistoryList');\n  if (!container) return;\n\n  // Sort strictly chronological\n  const sorted = [...workouts].sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());\n\n  interface RecordEvent {\n    date: string;\n    metric: string;\n    value: string;\n    improvement: string;\n    workoutId: string;\n  }\n\n  const events: RecordEvent[] = [];\n\n  // State to track maxes\n  let maxPower = 0;\n  let maxHr = 0;\n  const powerCurveBests: Record<number, number> = {};\n\n  sorted.forEach(w => {\n    const summary = getSummary(w);\n    const dateStr = formatDate(w.startTime);\n\n    // Power (1s)\n    if (summary.maxPower && summary.maxPower > maxPower) {\n      if (maxPower > 0) {\n        const diff = summary.maxPower - maxPower;\n        events.push({\n          date: dateStr,\n          metric: 'Max Power',\n          value: `${summary.maxPower} W`,\n          improvement: `+${diff} W`,\n          workoutId: w.id\n        });\n      } else {\n        events.push({ date: dateStr, metric: 'Max Power', value: `${summary.maxPower} W`, improvement: 'New!', workoutId: w.id });\n      }\n      maxPower = summary.maxPower;\n    }\n\n    // HR\n    if (summary.maxHeartrate && summary.maxHeartrate > maxHr) {\n      if (maxHr > 0) {\n        const diff = summary.maxHeartrate - maxHr;\n        events.push({\n          date: dateStr,\n          metric: 'Max Heart Rate',\n          value: `${summary.maxHeartrate} bpm`,\n          improvement: `+${diff} bpm`,\n          workoutId: w.id\n        });\n      } else {\n        events.push({ date: dateStr, metric: 'Max Heart Rate', value: `${summary.maxHeartrate} bpm`, improvement: 'New!', workoutId: w.id });\n      }\n      maxHr = summary.maxHeartrate;\n    }\n\n    // Power Curve - Notable durations (1m, 5m, 20m)\n    if (summary.powerCurve) {\n      const notable = [60, 300, 1200];\n      const labels: Record<number, string> = { 60: '1m Power', 300: '5m Power', 1200: '20m Power' };\n      summary.powerCurve.forEach((p: { duration: number, watts: number }) => {\n        if (notable.includes(p.duration)) {\n          const current = powerCurveBests[p.duration] || 0;\n          if (p.watts > current) {\n            if (current > 0) {\n              events.push({\n                date: dateStr,\n                metric: labels[p.duration],\n                value: `${p.watts} W`,\n                improvement: `+${p.watts - current} W`,\n                workoutId: w.id\n              });\n            } else {\n              events.push({ date: dateStr, metric: labels[p.duration], value: `${p.watts} W`, improvement: 'New!', workoutId: w.id });\n            }\n            powerCurveBests[p.duration] = p.watts;\n          }\n        }\n      });\n    }\n  });\n\n  if (events.length === 0) {\n    container.innerHTML = '<div style=\"text-align: center; color: var(--color-text-secondary); padding: 20px;\">No records found</div>';\n    return;\n  }\n\n  // Sort events reverse chronological (newest first)\n  const reversedEvents = events.reverse();\n\n  container.innerHTML = reversedEvents.map(e => `\n        <div class=\"pr-history-row\" data-id=\"${e.workoutId}\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--color-border); cursor: pointer;\">\n            <div style=\"flex: 1;\">\n                <div style=\"font-weight: 500;\">${e.metric}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">${e.date}</div>\n            </div>\n            <div style=\"text-align: right;\">\n                <div style=\"font-weight: bold; color: var(--color-accent);\">${e.value}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-success);\">${e.improvement}</div>\n            </div>\n        </div>\n    `).join('');\n\n  container.querySelectorAll('.pr-history-row').forEach(row => {\n    row.addEventListener('click', () => {\n      const id = (row as HTMLElement).dataset.id;\n      if (id) viewWorkoutDetails(id);\n    });\n  });\n}\n// Exported helper for the View\nexport async function refreshHistoryView(): Promise<void> {\n  // Reset to today if needed, or just refresh current view\n  if (currentView === 'list') {\n    await loadWorkouts();\n  } else if (currentView === 'calendar') {\n    await loadCalendar();\n  } else if (currentView === 'analytics') {\n    await loadAnalytics();\n  }\n}\n\n/**\n * Parses telemetry and renders charts for workout detail\n */\nfunction renderWorkoutCharts(telemetryJson: string, startTimeIso: string | number): void {\n  try {\n    const data = JSON.parse(telemetryJson) as MeasurementsData;\n    const startTs = typeof startTimeIso === 'string' ? new Date(startTimeIso).getTime() : startTimeIso;\n\n    // Power Chart\n    const powerContainer = document.getElementById('wd-chart-power');\n    if (powerContainer && data.power && data.power.length > 0) {\n      const points = data.power.map(p => ({ x: p.timestamp - startTs, y: p.value }));\n      renderLineChart(powerContainer, points, {\n        title: 'Power',\n        color: '#fbbf24', // Amber 400\n        yLabel: 'Watts',\n        yMin: 0\n      });\n    } else if (powerContainer) {\n      powerContainer.style.display = 'none';\n    }\n\n    // Heart Rate Chart\n    const hrContainer = document.getElementById('wd-chart-hr');\n    if (hrContainer && data.heartrate && data.heartrate.length > 0) {\n      const points = data.heartrate.map(p => ({ x: p.timestamp - startTs, y: p.value }));\n      renderLineChart(hrContainer, points, {\n        title: 'Heart Rate',\n        color: '#f87171', // Red 400\n        yLabel: 'BPM',\n        yMin: 40\n      });\n    } else if (hrContainer) {\n      hrContainer.style.display = 'none';\n    }\n\n    // Cadence Chart\n    const cadContainer = document.getElementById('wd-chart-cadence');\n    if (cadContainer && data.cadence && data.cadence.length > 0) {\n      const points = data.cadence.map(p => ({ x: p.timestamp - startTs, y: p.value }));\n      renderLineChart(cadContainer, points, {\n        title: 'Cadence',\n        color: '#60a5fa', // Blue 400\n        yLabel: 'RPM',\n        yMin: 0\n      });\n    } else if (cadContainer) {\n      cadContainer.style.display = 'none';\n    }\n\n    // Altitude Chart\n    const altContainer = document.getElementById('wd-chart-altitude');\n    if (altContainer && data.altitude && data.altitude.length > 0) {\n      const points = data.altitude.map(p => ({ x: p.timestamp - startTs, y: p.value }));\n      // Filter out zero altitudes if unlikely\n      const validPoints = points.filter(p => p.y !== 0);\n\n      if (validPoints.length > 0) {\n        renderLineChart(altContainer, validPoints, {\n          title: 'Altitude',\n          color: '#34d399', // Emerald 400\n          yLabel: 'Meters'\n        });\n      } else {\n        altContainer.style.display = 'none';\n      }\n    } else if (altContainer) {\n      altContainer.style.display = 'none';\n    }\n\n  } catch (e) {\n    console.error('Failed to parse telemetry for charts', e);\n  }\n}\n\n/**\n * Start the Crop Tool for a workout\n */\nfunction startCropTool(workout: Workout): void {\n  if (!workout.telemetry || !workout.startTime) {\n    alert('No telemetry data available for cropping');\n    return;\n  }\n\n  const detailPanel = document.getElementById('workoutDetailPanel');\n  if (!detailPanel) return;\n\n  let measurements: MeasurementsData | null = null;\n  try {\n    measurements = JSON.parse(workout.telemetry) as MeasurementsData;\n  } catch (e) {\n    console.error('Invalid telemetry', e);\n    alert('Failed to parse workout data');\n    return;\n  }\n\n  if (!measurements) return;\n\n  const originalStart = new Date(workout.startTime).getTime();\n  const originalEnd = workout.endTime ? new Date(workout.endTime).getTime() : originalStart + (workout.duration || 0) * 1000;\n\n  // Initial state\n  let currentStart = originalStart;\n  let currentEnd = originalEnd;\n  const durationMs = originalEnd - originalStart;\n\n  // Render Crop UI\n  detailPanel.innerHTML = `\n    <div class=\"workout-crop-tool\">\n      <div class=\"workout-detail-header\">\n        <button id=\"cancelCropBtn\" class=\"workout-back-btn\">Cancel</button>\n        <h3>Crop Workout</h3>\n        <button id=\"saveCropBtn\" class=\"workout-action-btn workout-status-completed\">Save Changes</button>\n      </div>\n\n      <div class=\"crop-controls\" style=\"margin: 20px 0; padding: 20px; background: var(--color-bg-secondary); border-radius: 8px;\">\n         <div style=\"display: flex; justify-content: space-between; margin-bottom: 20px;\">\n             <div>\n                 <label>Start Time offset</label>\n                 <div class=\"value-display\" id=\"cropStartDisplay\">00:00</div>\n                 <input type=\"range\" id=\"cropStartSlider\" min=\"0\" max=\"${durationMs}\" value=\"0\" style=\"width: 100%\">\n             </div>\n             <div style=\"text-align: right;\">\n                 <label>End Time offset</label>\n                 <div class=\"value-display\" id=\"cropEndDisplay\">${formatDuration(durationMs / 1000)}</div>\n                 <input type=\"range\" id=\"cropEndSlider\" min=\"0\" max=\"${durationMs}\" value=\"${durationMs}\" style=\"width: 100%\">\n             </div>\n         </div>\n         \n         <div style=\"text-align: center; font-weight: bold; margin-bottom: 10px;\">\n            New Duration: <span id=\"cropDurationDisplay\">${formatDuration(durationMs / 1000)}</span>\n         </div>\n         \n         <div id=\"cropPreviewChart\" style=\"height: 150px; background: var(--card-bg); border-radius: 8px;\"></div>\n      </div>\n      \n      <div class=\"crop-info\" style=\"font-size: 0.9em; color: var(--color-text-secondary); margin-top: 10px;\">\n          <p> Saving will overwrite the original workout data. This cannot be undone.</p>\n      </div>\n    </div>\n  `;\n\n  // Init interaction\n  const sliderStart = document.getElementById('cropStartSlider') as HTMLInputElement;\n  const sliderEnd = document.getElementById('cropEndSlider') as HTMLInputElement;\n  const displayStart = document.getElementById('cropStartDisplay');\n  const displayEnd = document.getElementById('cropEndDisplay');\n  const displayDuration = document.getElementById('cropDurationDisplay');\n  const chartContainer = document.getElementById('cropPreviewChart')!;\n\n  // Render preview chart (using Power as reference)\n  const renderPreview = () => {\n    if (measurements && measurements.power) {\n      const cropped = cropWorkout(measurements, originalStart, currentStart, currentEnd);\n      const points = cropped.measurements.power.map(p => ({ x: p.timestamp - currentStart, y: p.value }));\n\n      renderLineChart(chartContainer, points, {\n        title: 'Preview (Power)',\n        color: '#fbbf24',\n        yMin: 0,\n        height: 150\n      });\n    }\n  };\n\n  const updateUI = () => {\n    const startOffset = parseInt(sliderStart.value);\n    const endOffset = parseInt(sliderEnd.value);\n\n    // Enforce constraints\n    if (startOffset >= endOffset) {\n      // Prevent crossing\n      if (document.activeElement === sliderStart) {\n        sliderStart.value = (endOffset - 10000).toString(); // Keep 10s gap\n      } else {\n        sliderEnd.value = (startOffset + 10000).toString();\n      }\n      return;\n    }\n\n    currentStart = originalStart + parseInt(sliderStart.value);\n    currentEnd = originalStart + parseInt(sliderEnd.value);\n\n    if (displayStart) displayStart.textContent = formatDuration(parseInt(sliderStart.value) / 1000);\n    if (displayEnd) displayEnd.textContent = formatDuration(parseInt(sliderEnd.value) / 1000);\n    if (displayDuration) displayDuration.textContent = formatDuration((currentEnd - currentStart) / 1000);\n\n    renderPreview();\n  };\n\n  sliderStart.addEventListener('input', updateUI);\n  sliderEnd.addEventListener('input', updateUI);\n\n  // Initial render\n  setTimeout(renderPreview, 0);\n\n  // Cancel Action\n  document.getElementById('cancelCropBtn')?.addEventListener('click', () => {\n    viewWorkoutDetails(workout.id);\n  });\n\n  // Save Action\n  document.getElementById('saveCropBtn')?.addEventListener('click', async () => {\n    const btn = document.getElementById('saveCropBtn') as HTMLButtonElement;\n    btn.disabled = true;\n    btn.textContent = 'Saving...';\n\n    try {\n      const result = cropWorkout(measurements!, originalStart, currentStart, currentEnd);\n\n      // Construct updated workout object (for future API syncing)\n      // const updatedWorkout = {\n      //     ...workout,\n      //     startTime: new Date(result.startTime).toISOString(),\n      //     endTime: new Date(result.endTime).toISOString(),\n      //     duration: result.duration,\n      //     summary: JSON.stringify(result.summary),\n      //     telemetry: JSON.stringify(result.measurements)\n      // };\n\n      // Save methods\n      if (isIndexedDBSupported()) {\n        // Always update local storage if available\n        const { saveCompletedWorkout } = await import('../storage/workoutStorage.js');\n        await saveCompletedWorkout(\n          result.measurements,\n          result.startTime,\n          result.endTime\n        );\n\n        // If we are renaming/replacing, we might need to delete the old one if the ID depends on start time.\n        // ID is 'workout_' + startTime.\n        // If start time changes, ID changes!\n        if (result.startTime !== originalStart) {\n          // We created a new record. Should we delete the old one?\n          // Yes, to avoid duplicates.\n          // But wait, if it came from API, ID is a UUID usually.\n        }\n      }\n\n      // If pure local (ID starts with workout_), we might need to handle ID change or just update data\n      // If it is an API workout, we need to send update to server\n      // TODO: Implement API update for telemetry. For now, we only update local if possible or alert user.\n      if (dataSource === 'local' || workout.id.startsWith('workout_')) {\n        if (result.startTime !== originalStart) {\n          // const { deleteWorkout: deleteLocal } = await import('../api/workoutClient.js'); \n          // TODO: Implement local cleanup for renamed/moved workouts\n        }\n        alert('Workout cropped and saved locally.');\n      } else {\n        alert('Cropping currently only supported for local workouts (Server update not implemented). Changes are saved to local history.');\n        // We just saved it to local indexedDb as a new workout potentially.\n      }\n\n      // Return to details\n      // If ID changed, we might need to go to list\n      if (result.startTime !== originalStart && workout.id.startsWith('workout_')) {\n        // Go to list\n        const listPanel = document.getElementById('workoutListPanel');\n        if (detailPanel && listPanel) {\n          detailPanel.style.display = 'none';\n          listPanel.style.display = 'block';\n          // Trigger refresh mechanism?\n          document.getElementById('historyRefresh')?.click();\n        }\n      } else {\n        viewWorkoutDetails(workout.id);\n      }\n\n    } catch (e) {\n      console.error('Failed to save crop', e);\n      alert('Error saving cropped workout');\n      btn.disabled = false;\n      btn.textContent = 'Save Changes';\n    }\n  });\n}\n","import { View } from '../router/View.js';\nimport { initHistoryLogic, refreshHistoryView } from '../ui/workoutHistory.js';\n\nexport class HistoryView implements View {\n    public id = 'history';\n    private isInitialized = false;\n\n    public init(container: HTMLElement): void {\n        const template = document.getElementById('workoutHistoryTemplate') as HTMLTemplateElement;\n\n        if (template) {\n            const content = template.content.cloneNode(true);\n            container.appendChild(content);\n\n            // Initialize the logic now that elements are in the DOM\n            // We use setTimeout to ensure the DOM update is processed\n            setTimeout(() => {\n                initHistoryLogic();\n                this.isInitialized = true;\n            }, 0);\n        } else {\n            console.error('History template not found!');\n            container.innerHTML = '<p>Error loading history view</p>';\n        }\n    }\n\n    public onEnter(): void {\n        if (this.isInitialized) {\n            refreshHistoryView();\n        } else {\n            // Fallback if onEnter is called too fast (shouldn't happen with sync init)\n            // logic is initialized in init(), but data might need loading\n            setTimeout(() => refreshHistoryView(), 50);\n        }\n    }\n\n    public onLeave(): void {\n        // Cleanup if needed\n    }\n}\n"],"file":"HistoryView-DlKmdFTE.js"}