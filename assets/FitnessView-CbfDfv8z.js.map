{"version":3,"file":"FitnessView-CbfDfv8z.js","sources":["../../src/views/FitnessView.ts"],"sourcesContent":["import { View } from '../router/View.js';\nimport { Chart, registerables, ScriptableContext } from 'chart.js';\nimport { getClientPMCData } from '../services/fitnessService.js';\nimport { DailyPMC } from '../storage/workoutStorage.js';\nimport { showModal } from '../ui/modal.js';\n\nChart.register(...registerables);\n\nexport class FitnessView implements View {\n    public id = 'fitness';\n    private container: HTMLElement | null = null;\n    private chart: Chart | null = null;\n\n    public init(container: HTMLElement): void {\n        this.container = container;\n        this.container.innerHTML = `\n            <div class=\"view-header\" style=\"display: flex; align-items: center; justify-content: space-between;\">\n                <h2>Fitness & Freshness</h2>\n                <button id=\"fitness-help-btn\" class=\"icon-btn\" aria-label=\"Help\" style=\"background: none; border: none; font-size: 1.5rem; cursor: pointer;\">ℹ️</button>\n            </div>\n            <div class=\"fitness-content\" style=\"padding: 1rem; max-width: 1200px; margin: 0 auto;\">\n                \n                <!-- Current Status Cards -->\n                <div id=\"fitness-summary\" style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;\">\n                    <!-- Populated by JS -->\n                </div>\n\n                <!-- Interpretation Message -->\n                <div id=\"fitness-advice\" class=\"status-card\" style=\"margin-bottom: 2rem; padding: 1rem; border-radius: 8px; background: var(--bg-secondary); border-left: 4px solid var(--color-primary-500); display: none;\">\n                    <!-- Populated by JS -->\n                </div>\n\n                <div class=\"chart-container\" style=\"position: relative; height: 400px; width: 100%; margin-bottom: 2rem;\">\n                    <canvas id=\"pmcChart\"></canvas>\n                </div>\n                \n                <div id=\"fitness-status\" class=\"status-message\" style=\"margin-top: 1rem; text-align: center; color: var(--text-muted);\">Loading data...</div>\n            </div>\n        `;\n\n        this.container.querySelector('#fitness-help-btn')?.addEventListener('click', () => {\n            this.showHelpModal();\n        });\n    }\n\n    private showHelpModal(): void {\n        const content = document.createElement('div');\n        content.innerHTML = `\n            <div style=\"display: grid; gap: 1.5rem;\">\n                <div>\n                    <h4 style=\"color: rgb(75, 192, 192); margin-bottom: 0.5rem; font-size: 1.1em;\">Fitness (CTL)</h4>\n                    <p style=\"font-size: 0.95em; line-height: 1.5; color: var(--text-secondary);\">\n                        <strong>Your long-term endurance (42-day avg).</strong><br>\n                        Shows how much training load you've built up over the last 6 weeks. Higher is generally better for endurance performance.\n                    </p>\n                </div>\n                <div>\n                    <h4 style=\"color: rgb(255, 99, 132); margin-bottom: 0.5rem; font-size: 1.1em;\">Fatigue (ATL)</h4>\n                    <p style=\"font-size: 0.95em; line-height: 1.5; color: var(--text-secondary);\">\n                        <strong>Your recent tiredness (7-day avg).</strong><br>\n                        Tracks short-term exhaustion from hard efforts this week. Spikes quickly after training and drops when you rest.\n                    </p>\n                </div>\n                <div>\n                    <h4 style=\"color: rgb(255, 205, 86); margin-bottom: 0.5rem; font-size: 1.1em;\">Form (TSB)</h4>\n                    <p style=\"font-size: 0.95em; line-height: 1.5; color: var(--text-secondary);\">\n                        <strong>Your race readiness (Fitness - Fatigue).</strong><br>\n                        • <strong>Positive:</strong> You are fresh and ready for race day.<br>\n                        • <strong>Negative:</strong> You are in a heavy training block and building fitness.\n                    </p>\n                </div>\n            </div>\n        `;\n\n        showModal({\n            title: 'Chart Metrics Guide',\n            content,\n            closeOnOverlay: true,\n            buttons: [\n                {\n                    text: 'Close',\n                    variant: 'secondary',\n                    onClick: () => {\n                        // Modal closes automatically, just need a placeholder\n                        const closeBtn = document.querySelector('.modal-close-btn') as HTMLButtonElement | null;\n                        closeBtn?.click();\n                    },\n                },\n            ],\n        });\n    }\n\n    public async onEnter(): Promise<void> {\n        // Load data on enter\n        await this.loadData();\n    }\n\n    public onLeave(): void {\n        if (this.chart) {\n            this.chart.destroy();\n            this.chart = null;\n        }\n    }\n\n    private async loadData(): Promise<void> {\n        try {\n            console.log('FitnessView: Loading data...');\n            const data = await getClientPMCData();\n            console.log('FitnessView: Data loaded', data.length);\n\n            const status = this.container?.querySelector('#fitness-status');\n\n            if (data.length === 0) {\n                if (status) {\n                    status.textContent =\n                        'No fitness data available yet. Complete a workout with power data to see your stats!';\n                    status.classList.remove('loading');\n                }\n                // Do not render empty chart, it looks broken\n                if (this.chart) {\n                    this.chart.destroy();\n                    this.chart = null;\n                }\n                return;\n            }\n\n            this.renderChart(data);\n            this.renderSummary(data);\n\n            if (status) {\n                status.textContent = '';\n                status.classList.remove('loading');\n            }\n        } catch (error) {\n            console.error('FitnessView Error:', error);\n            const status = this.container?.querySelector('#fitness-status');\n            if (status) {\n                status.textContent = 'Error loading fitness data. See console for details.';\n                status.classList.remove('loading');\n            }\n        }\n    }\n\n    private renderSummary(data: DailyPMC[]): void {\n        const summaryContainer = this.container?.querySelector('#fitness-summary');\n        const adviceContainer = this.container?.querySelector('#fitness-advice');\n\n        if (!summaryContainer || !adviceContainer || data.length === 0) return;\n\n        const latest = data[data.length - 1];\n        const status = this.getFormStatus(latest.tsb);\n\n        // Render Cards\n        summaryContainer.innerHTML = `\n            <div style=\"background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center; box-shadow: var(--shadow-sm);\">\n                <div style=\"font-size: 0.9em; color: var(--text-secondary); margin-bottom: 0.5rem;\">Fitness (CTL)</div>\n                <div style=\"font-size: 1.8em; font-weight: bold; color: rgb(75, 192, 192);\">${Math.round(latest.ctl)}</div>\n            </div>\n            <div style=\"background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center; box-shadow: var(--shadow-sm);\">\n                <div style=\"font-size: 0.9em; color: var(--text-secondary); margin-bottom: 0.5rem;\">Fatigue (ATL)</div>\n                <div style=\"font-size: 1.8em; font-weight: bold; color: rgb(255, 99, 132);\">${Math.round(latest.atl)}</div>\n            </div>\n            <div style=\"background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center; box-shadow: var(--shadow-sm);\">\n                <div style=\"font-size: 0.9em; color: var(--text-secondary); margin-bottom: 0.5rem;\">Form (TSB)</div>\n                <div style=\"font-size: 1.8em; font-weight: bold; color: ${status.color};\">${Math.round(latest.tsb)}</div>\n            </div>\n        `;\n\n        // Render Advice\n        adviceContainer.innerHTML = `\n            <div style=\"font-weight: bold; margin-bottom: 0.5rem; color: ${status.color}; font-size: 1.1em;\">${status.label}</div>\n            <div style=\"color: var(--text-primary); line-height: 1.5;\">${status.description}</div>\n        `;\n        (adviceContainer as HTMLElement).style.display = 'block';\n        (adviceContainer as HTMLElement).style.borderLeftColor = status.color;\n    }\n\n    private getFormStatus(tsb: number): { label: string; color: string; description: string } {\n        if (tsb > 25)\n            return {\n                label: 'Transition Phase',\n                color: 'var(--color-info-main)',\n                description:\n                    'You are very fresh. This zone is typical when taking a break or tapering significantly before a major race. Prolonged time here means you are losing fitness.',\n            };\n        if (tsb >= 5)\n            return {\n                label: 'Fresh & Ready',\n                color: 'var(--color-success-main)',\n                description:\n                    'You are well-rested and primed for performance. This is the ideal state for race day or a personal best attempt.',\n            };\n        if (tsb >= -10)\n            return {\n                label: 'Neutral / Maintenance',\n                color: 'var(--color-text-secondary)',\n                description:\n                    'A balanced state. You are maintaining your fitness levels without accumulating excessive fatigue.',\n            };\n        if (tsb >= -30)\n            return {\n                label: 'Productive Training',\n                color: 'var(--color-warning-main)',\n                description:\n                    'Optimal training zone. You are pushing your body enough to stimulate fitness gains, but not so hard that you risk crashing.',\n            };\n        return {\n            label: 'High Fatigue Risk',\n            color: 'var(--color-error-main)',\n            description:\n                'You are digging deep. Short periods here are okay for overload blocks, but stay here too long and you risk overtraining or illness. Consider a rest week.',\n        };\n    }\n\n    private renderChart(data: DailyPMC[]): void {\n        const ctx = (this.container?.querySelector('#pmcChart') as HTMLCanvasElement)?.getContext('2d');\n        if (!ctx) return;\n\n        if (this.chart) {\n            this.chart.destroy();\n        }\n\n        // Get computed style for colors if possible, else use defaults\n        const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#666666';\n        const gridColor =\n            getComputedStyle(document.body).getPropertyValue('--border-default').trim() || 'rgba(128, 128, 128, 0.1)';\n\n        this.chart = new Chart(ctx, {\n            type: 'line',\n            data: {\n                labels: data.map((d) => d.date),\n                datasets: [\n                    {\n                        label: 'Fitness (CTL)',\n                        data: data.map((d) => d.ctl),\n                        borderColor: 'rgb(75, 192, 192)',\n                        backgroundColor: 'rgba(75, 192, 192, 0.2)',\n                        yAxisID: 'y',\n                        fill: true,\n                        tension: 0.1,\n                    },\n                    {\n                        label: 'Fatigue (ATL)',\n                        data: data.map((d) => d.atl),\n                        borderColor: 'rgb(255, 99, 132)',\n                        backgroundColor: 'rgba(255, 99, 132, 0.2)',\n                        yAxisID: 'y',\n                        fill: false,\n                        tension: 0.1,\n                    },\n                    {\n                        label: 'Form (TSB)',\n                        data: data.map((d) => d.tsb),\n                        borderColor: 'rgb(255, 205, 86)',\n                        backgroundColor: (context: ScriptableContext<'bar'>) => {\n                            const value = context.raw as number;\n                            return value < 0 ? 'rgba(255, 99, 132, 0.5)' : 'rgba(75, 192, 192, 0.5)';\n                        },\n                        yAxisID: 'y1',\n                        type: 'bar',\n                        barThickness: 'flex',\n                        maxBarThickness: 10,\n                    },\n                ],\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                interaction: {\n                    mode: 'index',\n                    intersect: false,\n                },\n                plugins: {\n                    legend: {\n                        labels: { color: textColor },\n                    },\n                },\n                scales: {\n                    x: {\n                        ticks: { color: textColor },\n                        grid: { color: gridColor },\n                    },\n                    y: {\n                        type: 'linear',\n                        display: true,\n                        position: 'left',\n                        title: { display: true, text: 'Load (TSS/day)', color: textColor },\n                        ticks: { color: textColor },\n                        grid: { color: gridColor },\n                    },\n                    y1: {\n                        type: 'linear',\n                        display: true,\n                        position: 'right',\n                        title: { display: true, text: 'Form', color: textColor },\n                        grid: { drawOnChartArea: false },\n                        ticks: { color: textColor },\n                    },\n                },\n            },\n        });\n    }\n}\n"],"names":["Chart","registerables","FitnessView","container","content","showModal","data","getClientPMCData","status","error","summaryContainer","adviceContainer","latest","tsb","ctx","textColor","gridColor","d","context"],"mappings":"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"}