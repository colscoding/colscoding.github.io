{"version":3,"mappings":"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","names":["API_BASE_URL","API_KEY","getFtpHistory","userId","headers","response","renderLineChart","container","data","options","height","color","padTop","padBottom","padLeft","padRight","processedData","downsample","xValues","p","yValues","minX","maxX","minY","maxY","yRange","width","getX","val","getY","pathD","areaD","gridLines","yStep","i","y","startTimeStr","formatTime","midTimeStr","endTimeStr","svg","target","step","result","ms","totalSeconds","h","m","s","renderBarChart","barGap","availableWidth","barWidth","index","bars","x","labelStep","xLabels","date","label","emptyStats","getSummary","workout","currentWorkouts","trendMetric","renderPeriodStatistics","containerId","workouts","statsContainer","renderSummaryTable","renderTrendsChart","parent","card","now","startOfWeek","day","startOfLastWeek","endOfLastWeek","startOfMonth","startOfLastMonth","endOfLastMonth","startOfYear","periods","w","summary","buckets","stat","dur","renderCell","rows","v","formatDuration","row","e","updateChart","select","weeks","d","weekKey","getWeekKey","points","a","b","key","year","week","getDateFromWeek","title","dayNum","yearStart","weekNo","diff","cropWorkout","measurements","originalStartTime","newStartTime","newEndTime","start","end","filterMeasurements","croppedMeasurements","t","l","duration","modalSummary","calculateWorkoutSummary","first","last","currentPage","totalPages","dbAvailable","filterType","filterStartDate","filterEndDate","currentView","calendarDate","dataSource","initHistoryLogic","prevBtn","nextBtn","refreshBtn","typeFilter","dateStart","dateEnd","viewListBtn","viewCalendarBtn","viewAnalyticsBtn","listView","calendarView","analyticsView","prevMonthBtn","nextMonthBtn","sourceCloudBtn","sourceLocalBtn","setSource","checkDatabaseAvailability","setView","view","loadWorkouts","loadCalendar","loadAnalytics","handleFilterChange","historyButton","hasIndexedDB","isIndexedDBSupported","isDatabaseAvailable","updateSourceToggle","storedToWorkout","stored","listContainer","pageInfo","getCompletedWorkouts","total","listWorkouts","pagination","renderWorkoutCard","workoutId","viewWorkoutDetails","confirmDeleteWorkout","syncWorkout","error","message","cloudBtn","localBtn","localId","local","announce","createRes","createWorkout","formatDate","completeWorkout","markWorkoutSynced","statusClass","syncBtn","detailPanel","listPanel","getWorkout","renderWorkoutDetail","renderZoneChart","renderWorkoutCharts","exportWorkoutData","startCropTool","filename","jsonData","jsonBlob","jsonUrl","jsonLink","deleteWorkout","calendarGrid","monthLabel","monthNames","month","startDate","endDate","renderCalendar","renderMonthlyStats","firstDay","daysInMonth","empty","dayCell","wDate","dot","icon","today","totalWorkouts","totalDuration","acc","totalDistance","totalEnergy","prList","ftpHistory","renderAnalytics","renderPersonalRecords","renderTrainingLoad","renderPowerCurve","renderFitnessTrend","renderFtpHistory","renderPrHistory","maxPower","maxHr","longestRide","maxDistance","dateStr","createRow","value","id","weekNum","getWeekNumber","maxLoad","load","bests","durations","pad","maxWatts","formatDurationLabel","sec","sorted","tssMap","current","dataPoints","kCTL","kATL","ctl","atl","tss","chartW","chartH","maxVal","timeSpan","ctlPath","atlPath","history","maxFtp","minFtp","ftpRange","currX","prevY","currY","events","powerCurveBests","notable","labels","reversedEvents","refreshHistoryView","ZONE_COLORS","formatZoneTime","seconds","mins","secs","hours","distribution","activeZones","maxTime","z","html","zone","percent","totalPercent","timeStr","telemetryJson","startTimeIso","startTs","powerContainer","hrContainer","cadContainer","altContainer","validPoints","originalStart","originalEnd","currentStart","currentEnd","durationMs","sliderStart","sliderEnd","displayStart","displayEnd","displayDuration","chartContainer","renderPreview","updateUI","startOffset","endOffset","btn","saveCompletedWorkout","__vitePreload","n","HistoryView","template","content"],"ignoreList":[],"sources":["../../src/api/userClient.ts","../../src/ui/charts.ts","../../src/ui/statistics.ts","../../src/utils/cropWorkout.ts","../../src/ui/workoutHistory.ts","../../src/views/HistoryView.ts"],"sourcesContent":["/**\n * API client for user operations\n * Handles communication with the user API including FTP history\n *\n * @module userClient\n */\n\nconst API_BASE_URL: string = import.meta.env.VITE_API_URL || '';\nconst API_KEY: string | undefined = import.meta.env.VITE_API_KEY;\n\nexport interface FtpHistoryEntry {\n    id: string;\n    userId: string;\n    ftp: number;\n    source: string | null;\n    createdAt: string;\n}\n\nexport interface UserSettings {\n    theme?: 'light' | 'dark' | 'system';\n    units?: 'metric' | 'imperial';\n    notifications?: boolean;\n    ftp?: number;\n}\n\n/**\n * Get user FTP history\n */\nexport async function getFtpHistory(userId: string): Promise<FtpHistoryEntry[]> {\n    const headers: Record<string, string> = {\n        'Content-Type': 'application/json',\n    };\n\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n\n    const response = await fetch(`${API_BASE_URL}/api/users/${userId}/ftp-history`, {\n        headers,\n    });\n\n    if (!response.ok) {\n        throw new Error(`Failed to fetch FTP history: ${response.statusText}`);\n    }\n\n    return response.json();\n}\n\n/**\n * Update user FTP\n */\nexport async function updateUserFtp(userId: string, ftp: number, source: string = 'manual'): Promise<{ ftp: number }> {\n    const headers: Record<string, string> = {\n        'Content-Type': 'application/json',\n    };\n\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n\n    const response = await fetch(`${API_BASE_URL}/api/users/${userId}/ftp`, {\n        method: 'PUT',\n        headers,\n        body: JSON.stringify({ ftp, source }),\n    });\n\n    if (!response.ok) {\n        throw new Error(`Failed to update FTP: ${response.statusText}`);\n    }\n\n    return response.json();\n}\n","/**\n * Simple SVG Charting Library for Bike Power Tracker\n *\n * Renders lightweight SVG charts for workout analysis.\n *\n * @module ui/charts\n */\n\nexport interface Point {\n    x: number; // Timestamp or relative time\n    y: number; // Value\n}\n\nexport interface ChartOptions {\n    color?: string;\n    height?: number;\n    title?: string;\n    yLabel?: string;\n    xLabel?: string;\n    yMin?: number;\n    yMax?: number;\n}\n\n/**\n * Render a simple line chart into a container\n */\nexport function renderLineChart(container: HTMLElement, data: Point[], options: ChartOptions = {}): void {\n    if (!container) return;\n\n    // Configuration\n    const height = options.height || 200;\n    const color = options.color || 'var(--color-accent)';\n    const padTop = 20;\n    const padBottom = 30;\n    const padLeft = 40;\n    const padRight = 10;\n\n    // Handle empty data\n    if (!data || data.length < 2) {\n        container.innerHTML = `\n            <div style=\"\n                display:flex; \n                justify-content:center; \n                align-items:center; \n                height:${height}px; \n                color: var(--color-text-secondary);\n                background: var(--card-bg);\n                border-radius: 8px;\n            \">\n                No data available\n            </div>\n        `;\n        return;\n    }\n\n    // Downsample if too many points (limit to ~500 points for performance)\n    const processedData = downsample(data, 500);\n\n    // Get value ranges\n    const xValues = processedData.map((p) => p.x);\n    const yValues = processedData.map((p) => p.y);\n\n    const minX = Math.min(...xValues);\n    const maxX = Math.max(...xValues);\n    let minY = options.yMin ?? Math.min(...yValues);\n    let maxY = options.yMax ?? Math.max(...yValues);\n\n    // Add some headroom to Y axis\n    const yRange = maxY - minY;\n    if (yRange === 0) {\n        maxY += 10;\n        minY -= 10;\n    } else {\n        // If not fixed to 0, add padding. If usually 0-based (like power), kept 0.\n        if (options.yMin === undefined) {\n            // If data is far from 0, don't force 0, but add padding\n            minY -= yRange * 0.1;\n        }\n        maxY += yRange * 0.1;\n    }\n\n    // Get container width\n    const width = container.clientWidth || container.parentElement?.clientWidth || 600;\n\n    // Helper to map values to coordinates\n    const getX = (val: number) => padLeft + ((val - minX) / (maxX - minX)) * (width - padLeft - padRight);\n    const getY = (val: number) => height - padBottom - ((val - minY) / (maxY - minY)) * (height - padTop - padBottom);\n\n    // Generate Path\n    const pathD = `M ${processedData.map((p) => `${getX(p.x).toFixed(1)},${getY(p.y).toFixed(1)}`).join(' L ')}`;\n\n    // Generate Area fill (optional, looks nice)\n    const areaD = `${pathD} L ${getX(processedData[processedData.length - 1].x).toFixed(1)},${height - padBottom} L ${getX(processedData[0].x).toFixed(1)},${height - padBottom} Z`;\n\n    // Generate Grid Lines\n    // Y-Axis: 5 lines\n    const gridLines = [];\n    const yStep = (maxY - minY) / 4;\n    for (let i = 0; i <= 4; i++) {\n        const val = minY + i * yStep;\n        const y = getY(val);\n        gridLines.push(`\n            <line x1=\"${padLeft}\" y1=\"${y}\" x2=\"${width - padRight}\" y2=\"${y}\" stroke=\"var(--color-border)\" stroke-width=\"1\" stroke-dasharray=\"4\" opacity=\"0.5\" />\n            <text x=\"${padLeft - 5}\" y=\"${y + 4}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${Math.round(val)}</text>\n        `);\n    }\n\n    // X-Axis: Time labels (Start, Middle, End)\n    const startTimeStr = formatTime(0); // Relative time 0\n    const midTimeStr = formatTime((maxX - minX) / 2);\n    const endTimeStr = formatTime(maxX - minX);\n\n    // Construct SVG\n    const svg = `\n        <svg width=\"100%\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\" style=\"background: var(--card-bg); border-radius: 8px;\">\n            <defs>\n                <linearGradient id=\"chartGradient-${options.title?.replace(/\\s/g, '')}\" x1=\"0\" x2=\"0\" y1=\"0\" y2=\"1\">\n                    <stop offset=\"0%\" stop-color=\"${color}\" stop-opacity=\"0.2\"/>\n                    <stop offset=\"100%\" stop-color=\"${color}\" stop-opacity=\"0\"/>\n                </linearGradient>\n            </defs>\n\n            <!-- Grid -->\n            ${gridLines.join('')}\n\n            <!-- Axis Labels -->\n            <text x=\"${padLeft}\" y=\"${height - 10}\" text-anchor=\"start\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${startTimeStr}</text>\n            <text x=\"${width / 2}\" y=\"${height - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${midTimeStr}</text>\n            <text x=\"${width - padRight}\" y=\"${height - 10}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${endTimeStr}</text>\n\n            <!-- Data Area -->\n            <path d=\"${areaD}\" fill=\"url(#chartGradient-${options.title?.replace(/\\s/g, '')})\" stroke=\"none\" />\n            \n            <!-- Data Line -->\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"${color}\" stroke-width=\"2\" vector-effect=\"non-scaling-stroke\" />\n\n            <!-- Title -->\n            ${options.title ? `<text x=\"${width / 2}\" y=\"${15}\" text-anchor=\"middle\" font-weight=\"bold\" font-size=\"12\" fill=\"var(--color-text-primary)\">${options.title}</text>` : ''}\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n\n/**\n * Reduce approximate number of points to target using simple N-th sampling\n */\nfunction downsample(data: Point[], target: number): Point[] {\n    if (data.length <= target) return data;\n    const step = Math.ceil(data.length / target);\n    const result = [];\n    for (let i = 0; i < data.length; i += step) {\n        result.push(data[i]);\n    }\n    return result;\n}\n\n/**\n * Format milliseconds to HH:MM:SS or MM:SS\n */\nfunction formatTime(ms: number): string {\n    const totalSeconds = Math.floor(ms / 1000);\n    const h = Math.floor(totalSeconds / 3600);\n    const m = Math.floor((totalSeconds % 3600) / 60);\n    const s = totalSeconds % 60;\n\n    if (h > 0) {\n        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;\n    }\n    return `${m}:${s.toString().padStart(2, '0')}`;\n}\n\n/**\n * Render a simple bar chart into a container\n */\nexport function renderBarChart(container: HTMLElement, data: Point[], options: ChartOptions = {}): void {\n    if (!container) return;\n\n    // Configuration\n    const height = options.height || 200;\n    const color = options.color || 'var(--color-accent)';\n    const padTop = 30;\n    const padBottom = 30;\n    const padLeft = 40;\n    const padRight = 10;\n    const barGap = 4;\n\n    // Handle empty data\n    if (!data || data.length === 0) {\n        container.innerHTML = `\n            <div style=\"\n                display:flex; \n                justify-content:center; \n                align-items:center; \n                height:${height}px; \n                color: var(--color-text-secondary);\n                background: var(--card-bg);\n                border-radius: 8px;\n            \">\n                No data available\n            </div>\n        `;\n        return;\n    }\n\n    // Process Values\n    const yValues = data.map((p) => p.y);\n    let maxY = options.yMax ?? Math.max(...yValues) * 1.1; // 10% headroom\n    let minY = options.yMin ?? 0;\n\n    if (maxY === minY) maxY += 10;\n\n    // Get container width\n    const width = container.clientWidth || container.parentElement?.clientWidth || 600;\n\n    // Calculate bar dimensions\n    const availableWidth = width - padLeft - padRight;\n    // Ensure minimum bar width of 2px\n    const barWidth = Math.max(2, availableWidth / data.length - barGap);\n\n    const getX = (index: number) => padLeft + index * (barWidth + barGap) + barGap / 2; // Center in slot\n    const getY = (val: number) => height - padBottom - ((val - minY) / (maxY - minY)) * (height - padTop - padBottom);\n\n    const bars = data.map((p, i) => {\n        const x = getX(i);\n        const y = getY(p.y);\n        const h = Math.max(0, height - padBottom - y); // Prevent negative height\n\n        // Don't render bars with 0 height or weird coordinates\n        if (h <= 0 || isNaN(y) || isNaN(h)) return '';\n\n        return `<rect x=\"${x.toFixed(1)}\" y=\"${y.toFixed(1)}\" width=\"${barWidth.toFixed(1)}\" height=\"${h.toFixed(1)}\" fill=\"${color}\" rx=\"2\" opacity=\"0.8\" />`;\n    });\n\n    // Generate Labels (simplified X axis labels)\n    // Reduce labels if too many\n    const maxLabels = 7;\n    const labelStep = Math.max(1, Math.floor(data.length / maxLabels));\n\n    const xLabels = data.map((p, i) => {\n        if (i % labelStep !== 0) return '';\n        // Date formatting based on X value (timestamp)\n        const date = new Date(p.x);\n        // Short date format DD/MM\n        const label = `${date.getDate()}/${date.getMonth() + 1}`;\n        const x = getX(i) + barWidth / 2;\n        return `<text x=\"${x.toFixed(1)}\" y=\"${height - 5}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${label}</text>`;\n    });\n\n    // Generate Y Grid and Labels\n    const gridLines = [];\n    const yStep = (maxY - minY) / 4;\n    for (let i = 0; i <= 4; i++) {\n        const val = minY + i * yStep;\n        const y = getY(val);\n        gridLines.push(`\n            <line x1=\"${padLeft}\" y1=\"${y}\" x2=\"${width - padRight}\" y2=\"${y}\" stroke=\"var(--color-border)\" stroke-width=\"1\" stroke-dasharray=\"4\" opacity=\"0.3\" />\n            <text x=\"${padLeft - 5}\" y=\"${y + 4}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${Math.round(val)}</text>\n        `);\n    }\n\n    const svg = `\n        <svg width=\"100%\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\" style=\"background: var(--card-bg); border-radius: 8px;\">\n            ${gridLines.join('')}\n            ${bars.join('')}\n            ${xLabels.join('')}\n            <!-- Axis Lines -->\n            <line x1=\"${padLeft}\" y1=\"${padTop}\" x2=\"${padLeft}\" y2=\"${height - padBottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${padLeft}\" y1=\"${height - padBottom}\" x2=\"${width - padRight}\" y2=\"${height - padBottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <!-- Title -->\n             ${options.title ? `<text x=\"${width / 2}\" y=\"15\" text-anchor=\"middle\" font-size=\"12\" font-weight=\"bold\" fill=\"var(--color-text-primary)\">${options.title}</text>` : ''}\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n","/**\n * Statistics View Component\n *\n * Aggregates and renders workout statistics across different time periods.\n *\n * @module ui/statistics\n */\n\nimport type { Workout } from '../api/workoutClient.js';\nimport type { WorkoutSummary } from '../types/measurements.js';\nimport { formatDuration } from '../api/workoutClient.js';\nimport { renderBarChart, type Point } from './charts.js';\n\ninterface PeriodStats {\n    count: number;\n    distance: number;\n    duration: number;\n    elevation: number;\n    energy: number;\n\n    avgPower: number;\n    avgHr: number;\n    avgCadence: number;\n\n    weightedPowerSum: number; // for calculating avg power across varying durations\n    weightedHrSum: number;\n    weightedCadenceSum: number;\n    totalDurationForAvg: number;\n}\n\nconst emptyStats = (): PeriodStats => ({\n    count: 0,\n    distance: 0,\n    duration: 0,\n    elevation: 0,\n    energy: 0,\n    avgPower: 0,\n    avgHr: 0,\n    avgCadence: 0,\n    weightedPowerSum: 0,\n    weightedHrSum: 0,\n    weightedCadenceSum: 0,\n    totalDurationForAvg: 0,\n});\n\nfunction getSummary(workout: Workout): Partial<WorkoutSummary> {\n    if (!workout.summary) return {};\n    if (typeof workout.summary === 'string') {\n        try {\n            return JSON.parse(workout.summary);\n        } catch {\n            return {};\n        }\n    }\n    return workout.summary as unknown as WorkoutSummary;\n}\n\n/**\n * State for the statistics view\n */\nlet currentWorkouts: Workout[] = [];\nlet trendMetric: 'distance' | 'duration' | 'energy' | 'count' = 'distance';\n\n/**\n * Main function to render statistics into a container\n */\nexport function renderPeriodStatistics(containerId: string, workouts: Workout[]): void {\n    const container = document.getElementById(containerId);\n    if (!container) return;\n\n    // Update state\n    currentWorkouts = workouts;\n\n    // Check if we already injected our specific container\n    let statsContainer = document.getElementById('periodStatsContainer');\n    if (!statsContainer) {\n        statsContainer = document.createElement('div');\n        statsContainer.id = 'periodStatsContainer';\n        statsContainer.style.display = 'grid';\n        statsContainer.style.gap = '16px';\n        statsContainer.style.marginBottom = '20px';\n\n        // Insert at the top of the analytics view\n        container.insertBefore(statsContainer, container.firstChild);\n    }\n\n    // 1. Render Summary Table Card\n    renderSummaryTable(statsContainer, workouts);\n\n    // 2. Render Trends Chart Card\n    renderTrendsChart(statsContainer);\n}\n\n/**\n * Render the summary comparison table\n */\nfunction renderSummaryTable(parent: HTMLElement, workouts: Workout[]): void {\n    let card = document.getElementById('statsTableCard');\n    if (!card) {\n        card = document.createElement('div');\n        card.id = 'statsTableCard';\n        card.className = 'card';\n        card.style.background = 'var(--card-bg)';\n        card.style.padding = '16px';\n        card.style.borderRadius = '8px';\n        card.style.border = '1px solid var(--color-border)';\n        parent.appendChild(card);\n    }\n\n    // Constants for periods\n    const now = new Date();\n\n    // Define time ranges\n    // This Week (starts Monday)\n    const startOfWeek = new Date(now);\n    const day = startOfWeek.getDay() || 7; // getDay returns 0 for Sunday\n    if (day !== 1) startOfWeek.setHours(-24 * (day - 1));\n    else startOfWeek.setHours(0, 0, 0, 0);\n    startOfWeek.setHours(0, 0, 0, 0);\n\n    const startOfLastWeek = new Date(startOfWeek);\n    startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);\n    const endOfLastWeek = new Date(startOfWeek);\n\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);\n\n    const startOfYear = new Date(now.getFullYear(), 0, 1);\n\n    // Buckets\n    const periods: Record<'thisWeek' | 'lastWeek' | 'thisMonth' | 'lastMonth' | 'thisYear', PeriodStats> = {\n        thisWeek: emptyStats(),\n        lastWeek: emptyStats(),\n        thisMonth: emptyStats(),\n        lastMonth: emptyStats(),\n        thisYear: emptyStats(),\n    };\n\n    // Aggregate Data\n    workouts.forEach((w) => {\n        const date = new Date(w.startTime);\n        const summary = getSummary(w);\n\n        // Determine which buckets this workout belongs to\n        const buckets: PeriodStats[] = [];\n\n        if (date >= startOfWeek) buckets.push(periods.thisWeek);\n        if (date >= startOfLastWeek && date < endOfLastWeek) buckets.push(periods.lastWeek);\n        if (date >= startOfMonth) buckets.push(periods.thisMonth);\n        if (date >= startOfLastMonth && date <= endOfLastMonth) buckets.push(periods.lastMonth);\n        if (date >= startOfYear) buckets.push(periods.thisYear);\n\n        // Add to buckets\n        buckets.forEach((stat) => {\n            stat.count++;\n            stat.duration += w.duration || 0;\n            stat.distance += summary.totalDistance || 0;\n            stat.elevation += summary.totalElevationGain || 0;\n\n            // Energy\n            if (summary.totalEnergy) {\n                stat.energy += summary.totalEnergy;\n            } else if (summary.avgPower && w.duration) {\n                stat.energy += (summary.avgPower * w.duration) / 1000;\n            }\n\n            // Weighted Averages\n            const dur = w.duration || 0;\n            if (dur > 0) {\n                if (summary.avgPower) stat.weightedPowerSum += summary.avgPower * dur;\n                if (summary.avgHeartrate) stat.weightedHrSum += summary.avgHeartrate * dur;\n                if (summary.avgCadence) stat.weightedCadenceSum += summary.avgCadence * dur;\n                stat.totalDurationForAvg += dur;\n            }\n        });\n    });\n\n    // Finalize Averages\n    Object.values(periods).forEach((stat) => {\n        if (stat.totalDurationForAvg > 0) {\n            stat.avgPower = Math.round(stat.weightedPowerSum / stat.totalDurationForAvg);\n            stat.avgHr = Math.round(stat.weightedHrSum / stat.totalDurationForAvg);\n            stat.avgCadence = Math.round(stat.weightedCadenceSum / stat.totalDurationForAvg);\n        }\n    });\n\n    // Helpers\n    const renderCell = (val: string) =>\n        `<td style=\"padding: 8px; text-align: right; border-bottom: 1px solid var(--color-border);\">${val}</td>`;\n\n    const formatDist = (m: number) => (m / 1000).toFixed(1) + ' km';\n\n    interface RowDef {\n        label: string;\n        key: keyof PeriodStats;\n        fmt: (v: number) => string;\n    }\n\n    const rows: RowDef[] = [\n        { label: 'Workouts', key: 'count', fmt: (v: number) => v.toString() },\n        { label: 'Distance', key: 'distance', fmt: formatDist },\n        { label: 'Time', key: 'duration', fmt: (v: number) => formatDuration(v) },\n        { label: 'Elevation', key: 'elevation', fmt: (v: number) => v + ' m' },\n        { label: 'Avg Power', key: 'avgPower', fmt: (v: number) => v + ' W' },\n        { label: 'Avg HR', key: 'avgHr', fmt: (v: number) => v + ' bpm' },\n        { label: 'Energy', key: 'energy', fmt: (v: number) => Math.round(v) + ' kJ' },\n    ];\n\n    card.innerHTML = `\n        <h4 style=\"margin: 0 0 12px 0;\"> Period Statistics</h4>\n        <div style=\"overflow-x: auto;\">\n            <table style=\"width: 100%; border-collapse: collapse; font-size: 0.9em;\">\n                <thead>\n                    <tr style=\"background: var(--color-bg-secondary);\">\n                        <th style=\"text-align: left; padding: 8px; border-bottom: 2px solid var(--color-border);\">Metric</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Week</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border); color: var(--color-text-secondary);\">Last Week</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Month</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border); color: var(--color-text-secondary);\">Last Month</th>\n                        <th style=\"text-align: right; padding: 8px; border-bottom: 2px solid var(--color-border);\">This Year</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${rows\n                        .map(\n                            (row) => `\n                        <tr>\n                            <td style=\"padding: 8px; font-weight: 500; border-bottom: 1px solid var(--color-border);\">${row.label}</td>\n                            ${renderCell(row.fmt(periods.thisWeek[row.key] as number))}\n                            ${renderCell(row.fmt(periods.lastWeek[row.key] as number))}\n                            ${renderCell(row.fmt(periods.thisMonth[row.key] as number))}\n                            ${renderCell(row.fmt(periods.lastMonth[row.key] as number))}\n                            ${renderCell(row.fmt(periods.thisYear[row.key] as number))}\n                        </tr>\n                    `\n                        )\n                        .join('')}\n                </tbody>\n            </table>\n        </div>\n    `;\n}\n\n/**\n * Render the weekly trends chart\n */\nfunction renderTrendsChart(parent: HTMLElement): void {\n    let card = document.getElementById('statsChartCard');\n\n    // Create card if not exists\n    if (!card) {\n        card = document.createElement('div');\n        card.id = 'statsChartCard';\n        card.className = 'card';\n        card.style.background = 'var(--card-bg)';\n        card.style.padding = '16px';\n        card.style.borderRadius = '8px';\n        card.style.border = '1px solid var(--color-border)';\n\n        // Initial HTML structure with header and controls\n        card.innerHTML = `\n            <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;\">\n                <h4 style=\"margin: 0;\"> Weekly Trends (Last 12 Weeks)</h4>\n                <select id=\"trendMetricSelect\" style=\"padding: 4px; border-radius: 4px; border: 1px solid var(--color-border);\">\n                    <option value=\"distance\">Distance</option>\n                    <option value=\"duration\">Time</option>\n                    <option value=\"energy\">Energy</option>\n                    <option value=\"count\">Workouts</option>\n                </select>\n            </div>\n            <div id=\"trendChartContainer\" style=\"height: 200px;\"></div>\n        `;\n\n        parent.appendChild(card);\n\n        // Add event listener\n        const select = card.querySelector('#trendMetricSelect') as HTMLSelectElement;\n        select?.addEventListener('change', (e) => {\n            trendMetric = (e.target as HTMLSelectElement).value as typeof trendMetric;\n            updateChart();\n        });\n    }\n\n    updateChart();\n}\n\n/**\n * Update the chart content based on current state\n */\nfunction updateChart(): void {\n    const container = document.getElementById('trendChartContainer');\n    if (!container) return;\n\n    const select = document.getElementById('trendMetricSelect') as HTMLSelectElement | null;\n    if (select) select.value = trendMetric; // Sync UI\n\n    // Aggregate data by week for the last 12 weeks\n    const weeks: Record<string, number> = {};\n    const now = new Date();\n\n    // Initialize 12 weeks with 0\n    for (let i = 11; i >= 0; i--) {\n        const d = new Date(now);\n        d.setDate(d.getDate() - i * 7);\n        const weekKey = getWeekKey(d);\n        weeks[weekKey] = 0;\n    }\n\n    // Fill data\n    currentWorkouts.forEach((w) => {\n        const date = new Date(w.startTime);\n        const weekKey = getWeekKey(date);\n\n        if (weeks.hasOwnProperty(weekKey)) {\n            const summary = getSummary(w);\n\n            switch (trendMetric) {\n                case 'distance':\n                    weeks[weekKey] += (summary.totalDistance || 0) / 1000; // km\n                    break;\n                case 'duration':\n                    weeks[weekKey] += w.duration || 0; // seconds\n                    break;\n                case 'energy':\n                    if (summary.totalEnergy) {\n                        weeks[weekKey] += summary.totalEnergy;\n                    } else if (summary.avgPower && w.duration) {\n                        weeks[weekKey] += (summary.avgPower * w.duration) / 1000;\n                    }\n                    break;\n                case 'count':\n                    weeks[weekKey] += 1;\n                    break;\n            }\n        }\n    });\n\n    // Convert to points\n    const points: Point[] = Object.entries(weeks)\n        .sort((a, b) => a[0].localeCompare(b[0]))\n        .map(([key, val]) => {\n            // weekKey is \"YYYY-Www\", parse to timestamp for x-axis\n            const [year, week] = key.split('-W').map(Number);\n            // Rough approximation of week start date for chart x-axis\n            const d = getDateFromWeek(year, week);\n            return { x: d.getTime(), y: val };\n        });\n\n    // Chart options\n    let title = '';\n\n    switch (trendMetric) {\n        case 'distance':\n            title = 'Distance (km)';\n            break;\n        case 'duration':\n            title = 'Time (hours)';\n            break; // Chart formatter might need update for hours?\n        case 'energy':\n            title = 'Energy (kJ)';\n            break;\n        case 'count':\n            title = 'Number of Workouts';\n            break;\n    }\n\n    // Special formatting for duration\n    if (trendMetric === 'duration') {\n        points.forEach((p) => (p.y = p.y / 3600)); // Convert seconds to hours\n    }\n\n    renderBarChart(container, points, {\n        title,\n        height: 200,\n        color: 'var(--color-accent)',\n    });\n}\n\n/**\n * Get ISO week string \"YYYY-Www\"\n */\nfunction getWeekKey(date: Date): string {\n    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    const dayNum = d.getUTCDay() || 7;\n    d.setUTCDate(d.getUTCDate() + 4 - dayNum);\n    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    const weekNo = Math.ceil(((d.getTime() - yearStart.getTime()) / 86400000 + 1) / 7);\n    return `${d.getUTCFullYear()}-W${weekNo.toString().padStart(2, '0')}`;\n}\n\n/**\n * Get date object from year and week number\n */\nfunction getDateFromWeek(year: number, week: number): Date {\n    const d = new Date(year, 0, 1 + (week - 1) * 7);\n    const day = d.getDay();\n    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday\n    return new Date(d.setDate(diff));\n}\n","/**\n * Workout Cropping Utility\n *\n * Provides functionality to crop workout data (measurements) based on start and end timestamps.\n * Recalculates summary statistics after cropping.\n *\n * @module utils/cropWorkout\n */\n\nimport type {\n    MeasurementsData,\n    Measurement,\n    GpsPoint,\n    TreadmillMeasurement,\n    LapMarker,\n    WorkoutSummary,\n} from '../types/measurements.js';\nimport { calculateWorkoutSummary, type WorkoutSummary as ModalWorkoutSummary } from '../ui/modal.js';\n\n/**\n * Result of a crop operation\n */\nexport interface CroppedWorkoutData {\n    startTime: number;\n    endTime: number;\n    duration: number;\n    measurements: MeasurementsData;\n    summary: WorkoutSummary;\n}\n\n/**\n * Crops workout measurements to a specific time range.\n *\n * @param measurements Original measurement data\n * @param originalStartTime The original start time of the workout (ms)\n * @param newStartTime New start time (ms) - absolute timestamp, must be >= originalStartTime\n * @param newEndTime New end time (ms) - absolute timestamp, must be <= originalEndTime\n * @returns Cropped measurements and recalculated summary\n */\nexport function cropWorkout(\n    measurements: MeasurementsData,\n    originalStartTime: number,\n    newStartTime: number,\n    newEndTime: number\n): CroppedWorkoutData {\n    // Ensure bounds are valid\n    const start = Math.max(originalStartTime, newStartTime);\n    const end = Math.max(start, newEndTime);\n\n    // Filter function for standard Measurement[]\n    const filterMeasurements = (data: Measurement[]) => {\n        return data.filter((m) => m.timestamp >= start && m.timestamp <= end);\n    };\n\n    // Filter specific types\n    const croppedMeasurements: MeasurementsData = {\n        heartrate: filterMeasurements(measurements.heartrate || []),\n        power: filterMeasurements(measurements.power || []),\n        cadence: filterMeasurements(measurements.cadence || []),\n        speed: filterMeasurements(measurements.speed || []),\n        distance: filterMeasurements(measurements.distance || []),\n        altitude: filterMeasurements(measurements.altitude || []),\n        gps: (measurements.gps || []).filter((p: GpsPoint) => p.timestamp >= start && p.timestamp <= end),\n        treadmill: (measurements.treadmill || []).filter(\n            (t: TreadmillMeasurement) => t.timestamp >= start && t.timestamp <= end\n        ),\n        treadmillSpeed: filterMeasurements(measurements.treadmillSpeed || []),\n        laps: (measurements.laps || []).filter((l: LapMarker) => l.timestamp >= start && l.timestamp <= end),\n    };\n\n    // Calculate new duration (seconds)\n    const duration = Math.floor((end - start) / 1000);\n\n    // Recalculate summary using modal's calculator\n    const modalSummary: ModalWorkoutSummary = calculateWorkoutSummary(start, end, {\n        power: croppedMeasurements.power,\n        heartrate: croppedMeasurements.heartrate,\n        cadence: croppedMeasurements.cadence,\n    });\n\n    // Convert to standard flat WorkoutSummary\n    const summary: WorkoutSummary = {\n        startTime: start,\n        endTime: end,\n        totalDuration: duration,\n        avgPower: modalSummary.power.avg ?? undefined,\n        maxPower: modalSummary.power.max ?? undefined,\n        avgHeartrate: modalSummary.heartrate.avg ?? undefined,\n        maxHeartrate: modalSummary.heartrate.max ?? undefined,\n        avgCadence: modalSummary.cadence.avg ?? undefined,\n        maxCadence: modalSummary.cadence.max ?? undefined,\n        // Calculate energy\n        // modalSummary doesn't have energy?\n        // simple calculation: avgPower * duration (seconds) / 1000 = kJ\n        // But better: sum of (watts * delta_time)\n        // For now use avg:\n        // (avgWatts * seconds) / 1000 = kJ\n        // Wait, modalSummary doesn't seem to calculate energy in recent snippet.\n    };\n\n    if (summary.avgPower) {\n        // Estimate energy (kJ)\n        // Power is Watts (J/s). kJ = Watts * seconds / 1000\n        // Approximate using average power\n        // For better accuracy we should integrate, but this matches basic summary often\n        // Check if there is a 'totalEnergy' field in WorkoutSummary (types/measurements.ts doesn't show it but workoutHistory used it)\n        // types/measurements.ts doesn't show totalEnergy.\n        // ui/workoutHistory.ts used summary.totalEnergy.\n        // Let's check ui/workoutHistory.ts getSummary again.\n        // It said \"interface WorkoutSummary { ... totalEnergy?: number ... }\" inside workoutHistory.ts\n        // So the local interface has it.\n        // types/measurements.ts defines WorkoutSummary, does it have totalEnergy?\n        // I read lines 100-127 of types/measurements.ts and it DID NOT have totalEnergy.\n        // But ui/workoutHistory.ts uses it.\n        // So there's a disconnect.\n        // Calculate totalEnergy\n        summary.totalEnergy = Math.round((summary.avgPower * duration) / 1000);\n    }\n\n    // Add distance\n    if (croppedMeasurements.distance.length > 0) {\n        const first = croppedMeasurements.distance[0].value;\n        const last = croppedMeasurements.distance[croppedMeasurements.distance.length - 1].value;\n        summary.totalDistance = Math.max(0, last - first);\n    }\n\n    return {\n        startTime: start,\n        endTime: end,\n        duration,\n        measurements: croppedMeasurements,\n        summary,\n    };\n}\n","/**\n * Workout History UI\n *\n * Displays saved workouts and allows viewing details.\n *\n * @module workoutHistory\n */\n\nimport {\n    isDatabaseAvailable,\n    listWorkouts,\n    getWorkout,\n    deleteWorkout,\n    createWorkout,\n    completeWorkout,\n    formatDuration,\n    formatDate,\n    type Workout,\n    type ListWorkoutsResponse,\n    type ListWorkoutsOptions,\n} from '../api/workoutClient.js';\nimport {\n    getCompletedWorkouts,\n    markWorkoutSynced,\n    isIndexedDBSupported,\n    type StoredWorkout,\n} from '../storage/workoutStorage.js';\nimport { getFtpHistory, type FtpHistoryEntry } from '../api/userClient.js';\nimport { calculateWorkoutSummary } from './modal.js';\nimport { announce } from './accessibility.js';\nimport { renderLineChart } from './charts.js';\nimport { renderPeriodStatistics } from './statistics.js';\nimport { cropWorkout } from '../utils/cropWorkout.js';\nimport type { MeasurementsData } from '../types/measurements.js';\n\n/** Current pagination page */\nlet currentPage = 1;\n/** Total number of pages */\nlet totalPages = 1;\n/** Database availability flag */\nlet dbAvailable = false;\n\n/* Filter State */\nlet filterType = '';\nlet filterStartDate = '';\nlet filterEndDate = '';\n\n/* View State */\nlet currentView: 'list' | 'calendar' | 'analytics' = 'list';\nlet calendarDate = new Date(); // Points to current month\nlet dataSource: 'cloud' | 'local' = 'cloud';\n\n/**\n * Workout summary data from API\n */\ninterface WorkoutSummary {\n    avgPower?: number;\n    maxPower?: number;\n    normalizedPower?: number;\n    avgCadence?: number;\n    maxCadence?: number;\n    avgHeartrate?: number;\n    maxHeartrate?: number;\n    totalEnergy?: number;\n    totalDistance?: number;\n    sampleCount?: number;\n    powerCurve?: { duration: number; watts: number }[];\n    trainingLoad?: number;\n    intensityFactor?: number;\n    powerZoneDistribution?: {\n        zones: {\n            zone: number;\n            name: string;\n            min: number;\n            max: number;\n            timeInZoneMs: number;\n        }[];\n        totalTimeMs: number;\n    };\n    hrZoneDistribution?: {\n        zones: {\n            zone: number;\n            name: string;\n            min: number;\n            max: number;\n            timeInZoneMs: number;\n        }[];\n        totalTimeMs: number;\n    };\n}\n\n/**\n * Helper to safely parse summary\n */\nfunction getSummary(workout: Workout): WorkoutSummary {\n    if (!workout.summary) return {};\n    if (typeof workout.summary === 'string') {\n        try {\n            return JSON.parse(workout.summary);\n        } catch {\n            return {};\n        }\n    }\n    return workout.summary as unknown as WorkoutSummary;\n}\n\n/**\n * Initialize the workout history feature logic\n * NOTE: This should be called after the History View is mounted to DOM.\n */\nexport function initHistoryLogic(): void {\n    const prevBtn = document.getElementById('historyPrevPage') as HTMLButtonElement | null;\n    const nextBtn = document.getElementById('historyNextPage') as HTMLButtonElement | null;\n    const refreshBtn = document.getElementById('historyRefresh');\n\n    // Filters & Views\n    const typeFilter = document.getElementById('workoutTypeFilter') as HTMLSelectElement | null;\n    const dateStart = document.getElementById('workoutDateStart') as HTMLInputElement | null;\n    const dateEnd = document.getElementById('workoutDateEnd') as HTMLInputElement | null;\n    const viewListBtn = document.getElementById('viewListBtn');\n    const viewCalendarBtn = document.getElementById('viewCalendarBtn');\n    const viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');\n\n    const listView = document.getElementById('workoutListView');\n    const calendarView = document.getElementById('workoutCalendarView');\n    const analyticsView = document.getElementById('workoutAnalyticsView');\n\n    // Calendar Controls\n    const prevMonthBtn = document.getElementById('calendarPrevMonth');\n    const nextMonthBtn = document.getElementById('calendarNextMonth');\n\n    // Source Toggle\n    const sourceCloudBtn = document.getElementById('sourceCloudBtn');\n    const sourceLocalBtn = document.getElementById('sourceLocalBtn');\n\n    if (sourceCloudBtn && sourceLocalBtn) {\n        sourceCloudBtn.addEventListener('click', () => setSource('cloud'));\n        sourceLocalBtn.addEventListener('click', () => setSource('local'));\n    }\n\n    // Check if database is available on load\n    checkDatabaseAvailability();\n\n    // Toggle Views\n    const setView = (view: 'list' | 'calendar' | 'analytics') => {\n        currentView = view;\n\n        // Buttons\n        if (viewListBtn) {\n            viewListBtn.classList.toggle('active', view === 'list');\n            viewListBtn.setAttribute('aria-pressed', (view === 'list').toString());\n            viewListBtn.style.background = view === 'list' ? 'var(--color-bg-active)' : 'transparent';\n        }\n        if (viewCalendarBtn) {\n            viewCalendarBtn.classList.toggle('active', view === 'calendar');\n            viewCalendarBtn.setAttribute('aria-pressed', (view === 'calendar').toString());\n            viewCalendarBtn.style.background = view === 'calendar' ? 'var(--color-bg-active)' : 'transparent';\n        }\n        if (viewAnalyticsBtn) {\n            viewAnalyticsBtn.classList.toggle('active', view === 'analytics');\n            viewAnalyticsBtn.setAttribute('aria-pressed', (view === 'analytics').toString());\n            viewAnalyticsBtn.style.background = view === 'analytics' ? 'var(--color-bg-active)' : 'transparent';\n        }\n\n        // Panels\n        if (listView) listView.style.display = view === 'list' ? 'block' : 'none';\n        if (calendarView) calendarView.style.display = view === 'calendar' ? 'block' : 'none';\n        if (analyticsView) analyticsView.style.display = view === 'analytics' ? 'block' : 'none';\n\n        // Filters visibility (hide generic filters for analytics maybe? Keeping for now)\n    };\n\n    viewListBtn?.addEventListener('click', () => {\n        setView('list');\n        loadWorkouts();\n    });\n\n    viewCalendarBtn?.addEventListener('click', () => {\n        setView('calendar');\n        loadCalendar();\n    });\n\n    viewAnalyticsBtn?.addEventListener('click', () => {\n        setView('analytics');\n        loadAnalytics();\n    });\n\n    // Filter Change Listeners\n    const handleFilterChange = () => {\n        if (typeFilter) filterType = typeFilter.value;\n        if (dateStart) filterStartDate = dateStart.value;\n        if (dateEnd) filterEndDate = dateEnd.value;\n\n        currentPage = 1;\n\n        if (currentView === 'list') {\n            loadWorkouts();\n        } else if (currentView === 'calendar') {\n            loadCalendar();\n        } else if (currentView === 'analytics') {\n            loadAnalytics();\n        }\n    };\n\n    typeFilter?.addEventListener('change', handleFilterChange);\n    dateStart?.addEventListener('change', handleFilterChange);\n    dateEnd?.addEventListener('change', handleFilterChange);\n\n    // Calendar Navigation\n    prevMonthBtn?.addEventListener('click', () => {\n        calendarDate.setMonth(calendarDate.getMonth() - 1);\n        loadCalendar();\n    });\n\n    nextMonthBtn?.addEventListener('click', () => {\n        calendarDate.setMonth(calendarDate.getMonth() + 1);\n        loadCalendar();\n    });\n\n    // Pagination\n    prevBtn?.addEventListener('click', async () => {\n        if (currentPage > 1) {\n            currentPage--;\n            await loadWorkouts();\n        }\n    });\n\n    nextBtn?.addEventListener('click', async () => {\n        if (currentPage < totalPages) {\n            currentPage++;\n            await loadWorkouts();\n        }\n    });\n\n    // Refresh\n    refreshBtn?.addEventListener('click', async () => {\n        await loadWorkouts();\n    });\n}\n\n/**\n * Check if database features are available\n */\nasync function checkDatabaseAvailability(): Promise<void> {\n    const historyButton = document.getElementById('workoutHistoryButton') as HTMLButtonElement | null;\n    const hasIndexedDB = isIndexedDBSupported();\n\n    try {\n        dbAvailable = await isDatabaseAvailable();\n    } catch {\n        dbAvailable = false;\n    }\n\n    // Default to local if cloud is unavailable\n    if (!dbAvailable && hasIndexedDB) {\n        dataSource = 'local';\n        updateSourceToggle();\n    }\n\n    if (historyButton) {\n        historyButton.disabled = !(dbAvailable || hasIndexedDB);\n        historyButton.title = dbAvailable || hasIndexedDB ? 'View workout history' : 'History not available';\n    }\n}\n\n/**\n * Convert locally stored workout to Workout interface\n */\nfunction storedToWorkout(stored: StoredWorkout): Workout & { _synced?: boolean } {\n    const summary = calculateWorkoutSummary(stored.startTime, stored.lastUpdated, stored.measurements);\n\n    return {\n        id: stored.id,\n        title: 'Local Workout',\n        sport: 'cycling',\n        startTime: new Date(stored.startTime).toISOString(),\n        endTime: new Date(stored.lastUpdated).toISOString(),\n        duration: Math.round((stored.lastUpdated - stored.startTime) / 1000),\n        status: 'COMPLETED', // API status enum\n        summary: JSON.stringify(summary),\n        createdAt: new Date(stored.startTime).toISOString(),\n        updatedAt: new Date(stored.lastUpdated).toISOString(),\n        _synced: stored.synced,\n    };\n}\n\n/**\n * Load and display workouts\n */\nasync function loadWorkouts(): Promise<void> {\n    const listContainer = document.getElementById('workoutList');\n    const pageInfo = document.getElementById('historyPageInfo');\n    const prevBtn = document.getElementById('historyPrevPage') as HTMLButtonElement | null;\n    const nextBtn = document.getElementById('historyNextPage') as HTMLButtonElement | null;\n\n    if (!listContainer) return;\n\n    // Show loading state\n    listContainer.innerHTML = '<div class=\"workout-loading\">Loading workouts...</div>';\n\n    try {\n        let workouts: (Workout & { _synced?: boolean })[] = [];\n\n        if (dataSource === 'local') {\n            const stored = await getCompletedWorkouts();\n            // TODO: Apply filters locally if needed\n            stored.sort((a, b) => b.startTime - a.startTime);\n\n            const total = stored.length;\n            totalPages = Math.ceil(total / 10) || 1;\n            const start = (currentPage - 1) * 10;\n            const pageItems = stored.slice(start, start + 10);\n\n            workouts = pageItems.map(storedToWorkout);\n\n            if (pageInfo) {\n                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${total} local)`;\n            }\n        } else {\n            const options: ListWorkoutsOptions = {\n                page: currentPage,\n                limit: 10,\n            };\n\n            if (filterType) options.sport = filterType;\n            if (filterStartDate) options.startDate = new Date(filterStartDate);\n            if (filterEndDate) options.endDate = new Date(filterEndDate);\n\n            const result: ListWorkoutsResponse = await listWorkouts(options);\n            workouts = result.workouts;\n            const { pagination } = result;\n\n            totalPages = pagination.totalPages;\n\n            // Update pagination info\n            if (pageInfo) {\n                pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)`;\n            }\n        }\n\n        // Update pagination buttons\n        if (prevBtn) prevBtn.disabled = currentPage <= 1;\n        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;\n\n        // Render workouts\n        if (workouts.length === 0) {\n            listContainer.innerHTML = `\n        <div class=\"workout-empty\">\n          <p>No workouts found</p>\n          <p class=\"workout-empty-hint\">Start a workout to see it here!</p>\n        </div>\n      `;\n            return;\n        }\n\n        listContainer.innerHTML = workouts.map((workout) => renderWorkoutCard(workout)).join('');\n\n        // Add event listeners for workout cards\n        listContainer.querySelectorAll('.workout-card').forEach((card) => {\n            const workoutId = (card as HTMLElement).dataset.workoutId;\n            if (!workoutId) return;\n\n            // View details\n            card.querySelector('.workout-view-btn')?.addEventListener('click', (e: Event) => {\n                e.stopPropagation();\n                viewWorkoutDetails(workoutId);\n            });\n\n            // Delete\n            card.querySelector('.workout-delete-btn')?.addEventListener('click', (e: Event) => {\n                e.stopPropagation();\n                confirmDeleteWorkout(workoutId);\n            });\n\n            // Sync\n            card.querySelector('.workout-sync-btn')?.addEventListener('click', (e: Event) => {\n                e.stopPropagation();\n                syncWorkout(workoutId);\n            });\n        });\n    } catch (error) {\n        console.error('Failed to load workouts:', error);\n        const message = error instanceof Error ? error.message : 'Unknown error';\n        listContainer.innerHTML = `\n      <div class=\"workout-error\">\n        <p>Failed to load workouts</p>\n        <p class=\"workout-error-detail\">${message}</p>\n      </div>\n    `;\n    }\n}\n\n/**\n * Switch data source and reload\n */\nfunction setSource(s: 'cloud' | 'local'): void {\n    if (dataSource === s) return;\n    dataSource = s;\n    updateSourceToggle();\n    currentPage = 1;\n    loadWorkouts();\n}\n\n/**\n * Update toggle UI\n */\nfunction updateSourceToggle(): void {\n    const cloudBtn = document.getElementById('sourceCloudBtn');\n    const localBtn = document.getElementById('sourceLocalBtn');\n\n    if (cloudBtn && localBtn) {\n        if (dataSource === 'cloud') {\n            cloudBtn.classList.add('active');\n            cloudBtn.setAttribute('aria-pressed', 'true');\n            cloudBtn.style.background = 'var(--color-bg-active)';\n\n            localBtn.classList.remove('active');\n            localBtn.setAttribute('aria-pressed', 'false');\n            localBtn.style.background = 'transparent';\n        } else {\n            localBtn.classList.add('active');\n            localBtn.setAttribute('aria-pressed', 'true');\n            localBtn.style.background = 'var(--color-bg-active)';\n\n            cloudBtn.classList.remove('active');\n            cloudBtn.setAttribute('aria-pressed', 'false');\n            cloudBtn.style.background = 'transparent';\n        }\n    }\n}\n\n/**\n * Sync a local workout to server\n */\nasync function syncWorkout(localId: string): Promise<void> {\n    const workouts = await getCompletedWorkouts();\n    const local = workouts.find((w) => w.id === localId);\n    if (!local) return;\n\n    try {\n        announce('Syncing workout...', 'polite');\n\n        // 1. Create Workout on server\n        const createRes = await createWorkout({\n            streamName: `sync-${localId}`,\n            title: `Synced: ${formatDate(new Date(local.startTime))}`,\n            sport: 'cycling',\n        });\n\n        if (createRes.success && createRes.workout) {\n            // 2. Mark as complete (updates status to COMPLETED)\n            const completeRes = await completeWorkout(createRes.workout.id, false);\n\n            if (completeRes.success) {\n                await markWorkoutSynced(localId);\n                announce('Workout synced successfully', 'assertive');\n                await loadWorkouts();\n            } else {\n                throw new Error('Failed to complete workout on server');\n            }\n        }\n    } catch (e) {\n        console.error('Sync failed', e);\n        announce('Sync failed', 'assertive');\n    }\n}\n\n/**\n * Render a workout card\n */\nfunction renderWorkoutCard(workout: Workout & { _synced?: boolean }): string {\n    const statusClass = workout.status.toLowerCase();\n    const summary = getSummary(workout);\n\n    const isUnsynced = workout._synced === false;\n    const syncBtn = isUnsynced\n        ? `<button class=\"workout-sync-btn\" title=\"Upload to server\"> Sync</button>`\n        : workout._synced === true\n          ? `<span title=\"Synced\" style=\"margin-right:8px;\"></span>`\n          : '';\n\n    return `\n    <div class=\"workout-card\" data-workout-id=\"${workout.id}\">\n      <div class=\"workout-card-header\">\n        <span class=\"workout-title\">${workout.title || 'Untitled Workout'}</span>\n        <span class=\"workout-status workout-status-${statusClass}\">${workout.status}</span>\n      </div>\n      <div class=\"workout-card-body\">\n        <div class=\"workout-date\">\n           ${formatDate(workout.startTime)}\n        </div>\n        <div class=\"workout-stats\">\n          ${workout.duration ? `<span class=\"workout-stat\"> ${formatDuration(workout.duration)}</span>` : ''}\n          ${summary.avgPower ? `<span class=\"workout-stat\"> ${summary.avgPower}W avg</span>` : ''}\n          ${summary.maxPower ? `<span class=\"workout-stat\"> ${summary.maxPower}W max</span>` : ''}\n          ${summary.avgHeartrate ? `<span class=\"workout-stat\"> ${summary.avgHeartrate} bpm</span>` : ''}\n          ${summary.totalEnergy ? `<span class=\"workout-stat\"> ${summary.totalEnergy} kJ</span>` : ''}\n        </div>\n      </div>\n      <div class=\"workout-card-actions\">\n        ${syncBtn}\n        <button class=\"workout-view-btn\" title=\"View details\"> View</button>\n        <button class=\"workout-delete-btn\" title=\"Delete workout\"></button>\n      </div>\n    </div>\n  `;\n}\n\n/**\n * View workout details in a detail panel\n */\nasync function viewWorkoutDetails(workoutId: string): Promise<void> {\n    const detailPanel = document.getElementById('workoutDetailPanel');\n    const listPanel = document.getElementById('workoutListPanel');\n\n    if (!detailPanel || !listPanel) return;\n\n    // Show detail panel\n    listPanel.style.display = 'none';\n    detailPanel.style.display = 'block';\n    detailPanel.innerHTML = '<div class=\"workout-loading\">Loading workout details...</div>';\n\n    try {\n        const workout = await getWorkout(workoutId, true);\n        detailPanel.innerHTML = renderWorkoutDetail(workout);\n\n        // Render Zone Charts\n        const summary = getSummary(workout);\n        if (summary.powerZoneDistribution) {\n            renderZoneChart('wd-chart-power-zones', summary.powerZoneDistribution, 'Power Zones');\n        }\n        if (summary.hrZoneDistribution) {\n            renderZoneChart('wd-chart-hr-zones', summary.hrZoneDistribution, 'Heart Rate Zones');\n        }\n\n        // Render Charts if telemetry exists\n        if (workout.telemetry) {\n            // Allow DOM to update first\n            requestAnimationFrame(() => {\n                renderWorkoutCharts(workout.telemetry!, workout.startTime);\n            });\n        }\n\n        // Back button\n        detailPanel.querySelector('.workout-back-btn')?.addEventListener('click', () => {\n            detailPanel.style.display = 'none';\n            listPanel.style.display = 'block';\n        });\n\n        // Export button\n        detailPanel.querySelector('.workout-export-btn')?.addEventListener('click', () => {\n            exportWorkoutData(workout);\n        });\n\n        // Crop button\n        detailPanel.querySelector('.workout-crop-btn')?.addEventListener('click', () => {\n            startCropTool(workout);\n        });\n    } catch (error) {\n        console.error('Failed to load workout details:', error);\n        const message = error instanceof Error ? error.message : 'Unknown error';\n        detailPanel.innerHTML = `\n      <div class=\"workout-error\">\n        <p>Failed to load workout</p>\n        <p class=\"workout-error-detail\">${message}</p>\n        <button class=\"workout-back-btn\"> Back to list</button>\n      </div>\n    `;\n        detailPanel.querySelector('.workout-back-btn')?.addEventListener('click', () => {\n            detailPanel.style.display = 'none';\n            listPanel.style.display = 'block';\n        });\n    }\n}\n\n/**\n * Render workout detail view\n */\nfunction renderWorkoutDetail(workout: Workout): string {\n    const summary = getSummary(workout);\n    const statusClass = workout.status.toLowerCase();\n\n    return `\n    <div class=\"workout-detail\">\n      <div class=\"workout-detail-header\">\n        <button class=\"workout-back-btn\"> Back</button>\n        <h3>${workout.title || 'Untitled Workout'}</h3>\n        <span class=\"workout-status workout-status-${statusClass}\">${workout.status}</span>\n      </div>\n\n      <div class=\"workout-detail-meta\">\n        <div class=\"meta-item\">\n          <span class=\"meta-label\">Sport</span>\n          <span class=\"meta-value\">${workout.sport || 'cycling'}</span>\n        </div>\n        <div class=\"meta-item\">\n          <span class=\"meta-label\">Start Time</span>\n          <span class=\"meta-value\">${formatDate(workout.startTime)}</span>\n        </div>\n        ${\n            workout.endTime\n                ? `\n          <div class=\"meta-item\">\n            <span class=\"meta-label\">End Time</span>\n            <span class=\"meta-value\">${formatDate(workout.endTime)}</span>\n          </div>\n        `\n                : ''\n        }\n        ${\n            workout.duration\n                ? `\n          <div class=\"meta-item\">\n            <span class=\"meta-label\">Duration</span>\n            <span class=\"meta-value\">${formatDuration(workout.duration)}</span>\n          </div>\n        `\n                : ''\n        }\n      </div>\n\n      ${\n          Object.keys(summary).length > 0\n              ? `\n        <div class=\"workout-detail-summary\">\n          <h4>Summary</h4>\n          <div class=\"summary-grid\">\n            ${\n                summary.avgPower\n                    ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Power</span>\n                <span class=\"summary-value\">${summary.avgPower} W</span>\n              </div>\n            `\n                    : ''\n            }\n            ${\n                summary.maxPower\n                    ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Max Power</span>\n                <span class=\"summary-value\">${summary.maxPower} W</span>\n              </div>\n            `\n                    : ''\n            }\n            ${\n                summary.avgCadence\n                    ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Cadence</span>\n                <span class=\"summary-value\">${summary.avgCadence} rpm</span>\n              </div>\n            `\n                    : ''\n            }\n            ${\n                summary.avgHeartrate\n                    ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Avg Heart Rate</span>\n                <span class=\"summary-value\">${summary.avgHeartrate} bpm</span>\n              </div>\n            `\n                    : ''\n            }\n            ${\n                summary.totalEnergy\n                    ? `\n              <div class=\"summary-item\">\n                <span class=\"summary-label\">Total Energy</span>\n                <span class=\"summary-value\">${summary.totalEnergy} kJ</span>\n              </div>\n            `\n                    : ''\n            }\n          </div>\n        </div>\n      `\n              : ''\n      }\n\n      ${\n          workout.telemetry\n              ? `\n        <div class=\"workout-detail-charts\">\n            <h4>Charts</h4>\n            <div id=\"wd-chart-power\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-hr\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-cadence\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-altitude\" class=\"chart-container\" style=\"height: 200px; margin-bottom: 20px;\"></div>\n            \n            <h4>Zone Distribution</h4>\n            <div id=\"wd-chart-power-zones\" class=\"chart-container\" style=\"margin-bottom: 20px;\"></div>\n            <div id=\"wd-chart-hr-zones\" class=\"chart-container\" style=\"margin-bottom: 20px;\"></div>\n        </div>\n      `\n              : ''\n      }\n\n      ${\n          workout.description\n              ? `\n        <div class=\"workout-detail-description\">\n          <h4>Notes</h4>\n          <p>${workout.description}</p>\n        </div>\n      `\n              : ''\n      }\n\n      <div class=\"workout-detail-actions\">\n        ${\n            workout.telemetry\n                ? `\n          <button class=\"workout-action-btn workout-crop-btn\"> Crop</button>\n          <button class=\"workout-export-btn\"> Export Data</button>\n        `\n                : ''\n        }\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Export workout data to files\n */\nfunction exportWorkoutData(workout: Workout): void {\n    const timestamp = new Date(workout.startTime).toISOString().replace(/[:.]/g, '-').slice(0, 19);\n    const filename = `workout-${timestamp}`;\n\n    const jsonData = {\n        id: workout.id,\n        title: workout.title,\n        sport: workout.sport,\n        startTime: workout.startTime,\n        endTime: workout.endTime,\n        duration: workout.duration,\n        summary: workout.summary,\n        telemetry: workout.telemetry,\n    };\n\n    const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });\n    const jsonUrl = URL.createObjectURL(jsonBlob);\n    const jsonLink = document.createElement('a');\n    jsonLink.href = jsonUrl;\n    jsonLink.download = `${filename}.json`;\n    jsonLink.click();\n    URL.revokeObjectURL(jsonUrl);\n}\n\n/**\n * Confirm and delete a workout\n */\nasync function confirmDeleteWorkout(workoutId: string): Promise<void> {\n    if (!confirm('Are you sure you want to delete this workout? This cannot be undone.')) {\n        return;\n    }\n\n    try {\n        await deleteWorkout(workoutId);\n        await loadWorkouts();\n    } catch (error) {\n        console.error('Failed to delete workout:', error);\n        const message = error instanceof Error ? error.message : 'Unknown error';\n        alert(`Failed to delete workout: ${message}`);\n    }\n}\n\n/**\n * Check database availability (exported for other modules)\n */\nexport function getDatabaseAvailable(): boolean {\n    return dbAvailable;\n}\n\n/**\n * Load and display calendar view\n */\nasync function loadCalendar(): Promise<void> {\n    const calendarGrid = document.getElementById('workoutCalendarGrid');\n    const monthLabel = document.getElementById('calendarMonthLabel');\n\n    if (!calendarGrid || !monthLabel) return;\n\n    // Set month label\n    const monthNames = [\n        'January',\n        'February',\n        'March',\n        'April',\n        'May',\n        'June',\n        'July',\n        'August',\n        'September',\n        'October',\n        'November',\n        'December',\n    ];\n    monthLabel.textContent = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;\n\n    // Show loading\n    calendarGrid.innerHTML =\n        '<div style=\"grid-column: 1 / -1; text-align: center; padding: 20px;\">Loading calendar...</div>';\n\n    // Calculate start and end of month\n    const year = calendarDate.getFullYear();\n    const month = calendarDate.getMonth();\n    const startDate = new Date(year, month, 1);\n    const endDate = new Date(year, month + 1, 0, 23, 59, 59, 999);\n\n    try {\n        const options: ListWorkoutsOptions = {\n            startDate,\n            endDate,\n            limit: 1000, // Get all workouts for the month\n        };\n        if (filterType) options.sport = filterType;\n\n        const result = await listWorkouts(options);\n        const workouts = result.workouts;\n\n        renderCalendar(workouts);\n        renderMonthlyStats(workouts);\n    } catch (error) {\n        console.error('Failed to load calendar:', error);\n        calendarGrid.innerHTML =\n            '<div style=\"grid-column: 1 / -1; text-align: center; color: var(--color-error);\">Failed to load calendar data</div>';\n    }\n}\n\n/**\n * Render the calendar grid\n */\nfunction renderCalendar(workouts: Workout[]): void {\n    const calendarGrid = document.getElementById('workoutCalendarGrid');\n    if (!calendarGrid) return;\n\n    calendarGrid.innerHTML = '';\n\n    // Add day headers\n    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n    days.forEach((day) => {\n        const d = document.createElement('div');\n        d.textContent = day;\n        d.style.textAlign = 'center';\n        d.style.fontWeight = 'bold';\n        d.style.padding = '4px';\n        d.style.fontSize = '0.9em';\n        d.style.color = 'var(--color-text-secondary)';\n        calendarGrid.appendChild(d);\n    });\n\n    const year = calendarDate.getFullYear();\n    const month = calendarDate.getMonth();\n\n    // First day of the month\n    const firstDay = new Date(year, month, 1).getDay();\n    // Days in month\n    const daysInMonth = new Date(year, month + 1, 0).getDate();\n\n    // Empty cells for days before first of month\n    for (let i = 0; i < firstDay; i++) {\n        const empty = document.createElement('div');\n        calendarGrid.appendChild(empty);\n    }\n\n    // Days\n    for (let day = 1; day <= daysInMonth; day++) {\n        const dayCell = document.createElement('div');\n        dayCell.style.border = '1px solid var(--color-border)';\n        dayCell.style.borderRadius = '4px';\n        dayCell.style.minHeight = '60px';\n        dayCell.style.padding = '4px';\n        dayCell.style.background = 'var(--card-bg)';\n        dayCell.style.position = 'relative';\n\n        const dayNum = document.createElement('div');\n        dayNum.textContent = day.toString();\n        dayNum.style.fontSize = '0.8em';\n        dayNum.style.marginBottom = '4px';\n        dayCell.appendChild(dayNum);\n\n        // Find workouts for this day\n        const dayWorkouts = workouts.filter((w) => {\n            const wDate = new Date(w.startTime);\n            return wDate.getDate() === day && wDate.getMonth() === month && wDate.getFullYear() === year;\n        });\n\n        dayWorkouts.forEach((w) => {\n            const dot = document.createElement('div');\n            dot.title = `${w.title || 'Workout'} (${formatDuration(w.duration || 0)})`;\n            dot.style.fontSize = '0.7em';\n            dot.style.whiteSpace = 'nowrap';\n            dot.style.overflow = 'hidden';\n            dot.style.textOverflow = 'ellipsis';\n            dot.style.cursor = 'pointer';\n            dot.style.padding = '2px';\n            dot.style.marginTop = '2px';\n            dot.style.borderRadius = '2px';\n            dot.style.background = 'var(--color-bg-active)';\n            dot.style.color = 'var(--color-text-primary)';\n\n            // Icon based on sport\n            const icon = w.sport === 'running' ? '' : '';\n            dot.textContent = `${icon} ${formatDuration(w.duration || 0)}`;\n\n            dot.addEventListener('click', (e) => {\n                e.stopPropagation();\n                viewWorkoutDetails(w.id);\n            });\n\n            dayCell.appendChild(dot);\n        });\n\n        // Highlight today\n        const today = new Date();\n        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {\n            dayCell.style.borderColor = 'var(--color-accent)';\n            dayNum.style.fontWeight = 'bold';\n            dayNum.style.color = 'var(--color-accent)';\n        }\n\n        calendarGrid.appendChild(dayCell);\n    }\n}\n\n/**\n * Render monthly statistics\n */\nfunction renderMonthlyStats(workouts: Workout[]): void {\n    const statsContainer = document.getElementById('monthlyStats');\n    if (!statsContainer) return;\n\n    const totalWorkouts = workouts.length;\n    const totalDuration = workouts.reduce((acc, w) => acc + (w.duration || 0), 0);\n    const totalDistance = workouts.reduce((acc, w) => {\n        const summary = getSummary(w);\n        return acc + (summary.totalDistance || 0);\n    }, 0);\n    const totalEnergy = workouts.reduce((acc, w) => {\n        const summary = getSummary(w);\n        return acc + (summary.totalEnergy || 0);\n    }, 0);\n\n    statsContainer.innerHTML = `\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Workouts</div>\n            <div style=\"font-weight: bold;\">${totalWorkouts}</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Duration</div>\n            <div style=\"font-weight: bold;\">${formatDuration(totalDuration)}</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Distance</div>\n            <div style=\"font-weight: bold;\">${(totalDistance / 1000).toFixed(1)} km</div>\n        </div>\n        <div class=\"stat-item\" style=\"background: var(--card-bg); padding: 8px; border-radius: 4px; text-align: center;\">\n            <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">Energy</div>\n            <div style=\"font-weight: bold;\">${totalEnergy.toFixed(0)} kJ</div>\n        </div>\n    `;\n}\n\n/**\n * Load and display analytics\n */\nasync function loadAnalytics(): Promise<void> {\n    const analyticsView = document.getElementById('workoutAnalyticsView');\n    if (!analyticsView) return;\n\n    // Show loading\n    const prList = document.getElementById('prList');\n    if (prList) prList.innerHTML = '<div style=\"padding: 12px; text-align: center;\">Loading records...</div>';\n\n    try {\n        // Fetch all history (might be heavy, better to have a dedicated endpoint in future)\n        // For now, fetch with large limit but minimal fields?\n        // Unfortunately getWorkoutHistory fetches all summary fields.\n        // We can respect filters though.\n\n        const options: ListWorkoutsOptions = {\n            limit: 1000, // Reasonable cap\n        };\n        if (filterType) options.sport = filterType;\n        if (filterStartDate) options.startDate = new Date(filterStartDate);\n        if (filterEndDate) options.endDate = new Date(filterEndDate);\n\n        const result = await listWorkouts(options);\n        const workouts = result.workouts;\n\n        // Fetch FTP History if we have a user ID\n        let ftpHistory: FtpHistoryEntry[] = [];\n        if (workouts.length > 0 && workouts[0].userId) {\n            try {\n                ftpHistory = await getFtpHistory(workouts[0].userId);\n            } catch (e) {\n                console.warn('Failed to load FTP history', e);\n            }\n        }\n\n        renderAnalytics(workouts, ftpHistory);\n    } catch (error) {\n        console.error('Failed to load analytics:', error);\n        if (prList)\n            prList.innerHTML = '<div style=\"color: var(--color-error); text-align: center;\">Failed to load data</div>';\n    }\n}\n\n/**\n * Render all analytics charts and stats\n */\nfunction renderAnalytics(workouts: Workout[], ftpHistory: FtpHistoryEntry[] = []): void {\n    renderPeriodStatistics('workoutAnalyticsView', workouts);\n    renderPersonalRecords(workouts);\n    renderTrainingLoad(workouts);\n    renderPowerCurve(workouts);\n    renderFitnessTrend(workouts);\n    renderFtpHistory(ftpHistory);\n    renderPrHistory(workouts);\n}\n\n/**\n * Render Personal Records\n */\nfunction renderPersonalRecords(workouts: Workout[]): void {\n    const container = document.getElementById('prList');\n    if (!container) return;\n\n    let maxPower = { val: 0, date: '', id: '' };\n    let maxHr = { val: 0, date: '', id: '' };\n    let longestRide = { val: 0, date: '', id: '' }; // Duration\n    let maxDistance = { val: 0, date: '', id: '' };\n\n    workouts.forEach((w) => {\n        const summary = getSummary(w);\n        const dateStr = formatDate(w.startTime);\n\n        if (summary.maxPower && summary.maxPower > maxPower.val) {\n            maxPower = { val: summary.maxPower, date: dateStr, id: w.id };\n        }\n        if (summary.maxHeartrate && summary.maxHeartrate > maxHr.val) {\n            maxHr = { val: summary.maxHeartrate, date: dateStr, id: w.id };\n        }\n        if (w.duration && w.duration > longestRide.val) {\n            longestRide = { val: w.duration, date: dateStr, id: w.id };\n        }\n        if (summary.totalDistance && summary.totalDistance > maxDistance.val) {\n            maxDistance = { val: summary.totalDistance, date: dateStr, id: w.id };\n        }\n    });\n\n    const createRow = (label: string, value: string, date: string, id: string) => `\n        <div class=\"pr-row\" data-id=\"${id}\" style=\"display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border); cursor: pointer;\">\n            <div style=\"font-weight: 500;\">${label}</div>\n            <div style=\"text-align: right;\">\n                <div style=\"font-weight: bold; color: var(--color-accent);\">${value}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">${date}</div>\n            </div>\n        </div>\n    `;\n\n    container.innerHTML = `\n        ${maxPower.val > 0 ? createRow('Max Power (1s)', `${maxPower.val} W`, maxPower.date, maxPower.id) : ''}\n        ${maxHr.val > 0 ? createRow('Max Heart Rate', `${maxHr.val} bpm`, maxHr.date, maxHr.id) : ''}\n        ${longestRide.val > 0 ? createRow('Longest Duration', formatDuration(longestRide.val), longestRide.date, longestRide.id) : ''}\n        ${maxDistance.val > 0 ? createRow('Longest Distance', `${(maxDistance.val / 1000).toFixed(1)} km`, maxDistance.date, maxDistance.id) : ''}\n    `;\n\n    // Re-attach click listeners\n    container.querySelectorAll('.pr-row').forEach((row) => {\n        row.addEventListener('click', () => {\n            const id = (row as HTMLElement).dataset.id;\n            if (id) viewWorkoutDetails(id);\n        });\n    });\n}\n\n/**\n * Render Training Load (Weekly TSS)\n */\nfunction renderTrainingLoad(workouts: Workout[]): void {\n    const container = document.getElementById('trainingLoadChart');\n    if (!container) return;\n\n    // Group by week\n    const weeks: Record<string, number> = {};\n    // Generate last 4 weeks keys\n    for (let i = 3; i >= 0; i--) {\n        const d = new Date();\n        d.setDate(d.getDate() - i * 7);\n        const weekNum = getWeekNumber(d);\n        weeks[`${d.getFullYear()}-W${weekNum}`] = 0;\n    }\n\n    workouts.forEach((w) => {\n        const summary = getSummary(w);\n        if (summary.trainingLoad) {\n            const date = new Date(w.startTime);\n            const key = `${date.getFullYear()}-W${getWeekNumber(date)}`;\n            if (weeks[key] !== undefined) {\n                weeks[key] += summary.trainingLoad;\n            }\n        }\n    });\n\n    const maxLoad = Math.max(...Object.values(weeks), 100); // Scale max\n\n    container.innerHTML = Object.entries(weeks)\n        .map(([week, load]) => {\n            const height = (load / maxLoad) * 100;\n            return `\n            <div style=\"display: flex; flex-direction: column; align-items: center; width: 20%;\">\n                <div style=\"font-size: 0.8em; font-weight: bold; margin-bottom: 4px;\">${Math.round(load)}</div>\n                <div style=\"width: 100%; height: 100px; display: flex; align-items: flex-end; justify-content: center;\">\n                    <div style=\"width: 80%; background: var(--color-accent); height: ${height}%; border-radius: 4px 4px 0 0; min-height: 4px;\"></div>\n                </div>\n                <div style=\"font-size: 0.7em; color: var(--color-text-secondary); margin-top: 4px;\">${week.split('-')[1]}</div>\n            </div>\n        `;\n        })\n        .join('');\n}\n\nfunction getWeekNumber(d: Date): number {\n    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));\n    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));\n    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    return Math.ceil(((d.getTime() - yearStart.getTime()) / 86400000 + 1) / 7);\n}\n\n/**\n * Render Power Curve (SVG Chart)\n */\nfunction renderPowerCurve(workouts: Workout[]): void {\n    const container = document.getElementById('powerCurveChart');\n    if (!container) return;\n\n    // Aggregate best power for each duration\n    const bests: Record<number, number> = {};\n    const durations = [1, 5, 10, 30, 60, 300, 1200, 3600];\n\n    workouts.forEach((w) => {\n        const summary = getSummary(w);\n        if (summary.powerCurve) {\n            summary.powerCurve.forEach((p) => {\n                if (!bests[p.duration] || p.watts > bests[p.duration]) {\n                    bests[p.duration] = p.watts;\n                }\n            });\n        }\n        // Fallback for older workouts if we have maxPower (1s)\n        if (summary.maxPower && (!bests[1] || summary.maxPower > bests[1])) {\n            bests[1] = summary.maxPower;\n        }\n    });\n\n    if (Object.keys(bests).length === 0) {\n        container.innerHTML =\n            '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">No power data available</div>';\n        return;\n    }\n\n    // Chart Dimensions\n    const width = container.clientWidth || 300;\n    const height = 200;\n    const pad = 30;\n\n    // Scales\n    const maxWatts = Math.max(...Object.values(bests)) * 1.1; // 10% overhead\n\n    const points = durations\n        .map((d, i) => {\n            if (!bests[d]) return null;\n            const x = pad + i * ((width - pad * 2) / (durations.length - 1));\n            const y = height - pad - (bests[d] / maxWatts) * (height - pad * 2);\n            return { x, y, val: bests[d], duration: d };\n        })\n        .filter((p) => p !== null);\n\n    if (points.length < 2) {\n        container.innerHTML =\n            '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">Insufficient data points</div>';\n        return;\n    }\n\n    const pathD = `M ${points.map((p) => `${p!.x},${p!.y}`).join(' L ')}`;\n\n    // SVG Content\n    const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad}\" y1=\"${pad}\" x2=\"${pad}\" y2=\"${height - pad}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad}\" y1=\"${height - pad}\" x2=\"${width - pad}\" y2=\"${height - pad}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- Path -->\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n            \n            <!-- Points -->\n            ${points\n                .map(\n                    (p) => `\n                <circle cx=\"${p!.x}\" cy=\"${p!.y}\" r=\"4\" fill=\"var(--card-bg)\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n                <text x=\"${p!.x}\" y=\"${p!.y - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-primary)\">${p!.val}W</text>\n                <text x=\"${p!.x}\" y=\"${height - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${formatDurationLabel(p!.duration)}</text>\n            `\n                )\n                .join('')}\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n\nfunction formatDurationLabel(sec: number): string {\n    if (sec < 60) return `${sec}s`;\n    if (sec < 3600) return `${sec / 60}m`;\n    return `${sec / 3600}h`;\n}\n\n/**\n * Render Fitness Trend (CTL/ATL)\n */\nfunction renderFitnessTrend(workouts: Workout[]): void {\n    const container = document.getElementById('fitnessTrendChart');\n    if (!container) return;\n\n    // Sort workouts by date ascending\n    const sorted = [...workouts].sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());\n\n    if (sorted.length < 2) {\n        container.innerHTML =\n            '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">Not enough data for trend analysis</div>';\n        return;\n    }\n\n    // Daily TSS Map\n    const tssMap = new Map<string, number>();\n    sorted.forEach((w) => {\n        const summary = getSummary(w);\n        if (summary.trainingLoad) {\n            const dateStr = new Date(w.startTime).toISOString().split('T')[0];\n            const current = tssMap.get(dateStr) || 0;\n            tssMap.set(dateStr, current + summary.trainingLoad);\n        }\n    });\n\n    // Calculate CTL/ATL day by day\n    const dataPoints: { date: Date; ctl: number; atl: number; tsb: number }[] = [];\n    const startDate = new Date(sorted[0].startTime);\n    const endDate = new Date(); // Today\n\n    // Constants\n    const kCTL = Math.exp(-1 / 42);\n    const kATL = Math.exp(-1 / 7);\n\n    let ctl = 0;\n    let atl = 0;\n\n    // Iterate day by day\n    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {\n        const dateStr = d.toISOString().split('T')[0];\n        const tss = tssMap.get(dateStr) || 0;\n\n        ctl = ctl * kCTL + tss * (1 - kCTL);\n        atl = atl * kATL + tss * (1 - kATL);\n\n        dataPoints.push({\n            date: new Date(d),\n            ctl,\n            atl,\n            tsb: ctl - atl,\n        });\n    }\n\n    // Chart Dimensions\n    const width = container.clientWidth || 600;\n    const height = 250;\n    const pad = { top: 20, right: 30, bottom: 30, left: 40 };\n    const chartW = width - pad.left - pad.right;\n    const chartH = height - pad.top - pad.bottom;\n\n    // Scales\n    const maxVal = Math.max(...dataPoints.map((p) => Math.max(p.ctl, p.atl))) * 1.1;\n\n    const timeSpan = endDate.getTime() - startDate.getTime();\n    if (timeSpan === 0) return;\n\n    const getX = (date: Date) => pad.left + ((date.getTime() - startDate.getTime()) / timeSpan) * chartW;\n    const getY = (val: number) => pad.top + chartH - (val / maxVal) * chartH;\n\n    // Generate Paths\n    const ctlPath = 'M ' + dataPoints.map((p) => `${getX(p.date)},${getY(p.ctl)}`).join(' L ');\n    const atlPath = 'M ' + dataPoints.map((p) => `${getX(p.date)},${getY(p.atl)}`).join(' L ');\n\n    // SVG Content\n    const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad.left}\" y1=\"${pad.top}\" x2=\"${pad.left}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad.left}\" y1=\"${height - pad.bottom}\" x2=\"${width - pad.right}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- CTL Line (Fitness) - Blue -->\n            <path d=\"${ctlPath}\" fill=\"none\" stroke=\"#3b82f6\" stroke-width=\"2\" />\n            \n            <!-- ATL Line (Fatigue) - Pink/Purple -->\n            <path d=\"${atlPath}\" fill=\"none\" stroke=\"#ec4899\" stroke-width=\"2\" stroke-dasharray=\"4\" />\n            \n            <!-- Legend -->\n            <g transform=\"translate(${pad.left + 10}, ${pad.top})\">\n                <rect x=\"0\" y=\"0\" width=\"10\" height=\"10\" fill=\"#3b82f6\" />\n                <text x=\"15\" y=\"10\" font-size=\"12\" fill=\"var(--color-text-secondary)\">Fitness (CTL)</text>\n                \n                <rect x=\"100\" y=\"0\" width=\"10\" height=\"10\" fill=\"none\" stroke=\"#ec4899\" stroke-width=\"2\" stroke-dasharray=\"4\" />\n                <text x=\"115\" y=\"10\" font-size=\"12\" fill=\"var(--color-text-secondary)\">Fatigue (ATL)</text>\n            </g>\n\n            <!-- Latest Stats -->\n             <text x=\"${width - pad.right}\" y=\"${pad.top}\" text-anchor=\"end\" font-size=\"12\" fill=\"var(--color-text-primary)\">\n                CTL: ${Math.round(ctl)} | ATL: ${Math.round(atl)} | TSB: ${Math.round(ctl - atl)}\n            </text>\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n\n/**\n * Render FTP History Chart\n */\nfunction renderFtpHistory(history: FtpHistoryEntry[]): void {\n    const container = document.getElementById('ftpHistoryChart');\n    if (!container) return;\n\n    if (history.length === 0) {\n        container.innerHTML =\n            '<div style=\"display:flex; justify-content:center; align-items:center; height:100%; color: var(--color-text-secondary);\">No FTP history available</div>';\n        return;\n    }\n\n    // Sort by date ascending\n    const sorted = [...history].sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());\n\n    // Chart Dimensions\n    const width = container.clientWidth || 600;\n    const height = 200;\n    const pad = { top: 20, right: 30, bottom: 30, left: 40 };\n    const chartW = width - pad.left - pad.right;\n    const chartH = height - pad.top - pad.bottom;\n\n    // Scales\n    const maxFtp = Math.max(...sorted.map((h) => h.ftp)) * 1.1;\n    const minFtp = Math.max(0, Math.min(...sorted.map((h) => h.ftp)) * 0.9);\n    const ftpRange = maxFtp - minFtp || 100; // avoid div by zero\n\n    const startDate = new Date(sorted[0].createdAt);\n    const endDate = new Date();\n    const timeSpan = endDate.getTime() - startDate.getTime();\n\n    const getX = (dateStr: string | Date) => {\n        const d = new Date(dateStr);\n        return pad.left + ((d.getTime() - startDate.getTime()) / timeSpan) * chartW;\n    };\n    const getY = (val: number) => pad.top + chartH - ((val - minFtp) / ftpRange) * chartH;\n\n    // Generate Path\n    let d = '';\n    if (sorted.length > 0) {\n        d = `M ${getX(sorted[0].createdAt)},${getY(sorted[0].ftp)}`;\n        for (let i = 1; i < sorted.length; i++) {\n            const currX = getX(sorted[i].createdAt);\n            const prevY = getY(sorted[i - 1].ftp);\n            const currY = getY(sorted[i].ftp);\n\n            // Step line: Horizontal then Vertical\n            d += ` L ${currX},${prevY} L ${currX},${currY}`;\n        }\n        // Extend to now\n        d += ` L ${width - pad.right},${getY(sorted[sorted.length - 1].ftp)}`;\n    }\n\n    // SVG Content\n    const svg = `\n        <svg width=\"100%\" height=\"100%\" viewBox=\"0 0 ${width} ${height}\" preserveAspectRatio=\"none\">\n            <!-- Grid Lines -->\n            <line x1=\"${pad.left}\" y1=\"${pad.top}\" x2=\"${pad.left}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            <line x1=\"${pad.left}\" y1=\"${height - pad.bottom}\" x2=\"${width - pad.right}\" y2=\"${height - pad.bottom}\" stroke=\"var(--color-border)\" stroke-width=\"1\" />\n            \n            <!-- FTP Line -->\n            <path d=\"${d}\" fill=\"none\" stroke=\"var(--color-accent)\" stroke-width=\"2\" />\n            \n            <!-- Points -->\n            ${sorted\n                .map(\n                    (h) => `\n                <circle cx=\"${getX(h.createdAt)}\" cy=\"${getY(h.ftp)}\" r=\"4\" fill=\"var(--card-bg)\" stroke=\"var(--color-accent)\" stroke-width=\"2\">\n                    <title>${h.ftp} W (${formatDate(h.createdAt)})</title>\n                </circle>\n                <text x=\"${getX(h.createdAt)}\" y=\"${getY(h.ftp) - 10}\" text-anchor=\"middle\" font-size=\"10\" fill=\"var(--color-text-primary)\">${h.ftp}</text>\n            `\n                )\n                .join('')}\n\n            <!-- Axis Labels (simplified) -->\n            <text x=\"${pad.left}\" y=\"${height - 10}\" font-size=\"10\" fill=\"var(--color-text-secondary)\">${formatDate(startDate)}</text>\n            <text x=\"${width - pad.right}\" y=\"${height - 10}\" text-anchor=\"end\" font-size=\"10\" fill=\"var(--color-text-secondary)\">Today</text>\n        </svg>\n    `;\n\n    container.innerHTML = svg;\n}\n\n/**\n * Render PR History (Chronological improvements)\n */\nfunction renderPrHistory(workouts: Workout[]): void {\n    const container = document.getElementById('prHistoryList');\n    if (!container) return;\n\n    // Sort strictly chronological\n    const sorted = [...workouts].sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());\n\n    interface RecordEvent {\n        date: string;\n        metric: string;\n        value: string;\n        improvement: string;\n        workoutId: string;\n    }\n\n    const events: RecordEvent[] = [];\n\n    // State to track maxes\n    let maxPower = 0;\n    let maxHr = 0;\n    const powerCurveBests: Record<number, number> = {};\n\n    sorted.forEach((w) => {\n        const summary = getSummary(w);\n        const dateStr = formatDate(w.startTime);\n\n        // Power (1s)\n        if (summary.maxPower && summary.maxPower > maxPower) {\n            if (maxPower > 0) {\n                const diff = summary.maxPower - maxPower;\n                events.push({\n                    date: dateStr,\n                    metric: 'Max Power',\n                    value: `${summary.maxPower} W`,\n                    improvement: `+${diff} W`,\n                    workoutId: w.id,\n                });\n            } else {\n                events.push({\n                    date: dateStr,\n                    metric: 'Max Power',\n                    value: `${summary.maxPower} W`,\n                    improvement: 'New!',\n                    workoutId: w.id,\n                });\n            }\n            maxPower = summary.maxPower;\n        }\n\n        // HR\n        if (summary.maxHeartrate && summary.maxHeartrate > maxHr) {\n            if (maxHr > 0) {\n                const diff = summary.maxHeartrate - maxHr;\n                events.push({\n                    date: dateStr,\n                    metric: 'Max Heart Rate',\n                    value: `${summary.maxHeartrate} bpm`,\n                    improvement: `+${diff} bpm`,\n                    workoutId: w.id,\n                });\n            } else {\n                events.push({\n                    date: dateStr,\n                    metric: 'Max Heart Rate',\n                    value: `${summary.maxHeartrate} bpm`,\n                    improvement: 'New!',\n                    workoutId: w.id,\n                });\n            }\n            maxHr = summary.maxHeartrate;\n        }\n\n        // Power Curve - Notable durations (1m, 5m, 20m)\n        if (summary.powerCurve) {\n            const notable = [60, 300, 1200];\n            const labels: Record<number, string> = { 60: '1m Power', 300: '5m Power', 1200: '20m Power' };\n            summary.powerCurve.forEach((p: { duration: number; watts: number }) => {\n                if (notable.includes(p.duration)) {\n                    const current = powerCurveBests[p.duration] || 0;\n                    if (p.watts > current) {\n                        if (current > 0) {\n                            events.push({\n                                date: dateStr,\n                                metric: labels[p.duration],\n                                value: `${p.watts} W`,\n                                improvement: `+${p.watts - current} W`,\n                                workoutId: w.id,\n                            });\n                        } else {\n                            events.push({\n                                date: dateStr,\n                                metric: labels[p.duration],\n                                value: `${p.watts} W`,\n                                improvement: 'New!',\n                                workoutId: w.id,\n                            });\n                        }\n                        powerCurveBests[p.duration] = p.watts;\n                    }\n                }\n            });\n        }\n    });\n\n    if (events.length === 0) {\n        container.innerHTML =\n            '<div style=\"text-align: center; color: var(--color-text-secondary); padding: 20px;\">No records found</div>';\n        return;\n    }\n\n    // Sort events reverse chronological (newest first)\n    const reversedEvents = events.reverse();\n\n    container.innerHTML = reversedEvents\n        .map(\n            (e) => `\n        <div class=\"pr-history-row\" data-id=\"${e.workoutId}\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--color-border); cursor: pointer;\">\n            <div style=\"flex: 1;\">\n                <div style=\"font-weight: 500;\">${e.metric}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-text-secondary);\">${e.date}</div>\n            </div>\n            <div style=\"text-align: right;\">\n                <div style=\"font-weight: bold; color: var(--color-accent);\">${e.value}</div>\n                <div style=\"font-size: 0.8em; color: var(--color-success);\">${e.improvement}</div>\n            </div>\n        </div>\n    `\n        )\n        .join('');\n\n    container.querySelectorAll('.pr-history-row').forEach((row) => {\n        row.addEventListener('click', () => {\n            const id = (row as HTMLElement).dataset.id;\n            if (id) viewWorkoutDetails(id);\n        });\n    });\n}\n// Exported helper for the View\nexport async function refreshHistoryView(): Promise<void> {\n    // Reset to today if needed, or just refresh current view\n    if (currentView === 'list') {\n        await loadWorkouts();\n    } else if (currentView === 'calendar') {\n        await loadCalendar();\n    } else if (currentView === 'analytics') {\n        await loadAnalytics();\n    }\n}\n\nconst ZONE_COLORS: Record<number, string> = {\n    1: '#3b82f6', // Blue - Recovery\n    2: '#22c55e', // Green - Endurance\n    3: '#eab308', // Yellow - Tempo\n    4: '#f97316', // Orange - Threshold\n    5: '#ef4444', // Red - VO2max/Anaerobic\n    6: '#a855f7', // Purple - Anaerobic (power)\n    7: '#ec4899', // Pink - Neuromuscular (power)\n};\n\n/**\n * Format seconds to MM:SS or Xh Ym\n */\nfunction formatZoneTime(ms: number): string {\n    const seconds = Math.round(ms / 1000);\n    if (seconds < 3600) {\n        const mins = Math.floor(seconds / 60);\n        const secs = seconds % 60;\n        return `${mins}m ${secs}s`;\n    } else {\n        const hours = Math.floor(seconds / 3600);\n        const mins = Math.floor((seconds % 3600) / 60);\n        return `${hours}h ${mins}m`;\n    }\n}\n\n/**\n * Render Zone Distribution Chart\n */\nfunction renderZoneChart(containerId: string, distribution: any, title: string): void {\n    const container = document.getElementById(containerId);\n    if (!container || !distribution || !distribution.zones) return;\n\n    // Filter zones that have any time\n    const activeZones = distribution.zones; // Show all zones for consistency, or filter? typical is all.\n    const maxTime = Math.max(...activeZones.map((z: any) => z.timeInZoneMs));\n\n    if (maxTime === 0) {\n        container.style.display = 'none';\n        return;\n    }\n\n    const html = `\n    <div style=\"display: flex; flex-direction: column; gap: 8px;\">\n      <div style=\"font-weight: bold; margin-bottom: 8px;\">${title}</div>\n      ${activeZones\n          .map((zone: any) => {\n              const percent = maxTime > 0 ? (zone.timeInZoneMs / maxTime) * 100 : 0;\n              const totalPercent =\n                  distribution.totalTimeMs > 0 ? (zone.timeInZoneMs / distribution.totalTimeMs) * 100 : 0;\n              const color = ZONE_COLORS[zone.zone] || '#888';\n              const timeStr = formatZoneTime(zone.timeInZoneMs);\n\n              return `\n          <div style=\"display: flex; align-items: center; gap: 10px; font-size: 0.9em;\">\n            <div style=\"width: 30px; font-weight: bold; color: var(--color-text-secondary);\">Z${zone.zone}</div>\n            <div style=\"flex: 1; background: var(--color-bg-tertiary); height: 24px; border-radius: 4px; overflow: hidden; position: relative;\">\n               <div style=\"width: ${percent}%; height: 100%; background-color: ${color}; transition: width 0.5s;\"></div>\n               <span style=\"position: absolute; left: 8px; top: 0; bottom: 0; display: flex; align-items: center; color: var(--color-text-inverse); text-shadow: 0 0 2px rgba(0,0,0,0.5); font-size: 0.8em;\">\n                 ${Math.round(totalPercent)}%\n               </span>\n            </div>\n            <div style=\"width: 60px; text-align: right; font-family: monospace;\">${timeStr}</div>\n          </div>\n        `;\n          })\n          .join('')}\n    </div>\n  `;\n\n    container.innerHTML = html;\n}\n\n/**\n * Parses telemetry and renders charts for workout detail\n */\nfunction renderWorkoutCharts(telemetryJson: string, startTimeIso: string | number): void {\n    try {\n        const data = JSON.parse(telemetryJson) as MeasurementsData;\n        const startTs = typeof startTimeIso === 'string' ? new Date(startTimeIso).getTime() : startTimeIso;\n\n        // Power Chart\n        const powerContainer = document.getElementById('wd-chart-power');\n        if (powerContainer && data.power && data.power.length > 0) {\n            const points = data.power.map((p) => ({ x: p.timestamp - startTs, y: p.value }));\n            renderLineChart(powerContainer, points, {\n                title: 'Power',\n                color: '#fbbf24', // Amber 400\n                yLabel: 'Watts',\n                yMin: 0,\n            });\n        } else if (powerContainer) {\n            powerContainer.style.display = 'none';\n        }\n\n        // Heart Rate Chart\n        const hrContainer = document.getElementById('wd-chart-hr');\n        if (hrContainer && data.heartrate && data.heartrate.length > 0) {\n            const points = data.heartrate.map((p) => ({ x: p.timestamp - startTs, y: p.value }));\n            renderLineChart(hrContainer, points, {\n                title: 'Heart Rate',\n                color: '#f87171', // Red 400\n                yLabel: 'BPM',\n                yMin: 40,\n            });\n        } else if (hrContainer) {\n            hrContainer.style.display = 'none';\n        }\n\n        // Cadence Chart\n        const cadContainer = document.getElementById('wd-chart-cadence');\n        if (cadContainer && data.cadence && data.cadence.length > 0) {\n            const points = data.cadence.map((p) => ({ x: p.timestamp - startTs, y: p.value }));\n            renderLineChart(cadContainer, points, {\n                title: 'Cadence',\n                color: '#60a5fa', // Blue 400\n                yLabel: 'RPM',\n                yMin: 0,\n            });\n        } else if (cadContainer) {\n            cadContainer.style.display = 'none';\n        }\n\n        // Altitude Chart\n        const altContainer = document.getElementById('wd-chart-altitude');\n        if (altContainer && data.altitude && data.altitude.length > 0) {\n            const points = data.altitude.map((p) => ({ x: p.timestamp - startTs, y: p.value }));\n            // Filter out zero altitudes if unlikely\n            const validPoints = points.filter((p) => p.y !== 0);\n\n            if (validPoints.length > 0) {\n                renderLineChart(altContainer, validPoints, {\n                    title: 'Altitude',\n                    color: '#34d399', // Emerald 400\n                    yLabel: 'Meters',\n                });\n            } else {\n                altContainer.style.display = 'none';\n            }\n        } else if (altContainer) {\n            altContainer.style.display = 'none';\n        }\n    } catch (e) {\n        console.error('Failed to parse telemetry for charts', e);\n    }\n}\n\n/**\n * Start the Crop Tool for a workout\n */\nfunction startCropTool(workout: Workout): void {\n    if (!workout.telemetry || !workout.startTime) {\n        alert('No telemetry data available for cropping');\n        return;\n    }\n\n    const detailPanel = document.getElementById('workoutDetailPanel');\n    if (!detailPanel) return;\n\n    let measurements: MeasurementsData | null = null;\n    try {\n        measurements = JSON.parse(workout.telemetry) as MeasurementsData;\n    } catch (e) {\n        console.error('Invalid telemetry', e);\n        alert('Failed to parse workout data');\n        return;\n    }\n\n    if (!measurements) return;\n\n    const originalStart = new Date(workout.startTime).getTime();\n    const originalEnd = workout.endTime\n        ? new Date(workout.endTime).getTime()\n        : originalStart + (workout.duration || 0) * 1000;\n\n    // Initial state\n    let currentStart = originalStart;\n    let currentEnd = originalEnd;\n    const durationMs = originalEnd - originalStart;\n\n    // Render Crop UI\n    detailPanel.innerHTML = `\n    <div class=\"workout-crop-tool\">\n      <div class=\"workout-detail-header\">\n        <button id=\"cancelCropBtn\" class=\"workout-back-btn\">Cancel</button>\n        <h3>Crop Workout</h3>\n        <button id=\"saveCropBtn\" class=\"workout-action-btn workout-status-completed\">Save Changes</button>\n      </div>\n\n      <div class=\"crop-controls\" style=\"margin: 20px 0; padding: 20px; background: var(--color-bg-secondary); border-radius: 8px;\">\n         <div style=\"display: flex; justify-content: space-between; margin-bottom: 20px;\">\n             <div>\n                 <label>Start Time offset</label>\n                 <div class=\"value-display\" id=\"cropStartDisplay\">00:00</div>\n                 <input type=\"range\" id=\"cropStartSlider\" min=\"0\" max=\"${durationMs}\" value=\"0\" style=\"width: 100%\">\n             </div>\n             <div style=\"text-align: right;\">\n                 <label>End Time offset</label>\n                 <div class=\"value-display\" id=\"cropEndDisplay\">${formatDuration(durationMs / 1000)}</div>\n                 <input type=\"range\" id=\"cropEndSlider\" min=\"0\" max=\"${durationMs}\" value=\"${durationMs}\" style=\"width: 100%\">\n             </div>\n         </div>\n         \n         <div style=\"text-align: center; font-weight: bold; margin-bottom: 10px;\">\n            New Duration: <span id=\"cropDurationDisplay\">${formatDuration(durationMs / 1000)}</span>\n         </div>\n         \n         <div id=\"cropPreviewChart\" style=\"height: 150px; background: var(--card-bg); border-radius: 8px;\"></div>\n      </div>\n      \n      <div class=\"crop-info\" style=\"font-size: 0.9em; color: var(--color-text-secondary); margin-top: 10px;\">\n          <p> Saving will overwrite the original workout data. This cannot be undone.</p>\n      </div>\n    </div>\n  `;\n\n    // Init interaction\n    const sliderStart = document.getElementById('cropStartSlider') as HTMLInputElement;\n    const sliderEnd = document.getElementById('cropEndSlider') as HTMLInputElement;\n    const displayStart = document.getElementById('cropStartDisplay');\n    const displayEnd = document.getElementById('cropEndDisplay');\n    const displayDuration = document.getElementById('cropDurationDisplay');\n    const chartContainer = document.getElementById('cropPreviewChart')!;\n\n    // Render preview chart (using Power as reference)\n    const renderPreview = () => {\n        if (measurements && measurements.power) {\n            const cropped = cropWorkout(measurements, originalStart, currentStart, currentEnd);\n            const points = cropped.measurements.power.map((p) => ({ x: p.timestamp - currentStart, y: p.value }));\n\n            renderLineChart(chartContainer, points, {\n                title: 'Preview (Power)',\n                color: '#fbbf24',\n                yMin: 0,\n                height: 150,\n            });\n        }\n    };\n\n    const updateUI = () => {\n        const startOffset = parseInt(sliderStart.value);\n        const endOffset = parseInt(sliderEnd.value);\n\n        // Enforce constraints\n        if (startOffset >= endOffset) {\n            // Prevent crossing\n            if (document.activeElement === sliderStart) {\n                sliderStart.value = (endOffset - 10000).toString(); // Keep 10s gap\n            } else {\n                sliderEnd.value = (startOffset + 10000).toString();\n            }\n            return;\n        }\n\n        currentStart = originalStart + parseInt(sliderStart.value);\n        currentEnd = originalStart + parseInt(sliderEnd.value);\n\n        if (displayStart) displayStart.textContent = formatDuration(parseInt(sliderStart.value) / 1000);\n        if (displayEnd) displayEnd.textContent = formatDuration(parseInt(sliderEnd.value) / 1000);\n        if (displayDuration) displayDuration.textContent = formatDuration((currentEnd - currentStart) / 1000);\n\n        renderPreview();\n    };\n\n    sliderStart.addEventListener('input', updateUI);\n    sliderEnd.addEventListener('input', updateUI);\n\n    // Initial render\n    setTimeout(renderPreview, 0);\n\n    // Cancel Action\n    document.getElementById('cancelCropBtn')?.addEventListener('click', () => {\n        viewWorkoutDetails(workout.id);\n    });\n\n    // Save Action\n    document.getElementById('saveCropBtn')?.addEventListener('click', async () => {\n        const btn = document.getElementById('saveCropBtn') as HTMLButtonElement;\n        btn.disabled = true;\n        btn.textContent = 'Saving...';\n\n        try {\n            const result = cropWorkout(measurements!, originalStart, currentStart, currentEnd);\n\n            // Construct updated workout object (for future API syncing)\n            // const updatedWorkout = {\n            //     ...workout,\n            //     startTime: new Date(result.startTime).toISOString(),\n            //     endTime: new Date(result.endTime).toISOString(),\n            //     duration: result.duration,\n            //     summary: JSON.stringify(result.summary),\n            //     telemetry: JSON.stringify(result.measurements)\n            // };\n\n            // Save methods\n            if (isIndexedDBSupported()) {\n                // Always update local storage if available\n                const { saveCompletedWorkout } = await import('../storage/workoutStorage.js');\n                await saveCompletedWorkout(result.measurements, result.startTime, result.endTime);\n\n                // If we are renaming/replacing, we might need to delete the old one if the ID depends on start time.\n                // ID is 'workout_' + startTime.\n                // If start time changes, ID changes!\n                if (result.startTime !== originalStart) {\n                    // We created a new record. Should we delete the old one?\n                    // Yes, to avoid duplicates.\n                    // But wait, if it came from API, ID is a UUID usually.\n                }\n            }\n\n            // If pure local (ID starts with workout_), we might need to handle ID change or just update data\n            // If it is an API workout, we need to send update to server\n            // TODO: Implement API update for telemetry. For now, we only update local if possible or alert user.\n            if (dataSource === 'local' || workout.id.startsWith('workout_')) {\n                if (result.startTime !== originalStart) {\n                    // const { deleteWorkout: deleteLocal } = await import('../api/workoutClient.js');\n                    // TODO: Implement local cleanup for renamed/moved workouts\n                }\n                alert('Workout cropped and saved locally.');\n            } else {\n                alert(\n                    'Cropping currently only supported for local workouts (Server update not implemented). Changes are saved to local history.'\n                );\n                // We just saved it to local indexedDb as a new workout potentially.\n            }\n\n            // Return to details\n            // If ID changed, we might need to go to list\n            if (result.startTime !== originalStart && workout.id.startsWith('workout_')) {\n                // Go to list\n                const listPanel = document.getElementById('workoutListPanel');\n                if (detailPanel && listPanel) {\n                    detailPanel.style.display = 'none';\n                    listPanel.style.display = 'block';\n                    // Trigger refresh mechanism?\n                    document.getElementById('historyRefresh')?.click();\n                }\n            } else {\n                viewWorkoutDetails(workout.id);\n            }\n        } catch (e) {\n            console.error('Failed to save crop', e);\n            alert('Error saving cropped workout');\n            btn.disabled = false;\n            btn.textContent = 'Save Changes';\n        }\n    });\n}\n","import { View } from '../router/View.js';\nimport { initHistoryLogic, refreshHistoryView } from '../ui/workoutHistory.js';\n\nexport class HistoryView implements View {\n    public id = 'history';\n    private isInitialized = false;\n\n    public init(container: HTMLElement): void {\n        const template = document.getElementById('workoutHistoryTemplate') as HTMLTemplateElement;\n\n        if (template) {\n            const content = template.content.cloneNode(true);\n            container.appendChild(content);\n\n            // Initialize the logic now that elements are in the DOM\n            // We use setTimeout to ensure the DOM update is processed\n            setTimeout(() => {\n                initHistoryLogic();\n                this.isInitialized = true;\n            }, 0);\n        } else {\n            console.error('History template not found!');\n            container.innerHTML = '<p>Error loading history view</p>';\n        }\n    }\n\n    public onEnter(): void {\n        if (this.isInitialized) {\n            refreshHistoryView();\n        } else {\n            // Fallback if onEnter is called too fast (shouldn't happen with sync init)\n            // logic is initialized in init(), but data might need loading\n            setTimeout(() => refreshHistoryView(), 50);\n        }\n    }\n\n    public onLeave(): void {\n        // Cleanup if needed\n    }\n}\n"],"file":"HistoryView-Cn1ZhpbW.js"}