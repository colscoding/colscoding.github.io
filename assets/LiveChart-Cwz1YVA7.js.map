{"version":3,"file":"LiveChart-Cwz1YVA7.js","sources":["../../src/components/LiveChart.ts"],"sourcesContent":["/**\n * Live Chart Component\n *\n * A Web Component for displaying real-time rolling charts of workout metrics.\n * Uses SVG for rendering and requestAnimationFrame for smooth 60fps updates.\n * Optimized for mobile performance with minimal DOM operations.\n *\n * @example\n * ```html\n * <bpt-live-chart\n *   type=\"power\"\n *   duration=\"60\"\n *   max-value=\"400\">\n * </bpt-live-chart>\n * ```\n *\n * @module LiveChart\n */\n\nimport { BaseComponent } from './base/BaseComponent.js';\n\n/**\n * Data point for the chart\n */\ninterface DataPoint {\n    timestamp: number;\n    value: number;\n}\n\n/**\n * Chart configuration by type\n */\nconst CHART_CONFIG: Record<\n    string,\n    { color: string; gradientStart: string; gradientEnd: string; label: string; unit: string; defaultMax: number }\n> = {\n    power: {\n        color: '#f97316',\n        gradientStart: 'rgba(249, 115, 22, 0.4)',\n        gradientEnd: 'rgba(249, 115, 22, 0.05)',\n        label: 'Power',\n        unit: 'W',\n        defaultMax: 400,\n    },\n    heartrate: {\n        color: '#ef4444',\n        gradientStart: 'rgba(239, 68, 68, 0.4)',\n        gradientEnd: 'rgba(239, 68, 68, 0.05)',\n        label: 'Heart Rate',\n        unit: 'bpm',\n        defaultMax: 200,\n    },\n};\n\n/**\n * Live Chart Web Component\n */\nexport class LiveChart extends BaseComponent {\n    private _data: DataPoint[] = [];\n    private _animationId: number | null = null;\n    private _lastRenderTime = 0;\n    private _isVisible = true;\n    private _duration = 60; // seconds\n    private _maxValue: number;\n    private _type: string;\n    private _svgPath: SVGPathElement | null = null;\n    private _svgArea: SVGPathElement | null = null;\n    private _currentValueEl: HTMLElement | null = null;\n    private _avgValueEl: HTMLElement | null = null;\n\n    static get observedAttributes(): string[] {\n        return ['type', 'duration', 'max-value', 'hidden'];\n    }\n\n    constructor() {\n        super();\n        this._type = 'power';\n        this._maxValue = CHART_CONFIG.power.defaultMax;\n    }\n\n    protected getStyles(): string {\n        return `\n            :host {\n                display: block;\n                width: 100%;\n                background: var(--color-bg-secondary, #f6f8fa);\n                border-radius: 8px;\n                overflow: hidden;\n                contain: layout style paint;\n            }\n\n            :host([hidden]) {\n                display: none;\n            }\n\n            .chart-container {\n                position: relative;\n                width: 100%;\n                height: 120px;\n                padding: 8px;\n            }\n\n            .chart-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 0 4px 4px 4px;\n                font-size: 11px;\n                color: var(--color-text-secondary, #656d76);\n            }\n\n            .chart-label {\n                font-weight: 600;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n\n            .chart-values {\n                display: flex;\n                gap: 12px;\n            }\n\n            .chart-value {\n                display: flex;\n                align-items: baseline;\n                gap: 2px;\n            }\n\n            .chart-value-number {\n                font-size: 14px;\n                font-weight: 700;\n                color: var(--chart-color, #f97316);\n            }\n\n            .chart-value-label {\n                font-size: 10px;\n                color: var(--color-text-muted, #8b949e);\n            }\n\n            .chart-svg-container {\n                position: relative;\n                width: 100%;\n                height: 80px;\n            }\n\n            svg {\n                width: 100%;\n                height: 100%;\n                display: block;\n            }\n\n            .chart-line {\n                fill: none;\n                stroke: var(--chart-color, #f97316);\n                stroke-width: 2;\n                stroke-linecap: round;\n                stroke-linejoin: round;\n                vector-effect: non-scaling-stroke;\n            }\n\n            .chart-area {\n                fill: url(#chartGradient);\n                opacity: 0.8;\n            }\n\n            .chart-grid-line {\n                stroke: var(--color-border, #d0d7de);\n                stroke-width: 1;\n                stroke-dasharray: 4 4;\n                opacity: 0.5;\n            }\n\n            .chart-axis-label {\n                font-size: 9px;\n                fill: var(--color-text-muted, #8b949e);\n            }\n\n            .no-data-message {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 12px;\n                color: var(--color-text-muted, #8b949e);\n            }\n\n            /* Reduced motion */\n            @media (prefers-reduced-motion: reduce) {\n                .chart-line,\n                .chart-area {\n                    transition: none;\n                }\n            }\n        `;\n    }\n\n    protected getTemplate(): string {\n        const config = CHART_CONFIG[this._type] || CHART_CONFIG.power;\n\n        return `\n            <div class=\"chart-container\">\n                <div class=\"chart-header\">\n                    <span class=\"chart-label\">\n                        <span>${config.label}</span>\n                        <span style=\"font-weight: normal; font-size: 10px;\">(${this._duration}s)</span>\n                    </span>\n                    <div class=\"chart-values\">\n                        <div class=\"chart-value\">\n                            <span class=\"chart-value-number\" id=\"currentValue\">--</span>\n                            <span class=\"chart-value-label\">${config.unit}</span>\n                        </div>\n                        <div class=\"chart-value\">\n                            <span class=\"chart-value-number\" id=\"avgValue\" style=\"opacity: 0.7;\">--</span>\n                            <span class=\"chart-value-label\">avg</span>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"chart-svg-container\">\n                    <svg viewBox=\"0 0 300 80\" preserveAspectRatio=\"none\" aria-hidden=\"true\">\n                        <defs>\n                            <linearGradient id=\"chartGradient-${this._type}\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n                                <stop offset=\"0%\" stop-color=\"${config.gradientStart}\" />\n                                <stop offset=\"100%\" stop-color=\"${config.gradientEnd}\" />\n                            </linearGradient>\n                        </defs>\n                        <!-- Grid lines -->\n                        <line class=\"chart-grid-line\" x1=\"0\" y1=\"20\" x2=\"300\" y2=\"20\" />\n                        <line class=\"chart-grid-line\" x1=\"0\" y1=\"40\" x2=\"300\" y2=\"40\" />\n                        <line class=\"chart-grid-line\" x1=\"0\" y1=\"60\" x2=\"300\" y2=\"60\" />\n                        <!-- Axis labels -->\n                        <text class=\"chart-axis-label\" x=\"2\" y=\"18\">${this._maxValue}</text>\n                        <text class=\"chart-axis-label\" x=\"2\" y=\"78\">0</text>\n                        <!-- Chart paths -->\n                        <path class=\"chart-area\" id=\"chartArea\" d=\"M0,80 L300,80\" style=\"fill: url(#chartGradient-${this._type});\" />\n                        <path class=\"chart-line\" id=\"chartLine\" d=\"\" style=\"stroke: ${config.color};\" />\n                    </svg>\n                    <div class=\"no-data-message\" id=\"noDataMessage\">Waiting for data...</div>\n                </div>\n            </div>\n        `;\n    }\n\n    protected onConnected(): void {\n        // Cache DOM references\n        this._svgPath = this.shadow.getElementById('chartLine') as SVGPathElement | null;\n        this._svgArea = this.shadow.getElementById('chartArea') as SVGPathElement | null;\n        this._currentValueEl = this.shadow.getElementById('currentValue');\n        this._avgValueEl = this.shadow.getElementById('avgValue');\n\n        // Set CSS variable for chart color\n        const config = CHART_CONFIG[this._type] || CHART_CONFIG.power;\n        this.style.setProperty('--chart-color', config.color);\n\n        // Start animation loop\n        this.startAnimation();\n\n        // Listen for visibility changes to save battery\n        document.addEventListener('visibilitychange', this.handleVisibilityChange);\n    }\n\n    protected onDisconnected(): void {\n        this.stopAnimation();\n        document.removeEventListener('visibilitychange', this.handleVisibilityChange);\n    }\n\n    protected onAttributeChanged(name: string, _oldValue: string | null, newValue: string | null): void {\n        switch (name) {\n            case 'type':\n                this._type = newValue || 'power';\n                this._maxValue = CHART_CONFIG[this._type]?.defaultMax || 400;\n                this.render();\n                this.onConnected(); // Re-cache DOM refs\n                break;\n            case 'duration':\n                this._duration = parseInt(newValue || '60', 10);\n                this.render();\n                break;\n            case 'max-value':\n                this._maxValue = parseInt(newValue || '400', 10);\n                this.render();\n                break;\n            case 'hidden':\n                this._isVisible = newValue === null;\n                if (this._isVisible) {\n                    this.startAnimation();\n                } else {\n                    this.stopAnimation();\n                }\n                break;\n        }\n    }\n\n    private handleVisibilityChange = (): void => {\n        if (document.hidden) {\n            this.stopAnimation();\n        } else if (this._isVisible) {\n            this.startAnimation();\n        }\n    };\n\n    /**\n     * Add a data point to the chart\n     */\n    public addDataPoint(value: number, timestamp: number = Date.now()): void {\n        this._data.push({ timestamp, value });\n\n        // Remove old data points (keep duration + 5s buffer)\n        const cutoffTime = timestamp - (this._duration + 5) * 1000;\n        while (this._data.length > 0 && this._data[0].timestamp < cutoffTime) {\n            this._data.shift();\n        }\n\n        // Auto-adjust max value if needed\n        if (value > this._maxValue * 0.9) {\n            this._maxValue = Math.ceil(value * 1.2 / 50) * 50; // Round to nearest 50\n        }\n    }\n\n    /**\n     * Clear all data points\n     */\n    public clear(): void {\n        this._data = [];\n        this.renderChart();\n    }\n\n    /**\n     * Start the animation loop\n     */\n    private startAnimation(): void {\n        if (this._animationId !== null) return;\n\n        const animate = (time: number): void => {\n            // Throttle to ~30fps for better performance\n            if (time - this._lastRenderTime >= 33) {\n                this.renderChart();\n                this._lastRenderTime = time;\n            }\n            this._animationId = requestAnimationFrame(animate);\n        };\n\n        this._animationId = requestAnimationFrame(animate);\n    }\n\n    /**\n     * Stop the animation loop\n     */\n    private stopAnimation(): void {\n        if (this._animationId !== null) {\n            cancelAnimationFrame(this._animationId);\n            this._animationId = null;\n        }\n    }\n\n    /**\n     * Render the chart paths\n     */\n    private renderChart(): void {\n        if (!this._svgPath || !this._svgArea) return;\n\n        const now = Date.now();\n        const startTime = now - this._duration * 1000;\n\n        // Filter data to visible range\n        const visibleData = this._data.filter((d) => d.timestamp >= startTime);\n\n        // Update no-data message\n        const noDataMsg = this.shadow.getElementById('noDataMessage');\n        if (noDataMsg) {\n            noDataMsg.style.display = visibleData.length === 0 ? 'block' : 'none';\n        }\n\n        if (visibleData.length === 0) {\n            this._svgPath.setAttribute('d', '');\n            this._svgArea.setAttribute('d', 'M0,80 L300,80');\n            return;\n        }\n\n        // Calculate path\n        const width = 300;\n        const height = 80;\n        const points: string[] = [];\n        const areaPoints: string[] = [];\n\n        visibleData.forEach((point) => {\n            const x = ((point.timestamp - startTime) / (this._duration * 1000)) * width;\n            const y = height - (Math.min(point.value, this._maxValue) / this._maxValue) * height;\n            points.push(`${x.toFixed(1)},${y.toFixed(1)}`);\n            areaPoints.push(`${x.toFixed(1)},${y.toFixed(1)}`);\n        });\n\n        // Build path strings\n        if (points.length > 0) {\n            const linePath = 'M' + points.join(' L');\n            this._svgPath.setAttribute('d', linePath);\n\n            // Area path: line + close to bottom\n            const firstX = ((visibleData[0].timestamp - startTime) / (this._duration * 1000)) * width;\n            const lastX =\n                ((visibleData[visibleData.length - 1].timestamp - startTime) / (this._duration * 1000)) * width;\n            const areaPath = `M${firstX.toFixed(1)},${height} L` + areaPoints.join(' L') + ` L${lastX.toFixed(1)},${height} Z`;\n            this._svgArea.setAttribute('d', areaPath);\n        }\n\n        // Update current and average values\n        if (this._currentValueEl && visibleData.length > 0) {\n            const currentValue = visibleData[visibleData.length - 1].value;\n            this._currentValueEl.textContent = Math.round(currentValue).toString();\n        }\n\n        if (this._avgValueEl && visibleData.length > 0) {\n            const avg = visibleData.reduce((sum, p) => sum + p.value, 0) / visibleData.length;\n            this._avgValueEl.textContent = Math.round(avg).toString();\n        }\n    }\n\n    /**\n     * Get current data for debugging/testing\n     */\n    public getData(): DataPoint[] {\n        return [...this._data];\n    }\n}\n\n// Register the custom element\ncustomElements.define('bpt-live-chart', LiveChart);\n\n// Export for type-safe usage\ndeclare global {\n    interface HTMLElementTagNameMap {\n        'bpt-live-chart': LiveChart;\n    }\n}\n"],"names":["CHART_CONFIG","LiveChart","BaseComponent","config","name","_oldValue","newValue","value","timestamp","cutoffTime","animate","time","startTime","visibleData","d","noDataMsg","width","height","points","areaPoints","point","x","y","linePath","firstX","lastX","areaPath","currentValue","avg","sum","p"],"mappings":"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"}