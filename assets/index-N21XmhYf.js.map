{"version":3,"mappings":"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","names":["registry","loaded","observer","registerLazyComponent","tagName","loader","upperTag","startObserver","checkForComponent","mutations","nodesAdded","m","checkAllPending","loadComponent","error","PerformanceMonitor","list","entry","entries","lastEntry","fid","clsValue","name","startMark","start","duration","value","summary","metric","data","VALIDATION_LIMITS","DEFAULT_SETTINGS","SettingsStore","openDB","db","stored","key","updates","listener","index","settings","e","settingsStore","StateEventBus","event","handler","handlers","stateEventBus","DistanceCalculator","point","distance","timeDelta","maxDistance","p1","p2","lat1","lat2","dLat","dLon","a","distanceCalculator","calculateCaloriesFromPower","powerWatts","durationSeconds","calculateCaloriesFromHeartRate","heartRate","weightKg","age","minutes","termAge","termWeight","termHr","caloriesPerMinute","DEFAULT_CONFIG","AdaptiveUpdater","config","callback","now","timeSinceDataChange","dataFieldsUpdater","MeasurementsState","enablePersistence","isIndexedDBSupported","flushPendingSave","time","_settings","timestamp","source","method","dt","kcal","throttledSave","min","max","type","clearPersisted","clearActiveWorkout","startTime","lapNumber","lap","enabled","measurement","appState","initializeState","exposeVariablesDuringTest","measurementsState","connectionsState","App","registerPlugin","__vitePreload","Router","container","Capacitor","canGoBack","view","viewContainer","viewId","path","replace","hash","matchedRoute","r","currentView","el","newView","DashboardView","_container","ViewId","NavBar","router","detail","btn","target","selectElement","id","element","setupRouter","dashboardView","settingsButton","details","workoutsButton","plansButton","getTimestring","milliseconds","totalSeconds","hours","seconds","announce","message","priority","announcer","shortcuts","registerShortcut","shortcut","handleKeydown","keyMatch","ctrlMatch","shiftMatch","altMatch","initKeyboardNavigation","startButton","pauseButton","resumeButton","modals","modal","closeBtn","firstButton","settingsBtn","historyBtn","exportBtn","lapBtn","trapFocus","focusableElements","firstElement","lastElement","updateWorkoutControlsAccessibility","state","stopButton","controlsContainer","generateRampSteps","startWatts","stepWatts","steps","_","i","watts","RAMP_TEST","SWEET_SPOT_3X10","VO2_MAX_30_30","WORKOUT_LIBRARY","getWorkoutDuration","workout","acc","step","PROFILE_KEY","defaultProfile","loadUserProfile","saveUserProfile","profile","AudioController","Ctx","muted","freq","osc","gain","text","utterance","audioManager","WorkoutRunner","options","totalDuration","cb","nextIndex","startVal","endVal","progress","currentVal","val","unit","API_BASE_URL","API_KEY","parseError","response","body","getHeaders","extraHeaders","headers","isDatabaseAvailable","createWorkout","streamName","title","sport","userId","errorData","listWorkouts","page","limit","status","startDate","endDate","params","getWorkout","workoutId","includeTelemetry","completeWorkout","archiveTelemetry","deleteWorkout","formatDuration","secs","formatDate","date","STORAGE_KEY","getCustomWorkouts","raw","saveCustomWorkout","workouts","w","saveAll","deleteCustomWorkout","filtered","activeRunner","initWorkoutSelectionLogic","initPlayerControls","initImportExport","refreshWorkoutList","importBtn","importInput","files","importWorkoutFile","file","err","exportWorkout","dataStr","downloadAnchorNode","custom","h3","renderWorkoutItem","hr","h3lib","isCustom","actionsHtml","actionContainerStyle","t","startStructuredWorkout","onComplete","completed","updatePlayerUI","overlay","minimizeBtn","skipBtn","isHidden","nameEl","descEl","timeEl","durEl","targetEl","nextEl","progressEl","timeRemaining","formatTime","nextPwr","calculateNextTarget","pct","s","onWorkoutStart","onWorkoutPause","BaseComponent","oldValue","newValue","_name","_oldValue","_newValue","eventName","selector","TYPE_STYLES","Toast","dismissible","styles","dismissBtn","toast","showNotification","notification","backgroundColor","calculateTotalDistanceKm","gpsPoints","totalMeters","R","prev","curr","deltaLat","deltaLon","c","VoiceFeedback","timeState","getSettings","voices","v","ms","parts","timeMs","avgPower","timeStr","zoneName","count","intervalMinutes","elapsedMs","intervalMs","currentInterval","lastInterval","intervalKm","totalKm","metrics","recentThreshold","recentPower","p","recentHr","h","recentCadence","recentSpeed","trigger","metricsSettings","voiceFeedback","showCountdown","resolve","createCountdownOverlay","currentCount","intervalId","isCancelled","updateDisplay","countElement","playBeep","cancelBtn","handleCancel","isFinal","audioContext","oscillator","gainNode","getWorkoutState","updateButtonVisibility","elements","workoutControlElements","pauseWorkout","isAutoPause","resumeWorkout","isAutoResume","pausedDuration","initTimerDisplay","timeElement","nextText","addListener","workoutCompleteEvent","getLapNumber","laps","getCsvString","measurements","dataPoints","mergeMeasurements","header","rows","power","cadence","heartrate","speed","altitude","lat","lon","FIT_PROTOCOL_VERSION","FIT_PROFILE_VERSION","FIT_MESG_FILE_ID","FIT_MESG_FILE_CREATOR","FIT_MESG_ACTIVITY","FIT_MESG_SESSION","FIT_MESG_LAP","FIT_MESG_RECORD","FIT_MESG_EVENT","FIT_BASE_TYPE_ENUM","FIT_BASE_TYPE_UINT8","FIT_BASE_TYPE_UINT16","FIT_BASE_TYPE_UINT32","FILE_ID_TYPE","FILE_ID_MANUFACTURER","FILE_ID_PRODUCT","FILE_ID_SERIAL_NUMBER","FILE_ID_TIME_CREATED","RECORD_TIMESTAMP","RECORD_HEART_RATE","RECORD_CADENCE","RECORD_POWER","SESSION_TIMESTAMP","SESSION_START_TIME","SESSION_TOTAL_ELAPSED_TIME","SESSION_TOTAL_TIMER_TIME","SESSION_TOTAL_DISTANCE","SESSION_TOTAL_CALORIES","SESSION_SPORT","SESSION_SUB_SPORT","SESSION_EVENT","SESSION_EVENT_TYPE","LAP_TIMESTAMP","LAP_START_TIME","LAP_TOTAL_ELAPSED_TIME","LAP_TOTAL_TIMER_TIME","LAP_TOTAL_DISTANCE","LAP_TOTAL_CALORIES","LAP_EVENT","LAP_EVENT_TYPE","EVENT_TIMESTAMP","EVENT_EVENT","EVENT_EVENT_TYPE","ACTIVITY_TIMESTAMP","ACTIVITY_TOTAL_TIMER_TIME","ACTIVITY_NUM_SESSIONS","ACTIVITY_TYPE","ACTIVITY_EVENT","ACTIVITY_EVENT_TYPE","ACTIVITY_LOCAL_TIMESTAMP","FILE_TYPE_ACTIVITY","MANUFACTURER_DEVELOPMENT","SPORT_CYCLING","SPORT_RUNNING","SPORT_WALKING","SUB_SPORT_INDOOR_CYCLING","SUB_SPORT_GENERIC","EVENT_TIMER","EVENT_SESSION","EVENT_LAP","EVENT_ACTIVITY","EVENT_TYPE_START","EVENT_TYPE_STOP","ACTIVITY_TYPE_MANUAL","FIT_EPOCH_MS","calculateCrc","buffer","end","crcTable","crc","byte","tmp","toFitTimestamp","jsTimestamp","FitBuilder","localMsgType","globalMsgNum","fields","field","values","result","dataSize","headerCrc","dataCrc","finalBuffer","getFitSportValues","getFitData","fitSportValues","fit","firstTimestamp","lastTimestamp","fitStartTime","fitEndTime","totalElapsedTime","totalElapsedTimeMs","validEnergy","totalCalories","validDistance","totalDistance","LOCAL_FILE_ID","LOCAL_FILE_CREATOR","LOCAL_EVENT","LOCAL_RECORD","LOCAL_LAP","LOCAL_SESSION","LOCAL_ACTIVITY","fitTimestamp","createModalElement","titleText","footer","button","b","firstFocusable","lastFocusable","handleTabKey","showModal","previousActiveElement","removeFocusTrap","autofocusEl","closeModal","handleEscape","originalOnClose","showConfirmation","confirmText","cancelText","confirmVariant","icon","calculateWorkoutSummary","endTime","zoneState","calcStats","d","sum","powerValues","powerCurve","durations","getMaxForDuration","windowSize","maxAvg","trainingLoad","intensityFactor","profileStr","ftp","rolling30s","sum30","pow4","avgPow4","np","powerDist","hrDist","formatDurationLong","formatSecondsShort","mins","ZONE_COLORS","createZoneHistogram","distribution","z","maxTime","zone","percent","timeSeconds","color","createSummaryContent","newRecords","formatValue","recordsHtml","powerChart","hrChart","showWorkoutSummary","callbacks","content","RPE_DESCRIPTIONS","generateDefaultTitle","timeOfDay","dateStr","createRpeSelector","selectedValue","info","buttons","rpe","createMetadataFormContent","showNotes","showExertion","titleSection","notesSection","rpeSection","getMetadataFromForm","titleInput","notesInput","selectedRpe","metadata","showWorkoutMetadataModal","promptForNotes","promptForExertion","formContent","shouldShowMetadataModal","DEFAULT_UNDO_TIMEOUT","showUndoNotification","onUndo","onExpire","timeout","timeoutSeconds","remainingSeconds","undoButton","countdownSpan","progressFill","prefersReducedMotion","isUndone","countdownInterval","dismissTimeout","dismiss","executeExpire","createWorkoutBackup","restoreWorkoutBackup","backup","initLapButton","lapButton","lapCounter","lapCountElement","updateLapCounter","updateLapButtonVisibility","isRecording","handleLapClick","lastLapTime","durationMs","lapPower","elapsedStr","resetLapCounter","PersonalRecordTracker","getSummary","currentBest","newSummary","records","significantDurations","labels","IntervalsService","workoutName","fitData","blob","formData","athleteId","url","auth","defaultSettings","STRAVA_UPLOAD_URL","StravaService","filename","filePrefix","tcxString","getTcxString","stravaService","initMetricsToggle","toggleYour","yourMetricsSection","toggleStream","streamMetricsSection","initDiscardButton","discardButton","resetWorkoutState","totalDataPoints","restoreWorkoutUI","elapsed","getExportTimestamp","downloadFile","link","initExportButton","exportDataElem","settingsJson","getWorkoutMetadata","safeTitle","isDownload","exportData","zoneData","jsonStr","csvString","fitBlob","collectedMetadata","clearWorkoutMetadata","initWorkoutSummaryModal","history","workoutMetadataModal","archiveWorkout","calculatePowerZones","calculateHrZones","maxHr","getPowerZone","zones","getHrZone","ZoneState","powerZonesDef","hrZonesDef","zoneInfo","currentZone","range","percentInZone","totalTimeMs","DATA_TIMEOUT_MS","UPDATE_INTERVAL_MS","initLiveCharts","chartsContainer","metricsSection","dataFieldsCarousel","initChartsToggle","chartsVisible","toggleBtn","topBarControls","workoutControls","initMetricsDisplay","chartsToggle","lastPowerIndex","lastHrIndex","lastPowerZone","lastHrZone","updateLiveCharts","updateZoneTracking","latest","createStream","listStreams","addMessage","author","createFetchSSE","onMessage","onConnected","onError","controller","isActive","connection","reader","decoder","done","messages","dataMatch","listenToStream","listenToAllStreams","sendWorkoutData","workoutData","StreamViewer","toggleViewBtn","grid","refreshBtn","viewAllBtn","streamsList","streams","stream","streamItem","div","streamTitle","statusEl","reactionPanel","allStreamsStatus","messageData","card","powerEl","cadenceEl","hrEl","row","messageStr","lastUpdateEl","heartrateEl","speedEl","distanceEl","altitudeEl","elapsedEl","streamLastUpdate","initStreamViewer","viewer","viewStreamsBtn","ReactionListener","delay","initStreamingControls","streamManager","reactionListener","reactionDisplay","setupReactions","n","cleanupReactions","startStreamButton","confirmBtn","nameInput","toolbar","toolbarStreamName","playPauseBtn","stopBtn","streamIndicator","updateToolbar","startStreaming","customName","stopStreaming","handleWorkoutPause","currentSteps","initWorkoutBuilder","createBtn","saveBtn","addStepBtn","openBuilder","closeBuilder","saveWorkout","addStepFromForm","targetTypeSelect","valInput","selectionModal","resetForm","renderSteps","durationStr","targetType","targetValStr","targetTypeStr","targetValue","capitalize","desc","idx","sec","DARK_MODE_KEY","getStoredThemePreference","saveThemePreference","preference","systemPrefersDark","applyTheme","theme","getEffectiveTheme","initDarkMode","effectiveTheme","systemDark","setupDarkModeToggle","toggleElement","isDark","newTheme","newPreference","onboardingSteps","createOnboardingModal","renderProgressDots","currentStep","totalSteps","dot","renderStep","stepIndex","inputContainer","inputField","inputLabel","inputUnit","helpText","prevBtn","nextBtn","progressDots","currentValue","showOnboarding","forceShow","saveCurrentInput","render","goNext","goPrev","skip","shouldShowOnboarding","initOnboarding","formatElapsedTime","createRecoveryModal","elapsedTime","addRecoveryStyles","style","showRecoveryModal","restoreBtn","discardBtn","cleanup","initWorkoutRecovery","hasRecoverableWorkout","loadActiveWorkout","deferredPrompt","initInstallPrompt","updateInstallButtonVisibility","canInstallPwa","triggerInstallPrompt","outcome","installButton","installButtonContainer","initAboutModal","aboutButton","aboutModal","closeAboutModal","openModal","handleWakeLock","wakeLock","requestWakeLock","registerSW","immediate","onNeedRefresh","onOfflineReady","onRegistered","onRegisteredSW","onRegisterError","wb","registerPromise","updateServiceWorker","_reloadPage","register","Workbox","registerServiceWorker","registrations","registration","updateSW","showUpdateNotification","updateContainer","MapComponent","elementId","L","hasData","initialLat","initialLon","initialZoom","gpsData","points","lastPoint","latLng","loop","initMap","mapContainerId","toggleBtnId","carouselId","mapContainer","carousel","mapComponent","isMapVisible","hasGpsData","AutoPauseService","minTimestamp","recentMeasurements","threshold","isAboveThreshold","timeBelow","delayMs","getAutoPauseSourceUnit","calculateTotalDistanceMeters","AutoLapService","autoLapService","isImperial","DEFAULT_POWER_ZONES","DEFAULT_HR_ZONES","DATA_FIELD_REGISTRY","registrationOrder","registerDataField","getDataField","getAllDataFields","getFieldsByCategory","category","f","getAllCategories","categories","searchFields","query","lowerQuery","DEFAULT_UPDATE_INTERVALS","CalculationManager","workoutState","frequency","interval","timerId","fieldId","fieldIds","allFields","results","frequencies","createCalculationManager","slotCounter","slot","size","resetSlotCounter","createCyclingMainScreen","createCyclingPowerScreen","createCyclingHrScreen","createCyclingClimbScreen","createCyclingLapScreen","createCyclingSimpleScreen","createIndoorMainScreen","createIndoorPowerScreen","createIndoorTrainingScreen","createIndoorZonesScreen","createRunningMainScreen","createRunningPaceScreen","DEFAULT_CYCLING_PROFILE","DEFAULT_INDOOR_PROFILE","DEFAULT_RUNNING_PROFILE","DEFAULT_SIMPLE_PROFILE","DEFAULT_PROFILES","DEFAULT_DATA_FIELD_SETTINGS","createDefaultIndoorProfile","createDefaultSettings","migrateFromLegacySettings","legacySettings","slots","SENSOR_FIELD_MAP","DataFieldsManager","prop","set","screen","connections","powerConnected","hrConnected","cadenceConnected","gpsConnected","property","lapCount","lapStartTime","createDataFieldsManager","LEGACY_SETTINGS_KEY","SCHEMA_VERSION","loadDataFieldSettings","parsed","migrated","migrateStoredSettings","validateSettings","saveDataFieldSettings","legacyStored","legacy","loadActiveProfile","saveProfile","existingIndex","saveActiveScreenIndex","profileId","screenIndex","version","validateProfile","storageCallbacks","initUi","dataFieldsManager","activeProfile","customEvent","darkModeToggle","autoPauseService","l","recovered","connectCadence","BluetoothFactory","connectHeartRate","connectPower","connectTreadmill","BackgroundGeolocation","createNativeGpsService","watcherId","location","createWebGpsService","watchId","position","GpsFactory","connectGps","service","getElement","sensorLabels","sensorIcons","parseBluetoothError","sensorType","sensorLabel","errorMessage","errorName","createErrorContent","errorInfo","messageEl","troubleshootingEl","titleEl","listEl","suggestion","itemEl","showConnectionError","onRetry","sensorIcon","showReconnectionFailed","tipsEl","tip","emojis","getSensorLabel","initConnectionButtons","updateButtonText","deviceName","connectElem","label","emoji","disconnectFn","connectionState","displayElem","handleStatusChange","connectFn","gpsConnection","disconnect","onStatusChange","StreamManager","safeName","incline","array","initHardware","Toast$1","initApp"],"ignoreList":[11],"sources":["../../src/components/lazyLoader.ts","../../src/monitoring/performance.ts","../../src/config/constants.ts","../../src/state/SettingsStore.ts","../../src/state/EventBus.ts","../../src/state/calculators/DistanceCalculator.ts","../../src/calculations/calories.ts","../../src/data-fields/AdaptiveUpdater.ts","../../src/measurements-state.ts","../../src/state/StateProvider.ts","../../src/exposeVariablesDuringTest.ts","../../../../node_modules/.pnpm/@capacitor+app@8.0.0_@capacitor+core@8.0.0/node_modules/@capacitor/app/dist/esm/index.js","../../src/router/Router.ts","../../src/views/DashboardView.ts","../../src/router/view-ids.ts","../../src/components/NavBar.ts","../../src/utils/dom.ts","../../src/init/router.ts","../../src/getTimestring.ts","../../src/ui/accessibility.ts","../../src/workouts/workoutLibrary.ts","../../src/storage/userSettings.ts","../../src/ui/audio.ts","../../src/workouts/WorkoutRunner.ts","../../src/api/workoutClient.ts","../../src/storage/customWorkouts.ts","../../src/ui/workoutPlayer.ts","../../src/components/base/BaseComponent.ts","../../src/components/Toast.ts","../../src/ui/notifications.ts","../../src/services/VoiceFeedback.ts","../../src/ui/countdown.ts","../../src/ui/time.ts","../../src/create-csv.ts","../../src/create-fit.ts","../../src/ui/modal.ts","../../src/ui/workoutMetadataModal.ts","../../src/ui/undoNotification.ts","../../src/ui/lap.ts","../../src/ui/analyticsHelper.ts","../../src/services/IntervalsService.ts","../../src/types/settings.ts","../../src/integrations/strava.ts","../../src/ui/menu.ts","../../src/zone-state.ts","../../src/initMetricsDisplay.ts","../../src/api/streamClient.ts","../../src/ui/streamViewer.ts","../../src/services/ReactionListener.ts","../../src/initStreamingControls.ts","../../src/ui/workoutBuilder.ts","../../src/ui/darkMode.ts","../../src/ui/onboarding.ts","../../src/ui/workoutRecovery.ts","../../src/ui/installPrompt.ts","../../src/ui/about.ts","../../src/ui/wakeLock.ts","../../../../../../../@vite-plugin-pwa/virtual:pwa-register","../../src/ui/serviceWorker.ts","../../src/ui/map-component.ts","../../src/init/map.ts","../../src/services/AutoPauseService.ts","../../src/services/AutoLapService.ts","../../src/data-fields/types.ts","../../src/data-fields/registry.ts","../../src/data-fields/CalculationManager.ts","../../src/data-fields/defaults.ts","../../src/data-fields/DataFieldsManager.ts","../../src/data-fields/persistence.ts","../../src/init/ui.ts","../../src/connect-cadence.ts","../../src/connect-heartrate.ts","../../src/connect-power.ts","../../src/connect-treadmill.ts","../../src/services/gps/native-gps.ts","../../src/services/gps/web-gps.ts","../../src/services/gps/factory.ts","../../src/connect-gps.ts","../../src/elements.ts","../../src/ui/connectionError.ts","../../src/initConnectionButtons.ts","../../src/stream-manager.ts","../../src/init/hardware.ts","../../src/main.ts"],"sourcesContent":["/**\n * Component Lazy Loader\n *\n * Facilitates lazy loading of Web Components when they appear in the DOM.\n * This avoids loading unused components and reduces initial bundle size.\n */\n\ntype ComponentLoader = () => Promise<unknown>;\n\nconst registry = new Map<string, ComponentLoader>();\nconst loaded = new Set<string>();\nlet observer: MutationObserver | null = null;\n\n/**\n * Register a component to be lazy loaded when it appears in the DOM.\n *\n * @param tagName - The custom element tag name (e.g., 'bpt-profile-settings')\n * @param loader - Function that imports the component module\n */\nexport function registerLazyComponent(tagName: string, loader: ComponentLoader): void {\n    const upperTag = tagName.toUpperCase();\n\n    if (customElements.get(tagName)) {\n        console.warn(`Component ${tagName} is already defined.`);\n        return;\n    }\n\n    registry.set(upperTag, loader);\n\n    // Start observer if not running\n    if (!observer) {\n        startObserver();\n    }\n\n    // Check if component is already in the DOM\n    checkForComponent(upperTag);\n}\n\nfunction startObserver() {\n    observer = new MutationObserver((mutations) => {\n        // Optimization: check if any nodes were actually added\n        let nodesAdded = false;\n        for (const m of mutations) {\n            if (m.addedNodes.length > 0) {\n                nodesAdded = true;\n                break;\n            }\n        }\n\n        if (nodesAdded) {\n            checkAllPending();\n        }\n    });\n\n    observer.observe(document.body, { childList: true, subtree: true });\n}\n\nfunction checkAllPending() {\n    for (const tagName of registry.keys()) {\n        if (!loaded.has(tagName)) {\n            checkForComponent(tagName);\n        }\n    }\n}\n\nfunction checkForComponent(tagName: string) {\n    // If we find the element in the DOM, trigger load\n    if (document.querySelector(tagName)) {\n        loadComponent(tagName);\n    }\n}\n\nasync function loadComponent(tagName: string) {\n    if (loaded.has(tagName)) return;\n    loaded.add(tagName);\n\n    const loader = registry.get(tagName);\n    if (!loader) return;\n\n    try {\n        await loader();\n        // The component module should call customElements.define()\n    } catch (error) {\n        console.error(`Failed to lazy load component ${tagName}:`, error);\n        loaded.delete(tagName); // Allow retry?\n    }\n}\n","interface PerformanceMetric {\n    name: string;\n    value: number;\n    timestamp: number;\n}\n\ninterface LayoutShiftEntry extends PerformanceEntry {\n    value: number;\n    hadRecentInput: boolean;\n}\n\ninterface PerformanceEventTiming extends PerformanceEntry {\n    processingStart: number;\n}\n\nclass PerformanceMonitor {\n    private metrics: PerformanceMetric[] = [];\n    private marks: Map<string, number> = new Map();\n\n    constructor() {\n        if (typeof window !== 'undefined' && 'PerformanceObserver' in window) {\n            this.observeWebVitals();\n            this.observeLongTasks();\n        }\n    }\n\n    private observeWebVitals(): void {\n        try {\n            // First Contentful Paint\n            new PerformanceObserver((list) => {\n                for (const entry of list.getEntries()) {\n                    if (entry.name === 'first-contentful-paint') {\n                        this.record('FCP', entry.startTime);\n                    }\n                }\n            }).observe({ entryTypes: ['paint'] });\n\n            // Largest Contentful Paint\n            new PerformanceObserver((list) => {\n                const entries = list.getEntries();\n                const lastEntry = entries[entries.length - 1];\n                this.record('LCP', lastEntry.startTime);\n            }).observe({ entryTypes: ['largest-contentful-paint'] });\n\n            // First Input Delay (via event timing)\n            new PerformanceObserver((list) => {\n                for (const entry of list.getEntries() as PerformanceEventTiming[]) {\n                    if (entry.processingStart) {\n                        const fid = entry.processingStart - entry.startTime;\n                        this.record('FID', fid);\n                    }\n                }\n            }).observe({ entryTypes: ['first-input'] });\n\n            // Cumulative Layout Shift\n            let clsValue = 0;\n            new PerformanceObserver((list) => {\n                for (const entry of list.getEntries() as LayoutShiftEntry[]) {\n                    if (!entry.hadRecentInput) {\n                        clsValue += entry.value;\n                        this.record('CLS', clsValue);\n                    }\n                }\n            }).observe({ entryTypes: ['layout-shift'] });\n        } catch (e) {\n            console.warn('PerformanceObserver not supported or failed to start', e);\n        }\n    }\n\n    private observeLongTasks(): void {\n        try {\n            new PerformanceObserver((list) => {\n                for (const entry of list.getEntries()) {\n                    if (entry.duration > 50) {\n                        this.record('LongTask', entry.duration);\n                    }\n                }\n            }).observe({ entryTypes: ['longtask'] });\n        } catch (e) {\n            // Quietly fail for longtask as it might not be supported\n        }\n    }\n\n    mark(name: string): void {\n        if (typeof performance === 'undefined') return;\n        this.marks.set(name, performance.now());\n    }\n\n    measure(name: string, startMark: string): number {\n        if (typeof performance === 'undefined') return 0;\n\n        const start = this.marks.get(startMark);\n        if (start === undefined) {\n            return 0;\n        }\n\n        const duration = performance.now() - start;\n        this.record(name, duration);\n        return duration;\n    }\n\n    record(name: string, value: number): void {\n        this.metrics.push({\n            name,\n            value,\n            timestamp: Date.now(),\n        });\n\n        // Log significant metrics in development\n        if (import.meta.env.DEV && value > 100) {\n            console.log(`[Perf] ${name}: ${value.toFixed(2)}ms`);\n        }\n    }\n\n    getMetrics(): PerformanceMetric[] {\n        return [...this.metrics];\n    }\n\n    getSummary(): Record<string, { avg: number; max: number; count: number }> {\n        const summary: Record<string, { total: number; max: number; count: number }> = {};\n\n        for (const metric of this.metrics) {\n            if (!summary[metric.name]) {\n                summary[metric.name] = { total: 0, max: 0, count: 0 };\n            }\n            summary[metric.name].total += metric.value;\n            summary[metric.name].max = Math.max(summary[metric.name].max, metric.value);\n            summary[metric.name].count++;\n        }\n\n        return Object.fromEntries(\n            Object.entries(summary).map(([name, data]) => [\n                name,\n                {\n                    avg: data.total / data.count,\n                    max: data.max,\n                    count: data.count,\n                },\n            ])\n        );\n    }\n}\n\nexport const performanceMonitor = new PerformanceMonitor();\n\n// Expose in development\nif (typeof window !== 'undefined' && import.meta.env.DEV) {\n    (window as any).__perfMonitor = performanceMonitor;\n}\n","/**\n * Validation limits for measurement values\n */\nexport const VALIDATION_LIMITS = {\n    heartrate: { min: 0, max: 300 },\n    power: { min: 0, max: 3000 },\n    cadence: { min: 0, max: 300 },\n    speed: { min: 0, max: 150 }, // km/h\n    distance: { min: 0, max: 1000000 }, // meters\n    altitude: { min: -500, max: 9000 }, // meters\n} as const;\n","import { openDB, IDBPDatabase } from 'idb';\n\nexport interface ZoneDefinition {\n    name: string;\n    min: number;\n    max: number;\n    color: string;\n}\n\nexport interface UserSettings {\n    // User profile\n    weight: number; // kg\n    height: number; // cm\n    age: number;\n    gender: 'male' | 'female' | 'other';\n    ftp: number; // Functional Threshold Power\n    maxHeartrate: number;\n    restingHeartrate: number;\n\n    // Display preferences\n    units: 'metric' | 'imperial';\n    dateFormat: 'ISO' | 'US' | 'EU';\n    clockFormat: '12h' | '24h';\n\n    // Calculation settings\n    energyMethod: 'power' | 'heartrate' | 'combined';\n    gapThreshold: number; // seconds before resetting energy calc\n    stalenessThreshold: number; // seconds before data considered stale\n\n    // Power zones (percentage of FTP)\n    powerZones: ZoneDefinition[];\n\n    // Heart rate zones (percentage of max HR)\n    heartrateZones: ZoneDefinition[];\n}\n\nconst DEFAULT_SETTINGS: UserSettings = {\n    weight: 75,\n    height: 175,\n    age: 30,\n    gender: 'other',\n    ftp: 200,\n    maxHeartrate: 190,\n    restingHeartrate: 60,\n\n    units: 'metric',\n    dateFormat: 'ISO',\n    clockFormat: '24h',\n\n    energyMethod: 'combined',\n    gapThreshold: 20,\n    stalenessThreshold: 5,\n\n    powerZones: [\n        { name: 'Recovery', min: 0, max: 55, color: '#808080' },\n        { name: 'Endurance', min: 55, max: 75, color: '#2196f3' },\n        { name: 'Tempo', min: 75, max: 90, color: '#4caf50' },\n        { name: 'Threshold', min: 90, max: 105, color: '#ffeb3b' },\n        { name: 'VO2max', min: 105, max: 120, color: '#ff9800' },\n        { name: 'Anaerobic', min: 120, max: 150, color: '#f44336' },\n        { name: 'Neuromuscular', min: 150, max: 1000, color: '#9c27b0' },\n    ],\n\n    heartrateZones: [\n        { name: 'Recovery', min: 0, max: 60, color: '#808080' },\n        { name: 'Endurance', min: 60, max: 70, color: '#2196f3' },\n        { name: 'Tempo', min: 70, max: 80, color: '#4caf50' },\n        { name: 'Threshold', min: 80, max: 90, color: '#ff9800' },\n        { name: 'VO2max', min: 90, max: 100, color: '#f44336' },\n    ],\n};\n\ntype SettingsListener = (settings: UserSettings) => void;\n\nexport class SettingsStore {\n    private settings: UserSettings = { ...DEFAULT_SETTINGS };\n    private listeners: SettingsListener[] = [];\n    private db: IDBPDatabase | null = null;\n    private initialized = false;\n\n    async initialize(): Promise<void> {\n        if (this.initialized) return;\n\n        // Try-catch block for environments that don't support IndexedDB\n        try {\n            this.db = await openDB('bpt-settings', 1, {\n                upgrade(db) {\n                    db.createObjectStore('settings');\n                },\n            });\n\n            const stored = await this.db.get('settings', 'user');\n            if (stored) {\n                // Merge stored settings with defaults to handle new fields\n                this.settings = { ...DEFAULT_SETTINGS, ...stored };\n            }\n        } catch (e) {\n            console.warn('Settings storage unavailable, using defaults/in-memory:', e);\n        }\n\n        this.initialized = true;\n        this.notifyListeners();\n    }\n\n    get<K extends keyof UserSettings>(key: K): UserSettings[K] {\n        return this.settings[key];\n    }\n\n    getAll(): UserSettings {\n        return { ...this.settings };\n    }\n\n    async set<K extends keyof UserSettings>(key: K, value: UserSettings[K]): Promise<void> {\n        this.settings[key] = value;\n        await this.persist();\n        this.notifyListeners();\n    }\n\n    async setMultiple(updates: Partial<UserSettings>): Promise<void> {\n        this.settings = { ...this.settings, ...updates };\n        await this.persist();\n        this.notifyListeners();\n    }\n\n    async reset(): Promise<void> {\n        this.settings = { ...DEFAULT_SETTINGS };\n        await this.persist();\n        this.notifyListeners();\n    }\n\n    onChange(listener: SettingsListener): () => void {\n        this.listeners.push(listener);\n        // Call immediately with current settings\n        // listener(this.getAll());\n        // Logic: maybe we shouldn't call immediate if they just subscribe?\n        // Let's stick to standard observable pattern where it calls on next change.\n        return () => {\n            const index = this.listeners.indexOf(listener);\n            if (index !== -1) this.listeners.splice(index, 1);\n        };\n    }\n\n    private async persist(): Promise<void> {\n        if (this.db) {\n            try {\n                await this.db.put('settings', this.settings, 'user');\n            } catch (e) {\n                console.error('Failed to save settings:', e);\n            }\n        }\n    }\n\n    private notifyListeners(): void {\n        const settings = this.getAll();\n        for (const listener of this.listeners) {\n            try {\n                listener(settings);\n            } catch (e) {\n                console.error('Settings listener error:', e);\n            }\n        }\n    }\n}\n\nexport const settingsStore = new SettingsStore();\n","export type EventHandler<T = unknown> = (data: T) => void;\n\ninterface EventMap {\n    'power:update': { timestamp: number; value: number; cadence?: number };\n    'heartrate:update': { timestamp: number; value: number };\n    'cadence:update': { timestamp: number; value: number };\n    'speed:update': { timestamp: number; value: number };\n    'gps:update': { timestamp: number; latitude: number; longitude: number; altitude?: number };\n    'distance:update': { timestamp: number; value: number };\n    'sensor:connected': { type: string; name: string };\n    'sensor:disconnected': { type: string; name: string };\n    'workout:start': { timestamp: number };\n    'workout:pause': { timestamp: number };\n    'workout:resume': { timestamp: number };\n    'workout:stop': { timestamp: number };\n    'lap:complete': { number: number; duration: number };\n    'settings:change': { key: string; value: unknown };\n}\n\nclass StateEventBus {\n    private handlers: Map<string, Set<EventHandler>> = new Map();\n\n    on<K extends keyof EventMap>(event: K, handler: EventHandler<EventMap[K]>): () => void {\n        if (!this.handlers.has(event)) {\n            this.handlers.set(event, new Set());\n        }\n\n        this.handlers.get(event)!.add(handler as EventHandler);\n\n        return () => {\n            this.handlers.get(event)?.delete(handler as EventHandler);\n        };\n    }\n\n    emit<K extends keyof EventMap>(event: K, data: EventMap[K]): void {\n        const handlers = this.handlers.get(event);\n        if (!handlers) return;\n\n        for (const handler of handlers) {\n            try {\n                handler(data);\n            } catch (error) {\n                console.error(`Event handler error for ${event}:`, error);\n            }\n        }\n    }\n\n    off<K extends keyof EventMap>(event: K, handler: EventHandler<EventMap[K]>): void {\n        this.handlers.get(event)?.delete(handler as EventHandler);\n    }\n\n    clear(): void {\n        this.handlers.clear();\n    }\n}\n\nexport const stateEventBus = new StateEventBus();\n","import { stateEventBus } from '../EventBus.js';\n\ninterface GPSPoint {\n    latitude: number;\n    longitude: number;\n    timestamp: number;\n}\n\nexport class DistanceCalculator {\n    private lastPoint: GPSPoint | null = null;\n    private totalDistance = 0;\n    private lapDistance = 0;\n\n    constructor() {\n        // Listen to GPS updates instead of being called directly\n        stateEventBus.on('gps:update', (data) => {\n            this.handleGPSUpdate(data);\n        });\n\n        stateEventBus.on('lap:complete', () => {\n            this.lapDistance = 0;\n        });\n\n        stateEventBus.on('workout:start', () => {\n            this.reset();\n        });\n    }\n\n    private handleGPSUpdate(data: { timestamp: number; latitude: number; longitude: number }): void {\n        const point: GPSPoint = {\n            latitude: data.latitude,\n            longitude: data.longitude,\n            timestamp: data.timestamp,\n        };\n\n        if (this.lastPoint) {\n            const distance = this.calculateDistance(this.lastPoint, point);\n\n            // Filter out unrealistic jumps (> 50m in 1 second would be > 180km/h)\n            const timeDelta = (point.timestamp - this.lastPoint.timestamp) / 1000;\n            // Avoid division by zero, though unlikely with timestamps\n            if (timeDelta > 0) {\n                const maxDistance = 50 * timeDelta; // 50m/s max\n\n                if (distance <= maxDistance) {\n                    this.totalDistance += distance;\n                    this.lapDistance += distance;\n\n                    stateEventBus.emit('distance:update', {\n                        timestamp: point.timestamp,\n                        value: this.totalDistance,\n                    });\n                }\n            }\n        }\n\n        this.lastPoint = point;\n    }\n\n    private calculateDistance(p1: GPSPoint, p2: GPSPoint): number {\n        const R = 6371000; // Earth radius in meters\n        const lat1 = (p1.latitude * Math.PI) / 180;\n        const lat2 = (p2.latitude * Math.PI) / 180;\n        const dLat = ((p2.latitude - p1.latitude) * Math.PI) / 180;\n        const dLon = ((p2.longitude - p1.longitude) * Math.PI) / 180;\n\n        const a =\n            Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n            Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\n\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        return R * c;\n    }\n\n    reset(): void {\n        this.lastPoint = null;\n        this.totalDistance = 0;\n        this.lapDistance = 0;\n    }\n\n    setTotalDistance(distance: number): void {\n        this.totalDistance = distance;\n        // We don't necessarily know the last point, so we can't fully restore continuity check\n        // but we can restore the accumulated value.\n    }\n\n    getTotalDistance(): number {\n        return this.totalDistance;\n    }\n\n    getLapDistance(): number {\n        return this.lapDistance;\n    }\n}\n\nexport const distanceCalculator = new DistanceCalculator();\n","/**\n * Calorie calculation utilities\n *\n * Provides methods to estimate energy expenditure from power (preferred)\n * or heart rate (fallback).\n */\n\n/**\n * Calculate calories burned based on mechanical work (Power).\n * Uses the standard conversion where 1 kJ of mechanical work  1 kcal of energy expenditure.\n * This assumes a mechanical efficiency of ~24% (1 kcal = 4.184 kJ).\n *\n * @param powerWatts - Average power in Watts\n * @param durationSeconds - Duration in seconds\n * @returns Energy expenditure in kcal\n */\nexport function calculateCaloriesFromPower(powerWatts: number, durationSeconds: number): number {\n    if (powerWatts <= 0 || durationSeconds <= 0) return 0;\n\n    // Energy (Joules) = Power (Watts) * Time (Seconds)\n    const joules = powerWatts * durationSeconds;\n\n    // Convert to kJ (which is approx equal to kcal due to human efficiency)\n    return joules / 1000;\n}\n\n/**\n * Calculate calories burned based on Heart Rate.\n * Uses a simplified prediction equation (Keytel et al.) with default assumptions\n * for missing demographic data (Male, 30 years old).\n *\n * @param heartRate - Average heart rate in bpm\n * @param weightKg - User weight in kg\n * @param durationSeconds - Duration in seconds\n * @returns Energy expenditure in kcal\n */\nexport function calculateCaloriesFromHeartRate(heartRate: number, weightKg: number, durationSeconds: number): number {\n    if (heartRate <= 0 || weightKg <= 0 || durationSeconds <= 0) return 0;\n\n    // Default parameters if not provided in settings\n    const age = 30; // Default age\n    // Formula for Male: Cal = [(Age x 0.2017) + (Weight x 0.1988) + (HR x 0.6309)  55.0969] x Time / 4.184\n    // Time in minutes\n\n    const minutes = durationSeconds / 60;\n\n    const termAge = age * 0.2017;\n    const termWeight = weightKg * 0.1988;\n    const termHr = heartRate * 0.6309;\n\n    const caloriesPerMinute = (termAge + termWeight + termHr - 55.0969) / 4.184;\n\n    return Math.max(0, caloriesPerMinute * minutes);\n}\n","interface UpdaterConfig {\n    minInterval: number; // Minimum update interval (ms)\n    maxInterval: number; // Maximum update interval (ms)\n    idleInterval: number; // Interval when no changes detected\n    visibilityAware: boolean; // Reduce updates when page not visible\n}\n\nconst DEFAULT_CONFIG: UpdaterConfig = {\n    minInterval: 100,\n    maxInterval: 1000,\n    idleInterval: 2000,\n    visibilityAware: true,\n};\n\nexport class AdaptiveUpdater {\n    private config: UpdaterConfig;\n    private currentInterval: number;\n    private lastDataChange = 0;\n    private updateTimer: ReturnType<typeof setTimeout> | null = null;\n    private isVisible = true;\n    private subscribers: Set<() => void> = new Set();\n    private cleanupVisibilityListener: (() => void) | null = null;\n\n    constructor(config: Partial<UpdaterConfig> = {}) {\n        this.config = { ...DEFAULT_CONFIG, ...config };\n        this.currentInterval = this.config.minInterval;\n\n        if (this.config.visibilityAware && typeof document !== 'undefined') {\n            const handler = this.handleVisibilityChange.bind(this);\n            document.addEventListener('visibilitychange', handler);\n            this.cleanupVisibilityListener = () => document.removeEventListener('visibilitychange', handler);\n        }\n    }\n\n    private handleVisibilityChange(): void {\n        if (typeof document === 'undefined') return;\n        this.isVisible = document.visibilityState === 'visible';\n\n        if (this.isVisible) {\n            // Resume with fast updates\n            this.currentInterval = this.config.minInterval;\n            this.scheduleUpdate();\n        } else {\n            // Slow down when not visible\n            this.currentInterval = this.config.maxInterval;\n        }\n    }\n\n    /**\n     * Notify that data has changed\n     */\n    notifyDataChange(): void {\n        this.lastDataChange = Date.now();\n\n        // Use fast interval when data is changing\n        if (this.currentInterval > this.config.minInterval) {\n            this.currentInterval = this.config.minInterval;\n            this.scheduleUpdate();\n        }\n    }\n\n    /**\n     * Subscribe to updates\n     */\n    subscribe(callback: () => void): () => void {\n        this.subscribers.add(callback);\n\n        // Start updating if first subscriber\n        if (this.subscribers.size === 1) {\n            this.scheduleUpdate();\n        }\n\n        return () => {\n            this.subscribers.delete(callback);\n\n            // Stop updating if no subscribers\n            if (this.subscribers.size === 0 && this.updateTimer) {\n                clearTimeout(this.updateTimer);\n                this.updateTimer = null;\n            }\n        };\n    }\n\n    private scheduleUpdate(): void {\n        if (this.updateTimer) {\n            clearTimeout(this.updateTimer);\n        }\n\n        this.updateTimer = setTimeout(() => {\n            this.update();\n        }, this.currentInterval);\n\n        if (this.updateTimer && typeof this.updateTimer === 'object' && 'unref' in this.updateTimer) {\n            (this.updateTimer as any).unref();\n        }\n    }\n\n    private update(): void {\n        const now = Date.now();\n\n        // Notify subscribers\n        for (const callback of this.subscribers) {\n            try {\n                callback();\n            } catch (e) {\n                console.error('Update callback error:', e);\n            }\n        }\n\n        // Adapt interval based on data activity\n        const timeSinceDataChange = now - this.lastDataChange;\n\n        if (timeSinceDataChange > 5000) {\n            // No data changes for 5s, slow down\n            this.currentInterval = Math.min(this.currentInterval * 1.5, this.config.idleInterval);\n        } else if (timeSinceDataChange < 1000) {\n            // Recent data changes, speed up\n            this.currentInterval = this.config.minInterval;\n        }\n\n        // Slow down if page not visible\n        if (!this.isVisible) {\n            this.currentInterval = this.config.maxInterval;\n        }\n\n        // Schedule next update\n        if (this.subscribers.size > 0) {\n            this.scheduleUpdate();\n        }\n    }\n\n    destroy(): void {\n        if (this.updateTimer) {\n            clearTimeout(this.updateTimer);\n        }\n        this.subscribers.clear();\n        if (this.cleanupVisibilityListener) {\n            this.cleanupVisibilityListener();\n        }\n    }\n}\n\nexport const dataFieldsUpdater = new AdaptiveUpdater({\n    minInterval: 100,\n    maxInterval: 1000,\n    idleInterval: 2000,\n    visibilityAware: true,\n});\n","/**\n * Measurements State Management\n *\n * Central state container for all workout measurement data.\n * Integrates with IndexedDB for persistent storage and crash recovery.\n *\n * @module MeasurementsState\n */\n\nimport type {\n    Measurement,\n    MeasurementsData,\n    MeasurementType,\n    LapMarker,\n    GpsPoint,\n    TreadmillMeasurement,\n} from './types/measurements.js';\nimport { throttledSave, flushPendingSave, clearActiveWorkout, isIndexedDBSupported } from './storage/workoutStorage.js';\nimport { VALIDATION_LIMITS } from './config/constants.js';\n// import { getSettings } from './config/settings.js'; // Keep for legacy until fully migrated?\n// Actually, I should check if I can remove it. But let's import settingsStore first.\nimport { settingsStore, type UserSettings } from './state/SettingsStore.js';\nimport { stateEventBus } from './state/EventBus.js';\nimport { distanceCalculator } from './state/calculators/DistanceCalculator.js';\nimport { calculateCaloriesFromPower, calculateCaloriesFromHeartRate } from './calculations/calories.js';\nimport { dataFieldsUpdater } from './data-fields/AdaptiveUpdater.js';\n\n/**\n * Callback type for state change notifications\n */\nexport type StateChangeCallback = (state: MeasurementsData) => void;\n\n/**\n * State container for workout measurements.\n *\n * Stores heart rate, power, and cadence measurements with timestamps.\n * Includes validation to reject invalid values.\n * Automatically persists to IndexedDB for crash recovery.\n *\n * @example\n * const state = new MeasurementsState();\n * state.addPower({ timestamp: Date.now(), value: 200 });\n * console.log(state.power); // [{ timestamp: ..., value: 200 }]\n */\nexport class MeasurementsState implements MeasurementsData {\n    heartrate: Measurement[] = [];\n    power: Measurement[] = [];\n    cadence: Measurement[] = [];\n    speed: Measurement[] = [];\n    distance: Measurement[] = [];\n    altitude: Measurement[] = [];\n    energy: Measurement[] = [];\n    gps: GpsPoint[] = [];\n    treadmill: TreadmillMeasurement[] = [];\n    treadmillSpeed: Measurement[] = [];\n    laps: LapMarker[] = [];\n\n    private _persistenceEnabled: boolean;\n    private _startTime: number | null = null;\n    private _onChangeCallbacks: StateChangeCallback[] = [];\n\n    // Energy calculation state\n    private _lastEnergyTime: number = 0;\n    private _lastPowerTime: number = 0;\n    private _totalEnergy: number = 0; // accumulated kcal\n\n    constructor(enablePersistence: boolean = true) {\n        this._persistenceEnabled = enablePersistence && isIndexedDBSupported();\n\n        // Subscribe to adaptive updates\n        dataFieldsUpdater.subscribe(() => {\n            this._dispatchUpdates();\n        });\n\n        // Subscribe to settings changes\n        settingsStore.onChange((settings) => {\n            this.onSettingsChange(settings);\n        });\n\n        // Listen for calculated values\n        stateEventBus.on('distance:update', (data) => {\n            if (this._startTime) {\n                // Ensure timestamp is valid relative to workout?\n                // Or just trust the event?\n                this.addDistance({\n                    timestamp: data.timestamp,\n                    value: data.value,\n                });\n            }\n        });\n\n        if (\n            typeof window !== 'undefined' &&\n            typeof window.addEventListener === 'function' &&\n            typeof document !== 'undefined'\n        ) {\n            // Set up page unload handler to save any pending changes\n            window.addEventListener('beforeunload', () => {\n                flushPendingSave();\n            });\n\n            // Also save on visibility change (mobile browsers)\n            document.addEventListener('visibilitychange', () => {\n                if (document.hidden) {\n                    flushPendingSave();\n                }\n            });\n        }\n    }\n\n    /**\n     * Set the workout start time (used for persistence)\n     */\n    setStartTime(time: number | null): void {\n        this._startTime = time;\n    }\n\n    /**\n     * Get the workout start time\n     */\n    getStartTime(): number | null {\n        return this._startTime;\n    }\n\n    /**\n     * Register a callback for state changes\n     */\n    onChange(callback: StateChangeCallback): void {\n        this._onChangeCallbacks.push(callback);\n    }\n\n    /**\n     * Remove a state change callback\n     */\n    offChange(callback: StateChangeCallback): void {\n        const index = this._onChangeCallbacks.indexOf(callback);\n        if (index > -1) {\n            this._onChangeCallbacks.splice(index, 1);\n        }\n    }\n\n    private get userWeight(): number {\n        return settingsStore.get('weight');\n    }\n\n    private get gapThreshold(): number {\n        return settingsStore.get('gapThreshold') * 1000; // Convert to ms\n    }\n\n    private onSettingsChange(_settings: UserSettings): void {\n        // Recalculate or handle changes if needed\n        // For now, getters handle the dynamic values\n    }\n\n    /**\n     * Update energy calculation\n     */\n    private _updateEnergy(timestamp: number, value: number, source: 'power' | 'heartrate'): void {\n        const method = settingsStore.get('energyMethod');\n\n        // Only use configured method\n        if (method === 'power' && source !== 'power') return;\n        if (method === 'heartrate' && source !== 'heartrate') return;\n\n        // If combined, we prefer power, but fall back to HR?\n        // Or \"combined\" usually means use power if available, else HR?\n        // For simplicity and to avoid double counting, let's assume 'combined' means smart switching or both contribute to separate buckets?\n        // The original code handled both.\n        // If source is 'heartrate', but we assume power also exists, we shouldn't double add.\n        // Let's implement a simple priority: Power > Heartrate if combined.\n        // But since this method is called per measurement, we need to know context.\n        // If we recently received power, ignore heartrate energy updates?\n\n        // For now, let's stick to the simpler logic of allowing both if 'combined' is set\n        // BUT preventing double counting is hard without knowing implicit state.\n        // Let's assume the user selects one main method or 'combined' means we simply log both if they come in?\n        // Actually, if we use both, we double count calories.\n        // Let's modify logic: If 'combined', use Power. If Power not available (gap), use HR.\n\n        if (method === 'combined') {\n            if (source === 'heartrate') {\n                // If we have recent power data (within gap threshold), ignore HR energy\n                if (timestamp - this._lastPowerTime < this.gapThreshold) {\n                    return;\n                }\n            } else if (source === 'power') {\n                this._lastPowerTime = timestamp;\n            }\n        }\n\n        // Initialize or reset if gap is too large\n        if (this._lastEnergyTime === 0 || timestamp - this._lastEnergyTime > this.gapThreshold) {\n            this._lastEnergyTime = timestamp;\n            return;\n        }\n\n        const dt = (timestamp - this._lastEnergyTime) / 1000;\n        if (dt <= 0) return;\n\n        let kcal = 0;\n        if (source === 'power') {\n            kcal = calculateCaloriesFromPower(value, dt);\n        } else {\n            kcal = calculateCaloriesFromHeartRate(value, this.userWeight, dt);\n        }\n\n        if (kcal > 0) {\n            this._totalEnergy += kcal;\n            // Store cumulative energy point\n            this.energy.push({\n                timestamp,\n                value: this._totalEnergy,\n            });\n        }\n\n        this._lastEnergyTime = timestamp;\n    }\n\n    /**\n     * Dispatch updates to listeners (throttled by AdaptiveUpdater)\n     */\n    private _dispatchUpdates(): void {\n        for (const callback of this._onChangeCallbacks) {\n            try {\n                callback(this);\n            } catch (e) {\n                console.error('State change callback error:', e);\n            }\n        }\n    }\n\n    /**\n     * Notify listeners and persist state\n     */\n    private _notifyChange(): void {\n        // Notify adaptive updater\n        dataFieldsUpdater.notifyDataChange();\n\n        // Persist to IndexedDB\n        if (this._persistenceEnabled) {\n            throttledSave(this.toJSON(), this._startTime);\n        }\n    }\n\n    /**\n     * Add a heart rate measurement\n     *\n     * @param entry - Measurement with timestamp and value\n     * @throws Logs warning if value is outside valid range (0-300 bpm)\n     */\n    addHeartrate(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.heartrate;\n        if (entry.value <= min || entry.value >= max) {\n            console.warn(`Invalid heartrate value: ${entry.value}`);\n            return;\n        }\n        this.heartrate.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n\n        // Calculate energy if power is missing/stale (>5s)\n        if (this._lastPowerTime === 0 || entry.timestamp - this._lastPowerTime > 5000) {\n            this._updateEnergy(entry.timestamp, entry.value, 'heartrate');\n        }\n\n        this._notifyChange();\n    }\n\n    /**\n     * Add a power measurement\n     *\n     * @param entry - Measurement with timestamp and value\n     * @throws Logs warning if value is outside valid range (0-3000 watts)\n     */\n    addPower(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.power;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid power value: ${entry.value}`);\n            return;\n        }\n        this.power.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n\n        this._lastPowerTime = entry.timestamp;\n        this._updateEnergy(entry.timestamp, entry.value, 'power');\n\n        this._notifyChange();\n    }\n\n    /**\n     * Add a cadence measurement\n     *\n     * @param entry - Measurement with timestamp and value\n     * @throws Logs warning if value is outside valid range (0-300 rpm)\n     */\n    addCadence(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.cadence;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid cadence value: ${entry.value}`);\n            return;\n        }\n        this.cadence.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n        this._notifyChange();\n    }\n\n    addSpeed(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.speed;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid speed value: ${entry.value}`);\n            return;\n        }\n        this.speed.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n        this._notifyChange();\n    }\n\n    addDistance(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.distance;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid distance value: ${entry.value}`);\n            return;\n        }\n        this.distance.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n        this._notifyChange();\n    }\n\n    addAltitude(entry: Measurement): void {\n        const { min, max } = VALIDATION_LIMITS.altitude;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid altitude value: ${entry.value}`);\n            return;\n        }\n        this.altitude.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n        this._notifyChange();\n    }\n\n    addTreadmillSpeed(entry: Measurement): void {\n        // Use same limits as speed for now\n        const { min, max } = VALIDATION_LIMITS.speed;\n        if (entry.value < min || entry.value >= max) {\n            console.warn(`Invalid treadmill speed value: ${entry.value}`);\n            return;\n        }\n        this.treadmillSpeed.push({\n            timestamp: entry.timestamp,\n            value: entry.value,\n        });\n        this._notifyChange();\n    }\n\n    addGps(point: GpsPoint): void {\n        this.gps.push(point);\n\n        // Emit for calculators (Distance calculations etc)\n        stateEventBus.emit('gps:update', {\n            timestamp: point.timestamp,\n            latitude: point.lat,\n            longitude: point.lon,\n            altitude: point.altitude !== null ? point.altitude : undefined,\n        });\n\n        // Add speed if available (convert m/s to km/h)\n        if (point.speed !== null) {\n            this.addSpeed({\n                timestamp: point.timestamp,\n                value: point.speed * 3.6,\n            });\n        }\n\n        // Add altitude if available\n        if (point.altitude !== null) {\n            this.addAltitude({\n                timestamp: point.timestamp,\n                value: point.altitude,\n            });\n        }\n\n        this._notifyChange();\n    }\n\n    /**\n     * Add a measurement of any type\n     *\n     * @param type - The measurement type\n     * @param entry - Measurement with timestamp and value\n     * @throws Error if type is unknown\n     */\n    add(type: MeasurementType, entry: Measurement): void {\n        switch (type) {\n            case 'heartrate':\n                this.addHeartrate(entry);\n                break;\n            case 'power':\n                this.addPower(entry);\n                break;\n            case 'cadence':\n                this.addCadence(entry);\n                break;\n            case 'speed':\n                this.addSpeed(entry);\n                break;\n            case 'distance':\n                this.addDistance(entry);\n                break;\n            case 'altitude':\n                this.addAltitude(entry);\n                break;\n            case 'treadmillSpeed':\n                this.addTreadmillSpeed(entry);\n                break;\n            default:\n                throw new Error(`Unknown measurement type: ${type}`);\n        }\n    }\n\n    /**\n     * Clear all measurements\n     * @param clearPersisted - Also clear persisted data from IndexedDB\n     */\n    async clear(clearPersisted: boolean = true): Promise<void> {\n        this.heartrate = [];\n        this.power = [];\n        this.cadence = [];\n        this.speed = [];\n        this.distance = [];\n        this.altitude = [];\n        this.treadmillSpeed = [];\n        this.laps = [];\n        this._startTime = null;\n\n        if (clearPersisted && this._persistenceEnabled) {\n            await clearActiveWorkout();\n        }\n\n        this._notifyChange();\n    }\n\n    /**\n     * Add a lap marker\n     *\n     * @param startTime - The workout start time for calculating elapsed time\n     * @returns The new lap marker\n     */\n    addLap(startTime: number | null): LapMarker {\n        const timestamp = Date.now();\n        const lapNumber = this.laps.length + 1;\n        const lap: LapMarker = {\n            timestamp,\n            number: lapNumber,\n            elapsedMs: startTime ? timestamp - startTime : undefined,\n        };\n        this.laps.push(lap);\n        this._notifyChange();\n        return lap;\n    }\n\n    /**\n     * Get the current lap count\n     */\n    getLapCount(): number {\n        return this.laps.length;\n    }\n\n    /**\n     * Get all measurements as a plain object\n     */\n    toJSON(): MeasurementsData {\n        return {\n            heartrate: [...this.heartrate],\n            power: [...this.power],\n            cadence: [...this.cadence],\n            speed: [...this.speed],\n            distance: [...this.distance],\n            altitude: [...this.altitude],\n            treadmillSpeed: [...this.treadmillSpeed],\n            gps: [...this.gps],\n            laps: [...this.laps],\n        };\n    }\n\n    /**\n     * Restore state from persisted data\n     * @param data - The measurement data to restore\n     * @param startTime - The workout start time\n     */\n    restore(data: MeasurementsData, startTime: number | null): void {\n        this.heartrate = [...(data.heartrate || [])];\n        this.power = [...(data.power || [])];\n        this.cadence = [...(data.cadence || [])];\n        this.speed = [...(data.speed || [])];\n        this.distance = [...(data.distance || [])];\n        this.altitude = [...(data.altitude || [])];\n        this.treadmillSpeed = [...(data.treadmillSpeed || [])];\n        this.laps = [...(data.laps || [])];\n        this._startTime = startTime;\n\n        // Restore distance calculator state\n        if (this.distance.length > 0) {\n            distanceCalculator.setTotalDistance(this.distance[this.distance.length - 1].value);\n        } else {\n            distanceCalculator.setTotalDistance(0);\n        }\n\n        // Don't persist on restore - data is already persisted\n        for (const callback of this._onChangeCallbacks) {\n            try {\n                callback(this);\n            } catch (e) {\n                console.error('State change callback error:', e);\n            }\n        }\n    }\n\n    /**\n     * Enable or disable persistence\n     */\n    setPersistenceEnabled(enabled: boolean): void {\n        this._persistenceEnabled = enabled && isIndexedDBSupported();\n    }\n\n    /**\n     * Check if any measurements have been recorded\n     */\n    hasData(): boolean {\n        return this.heartrate.length > 0 || this.power.length > 0 || this.cadence.length > 0;\n    }\n\n    /**\n     * Get the count of measurements for each type\n     */\n    getCounts(): Record<MeasurementType, number> {\n        return {\n            heartrate: this.heartrate.length,\n            power: this.power.length,\n            cadence: this.cadence.length,\n            speed: this.speed.length,\n            distance: this.distance.length,\n            altitude: this.altitude.length,\n            gps: this.gps.length,\n            treadmillSpeed: this.treadmillSpeed.length,\n            energy: this.energy.length,\n        };\n    }\n\n    /**\n     * Add a treadmill measurement\n     *\n     * @param entry - Treadmill measurement (speed/incline)\n     */\n    addTreadmillData(entry: TreadmillMeasurement): void {\n        this.treadmill.push(entry);\n\n        if (entry.speed != null) {\n            const measurement = {\n                timestamp: entry.timestamp,\n                value: entry.speed,\n            };\n\n            // Add to specific treadmill Speed metric\n            this.addTreadmillSpeed(measurement);\n\n            // Speed from treadmill is already in km/h\n            this.addSpeed(measurement);\n        }\n\n        // Note: We don't explicitly notifyChange here if addSpeed/addTreadmillSpeed was called,\n        // because they call it. But if only incline changed, we must notify.\n        if (entry.speed == null) {\n            this._notifyChange();\n        }\n    }\n}\n","import { MeasurementsState } from '../measurements-state.js';\nimport type { ConnectionsState } from '../types/connections.js';\nimport { settingsStore, type SettingsStore } from './SettingsStore.js';\nimport type { TimeState } from '../getInitState.js';\n\nexport interface AppState {\n    measurementsState: MeasurementsState;\n    connectionsState: ConnectionsState;\n    timeState: TimeState;\n    settings: SettingsStore;\n}\n\nlet appState: AppState | null = null;\n\nexport function initializeState(): AppState {\n    if (appState) {\n        console.warn('State already initialized');\n        return appState;\n    }\n\n    appState = {\n        measurementsState: new MeasurementsState(),\n        connectionsState: {\n            power: { isConnected: false, disconnect: null },\n            heartrate: { isConnected: false, disconnect: null },\n            cadence: { isConnected: false, disconnect: null },\n            speed: { isConnected: false, disconnect: null },\n            gps: { isConnected: false, disconnect: null },\n            treadmill: { isConnected: false, disconnect: null },\n        },\n        timeState: {\n            running: false,\n            startTime: null,\n            endTime: null,\n        },\n        // In the plan it says 'typeof settingsStore' but that refers to the class generally in TS if used as type,\n        // here we want the instance type. \"typeof settingsStore\" matches the instance variable type.\n        // Actually, let's just use the instance directly.\n        settings: settingsStore,\n    };\n\n    // Initialize settings\n    settingsStore.initialize();\n\n    return appState;\n}\n\nexport function getState(): AppState {\n    if (!appState) {\n        throw new Error('State not initialized. Call initializeState() first.');\n    }\n    return appState;\n}\n\n// For testing only\nexport function resetState(): void {\n    appState = null;\n}\n\n// Development/testing helpers (only available in dev mode)\nif (import.meta.env.DEV) {\n    (window as any).__getAppState = getState;\n    (window as any).__resetState = resetState;\n}\n","/**\n * Test exposure utilities\n *\n * Exposes application state for end-to-end testing.\n *\n * @module exposeVariablesDuringTest\n */\n\nimport type { MeasurementsState } from './measurements-state.js';\nimport type { ConnectionsState } from './types/connections.js';\n\n/**\n * Extended window interface for test variables\n */\ndeclare global {\n    interface Window {\n        bike?: MeasurementsState;\n        connectionsState?: ConnectionsState;\n    }\n}\n\n/**\n * Parameters for test exposure\n */\ninterface ExposeTestVariablesParams {\n    measurementsState: MeasurementsState;\n    connectionsState: ConnectionsState;\n}\n\n/**\n * Exposes application state variables on the window object for E2E testing.\n *\n * This allows Playwright and other testing frameworks to access and verify\n * application state during tests.\n *\n * @param params - Object containing state objects to expose\n *\n * @example\n * // In test:\n * const state = await page.evaluate(() => window.bike);\n */\nexport function exposeVariablesDuringTest({ measurementsState, connectionsState }: ExposeTestVariablesParams): void {\n    // Always expose in non-production builds for testing purposes\n    if (typeof window !== 'undefined') {\n        window.bike = measurementsState;\n        window.connectionsState = connectionsState;\n    }\n}\n","import { registerPlugin } from '@capacitor/core';\nconst App = registerPlugin('App', {\n    web: () => import('./web').then((m) => new m.AppWeb()),\n});\nexport * from './definitions';\nexport { App };\n//# sourceMappingURL=index.js.map","import { View } from './View.js';\nimport { IRouter } from './types.js';\nimport { Capacitor } from '@capacitor/core';\nimport { App } from '@capacitor/app';\n\ntype ViewLoader = () => Promise<View>;\n\ninterface Route {\n    path: string;\n    viewId: string;\n}\n\nexport class Router implements IRouter {\n    private views: Map<string, View> = new Map();\n    private lazyViews: Map<string, ViewLoader> = new Map();\n    private routes: Route[] = [];\n    private currentViewId: string | null = null;\n    private container: HTMLElement;\n    private isNative: boolean;\n\n    constructor(container: HTMLElement) {\n        this.container = container;\n        this.isNative = Capacitor.isNativePlatform();\n\n        // Handle browser back/forward buttons and hash changes\n        window.addEventListener('popstate', () => {\n            this.handleLocationChange();\n        });\n\n        // Also listen for hash changes (for Capacitor/native)\n        if (this.isNative) {\n            window.addEventListener('hashchange', () => {\n                this.handleLocationChange();\n            });\n        }\n\n        // Hardware back button handling for Capacitor\n        if (this.isNative) {\n            App.addListener('backButton', ({ canGoBack }) => {\n                if (canGoBack) {\n                    window.history.back();\n                } else {\n                    App.exitApp();\n                }\n            });\n        }\n    }\n\n    /**\n     * Register a view with the router.\n     */\n    public registerView(view: View): void {\n        this.views.set(view.id, view);\n\n        // Find existing container or create one\n        let viewContainer = document.getElementById(`page-${view.id}`);\n\n        if (!viewContainer) {\n            viewContainer = document.createElement('div');\n            viewContainer.id = `page-${view.id}`;\n            viewContainer.className = 'page-view';\n            viewContainer.style.display = 'none'; // Hidden by default\n            this.container.appendChild(viewContainer);\n        }\n\n        // Initialize the view with its container\n        view.init(viewContainer);\n    }\n\n    /**\n     * Register a lazy view loader.\n     */\n    public registerLazyView(viewId: string, loader: ViewLoader): void {\n        this.lazyViews.set(viewId, loader);\n    }\n\n    /**\n     * Add a route mapping to a view.\n     */\n    public addRoute(path: string, viewId: string): void {\n        this.routes.push({ path, viewId });\n    }\n\n    /**\n     * Navigate to a specific path.\n     * Uses hash-based routing on native platforms for better compatibility.\n     */\n    public navigate(path: string, replace = false): void {\n        if (this.isNative) {\n            // Use hash-based routing on Capacitor/native for file:// compatibility\n            if (replace) {\n                window.location.replace('#' + path);\n            } else {\n                window.location.hash = path;\n            }\n        } else {\n            // Use History API for web browsers\n            if (replace) {\n                window.history.replaceState({}, '', path);\n            } else {\n                window.history.pushState({}, '', path);\n            }\n            this.handleLocationChange();\n        }\n    }\n\n    /**\n     * Start the router and load the initial view.\n     */\n    public start(): void {\n        if (this.isNative) {\n            // On native, start with initial hash check\n            if (!window.location.hash) {\n                // If no hash, default to root\n                window.location.hash = '/';\n            }\n        }\n        this.handleLocationChange();\n    }\n\n    /**\n     * Go back in history.\n     */\n    public back(): void {\n        window.history.back();\n    }\n\n    /**\n     * Handle location changes (popstate or navigate).\n     */\n    private async handleLocationChange(): Promise<void> {\n        let path: string;\n\n        if (this.isNative) {\n            // On native platforms, use hash-based routing\n            // Hash format: #/path -> extract '/path'\n            const hash = window.location.hash;\n            path = hash ? hash.slice(1) : '/';\n            // Normalize empty hash to root\n            if (!path || path === '') {\n                path = '/';\n            }\n        } else {\n            // On web, use pathname\n            path = window.location.pathname;\n            // Normalize /index.html to /\n            if (path.endsWith('/index.html') || path.endsWith('.html')) {\n                path = '/';\n            }\n        }\n\n        // Simple matching logic\n        let matchedRoute = this.routes.find((r) => r.path === path);\n\n        // Fallback to strict root or first registered route if no match\n        // Useful for initial load if path is just \"/\" or empty\n        if (!matchedRoute) {\n            matchedRoute = this.routes.find((r) => r.path === '/') || this.routes[0];\n        }\n\n        if (matchedRoute) {\n            await this.switchView(matchedRoute.viewId);\n        }\n    }\n\n    /**\n     * Switch the visible view.\n     */\n    private async switchView(viewId: string): Promise<void> {\n        if (this.currentViewId === viewId) return;\n\n        // Check if loading is needed\n        if (!this.views.has(viewId)) {\n            const loader = this.lazyViews.get(viewId);\n            if (loader) {\n                try {\n                    const view = await loader();\n                    this.registerView(view);\n                } catch (error) {\n                    console.error(`Failed to load view for ${viewId}:`, error);\n                    return;\n                }\n            } else {\n                console.warn(`View ${viewId} not registered.`);\n                return;\n            }\n        }\n\n        // Leave current view\n        if (this.currentViewId) {\n            const currentView = this.views.get(this.currentViewId);\n            if (currentView) {\n                currentView.onLeave();\n                const el = document.getElementById(`page-${this.currentViewId}`);\n                if (el) el.style.display = 'none';\n            }\n        }\n\n        // Enter new view\n        const newView = this.views.get(viewId);\n        if (newView) {\n            const el = document.getElementById(`page-${viewId}`);\n            if (el) el.style.display = '';\n            newView.onEnter();\n            this.currentViewId = viewId;\n\n            // Dispatch event for UI updates (e.g. Nav Bar)\n            window.dispatchEvent(new CustomEvent('route-changed', { detail: { viewId } }));\n        }\n    }\n}\n","import { View } from '../router/View.js';\n\nexport class DashboardView implements View {\n    public id = 'dashboard';\n\n    public init(_container: HTMLElement): void {\n        console.log('Dashboard View initialized');\n    }\n\n    public onEnter(): void {\n        console.log('Entered Dashboard View');\n    }\n\n    public onLeave(): void {\n        console.log('Left Dashboard View');\n    }\n}\n","/**\n * View IDs for application navigation\n */\nexport enum ViewId {\n    Dashboard = 'dashboard',\n    History = 'history',\n    Workouts = 'workouts',\n    Settings = 'settings',\n    Plans = 'plans',\n    Debug = 'debug',\n}\n","/**\n * Navigation Bar Component\n *\n * Handles the bottom navigation bar.\n */\n\nimport { IRouter } from '../router/types.js';\nimport { ViewId } from '../router/view-ids.js';\n\nexport class NavBar {\n    private container: HTMLElement;\n    private router: IRouter;\n\n    constructor(router: IRouter) {\n        this.router = router;\n        this.container = document.createElement('nav');\n        this.container.id = 'bottom-nav';\n        this.container.className = 'bottom-nav';\n\n        // Mobile-first styles should be in CSS, but injecting basic structure here\n        this.render();\n        document.body.appendChild(this.container);\n\n        // Listen for route changes\n        window.addEventListener('route-changed', (e: Event) => {\n            const detail = (e as CustomEvent).detail;\n            this.setActive(detail.viewId);\n        });\n    }\n\n    private render(): void {\n        this.container.innerHTML = `\n            <button class=\"nav-item active\" data-target=\"${ViewId.Dashboard}\" data-testid=\"nav-dashboard\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">Dashboard</span>\n            </button>\n            <button class=\"nav-item\" data-target=\"${ViewId.History}\" data-testid=\"nav-history\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">History</span>\n            </button>\n            <button class=\"nav-item\" data-target=\"${ViewId.Workouts}\" data-testid=\"nav-workouts\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">Workouts</span>\n            </button>\n            <button class=\"nav-item\" data-target=\"${ViewId.Plans}\" data-testid=\"nav-plans\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">Plans</span>\n            </button>\n            <button class=\"nav-item\" data-target=\"${ViewId.Settings}\" data-testid=\"nav-settings\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">Settings</span>\n            </button>\n            <button class=\"nav-item\" data-target=\"${ViewId.Debug}\" data-testid=\"nav-debug\">\n                <span class=\"nav-icon\"></span>\n                <span class=\"nav-label\">Debug</span>\n            </button>\n        `;\n\n        this.container.querySelectorAll('.nav-item').forEach((btn) => {\n            btn.addEventListener('click', () => {\n                const target = (btn as HTMLElement).dataset.target;\n                if (target === ViewId.Dashboard) {\n                    this.router.navigate('/');\n                } else if (target) {\n                    this.router.navigate('/' + target);\n                }\n            });\n        });\n    }\n\n    public setActive(viewId: string): void {\n        this.container.querySelectorAll('.nav-item').forEach((btn) => {\n            const target = (btn as HTMLElement).dataset.target;\n            if (target === viewId) {\n                btn.classList.add('active');\n                btn.setAttribute('aria-current', 'page');\n            } else {\n                btn.classList.remove('active');\n                btn.removeAttribute('aria-current');\n            }\n        });\n    }\n}\n","/**\n * Safely select a DOM element by ID.\n * Throws a specific error if the element is not found,\n * allowing for easier debugging than standard null pointer exceptions.\n *\n * @param id The ID of the element to select\n * @returns The selected element\n * @throws Error if element not found\n */\nexport function selectElement<T extends HTMLElement>(id: string): T {\n    const element = document.getElementById(id);\n    if (!element) {\n        throw new Error(`Critical DOM element missing: #${id}. Ensure index.html is correct.`);\n    }\n    return element as T;\n}\n","import { Router } from '../router/Router.js';\nimport { DashboardView } from '../views/DashboardView.js';\nimport { NavBar } from '../components/NavBar.js';\nimport { ViewId } from '../router/view-ids.js';\nimport { selectElement } from '../utils/dom.js';\n\n/**\n * Initializes the Router, registers Views, and sets up the Navigation Bar.\n */\nexport function setupRouter(): Router {\n    const router = new Router(selectElement('mainContent'));\n\n    const dashboardView = new DashboardView();\n    router.registerView(dashboardView);\n\n    // Register Lazy Views\n    router.registerLazyView(ViewId.History, () => import('../views/HistoryView.js').then((m) => new m.HistoryView()));\n    router.registerLazyView(ViewId.Workouts, () =>\n        import('../views/WorkoutsView.js').then((m) => new m.WorkoutsView())\n    );\n    router.registerLazyView(ViewId.Settings, () =>\n        import('../views/SettingsView.js').then((m) => new m.SettingsView())\n    );\n    router.registerLazyView(ViewId.Plans, () => import('../views/PlansView.js').then((m) => new m.PlansView()));\n    router.registerLazyView(ViewId.Debug, () => import('../views/DebugView.js').then((m) => new m.DebugView()));\n\n    router.addRoute('/', ViewId.Dashboard);\n    router.addRoute('/history', ViewId.History);\n    router.addRoute('/workouts', ViewId.Workouts);\n    router.addRoute('/plans', ViewId.Plans);\n    router.addRoute('/settings', ViewId.Settings);\n    router.addRoute('/debug', ViewId.Debug);\n\n    // Initialize Navigation Bar\n    new NavBar(router);\n\n    // Wire up Sidebar Settings Button (for mobile/hamburger menu)\n    const settingsButton = document.getElementById('settingsButton');\n    if (settingsButton) {\n        settingsButton.addEventListener('click', () => {\n            router.navigate('/settings');\n            // Close the details menu if open\n            const details = document.querySelector('nav details') as HTMLDetailsElement;\n            if (details) {\n                details.open = false;\n            }\n        });\n    }\n\n    // Wire up Sidebar Workouts Button\n    const workoutsButton = document.getElementById('workoutsButton');\n    if (workoutsButton) {\n        workoutsButton.addEventListener('click', () => {\n            router.navigate('/workouts');\n            const details = document.querySelector('nav details') as HTMLDetailsElement;\n            if (details) {\n                details.open = false;\n            }\n        });\n    }\n\n    // Wire up Sidebar Plans Button\n    const plansButton = document.getElementById('plansButton');\n    if (plansButton) {\n        plansButton.addEventListener('click', () => {\n            router.navigate('/plans');\n            const details = document.querySelector('nav details') as HTMLDetailsElement;\n            if (details) {\n                details.open = false;\n            }\n        });\n    }\n\n    return router;\n}\n","/**\n * Time formatting utilities\n *\n * @module getTimestring\n */\n\n/**\n * Converts milliseconds to a formatted time string (HH:MM:SS)\n *\n * @param milliseconds - Time duration in milliseconds\n * @returns Formatted time string in HH:MM:SS format\n *\n * @example\n * getTimestring(3661000) // \"01:01:01\"\n * getTimestring(0)       // \"00:00:00\"\n */\nexport const getTimestring = (milliseconds: number): string => {\n    const totalSeconds = Math.floor(milliseconds / 1000);\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = totalSeconds % 60;\n    return (\n        `${hours.toString().padStart(2, '0')}:` +\n        `${minutes.toString().padStart(2, '0')}:` +\n        `${seconds.toString().padStart(2, '0')}`\n    );\n};\n","/**\n * Accessibility utilities and keyboard navigation\n *\n * Implements keyboard shortcuts and screen reader announcements.\n *\n * @module accessibility\n */\n\n/**\n * Announce a message to screen readers\n *\n * Uses an aria-live region to announce status changes.\n *\n * @param message - The message to announce\n * @param priority - 'polite' for non-urgent, 'assertive' for urgent\n */\nexport function announce(message: string, priority: 'polite' | 'assertive' = 'polite'): void {\n    const announcer = document.getElementById('srAnnouncements');\n    if (announcer) {\n        announcer.setAttribute('aria-live', priority);\n        announcer.textContent = message;\n\n        // Clear after announcement to allow repeated messages\n        setTimeout(() => {\n            announcer.textContent = '';\n        }, 1000);\n    }\n}\n\n/**\n * Keyboard shortcut definitions\n */\ninterface KeyboardShortcut {\n    key: string;\n    description: string;\n    action: () => void;\n    ctrl?: boolean;\n    shift?: boolean;\n    alt?: boolean;\n}\n\nconst shortcuts: KeyboardShortcut[] = [];\n\n/**\n * Register a keyboard shortcut\n *\n * @param shortcut - The shortcut definition\n */\nexport function registerShortcut(shortcut: KeyboardShortcut): void {\n    shortcuts.push(shortcut);\n}\n\n/**\n * Handle keyboard events for shortcuts\n */\nfunction handleKeydown(event: KeyboardEvent): void {\n    // Don't trigger shortcuts when typing in inputs\n    const target = event.target as HTMLElement;\n    if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {\n        // Allow Escape in inputs to blur\n        if (event.key === 'Escape') {\n            target.blur();\n        }\n        return;\n    }\n\n    for (const shortcut of shortcuts) {\n        const keyMatch = event.key.toLowerCase() === shortcut.key.toLowerCase();\n        const ctrlMatch = shortcut.ctrl ? event.ctrlKey || event.metaKey : !event.ctrlKey && !event.metaKey;\n        const shiftMatch = shortcut.shift ? event.shiftKey : !event.shiftKey;\n        const altMatch = shortcut.alt ? event.altKey : !event.altKey;\n\n        if (keyMatch && ctrlMatch && shiftMatch && altMatch) {\n            event.preventDefault();\n            shortcut.action();\n            return;\n        }\n    }\n}\n\n/**\n * Initialize keyboard navigation\n *\n * Sets up global keyboard shortcuts:\n * - Space: Start/pause/resume recording (context-aware)\n * - Escape: Close modal/menu\n * - M: Toggle menu\n * - S: Open settings\n * - H: Open workout history\n * - L: Mark lap\n * - ?: Show keyboard shortcuts\n */\nexport function initKeyboardNavigation(): void {\n    // Space - Context-aware workout control\n    registerShortcut({\n        key: ' ',\n        description: 'Start/pause/resume workout (context-aware)',\n        action: () => {\n            // Garmin-style: Space toggles between recording and paused\n            const startButton = document.getElementById('startButton') as HTMLButtonElement | null;\n            const pauseButton = document.getElementById('pauseButton') as HTMLButtonElement | null;\n            const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n\n            // Click whichever button is currently visible\n            if (startButton && startButton.style.display !== 'none') {\n                startButton.click();\n            } else if (pauseButton && pauseButton.style.display !== 'none') {\n                pauseButton.click();\n            } else if (resumeButton && resumeButton.style.display !== 'none') {\n                resumeButton.click();\n            }\n        },\n    });\n\n    // Escape - Close modal/menu\n    registerShortcut({\n        key: 'Escape',\n        description: 'Close modal or menu',\n        action: () => {\n            // Close any open modal\n            const modals = document.querySelectorAll<HTMLElement>(\n                '.stream-modal[style*=\"display: block\"], .stream-modal:not([style*=\"display: none\"])'\n            );\n            for (const modal of modals) {\n                if (modal.style.display !== 'none') {\n                    const closeBtn = modal.querySelector<HTMLButtonElement>('.close-button');\n                    if (closeBtn) {\n                        closeBtn.click();\n                        announce('Dialog closed');\n                        return;\n                    }\n                }\n            }\n\n            // Close menu if open\n            const details = document.querySelector('details[open]') as HTMLDetailsElement | null;\n            if (details) {\n                details.removeAttribute('open');\n                announce('Menu closed');\n            }\n        },\n    });\n\n    // M - Toggle menu\n    registerShortcut({\n        key: 'm',\n        description: 'Toggle menu',\n        action: () => {\n            const details = document.querySelector('header details') as HTMLDetailsElement | null;\n            if (details) {\n                const isOpen = details.hasAttribute('open');\n                if (isOpen) {\n                    details.removeAttribute('open');\n                    announce('Menu closed');\n                } else {\n                    details.setAttribute('open', '');\n                    announce('Menu opened');\n                    // Focus first menu item\n                    const firstButton = details.querySelector<HTMLButtonElement>('#controls button');\n                    if (firstButton) {\n                        firstButton.focus();\n                    }\n                }\n            }\n        },\n    });\n\n    // S - Open settings\n    registerShortcut({\n        key: 's',\n        description: 'Open settings',\n        action: () => {\n            const settingsBtn = document.getElementById('settingsButton');\n            if (settingsBtn) {\n                settingsBtn.click();\n                announce('Settings opened');\n            }\n        },\n    });\n\n    // H - Open workout history\n    registerShortcut({\n        key: 'h',\n        description: 'Open workout history',\n        action: () => {\n            const router = window.router;\n            if (router) {\n                router.navigate('/history');\n                announce('Workout history opened');\n            } else {\n                const historyBtn = document.getElementById('workoutHistoryButton');\n                if (historyBtn) {\n                    historyBtn.click();\n                    announce('Workout history opened');\n                }\n            }\n        },\n    });\n\n    // E - Export data\n    registerShortcut({\n        key: 'e',\n        description: 'Export workout data',\n        action: () => {\n            const exportBtn = document.getElementById('exportData');\n            if (exportBtn) {\n                exportBtn.click();\n            }\n        },\n    });\n\n    // L - Mark lap\n    registerShortcut({\n        key: 'l',\n        description: 'Mark lap',\n        action: () => {\n            const lapBtn = document.getElementById('lapButton');\n            if (lapBtn) {\n                lapBtn.click();\n            }\n        },\n    });\n\n    // Add event listener\n    document.addEventListener('keydown', handleKeydown);\n\n    // Update summary element to indicate keyboard accessibility\n    const summary = document.querySelector('header summary');\n    if (summary) {\n        summary.setAttribute('aria-keyshortcuts', 'M');\n    }\n\n    console.log('Keyboard navigation initialized');\n}\n\n/**\n * Trap focus within a modal dialog\n *\n * @param modal - The modal element\n */\nexport function trapFocus(modal: HTMLElement): void {\n    const focusableElements = modal.querySelectorAll<HTMLElement>(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n    );\n\n    if (focusableElements.length === 0) return;\n\n    const firstElement = focusableElements[0];\n    const lastElement = focusableElements[focusableElements.length - 1];\n\n    // Focus first element\n    firstElement.focus();\n\n    modal.addEventListener('keydown', (event) => {\n        if (event.key !== 'Tab') return;\n\n        if (event.shiftKey) {\n            // Shift + Tab\n            if (document.activeElement === firstElement) {\n                event.preventDefault();\n                lastElement.focus();\n            }\n        } else {\n            // Tab\n            if (document.activeElement === lastElement) {\n                event.preventDefault();\n                firstElement.focus();\n            }\n        }\n    });\n}\n\n/**\n * Update workout controls accessibility state\n *\n * @param state - The current workout state: 'idle', 'recording', or 'paused'\n */\nexport function updateWorkoutControlsAccessibility(state: 'idle' | 'recording' | 'paused'): void {\n    const startButton = document.getElementById('startButton');\n    const pauseButton = document.getElementById('pauseButton');\n    const resumeButton = document.getElementById('resumeButton');\n    const stopButton = document.getElementById('stopButton');\n\n    // Update ARIA labels based on state\n    if (startButton) {\n        startButton.setAttribute('aria-label', 'Start workout');\n    }\n    if (pauseButton) {\n        pauseButton.setAttribute('aria-label', 'Pause workout');\n    }\n    if (resumeButton) {\n        resumeButton.setAttribute('aria-label', 'Resume workout');\n    }\n    if (stopButton) {\n        stopButton.setAttribute('aria-label', 'Stop and save workout');\n    }\n\n    // Update workout controls container with current state\n    const controlsContainer = document.getElementById('workoutControls');\n    if (controlsContainer) {\n        controlsContainer.setAttribute('data-workout-state', state);\n    }\n}\n\n/**\n * Update start/stop button accessibility state\n * @deprecated Use updateWorkoutControlsAccessibility instead\n * @param isRunning - Whether the workout is running\n */\nexport function updateStartStopAccessibility(isRunning: boolean): void {\n    // Backward compatibility - map to new function\n    updateWorkoutControlsAccessibility(isRunning ? 'recording' : 'paused');\n}\n\n/**\n * Announce connection status change\n *\n * @param sensorType - The type of sensor\n * @param isConnected - Whether the sensor is connected\n */\nexport function announceConnectionStatus(sensorType: 'power' | 'cadence' | 'heartrate', isConnected: boolean): void {\n    const sensorNames = {\n        power: 'Power meter',\n        cadence: 'Cadence sensor',\n        heartrate: 'Heart rate monitor',\n    };\n\n    const message = isConnected ? `${sensorNames[sensorType]} connected` : `${sensorNames[sensorType]} disconnected`;\n\n    announce(message, 'assertive');\n}\n","/**\n * Workout Library\n *\n * Pre-built structured workouts.\n */\n\nimport type { StructuredWorkout, WorkoutStep } from './types.js';\n\n// Helper to generate ramp steps\nconst generateRampSteps = (startWatts: number, stepWatts: number, steps: number): WorkoutStep[] => {\n    return Array.from({ length: steps }).map((_, i) => {\n        const watts = startWatts + i * stepWatts;\n        return {\n            type: 'active',\n            duration: 60,\n            target: { type: 'power', unit: 'watts', value: watts },\n            name: `Step ${i + 1}`,\n            description: `${watts} Watts`,\n        };\n    });\n};\n\nconst RAMP_TEST: StructuredWorkout = {\n    id: 'ramp-test',\n    name: 'Ramp Test',\n    description: 'Standard Ramp Test to estimate FTP. Start at 100W, increase by 20W every minute until failure.',\n    tags: ['test', 'ftp'],\n    category: 'Testing',\n    steps: [\n        {\n            type: 'warmup',\n            duration: 300,\n            target: { type: 'open', unit: 'watts', min: 80, max: 120 },\n            description: 'Free warmup',\n        },\n        ...generateRampSteps(100, 20, 25), // Up to 600W\n    ],\n};\n\nconst SWEET_SPOT_3X10: StructuredWorkout = {\n    id: 'sweet-spot-3x10',\n    name: 'Sweet Spot 3x10',\n    description: 'Classic Sweet Spot workout. 3 intervals of 10 minutes at 90% FTP.',\n    tags: ['sweet-spot', 'aerobic'],\n    category: 'Sweet Spot',\n    steps: [\n        { type: 'warmup', duration: 600, target: { type: 'power', unit: 'percent_ftp', value: 50 }, name: 'Warmup' },\n        // Interval 1\n        {\n            type: 'active',\n            duration: 600,\n            target: { type: 'power', unit: 'percent_ftp', value: 90 },\n            name: 'Sweet Spot',\n        },\n        {\n            type: 'recovery',\n            duration: 300,\n            target: { type: 'power', unit: 'percent_ftp', value: 50 },\n            name: 'Recovery',\n        },\n        // Interval 2\n        {\n            type: 'active',\n            duration: 600,\n            target: { type: 'power', unit: 'percent_ftp', value: 90 },\n            name: 'Sweet Spot',\n        },\n        {\n            type: 'recovery',\n            duration: 300,\n            target: { type: 'power', unit: 'percent_ftp', value: 50 },\n            name: 'Recovery',\n        },\n        // Interval 3\n        {\n            type: 'active',\n            duration: 600,\n            target: { type: 'power', unit: 'percent_ftp', value: 90 },\n            name: 'Sweet Spot',\n        },\n        {\n            type: 'cooldown',\n            duration: 600,\n            target: { type: 'power', unit: 'percent_ftp', value: 50 },\n            name: 'Cooldown',\n        },\n    ],\n};\n\nconst VO2_MAX_30_30: StructuredWorkout = {\n    id: 'vo2-30-30',\n    name: 'VO2 Max 30/30s',\n    description: 'High intensity intervals. 2 sets of 8x 30s ON / 30s OFF.',\n    tags: ['vo2max', 'hiit'],\n    category: 'VO2 Max',\n    steps: [\n        { type: 'warmup', duration: 600, target: { type: 'power', unit: 'percent_ftp', value: 50 }, name: 'Warmup' },\n        { type: 'warmup', duration: 60, target: { type: 'power', unit: 'percent_ftp', value: 100 }, name: 'Opener' },\n        { type: 'rest', duration: 120, target: { type: 'power', unit: 'percent_ftp', value: 50 }, name: 'Recover' },\n\n        // Set 1 (8 reps)\n        ...Array.from({ length: 8 }).flatMap(\n            (_, i) =>\n                [\n                    {\n                        type: 'active',\n                        duration: 30,\n                        target: { type: 'power', unit: 'percent_ftp', value: 120 },\n                        name: `Rep ${i + 1}`,\n                    },\n                    {\n                        type: 'rest',\n                        duration: 30,\n                        target: { type: 'power', unit: 'percent_ftp', value: 50 },\n                        name: 'Float',\n                    },\n                ] as WorkoutStep[]\n        ),\n\n        {\n            type: 'rest',\n            duration: 300,\n            target: { type: 'power', unit: 'percent_ftp', value: 50 },\n            name: 'Set Recovery',\n        },\n\n        // Set 2 (8 reps)\n        ...Array.from({ length: 8 }).flatMap(\n            (_, i) =>\n                [\n                    {\n                        type: 'active',\n                        duration: 30,\n                        target: { type: 'power', unit: 'percent_ftp', value: 120 },\n                        name: `Rep ${i + 1}`,\n                    },\n                    {\n                        type: 'rest',\n                        duration: 30,\n                        target: { type: 'power', unit: 'percent_ftp', value: 50 },\n                        name: 'Float',\n                    },\n                ] as WorkoutStep[]\n        ),\n\n        {\n            type: 'cooldown',\n            duration: 600,\n            target: { type: 'power', unit: 'percent_ftp', value: 40 },\n            name: 'Cooldown',\n        },\n    ],\n};\n\nexport const WORKOUT_LIBRARY: StructuredWorkout[] = [RAMP_TEST, SWEET_SPOT_3X10, VO2_MAX_30_30];\n\nexport function getWorkoutById(id: string): StructuredWorkout | undefined {\n    return WORKOUT_LIBRARY.find((w) => w.id === id);\n}\n\n/**\n * Calculate total duration in seconds\n */\nexport function getWorkoutDuration(workout: StructuredWorkout): number {\n    return workout.steps.reduce((acc, step) => acc + step.duration, 0);\n}\n","/**\n * User Profile Storage\n *\n * Manages persistence of user settings (FTP, Weight, Max HR).\n */\n\n/**\n * User profile settings for training zones\n */\nexport interface UserProfile {\n    /** Functional Threshold Power in watts */\n    ftp: number | null;\n    /** Maximum heart rate in bpm */\n    maxHr: number | null;\n    /** Body weight in kg */\n    weight: number | null;\n    /** Whether onboarding has been completed */\n    onboardingComplete: boolean;\n    /** Timestamp of last profile update */\n    lastUpdated: number | null;\n}\n\n/** Storage key for user profile */\nexport const PROFILE_KEY = 'bpt-user-profile';\n\n/** Default profile values */\nexport const defaultProfile: UserProfile = {\n    ftp: null,\n    maxHr: null,\n    weight: null,\n    onboardingComplete: false,\n    lastUpdated: null,\n};\n\n/**\n * Load user profile from localStorage\n */\nexport function loadUserProfile(): UserProfile {\n    try {\n        if (typeof localStorage === 'undefined') {\n            return { ...defaultProfile };\n        }\n        const stored = localStorage.getItem(PROFILE_KEY);\n        if (stored) {\n            return { ...defaultProfile, ...JSON.parse(stored) };\n        }\n    } catch (e) {\n        console.warn('Failed to load user profile:', e);\n    }\n    return { ...defaultProfile };\n}\n\n/**\n * Save user profile to localStorage\n */\nexport function saveUserProfile(profile: UserProfile): void {\n    try {\n        if (typeof localStorage === 'undefined') {\n            console.warn('localStorage not available, profile not saved');\n            return;\n        }\n        profile.lastUpdated = Date.now();\n        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));\n    } catch (e) {\n        console.warn('Failed to save user profile:', e);\n    }\n}\n","/**\n * Audio cues for workouts and notifications\n * Using Web Audio API for synthetic sounds (no assets needed)\n * and SpeechSynthesis for voice announcements.\n */\n\nclass AudioController {\n    private audioCtx: AudioContext | null = null;\n    private gainNode: GainNode | null = null;\n    private isMuted: boolean = false;\n\n    constructor() {\n        // Initialize AudioContext on first user interaction if possible\n        // But for now we just prepare it.\n        // Modern browsers require user gesture to resume AudioContext.\n    }\n\n    public init() {\n        this.ensureContext();\n    }\n\n    private ensureContext() {\n        if (!this.audioCtx) {\n            const Ctx = window.AudioContext || window.webkitAudioContext;\n            if (Ctx) {\n                this.audioCtx = new Ctx();\n                this.gainNode = this.audioCtx.createGain();\n                this.gainNode.connect(this.audioCtx.destination);\n                this.gainNode.gain.value = 0.5; // Default volume\n            }\n        }\n\n        if (this.audioCtx && this.audioCtx.state === 'suspended') {\n            this.audioCtx.resume();\n        }\n    }\n\n    public setMuted(muted: boolean) {\n        this.isMuted = muted;\n    }\n\n    /**\n     * Play a synthesized beep\n     * @param freq Frequency in Hz\n     * @param duration Duration in ms\n     * @param type Oscillator type\n     */\n    public beep(freq: number = 440, duration: number = 200, type: OscillatorType = 'sine') {\n        if (this.isMuted) return;\n        this.ensureContext();\n\n        if (!this.audioCtx || !this.gainNode) return;\n\n        const osc = this.audioCtx.createOscillator();\n        const gain = this.audioCtx.createGain();\n\n        osc.type = type;\n        osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime);\n\n        // Envelope to avoid clicking\n        gain.gain.setValueAtTime(0, this.audioCtx.currentTime);\n        gain.gain.linearRampToValueAtTime(0.5, this.audioCtx.currentTime + 0.01);\n        gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + duration / 1000);\n\n        osc.connect(gain);\n        gain.connect(this.gainNode);\n\n        osc.start();\n        osc.stop(this.audioCtx.currentTime + duration / 1000);\n    }\n\n    /**\n     * Play a sequence of beeps (e.g. countdown)\n     * High pitch: 880Hz, Low pitch: 440Hz\n     */\n    public playCountdown() {\n        this.beep(440, 150); // 3\n    }\n\n    public playStart() {\n        this.beep(880, 400); // GO\n    }\n\n    public playSuccess() {\n        if (this.isMuted) return;\n        this.ensureContext();\n        if (!this.audioCtx || !this.gainNode) return;\n\n        const now = this.audioCtx.currentTime;\n\n        // Arpeggio C E G\n        this.scheduleNote(523.25, now, 0.1);\n        this.scheduleNote(659.25, now + 0.1, 0.1);\n        this.scheduleNote(783.99, now + 0.2, 0.2);\n    }\n\n    private scheduleNote(freq: number, startTime: number, duration: number) {\n        if (!this.audioCtx || !this.gainNode) return;\n\n        const osc = this.audioCtx.createOscillator();\n        const gain = this.audioCtx.createGain();\n\n        osc.frequency.value = freq;\n\n        gain.gain.setValueAtTime(0, startTime);\n        gain.gain.linearRampToValueAtTime(0.3, startTime + 0.01);\n        gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);\n\n        osc.connect(gain);\n        gain.connect(this.gainNode);\n\n        osc.start(startTime);\n        osc.stop(startTime + duration);\n    }\n\n    /**\n     * Speak text using SpeechSynthesis\n     */\n    public speak(text: string) {\n        if (this.isMuted || !window.speechSynthesis) return;\n\n        // Cancel current utterance\n        window.speechSynthesis.cancel();\n\n        const utterance = new SpeechSynthesisUtterance(text);\n        utterance.rate = 1.0;\n        utterance.pitch = 1.0;\n        utterance.volume = 1.0;\n\n        window.speechSynthesis.speak(utterance);\n    }\n}\n\nexport const audioManager = new AudioController();\n","/**\n * Workout Runner\n *\n * Manages the execution state of a structured workout.\n */\n\nimport type { StructuredWorkout, ActiveWorkoutState, TargetUnit } from './types.js';\nimport { loadUserProfile } from '../storage/userSettings.js';\nimport { audioManager } from '../ui/audio.js';\n\nexport type StateChangeCallback = (state: ActiveWorkoutState) => void;\n\nexport class WorkoutRunner {\n    private state: ActiveWorkoutState;\n    private timerInterval: ReturnType<typeof setInterval> | null = null;\n    private onStateChange: StateChangeCallback | null = null;\n    private userFtp: number = 200; // Default fallback\n\n    constructor(workout: StructuredWorkout, options?: { userFtp?: number }) {\n        // Load User FTP\n        if (options?.userFtp) {\n            this.userFtp = options.userFtp;\n        } else {\n            try {\n                const profile = loadUserProfile();\n                if (profile.ftp) {\n                    this.userFtp = profile.ftp;\n                }\n            } catch (e) {\n                // Ignore error (e.g. ssr/test environment)\n            }\n        }\n\n        // Initialize State\n        const totalDuration = workout.steps.reduce((acc, step) => acc + step.duration, 0);\n\n        this.state = {\n            workout,\n            isRunning: false,\n            isPaused: true,\n            isFinished: false,\n            currentStepIndex: 0,\n            startTime: null,\n            stepElapsedTime: 0,\n            stepTimeRemaining: workout.steps[0].duration,\n            totalElapsedTime: 0,\n            totalDuration,\n            currentStep: workout.steps[0],\n            nextStep: workout.steps.length > 1 ? workout.steps[1] : null,\n            totalSteps: workout.steps.length,\n            currentAbsoluteTarget: undefined,\n        };\n\n        // Initial calculation\n        this.updateCurrentTarget();\n    }\n\n    public getWorkoutName(): string {\n        return this.state.workout.name;\n    }\n\n    /**\n     * Set callback for state updates\n     */\n    public setCallback(cb: StateChangeCallback): void {\n        this.onStateChange = cb;\n        // Emit initial state\n        cb(this.state);\n    }\n\n    /**\n     * Start or Resume the workout\n     */\n    public start(): void {\n        if (this.state.isFinished) return;\n        if (this.state.isRunning && !this.state.isPaused) return;\n\n        if (!this.state.startTime) {\n            this.state.startTime = Date.now();\n        }\n\n        this.state.isRunning = true;\n        this.state.isPaused = false;\n        this.emitState();\n\n        this.timerInterval = setInterval(() => {\n            this.tick();\n        }, 1000);\n    }\n\n    /**\n     * Pause the workout\n     */\n    public pause(): void {\n        this.state.isPaused = true;\n        this.state.isRunning = false;\n        if (this.timerInterval) {\n            clearInterval(this.timerInterval);\n            this.timerInterval = null;\n        }\n        this.emitState();\n    }\n\n    /**\n     * Skip to next step\n     */\n    public nextStep(): void {\n        this.advanceStep();\n    }\n\n    /**\n     * Stop and cleanup\n     */\n    public stop(): void {\n        this.pause();\n        this.onStateChange = null;\n    }\n\n    private tick(): void {\n        if (this.state.isPaused || this.state.isFinished) return;\n\n        this.state.stepElapsedTime++;\n        this.state.totalElapsedTime++;\n        this.state.stepTimeRemaining = Math.max(0, this.state.currentStep.duration - this.state.stepElapsedTime);\n\n        // Update Ramp Targets dynamic calculation\n        this.updateCurrentTarget();\n\n        // Audio Cues (3, 2, 1)\n        if (this.state.stepTimeRemaining <= 3 && this.state.stepTimeRemaining > 0) {\n            this.safePlaySound('countdown');\n        }\n\n        // Check if step is complete\n        if (this.state.stepElapsedTime >= this.state.currentStep.duration) {\n            this.advanceStep();\n        } else {\n            this.emitState();\n        }\n    }\n\n    private advanceStep(): void {\n        const nextIndex = this.state.currentStepIndex + 1;\n\n        if (nextIndex >= this.state.workout.steps.length) {\n            this.finish();\n            return;\n        }\n\n        this.state.currentStepIndex = nextIndex;\n        this.state.currentStep = this.state.workout.steps[nextIndex];\n        this.state.nextStep =\n            nextIndex + 1 < this.state.workout.steps.length ? this.state.workout.steps[nextIndex + 1] : null;\n\n        this.state.stepElapsedTime = 0;\n        this.state.stepTimeRemaining = this.state.currentStep.duration;\n        this.updateCurrentTarget();\n\n        // Play interval start sound\n        this.safePlaySound('start');\n\n        this.emitState();\n    }\n\n    private finish(): void {\n        this.state.isFinished = true;\n        this.state.isRunning = false;\n        this.pause();\n        this.safePlaySound('success');\n        this.emitState();\n    }\n\n    private safePlaySound(type: 'countdown' | 'start' | 'success'): void {\n        try {\n            if (type === 'countdown') audioManager.playCountdown();\n            if (type === 'start') audioManager.playStart();\n            if (type === 'success') audioManager.playSuccess();\n        } catch (e) {\n            // Ignore (test/headless)\n        }\n    }\n\n    private updateCurrentTarget(): void {\n        const step = this.state.currentStep;\n\n        if (step.rampStart && step.rampEnd) {\n            // Ramp Calculation\n            const startVal = this.resolveValue(step.rampStart.value, step.rampStart.unit);\n            const endVal = this.resolveValue(step.rampEnd.value, step.rampEnd.unit);\n\n            if (startVal !== null && endVal !== null) {\n                const progress = this.state.stepElapsedTime / step.duration;\n                const currentVal = startVal + (endVal - startVal) * progress;\n\n                this.state.currentAbsoluteTarget = {\n                    type: step.rampStart.type,\n                    unit: 'watts', // Resolved to watts usually\n                    value: Math.round(currentVal),\n                    min: Math.round(currentVal - 5),\n                    max: Math.round(currentVal + 5),\n                };\n            }\n        } else if (step.target) {\n            // Steady State\n            const val = this.resolveValue(step.target.value, step.target.unit);\n            const min = this.resolveValue(step.target.min, step.target.unit);\n            const max = this.resolveValue(step.target.max, step.target.unit);\n\n            if (val !== null || (min !== null && max !== null)) {\n                this.state.currentAbsoluteTarget = {\n                    type: step.target.type,\n                    unit: 'watts', // Assuming watts for now if resolved\n                    value: val || (min! + max!) / 2,\n                    min: min || (val ? val - 10 : 0),\n                    max: max || (val ? val + 10 : 999),\n                };\n\n                // Handle HR units\n                if (step.target.type === 'heartrate') {\n                    this.state.currentAbsoluteTarget.unit = 'bpm';\n                }\n            } else {\n                this.state.currentAbsoluteTarget = undefined;\n            }\n        } else {\n            this.state.currentAbsoluteTarget = undefined;\n        }\n    }\n\n    // Resolve %FTP to Watts, etc.\n    private resolveValue(value: number | undefined, unit: TargetUnit): number | null {\n        if (value === undefined) return null;\n\n        if (unit === 'watts' || unit === 'bpm' || unit === 'rpm') {\n            return value;\n        }\n\n        if (unit === 'percent_ftp') {\n            return Math.round(this.userFtp * (value / 100));\n        }\n\n        return value;\n    }\n\n    private emitState(): void {\n        if (this.onStateChange) {\n            this.onStateChange({ ...this.state });\n        }\n    }\n\n    public getState(): ActiveWorkoutState {\n        return { ...this.state };\n    }\n}\n","/**\n * API client for workout database operations\n * Handles communication with the workout history API\n *\n * @module workoutClient\n */\n\nimport type { ApiError } from './types.js';\n\n// Use relative path for proxy in development, or custom URL in production\nconst API_BASE_URL: string = import.meta.env.VITE_API_URL || '';\nconst API_KEY: string | undefined = import.meta.env.VITE_API_KEY;\n\n/**\n * Helper to parse API errors\n */\nasync function parseError(response: Response): Promise<ApiError> {\n    try {\n        const body = await response.json();\n        return {\n            status: response.status,\n            message: body.error || body.message || 'Unknown error',\n            code: body.code,\n            details: body.details,\n        };\n    } catch {\n        return {\n            status: response.status,\n            message: response.statusText || 'Unknown error',\n        };\n    }\n}\n\n/**\n * Workout data from API\n */\nexport interface Workout {\n    id: string;\n    userId?: string;\n    streamName?: string;\n    title?: string;\n    description?: string;\n    sport: string;\n    startTime: string;\n    endTime?: string;\n    duration?: number;\n    status: 'ACTIVE' | 'PAUSED' | 'COMPLETED' | 'ARCHIVED' | 'DELETED';\n    summary?: string;\n    telemetry?: string;\n    createdAt: string;\n    updatedAt: string;\n}\n\n/**\n * Pagination info\n */\nexport interface PaginationInfo {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n}\n\n/**\n * List workouts response\n */\nexport interface ListWorkoutsResponse {\n    workouts: Workout[];\n    pagination: PaginationInfo;\n}\n\n/**\n * List workouts options\n */\nexport interface ListWorkoutsOptions {\n    page?: number;\n    limit?: number;\n    status?: string;\n    userId?: string;\n    startDate?: Date;\n    endDate?: Date;\n    sport?: string;\n}\n\n/**\n * Create workout params\n */\nexport interface CreateWorkoutParams {\n    streamName: string;\n    title?: string;\n    sport?: string;\n    userId?: string;\n}\n\n/**\n * Create workout response\n */\nexport interface CreateWorkoutResponse {\n    success: boolean;\n    workout: Workout;\n}\n\n/**\n * Update workout params\n */\nexport interface UpdateWorkoutParams {\n    title?: string;\n    description?: string;\n    sport?: string;\n}\n\n/**\n * Complete workout response\n */\nexport interface CompleteWorkoutResponse {\n    success: boolean;\n    workout: Workout;\n    archivedMessages: number;\n}\n\n/**\n * Delete workout response\n */\nexport interface DeleteWorkoutResponse {\n    success: boolean;\n    message: string;\n}\n\n/**\n * User statistics\n */\nexport interface UserStats {\n    totalWorkouts: number;\n    totalDuration: number;\n}\n\n/**\n * Helper to get headers with authentication\n */\nfunction getHeaders(extraHeaders: Record<string, string> = {}): Record<string, string> {\n    const headers: Record<string, string> = { ...extraHeaders };\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n    return headers;\n}\n\n/**\n * Check if database features are available\n *\n * @returns Promise resolving to true if database is connected\n */\nexport async function isDatabaseAvailable(): Promise<boolean> {\n    try {\n        const response = await fetch(`${API_BASE_URL}/health`, {\n            headers: getHeaders(),\n        });\n        if (!response.ok) return false;\n        const health = await response.json();\n        return health.database === 'connected';\n    } catch {\n        return false;\n    }\n}\n\n/**\n * Create a new workout\n *\n * @param params - Workout parameters\n * @returns Promise with created workout\n */\nexport async function createWorkout({\n    streamName,\n    title,\n    sport = 'cycling',\n    userId,\n}: CreateWorkoutParams): Promise<CreateWorkoutResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/workouts`, {\n        method: 'POST',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({ streamName, title, sport, userId }),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<CreateWorkoutResponse>;\n}\n\n/**\n * List workouts with pagination\n *\n * @param options - Query options\n * @returns Promise with workouts and pagination info\n */\nexport async function listWorkouts({\n    page = 1,\n    limit = 20,\n    status,\n    userId,\n    startDate,\n    endDate,\n    sport,\n}: ListWorkoutsOptions = {}): Promise<ListWorkoutsResponse> {\n    const params = new URLSearchParams();\n    params.set('page', page.toString());\n    params.set('limit', limit.toString());\n    if (status) params.set('status', status);\n    if (userId) params.set('userId', userId);\n    if (startDate) params.set('startDate', startDate.toISOString());\n    if (endDate) params.set('endDate', endDate.toISOString());\n    if (sport) params.set('sport', sport);\n\n    const response = await fetch(`${API_BASE_URL}/api/workouts?${params}`, {\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<ListWorkoutsResponse>;\n}\n\n/**\n * Get a single workout by ID\n *\n * @param workoutId - Workout ID\n * @param includeTelemetry - Include full telemetry data\n * @returns Promise with workout data\n */\nexport async function getWorkout(workoutId: string, includeTelemetry: boolean = false): Promise<Workout> {\n    const params = new URLSearchParams();\n    if (includeTelemetry) params.set('includeTelemetry', 'true');\n\n    const response = await fetch(`${API_BASE_URL}/api/workouts/${workoutId}?${params}`, {\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<Workout>;\n}\n\n/**\n * Update workout metadata\n *\n * @param workoutId - Workout ID\n * @param data - Fields to update\n * @returns Promise with updated workout\n */\nexport async function updateWorkout(\n    workoutId: string,\n    { title, description, sport }: UpdateWorkoutParams\n): Promise<CreateWorkoutResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/workouts/${workoutId}`, {\n        method: 'PATCH',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({ title, description, sport }),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<CreateWorkoutResponse>;\n}\n\n/**\n * Complete a workout (archive from Redis to database)\n *\n * @param workoutId - Workout ID\n * @param archiveTelemetry - Archive telemetry data\n * @returns Promise with completion result\n */\nexport async function completeWorkout(\n    workoutId: string,\n    archiveTelemetry: boolean = true\n): Promise<CompleteWorkoutResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/workouts/${workoutId}/complete`, {\n        method: 'POST',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({ archiveTelemetry }),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<CompleteWorkoutResponse>;\n}\n\n/**\n * Delete a workout\n *\n * @param workoutId - Workout ID\n * @returns Promise with deletion result\n */\nexport async function deleteWorkout(workoutId: string): Promise<DeleteWorkoutResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/workouts/${workoutId}`, {\n        method: 'DELETE',\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<DeleteWorkoutResponse>;\n}\n\n/**\n * Get active workout by stream name\n *\n * @param streamName - Stream name\n * @returns Promise with workout or null if not found\n */\nexport async function getWorkoutByStream(streamName: string): Promise<Workout | null> {\n    try {\n        const response = await fetch(`${API_BASE_URL}/api/workouts/by-stream/${encodeURIComponent(streamName)}`, {\n            headers: getHeaders(),\n        });\n\n        if (response.status === 404) {\n            return null;\n        }\n\n        if (!response.ok) {\n            const errorData = await parseError(response);\n            throw new Error(errorData.message);\n        }\n\n        return response.json() as Promise<Workout>;\n    } catch (error) {\n        if (error instanceof Error && error.message.includes('not found')) {\n            return null;\n        }\n        throw error;\n    }\n}\n\n/**\n * Get user statistics\n *\n * @param userId - User ID\n * @returns Promise with user stats\n */\nexport async function getUserStats(userId: string): Promise<UserStats> {\n    const response = await fetch(`${API_BASE_URL}/api/users/${userId}/stats`, {\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const errorData = await parseError(response);\n        throw new Error(errorData.message);\n    }\n\n    return response.json() as Promise<UserStats>;\n}\n\n/**\n * Format duration in seconds to human-readable string\n *\n * @param seconds - Duration in seconds\n * @returns Formatted duration string\n */\nexport function formatDuration(seconds: number | undefined | null): string {\n    if (!seconds) return '--';\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n\n    if (hours > 0) {\n        return `${hours}h ${minutes}m`;\n    }\n    if (minutes > 0) {\n        return `${minutes}m ${secs}s`;\n    }\n    return `${secs}s`;\n}\n\n/**\n * Format date to locale string\n *\n * @param date - Date to format\n * @returns Formatted date string\n */\nexport function formatDate(date: string | Date | undefined | null): string {\n    if (!date) return '--';\n    return new Date(date).toLocaleDateString(undefined, {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit',\n    });\n}\n","/**\n * Custom Workout Storage\n *\n * Manages saving and loading user-created structured workouts in LocalStorage.\n */\n\nimport type { StructuredWorkout } from '../workouts/types.js';\n\nconst STORAGE_KEY = 'bpt_custom_workouts';\n\n/**\n * Get all custom workouts\n */\nexport function getCustomWorkouts(): StructuredWorkout[] {\n    try {\n        const raw = localStorage.getItem(STORAGE_KEY);\n        if (!raw) return [];\n        return JSON.parse(raw);\n    } catch (e) {\n        console.error('Failed to load custom workouts', e);\n        return [];\n    }\n}\n\n/**\n * Save a custom workout\n */\nexport function saveCustomWorkout(workout: StructuredWorkout): void {\n    const workouts = getCustomWorkouts();\n\n    // Check if updating existing\n    const index = workouts.findIndex((w) => w.id === workout.id);\n    if (index >= 0) {\n        workouts[index] = workout;\n    } else {\n        workouts.push(workout);\n    }\n\n    saveAll(workouts);\n}\n\n/**\n * Delete a custom workout\n */\nexport function deleteCustomWorkout(id: string): void {\n    const workouts = getCustomWorkouts();\n    const filtered = workouts.filter((w) => w.id !== id);\n    saveAll(filtered);\n}\n\nfunction saveAll(workouts: StructuredWorkout[]): void {\n    try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(workouts));\n    } catch (e) {\n        console.error('Failed to save custom workouts', e);\n        alert('Failed to save workout. Storage might be full.');\n    }\n}\n","/**\n * Workout UI Manager\n *\n * Handles the Workout Selection Modal and the Active Workout Player Overlay.\n */\n\nimport { WORKOUT_LIBRARY, getWorkoutDuration } from '../workouts/workoutLibrary.js';\nimport type { StructuredWorkout, WorkoutStep, ActiveWorkoutState } from '../workouts/types.js';\nimport { WorkoutRunner } from '../workouts/WorkoutRunner.js';\nimport { formatDuration } from '../api/workoutClient.js';\nimport { announce } from './accessibility.js';\nimport { audioManager } from './audio.js';\nimport { getCustomWorkouts, deleteCustomWorkout, saveCustomWorkout } from '../storage/customWorkouts.js';\n\nlet activeRunner: WorkoutRunner | null = null;\n// let playerVisible = false;\n\n// export function initWorkoutUI(): void {\n//     initSelectionModal();\n//     initPlayerControls();\n//     initImportExport();\n// }\n\n/**\n * Initialize Workout Selection Logic\n * Call this from the Workouts View\n */\nexport function initWorkoutSelectionLogic(): void {\n    initPlayerControls(); // Logic only, assuming container exists\n    initImportExport();\n    refreshWorkoutList();\n}\n\n/**\n * Initialize Import/Export controls\n */\nfunction initImportExport(): void {\n    const importBtn = document.getElementById('importWorkoutBtn');\n    const importInput = document.getElementById('importWorkoutInput') as HTMLInputElement;\n\n    if (importBtn && importInput) {\n        importBtn.addEventListener('click', () => {\n            importInput.click();\n        });\n\n        importInput.addEventListener('change', (e) => {\n            const files = (e.target as HTMLInputElement).files;\n            if (files && files.length > 0) {\n                importWorkoutFile(files[0]);\n                // Reset input\n                importInput.value = '';\n            }\n        });\n    }\n}\n\nasync function importWorkoutFile(file: File): Promise<void> {\n    try {\n        const text = await file.text();\n        const workout = JSON.parse(text) as StructuredWorkout;\n\n        // Basic validation\n        if (!workout.name || !Array.isArray(workout.steps)) {\n            throw new Error('Invalid workout format');\n        }\n\n        // Ensure unique ID for imported workout\n        workout.id = crypto.randomUUID();\n        workout.tags = [...(workout.tags || []), 'imported'];\n\n        saveCustomWorkout(workout);\n        refreshWorkoutList();\n        announce(`Imported workout: ${workout.name}`, 'assertive');\n    } catch (err) {\n        console.error('Import failed', err);\n        alert('Failed to import workout: Invalid file format.');\n    }\n}\n\nfunction exportWorkout(workout: StructuredWorkout): void {\n    const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(workout, null, 2));\n    const downloadAnchorNode = document.createElement('a');\n    downloadAnchorNode.setAttribute('href', dataStr);\n    downloadAnchorNode.setAttribute('download', `${workout.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`);\n    document.body.appendChild(downloadAnchorNode); // required for firefox\n    downloadAnchorNode.click();\n    downloadAnchorNode.remove();\n}\n\n// function initSelectionModal(): void {\n//     const btn = document.getElementById('workoutsButton');\n//     const modal = document.getElementById('workoutSelectionModal');\n//     const closeBtn = document.getElementById('closeWorkoutModal');\n//     // const list = document.getElementById('workoutList');\n\n//     if (!btn || !modal || !closeBtn) return;\n\n//     // Open Modal\n//     btn.addEventListener('click', () => {\n//         modal.style.display = 'flex';\n//         refreshWorkoutList();\n//         announce('Workout selection opened', 'polite');\n//     });\n\n//     // Close Modal\n//     closeBtn.addEventListener('click', () => {\n//         modal.style.display = 'none';\n//     });\n// }\n\n/**\n * Render list of workouts (Exported for Builder to update)\n */\nexport function refreshWorkoutList(): void {\n    const container = document.getElementById('workoutList');\n    if (!container) return;\n\n    container.innerHTML = '';\n\n    const custom = getCustomWorkouts();\n\n    if (custom.length > 0) {\n        const h3 = document.createElement('h3');\n        h3.textContent = 'My Workouts';\n        h3.style.margin = '0 0 8px 0';\n        h3.style.fontSize = '1rem';\n        h3.style.color = 'var(--color-text-secondary)';\n        container.appendChild(h3);\n\n        custom.forEach((w) => renderWorkoutItem(w, container, true));\n\n        const hr = document.createElement('hr');\n        hr.style.margin = '16px 0';\n        hr.style.border = '0';\n        hr.style.borderTop = '1px solid var(--color-border)';\n        container.appendChild(hr);\n\n        const h3lib = document.createElement('h3');\n        h3lib.textContent = 'Library';\n        h3lib.style.margin = '0 0 8px 0';\n        h3lib.style.fontSize = '1rem';\n        h3lib.style.color = 'var(--color-text-secondary)';\n        container.appendChild(h3lib);\n    }\n\n    WORKOUT_LIBRARY.forEach((w) => renderWorkoutItem(w, container, false));\n}\n\nfunction renderWorkoutItem(w: StructuredWorkout, container: HTMLElement, isCustom: boolean): void {\n    const duration = getWorkoutDuration(w);\n\n    const el = document.createElement('div');\n    el.className = 'workout-item';\n    el.setAttribute('role', 'button');\n    el.setAttribute('tabindex', '0');\n    el.style.position = 'relative'; // For action buttons\n\n    let actionsHtml = '';\n    // Always allow exporting, but deleting only for custom\n    actionsHtml += `<button class=\"export-workout-btn\" aria-label=\"Export ${w.name}\" title=\"Export JSON\" style=\"background: none; border: none; font-size: 1.2rem; cursor: pointer;\"></button>`;\n\n    if (isCustom) {\n        actionsHtml += `<button class=\"delete-workout-btn\" aria-label=\"Delete ${w.name}\" title=\"Delete\" style=\"background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--color-error);\"></button>`;\n    }\n\n    const actionContainerStyle = 'position: absolute; right: 10px; top: 10px; display: flex; gap: 8px; z-index: 2;';\n\n    el.innerHTML = `\n        <div class=\"workout-item-header\">\n            <span class=\"workout-item-title\">${w.name}</span>\n            <span class=\"workout-item-duration\"> ${formatDuration(duration * 1000)}</span>\n        </div>\n        <div class=\"workout-item-desc\">${w.description}</div>\n        <div class=\"workout-tags\">\n            ${(w.tags || []).map((t) => `<span class=\"workout-tag\">${t}</span>`).join('')}\n        </div>\n        <div style=\"${actionContainerStyle}\">\n            ${actionsHtml}\n        </div>\n    `;\n\n    // Handle Export\n    const exportBtn = el.querySelector('.export-workout-btn');\n    exportBtn?.addEventListener('click', (e) => {\n        e.stopPropagation();\n        exportWorkout(w);\n    });\n\n    // Handle Delete\n    if (isCustom) {\n        const delBtn = el.querySelector('.delete-workout-btn');\n        delBtn?.addEventListener('click', (e) => {\n            e.stopPropagation();\n            if (confirm(`Delete workout \"${w.name}\"?`)) {\n                deleteCustomWorkout(w.id);\n                refreshWorkoutList();\n                announce(`Deleted workout: ${w.name}`, 'assertive');\n            }\n        });\n    }\n\n    // Start workout on click (prevent if clicking actions)\n    el.addEventListener('click', (e) => {\n        // Simple check to ensure we didn't click a button\n        if ((e.target as HTMLElement).tagName === 'BUTTON') return;\n\n        startStructuredWorkout(w);\n        const modal = document.getElementById('workoutSelectionModal');\n        if (modal) modal.style.display = 'none';\n    });\n\n    // Keyboard support\n    el.addEventListener('keydown', (e) => {\n        if (e.key === 'Enter' || e.key === ' ') {\n            e.preventDefault();\n            startStructuredWorkout(w);\n            const modal = document.getElementById('workoutSelectionModal');\n            if (modal) modal.style.display = 'none';\n        }\n    });\n\n    container.appendChild(el);\n}\n\n/**\n * Select and start a workout\n */\nexport function startStructuredWorkout(workout: StructuredWorkout, onComplete?: () => void): void {\n    if (activeRunner) {\n        if (!confirm('A workout is already active. Stop it and start this one?')) {\n            return;\n        }\n        activeRunner.stop();\n    }\n\n    // Initialize audio on user interaction\n    audioManager.init();\n\n    activeRunner = new WorkoutRunner(workout);\n\n    // Track if we have already called onComplete\n    let completed = false;\n\n    activeRunner.setCallback((state) => {\n        updatePlayerUI(state);\n\n        if (state.isFinished && !completed && onComplete) {\n            completed = true;\n            onComplete();\n        }\n    });\n\n    // Show player\n    const overlay = document.getElementById('workoutPlayerOverlay');\n    if (overlay) {\n        overlay.style.display = 'block';\n        // playerVisible = true;\n    }\n\n    // Announce\n    announce(`Starting workout: ${workout.name}. Ready to start.`, 'assertive');\n}\n\n/**\n * Initialize player controls (Minimize, Close, Skip)\n */\nfunction initPlayerControls(): void {\n    const overlay = document.getElementById('workoutPlayerOverlay');\n    const minimizeBtn = document.getElementById('wpMinimize');\n    const closeBtn = document.getElementById('wpClose');\n    const skipBtn = document.getElementById('wpSkip');\n\n    if (!overlay) return;\n\n    // Close/Stop\n    closeBtn?.addEventListener('click', () => {\n        if (!activeRunner) return;\n        if (confirm('Stop current workout?')) {\n            activeRunner.stop();\n            activeRunner = null;\n            overlay.style.display = 'none';\n            announce('Workout stopped', 'polite');\n        }\n    });\n\n    // Minimize (Toggle visibility of body)\n    minimizeBtn?.addEventListener('click', () => {\n        const body = overlay.querySelector('.workout-player-body') as HTMLElement;\n        if (body) {\n            const isHidden = body.style.display === 'none';\n            body.style.display = isHidden ? 'block' : 'none';\n            minimizeBtn.textContent = isHidden ? '_' : '';\n        }\n    });\n\n    // Skip\n    skipBtn?.addEventListener('click', () => {\n        if (activeRunner) {\n            activeRunner.nextStep();\n            announce('Skipped to next step', 'polite');\n        }\n    });\n}\n\n/**\n * Update the player UI based on state\n */\n/**\n * Update the player UI based on state\n */\nfunction updatePlayerUI(state: ActiveWorkoutState): void {\n    const nameEl = document.getElementById('wpWorkoutName');\n    const descEl = document.getElementById('wpStepDescription');\n    const timeEl = document.getElementById('wpStepTime');\n    const durEl = document.getElementById('wpStepDuration');\n    const targetEl = document.getElementById('wpTargetPower');\n    const nextEl = document.getElementById('wpNextStep');\n    const progressEl = document.getElementById('wpProgress');\n\n    if (nameEl) nameEl.textContent = state.workout.name;\n\n    if (state.currentStep) {\n        if (descEl)\n            descEl.textContent =\n                state.currentStep.description || state.currentStep.name || state.currentStep.type.toUpperCase();\n\n        // Timer\n        const timeRemaining = state.currentStep.duration - state.stepElapsedTime;\n        if (timeEl) timeEl.textContent = formatTime(Math.max(0, timeRemaining));\n        if (durEl) durEl.textContent = formatTime(state.currentStep.duration);\n\n        // Target\n        if (targetEl) {\n            targetEl.textContent = state.currentAbsoluteTarget?.value\n                ? Math.round(state.currentAbsoluteTarget.value).toString()\n                : '--';\n        }\n    }\n\n    // Next Step\n    if (nextEl) {\n        if (state.nextStep) {\n            const nextPwr = calculateNextTarget(state.nextStep);\n            nextEl.textContent = `${state.nextStep.type} (${formatTime(state.nextStep.duration)}${nextPwr})`;\n        } else {\n            nextEl.textContent = 'Finish';\n        }\n    }\n\n    // Progress Bar\n    if (progressEl) {\n        const pct = (state.stepElapsedTime / state.currentStep.duration) * 100;\n        progressEl.style.width = `${Math.min(100, Math.max(0, pct))}%`;\n\n        // Change color based on zone/intensity?\n        // simple: blue for warmup/rest, orange for active\n        if (state.currentStep.type === 'active') {\n            progressEl.style.backgroundColor = '#ff9800'; // Orange\n        } else if (state.currentStep.type === 'rest' || state.currentStep.type === 'warmup') {\n            progressEl.style.backgroundColor = '#2196F3'; // Blue\n        } else {\n            progressEl.style.backgroundColor = '#4CAF50'; // Green\n        }\n    }\n\n    // Finished?\n    if (state.isFinished) {\n        const overlay = document.getElementById('workoutPlayerOverlay');\n        if (overlay) overlay.style.display = 'none';\n        activeRunner = null;\n        alert('Workout Complete!');\n        announce('Workout Complete!', 'assertive');\n    }\n}\n\n/**\n * Basic time formatter (mm:ss)\n */\nfunction formatTime(seconds: number): string {\n    const m = Math.floor(seconds / 60);\n    const s = seconds % 60;\n    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;\n}\n\n// Temporary helper until I expose calculation from Runner or pass it in state\nfunction calculateNextTarget(step: WorkoutStep): string {\n    // This logic is duplicated from Runner, improving later\n    const t = step.target;\n    if (!t) return '';\n    return t.value ? ` @ ~${t.value}${t.unit === 'percent_ftp' ? '%' : 'W'}` : '';\n}\n\n/**\n * Hook to link main timer start/pause to workout runner\n * Call this from main.ts or connection logic\n */\nexport function onWorkoutStart(): void {\n    if (activeRunner) {\n        activeRunner.start();\n    }\n}\n\nexport function onWorkoutPause(): void {\n    if (activeRunner) {\n        activeRunner.pause();\n    }\n}\n","/**\n * Base Component\n *\n * Abstract base class for all Web Components in the application.\n * Provides common functionality like shadow DOM, theming, and lifecycle hooks.\n *\n * @module BaseComponent\n */\n\n/**\n * Base class for all custom elements\n */\nexport abstract class BaseComponent extends HTMLElement {\n    protected shadow: ShadowRoot;\n    private _initialized = false;\n\n    constructor() {\n        super();\n        this.shadow = this.attachShadow({ mode: 'open' });\n    }\n\n    /**\n     * Called when the element is added to the DOM\n     */\n    connectedCallback(): void {\n        if (!this._initialized) {\n            this.render();\n            this.setupEventListeners();\n            this._initialized = true;\n        }\n        this.onConnected();\n    }\n\n    /**\n     * Called when the element is removed from the DOM\n     */\n    disconnectedCallback(): void {\n        this.onDisconnected();\n    }\n\n    /**\n     * Called when an observed attribute changes\n     */\n    attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null): void {\n        if (oldValue !== newValue && this._initialized) {\n            this.onAttributeChanged(name, oldValue, newValue);\n        }\n    }\n\n    /**\n     * Get base styles that apply to all components\n     */\n    protected getBaseStyles(): string {\n        return `\n            :host {\n                display: block;\n                box-sizing: border-box;\n            }\n            \n            :host([hidden]) {\n                display: none;\n            }\n            \n            *,\n            *::before,\n            *::after {\n                box-sizing: inherit;\n            }\n            \n            /* Respect reduced motion preferences */\n            @media (prefers-reduced-motion: reduce) {\n                *,\n                *::before,\n                *::after {\n                    animation-duration: 0.01ms !important;\n                    animation-iteration-count: 1 !important;\n                    transition-duration: 0.01ms !important;\n                }\n            }\n        `;\n    }\n\n    /**\n     * Get the component's styles - override in subclasses\n     */\n    protected abstract getStyles(): string;\n\n    /**\n     * Get the component's template - override in subclasses\n     */\n    protected abstract getTemplate(): string;\n\n    /**\n     * Render the component\n     */\n    protected render(): void {\n        this.shadow.innerHTML = `\n            <style>\n                ${this.getBaseStyles()}\n                ${this.getStyles()}\n            </style>\n            ${this.getTemplate()}\n        `;\n    }\n\n    /**\n     * Set up event listeners - override in subclasses\n     */\n    protected setupEventListeners(): void {\n        // Override in subclasses\n    }\n\n    /**\n     * Called after the component is connected to the DOM\n     */\n    protected onConnected(): void {\n        // Override in subclasses\n    }\n\n    /**\n     * Called when the component is disconnected from the DOM\n     */\n    protected onDisconnected(): void {\n        // Override in subclasses\n    }\n\n    /**\n     * Called when an observed attribute changes\n     */\n    protected onAttributeChanged(_name: string, _oldValue: string | null, _newValue: string | null): void {\n        // Override in subclasses\n    }\n\n    /**\n     * Emit a custom event\n     */\n    protected emit<T>(eventName: string, detail?: T): void {\n        this.dispatchEvent(\n            new CustomEvent(eventName, {\n                detail,\n                bubbles: true,\n                composed: true, // Allows event to cross shadow DOM boundary\n            })\n        );\n    }\n\n    /**\n     * Query an element in the shadow DOM\n     */\n    protected query<T extends Element>(selector: string): T | null {\n        return this.shadow.querySelector<T>(selector);\n    }\n\n    /**\n     * Query all elements in the shadow DOM\n     */\n    protected queryAll<T extends Element>(selector: string): NodeListOf<T> {\n        return this.shadow.querySelectorAll<T>(selector);\n    }\n}\n","/**\n * Notification Toast Component\n *\n * A Web Component for displaying toast-style notifications.\n * Accessible, auto-dismissing, and supports different notification types.\n *\n * @example\n * ```html\n * <bpt-toast\n *   message=\"Workout saved!\"\n *   type=\"success\"\n *   duration=\"3000\">\n * </bpt-toast>\n * ```\n *\n * Or programmatically:\n * ```typescript\n * Toast.show('Workout saved!', 'success');\n * ```\n *\n * @module Toast\n */\n\nimport { BaseComponent } from './base/BaseComponent.js';\n\n/**\n * Notification type determines styling\n */\nexport type ToastType = 'info' | 'success' | 'error' | 'warning';\n\n/**\n * Toast configuration options\n */\nexport interface ToastOptions {\n    message: string;\n    type?: ToastType;\n    duration?: number;\n    dismissible?: boolean;\n}\n\n/**\n * Type-specific colors (WCAG AA compliant)\n */\nconst TYPE_STYLES: Record<ToastType, { bg: string; icon: string }> = {\n    info: { bg: '#1d4ed8', icon: '' },\n    success: { bg: '#15803d', icon: '' },\n    error: { bg: '#b91c1c', icon: '' },\n    warning: { bg: '#a16207', icon: '' },\n};\n\n/**\n * Toast Notification Web Component\n */\nexport class Toast extends BaseComponent {\n    private timeoutId: number | null = null;\n\n    static get observedAttributes(): string[] {\n        return ['message', 'type', 'duration', 'dismissible'];\n    }\n\n    protected getStyles(): string {\n        return `\n            :host {\n                position: fixed;\n                top: 80px;\n                left: 50%;\n                transform: translateX(-50%) translateY(-20px);\n                z-index: 10001;\n                opacity: 0;\n                transition: transform 0.3s ease, opacity 0.3s ease;\n                pointer-events: none;\n            }\n\n            :host(.stacked) {\n                position: relative;\n                top: auto;\n                left: auto;\n                transform: translateX(100%); /* Start from right */\n                margin-bottom: 10px;\n                pointer-events: auto; /* Container handles layout */\n                opacity: 0;\n            }\n            \n            :host(.visible) {\n                transform: translateX(-50%) translateY(0);\n                opacity: 1;\n                pointer-events: auto;\n            }\n\n            :host(.stacked.visible) {\n                transform: translateX(0);\n                opacity: 1;\n            }\n            \n            :host(.hiding) {\n                transform: translateX(-50%) translateY(-20px);\n                opacity: 0;\n            }\n\n            :host(.stacked.hiding) {\n                transform: translateX(100%);\n                opacity: 0;\n            }\n            \n            .toast {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 12px 20px;\n                border-radius: 8px;\n                background-color: var(--toast-bg, #1d4ed8);\n                color: white;\n                font-size: 14px;\n                font-weight: 500;\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n                max-width: 90vw;\n            }\n            \n            .icon {\n                font-size: 18px;\n                flex-shrink: 0;\n            }\n            \n            .message {\n                flex: 1;\n            }\n            \n            .dismiss-btn {\n                background: none;\n                border: none;\n                color: white;\n                font-size: 18px;\n                cursor: pointer;\n                padding: 0 4px;\n                opacity: 0.8;\n                transition: opacity 0.2s ease;\n                flex-shrink: 0;\n            }\n            \n            .dismiss-btn:hover {\n                opacity: 1;\n            }\n            \n            .dismiss-btn:focus-visible {\n                outline: 2px solid white;\n                outline-offset: 2px;\n            }\n            \n            /* Reduced motion */\n            @media (prefers-reduced-motion: reduce) {\n                :host {\n                    transition: none;\n                }\n            }\n        `;\n    }\n\n    protected getTemplate(): string {\n        const message = this.getAttribute('message') || '';\n        const type = (this.getAttribute('type') || 'info') as ToastType;\n        const dismissible = this.getAttribute('dismissible') !== 'false';\n        const styles = TYPE_STYLES[type] || TYPE_STYLES.info;\n\n        this.style.setProperty('--toast-bg', styles.bg);\n\n        return `\n            <div class=\"toast\" role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\n                <span class=\"icon\" aria-hidden=\"true\">${styles.icon}</span>\n                <span class=\"message\">${message}</span>\n                ${\n                    dismissible\n                        ? `\n                    <button class=\"dismiss-btn\" aria-label=\"Dismiss notification\">&times;</button>\n                `\n                        : ''\n                }\n            </div>\n        `;\n    }\n\n    protected setupEventListeners(): void {\n        const dismissBtn = this.query('.dismiss-btn');\n        if (dismissBtn) {\n            dismissBtn.addEventListener('click', () => this.dismiss());\n        }\n    }\n\n    protected onConnected(): void {\n        // Trigger show animation\n        requestAnimationFrame(() => {\n            requestAnimationFrame(() => {\n                this.classList.add('visible');\n            });\n        });\n\n        // Auto-dismiss after duration\n        const duration = parseInt(this.getAttribute('duration') || '3000', 10);\n        if (duration > 0) {\n            this.timeoutId = window.setTimeout(() => this.dismiss(), duration);\n        }\n    }\n\n    protected onDisconnected(): void {\n        if (this.timeoutId) {\n            clearTimeout(this.timeoutId);\n        }\n    }\n\n    protected onAttributeChanged(_name: string, _oldValue: string | null, _newValue: string | null): void {\n        // Re-render when attributes change\n        this.render();\n        this.setupEventListeners();\n    }\n\n    /**\n     * Dismiss the toast\n     */\n    public dismiss(): void {\n        if (this.timeoutId) {\n            clearTimeout(this.timeoutId);\n        }\n\n        this.classList.remove('visible');\n        this.classList.add('hiding');\n\n        // Remove after animation\n        setTimeout(() => {\n            this.remove();\n        }, 300);\n    }\n\n    /**\n     * Static method to show a toast notification\n     */\n    static show(message: string, type: ToastType = 'info', options: Partial<ToastOptions> = {}): Toast {\n        const toast = document.createElement('bpt-toast') as Toast;\n        toast.setAttribute('message', message);\n        toast.setAttribute('type', type);\n\n        if (options.duration !== undefined) {\n            toast.setAttribute('duration', String(options.duration));\n        }\n        if (options.dismissible !== undefined) {\n            toast.setAttribute('dismissible', String(options.dismissible));\n        }\n\n        document.body.appendChild(toast);\n        return toast;\n    }\n\n    /**\n     * Convenience methods for different types\n     */\n    static info(message: string, options?: Partial<ToastOptions>): Toast {\n        return Toast.show(message, 'info', options);\n    }\n\n    static success(message: string, options?: Partial<ToastOptions>): Toast {\n        return Toast.show(message, 'success', options);\n    }\n\n    static error(message: string, options?: Partial<ToastOptions>): Toast {\n        return Toast.show(message, 'error', options);\n    }\n\n    static warning(message: string, options?: Partial<ToastOptions>): Toast {\n        return Toast.show(message, 'warning', options);\n    }\n}\n\n// Register the custom element\ncustomElements.define('bpt-toast', Toast);\n\n// Export for type-safe usage\ndeclare global {\n    interface HTMLElementTagNameMap {\n        'bpt-toast': Toast;\n    }\n}\n","/**\n * Notification utilities\n *\n * Displays toast-style notifications to the user.\n * Accessible to screen readers via role=\"alert\".\n *\n * Now uses the bpt-toast Web Component when available,\n * with fallback to inline styles for progressive enhancement.\n *\n * @module notifications\n */\n\nimport { Toast } from '../components/Toast.js';\n\n/**\n * Notification types\n */\nexport type NotificationType = 'info' | 'success' | 'error' | 'warning';\n\n/**\n * Show a notification to the user\n *\n * Creates an accessible toast notification that:\n * - Is announced to screen readers via role=\"alert\"\n * - Has proper color contrast (WCAG AA compliant)\n * - Respects reduced motion preferences\n *\n * @param message - The message to display\n * @param type - The type of notification (affects styling)\n * @param duration - How long to show the notification (ms)\n */\nexport function showNotification(message: string, type: NotificationType = 'info', duration = 3000): void {\n    // Use the Web Component if available\n    if (customElements.get('bpt-toast')) {\n        Toast.show(message, type, { duration });\n        return;\n    }\n\n    // Fallback to inline notification (for cases where components aren't loaded)\n    const notification = document.createElement('div');\n\n    // Use WCAG AA compliant colors\n    const backgroundColor =\n        type === 'error' ? '#b91c1c' : type === 'success' ? '#15803d' : type === 'warning' ? '#a16207' : '#1d4ed8';\n\n    notification.setAttribute('role', 'alert');\n    notification.setAttribute('aria-live', 'assertive');\n\n    notification.style.cssText = `\n    position: fixed;\n    top: 80px;\n    left: 50%;\n    transform: translateX(-50%);\n    background: ${backgroundColor};\n    color: white;\n    padding: 12px 24px;\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n    z-index: 1001;\n    font-size: 14px;\n    max-width: 90%;\n    text-align: center;\n    font-weight: 500;\n  `;\n\n    notification.textContent = message;\n    document.body.appendChild(notification);\n\n    setTimeout(() => {\n        // Check for reduced motion preference\n        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n\n        if (prefersReducedMotion) {\n            notification.remove();\n        } else {\n            notification.style.opacity = '0';\n            notification.style.transition = 'opacity 0.3s ease';\n            setTimeout(() => notification.remove(), 300);\n        }\n    }, duration);\n}\n","import { getSettings } from '../config/settings.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\n\n/**\n * Current workout metrics for announcements\n */\ninterface WorkoutMetrics {\n    power: number | null;\n    heartrate: number | null;\n    cadence: number | null;\n    speedKmh: number | null;\n    distanceKm: number | null;\n    elapsedMs: number;\n}\n\n/**\n * Calculate total distance from GPS points in km\n */\nfunction calculateTotalDistanceKm(gpsPoints: { lat: number; lon: number }[]): number {\n    if (gpsPoints.length < 2) return 0;\n\n    let totalMeters = 0;\n    const R = 6371000; // Earth radius in meters\n\n    for (let i = 1; i < gpsPoints.length; i++) {\n        const prev = gpsPoints[i - 1];\n        const curr = gpsPoints[i];\n\n        // Haversine formula\n        const lat1 = (prev.lat * Math.PI) / 180;\n        const lat2 = (curr.lat * Math.PI) / 180;\n        const deltaLat = ((curr.lat - prev.lat) * Math.PI) / 180;\n        const deltaLon = ((curr.lon - prev.lon) * Math.PI) / 180;\n\n        const a =\n            Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +\n            Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        totalMeters += R * c;\n    }\n\n    return totalMeters / 1000;\n}\n\nexport class VoiceFeedback {\n    private synth: SpeechSynthesis | null;\n    private voice: SpeechSynthesisVoice | null = null;\n    private measurementsState: MeasurementsState | null = null;\n    private timeState: TimeState | null = null;\n    private lastTimeIntervalMs: number = 0;\n    private lastDistanceIntervalKm: number = 0;\n    private checkInterval: ReturnType<typeof setInterval> | null = null;\n    private isActive: boolean = false;\n\n    constructor() {\n        if (typeof window !== 'undefined') {\n            this.synth = window.speechSynthesis || null;\n        } else {\n            this.synth = null;\n        }\n\n        if (!this.synth) {\n            console.warn('Speech Synthesis not supported on this device');\n            return;\n        }\n\n        // Wait for voices to be loaded\n        if (this.synth.onvoiceschanged !== undefined) {\n            this.synth.onvoiceschanged = () => this.loadVoice();\n        }\n        this.loadVoice();\n    }\n\n    /**\n     * Initialize with state references for enhanced announcements\n     */\n    init(measurementsState: MeasurementsState, timeState: TimeState): void {\n        this.measurementsState = measurementsState;\n        this.timeState = timeState;\n    }\n\n    /**\n     * Start interval-based announcements\n     */\n    startIntervalAnnouncements(): void {\n        if (this.isActive || !this.measurementsState || !this.timeState) {\n            return;\n        }\n\n        const settings = getSettings();\n        if (settings.enhancedVoice.timeIntervalMinutes === 0 && settings.enhancedVoice.distanceIntervalKm === 0) {\n            return;\n        }\n\n        this.isActive = true;\n        this.lastTimeIntervalMs = 0;\n        this.lastDistanceIntervalKm = 0;\n\n        // Check every second\n        this.checkInterval = setInterval(() => this.checkIntervalAnnouncements(), 1000);\n\n        console.log('Enhanced voice announcements started');\n    }\n\n    /**\n     * Stop interval-based announcements\n     */\n    stopIntervalAnnouncements(): void {\n        if (this.checkInterval) {\n            clearInterval(this.checkInterval);\n            this.checkInterval = null;\n        }\n        this.isActive = false;\n        this.lastTimeIntervalMs = 0;\n        this.lastDistanceIntervalKm = 0;\n    }\n\n    /**\n     * Reset state\n     */\n    reset(): void {\n        this.stopIntervalAnnouncements();\n    }\n\n    private loadVoice(): void {\n        if (!this.synth) return;\n\n        const voices = this.synth.getVoices();\n        // Prefer English voices\n        this.voice = voices.find((v) => v.lang.startsWith('en')) || voices[0] || null;\n    }\n\n    private formatTimeForSpeech(ms: number): string {\n        const totalSeconds = Math.floor(ms / 1000);\n        const hours = Math.floor(totalSeconds / 3600);\n        const minutes = Math.floor((totalSeconds % 3600) / 60);\n        const seconds = totalSeconds % 60;\n\n        const parts = [];\n        if (hours > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);\n        if (minutes > 0) parts.push(`${minutes} minute${minutes !== 1 ? 's' : ''}`);\n        if (seconds > 0 || parts.length === 0) parts.push(`${seconds} second${seconds !== 1 ? 's' : ''}`);\n\n        return parts.join(' ');\n    }\n\n    private formatTimeShort(ms: number): string {\n        const totalSeconds = Math.floor(ms / 1000);\n        const hours = Math.floor(totalSeconds / 3600);\n        const minutes = Math.floor((totalSeconds % 3600) / 60);\n\n        if (hours > 0) {\n            return `${hours} hour${hours !== 1 ? 's' : ''} ${minutes} minute${minutes !== 1 ? 's' : ''}`;\n        }\n        return `${minutes} minute${minutes !== 1 ? 's' : ''}`;\n    }\n\n    public speak(text: string): void {\n        if (!this.synth) return;\n\n        const settings = getSettings();\n        if (!settings.voiceEnabled) return;\n\n        if (this.synth.speaking) {\n            this.synth.cancel();\n        }\n\n        const utterance = new SpeechSynthesisUtterance(text);\n        if (this.voice) {\n            utterance.voice = this.voice;\n        }\n\n        // Apply speech rate\n        utterance.rate = settings.enhancedVoice.speechRate;\n\n        this.synth.speak(utterance);\n    }\n\n    public announceLap(lapNumber: number, timeMs: number, avgPower: number): void {\n        if (!this.synth) return;\n\n        const settings = getSettings();\n        if (!settings.voiceLaps) return;\n\n        const timeStr = this.formatTimeForSpeech(timeMs);\n        const text = `Lap ${lapNumber}. Time ${timeStr}. Average Power ${Math.round(avgPower)} watts.`;\n        this.speak(text);\n    }\n\n    public announceZoneChange(zoneName: string): void {\n        if (!this.synth) return;\n\n        const settings = getSettings();\n        if (!settings.voiceZones) return;\n\n        const text = `Entering ${zoneName} Zone`;\n        this.speak(text);\n    }\n\n    public announceCountdown(count: number): void {\n        if (!this.synth) return;\n\n        const settings = getSettings();\n        if (!settings.countdown.enableVoice) return;\n\n        const text = count === 0 ? 'Go!' : `${count}`;\n        this.speak(text);\n    }\n\n    /**\n     * Check if interval-based announcements should be triggered\n     */\n    private checkIntervalAnnouncements(): void {\n        if (!this.measurementsState || !this.timeState || !this.timeState.running) {\n            return;\n        }\n\n        const settings = getSettings();\n\n        // Check time-based announcements\n        if (settings.enhancedVoice.timeIntervalMinutes > 0) {\n            this.checkTimeAnnouncement(settings.enhancedVoice.timeIntervalMinutes);\n        }\n\n        // Check distance-based announcements\n        if (settings.enhancedVoice.distanceIntervalKm > 0) {\n            this.checkDistanceAnnouncement(settings.enhancedVoice.distanceIntervalKm);\n        }\n    }\n\n    /**\n     * Check for time-based announcements\n     */\n    private checkTimeAnnouncement(intervalMinutes: number): void {\n        if (!this.timeState || !this.timeState.startTime) return;\n\n        const elapsedMs = Date.now() - this.timeState.startTime;\n        const intervalMs = intervalMinutes * 60 * 1000;\n\n        const currentInterval = Math.floor(elapsedMs / intervalMs);\n        const lastInterval = Math.floor(this.lastTimeIntervalMs / intervalMs);\n\n        if (currentInterval > lastInterval && elapsedMs > 0) {\n            this.announceCurrentMetrics('time');\n            this.lastTimeIntervalMs = elapsedMs;\n        }\n    }\n\n    /**\n     * Check for distance-based announcements\n     */\n    private checkDistanceAnnouncement(intervalKm: number): void {\n        if (!this.measurementsState) return;\n\n        const totalKm = calculateTotalDistanceKm(this.measurementsState.gps);\n\n        const currentInterval = Math.floor(totalKm / intervalKm);\n        const lastInterval = Math.floor(this.lastDistanceIntervalKm / intervalKm);\n\n        if (currentInterval > lastInterval && totalKm > 0) {\n            this.announceCurrentMetrics('distance');\n            this.lastDistanceIntervalKm = totalKm;\n        }\n    }\n\n    /**\n     * Get current workout metrics\n     */\n    private getCurrentMetrics(): WorkoutMetrics {\n        const metrics: WorkoutMetrics = {\n            power: null,\n            heartrate: null,\n            cadence: null,\n            speedKmh: null,\n            distanceKm: null,\n            elapsedMs: 0,\n        };\n\n        if (!this.measurementsState || !this.timeState) return metrics;\n\n        // Get latest values (within last 5 seconds)\n        const now = Date.now();\n        const recentThreshold = now - 5000;\n\n        // Power\n        const recentPower = this.measurementsState.power.filter((p) => p.timestamp > recentThreshold);\n        if (recentPower.length > 0) {\n            metrics.power = Math.round(recentPower[recentPower.length - 1].value);\n        }\n\n        // Heart rate\n        const recentHr = this.measurementsState.heartrate.filter((h) => h.timestamp > recentThreshold);\n        if (recentHr.length > 0) {\n            metrics.heartrate = Math.round(recentHr[recentHr.length - 1].value);\n        }\n\n        // Cadence\n        const recentCadence = this.measurementsState.cadence.filter((c) => c.timestamp > recentThreshold);\n        if (recentCadence.length > 0) {\n            metrics.cadence = Math.round(recentCadence[recentCadence.length - 1].value);\n        }\n\n        // Speed\n        const recentSpeed = this.measurementsState.speed.filter((s) => s.timestamp > recentThreshold);\n        if (recentSpeed.length > 0) {\n            metrics.speedKmh = Math.round(recentSpeed[recentSpeed.length - 1].value * 10) / 10;\n        }\n\n        // Distance\n        metrics.distanceKm = Math.round(calculateTotalDistanceKm(this.measurementsState.gps) * 100) / 100;\n\n        // Elapsed time\n        if (this.timeState.startTime) {\n            metrics.elapsedMs = now - this.timeState.startTime;\n        }\n\n        return metrics;\n    }\n\n    /**\n     * Announce current metrics based on settings\n     */\n    private announceCurrentMetrics(trigger: 'time' | 'distance'): void {\n        const settings = getSettings();\n        const metricsSettings = settings.enhancedVoice.metrics;\n        const metrics = this.getCurrentMetrics();\n\n        const parts: string[] = [];\n\n        // Start with the trigger announcement\n        if (trigger === 'time' && metricsSettings.time) {\n            parts.push(this.formatTimeShort(metrics.elapsedMs));\n        } else if (trigger === 'distance' && metricsSettings.distance && metrics.distanceKm !== null) {\n            parts.push(`${metrics.distanceKm.toFixed(1)} kilometers`);\n        }\n\n        // Add other metrics based on settings\n        if (metricsSettings.power && metrics.power !== null) {\n            parts.push(`power ${metrics.power} watts`);\n        }\n\n        if (metricsSettings.heartrate && metrics.heartrate !== null) {\n            parts.push(`heart rate ${metrics.heartrate}`);\n        }\n\n        if (metricsSettings.speed && metrics.speedKmh !== null) {\n            parts.push(`speed ${metrics.speedKmh.toFixed(1)} k p h`);\n        }\n\n        if (metricsSettings.cadence && metrics.cadence !== null) {\n            parts.push(`cadence ${metrics.cadence}`);\n        }\n\n        // Include distance if not already the trigger\n        if (trigger === 'time' && metricsSettings.distance && metrics.distanceKm !== null && metrics.distanceKm > 0) {\n            parts.push(`distance ${metrics.distanceKm.toFixed(1)} kilometers`);\n        }\n\n        // Include time if not already the trigger\n        if (trigger === 'distance' && metricsSettings.time) {\n            parts.push(`time ${this.formatTimeShort(metrics.elapsedMs)}`);\n        }\n\n        if (parts.length > 0) {\n            const text = parts.join('. ') + '.';\n            this.speak(text);\n            console.log(`Voice announcement (${trigger}): ${text}`);\n        }\n    }\n}\n\nexport const voiceFeedback = new VoiceFeedback();\n","/**\n * Workout Countdown Overlay\n *\n * Shows a countdown before starting a workout.\n * Supports visual, audio (beep), and voice announcements.\n *\n * @module ui/countdown\n */\n\nimport { getSettings } from '../config/settings.js';\nimport { voiceFeedback } from '../services/VoiceFeedback.js';\nimport { announce } from './accessibility.js';\n\n/**\n * Show countdown overlay and execute callback when complete\n *\n * @param onComplete - Callback to execute after countdown finishes\n * @returns Promise that resolves when countdown is complete or cancelled\n */\nexport async function showCountdown(onComplete: () => void): Promise<void> {\n    const settings = getSettings();\n    const duration = settings.countdown.duration;\n\n    // If countdown is disabled (duration = 0), immediately execute callback\n    if (duration === 0) {\n        onComplete();\n        return;\n    }\n\n    return new Promise((resolve) => {\n        // Create overlay\n        const overlay = createCountdownOverlay();\n        document.body.appendChild(overlay);\n\n        let currentCount = duration;\n        let intervalId: number;\n        let isCancelled = false;\n\n        // Update display\n        const updateDisplay = (count: number) => {\n            const countElement = overlay.querySelector('.countdown__number') as HTMLElement;\n            if (countElement) {\n                countElement.textContent = count === 0 ? 'GO!' : count.toString();\n                countElement.className = 'countdown__number';\n\n                // Add animation class\n                requestAnimationFrame(() => {\n                    countElement.classList.add('countdown__number--pulse');\n                });\n            }\n\n            // Voice announcement\n            if (settings.countdown.enableVoice) {\n                voiceFeedback.announceCountdown(count);\n            }\n\n            // Beep sound\n            if (settings.countdown.enableBeep) {\n                playBeep(count === 0);\n            }\n\n            // Screen reader announcement\n            const text = count === 0 ? 'Go! Workout starting' : `${count}`;\n            announce(text, 'assertive');\n        };\n\n        // Cancel button handler\n        const cancelBtn = overlay.querySelector('.countdown__cancel') as HTMLButtonElement;\n        const handleCancel = () => {\n            isCancelled = true;\n            clearInterval(intervalId);\n            document.body.removeChild(overlay);\n            announce('Countdown cancelled', 'assertive');\n            resolve();\n        };\n        cancelBtn?.addEventListener('click', handleCancel);\n\n        // ESC key to cancel\n        const handleKeydown = (e: KeyboardEvent) => {\n            if (e.key === 'Escape') {\n                handleCancel();\n                document.removeEventListener('keydown', handleKeydown);\n            }\n        };\n        document.addEventListener('keydown', handleKeydown);\n\n        // Start countdown\n        updateDisplay(currentCount);\n\n        intervalId = window.setInterval(() => {\n            currentCount--;\n\n            if (currentCount >= 0) {\n                updateDisplay(currentCount);\n            }\n\n            if (currentCount < 0) {\n                clearInterval(intervalId);\n                document.removeEventListener('keydown', handleKeydown);\n\n                if (!isCancelled) {\n                    // Remove overlay\n                    document.body.removeChild(overlay);\n\n                    // Execute callback\n                    onComplete();\n                }\n\n                resolve();\n            }\n        }, 1000);\n    });\n}\n\n/**\n * Create countdown overlay DOM element\n */\nfunction createCountdownOverlay(): HTMLElement {\n    const overlay = document.createElement('div');\n    overlay.className = 'countdown-overlay';\n    overlay.setAttribute('role', 'alertdialog');\n    overlay.setAttribute('aria-labelledby', 'countdownTitle');\n    overlay.setAttribute('aria-live', 'assertive');\n\n    overlay.innerHTML = `\n        <div class=\"countdown__backdrop\"></div>\n        <div class=\"countdown__content\">\n            <h2 id=\"countdownTitle\" class=\"countdown__title\">Get Ready!</h2>\n            <div class=\"countdown__number\"></div>\n            <button class=\"countdown__cancel\" aria-label=\"Cancel countdown\">\n                Cancel (ESC)\n            </button>\n        </div>\n    `;\n\n    return overlay;\n}\n\n/**\n * Play a beep sound using Web Audio API\n *\n * @param isFinal - If true, plays a higher-pitched \"go\" beep\n */\nfunction playBeep(isFinal: boolean = false): void {\n    try {\n        const audioContext = new (window.AudioContext || window.webkitAudioContext)();\n        const oscillator = audioContext.createOscillator();\n        const gainNode = audioContext.createGain();\n\n        oscillator.connect(gainNode);\n        gainNode.connect(audioContext.destination);\n\n        // Frequency: Higher for final beep\n        oscillator.frequency.value = isFinal ? 880 : 440; // A5 or A4\n        oscillator.type = 'sine';\n\n        // Volume envelope\n        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);\n        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);\n\n        oscillator.start(audioContext.currentTime);\n        oscillator.stop(audioContext.currentTime + 0.1);\n    } catch (error) {\n        console.warn('Failed to play beep:', error);\n    }\n}\n","/**\n * Timer Display Initialization\n *\n * Sets up the workout timer display and Garmin-style workout controls.\n *\n * Workout states:\n * - Idle: Not started, show Start button\n * - Recording: Timer running, show Pause button\n * - Paused: Timer paused, show Resume and Stop buttons\n *\n * @module time\n */\n\nimport { getTimestring } from '../getTimestring.js';\nimport { announce, updateWorkoutControlsAccessibility } from './accessibility.js';\nimport { onWorkoutStart, onWorkoutPause } from './workoutPlayer.js';\nimport { showNotification } from './notifications.js';\nimport { showCountdown } from './countdown.js';\nimport type { TimeState } from '../getInitState.js';\n\n/**\n * Workout state enum for clarity\n */\nexport type WorkoutState = 'idle' | 'recording' | 'paused';\n\n/**\n * Get the current workout state from time state\n */\nexport function getWorkoutState(timeState: TimeState): WorkoutState {\n    if (!timeState.startTime) {\n        return 'idle';\n    }\n    if (timeState.running) {\n        return 'recording';\n    }\n    return 'paused';\n}\n\n/**\n * Workout control button elements\n */\ninterface WorkoutControlElements {\n    startButton: HTMLButtonElement;\n    pauseButton: HTMLButtonElement;\n    resumeButton: HTMLButtonElement;\n    stopButton: HTMLButtonElement;\n}\n\n/**\n * Update button visibility based on workout state\n */\nfunction updateButtonVisibility(elements: WorkoutControlElements, state: WorkoutState): void {\n    const { startButton, pauseButton, resumeButton, stopButton } = elements;\n\n    // Hide all buttons first\n    startButton.style.display = 'none';\n    pauseButton.style.display = 'none';\n    resumeButton.style.display = 'none';\n    stopButton.style.display = 'none';\n\n    switch (state) {\n        case 'idle':\n            startButton.style.display = 'inline-flex';\n            break;\n        case 'recording':\n            pauseButton.style.display = 'inline-flex';\n            break;\n        case 'paused':\n            resumeButton.style.display = 'inline-flex';\n            stopButton.style.display = 'inline-flex';\n            break;\n    }\n}\n\n/** Module-level reference to control elements for programmatic access */\nlet workoutControlElements: WorkoutControlElements | null = null;\n\n/**\n * Programmatically pause the workout (used by AutoPauseService)\n * @param timeState - The workout time state object\n * @param isAutoPause - Whether this is triggered by auto-pause (shows notification)\n */\nexport function pauseWorkout(timeState: TimeState, isAutoPause = false): void {\n    if (!timeState.running || !timeState.startTime) {\n        return;\n    }\n\n    timeState.running = false;\n    timeState.endTime = Date.now();\n\n    onWorkoutPause();\n\n    if (workoutControlElements) {\n        updateButtonVisibility(workoutControlElements, 'paused');\n    }\n    updateWorkoutControlsAccessibility('paused');\n\n    if (isAutoPause) {\n        showNotification(' Auto-paused', 'info');\n        announce('Auto paused due to low activity', 'polite');\n    } else {\n        announce('Workout paused. Press resume to continue or stop to save.', 'assertive');\n    }\n}\n\n/**\n * Programmatically resume the workout (used by AutoPauseService)\n * @param timeState - The workout time state object\n * @param isAutoResume - Whether this is triggered by auto-resume (shows notification)\n */\nexport function resumeWorkout(timeState: TimeState, isAutoResume = false): void {\n    if (timeState.running || !timeState.startTime) {\n        return;\n    }\n\n    if (timeState.endTime && timeState.startTime) {\n        // Adjust startTime to account for paused duration\n        const pausedDuration = Date.now() - timeState.endTime;\n        timeState.startTime += pausedDuration;\n    }\n    timeState.endTime = null;\n    timeState.running = true;\n\n    onWorkoutStart();\n\n    if (workoutControlElements) {\n        updateButtonVisibility(workoutControlElements, 'recording');\n    }\n    updateWorkoutControlsAccessibility('recording');\n\n    if (isAutoResume) {\n        showNotification(' Auto-resumed', 'info');\n        announce('Auto resumed', 'polite');\n    } else {\n        announce('Workout resumed', 'assertive');\n    }\n}\n\n/**\n * Initialize the timer display and Garmin-style workout controls.\n *\n * Sets up:\n * - Timer display that updates every 100ms\n * - Start button to begin a new workout\n * - Pause button to pause recording\n * - Resume button to continue a paused workout\n * - Stop button to end and save the workout\n * - Visual state changes for workout status\n *\n * @param timeState - The workout time state object\n */\nexport const initTimerDisplay = (timeState: TimeState): void => {\n    const startButton = document.getElementById('startButton') as HTMLButtonElement | null;\n    const pauseButton = document.getElementById('pauseButton') as HTMLButtonElement | null;\n    const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n    const stopButton = document.getElementById('stopButton') as HTMLButtonElement | null;\n    const timeElement = document.getElementById('time');\n\n    if (!startButton || !pauseButton || !resumeButton || !stopButton || !timeElement) {\n        console.warn('Workout control elements not found in DOM');\n        return;\n    }\n\n    const elements: WorkoutControlElements = {\n        startButton,\n        pauseButton,\n        resumeButton,\n        stopButton,\n    };\n\n    // Store reference for programmatic access\n    workoutControlElements = elements;\n\n    // Update timer display every 100ms\n    setInterval(() => {\n        let nextText = '00:00:00';\n\n        if (timeState.startTime && timeState.running) {\n            const elapsedMs = Date.now() - timeState.startTime;\n            nextText = getTimestring(elapsedMs);\n        } else if (timeState.startTime && timeState.endTime) {\n            const elapsedMs = timeState.endTime - timeState.startTime;\n            nextText = getTimestring(elapsedMs);\n        }\n\n        if (timeElement.textContent !== nextText) {\n            timeElement.textContent = nextText;\n        }\n    }, 100);\n\n    // Initialize button visibility\n    updateButtonVisibility(elements, getWorkoutState(timeState));\n\n    // Helper to add robust touch/click listeners\n    const addListener = (btn: HTMLButtonElement, callback: () => void) => {\n        const handler = (e: Event) => {\n            e.stopPropagation();\n            e.preventDefault();\n            callback();\n        };\n        btn.addEventListener('click', handler);\n    };\n\n    // Handle Start button click - begin new workout with countdown\n    addListener(startButton, () => {\n        console.log('[time.ts] Start button clicked');\n\n        // Show countdown overlay (if enabled), then start workout\n        showCountdown(() => {\n            timeState.startTime = Date.now();\n            timeState.endTime = null;\n            timeState.running = true;\n\n            onWorkoutStart();\n\n            updateButtonVisibility(elements, 'recording');\n            updateWorkoutControlsAccessibility('recording');\n            announce('Workout started', 'assertive');\n\n            // Dispatch event so auto-pause service can start monitoring\n            document.dispatchEvent(new CustomEvent('workoutStarted'));\n        });\n    });\n\n    // Handle Pause button click - pause recording\n    addListener(pauseButton, () => {\n        pauseWorkout(timeState, false);\n    });\n\n    // Handle Resume button click - continue paused workout\n    addListener(resumeButton, () => {\n        resumeWorkout(timeState, false);\n    });\n\n    // Handle Stop button click - end and save workout\n    addListener(stopButton, () => {\n        // Keep endTime as is (already set when paused)\n        // Reset to idle state for next workout\n        timeState.running = false;\n\n        onWorkoutPause();\n\n        updateButtonVisibility(elements, 'paused');\n        updateWorkoutControlsAccessibility('paused');\n        announce('Workout stopped and saved. Press resume to continue or export your data.', 'assertive');\n\n        // Dispatch custom event for workout completion\n        const workoutCompleteEvent = new CustomEvent('workoutComplete', {\n            detail: {\n                startTime: timeState.startTime,\n                endTime: timeState.endTime,\n                duration: timeState.endTime && timeState.startTime ? timeState.endTime - timeState.startTime : 0,\n            },\n        });\n        document.dispatchEvent(workoutCompleteEvent);\n    });\n};\n\n/**\n * Reset workout to idle state\n *\n * @param timeState - The workout time state object\n */\nexport function resetWorkout(timeState: TimeState): void {\n    timeState.startTime = null;\n    timeState.endTime = null;\n    timeState.running = false;\n\n    const startButton = document.getElementById('startButton') as HTMLButtonElement | null;\n    const pauseButton = document.getElementById('pauseButton') as HTMLButtonElement | null;\n    const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n    const stopButton = document.getElementById('stopButton') as HTMLButtonElement | null;\n\n    if (startButton && pauseButton && resumeButton && stopButton) {\n        updateButtonVisibility({ startButton, pauseButton, resumeButton, stopButton }, 'idle');\n        updateWorkoutControlsAccessibility('idle');\n    }\n\n    announce('Workout reset', 'polite');\n}\n","/**\n * CSV export utilities\n *\n * @module create-csv\n */\n\nimport { mergeMeasurements, type MergedDataPoint } from './merge-measurements.js';\nimport type { MeasurementsData, LapMarker } from './types/measurements.js';\n\n/**\n * Determines which lap a timestamp belongs to\n */\nfunction getLapNumber(timestamp: number, laps: LapMarker[]): number {\n    if (laps.length === 0) return 1;\n\n    let lapNumber = 1;\n    for (const lap of laps) {\n        if (timestamp >= lap.timestamp) {\n            lapNumber = lap.number + 1;\n        } else {\n            break;\n        }\n    }\n    return lapNumber;\n}\n\n/**\n * Creates a CSV string from workout measurements.\n *\n * Merges all measurement types (heart rate, cadence, power) into synchronized\n * data points and exports them as a CSV file with ISO timestamps.\n * Includes lap number for each data point.\n *\n * @param measurements - The measurements data object containing workout data\n * @returns CSV formatted string with header row\n *\n * @example\n * const csv = getCsvString(measurementsState);\n * // Returns:\n * // \"timestamp,lap,power,cadence,heartrate,speed,distance,altitude,lat,lon\n * //  2024-01-01T00:00:00.000Z,1,200,80,120,25.5,1000,100,52.123456,5.123456\n * //  ...\"\n */\nexport const getCsvString = (measurements: MeasurementsData): string => {\n    const dataPoints = mergeMeasurements(measurements);\n\n    if (!dataPoints || dataPoints.length === 0) {\n        return '';\n    }\n\n    const laps = measurements.laps || [];\n\n    // CSV header - now includes lap column\n    const header = 'timestamp,lap,power,cadence,heartrate,speed,distance,altitude,lat,lon';\n\n    // Convert each data point to CSV row\n    const rows = dataPoints.map((point: MergedDataPoint) => {\n        const timestamp = new Date(point.timestamp).toISOString();\n        const lap = getLapNumber(point.timestamp, laps);\n        const power = point.power !== null ? Math.round(point.power) : '';\n        const cadence = point.cadence !== null ? Math.round(point.cadence) : '';\n        const heartrate = point.heartrate !== null ? Math.round(point.heartrate) : '';\n        const speed = point.speed !== null ? point.speed.toFixed(1) : '';\n        const distance = point.distance !== null ? Math.round(point.distance) : '';\n        const altitude = point.altitude !== null ? Math.round(point.altitude) : '';\n        const lat = point.lat !== null ? point.lat.toFixed(6) : '';\n        const lon = point.lon !== null ? point.lon.toFixed(6) : '';\n\n        return `${timestamp},${lap},${power},${cadence},${heartrate},${speed},${distance},${altitude},${lat},${lon}`;\n    });\n\n    return [header, ...rows].join('\\n');\n};\n","/**\n * FIT (Flexible and Interoperable Data Transfer) export utilities\n *\n * Creates Garmin FIT files from workout measurements.\n * FIT is a binary format optimized for storing and sharing fitness data.\n *\n * @module create-fit\n */\n\nimport { mergeMeasurements } from './merge-measurements.js';\nimport type { MeasurementsData } from './types/measurements.js';\nimport type { SportType } from './config/sport.js';\n\n// FIT Protocol Constants\nconst FIT_PROTOCOL_VERSION = 0x20; // 2.0\nconst FIT_PROFILE_VERSION = 0x0813; // 20.83\n\n// FIT Message Numbers\nconst FIT_MESG_FILE_ID = 0;\nconst FIT_MESG_FILE_CREATOR = 1;\nconst FIT_MESG_ACTIVITY = 34;\nconst FIT_MESG_SESSION = 18;\nconst FIT_MESG_LAP = 19;\nconst FIT_MESG_RECORD = 20;\nconst FIT_MESG_EVENT = 21;\n\n// FIT Base Types (only used types are uncommented)\nconst FIT_BASE_TYPE_ENUM = 0x00;\n// const FIT_BASE_TYPE_SINT8 = 0x01;\nconst FIT_BASE_TYPE_UINT8 = 0x02;\n// const FIT_BASE_TYPE_SINT16 = 0x83;\nconst FIT_BASE_TYPE_UINT16 = 0x84;\n// const FIT_BASE_TYPE_SINT32 = 0x85;\nconst FIT_BASE_TYPE_UINT32 = 0x86;\n// const FIT_BASE_TYPE_STRING = 0x07;\n\n// FIT Field IDs for File ID message\nconst FILE_ID_TYPE = 0;\nconst FILE_ID_MANUFACTURER = 1;\nconst FILE_ID_PRODUCT = 2;\nconst FILE_ID_SERIAL_NUMBER = 3;\nconst FILE_ID_TIME_CREATED = 4;\n\n// FIT Field IDs for Record message\nconst RECORD_TIMESTAMP = 253;\nconst RECORD_HEART_RATE = 3;\nconst RECORD_CADENCE = 4;\nconst RECORD_POWER = 7;\n\n// FIT Field IDs for Session message\nconst SESSION_TIMESTAMP = 253;\nconst SESSION_START_TIME = 2;\nconst SESSION_TOTAL_ELAPSED_TIME = 7;\nconst SESSION_TOTAL_TIMER_TIME = 8;\nconst SESSION_TOTAL_DISTANCE = 9;\nconst SESSION_TOTAL_CALORIES = 11;\nconst SESSION_SPORT = 5;\nconst SESSION_SUB_SPORT = 6;\nconst SESSION_EVENT = 0;\nconst SESSION_EVENT_TYPE = 1;\n\n// FIT Field IDs for Lap message\nconst LAP_TIMESTAMP = 253;\nconst LAP_START_TIME = 2;\nconst LAP_TOTAL_ELAPSED_TIME = 7;\nconst LAP_TOTAL_TIMER_TIME = 8;\nconst LAP_TOTAL_DISTANCE = 9;\nconst LAP_TOTAL_CALORIES = 11;\nconst LAP_EVENT = 0;\nconst LAP_EVENT_TYPE = 1;\n\n// FIT Field IDs for Event message\nconst EVENT_TIMESTAMP = 253;\nconst EVENT_EVENT = 0;\nconst EVENT_EVENT_TYPE = 1;\n\n// FIT Field IDs for Activity message\nconst ACTIVITY_TIMESTAMP = 253;\nconst ACTIVITY_TOTAL_TIMER_TIME = 0;\nconst ACTIVITY_NUM_SESSIONS = 1;\nconst ACTIVITY_TYPE = 2;\nconst ACTIVITY_EVENT = 3;\nconst ACTIVITY_EVENT_TYPE = 4;\nconst ACTIVITY_LOCAL_TIMESTAMP = 5;\n\n// FIT Type values\nconst FILE_TYPE_ACTIVITY = 4;\nconst MANUFACTURER_DEVELOPMENT = 255;\nconst SPORT_CYCLING = 2;\nconst SPORT_RUNNING = 1;\nconst SPORT_WALKING = 11;\nconst SUB_SPORT_INDOOR_CYCLING = 6;\nconst SUB_SPORT_GENERIC = 0;\nconst EVENT_TIMER = 0;\nconst EVENT_SESSION = 8;\nconst EVENT_LAP = 9;\nconst EVENT_ACTIVITY = 26;\nconst EVENT_TYPE_START = 0;\nconst EVENT_TYPE_STOP = 1;\nconst ACTIVITY_TYPE_MANUAL = 0;\n\n// FIT timestamp epoch (1989-12-31 00:00:00 UTC)\nconst FIT_EPOCH_MS = Date.UTC(1989, 11, 31, 0, 0, 0);\n\n/**\n * Calculate CRC-16 (CCITT) for FIT file\n */\nfunction calculateCrc(buffer: Uint8Array, start: number, end: number): number {\n    const crcTable = [\n        0x0000, 0xcc01, 0xd801, 0x1400, 0xf001, 0x3c00, 0x2800, 0xe401, 0xa001, 0x6c00, 0x7800, 0xb401, 0x5000, 0x9c01,\n        0x8801, 0x4400,\n    ];\n\n    let crc = 0;\n    for (let i = start; i < end; i++) {\n        const byte = buffer[i];\n        // Low nibble\n        let tmp = crcTable[crc & 0xf];\n        crc = (crc >> 4) & 0x0fff;\n        crc = crc ^ tmp ^ crcTable[byte & 0xf];\n        // High nibble\n        tmp = crcTable[crc & 0xf];\n        crc = (crc >> 4) & 0x0fff;\n        crc = crc ^ tmp ^ crcTable[(byte >> 4) & 0xf];\n    }\n    return crc;\n}\n\n/**\n * Convert JavaScript timestamp to FIT timestamp\n */\nfunction toFitTimestamp(jsTimestamp: number): number {\n    return Math.round((jsTimestamp - FIT_EPOCH_MS) / 1000);\n}\n\n/**\n * FIT file builder class\n */\nclass FitBuilder {\n    private buffer: number[] = [];\n    private definedMessages: Map<number, boolean> = new Map();\n\n    /**\n     * Write header (14 bytes)\n     */\n    writeHeader(): void {\n        // Header size (1 byte)\n        this.buffer.push(14);\n        // Protocol version (1 byte)\n        this.buffer.push(FIT_PROTOCOL_VERSION);\n        // Profile version (2 bytes, little-endian)\n        this.buffer.push(FIT_PROFILE_VERSION & 0xff);\n        this.buffer.push((FIT_PROFILE_VERSION >> 8) & 0xff);\n        // Data size placeholder (4 bytes) - will be updated later\n        this.buffer.push(0, 0, 0, 0);\n        // Data type \".FIT\" (4 bytes)\n        this.buffer.push(0x2e, 0x46, 0x49, 0x54); // \".FIT\"\n        // CRC (2 bytes) - will be updated later\n        this.buffer.push(0, 0);\n    }\n\n    /**\n     * Write definition message\n     */\n    writeDefinition(\n        localMsgType: number,\n        globalMsgNum: number,\n        fields: { fieldDefNum: number; size: number; baseType: number }[]\n    ): void {\n        // Record header: definition message (bit 6 = 1)\n        this.buffer.push(0x40 | (localMsgType & 0x0f));\n        // Reserved byte\n        this.buffer.push(0);\n        // Architecture (0 = little-endian)\n        this.buffer.push(0);\n        // Global message number (2 bytes, little-endian)\n        this.buffer.push(globalMsgNum & 0xff);\n        this.buffer.push((globalMsgNum >> 8) & 0xff);\n        // Number of fields\n        this.buffer.push(fields.length);\n        // Field definitions\n        for (const field of fields) {\n            this.buffer.push(field.fieldDefNum);\n            this.buffer.push(field.size);\n            this.buffer.push(field.baseType);\n        }\n        this.definedMessages.set(localMsgType, true);\n    }\n\n    /**\n     * Write data message\n     */\n    writeData(localMsgType: number, values: (number | null)[]): void {\n        // Record header: data message (bit 6 = 0)\n        this.buffer.push(localMsgType & 0x0f);\n        // Field values\n        for (const value of values) {\n            if (typeof value === 'number') {\n                // Handled by caller based on field size\n            }\n        }\n    }\n\n    /**\n     * Write uint8 value\n     */\n    writeUint8(value: number): void {\n        this.buffer.push(value & 0xff);\n    }\n\n    /**\n     * Write uint16 value (little-endian)\n     */\n    writeUint16(value: number): void {\n        this.buffer.push(value & 0xff);\n        this.buffer.push((value >> 8) & 0xff);\n    }\n\n    /**\n     * Write uint32 value (little-endian)\n     */\n    writeUint32(value: number): void {\n        this.buffer.push(value & 0xff);\n        this.buffer.push((value >> 8) & 0xff);\n        this.buffer.push((value >> 16) & 0xff);\n        this.buffer.push((value >> 24) & 0xff);\n    }\n\n    /**\n     * Write data message header\n     */\n    writeDataHeader(localMsgType: number): void {\n        this.buffer.push(localMsgType & 0x0f);\n    }\n\n    /**\n     * Finalize the FIT file with CRC\n     */\n    finalize(): Uint8Array {\n        const result = new Uint8Array(this.buffer);\n\n        // Update data size in header (bytes 4-7)\n        const dataSize = this.buffer.length - 14; // Exclude header\n        result[4] = dataSize & 0xff;\n        result[5] = (dataSize >> 8) & 0xff;\n        result[6] = (dataSize >> 16) & 0xff;\n        result[7] = (dataSize >> 24) & 0xff;\n\n        // Calculate header CRC (bytes 12-13)\n        const headerCrc = calculateCrc(result, 0, 12);\n        result[12] = headerCrc & 0xff;\n        result[13] = (headerCrc >> 8) & 0xff;\n\n        // Calculate and append data CRC\n        const dataCrc = calculateCrc(result, 0, result.length);\n        const finalBuffer = new Uint8Array(result.length + 2);\n        finalBuffer.set(result);\n        finalBuffer[result.length] = dataCrc & 0xff;\n        finalBuffer[result.length + 1] = (dataCrc >> 8) & 0xff;\n\n        return finalBuffer;\n    }\n\n    /**\n     * Get current buffer as array\n     */\n    getBuffer(): number[] {\n        return this.buffer;\n    }\n}\n\n/**\n * Map internal sport type to FIT sport and sub-sport values\n */\nfunction getFitSportValues(sport?: SportType): { sport: number; subSport: number } {\n    switch (sport) {\n        case 'running':\n            return { sport: SPORT_RUNNING, subSport: SUB_SPORT_GENERIC };\n        case 'walking':\n            return { sport: SPORT_WALKING, subSport: SUB_SPORT_GENERIC };\n        case 'cycling':\n        default:\n            return { sport: SPORT_CYCLING, subSport: SUB_SPORT_INDOOR_CYCLING };\n    }\n}\n\n/**\n * Creates a Garmin FIT binary file from workout measurements.\n *\n * FIT (Flexible and Interoperable Data Transfer) is a binary format\n * used by Garmin devices and supported by most fitness platforms.\n *\n * @param measurements - The measurements data object containing workout data\n * @param sport - Optional sport type for the activity (defaults to cycling)\n * @returns FIT binary data as Uint8Array, or null if no data\n *\n * @example\n * const fitData = getFitData(measurementsState, 'running');\n * if (fitData) {\n *     const blob = new Blob([fitData], { type: 'application/fit' });\n *     // Download or upload the file\n * }\n */\nexport const getFitData = (measurements: MeasurementsData, sport?: SportType): Uint8Array | null => {\n    const dataPoints = mergeMeasurements(measurements);\n\n    if (!dataPoints || dataPoints.length === 0) {\n        return null;\n    }\n\n    const fitSportValues = getFitSportValues(sport);\n    const fit = new FitBuilder();\n    fit.writeHeader();\n\n    const firstTimestamp = dataPoints[0].timestamp;\n    const lastTimestamp = dataPoints[dataPoints.length - 1].timestamp;\n    const fitStartTime = toFitTimestamp(firstTimestamp);\n    const fitEndTime = toFitTimestamp(lastTimestamp);\n    const totalElapsedTime = (lastTimestamp - firstTimestamp) / 1000; // seconds\n    const totalElapsedTimeMs = Math.round(totalElapsedTime * 1000); // milliseconds for FIT\n\n    // Calculate totals\n    const validEnergy = dataPoints.filter((p) => p.energy !== null);\n    const totalCalories =\n        validEnergy.length > 0\n            ? Math.round(validEnergy[validEnergy.length - 1].energy! - (validEnergy[0].energy || 0))\n            : 0;\n\n    const validDistance = dataPoints.filter((p) => p.distance !== null);\n    const totalDistance =\n        validDistance.length > 0 && validDistance[validDistance.length - 1].distance! > (validDistance[0].distance || 0)\n            ? Math.round(validDistance[validDistance.length - 1].distance! - (validDistance[0].distance || 0))\n            : 0;\n\n    // Local message type assignments\n    const LOCAL_FILE_ID = 0;\n    const LOCAL_FILE_CREATOR = 1;\n    const LOCAL_EVENT = 2;\n    const LOCAL_RECORD = 3;\n    const LOCAL_LAP = 4;\n    const LOCAL_SESSION = 5;\n    const LOCAL_ACTIVITY = 6;\n\n    // === File ID Message ===\n    fit.writeDefinition(LOCAL_FILE_ID, FIT_MESG_FILE_ID, [\n        { fieldDefNum: FILE_ID_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: FILE_ID_MANUFACTURER, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n        { fieldDefNum: FILE_ID_PRODUCT, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n        { fieldDefNum: FILE_ID_SERIAL_NUMBER, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: FILE_ID_TIME_CREATED, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n    ]);\n    fit.writeDataHeader(LOCAL_FILE_ID);\n    fit.writeUint8(FILE_TYPE_ACTIVITY);\n    fit.writeUint16(MANUFACTURER_DEVELOPMENT);\n    fit.writeUint16(1); // Product ID\n    fit.writeUint32(12345678); // Serial number\n    fit.writeUint32(fitStartTime);\n\n    // === File Creator Message ===\n    fit.writeDefinition(LOCAL_FILE_CREATOR, FIT_MESG_FILE_CREATOR, [\n        { fieldDefNum: 0, size: 2, baseType: FIT_BASE_TYPE_UINT16 }, // software_version\n        { fieldDefNum: 1, size: 1, baseType: FIT_BASE_TYPE_UINT8 }, // hardware_version\n    ]);\n    fit.writeDataHeader(LOCAL_FILE_CREATOR);\n    fit.writeUint16(100); // Software version\n    fit.writeUint8(1); // Hardware version\n\n    // === Timer Start Event ===\n    fit.writeDefinition(LOCAL_EVENT, FIT_MESG_EVENT, [\n        { fieldDefNum: EVENT_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: EVENT_EVENT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: EVENT_EVENT_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n    ]);\n    fit.writeDataHeader(LOCAL_EVENT);\n    fit.writeUint32(fitStartTime);\n    fit.writeUint8(EVENT_TIMER);\n    fit.writeUint8(EVENT_TYPE_START);\n\n    // === Record Messages (one per data point) ===\n    fit.writeDefinition(LOCAL_RECORD, FIT_MESG_RECORD, [\n        { fieldDefNum: RECORD_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: RECORD_HEART_RATE, size: 1, baseType: FIT_BASE_TYPE_UINT8 },\n        { fieldDefNum: RECORD_CADENCE, size: 1, baseType: FIT_BASE_TYPE_UINT8 },\n        { fieldDefNum: RECORD_POWER, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n    ]);\n\n    for (const point of dataPoints) {\n        const fitTimestamp = toFitTimestamp(point.timestamp);\n        fit.writeDataHeader(LOCAL_RECORD);\n        fit.writeUint32(fitTimestamp);\n        // Heart rate (0xFF = invalid)\n        fit.writeUint8(point.heartrate !== null ? Math.min(255, Math.round(point.heartrate)) : 0xff);\n        // Cadence (0xFF = invalid)\n        fit.writeUint8(point.cadence !== null ? Math.min(255, Math.round(point.cadence)) : 0xff);\n        // Power (0xFFFF = invalid)\n        fit.writeUint16(point.power !== null ? Math.round(point.power) : 0xffff);\n    }\n\n    // === Timer Stop Event ===\n    fit.writeDataHeader(LOCAL_EVENT);\n    fit.writeUint32(fitEndTime);\n    fit.writeUint8(EVENT_TIMER);\n    fit.writeUint8(EVENT_TYPE_STOP);\n\n    // === Lap Message ===\n    fit.writeDefinition(LOCAL_LAP, FIT_MESG_LAP, [\n        { fieldDefNum: LAP_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: LAP_START_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: LAP_TOTAL_ELAPSED_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: LAP_TOTAL_TIMER_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: LAP_TOTAL_DISTANCE, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: LAP_TOTAL_CALORIES, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n        { fieldDefNum: LAP_EVENT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: LAP_EVENT_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n    ]);\n    fit.writeDataHeader(LOCAL_LAP);\n    fit.writeUint32(fitEndTime);\n    fit.writeUint32(fitStartTime);\n    fit.writeUint32(totalElapsedTimeMs);\n    fit.writeUint32(totalElapsedTimeMs); // Timer time same as elapsed\n    fit.writeUint32(totalDistance);\n    fit.writeUint16(totalCalories);\n    fit.writeUint8(EVENT_LAP);\n    fit.writeUint8(EVENT_TYPE_STOP);\n\n    // === Session Message ===\n    fit.writeDefinition(LOCAL_SESSION, FIT_MESG_SESSION, [\n        { fieldDefNum: SESSION_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: SESSION_START_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: SESSION_TOTAL_ELAPSED_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: SESSION_TOTAL_TIMER_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: SESSION_TOTAL_DISTANCE, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: SESSION_TOTAL_CALORIES, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n        { fieldDefNum: SESSION_SPORT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: SESSION_SUB_SPORT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: SESSION_EVENT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: SESSION_EVENT_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n    ]);\n    fit.writeDataHeader(LOCAL_SESSION);\n    fit.writeUint32(fitEndTime);\n    fit.writeUint32(fitStartTime);\n    fit.writeUint32(totalElapsedTimeMs);\n    fit.writeUint32(totalElapsedTimeMs);\n    fit.writeUint32(totalDistance);\n    fit.writeUint16(totalCalories);\n    fit.writeUint8(fitSportValues.sport);\n    fit.writeUint8(fitSportValues.subSport);\n    fit.writeUint8(EVENT_SESSION);\n    fit.writeUint8(EVENT_TYPE_STOP);\n\n    // === Activity Message ===\n    fit.writeDefinition(LOCAL_ACTIVITY, FIT_MESG_ACTIVITY, [\n        { fieldDefNum: ACTIVITY_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: ACTIVITY_TOTAL_TIMER_TIME, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n        { fieldDefNum: ACTIVITY_NUM_SESSIONS, size: 2, baseType: FIT_BASE_TYPE_UINT16 },\n        { fieldDefNum: ACTIVITY_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: ACTIVITY_EVENT, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: ACTIVITY_EVENT_TYPE, size: 1, baseType: FIT_BASE_TYPE_ENUM },\n        { fieldDefNum: ACTIVITY_LOCAL_TIMESTAMP, size: 4, baseType: FIT_BASE_TYPE_UINT32 },\n    ]);\n    fit.writeDataHeader(LOCAL_ACTIVITY);\n    fit.writeUint32(fitEndTime);\n    fit.writeUint32(totalElapsedTimeMs);\n    fit.writeUint16(1); // Number of sessions\n    fit.writeUint8(ACTIVITY_TYPE_MANUAL);\n    fit.writeUint8(EVENT_ACTIVITY);\n    fit.writeUint8(EVENT_TYPE_STOP);\n    fit.writeUint32(fitEndTime); // Local timestamp\n\n    return fit.finalize();\n};\n","/**\n * Modal Component\n *\n * Reusable modal dialog system for confirmations and content display.\n * Fully accessible with keyboard navigation and screen reader support.\n *\n * @module modal\n */\n\nimport { announce } from './accessibility.js';\nimport type { ZoneState, ZoneDistribution } from '../zone-state.js';\n\n/**\n * Modal button configuration\n */\nexport interface ModalButton {\n    text: string;\n    variant: 'primary' | 'secondary' | 'danger';\n    onClick: () => void;\n}\n\n/**\n * Modal configuration options\n */\nexport interface ModalOptions {\n    title: string;\n    content: string | HTMLElement;\n    buttons: ModalButton[];\n    icon?: string;\n    onClose?: () => void;\n    closeOnOverlay?: boolean;\n}\n\n/**\n * Create a modal element\n */\nfunction createModalElement(options: ModalOptions): HTMLElement {\n    const modal = document.createElement('div');\n    modal.className = 'custom-modal';\n    modal.setAttribute('role', 'dialog');\n    modal.setAttribute('aria-modal', 'true');\n    modal.setAttribute('aria-labelledby', 'modal-title');\n\n    const titleText = options.icon ? `${options.icon} ${options.title}` : options.title;\n\n    modal.innerHTML = `\n        <div class=\"custom-modal-overlay\"></div>\n        <div class=\"custom-modal-container\">\n            <div class=\"custom-modal-header\">\n                <h2 id=\"modal-title\">${titleText}</h2>\n                <button class=\"modal-close-btn\" aria-label=\"Close dialog\">&times;</button>\n            </div>\n            <div class=\"custom-modal-body\"></div>\n            <div class=\"custom-modal-footer\"></div>\n        </div>\n    `;\n\n    // Add content\n    const body = modal.querySelector('.custom-modal-body') as HTMLElement;\n    if (typeof options.content === 'string') {\n        body.innerHTML = options.content;\n    } else {\n        body.appendChild(options.content);\n    }\n\n    // Add buttons\n    const footer = modal.querySelector('.custom-modal-footer') as HTMLElement;\n    options.buttons.forEach((btn, index) => {\n        const button = document.createElement('button');\n        button.textContent = btn.text;\n        button.className = `modal-btn modal-btn-${btn.variant}`;\n        button.addEventListener('click', btn.onClick);\n\n        // Auto-focus the first primary button, or first button if no primary\n        if (btn.variant === 'primary' || (index === 0 && !options.buttons.some((b) => b.variant === 'primary'))) {\n            button.setAttribute('data-autofocus', 'true');\n        }\n\n        footer.appendChild(button);\n    });\n\n    return modal;\n}\n\n/**\n * Focus trap for modal accessibility\n */\nfunction trapFocus(modal: HTMLElement): () => void {\n    const focusableElements = modal.querySelectorAll<HTMLElement>(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n    );\n    const firstFocusable = focusableElements[0];\n    const lastFocusable = focusableElements[focusableElements.length - 1];\n\n    const handleTabKey = (e: KeyboardEvent) => {\n        if (e.key !== 'Tab') return;\n\n        if (e.shiftKey) {\n            if (document.activeElement === firstFocusable) {\n                e.preventDefault();\n                lastFocusable?.focus();\n            }\n        } else {\n            if (document.activeElement === lastFocusable) {\n                e.preventDefault();\n                firstFocusable?.focus();\n            }\n        }\n    };\n\n    modal.addEventListener('keydown', handleTabKey);\n    return () => modal.removeEventListener('keydown', handleTabKey);\n}\n\n/**\n * Show a modal dialog\n *\n * @param options - Modal configuration\n * @returns A function to close the modal\n */\nexport function showModal(options: ModalOptions): () => void {\n    const modal = createModalElement(options);\n    const previousActiveElement = document.activeElement as HTMLElement;\n\n    document.body.appendChild(modal);\n\n    // Force reflow for animation\n    modal.offsetHeight;\n    modal.classList.add('modal-visible');\n\n    // Set up focus trap\n    const removeFocusTrap = trapFocus(modal);\n\n    // Focus the autofocus element or first focusable\n    const autofocusEl = modal.querySelector<HTMLElement>('[data-autofocus]');\n    setTimeout(() => {\n        autofocusEl?.focus();\n    }, 50);\n\n    // Close function\n    const closeModal = () => {\n        modal.classList.remove('modal-visible');\n\n        // Remove after animation\n        setTimeout(() => {\n            modal.remove();\n            removeFocusTrap();\n\n            // Restore focus\n            previousActiveElement?.focus();\n\n            options.onClose?.();\n        }, 200);\n    };\n\n    // Close button\n    const closeBtn = modal.querySelector('.modal-close-btn');\n    closeBtn?.addEventListener('click', closeModal);\n\n    // Overlay click\n    if (options.closeOnOverlay !== false) {\n        const overlay = modal.querySelector('.custom-modal-overlay');\n        overlay?.addEventListener('click', closeModal);\n    }\n\n    // Escape key\n    const handleEscape = (e: KeyboardEvent) => {\n        if (e.key === 'Escape') {\n            e.preventDefault();\n            closeModal();\n        }\n    };\n    document.addEventListener('keydown', handleEscape);\n\n    // Cleanup escape listener when modal closes\n    const originalOnClose = options.onClose;\n    options.onClose = () => {\n        document.removeEventListener('keydown', handleEscape);\n        originalOnClose?.();\n    };\n\n    announce(`${options.title} dialog opened`, 'polite');\n\n    return closeModal;\n}\n\n/**\n * Show a confirmation dialog\n *\n * @param title - Dialog title\n * @param message - Confirmation message\n * @param options - Additional options\n * @returns Promise resolving to true if confirmed, false if cancelled\n */\nexport function showConfirmation(\n    title: string,\n    message: string,\n    options: {\n        confirmText?: string;\n        cancelText?: string;\n        confirmVariant?: 'primary' | 'danger';\n        icon?: string;\n    } = {}\n): Promise<boolean> {\n    return new Promise((resolve) => {\n        const { confirmText = 'Confirm', cancelText = 'Cancel', confirmVariant = 'primary', icon } = options;\n\n        let closeModal: (() => void) | null = null;\n\n        closeModal = showModal({\n            title,\n            content: `<p class=\"modal-message\">${message}</p>`,\n            icon,\n            buttons: [\n                {\n                    text: cancelText,\n                    variant: 'secondary',\n                    onClick: () => {\n                        closeModal?.();\n                        resolve(false);\n                    },\n                },\n                {\n                    text: confirmText,\n                    variant: confirmVariant,\n                    onClick: () => {\n                        closeModal?.();\n                        resolve(true);\n                    },\n                },\n            ],\n            onClose: () => resolve(false),\n        });\n    });\n}\n\n/**\n * Workout summary data\n */\nexport interface WorkoutSummary {\n    duration: number;\n    startTime: number;\n    endTime: number;\n    power: {\n        avg: number | null;\n        max: number | null;\n        count: number;\n    };\n    heartrate: {\n        avg: number | null;\n        max: number | null;\n        count: number;\n    };\n    cadence: {\n        avg: number | null;\n        max: number | null;\n        count: number;\n    };\n    powerZoneDistribution?: ZoneDistribution;\n    hrZoneDistribution?: ZoneDistribution;\n    powerCurve?: { duration: number; watts: number }[];\n    trainingLoad?: number;\n    intensityFactor?: number;\n}\n\n/**\n * Calculate workout summary statistics\n */\nexport function calculateWorkoutSummary(\n    startTime: number,\n    endTime: number,\n    measurements: {\n        power: { value: number }[];\n        heartrate: { value: number }[];\n        cadence: { value: number }[];\n    },\n    zoneState?: ZoneState\n): WorkoutSummary {\n    const calcStats = (data: { value: number }[]) => {\n        if (data.length === 0) {\n            return { avg: null, max: null, count: 0 };\n        }\n        const values = data.map((d) => d.value);\n        const sum = values.reduce((a, b) => a + b, 0);\n        return {\n            avg: Math.round(sum / values.length),\n            max: Math.max(...values),\n            count: values.length,\n        };\n    };\n\n    // Calculate Power Curve\n    const powerValues = measurements.power.map((p) => p.value);\n    const powerCurve: { duration: number; watts: number }[] = [];\n    const durations = [1, 5, 10, 30, 60, 300, 1200, 3600]; // 1s, 5s, 10s, 30s, 1m, 5m, 20m, 1h\n\n    // Helper for sliding window max\n    const getMaxForDuration = (windowSize: number) => {\n        if (powerValues.length < windowSize) return 0;\n        let sum = 0;\n        for (let i = 0; i < windowSize; i++) sum += powerValues[i];\n        let maxAvg = sum / windowSize;\n\n        for (let i = windowSize; i < powerValues.length; i++) {\n            sum = sum - powerValues[i - windowSize] + powerValues[i];\n            if (sum / windowSize > maxAvg) maxAvg = sum / windowSize;\n        }\n        return Math.round(maxAvg);\n    };\n\n    for (const d of durations) {\n        if (powerValues.length >= d) {\n            powerCurve.push({ duration: d, watts: getMaxForDuration(d) });\n        }\n    }\n\n    // Calculate TSS & IF (Assuming FTP = 200 if not set, should ideally come from user profile)\n    // TODO: Fetch user profile FTP properly. Using a fallback for now.\n    // Normalized power approximation: xPower (simple moving average for now or just avg)\n    // Real NP requires 30s rolling avg, raised to 4th power, avg, 4th root.\n\n    let trainingLoad = 0;\n    let intensityFactor = 0;\n\n    // Quick and dirty TSS if we have \"bpt-user-profile\" in localstorage\n    try {\n        const profileStr = localStorage.getItem('bpt-user-profile');\n        if (profileStr && powerValues.length > 0) {\n            const profile = JSON.parse(profileStr);\n            const ftp = profile.ftp || 200;\n\n            // Calculate Normalized Power (Simplified algorithm)\n            // 1. 30s rolling avg\n            const rolling30s: number[] = [];\n            let sum30 = 0;\n            for (let i = 0; i < powerValues.length; i++) {\n                sum30 += powerValues[i];\n                if (i >= 30) sum30 -= powerValues[i - 30];\n                if (i >= 29) rolling30s.push(sum30 / 30);\n            }\n\n            if (rolling30s.length > 0) {\n                // 2. raise to 4th power\n                const pow4 = rolling30s.map((v) => Math.pow(v, 4));\n                // 3. average\n                const avgPow4 = pow4.reduce((a, b) => a + b, 0) / pow4.length;\n                // 4. 4th root\n                const np = Math.pow(avgPow4, 0.25);\n\n                intensityFactor = np / ftp;\n                // TSS = (sec x NP x IF) / (FTP x 3600) x 100\n                const durationSec = (endTime - startTime) / 1000;\n                trainingLoad = ((durationSec * np * intensityFactor) / (ftp * 3600)) * 100;\n            }\n        }\n    } catch (e) {\n        console.warn('Error calculating TSS', e);\n    }\n\n    const summary: WorkoutSummary = {\n        duration: endTime - startTime,\n        startTime,\n        endTime,\n        power: calcStats(measurements.power),\n        heartrate: calcStats(measurements.heartrate),\n        cadence: calcStats(measurements.cadence),\n        powerCurve: powerCurve.length > 0 ? powerCurve : undefined,\n        trainingLoad: trainingLoad > 0 ? Math.round(trainingLoad) : undefined,\n        intensityFactor: intensityFactor > 0 ? parseFloat(intensityFactor.toFixed(2)) : undefined,\n    };\n\n    // Add zone distributions if available\n    if (zoneState) {\n        const powerDist = zoneState.getPowerZoneDistribution();\n        const hrDist = zoneState.getHrZoneDistribution();\n\n        if (powerDist.totalTimeMs > 0) {\n            summary.powerZoneDistribution = powerDist;\n        }\n        if (hrDist.totalTimeMs > 0) {\n            summary.hrZoneDistribution = hrDist;\n        }\n    }\n\n    return summary;\n}\n\n/**\n * Format duration in milliseconds to human readable string\n */\nexport function formatDurationLong(ms: number): string {\n    const totalSeconds = Math.floor(ms / 1000);\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = totalSeconds % 60;\n\n    const parts: string[] = [];\n    if (hours > 0) parts.push(`${hours}h`);\n    if (minutes > 0) parts.push(`${minutes}m`);\n    if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);\n\n    return parts.join(' ');\n}\n\n/**\n * Format seconds to MM:SS format\n */\nfunction formatSecondsShort(seconds: number): string {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${String(secs).padStart(2, '0')}`;\n}\n\n/**\n * Zone colors for the histogram\n */\nconst ZONE_COLORS: Record<number, string> = {\n    1: '#3b82f6', // Blue - Recovery\n    2: '#22c55e', // Green - Endurance\n    3: '#eab308', // Yellow - Tempo\n    4: '#f97316', // Orange - Threshold\n    5: '#ef4444', // Red - VO2max/Anaerobic\n    6: '#a855f7', // Purple - Anaerobic (power)\n    7: '#ec4899', // Pink - Neuromuscular (power)\n};\n\n/**\n * Create zone distribution histogram chart\n */\nfunction createZoneHistogram(distribution: ZoneDistribution, title: string): HTMLElement {\n    const container = document.createElement('div');\n    container.className = 'zone-distribution';\n\n    // Filter zones with time > 0\n    const activeZones = distribution.zones.filter((z) => z.timeInZoneMs > 0);\n\n    if (activeZones.length === 0) {\n        return container; // Return empty if no zone data\n    }\n\n    const maxTime = Math.max(...distribution.zones.map((z) => z.timeInZoneMs));\n\n    container.innerHTML = `\n        <h4 class=\"zone-distribution-title\">${title}</h4>\n        <div class=\"zone-chart\">\n            ${distribution.zones\n                .map((zone) => {\n                    const percent = maxTime > 0 ? (zone.timeInZoneMs / maxTime) * 100 : 0;\n                    const timeSeconds = Math.round(zone.timeInZoneMs / 1000);\n                    const color = ZONE_COLORS[zone.zone] || '#888';\n                    const timeStr = formatSecondsShort(timeSeconds);\n\n                    return `\n                    <div class=\"zone-bar-row\" title=\"${zone.name}: ${timeStr}\">\n                        <span class=\"zone-bar-label\">Z${zone.zone}</span>\n                        <div class=\"zone-bar-container\">\n                            <div class=\"zone-bar\" style=\"width: ${Math.max(percent, 2)}%; background-color: ${color};\" aria-valuenow=\"${timeSeconds}\" aria-label=\"${zone.name}\"></div>\n                        </div>\n                        <span class=\"zone-bar-time\">${timeStr}</span>\n                    </div>\n                `;\n                })\n                .join('')}\n        </div>\n    `;\n\n    return container;\n}\n\n/**\n * Create workout summary content HTML element\n */\nexport function createSummaryContent(summary: WorkoutSummary, newRecords: string[] = []): HTMLElement {\n    const container = document.createElement('div');\n    container.className = 'workout-summary';\n\n    const formatValue = (value: number | null, unit: string): string => {\n        return value !== null ? `${value}${unit}` : '--';\n    };\n\n    // New Records Section\n    let recordsHtml = '';\n    if (newRecords.length > 0) {\n        recordsHtml = `\n            <div class=\"summary-records\" style=\"background: rgba(255, 215, 0, 0.1); border: 1px solid var(--color-accent); border-radius: 8px; padding: 12px; margin-bottom: 16px;\">\n                <h4 style=\"margin: 0 0 8px 0; color: var(--color-accent); display: flex; align-items: center; gap: 8px;\">\n                     New Personal Records!\n                </h4>\n                <ul style=\"margin: 0; padding-left: 20px; list-style-type: none;\">\n                    ${newRecords.map((r) => `<li style=\"margin-bottom: 4px;\"> ${r}</li>`).join('')}\n                </ul>\n            </div>\n        `;\n    }\n\n    container.innerHTML = `\n        ${recordsHtml}\n        <div class=\"summary-duration\">\n            <span class=\"summary-label\">Duration</span>\n            <span class=\"summary-value\">${formatDurationLong(summary.duration)}</span>\n        </div>\n        <div class=\"summary-grid\">\n            <div class=\"summary-metric\">\n                <span class=\"summary-metric-icon\"></span>\n                <span class=\"summary-metric-label\">Power</span>\n                <div class=\"summary-metric-values\">\n                    <span class=\"summary-avg\">Avg: ${formatValue(summary.power.avg, 'W')}</span>\n                    <span class=\"summary-max\">Max: ${formatValue(summary.power.max, 'W')}</span>\n                </div>\n            </div>\n            <div class=\"summary-metric\">\n                <span class=\"summary-metric-icon\"></span>\n                <span class=\"summary-metric-label\">Heart Rate</span>\n                <div class=\"summary-metric-values\">\n                    <span class=\"summary-avg\">Avg: ${formatValue(summary.heartrate.avg, ' bpm')}</span>\n                    <span class=\"summary-max\">Max: ${formatValue(summary.heartrate.max, ' bpm')}</span>\n                </div>\n            </div>\n            <div class=\"summary-metric\">\n                <span class=\"summary-metric-icon\"></span>\n                <span class=\"summary-metric-label\">Cadence</span>\n                <div class=\"summary-metric-values\">\n                    <span class=\"summary-avg\">Avg: ${formatValue(summary.cadence.avg, ' rpm')}</span>\n                    <span class=\"summary-max\">Max: ${formatValue(summary.cadence.max, ' rpm')}</span>\n                </div>\n            </div>\n        </div>\n        <div class=\"summary-samples\">\n            <span class=\"summary-samples-text\">\n                ${summary.power.count + summary.heartrate.count + summary.cadence.count} data points recorded\n            </span>\n        </div>\n    `;\n\n    // Add zone distribution charts if available\n    if (summary.powerZoneDistribution && summary.powerZoneDistribution.totalTimeMs > 0) {\n        const powerChart = createZoneHistogram(summary.powerZoneDistribution, ' Power Zone Distribution');\n        container.appendChild(powerChart);\n    }\n\n    if (summary.hrZoneDistribution && summary.hrZoneDistribution.totalTimeMs > 0) {\n        const hrChart = createZoneHistogram(summary.hrZoneDistribution, ' Heart Rate Zone Distribution');\n        container.appendChild(hrChart);\n    }\n\n    return container;\n}\n\n/**\n * Show post-workout summary modal\n *\n * @param summary - Workout summary data\n * @param callbacks - Action callbacks\n * @returns Promise resolving to the chosen action\n */\nexport function showWorkoutSummary(\n    summary: WorkoutSummary,\n    callbacks: {\n        onExport: () => void;\n        onDiscard: () => void;\n        onKeepRecording: () => void;\n    },\n    newRecords: string[] = []\n): Promise<'export' | 'discard' | 'keep'> {\n    return new Promise((resolve) => {\n        let closeModal: (() => void) | null = null;\n\n        const content = createSummaryContent(summary, newRecords);\n\n        closeModal = showModal({\n            title: 'Workout Complete',\n            content,\n            icon: '',\n            closeOnOverlay: false,\n            buttons: [\n                {\n                    text: ' Discard',\n                    variant: 'danger',\n                    onClick: () => {\n                        closeModal?.();\n                        callbacks.onDiscard();\n                        resolve('discard');\n                    },\n                },\n                {\n                    text: ' Keep Recording',\n                    variant: 'secondary',\n                    onClick: () => {\n                        closeModal?.();\n                        callbacks.onKeepRecording();\n                        resolve('keep');\n                    },\n                },\n                {\n                    text: ' Save & Finish',\n                    variant: 'primary',\n                    onClick: () => {\n                        closeModal?.();\n                        callbacks.onExport();\n                        resolve('export');\n                    },\n                },\n            ],\n            onClose: () => {\n                callbacks.onKeepRecording();\n                resolve('keep');\n            },\n        });\n    });\n}\n","/**\n * Post-Workout Metadata Modal\n *\n * Shows a modal after workout completion to collect:\n * - Workout title (with smart default)\n * - Notes\n * - Perceived exertion (RPE 1-10)\n *\n * Settings control whether notes and/or exertion prompts are shown.\n *\n * @module ui/workoutMetadataModal\n */\n\nimport { showModal } from './modal.js';\nimport { getSettings } from '../config/settings.js';\nimport type { WorkoutMetadata, PerceivedExertion } from '../types/measurements.js';\n\n/**\n * RPE (Rate of Perceived Exertion) scale descriptions\n */\nconst RPE_DESCRIPTIONS: Record<PerceivedExertion, { label: string; description: string; color: string }> = {\n    1: { label: '1 - Very Light', description: 'Barely any effort', color: '#3b82f6' },\n    2: { label: '2 - Light', description: 'Easy breathing', color: '#22c55e' },\n    3: { label: '3 - Light', description: 'Could do this all day', color: '#22c55e' },\n    4: { label: '4 - Moderate', description: 'Comfortable effort', color: '#84cc16' },\n    5: { label: '5 - Moderate', description: 'Starting to breathe harder', color: '#eab308' },\n    6: { label: '6 - Hard', description: 'Can speak in sentences', color: '#eab308' },\n    7: { label: '7 - Hard', description: 'Can only speak in phrases', color: '#f97316' },\n    8: { label: '8 - Very Hard', description: 'Difficult to maintain', color: '#ef4444' },\n    9: { label: '9 - Very Hard', description: 'Almost maximal effort', color: '#dc2626' },\n    10: { label: '10 - Maximum', description: 'All-out effort', color: '#991b1b' },\n};\n\n/**\n * Generate a default workout title based on the date/time\n */\nexport function generateDefaultTitle(startTime?: number): string {\n    const date = startTime ? new Date(startTime) : new Date();\n    const hours = date.getHours();\n\n    let timeOfDay = 'Morning';\n    if (hours >= 12 && hours < 17) {\n        timeOfDay = 'Afternoon';\n    } else if (hours >= 17 && hours < 21) {\n        timeOfDay = 'Evening';\n    } else if (hours >= 21 || hours < 5) {\n        timeOfDay = 'Night';\n    }\n\n    const dateStr = date.toLocaleDateString('en-US', {\n        month: 'short',\n        day: 'numeric',\n    });\n\n    return `${timeOfDay} Ride - ${dateStr}`;\n}\n\n/**\n * Create the RPE selector element\n */\nfunction createRpeSelector(selectedValue?: PerceivedExertion): HTMLElement {\n    const container = document.createElement('div');\n    container.className = 'rpe-selector';\n    container.innerHTML = `\n        <label class=\"metadata-label\">Perceived Exertion (RPE)</label>\n        <div class=\"rpe-grid\">\n            ${([1, 2, 3, 4, 5, 6, 7, 8, 9, 10] as PerceivedExertion[])\n                .map((value) => {\n                    const info = RPE_DESCRIPTIONS[value];\n                    const isSelected = selectedValue === value;\n                    return `\n                    <button type=\"button\"\n                        class=\"rpe-button ${isSelected ? 'selected' : ''}\"\n                        data-rpe=\"${value}\"\n                        title=\"${info.label}: ${info.description}\"\n                        style=\"--rpe-color: ${info.color};\">\n                        ${value}\n                    </button>\n                `;\n                })\n                .join('')}\n        </div>\n        <div class=\"rpe-description\" id=\"rpeDescription\">\n            ${selectedValue ? `${RPE_DESCRIPTIONS[selectedValue].label}: ${RPE_DESCRIPTIONS[selectedValue].description}` : 'Select how hard the workout felt'}\n        </div>\n    `;\n\n    // Add click handlers for RPE buttons\n    const buttons = container.querySelectorAll('.rpe-button');\n    buttons.forEach((button) => {\n        button.addEventListener('click', () => {\n            // Remove selected from all\n            buttons.forEach((b) => b.classList.remove('selected'));\n            // Add to clicked\n            button.classList.add('selected');\n\n            // Update description\n            const rpe = parseInt(button.getAttribute('data-rpe') || '5', 10) as PerceivedExertion;\n            const descEl = container.querySelector('#rpeDescription');\n            if (descEl) {\n                descEl.textContent = `${RPE_DESCRIPTIONS[rpe].label}: ${RPE_DESCRIPTIONS[rpe].description}`;\n            }\n        });\n    });\n\n    return container;\n}\n\n/**\n * Create the metadata form content\n */\nfunction createMetadataFormContent(\n    startTime: number | undefined,\n    showNotes: boolean,\n    showExertion: boolean\n): HTMLElement {\n    const container = document.createElement('div');\n    container.className = 'workout-metadata-form';\n\n    // Title field (always shown)\n    const titleSection = document.createElement('div');\n    titleSection.className = 'metadata-field';\n    titleSection.innerHTML = `\n        <label class=\"metadata-label\" for=\"workoutTitle\">Workout Title</label>\n        <input type=\"text\"\n            id=\"workoutTitle\"\n            class=\"metadata-input\"\n            value=\"${generateDefaultTitle(startTime)}\"\n            placeholder=\"Enter workout title...\"\n            maxlength=\"100\">\n    `;\n    container.appendChild(titleSection);\n\n    // Notes field (optional based on settings)\n    if (showNotes) {\n        const notesSection = document.createElement('div');\n        notesSection.className = 'metadata-field';\n        notesSection.innerHTML = `\n            <label class=\"metadata-label\" for=\"workoutNotes\">Notes (optional)</label>\n            <textarea\n                id=\"workoutNotes\"\n                class=\"metadata-textarea\"\n                placeholder=\"How did the workout go? Any observations...\"\n                rows=\"3\"\n                maxlength=\"1000\"></textarea>\n        `;\n        container.appendChild(notesSection);\n    }\n\n    // RPE selector (optional based on settings)\n    if (showExertion) {\n        const rpeSection = document.createElement('div');\n        rpeSection.className = 'metadata-field';\n        rpeSection.appendChild(createRpeSelector());\n        container.appendChild(rpeSection);\n    }\n\n    return container;\n}\n\n/**\n * Extract metadata from the form\n */\nfunction getMetadataFromForm(container: HTMLElement): WorkoutMetadata {\n    const titleInput = container.querySelector('#workoutTitle') as HTMLInputElement;\n    const notesInput = container.querySelector('#workoutNotes') as HTMLTextAreaElement;\n    const selectedRpe = container.querySelector('.rpe-button.selected') as HTMLButtonElement;\n\n    const metadata: WorkoutMetadata = {\n        title: titleInput?.value.trim() || generateDefaultTitle(),\n    };\n\n    if (notesInput?.value.trim()) {\n        metadata.notes = notesInput.value.trim();\n    }\n\n    if (selectedRpe) {\n        const rpe = parseInt(selectedRpe.getAttribute('data-rpe') || '0', 10);\n        if (rpe >= 1 && rpe <= 10) {\n            metadata.perceivedExertion = rpe as PerceivedExertion;\n        }\n    }\n\n    return metadata;\n}\n\n/**\n * Show the post-workout metadata collection modal\n *\n * @param startTime - The workout start timestamp for default title generation\n * @returns Promise resolving to the collected metadata, or null if skipped/cancelled\n */\nexport function showWorkoutMetadataModal(startTime?: number): Promise<WorkoutMetadata | null> {\n    const settings = getSettings();\n    const { promptForNotes, promptForExertion } = settings.workoutMetadata;\n\n    // If both prompts are disabled, return default metadata immediately\n    if (!promptForNotes && !promptForExertion) {\n        return Promise.resolve({\n            title: generateDefaultTitle(startTime),\n        });\n    }\n\n    return new Promise((resolve) => {\n        let closeModal: (() => void) | null = null;\n\n        const formContent = createMetadataFormContent(startTime, promptForNotes, promptForExertion);\n\n        closeModal = showModal({\n            title: 'Workout Details',\n            content: formContent,\n            icon: '',\n            closeOnOverlay: false,\n            buttons: [\n                {\n                    text: 'Skip',\n                    variant: 'secondary',\n                    onClick: () => {\n                        closeModal?.();\n                        // Return default metadata even when skipped\n                        resolve({\n                            title: generateDefaultTitle(startTime),\n                        });\n                    },\n                },\n                {\n                    text: 'Save',\n                    variant: 'primary',\n                    onClick: () => {\n                        const metadata = getMetadataFromForm(formContent);\n                        closeModal?.();\n                        resolve(metadata);\n                    },\n                },\n            ],\n            onClose: () => {\n                // Return default if modal is closed via escape/X\n                resolve({\n                    title: generateDefaultTitle(startTime),\n                });\n            },\n        });\n\n        // Focus the title input after modal opens\n        setTimeout(() => {\n            const titleInput = formContent.querySelector('#workoutTitle') as HTMLInputElement;\n            titleInput?.focus();\n            titleInput?.select();\n        }, 100);\n    });\n}\n\n/**\n * Check if metadata modal should be shown based on settings\n */\nexport function shouldShowMetadataModal(): boolean {\n    const settings = getSettings();\n    return settings.workoutMetadata.promptForNotes || settings.workoutMetadata.promptForExertion;\n}\n","/**\n * Undo Notification Module\n *\n * Displays a toast notification with an undo button that allows users\n * to reverse a destructive action within a time limit.\n *\n * @module undoNotification\n */\n\nimport { announce } from './accessibility.js';\n\n/** Default undo timeout in milliseconds */\nconst DEFAULT_UNDO_TIMEOUT = 5000;\n\n/**\n * Undo notification options\n */\nexport interface UndoNotificationOptions {\n    /** The message to display */\n    message: string;\n    /** Callback when undo is clicked */\n    onUndo: () => void;\n    /** Callback when the timeout expires without undo */\n    onExpire?: () => void;\n    /** Time in ms before the notification disappears (default: 5000) */\n    timeout?: number;\n    /** Icon to display (optional) */\n    icon?: string;\n}\n\n/**\n * Show an undo notification toast\n *\n * Displays a notification with a countdown timer and undo button.\n * The notification auto-dismisses after the timeout, executing onExpire.\n * If the user clicks undo, onUndo is called and the notification closes.\n *\n * @param options - Configuration for the undo notification\n * @returns A function to manually dismiss the notification\n */\nexport function showUndoNotification(options: UndoNotificationOptions): () => void {\n    const { message, onUndo, onExpire, timeout = DEFAULT_UNDO_TIMEOUT, icon = '' } = options;\n\n    // Remove any existing undo notifications\n    const existing = document.querySelector('.undo-notification');\n    existing?.remove();\n\n    // Create notification element\n    const notification = document.createElement('div');\n    notification.className = 'undo-notification';\n    notification.setAttribute('role', 'alert');\n    notification.setAttribute('aria-live', 'assertive');\n\n    // Calculate countdown in seconds\n    const timeoutSeconds = Math.ceil(timeout / 1000);\n    let remainingSeconds = timeoutSeconds;\n\n    // Create content\n    notification.innerHTML = `\n        <div class=\"undo-notification-content\">\n            <span class=\"undo-notification-icon\" aria-hidden=\"true\">${icon}</span>\n            <span class=\"undo-notification-message\">${message}</span>\n        </div>\n        <div class=\"undo-notification-actions\">\n            <button class=\"undo-notification-btn\" type=\"button\">\n                Undo <span class=\"undo-countdown\">(${remainingSeconds}s)</span>\n            </button>\n        </div>\n        <div class=\"undo-progress-bar\">\n            <div class=\"undo-progress-fill\"></div>\n        </div>\n    `;\n\n    document.body.appendChild(notification);\n\n    // Get elements\n    const undoButton = notification.querySelector('.undo-notification-btn') as HTMLButtonElement;\n    const countdownSpan = notification.querySelector('.undo-countdown') as HTMLSpanElement;\n    const progressFill = notification.querySelector('.undo-progress-fill') as HTMLDivElement;\n\n    // Check reduced motion preference\n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n\n    // Set up progress bar animation\n    if (!prefersReducedMotion) {\n        progressFill.style.transition = `width ${timeout}ms linear`;\n        // Force reflow before starting animation\n        progressFill.offsetHeight;\n        progressFill.style.width = '0%';\n    } else {\n        progressFill.style.width = '0%';\n    }\n\n    // Animate in\n    requestAnimationFrame(() => {\n        notification.classList.add('undo-notification-visible');\n    });\n\n    let isUndone = false;\n    let countdownInterval: ReturnType<typeof setInterval> | null = null;\n    let dismissTimeout: ReturnType<typeof setTimeout> | null = null;\n\n    /**\n     * Dismiss the notification with cleanup\n     */\n    const dismiss = (executeExpire = false) => {\n        if (countdownInterval) {\n            clearInterval(countdownInterval);\n            countdownInterval = null;\n        }\n        if (dismissTimeout) {\n            clearTimeout(dismissTimeout);\n            dismissTimeout = null;\n        }\n\n        if (prefersReducedMotion) {\n            notification.remove();\n            if (executeExpire && !isUndone && onExpire) {\n                onExpire();\n            }\n        } else {\n            notification.classList.remove('undo-notification-visible');\n            notification.classList.add('undo-notification-hiding');\n            setTimeout(() => {\n                notification.remove();\n                if (executeExpire && !isUndone && onExpire) {\n                    onExpire();\n                }\n            }, 200);\n        }\n    };\n\n    // Start countdown display\n    countdownInterval = setInterval(() => {\n        remainingSeconds--;\n        if (remainingSeconds > 0) {\n            countdownSpan.textContent = `(${remainingSeconds}s)`;\n        } else {\n            if (countdownInterval) {\n                clearInterval(countdownInterval);\n            }\n        }\n    }, 1000);\n\n    // Set up auto-dismiss\n    dismissTimeout = setTimeout(() => {\n        dismiss(true);\n    }, timeout);\n\n    // Handle undo click\n    undoButton.addEventListener('click', () => {\n        isUndone = true;\n        dismiss(false);\n        onUndo();\n        announce('Action undone', 'assertive');\n    });\n\n    // Focus the undo button for accessibility\n    undoButton.focus();\n\n    // Announce to screen readers\n    announce(`${message} Press undo within ${timeoutSeconds} seconds to restore.`, 'assertive');\n\n    return () => dismiss(false);\n}\n\n/**\n * Data backup for undo functionality\n */\nexport interface WorkoutBackup {\n    power: Array<{ timestamp: number; value: number }>;\n    heartrate: Array<{ timestamp: number; value: number }>;\n    cadence: Array<{ timestamp: number; value: number }>;\n    startTime: number | null;\n    endTime: number | null;\n    running: boolean;\n}\n\n/**\n * Create a backup of workout data for undo\n *\n * @param measurementsState - The measurements state to backup\n * @param timeState - The time state to backup\n * @returns A backup object that can be restored\n */\nexport function createWorkoutBackup(\n    measurementsState: {\n        power: Array<{ timestamp: number; value: number }>;\n        heartrate: Array<{ timestamp: number; value: number }>;\n        cadence: Array<{ timestamp: number; value: number }>;\n    },\n    timeState: { startTime: number | null; endTime: number | null; running: boolean }\n): WorkoutBackup {\n    return {\n        power: [...measurementsState.power],\n        heartrate: [...measurementsState.heartrate],\n        cadence: [...measurementsState.cadence],\n        startTime: timeState.startTime,\n        endTime: timeState.endTime,\n        running: timeState.running,\n    };\n}\n\n/**\n * Restore workout data from a backup\n *\n * @param backup - The backup to restore\n * @param measurementsState - The measurements state to restore to\n * @param timeState - The time state to restore to\n */\nexport function restoreWorkoutBackup(\n    backup: WorkoutBackup,\n    measurementsState: {\n        power: Array<{ timestamp: number; value: number }>;\n        heartrate: Array<{ timestamp: number; value: number }>;\n        cadence: Array<{ timestamp: number; value: number }>;\n    },\n    timeState: { startTime: number | null; endTime: number | null; running: boolean }\n): void {\n    measurementsState.power = [...backup.power];\n    measurementsState.heartrate = [...backup.heartrate];\n    measurementsState.cadence = [...backup.cadence];\n    timeState.startTime = backup.startTime;\n    timeState.endTime = backup.endTime;\n    timeState.running = backup.running;\n}\n","/**\n * Lap Button Functionality\n *\n * Handles lap marking during workouts.\n * Shows lap button during recording and updates lap counter.\n *\n * @module lap\n */\n\nimport { announce } from './accessibility.js';\nimport { showNotification } from './notifications.js';\nimport { getTimestring } from '../getTimestring.js';\nimport { voiceFeedback } from '../services/VoiceFeedback.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\n\n/**\n * Parameters for lap button initialization\n */\ninterface InitLapButtonParams {\n    measurementsState: MeasurementsState;\n    timeState: TimeState;\n}\n\n/**\n * Initialize the lap button functionality.\n *\n * Sets up:\n * - Lap button visibility based on workout state\n * - Lap counter display\n * - Click handler for marking laps\n *\n * @param params - Object containing state objects\n */\nexport function initLapButton({ measurementsState, timeState }: InitLapButtonParams): void {\n    const lapButton = document.getElementById('lapButton') as HTMLButtonElement | null;\n    const lapCounter = document.getElementById('lapCounter');\n    const lapCountElement = document.getElementById('lapCount');\n    const startButton = document.getElementById('startButton');\n    const pauseButton = document.getElementById('pauseButton');\n    const resumeButton = document.getElementById('resumeButton');\n    const stopButton = document.getElementById('stopButton');\n\n    if (!lapButton || !lapCounter || !lapCountElement) {\n        console.warn('Lap button elements not found in DOM');\n        return;\n    }\n\n    /**\n     * Update lap counter display\n     */\n    const updateLapCounter = (): void => {\n        const count = measurementsState.getLapCount();\n        lapCountElement.textContent = String(count);\n        lapCounter.style.display = count > 0 ? 'block' : 'none';\n    };\n\n    /**\n     * Show/hide lap button based on workout state\n     */\n    const updateLapButtonVisibility = (): void => {\n        const isRecording = timeState.running && timeState.startTime !== null;\n        lapButton.style.display = isRecording ? 'inline-flex' : 'none';\n    };\n\n    /**\n     * Handle lap button click\n     */\n    const handleLapClick = (): void => {\n        if (!timeState.running || !timeState.startTime) {\n            return;\n        }\n\n        // Get previous lap timestamp or start time\n        const laps = measurementsState.laps;\n        const lastLapTime = laps.length > 0 ? laps[laps.length - 1].timestamp : timeState.startTime;\n\n        const lap = measurementsState.addLap(timeState.startTime);\n        updateLapCounter();\n\n        // Calculate stats for the lap that just finished\n        const now = lap.timestamp;\n        const durationMs = now - lastLapTime;\n\n        // Calculate average power\n        const lapPower = measurementsState.power.filter((p) => p.timestamp >= lastLapTime && p.timestamp <= now);\n        const avgPower = lapPower.length > 0 ? lapPower.reduce((sum, p) => sum + p.value, 0) / lapPower.length : 0;\n\n        // Voice announcement\n        voiceFeedback.announceLap(lap.number, durationMs, avgPower);\n\n        // Format elapsed time for the lap\n        const elapsedStr = lap.elapsedMs ? getTimestring(lap.elapsedMs) : '';\n        const message = `Lap ${lap.number}${elapsedStr ? ` at ${elapsedStr}` : ''}`;\n\n        // Show toast notification\n        showNotification(` ${message}`, 'info');\n\n        // Announce for screen readers\n        announce(message, 'assertive');\n\n        console.log(`Lap marked: ${lap.number} at ${new Date(lap.timestamp).toISOString()}`);\n    };\n\n    // Lap button click handler\n    lapButton.addEventListener('click', handleLapClick);\n\n    // Watch for workout state changes by observing button visibility\n    // This is a simple approach - in a more complex app, use events or state management\n    const observer = new MutationObserver(() => {\n        updateLapButtonVisibility();\n    });\n\n    // Observe the start/pause/resume buttons for visibility changes\n    [startButton, pauseButton, resumeButton, stopButton].forEach((btn) => {\n        if (btn) {\n            observer.observe(btn, { attributes: true, attributeFilter: ['style'] });\n        }\n    });\n\n    // Initial state\n    updateLapButtonVisibility();\n    updateLapCounter();\n\n    // Also update when recording starts (observe start button click)\n    startButton?.addEventListener('click', () => {\n        setTimeout(updateLapButtonVisibility, 10);\n    });\n\n    pauseButton?.addEventListener('click', () => {\n        setTimeout(updateLapButtonVisibility, 10);\n    });\n\n    resumeButton?.addEventListener('click', () => {\n        setTimeout(updateLapButtonVisibility, 10);\n    });\n\n    stopButton?.addEventListener('click', () => {\n        setTimeout(() => {\n            updateLapButtonVisibility();\n            // Reset lap counter display after workout stops\n            // (laps are cleared when workout data is discarded)\n        }, 10);\n    });\n\n    console.log('Lap button initialized');\n}\n\n/**\n * Reset lap counter display (called when workout is discarded)\n */\nexport function resetLapCounter(): void {\n    const lapCounter = document.getElementById('lapCounter');\n    const lapCountElement = document.getElementById('lapCount');\n\n    if (lapCounter && lapCountElement) {\n        lapCountElement.textContent = '0';\n        lapCounter.style.display = 'none';\n    }\n}\n","/**\n * Analytics Helper for BPT\n *\n * Shared logic for calculating statistics, parsing summaries, and tracking personal records.\n */\n\nimport type { Workout } from '../api/workoutClient.js';\nimport type { WorkoutSummary } from './modal.js';\n\ninterface PrState {\n    maxPower: number;\n    maxHr: number;\n    longestDuration: number;\n    longestDistance: number;\n    powerCurve: Record<number, number>; // duration -> watts\n}\n\nexport class PersonalRecordTracker {\n    private state: PrState = {\n        maxPower: 0,\n        maxHr: 0,\n        longestDuration: 0,\n        longestDistance: 0,\n        powerCurve: {},\n    };\n\n    /**\n     * Initialize tracker with historical workouts\n     */\n    constructor(workouts: Workout[]) {\n        this.processHistory(workouts);\n    }\n\n    private processHistory(workouts: Workout[]): void {\n        workouts.forEach((w) => {\n            const summary = getSummary(w);\n\n            if (summary.power?.max && summary.power.max > this.state.maxPower) {\n                this.state.maxPower = summary.power.max;\n            }\n            if (summary.heartrate?.max && summary.heartrate.max > this.state.maxHr) {\n                this.state.maxHr = summary.heartrate.max;\n            }\n            if (w.duration && w.duration > this.state.longestDuration) {\n                this.state.longestDuration = w.duration;\n            }\n            /*\n            if (summary.totalDistance && summary.totalDistance > this.state.longestDistance) {\n                this.state.longestDistance = summary.totalDistance;\n            }\n            */\n\n            // Power Curve\n            if (summary.powerCurve) {\n                summary.powerCurve.forEach((p: { duration: number; watts: number }) => {\n                    const currentBest = this.state.powerCurve[p.duration] || 0;\n                    if (p.watts > currentBest) {\n                        this.state.powerCurve[p.duration] = p.watts;\n                    }\n                });\n            }\n        });\n    }\n\n    /**\n     * Check a new workout for records\n     * @returns Array of strings describing any new records\n     */\n    public checkNewRecords(newSummary: WorkoutSummary): string[] {\n        const records: string[] = [];\n\n        if (newSummary.power.max && newSummary.power.max > this.state.maxPower) {\n            records.push(`Max Power: ${newSummary.power.max} W`);\n        }\n\n        if (newSummary.heartrate.max && newSummary.heartrate.max > this.state.maxHr) {\n            records.push(`Max Heart Rate: ${newSummary.heartrate.max} bpm`);\n        }\n\n        // duration is in ms in Workout (DB), but WorkoutSummary.duration might be ms?\n        // Let's verify modal.ts. duration = endTime - startTime (ms).\n        if (newSummary.duration && newSummary.duration > this.state.longestDuration) {\n            // Only report significant duration records (>10% improvement or >1h) to avoid noise?\n            // For now, just simplistic check\n            records.push(`Longest Ride: ${formatDuration(newSummary.duration)}`);\n        }\n\n        // Modal summary doesn't have totalDistance computed yet unfortunately calculateWorkoutSummary doesn't do distance from GPS\n        // We might skip distance for live summary check unless we update calculateWorkoutSummary to include it.\n\n        // Power Curve\n        if (newSummary.powerCurve) {\n            const significantDurations = [1, 5, 60, 300, 1200, 3600]; // 1s, 5s, 1m, 5m, 20m, 1h\n            const labels: Record<number, string> = {\n                1: '1s Power',\n                5: '5s Power',\n                60: '1m Power',\n                300: '5m Power',\n                1200: '20m Power',\n                3600: '1h Power',\n            };\n\n            newSummary.powerCurve.forEach((p) => {\n                if (significantDurations.includes(p.duration)) {\n                    const currentBest = this.state.powerCurve[p.duration] || 0;\n                    if (p.watts > currentBest) {\n                        // Avoid duplicates if multiple durations map to \"Max Power\" (like 1s)\n                        if (p.duration === 1 && records.some((r) => r.startsWith('Max Power'))) return;\n\n                        records.push(`${labels[p.duration]}: ${p.watts} W`);\n                    }\n                }\n            });\n        }\n\n        return records;\n    }\n}\n\n/**\n * Helper to safely parse summary from DB workout\n * Note: Local WorkoutSummary type has different shape than DB text/json summary.\n * We cast to 'any' for reading flexible fields.\n */\nexport function getSummary(workout: Workout): Partial<WorkoutSummary> {\n    if (!workout.summary) return {};\n    if (typeof workout.summary === 'string') {\n        try {\n            return JSON.parse(workout.summary) as Partial<WorkoutSummary>;\n        } catch {\n            return {};\n        }\n    }\n    return workout.summary as unknown as Partial<WorkoutSummary>;\n}\n\nfunction formatDuration(ms: number): string {\n    const seconds = Math.floor(ms / 1000);\n    const h = Math.floor(seconds / 3600);\n    const m = Math.floor((seconds % 3600) / 60);\n    const s = seconds % 60;\n    if (h > 0) return `${h}h ${m}m`;\n    return `${m}m ${s}s`;\n}\n","import { getSettings } from '../config/settings.js';\nimport type { MeasurementsData } from '../types/measurements.js';\nimport { getFitData } from '../create-fit.js';\nimport { showNotification } from '../ui/notifications.js';\n\n/**\n * Service for integrating with Intervals.icu API\n */\nexport class IntervalsService {\n    private static API_BASE = 'https://intervals.icu/api/v1';\n\n    /**\n     * Upload a workout to Intervals.icu\n     *\n     * @param measurements - The workout measurements data\n     * @param workoutName - Name for the file (e.g. \"BikePowerTracker_2024-01-01.fit\")\n     */\n    static async uploadWorkout(measurements: MeasurementsData, workoutName: string): Promise<void> {\n        const settings = getSettings();\n\n        // Basic check before processing\n        if (!settings.intervals.enabled || !settings.intervals.apiKey) {\n            return;\n        }\n\n        try {\n            const fitData = getFitData(measurements);\n            if (!fitData) {\n                console.warn('[Intervals] No data to upload');\n                return;\n            }\n\n            const blob = new Blob([fitData as unknown as BlobPart], { type: 'application/fit' });\n            const formData = new FormData();\n            // Append the file. 'file' is the key expected by standard multipart uploads,\n            // though Intervals.icu endpoint documentation should be checked.\n            // Most fit upload endpoints accept a 'file' parameter.\n            formData.append('file', blob, workoutName);\n\n            const athleteId = settings.intervals.athleteId || 'i';\n            const url = `${this.API_BASE}/athlete/${athleteId}/activities`;\n\n            // Authorization: Basic <base64(\"API_KEY:\" + api_key)>\n            const auth = btoa(`API_KEY:${settings.intervals.apiKey}`);\n\n            showNotification('Uploading to Intervals.icu...', 'info');\n\n            const response = await fetch(url, {\n                method: 'POST',\n                headers: {\n                    Authorization: `Basic ${auth}`,\n                },\n                body: formData,\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                console.log('[Intervals] Upload success:', result);\n                showNotification('Uploaded to Intervals.icu! ', 'success');\n            } else {\n                const text = await response.text();\n                console.error('[Intervals] Upload failed:', response.status, text);\n                showNotification(`Upload failed: ${response.status}`, 'error');\n            }\n        } catch (error) {\n            console.error('[Intervals] Network error:', error);\n            showNotification('Upload network error', 'error');\n        }\n    }\n}\n","/**\n * Application settings stored in localStorage\n */\nexport interface AppSettings {\n    power: boolean;\n    cadence: boolean;\n    heartrate: boolean;\n    exportTcx: boolean;\n    exportCsv: boolean;\n    exportJson: boolean;\n    exportFit: boolean;\n}\n\n/**\n * Default settings\n */\nexport const defaultSettings: AppSettings = {\n    power: true,\n    cadence: true,\n    heartrate: true,\n    exportTcx: true,\n    exportCsv: true,\n    exportJson: false,\n    exportFit: false,\n};\n","/**\n * Strava Integration Module\n *\n * Handles Strava connectivity and upload options.\n *\n * Current Implementation:\n * - Option 1: Manual Upload (Generates TCX and opens Strava upload page)\n *\n * @module strava\n */\n\nimport { getTcxString } from '../create-tcx.js';\nimport { getFitData } from '../create-fit.js'; // Prefer FIT if possible\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { WorkoutMetadata } from '../types/measurements.js';\nimport { announce } from '../ui/accessibility.js';\n\n/**\n * Base URL for Strava's manual upload page\n */\nexport const STRAVA_UPLOAD_URL = 'https://www.strava.com/upload/select';\n\n/**\n * Strava Integration Service\n */\nexport class StravaService {\n    private static instance: StravaService;\n\n    // Future expansion: OAuth tokens\n    private accessToken: string | null = null;\n\n    private constructor() {}\n\n    public static getInstance(): StravaService {\n        if (!StravaService.instance) {\n            StravaService.instance = new StravaService();\n        }\n        return StravaService.instance;\n    }\n\n    /**\n     * Check if Strava is \"connected\" (meaning we have tokens)\n     * For now, returns false as we are doing manual upload\n     */\n    public isConnected(): boolean {\n        return !!this.accessToken;\n    }\n\n    /**\n     * Initiate Strava Upload Flow\n     *\n     * If not connected:\n     * 1. Generates workout file (FIT preferred, TCX fallback)\n     * 2. Triggers download\n     * 3. Opens Strava Upload page in new tab\n     */\n    public async handleUpload(\n        measurementsState: MeasurementsState,\n        // @ts-ignore: metadata currently unused until we add real metadata to export\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        metadata?: WorkoutMetadata\n    ): Promise<void> {\n        try {\n            // 1. Generate Data\n            // We use FIT because it's binary, smaller, and preferred by Strava\n            // But we need to check if getFitData works (it might be async in some implementations, though here likely sync)\n\n            let blob: Blob;\n            let filename: string;\n\n            const dateStr = new Date().toISOString().slice(0, 10);\n            const timeStr = new Date().toISOString().slice(11, 16).replace(':', '-');\n            const filePrefix = `bike-power-tracker-${dateStr}-${timeStr}`;\n\n            try {\n                // Try FIT first\n                // IMPORTANT: getFitData expects SportType | undefined, but metadata passes title/notes\n                // We should extract sport type from metadata or valid source.\n                // Assuming metadata doesn't have sport yet, defaulting to undefined (cycling)\n                const fitData = getFitData(measurementsState, undefined);\n                if (fitData) {\n                    blob = new Blob([fitData as unknown as BlobPart], { type: 'application/octet-stream' });\n                    filename = `${filePrefix}.fit`;\n                } else {\n                    throw new Error('No FIT data generated');\n                }\n            } catch (e) {\n                console.warn('FIT generation failed, falling back to TCX', e);\n                const tcxString = getTcxString(measurementsState);\n                blob = new Blob([tcxString], { type: 'application/vnd.garmin.tcx+xml' });\n                filename = `${filePrefix}.tcx`;\n            }\n\n            // 2. Trigger Download\n            this.downloadFile(blob, filename);\n\n            // 3. Open Strava\n            this.openStravaUpload();\n\n            announce('Workout file downloaded. Please upload closely in the new Strava tab.', 'assertive');\n        } catch (error) {\n            console.error('Strava upload preparation failed:', error);\n            alert('Failed to prepare Strava upload.');\n        }\n    }\n\n    private downloadFile(blob: Blob, filename: string): void {\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        setTimeout(() => URL.revokeObjectURL(url), 100);\n    }\n\n    private openStravaUpload(): void {\n        window.open(STRAVA_UPLOAD_URL, '_blank');\n    }\n}\n\nexport const stravaService = StravaService.getInstance();\n","/**\n * Menu Controls\n *\n * Initializes menu buttons for export, discard, and settings toggle.\n *\n * @module menu\n */\n\nimport { getCsvString } from '../create-csv.js';\nimport { getTcxString } from '../create-tcx.js';\nimport { getFitData } from '../create-fit.js';\nimport { showConfirmation, showWorkoutSummary, calculateWorkoutSummary } from './modal.js';\nimport { showWorkoutMetadataModal, shouldShowMetadataModal } from './workoutMetadataModal.js';\nimport { announce } from './accessibility.js';\nimport {\n    showUndoNotification,\n    createWorkoutBackup,\n    restoreWorkoutBackup,\n    type WorkoutBackup,\n} from './undoNotification.js';\nimport { resetLapCounter } from './lap.js';\nimport { PersonalRecordTracker } from './analyticsHelper.js';\nimport { listWorkouts, isDatabaseAvailable } from '../api/workoutClient.js';\nimport { archiveWorkout } from '../storage/workoutStorage.js';\nimport { IntervalsService } from '../services/IntervalsService.js';\nimport { getSettings } from '../config/settings.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\nimport type { ZoneState } from '../zone-state.js';\nimport type { WorkoutMetadata } from '../types/measurements.js';\nimport { type AppSettings, defaultSettings } from '../types/settings.js';\n\n/**\n * Initialize the metrics visibility toggles.\n *\n * Sets up toggle switches for showing/hiding \"Your Metrics\" and \"Stream Metrics\" sections.\n */\nexport const initMetricsToggle = (): void => {\n    // Your Metrics Toggle\n    const toggleYour = document.getElementById('toggleYourMetrics') as HTMLInputElement | null;\n    const yourMetricsSection = document.getElementById('yourMetrics');\n\n    if (toggleYour && yourMetricsSection) {\n        // Initial state check\n        toggleYour.checked = yourMetricsSection.style.display !== 'none';\n\n        toggleYour.addEventListener('change', (e: Event) => {\n            const target = e.target as HTMLInputElement;\n            yourMetricsSection.style.display = target.checked ? 'flex' : 'none';\n        });\n    }\n\n    // Stream Metrics Toggle\n    const toggleStream = document.getElementById('toggleStreamMetrics') as HTMLInputElement | null;\n    const streamMetricsSection = document.getElementById('streamMetrics');\n\n    if (toggleStream && streamMetricsSection) {\n        // Initial state check\n        toggleStream.checked = streamMetricsSection.style.display !== 'none';\n\n        toggleStream.addEventListener('change', (e: Event) => {\n            const target = e.target as HTMLInputElement;\n            streamMetricsSection.style.display = target.checked ? 'flex' : 'none';\n        });\n    }\n};\n\n/**\n * Parameters for discard button initialization\n */\ninterface InitDiscardButtonParams {\n    measurementsState: MeasurementsState;\n    timeState: TimeState;\n    zoneState?: ZoneState;\n}\n\n/**\n * Initialize the discard button.\n *\n * Shows a custom confirmation dialog before clearing all workout data.\n * After discard, shows an undo notification for 5 seconds allowing\n * the user to restore their data.\n *\n * @param params - Object containing state objects\n */\nexport const initDiscardButton = ({ measurementsState, timeState, zoneState }: InitDiscardButtonParams): void => {\n    const discardButton = document.getElementById('discardButton');\n\n    if (!discardButton) {\n        console.warn('Discard button not found in DOM');\n        return;\n    }\n\n    const addListener = (btn: HTMLElement, callback: () => void) => {\n        const handler = (e: Event) => {\n            e.stopPropagation();\n            callback();\n        };\n        btn.addEventListener('click', handler);\n    };\n\n    addListener(discardButton, async () => {\n        const hasData =\n            measurementsState.power.length > 0 ||\n            measurementsState.heartrate.length > 0 ||\n            measurementsState.cadence.length > 0 ||\n            timeState.startTime !== null;\n\n        // If no data, just reset silently\n        if (!hasData) {\n            resetWorkoutState(measurementsState, timeState);\n            return;\n        }\n\n        // Count data points for the warning message\n        const totalDataPoints =\n            measurementsState.power.length + measurementsState.heartrate.length + measurementsState.cadence.length;\n\n        const confirmed = await showConfirmation(\n            'Discard Workout',\n            `Are you sure you want to discard this workout? You have ${totalDataPoints} data points that will be deleted. You'll have 5 seconds to undo this action.`,\n            {\n                confirmText: 'Discard',\n                cancelText: 'Keep Data',\n                confirmVariant: 'danger',\n                icon: '',\n            }\n        );\n\n        if (confirmed) {\n            // Create backup before clearing\n            const backup = createWorkoutBackup(measurementsState, timeState);\n\n            // Clear the workout data\n            resetWorkoutState(measurementsState, timeState);\n\n            // Reset zone tracking\n            if (zoneState) {\n                zoneState.reset();\n            }\n\n            // Dispatch event for zone state to reset\n            document.dispatchEvent(new CustomEvent('workout-discarded'));\n\n            // Reset lap counter display\n            resetLapCounter();\n\n            // Show undo notification\n            showUndoNotification({\n                message: 'Workout data discarded',\n                icon: '',\n                timeout: 5000,\n                onUndo: () => {\n                    // Restore the backup\n                    restoreWorkoutBackup(backup, measurementsState, timeState);\n\n                    // Restore UI state based on the backup\n                    restoreWorkoutUI(backup);\n\n                    announce('Workout data restored', 'polite');\n                },\n                onExpire: () => {\n                    // Data is already cleared, nothing more to do\n                    announce('Discard complete', 'polite');\n                },\n            });\n        }\n    });\n};\n\n/**\n * Restore the workout UI based on backed up state\n */\nfunction restoreWorkoutUI(backup: WorkoutBackup): void {\n    const startButton = document.getElementById('startButton') as HTMLButtonElement | null;\n    const pauseButton = document.getElementById('pauseButton') as HTMLButtonElement | null;\n    const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n    const stopButton = document.getElementById('stopButton') as HTMLButtonElement | null;\n    const timeElement = document.getElementById('time');\n\n    if (backup.running) {\n        // Was running when discarded\n        if (startButton) startButton.style.display = 'none';\n        if (pauseButton) pauseButton.style.display = 'inline-flex';\n        if (resumeButton) resumeButton.style.display = 'none';\n        if (stopButton) stopButton.style.display = 'inline-flex';\n    } else if (backup.startTime !== null) {\n        // Was paused when discarded\n        if (startButton) startButton.style.display = 'none';\n        if (pauseButton) pauseButton.style.display = 'none';\n        if (resumeButton) resumeButton.style.display = 'inline-flex';\n        if (stopButton) stopButton.style.display = 'inline-flex';\n    }\n\n    // Restore timer display if there was a start time\n    if (timeElement && backup.startTime !== null) {\n        const elapsed = (backup.endTime || Date.now()) - backup.startTime;\n        const seconds = Math.floor(elapsed / 1000);\n        const hours = Math.floor(seconds / 3600);\n        const minutes = Math.floor((seconds % 3600) / 60);\n        const secs = seconds % 60;\n        timeElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;\n    }\n}\n\n/**\n * Reset workout state to initial values\n */\nfunction resetWorkoutState(measurementsState: MeasurementsState, timeState: TimeState): void {\n    // Reset time state\n    timeState.running = false;\n    timeState.startTime = null;\n    timeState.endTime = null;\n\n    // Reset measurements\n    measurementsState.power = [];\n    measurementsState.heartrate = [];\n    measurementsState.cadence = [];\n\n    // Reset workout controls to idle state\n    const startButton = document.getElementById('startButton') as HTMLButtonElement | null;\n    const pauseButton = document.getElementById('pauseButton') as HTMLButtonElement | null;\n    const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n    const stopButton = document.getElementById('stopButton') as HTMLButtonElement | null;\n\n    if (startButton) startButton.style.display = 'inline-flex';\n    if (pauseButton) pauseButton.style.display = 'none';\n    if (resumeButton) resumeButton.style.display = 'none';\n    if (stopButton) stopButton.style.display = 'none';\n\n    // Reset timer display\n    const timeElement = document.getElementById('time');\n    if (timeElement) timeElement.textContent = '00:00:00';\n}\n\n/**\n * Generate a timestamp string for filenames.\n */\nfunction getExportTimestamp(): string {\n    const now = new Date();\n    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;\n}\n\n/**\n * Download a file by creating a temporary link element.\n */\nfunction downloadFile(blob: Blob, filename: string): void {\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    link.click();\n    URL.revokeObjectURL(url);\n}\n\nimport { showNotification } from './notifications.js';\nimport { stravaService } from '../integrations/strava.js';\n\n/**\n * Initialize the export button.\n *\n * Exports workout data in configured formats (TCX, CSV, JSON).\n *\n * @param measurementsState - The measurements state object\n * @param zoneState - Optional zone state for including zone data in exports\n */\nexport const initExportButton = (measurementsState: MeasurementsState, zoneState?: ZoneState): void => {\n    const exportDataElem = document.getElementById('exportData');\n\n    if (!exportDataElem) {\n        console.warn('Export button not found in DOM');\n        return;\n    }\n\n    const addListener = (btn: HTMLElement, callback: () => void) => {\n        const handler = (e: Event) => {\n            e.stopPropagation();\n            callback();\n        };\n        btn.addEventListener('click', handler);\n    };\n\n    addListener(exportDataElem, () => {\n        try {\n            // Get export format settings\n            const settingsJson = localStorage.getItem('bpt-settings');\n            const settings: AppSettings = settingsJson\n                ? { ...defaultSettings, ...JSON.parse(settingsJson) }\n                : defaultSettings;\n\n            const timestamp = getExportTimestamp();\n            const metadata = getWorkoutMetadata();\n\n            // Create a safe filename from metadata title\n            const safeTitle = metadata?.title\n                ? metadata.title\n                      .replace(/[^a-z0-9]+/gi, '-')\n                      .substring(0, 30)\n                      .toLowerCase()\n                : 'workout';\n\n            // Show options modal\n            showConfirmation('Export Options', 'Choose an action for your workout data:', {\n                confirmText: 'Download Files',\n                confirmVariant: 'primary',\n                cancelText: 'Upload to Strava',\n                icon: '',\n            }).then((isDownload) => {\n                if (isDownload) {\n                    // Download JSON file (includes zone data and metadata)\n                    if (settings.exportJson) {\n                        const exportData: Record<string, unknown> = {\n                            metadata: metadata\n                                ? {\n                                      title: metadata.title,\n                                      notes: metadata.notes || null,\n                                      perceivedExertion: metadata.perceivedExertion || null,\n                                  }\n                                : null,\n                            power: measurementsState.power,\n                            heartrate: measurementsState.heartrate,\n                            cadence: measurementsState.cadence,\n                        };\n                        // ... (zone data logic)\n                        if (zoneState) {\n                            const zoneData = zoneState.toJSON();\n                            if (\n                                zoneData.powerZones.some((z) => z.timeInZoneMs > 0) ||\n                                zoneData.hrZones.some((z) => z.timeInZoneMs > 0)\n                            ) {\n                                exportData.zoneDistribution = {\n                                    power: zoneData.powerZones.map((z) => ({\n                                        zone: z.zone,\n                                        name: z.name,\n                                        timeSeconds: Math.round(z.timeInZoneMs / 1000),\n                                    })),\n                                    hr: zoneData.hrZones.map((z) => ({\n                                        zone: z.zone,\n                                        name: z.name,\n                                        timeSeconds: Math.round(z.timeInZoneMs / 1000),\n                                    })),\n                                };\n                            }\n                        }\n\n                        const jsonStr = JSON.stringify(exportData, null, 2);\n                        const blob = new Blob([jsonStr], { type: 'application/json' });\n                        downloadFile(blob, `${safeTitle}-${timestamp}.json`);\n                    }\n\n                    // Download CSV\n                    if (settings.exportCsv) {\n                        const csvString = getCsvString(measurementsState);\n                        const blob = new Blob([csvString], { type: 'text/csv' });\n                        downloadFile(blob, `${safeTitle}-${timestamp}.csv`);\n                    }\n\n                    // Download TCX\n                    if (settings.exportTcx) {\n                        const tcxString = getTcxString(measurementsState);\n                        const blob = new Blob([tcxString], { type: 'application/vnd.garmin.tcx+xml' });\n                        downloadFile(blob, `${safeTitle}-${timestamp}.tcx`);\n                    }\n\n                    // Download FIT (if enabled or default?) - let's add it if settings allow or default\n                    // Assuming FIT is better, let's include it if settings don't explicitly disable it\n                    // For now, adhere to existing logical flow but consider asking settings\n                    try {\n                        // Pass undefined for sport unless we have it in metadata or settings\n                        const fitData = getFitData(measurementsState, undefined);\n                        if (fitData) {\n                            const fitBlob = new Blob([fitData as unknown as BlobPart], {\n                                type: 'application/octet-stream',\n                            });\n                            downloadFile(fitBlob, `${safeTitle}-${timestamp}.fit`);\n                        }\n                    } catch (e) {\n                        // ignore\n                    }\n\n                    announce('Workout files downloaded', 'assertive');\n                } else {\n                    // Upload to Strava\n                    stravaService.handleUpload(measurementsState, metadata || undefined);\n                }\n            });\n        } catch (error) {\n            console.error('Export failed:', error);\n            showNotification('Failed to export data', 'error');\n        }\n    });\n};\n\n/**\n * Parameters for workout summary initialization\n */\ninterface InitWorkoutSummaryParams {\n    measurementsState: MeasurementsState;\n    timeState: TimeState;\n    zoneState?: ZoneState;\n}\n\n/** Module-level storage for collected workout metadata */\nlet collectedMetadata: WorkoutMetadata | null = null;\n\n/**\n * Get the collected workout metadata (for use in exports)\n */\nexport function getWorkoutMetadata(): WorkoutMetadata | null {\n    return collectedMetadata;\n}\n\n/**\n * Clear the collected workout metadata\n */\nexport function clearWorkoutMetadata(): void {\n    collectedMetadata = null;\n}\n\n/**\n * Initialize the post-workout summary modal.\n *\n * Listens for the 'workoutComplete' event and shows a summary modal\n * with workout statistics and export options.\n *\n * @param params - Object containing state objects\n */\nexport const initWorkoutSummaryModal = ({\n    measurementsState,\n    timeState,\n    zoneState,\n}: InitWorkoutSummaryParams): void => {\n    document.addEventListener('workoutComplete', async (event) => {\n        const detail = (event as CustomEvent).detail;\n\n        // Only show summary if we have data\n        const hasData =\n            measurementsState.power.length > 0 ||\n            measurementsState.heartrate.length > 0 ||\n            measurementsState.cadence.length > 0;\n\n        if (!hasData && !detail.startTime) {\n            return;\n        }\n\n        const summary = calculateWorkoutSummary(\n            detail.startTime || timeState.startTime || Date.now(),\n            detail.endTime || timeState.endTime || Date.now(),\n            measurementsState,\n            zoneState\n        );\n\n        // Check for Personal Records\n        let newRecords: string[] = [];\n        try {\n            if (await isDatabaseAvailable()) {\n                const history = await listWorkouts({ limit: 1000 }); // Fetch simplified list\n                const tracker = new PersonalRecordTracker(history.workouts);\n                newRecords = tracker.checkNewRecords(summary);\n\n                if (newRecords.length > 0) {\n                    announce(`Congratulations! You set ${newRecords.length} new personal records!`, 'assertive');\n                }\n            }\n        } catch (e) {\n            console.warn('Failed to check for PRs:', e);\n        }\n\n        await showWorkoutSummary(\n            summary,\n            {\n                onExport: async () => {\n                    // Collect metadata if settings allow\n                    if (shouldShowMetadataModal()) {\n                        collectedMetadata = await showWorkoutMetadataModal(detail.startTime || timeState.startTime);\n                    } else {\n                        // Use default metadata if prompts are disabled\n                        const { generateDefaultTitle } = await import('./workoutMetadataModal.js');\n                        collectedMetadata = {\n                            title: generateDefaultTitle(detail.startTime || timeState.startTime),\n                        };\n                    }\n\n                    try {\n                        // Archive to IndexedDB\n                        await archiveWorkout();\n                        announce('Workout saved to local history', 'polite');\n\n                        // Auto-upload to Intervals.icu\n                        const settings = getSettings();\n                        if (settings.intervals && settings.intervals.enabled && settings.intervals.autoUpload) {\n                            try {\n                                const metadata = getWorkoutMetadata();\n                                const safeTitle = metadata?.title\n                                    ? metadata.title\n                                          .replace(/[^a-z0-9]+/gi, '-')\n                                          .substring(0, 30)\n                                          .toLowerCase()\n                                    : 'workout';\n                                const timestamp = getExportTimestamp();\n\n                                // Don't await the upload so we don't block the UI reset?\n                                // Or better: await it so user sees notification before reset?\n                                // But resetWorkoutState clears data. we passed measurementsState to service?\n                                // The service generates fitData immediately.\n                                // Let's await to be safe, or start it before reset.\n                                await IntervalsService.uploadWorkout(\n                                    measurementsState,\n                                    `${safeTitle}-${timestamp}.fit`\n                                );\n                            } catch (e) {\n                                console.error('Intervals auto-upload failed', e);\n                            }\n                        }\n                    } catch (err) {\n                        console.error('Failed to save to local history', err);\n                        announce('Failed to save to local history', 'assertive');\n                    }\n\n                    // Trigger the export button click\n                    const exportButton = document.getElementById('exportData');\n                    exportButton?.click();\n\n                    // Reset state after export\n                    resetWorkoutState(measurementsState, timeState);\n                    clearWorkoutMetadata();\n                },\n                onDiscard: () => {\n                    resetWorkoutState(measurementsState, timeState);\n                    clearWorkoutMetadata();\n                    announce('Workout discarded', 'polite');\n                },\n                onKeepRecording: () => {\n                    // Resume the workout\n                    const resumeButton = document.getElementById('resumeButton') as HTMLButtonElement | null;\n                    resumeButton?.click();\n                },\n            },\n            newRecords\n        );\n    });\n};\n","/**\n * Zone State Management\n *\n * Tracks time spent in each power and heart rate zone during a workout.\n * Integrates with UserProfile for zone thresholds.\n *\n * @module ZoneState\n */\n\n/**\n * User profile for zone calculations\n */\ninterface UserProfile {\n    ftp: number | null;\n    maxHr: number | null;\n}\n\n/** Storage key for user profile */\nconst PROFILE_KEY = 'bpt-user-profile';\n\n/**\n * Load user profile from localStorage\n */\nfunction loadUserProfile(): UserProfile {\n    try {\n        const stored = localStorage.getItem(PROFILE_KEY);\n        if (stored) {\n            return JSON.parse(stored) as UserProfile;\n        }\n    } catch (e) {\n        console.warn('Failed to load user profile:', e);\n    }\n    return { ftp: null, maxHr: null };\n}\n\n/**\n * Calculate power zones based on FTP (Coggan 7-zone model)\n */\nfunction calculatePowerZones(ftp: number): { name: string; min: number; max: number }[] {\n    return [\n        { name: 'Active Recovery', min: 0, max: Math.round(ftp * 0.55) },\n        { name: 'Endurance', min: Math.round(ftp * 0.55), max: Math.round(ftp * 0.75) },\n        { name: 'Tempo', min: Math.round(ftp * 0.75), max: Math.round(ftp * 0.9) },\n        { name: 'Threshold', min: Math.round(ftp * 0.9), max: Math.round(ftp * 1.05) },\n        { name: 'VO2max', min: Math.round(ftp * 1.05), max: Math.round(ftp * 1.2) },\n        { name: 'Anaerobic', min: Math.round(ftp * 1.2), max: Math.round(ftp * 1.5) },\n        { name: 'Neuromuscular', min: Math.round(ftp * 1.5), max: 9999 },\n    ];\n}\n\n/**\n * Calculate heart rate zones based on max HR (5-zone model)\n */\nfunction calculateHrZones(maxHr: number): { name: string; min: number; max: number }[] {\n    return [\n        { name: 'Recovery', min: Math.round(maxHr * 0.5), max: Math.round(maxHr * 0.6) },\n        { name: 'Aerobic', min: Math.round(maxHr * 0.6), max: Math.round(maxHr * 0.7) },\n        { name: 'Tempo', min: Math.round(maxHr * 0.7), max: Math.round(maxHr * 0.8) },\n        { name: 'Threshold', min: Math.round(maxHr * 0.8), max: Math.round(maxHr * 0.9) },\n        { name: 'Anaerobic', min: Math.round(maxHr * 0.9), max: maxHr },\n    ];\n}\n\n/**\n * Get current power zone for a given wattage\n */\nfunction getPowerZone(power: number, ftp: number): { zone: number; name: string } | null {\n    const zones = calculatePowerZones(ftp);\n    for (let i = 0; i < zones.length; i++) {\n        if (power >= zones[i].min && power < zones[i].max) {\n            return { zone: i + 1, name: zones[i].name };\n        }\n    }\n    return null;\n}\n\n/**\n * Get current HR zone for a given heart rate\n */\nfunction getHrZone(hr: number, maxHr: number): { zone: number; name: string } | null {\n    const zones = calculateHrZones(maxHr);\n    for (let i = 0; i < zones.length; i++) {\n        if (hr >= zones[i].min && hr <= zones[i].max) {\n            return { zone: i + 1, name: zones[i].name };\n        }\n    }\n    return null;\n}\n\n/**\n * Zone information with time tracking\n */\nexport interface ZoneInfo {\n    zone: number;\n    name: string;\n    min: number;\n    max: number;\n    timeInZoneMs: number;\n}\n\n/**\n * Current zone status for real-time display\n */\nexport interface CurrentZoneStatus {\n    zone: number;\n    name: string;\n    percentInZone: number; // 0-100, position within zone range\n}\n\n/**\n * Zone distribution data for summary\n */\nexport interface ZoneDistribution {\n    zones: ZoneInfo[];\n    totalTimeMs: number;\n}\n\n/**\n * State change callback type\n */\nexport type ZoneStateChangeCallback = () => void;\n\n/**\n * Zone State class for tracking time in zones\n */\nexport class ZoneState {\n    private _powerZones: ZoneInfo[] = [];\n    private _hrZones: ZoneInfo[] = [];\n    private _lastPowerZone: number | null = null;\n    private _lastHrZone: number | null = null;\n    private _lastUpdateTime: number | null = null;\n    private _ftp: number | null = null;\n    private _maxHr: number | null = null;\n    private _currentPowerZone: CurrentZoneStatus | null = null;\n    private _currentHrZone: CurrentZoneStatus | null = null;\n    private _onChangeCallbacks: ZoneStateChangeCallback[] = [];\n\n    constructor() {\n        this.loadProfile();\n    }\n\n    /**\n     * Load user profile and initialize zones\n     */\n    loadProfile(): void {\n        const profile = loadUserProfile();\n        this._ftp = profile.ftp;\n        this._maxHr = profile.maxHr;\n\n        // Initialize power zones\n        if (this._ftp) {\n            const powerZonesDef = calculatePowerZones(this._ftp);\n            this._powerZones = powerZonesDef.map((z, i) => ({\n                zone: i + 1,\n                name: z.name,\n                min: z.min,\n                max: z.max,\n                timeInZoneMs: 0,\n            }));\n        }\n\n        // Initialize HR zones\n        if (this._maxHr) {\n            const hrZonesDef = calculateHrZones(this._maxHr);\n            this._hrZones = hrZonesDef.map((z, i) => ({\n                zone: i + 1,\n                name: z.name,\n                min: z.min,\n                max: z.max,\n                timeInZoneMs: 0,\n            }));\n        }\n    }\n\n    /**\n     * Register a callback for state changes\n     */\n    onChange(callback: ZoneStateChangeCallback): void {\n        this._onChangeCallbacks.push(callback);\n    }\n\n    /**\n     * Remove a state change callback\n     */\n    offChange(callback: ZoneStateChangeCallback): void {\n        const index = this._onChangeCallbacks.indexOf(callback);\n        if (index > -1) {\n            this._onChangeCallbacks.splice(index, 1);\n        }\n    }\n\n    /**\n     * Notify listeners of state change\n     */\n    private _notifyChange(): void {\n        for (const callback of this._onChangeCallbacks) {\n            try {\n                callback();\n            } catch (e) {\n                console.error('Zone state change callback error:', e);\n            }\n        }\n    }\n\n    /**\n     * Update power value and track zone time\n     */\n    updatePower(power: number, timestamp: number = Date.now()): CurrentZoneStatus | null {\n        if (!this._ftp) return null;\n\n        const zoneInfo = getPowerZone(power, this._ftp);\n        if (!zoneInfo) return null;\n\n        const currentZone = zoneInfo.zone;\n\n        // Track time in zone\n        if (this._lastUpdateTime !== null && this._lastPowerZone !== null) {\n            const timeDelta = timestamp - this._lastUpdateTime;\n            const zoneData = this._powerZones[this._lastPowerZone - 1];\n            if (zoneData && timeDelta > 0 && timeDelta < 5000) {\n                // Only count if less than 5 seconds (avoid large gaps)\n                zoneData.timeInZoneMs += timeDelta;\n            }\n        }\n\n        this._lastPowerZone = currentZone;\n        this._lastUpdateTime = timestamp;\n\n        // Calculate position within zone\n        const zoneData = this._powerZones[currentZone - 1];\n        const range = zoneData.max - zoneData.min;\n        const percentInZone = range > 0 ? Math.min(100, Math.max(0, ((power - zoneData.min) / range) * 100)) : 50;\n\n        this._currentPowerZone = {\n            zone: currentZone,\n            name: zoneInfo.name,\n            percentInZone,\n        };\n\n        this._notifyChange();\n        return this._currentPowerZone;\n    }\n\n    /**\n     * Update heart rate value and track zone time\n     */\n    updateHeartRate(hr: number, timestamp: number = Date.now()): CurrentZoneStatus | null {\n        if (!this._maxHr) return null;\n\n        const zoneInfo = getHrZone(hr, this._maxHr);\n        if (!zoneInfo) return null;\n\n        const currentZone = zoneInfo.zone;\n\n        // Track time in zone\n        if (this._lastUpdateTime !== null && this._lastHrZone !== null) {\n            const timeDelta = timestamp - this._lastUpdateTime;\n            const zoneData = this._hrZones[this._lastHrZone - 1];\n            if (zoneData && timeDelta > 0 && timeDelta < 5000) {\n                zoneData.timeInZoneMs += timeDelta;\n            }\n        }\n\n        this._lastHrZone = currentZone;\n        // Only update if no power update occurred (prevent double counting)\n        if (this._lastUpdateTime === null || timestamp - this._lastUpdateTime > 50) {\n            this._lastUpdateTime = timestamp;\n        }\n\n        // Calculate position within zone\n        const zoneData = this._hrZones[currentZone - 1];\n        const range = zoneData.max - zoneData.min;\n        const percentInZone = range > 0 ? Math.min(100, Math.max(0, ((hr - zoneData.min) / range) * 100)) : 50;\n\n        this._currentHrZone = {\n            zone: currentZone,\n            name: zoneInfo.name,\n            percentInZone,\n        };\n\n        this._notifyChange();\n        return this._currentHrZone;\n    }\n\n    /**\n     * Get current power zone status\n     */\n    getCurrentPowerZone(): CurrentZoneStatus | null {\n        return this._currentPowerZone;\n    }\n\n    /**\n     * Get current HR zone status\n     */\n    getCurrentHrZone(): CurrentZoneStatus | null {\n        return this._currentHrZone;\n    }\n\n    /**\n     * Get power zone distribution for summary\n     */\n    getPowerZoneDistribution(): ZoneDistribution {\n        const totalTimeMs = this._powerZones.reduce((sum, z) => sum + z.timeInZoneMs, 0);\n        return {\n            zones: [...this._powerZones],\n            totalTimeMs,\n        };\n    }\n\n    /**\n     * Get HR zone distribution for summary\n     */\n    getHrZoneDistribution(): ZoneDistribution {\n        const totalTimeMs = this._hrZones.reduce((sum, z) => sum + z.timeInZoneMs, 0);\n        return {\n            zones: [...this._hrZones],\n            totalTimeMs,\n        };\n    }\n\n    /**\n     * Check if power zones are configured\n     */\n    hasPowerZones(): boolean {\n        return this._ftp !== null && this._ftp > 0;\n    }\n\n    /**\n     * Check if HR zones are configured\n     */\n    hasHrZones(): boolean {\n        return this._maxHr !== null && this._maxHr > 0;\n    }\n\n    /**\n     * Get FTP value\n     */\n    getFtp(): number | null {\n        return this._ftp;\n    }\n\n    /**\n     * Get Max HR value\n     */\n    getMaxHr(): number | null {\n        return this._maxHr;\n    }\n\n    /**\n     * Reset all zone tracking data\n     */\n    reset(): void {\n        this._powerZones.forEach((z) => (z.timeInZoneMs = 0));\n        this._hrZones.forEach((z) => (z.timeInZoneMs = 0));\n        this._lastPowerZone = null;\n        this._lastHrZone = null;\n        this._lastUpdateTime = null;\n        this._currentPowerZone = null;\n        this._currentHrZone = null;\n        this._notifyChange();\n    }\n\n    /**\n     * Export zone data as JSON (for exports/summary)\n     */\n    toJSON(): {\n        powerZones: ZoneInfo[];\n        hrZones: ZoneInfo[];\n        ftp: number | null;\n        maxHr: number | null;\n    } {\n        return {\n            powerZones: [...this._powerZones],\n            hrZones: [...this._hrZones],\n            ftp: this._ftp,\n            maxHr: this._maxHr,\n        };\n    }\n}\n","/**\n * Metrics Display Initialization\n *\n * Sets up zone tracking and live charts for workout metrics.\n * The actual data field display is handled by DataFieldsManager.\n *\n * @module initMetricsDisplay\n */\n\nimport type { MeasurementsState } from './measurements-state.js';\nimport { ZoneState } from './zone-state.js';\nimport type { LiveChart } from './components/LiveChart.js';\nimport { voiceFeedback } from './services/VoiceFeedback.js';\n\n/**\n * Parameters for metrics display initialization\n */\ninterface InitMetricsDisplayParams {\n    measurementsState: MeasurementsState;\n}\n\n/** Maximum age of measurement data before showing as disconnected (ms) */\nconst DATA_TIMEOUT_MS = 5000;\n\n/** Update interval for display refresh (ms) */\nconst UPDATE_INTERVAL_MS = 100;\n\n/** Zone state instance - exported for use in summary/exports */\nexport let zoneState: ZoneState;\n\n/**\n * Initialize live charts for power and heart rate\n */\nfunction initLiveCharts(): { powerChart: LiveChart | null; hrChart: LiveChart | null } {\n    let powerChart = document.getElementById('powerLiveChart') as LiveChart | null;\n    let hrChart = document.getElementById('hrLiveChart') as LiveChart | null;\n\n    // Create charts container if it doesn't exist\n    let chartsContainer = document.getElementById('liveChartsContainer');\n    if (!chartsContainer) {\n        const metricsSection = document.getElementById('yourMetrics');\n        if (metricsSection) {\n            chartsContainer = document.createElement('div');\n            chartsContainer.id = 'liveChartsContainer';\n            chartsContainer.className = 'live-charts-container';\n            chartsContainer.style.display = 'none'; // Hidden by default\n\n            // Insert after data fields carousel\n            const dataFieldsCarousel = document.getElementById('dataFieldsCarousel');\n            if (dataFieldsCarousel && dataFieldsCarousel.nextSibling) {\n                metricsSection.insertBefore(chartsContainer, dataFieldsCarousel.nextSibling);\n            } else {\n                metricsSection.appendChild(chartsContainer);\n            }\n        }\n    }\n\n    if (chartsContainer) {\n        // Create power chart if it doesn't exist\n        if (!powerChart) {\n            powerChart = document.createElement('bpt-live-chart') as LiveChart;\n            powerChart.id = 'powerLiveChart';\n            powerChart.setAttribute('type', 'power');\n            powerChart.setAttribute('duration', '60');\n            chartsContainer.appendChild(powerChart);\n        }\n\n        // Create HR chart if it doesn't exist\n        if (!hrChart) {\n            hrChart = document.createElement('bpt-live-chart') as LiveChart;\n            hrChart.id = 'hrLiveChart';\n            hrChart.setAttribute('type', 'heartrate');\n            hrChart.setAttribute('duration', '60');\n            chartsContainer.appendChild(hrChart);\n        }\n    }\n\n    return { powerChart, hrChart };\n}\n\n/**\n * Get or create the charts toggle button\n */\nfunction initChartsToggle(chartsVisible: boolean): HTMLButtonElement | null {\n    let toggleBtn = document.getElementById('toggleLiveCharts') as HTMLButtonElement | null;\n\n    if (!toggleBtn) {\n        const topBarControls = document.getElementById('topBarControls');\n        if (topBarControls) {\n            toggleBtn = document.createElement('button');\n            toggleBtn.id = 'toggleLiveCharts';\n            toggleBtn.className = 'workout-btn workout-btn-chart';\n            toggleBtn.setAttribute('aria-label', 'Toggle live charts');\n            toggleBtn.setAttribute('title', 'Toggle Charts');\n            toggleBtn.innerHTML = '';\n            toggleBtn.style.display = 'none'; // Hidden until workout starts\n\n            // Insert before workout controls\n            const workoutControls = document.querySelector('.workout-controls');\n            if (workoutControls) {\n                topBarControls.insertBefore(toggleBtn, workoutControls);\n            } else {\n                topBarControls.appendChild(toggleBtn);\n            }\n        }\n    }\n\n    if (toggleBtn) {\n        toggleBtn.setAttribute('aria-pressed', chartsVisible ? 'true' : 'false');\n    }\n\n    return toggleBtn;\n}\n\n/**\n * Initialize the metrics display update loop.\n *\n * Sets up zone tracking and live charts. The actual data field display\n * is handled by DataFieldsManager.\n *\n * @param params - Object containing state objects\n * @returns The ZoneState instance for external use\n */\nexport const initMetricsDisplay = ({ measurementsState }: InitMetricsDisplayParams): ZoneState => {\n    // Initialize zone state\n    zoneState = new ZoneState();\n\n    // Initialize live charts\n    const { powerChart, hrChart } = initLiveCharts();\n    let chartsVisible = localStorage.getItem('bpt-charts-visible') === 'true';\n\n    // Initialize charts toggle button\n    const chartsToggle = initChartsToggle(chartsVisible);\n    const chartsContainer = document.getElementById('liveChartsContainer');\n\n    // Set initial visibility\n    if (chartsContainer) {\n        chartsContainer.style.display = chartsVisible ? 'flex' : 'none';\n    }\n\n    // Charts toggle click handler\n    if (chartsToggle) {\n        chartsToggle.addEventListener('click', () => {\n            chartsVisible = !chartsVisible;\n            localStorage.setItem('bpt-charts-visible', chartsVisible ? 'true' : 'false');\n            chartsToggle.setAttribute('aria-pressed', chartsVisible ? 'true' : 'false');\n            if (chartsContainer) {\n                chartsContainer.style.display = chartsVisible ? 'flex' : 'none';\n            }\n        });\n    }\n\n    // Track last data index to only push new data points\n    let lastPowerIndex = 0;\n    let lastHrIndex = 0;\n\n    // Track last zones for voice feedback\n    let lastPowerZone: number | null = null;\n    let lastHrZone: number | null = null;\n\n    /**\n     * Update live charts with new data\n     */\n    const updateLiveCharts = (): void => {\n        // Update power chart\n        if (powerChart && measurementsState.power.length > lastPowerIndex) {\n            for (let i = lastPowerIndex; i < measurementsState.power.length; i++) {\n                const point = measurementsState.power[i];\n                powerChart.addDataPoint(point.value, point.timestamp);\n            }\n            lastPowerIndex = measurementsState.power.length;\n        }\n\n        // Update HR chart\n        if (hrChart && measurementsState.heartrate.length > lastHrIndex) {\n            for (let i = lastHrIndex; i < measurementsState.heartrate.length; i++) {\n                const point = measurementsState.heartrate[i];\n                hrChart.addDataPoint(point.value, point.timestamp);\n            }\n            lastHrIndex = measurementsState.heartrate.length;\n        }\n    };\n\n    /**\n     * Update zone tracking and trigger voice announcements\n     */\n    const updateZoneTracking = (): void => {\n        // Update power zones\n        if (measurementsState.power.length > 0) {\n            const latest = measurementsState.power[measurementsState.power.length - 1];\n            if (Date.now() - latest.timestamp < DATA_TIMEOUT_MS) {\n                const zoneInfo = zoneState.updatePower(latest.value, latest.timestamp);\n                const currentZone = zoneInfo?.zone ?? null;\n\n                if (currentZone !== lastPowerZone) {\n                    if (currentZone !== null && lastPowerZone !== null) {\n                        voiceFeedback.announceZoneChange(zoneInfo!.name);\n                    }\n                    lastPowerZone = currentZone;\n                }\n            }\n        }\n\n        // Update HR zones\n        if (measurementsState.heartrate.length > 0) {\n            const latest = measurementsState.heartrate[measurementsState.heartrate.length - 1];\n            if (Date.now() - latest.timestamp < DATA_TIMEOUT_MS) {\n                const zoneInfo = zoneState.updateHeartRate(latest.value, latest.timestamp);\n                const currentZone = zoneInfo?.zone ?? null;\n\n                if (currentZone !== lastHrZone) {\n                    if (currentZone !== null && lastHrZone !== null) {\n                        voiceFeedback.announceZoneChange(zoneInfo!.name);\n                    }\n                    lastHrZone = currentZone;\n                }\n            }\n        }\n    };\n\n    // Start the update loop for charts and zone tracking\n    setInterval(() => {\n        updateZoneTracking();\n        updateLiveCharts();\n    }, UPDATE_INTERVAL_MS);\n\n    // Show/hide charts toggle based on workout state\n    document.addEventListener('workoutStarted', () => {\n        if (chartsToggle) {\n            chartsToggle.style.display = 'inline-flex';\n        }\n    });\n\n    document.addEventListener('workoutStopped', () => {\n        if (chartsToggle) {\n            chartsToggle.style.display = 'none';\n        }\n    });\n\n    // Listen for profile updates to reload zones\n    window.addEventListener('storage', (e) => {\n        if (e.key === 'bpt-user-profile') {\n            zoneState.loadProfile();\n        }\n    });\n\n    // Listen for workout discard to reset zones and charts\n    document.addEventListener('workout-discarded', () => {\n        zoneState.reset();\n        lastPowerIndex = 0;\n        lastHrIndex = 0;\n        if (powerChart) powerChart.clear();\n        if (hrChart) hrChart.clear();\n    });\n\n    return zoneState;\n};\n","/**\n * API client for the BPT streaming service\n * Handles communication with the Redis Streams API\n *\n * @module streamClient\n */\n\n// Use relative path for proxy in development, or custom URL in production\nconst API_BASE_URL: string = import.meta.env.VITE_API_URL || '';\nconst API_KEY: string | undefined = import.meta.env.VITE_API_KEY;\n\n/**\n * Stream information\n */\nexport interface StreamInfo {\n    name: string;\n    length: number;\n    firstMessageId: string;\n    lastMessageId: string;\n}\n\n/**\n * Stream creation response\n */\nexport interface CreateStreamResponse {\n    success: boolean;\n    streamName: string;\n    messageId: string;\n}\n\n/**\n * Message response\n */\nexport interface MessageResponse {\n    success: boolean;\n    messageId: string;\n    streamName: string;\n}\n\n/**\n * Messages query options\n */\nexport interface GetMessagesOptions {\n    start?: string;\n    end?: string;\n    count?: number;\n}\n\n/**\n * Stream messages response\n */\nexport interface StreamMessagesResponse {\n    streamName: string;\n    messages: StreamMessageData[];\n}\n\n/**\n * Message data from stream\n */\nexport interface StreamMessageData {\n    id: string;\n    fields: Record<string, string>;\n}\n\n/**\n * SSE message callback\n */\nexport type SSEMessageCallback = (data: SSEMessageData) => void;\n\n/**\n * SSE connected callback\n */\nexport type SSEConnectedCallback = (data: SSEConnectedData) => void;\n\n/**\n * SSE error callback\n */\nexport type SSEErrorCallback = (error: Error | Event) => void;\n\n/**\n * SSE message data\n */\nexport interface SSEMessageData {\n    type: 'message';\n    id: string;\n    streamName: string;\n    fields: Record<string, string>;\n}\n\n/**\n * SSE connected data\n */\nexport interface SSEConnectedData {\n    type: 'connected';\n    streamName: string;\n    listenerId: string;\n}\n\n/**\n * Workout data to send\n */\nexport interface WorkoutDataPayload {\n    power?: number | null;\n    cadence?: number | null;\n    heartrate?: number | null;\n    speed?: number | null;\n    distance?: number | null;\n    altitude?: number | null;\n    incline?: number | null;\n    timestamp: number;\n    elapsed: string; // usually seconds as string, or mm:ss\n}\n\n/**\n * Delete stream response\n */\nexport interface DeleteStreamResponse {\n    success: boolean;\n    message: string;\n}\n\n/**\n * Helper to get headers with authentication\n */\nfunction getHeaders(extraHeaders: Record<string, string> = {}): Record<string, string> {\n    const headers: Record<string, string> = { ...extraHeaders };\n    if (API_KEY) {\n        headers['X-API-Key'] = API_KEY;\n    }\n    return headers;\n}\n\n/**\n * Create a new stream\n *\n * @param streamName - Unique name for the stream\n * @returns Promise with stream creation result\n */\nexport async function createStream(streamName: string): Promise<CreateStreamResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/streams/create`, {\n        method: 'POST',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({ streamName }),\n    });\n\n    if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to create stream');\n    }\n\n    return response.json();\n}\n\n/**\n * List all available streams\n *\n * @returns Promise with list of streams\n */\nexport async function listStreams(): Promise<{ streams: StreamInfo[] }> {\n    const response = await fetch(`${API_BASE_URL}/api/streams`, {\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const error = await response.text();\n        throw new Error(error || 'Failed to list streams');\n    }\n\n    return response.json();\n}\n\n/**\n * Add a message to a stream\n *\n * @param streamName - Name of the stream\n * @param message - Message content\n * @param author - Message author\n * @returns Promise with message result\n */\nexport async function addMessage(\n    streamName: string,\n    message: string,\n    author: string = 'anonymous'\n): Promise<MessageResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/streams/${streamName}/messages`, {\n        method: 'POST',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({ message, author }),\n    });\n\n    if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to add message');\n    }\n\n    return response.json();\n}\n\n/**\n * Get messages from a stream\n *\n * @param streamName - Name of the stream\n * @param options - Query options\n * @returns Promise with stream messages\n */\nexport async function getMessages(\n    streamName: string,\n    options: GetMessagesOptions = {}\n): Promise<StreamMessagesResponse> {\n    const { start = '-', end = '+', count = 100 } = options;\n    const params = new URLSearchParams({ start, end, count: count.toString() });\n\n    const response = await fetch(`${API_BASE_URL}/api/streams/${streamName}/messages?${params}`, {\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to get messages');\n    }\n\n    return response.json();\n}\n\n/**\n * SSE Connection interface for fetch-based SSE\n * Provides a consistent API similar to EventSource\n */\nexport interface SSEConnection {\n    /** Close the SSE connection */\n    close: () => void;\n    /** Whether the connection is active */\n    readonly active: boolean;\n}\n\n/**\n * Create a fetch-based SSE connection that supports custom headers\n * Unlike EventSource, this allows sending authentication via headers\n *\n * @param url - The SSE endpoint URL\n * @param onMessage - Callback for each SSE message\n * @param onConnected - Callback when connection is established\n * @param onError - Callback for errors\n * @returns SSEConnection object with close() method\n */\nexport function createFetchSSE(\n    url: string,\n    onMessage: SSEMessageCallback,\n    onConnected?: SSEConnectedCallback,\n    onError?: SSEErrorCallback\n): SSEConnection {\n    const controller = new AbortController();\n    let isActive = true;\n\n    const connection: SSEConnection = {\n        close: () => {\n            isActive = false;\n            controller.abort();\n        },\n        get active() {\n            return isActive;\n        },\n    };\n\n    // Start the fetch in the background\n    (async () => {\n        try {\n            const response = await fetch(url, {\n                method: 'GET',\n                headers: getHeaders({\n                    Accept: 'text/event-stream',\n                    'Cache-Control': 'no-cache',\n                }),\n                signal: controller.signal,\n            });\n\n            if (!response.ok) {\n                throw new Error(`SSE connection failed: ${response.status} ${response.statusText}`);\n            }\n\n            if (!response.body) {\n                throw new Error('SSE response has no body');\n            }\n\n            const reader = response.body.getReader();\n            const decoder = new TextDecoder();\n            let buffer = '';\n\n            while (isActive) {\n                const { done, value } = await reader.read();\n\n                if (done) {\n                    break;\n                }\n\n                buffer += decoder.decode(value, { stream: true });\n\n                // Process complete SSE messages (separated by double newlines)\n                const messages = buffer.split('\\n\\n');\n                buffer = messages.pop() || ''; // Keep incomplete message in buffer\n\n                for (const message of messages) {\n                    if (!message.trim()) continue;\n\n                    // Parse SSE format: \"data: {...}\\n\"\n                    const dataMatch = message.match(/^data:\\s*(.+)$/m);\n                    if (dataMatch) {\n                        try {\n                            const data = JSON.parse(dataMatch[1]);\n\n                            if (data.type === 'connected' && onConnected) {\n                                onConnected(data);\n                            } else if (data.type === 'message') {\n                                onMessage(data);\n                            }\n                        } catch (parseError) {\n                            console.error('Error parsing SSE data:', parseError);\n                        }\n                    }\n                }\n            }\n        } catch (error) {\n            if ((error as Error).name === 'AbortError') {\n                // Connection was intentionally closed\n                return;\n            }\n            console.error('SSE connection error:', error);\n            if (onError) {\n                onError(error as Error);\n            }\n        } finally {\n            isActive = false;\n        }\n    })();\n\n    return connection;\n}\n\n/**\n * Connect to a stream and listen for real-time messages via SSE\n * Uses fetch-based SSE to support authentication headers\n *\n * @param streamName - Name of the stream to listen to\n * @param onMessage - Callback function for new messages\n * @param onConnected - Callback function when connected\n * @param onError - Callback function for errors\n * @returns SSEConnection object (call .close() to disconnect)\n */\nexport function listenToStream(\n    streamName: string,\n    onMessage: SSEMessageCallback,\n    onConnected?: SSEConnectedCallback,\n    onError?: SSEErrorCallback\n): SSEConnection {\n    const url = `${API_BASE_URL}/api/streams/${streamName}/listen`;\n    return createFetchSSE(url, onMessage, onConnected, onError);\n}\n\n/**\n * Connect to all streams and listen for real-time messages via SSE\n * Uses fetch-based SSE to support authentication headers\n *\n * @param onMessage - Callback function for new messages\n * @param onConnected - Callback function when connected\n * @param onError - Callback function for errors\n * @returns SSEConnection object (call .close() to disconnect)\n */\nexport function listenToAllStreams(\n    onMessage: SSEMessageCallback,\n    onConnected?: SSEConnectedCallback,\n    onError?: SSEErrorCallback\n): SSEConnection {\n    const url = `${API_BASE_URL}/api/streams/listenAll`;\n    return createFetchSSE(url, onMessage, onConnected, onError);\n}\n\n/**\n * Send workout data to a stream\n *\n * @param streamName - Name of the stream\n * @param workoutData - Workout data to send\n * @returns Promise with message result\n */\nexport async function sendWorkoutData(streamName: string, workoutData: WorkoutDataPayload): Promise<MessageResponse> {\n    const message = JSON.stringify({\n        power: workoutData.power ?? null,\n        cadence: workoutData.cadence ?? null,\n        heartrate: workoutData.heartrate ?? null,\n        speed: workoutData.speed ?? null,\n        distance: workoutData.distance ?? null,\n        altitude: workoutData.altitude ?? null,\n        incline: workoutData.incline ?? null,\n        timestamp: workoutData.timestamp,\n        elapsed: workoutData.elapsed,\n        dataType: 'workout_metrics',\n    });\n\n    return addMessage(streamName, message, 'bike-power-tracker');\n}\n\n/**\n * Delete a stream\n *\n * @param streamName - Name of the stream to delete\n * @returns Promise with deletion result\n */\nexport async function deleteStream(streamName: string): Promise<DeleteStreamResponse> {\n    const response = await fetch(`${API_BASE_URL}/api/streams/${streamName}`, {\n        method: 'DELETE',\n        headers: getHeaders(),\n    });\n\n    if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to delete stream');\n    }\n\n    return response.json();\n}\n\n/**\n * Parameters for sending a reaction\n */\nexport interface SendReactionParams {\n    streamName: string;\n    type: 'reaction' | 'text';\n    content: string;\n    viewerId: string;\n    viewerName?: string;\n}\n\n/**\n * Send a reaction or message to a stream\n *\n * @param params - Reaction parameters\n * @returns Promise with reaction result\n */\nexport const sendReaction = async (params: SendReactionParams): Promise<{ success: boolean; id?: string }> => {\n    const response = await fetch(`${API_BASE_URL}/api/streams/${params.streamName}/reactions`, {\n        method: 'POST',\n        headers: getHeaders({\n            'Content-Type': 'application/json',\n        }),\n        body: JSON.stringify({\n            type: params.type,\n            content: params.content,\n            viewerId: params.viewerId,\n            viewerName: params.viewerName,\n        }),\n    });\n\n    if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to send reaction');\n    }\n\n    return response.json();\n};\n","/**\n * Stream Viewer UI\n *\n * Displays available streams and allows viewing live workout data.\n *\n * @module streamViewer\n */\n\nimport { listStreams, listenToStream, listenToAllStreams } from '../api/streamClient.js';\nimport type { StreamInfo, SSEMessageData, SSEConnection } from '../api/streamClient.js';\nimport { ReactionPanel } from '../components/ReactionPanel.js';\n\n/**\n * Workout metrics data from stream message\n */\ninterface WorkoutMetrics {\n    power?: number | null;\n    cadence?: number | null;\n    heartrate?: number | null;\n    speed?: number | null;\n    distance?: number | null;\n    altitude?: number | null;\n    elapsed?: string;\n    dataType?: string;\n}\n\n/**\n * All streams message data\n */\ninterface AllStreamsMessageData {\n    stream: string;\n    data:\n        | {\n              message: string;\n          }\n        | WorkoutMetrics;\n}\n\n/**\n * Stream viewer class that manages the stream viewing UI\n */\nexport class StreamViewer {\n    private modal: HTMLDivElement | null = null;\n    private currentConnection: SSEConnection | null = null;\n    private streamMetricsSection: HTMLElement | null = null;\n    private allStreamsMetricsSection: HTMLElement | null = null;\n    private allStreamsConnection: SSEConnection | null = null;\n    private streamCards: Map<string, HTMLElement> = new Map();\n    private streamRows: Map<string, HTMLElement> = new Map();\n    private isCompactView: boolean = false;\n\n    constructor() {\n        this.initModal();\n        this.initInlineViewer();\n        this.initAllStreamsViewer();\n    }\n\n    /**\n     * Initialize the inline stream viewer in main content\n     */\n    private initInlineViewer(): void {\n        this.streamMetricsSection = document.getElementById('streamMetrics');\n        if (!this.streamMetricsSection) {\n            console.warn('Stream metrics section not found in DOM');\n            return;\n        }\n\n        const closeBtn = document.getElementById('closeStreamView');\n        if (closeBtn) {\n            closeBtn.addEventListener('click', () => this.disconnectFromStream());\n        }\n    }\n\n    /**\n     * Initialize the all streams viewer\n     */\n    private initAllStreamsViewer(): void {\n        this.allStreamsMetricsSection = document.getElementById('allStreamsMetrics');\n        if (!this.allStreamsMetricsSection) {\n            console.warn('All streams metrics section not found in DOM');\n            return;\n        }\n\n        const closeBtn = document.getElementById('closeAllStreamsView');\n        if (closeBtn) {\n            closeBtn.addEventListener('click', () => this.disconnectFromAllStreams());\n        }\n\n        const toggleViewBtn = document.getElementById('toggleViewBtn');\n        if (toggleViewBtn) {\n            toggleViewBtn.addEventListener('click', () => this.toggleAllStreamsView());\n        }\n    }\n\n    /**\n     * Toggle between grid and compact list view\n     */\n    private toggleAllStreamsView(): void {\n        this.isCompactView = !this.isCompactView;\n        const grid = document.getElementById('allStreamsGrid');\n        const list = document.getElementById('allStreamsList');\n        const toggleBtn = document.getElementById('toggleViewBtn');\n\n        if (this.isCompactView) {\n            if (grid) grid.style.display = 'none';\n            if (list) list.style.display = 'flex';\n            if (toggleBtn) {\n                toggleBtn.textContent = '';\n                toggleBtn.title = 'Toggle grid view';\n                toggleBtn.classList.add('active');\n            }\n        } else {\n            if (grid) grid.style.display = 'grid';\n            if (list) list.style.display = 'none';\n            if (toggleBtn) {\n                toggleBtn.textContent = '';\n                toggleBtn.title = 'Toggle compact view';\n                toggleBtn.classList.remove('active');\n            }\n        }\n    }\n\n    /**\n     * Initialize the stream viewer modal\n     */\n    private initModal(): void {\n        const modal = document.createElement('div');\n        modal.id = 'streamViewerModal';\n        modal.className = 'stream-modal';\n        modal.innerHTML = `\n      <div class=\"stream-modal-content\">\n        <div class=\"stream-modal-header\">\n          <h2> Live Streams</h2>\n          <button id=\"closeStreamModal\" class=\"close-button\">&times;</button>\n        </div>\n        <div class=\"stream-modal-body\">\n          <div class=\"stream-list-container\">\n            <div class=\"stream-list-controls\" style=\"display: flex; justify-content: space-between; margin-bottom: 10px;\">\n              <button id=\"refreshStreamList\" class=\"refresh-button\"> Refresh List</button>\n              <button id=\"viewAllStreamsBtn\" class=\"connect-button\" style=\"background-color: #4CAF50;\"> View All Streams</button>\n            </div>\n            <div id=\"streamsList\" class=\"streams-list\">\n              <p class=\"loading\">Loading streams...</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n\n        document.body.appendChild(modal);\n        this.modal = modal;\n        this.setupEventListeners();\n    }\n\n    /**\n     * Set up event listeners for modal controls\n     */\n    private setupEventListeners(): void {\n        const closeBtn = document.getElementById('closeStreamModal');\n        const refreshBtn = document.getElementById('refreshStreamList');\n        const viewAllBtn = document.getElementById('viewAllStreamsBtn');\n\n        if (closeBtn) {\n            closeBtn.addEventListener('click', () => this.close());\n        }\n        if (refreshBtn) {\n            refreshBtn.addEventListener('click', () => this.refreshStreamList());\n        }\n        if (viewAllBtn) {\n            viewAllBtn.addEventListener('click', () => this.connectToAllStreams());\n        }\n\n        if (this.modal) {\n            this.modal.addEventListener('click', (e: MouseEvent) => {\n                if (e.target === this.modal) {\n                    this.close();\n                }\n            });\n        }\n    }\n\n    /**\n     * Open the stream viewer modal\n     */\n    async open(): Promise<void> {\n        if (this.modal) {\n            this.modal.style.display = 'flex';\n        }\n        await this.refreshStreamList();\n    }\n\n    /**\n     * Close the stream viewer modal\n     */\n    close(): void {\n        if (this.modal) {\n            this.modal.style.display = 'none';\n        }\n    }\n\n    /**\n     * Refresh the list of available streams\n     */\n    async refreshStreamList(): Promise<void> {\n        const streamsList = document.getElementById('streamsList');\n        if (!streamsList) return;\n\n        streamsList.innerHTML = '<p class=\"loading\">Loading streams...</p>';\n\n        try {\n            const { streams } = await listStreams();\n\n            if (streams.length === 0) {\n                streamsList.innerHTML = '<p class=\"no-streams\">No active streams found</p>';\n                return;\n            }\n\n            streamsList.innerHTML = '';\n            streams.forEach((stream: StreamInfo) => {\n                const streamItem = this.createStreamItem(stream);\n                streamsList.appendChild(streamItem);\n            });\n        } catch (error) {\n            console.error('Failed to load streams:', error);\n            const message = error instanceof Error ? error.message : 'Unknown error';\n            streamsList.innerHTML = `<p class=\"error\">Failed to load streams: ${message}</p>`;\n        }\n    }\n\n    /**\n     * Create a stream list item element\n     */\n    private createStreamItem(stream: StreamInfo): HTMLElement {\n        const div = document.createElement('div');\n        div.className = 'stream-item';\n\n        const isWorkoutStream = stream.name.startsWith('workout-');\n        const icon = isWorkoutStream ? '' : '';\n\n        div.innerHTML = `\n      <div class=\"stream-item-info\">\n        <div class=\"stream-item-name\">${icon} ${stream.name}</div>\n        <div class=\"stream-item-meta\">\n          ${stream.length} message${stream.length !== 1 ? 's' : ''}\n        </div>\n      </div>\n      <button class=\"connect-button\" data-stream=\"${stream.name}\">\n         View\n      </button>\n    `;\n\n        const connectBtn = div.querySelector('.connect-button');\n        connectBtn?.addEventListener('click', () => {\n            this.connectToStream(stream.name);\n        });\n\n        return div;\n    }\n\n    /**\n     * Connect to a stream and view live data\n     */\n    connectToStream(streamName: string): void {\n        this.disconnectFromStream();\n\n        if (!this.streamMetricsSection) {\n            console.error('Stream metrics section not available');\n            return;\n        }\n\n        this.streamMetricsSection.style.display = 'flex';\n\n        const toggleStream = document.getElementById('toggleStreamMetrics') as HTMLInputElement | null;\n        if (toggleStream) toggleStream.checked = true;\n\n        const streamTitle = document.getElementById('streamTitle');\n        const statusEl = document.getElementById('streamStatus');\n\n        if (streamTitle) streamTitle.textContent = streamName;\n        if (statusEl) {\n            statusEl.textContent = 'Connecting...';\n            statusEl.className = 'status-badge connecting';\n        }\n\n        this.close();\n\n        // Initialize reaction panel\n        const reactionPanel = this.streamMetricsSection.querySelector('reaction-panel') as ReactionPanel | null;\n        if (reactionPanel) {\n            reactionPanel.stream = streamName;\n        }\n\n        this.currentConnection = listenToStream(\n            streamName,\n            (data: SSEMessageData) => this.handleStreamMessage(data),\n            () => this.handleStreamConnected(),\n            (error: Error | Event) => this.handleStreamError(error)\n        );\n    }\n\n    /**\n     * Connect to all streams\n     */\n    connectToAllStreams(): void {\n        this.disconnectFromStream();\n        this.disconnectFromAllStreams();\n\n        if (!this.allStreamsMetricsSection) {\n            console.error('All streams metrics section not available');\n            return;\n        }\n\n        this.allStreamsMetricsSection.style.display = 'flex';\n        this.close();\n\n        const grid = document.getElementById('allStreamsGrid');\n        const list = document.getElementById('allStreamsList');\n        if (grid) grid.innerHTML = '';\n        if (list) list.innerHTML = '';\n        this.streamCards.clear();\n        this.streamRows.clear();\n\n        const allStreamsStatus = document.getElementById('allStreamsStatus');\n        if (allStreamsStatus) {\n            allStreamsStatus.textContent = 'Connecting...';\n            allStreamsStatus.className = 'status-badge connecting';\n        }\n\n        this.allStreamsConnection = listenToAllStreams(\n            (data: SSEMessageData) => this.handleAllStreamsMessage(data as unknown as AllStreamsMessageData),\n            () => this.handleAllStreamsConnected(),\n            (error: Error | Event) => this.handleAllStreamsError(error)\n        );\n    }\n\n    /**\n     * Handle all streams connected event\n     */\n    private handleAllStreamsConnected(): void {\n        console.log('Connected to all streams');\n        const statusEl = document.getElementById('allStreamsStatus');\n        if (statusEl) {\n            statusEl.textContent = ' Connected';\n            statusEl.className = 'status-badge connected';\n        }\n    }\n\n    /**\n     * Handle all streams error\n     */\n    private handleAllStreamsError(error: Error | Event): void {\n        console.error('All streams error:', error);\n        const statusEl = document.getElementById('allStreamsStatus');\n        if (!statusEl) return;\n\n        if (this.allStreamsConnection && this.allStreamsConnection.active) {\n            statusEl.textContent = ' Reconnecting...';\n            statusEl.className = 'status-badge reconnecting';\n        } else {\n            statusEl.textContent = ' Error';\n            statusEl.className = 'status-badge error';\n        }\n    }\n\n    /**\n     * Disconnect from all streams\n     */\n    disconnectFromAllStreams(): void {\n        if (this.allStreamsConnection) {\n            this.allStreamsConnection.close();\n            this.allStreamsConnection = null;\n        }\n\n        if (this.allStreamsMetricsSection) {\n            this.allStreamsMetricsSection.style.display = 'none';\n        }\n\n        const yourMetricsSection = document.getElementById('yourMetrics');\n        if (yourMetricsSection) {\n            yourMetricsSection.style.display = 'flex';\n        }\n    }\n\n    /**\n     * Handle incoming message for all streams view\n     */\n    private handleAllStreamsMessage(data: AllStreamsMessageData): void {\n        try {\n            const streamName = data.stream;\n            const messageData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;\n\n            this.updateStreamCard(streamName, messageData);\n        } catch (error) {\n            console.error('Error parsing stream message:', error, data);\n        }\n    }\n\n    /**\n     * Update or create a stream card\n     */\n    private updateStreamCard(streamName: string, data: { message?: string } & WorkoutMetrics): void {\n        const grid = document.getElementById('allStreamsGrid');\n        const list = document.getElementById('allStreamsList');\n\n        let messageData: WorkoutMetrics = {};\n        try {\n            if (data.message) {\n                messageData = JSON.parse(data.message);\n            } else {\n                messageData = data;\n            }\n        } catch {\n            // Ignore parse errors\n        }\n\n        if (grid) {\n            let card = this.streamCards.get(streamName);\n\n            if (!card) {\n                card = document.createElement('div');\n                card.className = 'stream-card';\n                card.innerHTML = `\n          <div class=\"stream-card-name\" title=\"${streamName}\">${streamName}</div>\n          <div class=\"stream-card-power\">--</div>\n          <div class=\"stream-card-secondary\">\n            <div class=\"stream-card-metric\">\n              <span>CAD</span>\n              <span class=\"card-cadence\">--</span>\n            </div>\n            <div class=\"stream-card-metric\">\n              <span>HR</span>\n              <span class=\"card-heartrate\">--</span>\n            </div>\n          </div>\n        `;\n                grid.appendChild(card);\n                this.streamCards.set(streamName, card);\n            }\n\n            if (messageData.power !== undefined && messageData.power !== null) {\n                const powerEl = card.querySelector('.stream-card-power');\n                if (powerEl) powerEl.textContent = String(messageData.power);\n            }\n\n            if (messageData.cadence !== undefined && messageData.cadence !== null) {\n                const cadenceEl = card.querySelector('.card-cadence');\n                if (cadenceEl) cadenceEl.textContent = String(messageData.cadence);\n            }\n\n            if (messageData.heartrate !== undefined && messageData.heartrate !== null) {\n                const hrEl = card.querySelector('.card-heartrate');\n                if (hrEl) hrEl.textContent = String(messageData.heartrate);\n            }\n        }\n\n        if (list) {\n            let row = this.streamRows.get(streamName);\n\n            if (!row) {\n                row = document.createElement('div');\n                row.className = 'stream-row';\n                row.innerHTML = `\n          <span class=\"stream-row-name\" title=\"${streamName}\">${streamName}</span>\n          <span class=\"stream-row-power\">--</span>\n        `;\n                list.appendChild(row);\n                this.streamRows.set(streamName, row);\n            }\n\n            if (messageData.power !== undefined && messageData.power !== null) {\n                const powerEl = row.querySelector('.stream-row-power');\n                if (powerEl) powerEl.textContent = String(messageData.power);\n            }\n        }\n    }\n\n    /**\n     * Disconnect from the current stream\n     */\n    disconnectFromStream(): void {\n        this.disconnectFromAllStreams();\n\n        if (this.currentConnection) {\n            this.currentConnection.close();\n            this.currentConnection = null;\n        }\n\n        if (this.streamMetricsSection) {\n            this.streamMetricsSection.style.display = 'none';\n\n            const toggleStream = document.getElementById('toggleStreamMetrics') as HTMLInputElement | null;\n            if (toggleStream) toggleStream.checked = false;\n        }\n\n        const yourMetricsSection = document.getElementById('yourMetrics');\n        if (yourMetricsSection) {\n            yourMetricsSection.style.display = 'flex';\n        }\n\n        this.resetViewer();\n    }\n\n    /**\n     * Handle stream connected event\n     */\n    private handleStreamConnected(): void {\n        const statusEl = document.getElementById('streamStatus');\n        if (statusEl) {\n            statusEl.textContent = ' Connected';\n            statusEl.className = 'status-badge connected';\n        }\n    }\n\n    /**\n     * Handle incoming stream message\n     */\n    private handleStreamMessage(data: SSEMessageData): void {\n        try {\n            const messageStr = (data as unknown as { data: { message: string } }).data?.message;\n            const messageData: WorkoutMetrics =\n                typeof messageStr === 'string'\n                    ? JSON.parse(messageStr)\n                    : (data as unknown as { data: WorkoutMetrics }).data;\n\n            if (\n                messageData.dataType === 'workout_metrics' ||\n                messageData.power !== undefined ||\n                messageData.cadence !== undefined ||\n                messageData.heartrate !== undefined\n            ) {\n                this.updateMetrics(messageData);\n            }\n\n            const lastUpdateEl = document.getElementById('streamLastUpdate');\n            if (lastUpdateEl) {\n                const now = new Date();\n                lastUpdateEl.textContent = `Last update: ${now.toLocaleTimeString()}`;\n            }\n        } catch (error) {\n            console.error('Error parsing stream message:', error, data);\n        }\n    }\n\n    /**\n     * Update metrics display with new data\n     */\n    private updateMetrics(data: WorkoutMetrics): void {\n        const powerEl = document.getElementById('streamPower');\n        const cadenceEl = document.getElementById('streamCadence');\n        const heartrateEl = document.getElementById('streamHeartrate');\n        const speedEl = document.getElementById('streamSpeed');\n        const distanceEl = document.getElementById('streamDistance');\n        const altitudeEl = document.getElementById('streamAltitude');\n        const elapsedEl = document.getElementById('streamElapsed');\n\n        if (powerEl && data.power !== null && data.power !== undefined) {\n            powerEl.textContent = String(data.power);\n        }\n        if (cadenceEl && data.cadence !== null && data.cadence !== undefined) {\n            cadenceEl.textContent = String(data.cadence);\n        }\n        if (heartrateEl && data.heartrate !== null && data.heartrate !== undefined) {\n            heartrateEl.textContent = String(data.heartrate);\n        }\n        if (speedEl && data.speed !== null && data.speed !== undefined) {\n            speedEl.textContent = String(data.speed);\n        }\n        if (distanceEl && data.distance !== null && data.distance !== undefined) {\n            distanceEl.textContent = String(data.distance);\n        }\n        if (altitudeEl && data.altitude !== null && data.altitude !== undefined) {\n            altitudeEl.textContent = String(data.altitude);\n        }\n        if (elapsedEl && data.elapsed) {\n            elapsedEl.textContent = data.elapsed;\n        }\n    }\n\n    /**\n     * Handle stream error\n     */\n    private handleStreamError(error: Error | Event): void {\n        console.error('Stream error:', error);\n        const statusEl = document.getElementById('streamStatus');\n        if (!statusEl) return;\n\n        if (this.currentConnection && this.currentConnection.active) {\n            statusEl.textContent = ' Reconnecting...';\n            statusEl.className = 'status-badge reconnecting';\n        } else {\n            statusEl.textContent = ' Error';\n            statusEl.className = 'status-badge error';\n        }\n    }\n\n    /**\n     * Reset viewer display\n     */\n    private resetViewer(): void {\n        const elements = [\n            'streamPower',\n            'streamCadence',\n            'streamHeartrate',\n            'streamSpeed',\n            'streamDistance',\n            'streamAltitude',\n            'streamElapsed',\n        ];\n\n        elements.forEach((id) => {\n            const el = document.getElementById(id);\n            if (el) el.textContent = '--';\n        });\n\n        const streamLastUpdate = document.getElementById('streamLastUpdate');\n        if (streamLastUpdate) streamLastUpdate.textContent = 'Waiting for data...';\n    }\n}\n\n/**\n * Initialize stream viewer UI\n */\nexport function initStreamViewer(): StreamViewer {\n    const viewer = new StreamViewer();\n\n    const viewStreamsBtn = document.getElementById('viewStreamsButton');\n    if (viewStreamsBtn) {\n        viewStreamsBtn.addEventListener('click', () => viewer.open());\n    }\n\n    return viewer;\n}\n","import { createFetchSSE, type SSEConnection } from '../api/streamClient.js';\nimport type { StreamerNotification } from '../types/stream.js';\n\ntype ReactionCallback = (notification: StreamerNotification) => void;\n\nexport class ReactionListener {\n    private connection: SSEConnection | null = null;\n    private callbacks: Set<ReactionCallback> = new Set();\n    private streamName: string | null = null;\n    private reconnectAttempts: number = 0;\n    private maxReconnectAttempts: number = 5;\n    private reconnectDelay: number = 2000;\n\n    async start(streamName: string): Promise<void> {\n        this.streamName = streamName;\n        this.reconnectAttempts = 0;\n        await this.connect();\n    }\n\n    stop(): void {\n        if (this.connection) {\n            this.connection.close();\n            this.connection = null;\n        }\n        this.streamName = null;\n        this.reconnectAttempts = 0;\n    }\n\n    onReaction(callback: ReactionCallback): () => void {\n        this.callbacks.add(callback);\n        return () => this.callbacks.delete(callback);\n    }\n\n    private async connect(): Promise<void> {\n        if (!this.streamName) return;\n\n        const apiUrl = import.meta.env.VITE_API_URL || '';\n        const url = `${apiUrl}/api/streams/${this.streamName}/reactions/listen`;\n\n        this.connection = createFetchSSE(\n            url,\n            (data: any) => this.handleMessage(data),\n            () => console.log('Connected to reaction stream'),\n            (error: unknown) => this.handleError(error as Error)\n        );\n    }\n\n    private handleMessage(data: unknown): void {\n        const message = data as {\n            type: string;\n            id: string;\n            data: {\n                type: 'reaction' | 'text';\n                content: string;\n                viewerId: string;\n                viewerName?: string;\n                timestamp: string;\n            };\n        };\n\n        if (message.type === 'reaction') {\n            const notification: StreamerNotification = {\n                id: message.id,\n                type: message.data.type,\n                content: message.data.content,\n                viewerId: message.data.viewerId,\n                viewerName: message.data.viewerName,\n                timestamp: parseInt(message.data.timestamp),\n            };\n\n            this.callbacks.forEach((cb) => cb(notification));\n        }\n    }\n\n    private handleError(error: Error): void {\n        console.error('Reaction listener error:', error);\n\n        if (this.reconnectAttempts < this.maxReconnectAttempts && this.streamName) {\n            this.reconnectAttempts++;\n            const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\n            setTimeout(() => this.connect(), delay);\n        }\n    }\n}\n","/**\n * Streaming Controls Initialization\n *\n * Sets up UI controls for starting, pausing, and stopping workout streaming.\n *\n * @module initStreamingControls\n */\n\nimport { showNotification } from './ui/notifications.js';\nimport type { StreamManager, StreamStatus } from './stream-manager.js';\nimport type { TimeState } from './getInitState.js';\nimport { ReactionListener } from './services/ReactionListener.js';\nimport { ReactionDisplay } from './components/ReactionDisplay.js';\n\n/**\n * Initialize streaming controls.\n *\n * Sets up event handlers for:\n * - Start/stop streaming button\n * - Stream name modal\n * - Toolbar play/pause/stop buttons\n * - Auto-stop when workout ends\n *\n * @param streamManager - The stream manager instance\n * @param timeState - The workout time state\n */\nexport function initStreamingControls(streamManager: StreamManager, timeState: TimeState): void {\n    let reactionListener: ReactionListener | null = null;\n    let reactionDisplay: ReactionDisplay | null = null;\n\n    const setupReactions = async (streamName: string) => {\n        if (reactionListener) reactionListener.stop();\n        reactionListener = new ReactionListener();\n        await reactionListener.start(streamName);\n\n        if (reactionDisplay) reactionDisplay.remove();\n        reactionDisplay = document.createElement('reaction-display') as ReactionDisplay;\n        document.body.appendChild(reactionDisplay);\n\n        reactionListener.onReaction((n) => reactionDisplay?.addNotification(n));\n    };\n\n    const cleanupReactions = () => {\n        if (reactionListener) {\n            reactionListener.stop();\n            reactionListener = null;\n        }\n        if (reactionDisplay) {\n            reactionDisplay.remove();\n            reactionDisplay = null;\n        }\n    };\n\n    // Main button\n    const startStreamButton = document.getElementById('startStreamButton') as HTMLButtonElement | null;\n\n    // Modal elements\n    const modal = document.getElementById('streamNameModal') as HTMLDivElement | null;\n    const closeBtn = document.getElementById('closeStreamNameModal') as HTMLButtonElement | null;\n    const cancelBtn = document.getElementById('cancelStreamName') as HTMLButtonElement | null;\n    const confirmBtn = document.getElementById('confirmStreamName') as HTMLButtonElement | null;\n    const nameInput = document.getElementById('streamNameInput') as HTMLInputElement | null;\n\n    // Toolbar elements\n    const toolbar = document.getElementById('activeStreamToolbar') as HTMLDivElement | null;\n    const toolbarStreamName = document.getElementById('toolbarStreamName') as HTMLSpanElement | null;\n    const playPauseBtn = document.getElementById('streamPlayPauseBtn') as HTMLButtonElement | null;\n    const stopBtn = document.getElementById('streamStopBtn') as HTMLButtonElement | null;\n    const streamIndicator = document.querySelector('.stream-indicator') as HTMLElement | null;\n\n    /**\n     * Update toolbar visibility and state\n     */\n    const updateToolbar = (status: StreamStatus): void => {\n        if (!toolbar) return;\n\n        if (status.isStreaming) {\n            toolbar.style.display = 'flex';\n            document.body.classList.add('has-stream-toolbar');\n\n            if (toolbarStreamName) {\n                toolbarStreamName.textContent = status.streamName;\n            }\n\n            // Update Play/Pause button\n            if (playPauseBtn) {\n                if (status.isPaused) {\n                    playPauseBtn.textContent = '';\n                    playPauseBtn.title = 'Resume Stream';\n                    streamIndicator?.classList.add('paused');\n                } else {\n                    playPauseBtn.textContent = '';\n                    playPauseBtn.title = 'Pause Stream';\n                    streamIndicator?.classList.remove('paused');\n                }\n            }\n        } else {\n            toolbar.style.display = 'none';\n            document.body.classList.remove('has-stream-toolbar');\n        }\n    };\n\n    if (!startStreamButton) {\n        console.warn('Start stream button not found in DOM');\n        return;\n    }\n\n    /**\n     * Close the stream name modal\n     */\n    const closeModal = (): void => {\n        if (modal) modal.style.display = 'none';\n        if (nameInput) nameInput.value = '';\n    };\n\n    /**\n     * Start streaming with optional custom name\n     */\n    const startStreaming = async (): Promise<void> => {\n        const customName = nameInput?.value.trim() || '';\n\n        try {\n            const streamName = await streamManager.startStreaming(customName || undefined);\n            startStreamButton.textContent = ' Stop Streaming';\n            startStreamButton.classList.add('streaming');\n\n            updateToolbar(streamManager.getStatus());\n            showNotification(`Streaming to: ${streamName}`, 'success');\n            await setupReactions(streamName);\n            closeModal();\n        } catch (error) {\n            console.error('Failed to start streaming:', error);\n            const message = error instanceof Error ? error.message : 'Unknown error';\n            showNotification('Failed to start streaming: ' + message, 'error');\n        }\n    };\n\n    /**\n     * Stop streaming\n     */\n    const stopStreaming = async (): Promise<void> => {\n        try {\n            await streamManager.stopStreaming();\n            cleanupReactions();\n            startStreamButton.textContent = ' Start Streaming';\n            startStreamButton.classList.remove('streaming');\n\n            updateToolbar(streamManager.getStatus());\n            showNotification('Streaming stopped', 'info');\n        } catch (error) {\n            console.error(error);\n            showNotification('Error stopping stream', 'error');\n        }\n    };\n\n    // Wire up toolbar buttons\n    if (playPauseBtn) {\n        playPauseBtn.addEventListener('click', () => {\n            const status = streamManager.getStatus();\n            if (status.isPaused) {\n                streamManager.resumeStreaming();\n                showNotification('Stream Resumed', 'success');\n            } else {\n                streamManager.pauseStreaming();\n                showNotification('Stream Paused', 'info');\n            }\n            updateToolbar(streamManager.getStatus());\n        });\n    }\n\n    if (stopBtn) {\n        stopBtn.addEventListener('click', async () => {\n            if (confirm('Stop streaming?')) {\n                await stopStreaming();\n            }\n        });\n    }\n\n    // Event listeners for modal\n    if (closeBtn) closeBtn.addEventListener('click', closeModal);\n    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);\n\n    if (confirmBtn) {\n        confirmBtn.addEventListener('click', startStreaming);\n    }\n\n    if (nameInput) {\n        nameInput.addEventListener('keypress', (e: KeyboardEvent) => {\n            if (e.key === 'Enter') {\n                startStreaming();\n            }\n        });\n    }\n\n    // Close on click outside\n    if (modal) {\n        modal.addEventListener('click', (e: MouseEvent) => {\n            if (e.target === modal) closeModal();\n        });\n    }\n\n    // Main button click handler\n    startStreamButton.addEventListener('click', async () => {\n        if (streamManager.isStreaming) {\n            await stopStreaming();\n        } else {\n            if (modal) {\n                modal.style.display = 'flex';\n                nameInput?.focus();\n            } else {\n                // Fallback if modal missing\n                try {\n                    const streamName = await streamManager.startStreaming();\n                    startStreamButton.textContent = ' Stop Streaming';\n                    startStreamButton.classList.add('streaming');\n                    updateToolbar(streamManager.getStatus());\n                    showNotification(`Streaming to: ${streamName}`, 'success');\n                    await setupReactions(streamName);\n                } catch (error) {\n                    console.error('Failed to start streaming:', error);\n                    const message = error instanceof Error ? error.message : 'Unknown error';\n                    showNotification('Failed to start streaming: ' + message, 'error');\n                }\n            }\n        }\n    });\n\n    // Auto-stop streaming when workout is stopped (Pause or Stop buttons)\n    const pauseButton = document.getElementById('pauseButton');\n    const stopButton = document.getElementById('stopButton');\n\n    const handleWorkoutPause = () => {\n        if (timeState.running === false && streamManager.isStreaming) {\n            // Workout was just paused\n            setTimeout(() => {\n                if (!timeState.running && streamManager.isStreaming) {\n                    streamManager.stopStreaming();\n                    startStreamButton.textContent = ' Start Streaming';\n                    startStreamButton.classList.remove('streaming');\n                    updateToolbar(streamManager.getStatus());\n                }\n            }, 100);\n        }\n    };\n\n    if (pauseButton) {\n        pauseButton.addEventListener('click', handleWorkoutPause);\n    }\n    if (stopButton) {\n        stopButton.addEventListener('click', handleWorkoutPause);\n    }\n}\n","/**\n * Workout Builder UI\n *\n * Manages the UI for creating custom structured workouts.\n */\n\nimport type { StructuredWorkout, WorkoutStep, WorkoutTarget, IntervalType, TargetType } from '../workouts/types.js';\nimport { saveCustomWorkout } from '../storage/customWorkouts.js';\nimport { announce } from './accessibility.js';\nimport { refreshWorkoutList } from './workoutPlayer.js';\n\nlet currentSteps: WorkoutStep[] = [];\n\n/**\n * Initialize Builder UI\n */\nexport function initWorkoutBuilder(): void {\n    const createBtn = document.getElementById('createWorkoutBtn');\n    const closeBtn = document.getElementById('closeBuilderModal');\n    const cancelBtn = document.getElementById('wbCancel');\n    const saveBtn = document.getElementById('wbSave');\n    const addStepBtn = document.getElementById('wbAddStepRef');\n\n    if (createBtn) {\n        createBtn.addEventListener('click', openBuilder);\n    }\n\n    if (closeBtn) closeBtn.addEventListener('click', closeBuilder);\n    if (cancelBtn) cancelBtn.addEventListener('click', closeBuilder);\n\n    if (saveBtn) {\n        saveBtn.addEventListener('click', saveWorkout);\n    }\n\n    if (addStepBtn) {\n        addStepBtn.addEventListener('click', addStepFromForm);\n    }\n\n    // Toggle target value visibility based on type\n    const targetTypeSelect = document.getElementById('wbTargetType') as HTMLSelectElement;\n    if (targetTypeSelect) {\n        targetTypeSelect.addEventListener('change', () => {\n            const valInput = document.getElementById('wbTargetValue') as HTMLInputElement;\n            if (valInput) {\n                valInput.parentElement!.style.display = targetTypeSelect.value === 'open' ? 'none' : 'block';\n            }\n        });\n    }\n}\n\nfunction openBuilder(): void {\n    const modal = document.getElementById('workoutBuilderModal');\n    const selectionModal = document.getElementById('workoutSelectionModal');\n\n    if (selectionModal) selectionModal.style.display = 'none';\n    if (modal) {\n        modal.style.display = 'flex';\n        resetForm();\n    }\n}\n\nfunction closeBuilder(): void {\n    const modal = document.getElementById('workoutBuilderModal');\n    if (modal) modal.style.display = 'none';\n}\n\nfunction resetForm(): void {\n    currentSteps = [];\n    (document.getElementById('wbName') as HTMLInputElement).value = '';\n    (document.getElementById('wbDesc') as HTMLTextAreaElement).value = '';\n    renderSteps();\n}\n\nfunction addStepFromForm(): void {\n    const type = (document.getElementById('wbStepType') as HTMLSelectElement).value as IntervalType;\n    const durationStr = (document.getElementById('wbStepDuration') as HTMLInputElement).value;\n    const targetType = (document.getElementById('wbTargetType') as HTMLSelectElement).value as TargetType;\n    const targetValStr = (document.getElementById('wbTargetValue') as HTMLInputElement).value;\n\n    const duration = parseInt(durationStr, 10);\n    // Explicitly treat as string because it can contain unit-mixed values like 'percent_ftp'\n    const targetTypeStr = targetType as unknown as string;\n\n    if (isNaN(duration) || duration <= 0) {\n        alert('Invalid duration');\n        return;\n    }\n\n    let targetValue: number | undefined = undefined;\n    if (targetTypeStr !== 'open') {\n        // Checks against string from DOM\n        targetValue = parseInt(targetValStr, 10);\n        if (isNaN(targetValue)) {\n            alert('Invalid target value');\n            return;\n        }\n    }\n\n    // Adapt to new WorkoutTarget structure\n    const target: WorkoutTarget = {\n        type: targetTypeStr === 'open' ? 'open' : 'power',\n        unit: targetTypeStr === 'percent_ftp' ? 'percent_ftp' : 'watts',\n        value: targetValue,\n    };\n\n    const step: WorkoutStep = {\n        type,\n        duration,\n        target,\n        description: `${capitalize(type)} (${formatDuration(duration)})`,\n    };\n\n    currentSteps.push(step);\n    renderSteps();\n    announce(`Added step: ${step.description}`, 'polite');\n}\n\nfunction renderSteps(): void {\n    const list = document.getElementById('wbStepsList');\n    if (!list) return;\n\n    if (currentSteps.length === 0) {\n        list.innerHTML = `<div class=\"wb-step-empty\" style=\"text-align: center; color: var(--color-text-secondary); padding: 1rem; border: 1px dashed var(--color-border);\">\n                        No steps added yet.\n                    </div>`;\n        return;\n    }\n\n    list.innerHTML = '';\n\n    currentSteps.forEach((step, index) => {\n        const row = document.createElement('div');\n        row.className = 'wb-step-item';\n        // Add minimal styles inline for now, ideally strictly in CSS\n        row.style.background = 'var(--card-bg-hover)';\n        row.style.padding = '8px';\n        row.style.borderRadius = '4px';\n        row.style.display = 'flex';\n        row.style.justifyContent = 'space-between';\n        row.style.alignItems = 'center';\n        row.style.border = '1px solid var(--color-border)';\n\n        const t = step.target;\n        const desc = !t || t.type === 'open' ? 'Open effort' : `${t.value} ${t.unit === 'percent_ftp' ? '%' : 'W'}`;\n\n        row.innerHTML = `\n            <div>\n                <strong>${index + 1}. ${capitalize(step.type)}</strong> - ${formatDuration(step.duration)}\n                <div style=\"font-size: 0.85em; color: var(--color-text-secondary)\">${desc}</div>\n            </div>\n            <button class=\"remove-step-btn\" data-index=\"${index}\" style=\"color: var(--color-error); background: none; border: none; cursor: pointer;\"></button>\n        `;\n\n        list.appendChild(row);\n    });\n\n    // Add event listeners for remove buttons\n    list.querySelectorAll('.remove-step-btn').forEach((btn) => {\n        btn.addEventListener('click', (e) => {\n            const idx = parseInt((e.target as HTMLElement).getAttribute('data-index') || '-1', 10);\n            if (idx >= 0) {\n                currentSteps.splice(idx, 1);\n                renderSteps();\n            }\n        });\n    });\n}\n\nfunction saveWorkout(): void {\n    const name = (document.getElementById('wbName') as HTMLInputElement).value.trim();\n    const desc = (document.getElementById('wbDesc') as HTMLTextAreaElement).value.trim();\n\n    if (!name) {\n        alert('Please enter a workout name');\n        return;\n    }\n\n    if (currentSteps.length === 0) {\n        alert('Please add at least one step');\n        return;\n    }\n\n    const workout: StructuredWorkout = {\n        id: crypto.randomUUID(), // Native UUID\n        name,\n        description: desc,\n        steps: currentSteps,\n        tags: ['custom'],\n    };\n\n    saveCustomWorkout(workout);\n    refreshWorkoutList(); // Note: need to export this from workoutPlayer\n    closeBuilder();\n    announce(`Workout saved: ${name}`, 'assertive');\n}\n\nfunction capitalize(s: string): string {\n    return s.charAt(0).toUpperCase() + s.slice(1);\n}\n\nfunction formatDuration(sec: number): string {\n    const m = Math.floor(sec / 60);\n    const s = sec % 60;\n    if (m > 0) return `${m}m ${s}s`;\n    return `${s}s`;\n}\n","/**\n * Dark Mode Module\n * Handles theme switching and persistence for the app\n */\n\nimport { announce } from './accessibility.js';\n\nconst DARK_MODE_KEY = 'bpt-dark-mode';\n\nexport type ThemePreference = 'light' | 'dark' | 'system';\n\n/**\n * Get the stored theme preference from localStorage\n */\nexport function getStoredThemePreference(): ThemePreference | null {\n    try {\n        const stored = localStorage.getItem(DARK_MODE_KEY);\n        if (stored === 'light' || stored === 'dark' || stored === 'system') {\n            return stored;\n        }\n        return null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * Save theme preference to localStorage\n */\nexport function saveThemePreference(preference: ThemePreference): void {\n    try {\n        localStorage.setItem(DARK_MODE_KEY, preference);\n    } catch {\n        // localStorage might not be available\n    }\n}\n\n/**\n * Check if the system prefers dark mode\n */\nexport function systemPrefersDark(): boolean {\n    return window.matchMedia('(prefers-color-scheme: dark)').matches;\n}\n\n/**\n * Apply the theme to the document\n */\nexport function applyTheme(theme: 'light' | 'dark'): void {\n    document.documentElement.setAttribute('data-theme', theme);\n}\n\n/**\n * Get the effective theme based on preference\n */\nexport function getEffectiveTheme(preference: ThemePreference): 'light' | 'dark' {\n    if (preference === 'system') {\n        return systemPrefersDark() ? 'dark' : 'light';\n    }\n    return preference;\n}\n\n/**\n * Check if dark mode is currently active\n */\nexport function isDarkMode(): boolean {\n    return document.documentElement.getAttribute('data-theme') === 'dark';\n}\n\n/**\n * Toggle dark mode on/off\n */\nexport function toggleDarkMode(): boolean {\n    const currentlyDark = isDarkMode();\n    const newTheme = currentlyDark ? 'light' : 'dark';\n    applyTheme(newTheme);\n    saveThemePreference(newTheme);\n    return !currentlyDark;\n}\n\n/**\n * Initialize dark mode based on stored preference or system preference\n */\nexport function initDarkMode(): boolean {\n    const stored = getStoredThemePreference();\n\n    if (stored) {\n        const effectiveTheme = getEffectiveTheme(stored);\n        applyTheme(effectiveTheme);\n        return effectiveTheme === 'dark';\n    }\n\n    // Default to system preference if no stored preference\n    const systemDark = systemPrefersDark();\n    if (systemDark) {\n        applyTheme('dark');\n    }\n    // Note: Don't save preference when using system default\n    return systemDark;\n}\n\n/**\n * Set up the dark mode toggle checkbox\n */\nexport function setupDarkModeToggle(toggleElement: HTMLInputElement): void {\n    // Initialize toggle state\n    const isDark = initDarkMode();\n    toggleElement.checked = isDark;\n\n    // Handle toggle changes\n    toggleElement.addEventListener('change', () => {\n        const newTheme = toggleElement.checked ? 'dark' : 'light';\n        applyTheme(newTheme);\n        saveThemePreference(newTheme);\n        announce(`Dark mode ${toggleElement.checked ? 'enabled' : 'disabled'}`);\n    });\n\n    // Listen for system preference changes (when using system theme)\n    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\n    mediaQuery.addEventListener('change', (e) => {\n        // Only auto-switch if user hasn't set a preference\n        const stored = getStoredThemePreference();\n        if (!stored || stored === 'system') {\n            const newTheme = e.matches ? 'dark' : 'light';\n            applyTheme(newTheme);\n            toggleElement.checked = e.matches;\n            announce(`Dark mode ${e.matches ? 'enabled' : 'disabled'}`);\n        }\n    });\n\n    // Listen for storage changes (sync across tabs)\n    window.addEventListener('storage', (e) => {\n        if (e.key === DARK_MODE_KEY) {\n            const newPreference = e.newValue as ThemePreference | null;\n            if (newPreference) {\n                const effectiveTheme = getEffectiveTheme(newPreference);\n                applyTheme(effectiveTheme);\n                toggleElement.checked = effectiveTheme === 'dark';\n            } else {\n                // If cleared, revert to system\n                const systemDark = systemPrefersDark();\n                applyTheme(systemDark ? 'dark' : 'light');\n                toggleElement.checked = systemDark;\n            }\n        }\n    });\n}\n","/**\n * Onboarding Flow\n *\n * First-run setup wizard for new users.\n * Guides users through:\n * - FTP (Functional Threshold Power) entry\n * - Max Heart Rate entry\n * - Weight entry\n * - Sensor pairing guide\n * - Feature tour\n *\n * @module onboarding\n */\n\nimport { announce, trapFocus } from './accessibility.js';\nimport { showNotification } from './notifications.js';\nimport { selectElement } from '../utils/dom.js';\n\nimport { type UserProfile, loadUserProfile, saveUserProfile } from '../storage/userSettings.js';\n\nexport { loadUserProfile, saveUserProfile };\nexport type { UserProfile };\n\n/**\n * Onboarding step configuration\n */\ninterface OnboardingStep {\n    id: string;\n    title: string;\n    icon: string;\n    content: string;\n    inputType?: 'number' | 'none';\n    inputLabel?: string;\n    inputPlaceholder?: string;\n    inputUnit?: string;\n    inputMin?: number;\n    inputMax?: number;\n    profileKey?: keyof UserProfile;\n    helpText?: string;\n}\n\n/**\n * Onboarding steps configuration\n */\nconst onboardingSteps: OnboardingStep[] = [\n    {\n        id: 'welcome',\n        title: 'Welcome to Bike Power Tracker!',\n        icon: '',\n        content: `\n            <p>Let's set up your profile for personalized training zones and better workout analysis.</p>\n            <p>This will only take a minute, and you can update these settings anytime.</p>\n        `,\n    },\n    {\n        id: 'ftp',\n        title: 'Functional Threshold Power (FTP)',\n        icon: '',\n        content: `\n            <p>Your FTP is the highest power you can sustain for about an hour.</p>\n            <p>If you don't know your FTP, you can skip this and do an FTP test later.</p>\n        `,\n        inputType: 'number',\n        inputLabel: 'Your FTP',\n        inputPlaceholder: 'e.g., 200',\n        inputUnit: 'watts',\n        inputMin: 50,\n        inputMax: 500,\n        profileKey: 'ftp',\n        helpText: 'Typical range: 100-400W for recreational to elite cyclists',\n    },\n    {\n        id: 'maxhr',\n        title: 'Maximum Heart Rate',\n        icon: '',\n        content: `\n            <p>Your max HR is used to calculate heart rate training zones.</p>\n            <p>A common estimate is 220 minus your age, but actual max HR varies.</p>\n        `,\n        inputType: 'number',\n        inputLabel: 'Your Max HR',\n        inputPlaceholder: 'e.g., 185',\n        inputUnit: 'bpm',\n        inputMin: 100,\n        inputMax: 230,\n        profileKey: 'maxHr',\n        helpText: 'If unsure, use 220 - your age as a starting point',\n    },\n    {\n        id: 'weight',\n        title: 'Body Weight',\n        icon: '',\n        content: `\n            <p>Your weight is used to calculate power-to-weight ratio (W/kg), an important metric for climbing.</p>\n        `,\n        inputType: 'number',\n        inputLabel: 'Your Weight',\n        inputPlaceholder: 'e.g., 70',\n        inputUnit: 'kg',\n        inputMin: 30,\n        inputMax: 200,\n        profileKey: 'weight',\n        helpText: 'Used for calculating watts per kilogram (W/kg)',\n    },\n    {\n        id: 'sensors',\n        title: 'Connect Your Sensors',\n        icon: '',\n        content: `\n            <p>Bike Power Tracker works with Bluetooth cycling sensors:</p>\n            <ul style=\"text-align: left; margin: 16px auto; max-width: 280px;\">\n                <li><strong> Power Meter</strong> - Measures your power output in watts</li>\n                <li><strong> Cadence Sensor</strong> - Tracks your pedaling speed (RPM)</li>\n                <li><strong> Heart Rate Monitor</strong> - Monitors your heart rate</li>\n            </ul>\n            <p>Use the menu () to connect your sensors before starting a workout.</p>\n        `,\n    },\n    {\n        id: 'shortcuts',\n        title: 'Keyboard Shortcuts',\n        icon: '',\n        content: `\n            <p>Quick access to common actions:</p>\n            <table style=\"margin: 16px auto; text-align: left; border-collapse: collapse;\">\n                <tr><td style=\"padding: 4px 12px;\"><kbd>Space</kbd></td><td>Start/pause workout</td></tr>\n                <tr><td style=\"padding: 4px 12px;\"><kbd>L</kbd></td><td>Mark lap</td></tr>\n                <tr><td style=\"padding: 4px 12px;\"><kbd>M</kbd></td><td>Open menu</td></tr>\n                <tr><td style=\"padding: 4px 12px;\"><kbd>S</kbd></td><td>Open settings</td></tr>\n                <tr><td style=\"padding: 4px 12px;\"><kbd>E</kbd></td><td>Export data</td></tr>\n                <tr><td style=\"padding: 4px 12px;\"><kbd>Escape</kbd></td><td>Close modal</td></tr>\n            </table>\n        `,\n    },\n    {\n        id: 'done',\n        title: \"You're All Set!\",\n        icon: '',\n        content: `\n            <p>Your profile has been saved. You can update your settings anytime from the menu.</p>\n            <p>Ready to start your first workout? Connect a sensor and press the <strong> Start</strong> button!</p>\n        `,\n    },\n];\n\n/**\n * Create the onboarding modal element\n */\nfunction createOnboardingModal(): HTMLElement {\n    const modal = document.createElement('div');\n    modal.id = 'onboardingModal';\n    modal.className = 'stream-modal';\n    modal.setAttribute('role', 'dialog');\n    modal.setAttribute('aria-labelledby', 'onboardingTitle');\n    modal.setAttribute('aria-modal', 'true');\n    modal.style.display = 'none';\n\n    modal.innerHTML = `\n        <div class=\"stream-modal-content onboarding-modal\" style=\"max-width: 480px;\">\n            <div class=\"stream-modal-header\">\n                <h2 id=\"onboardingTitle\">\n                    <span id=\"onboardingIcon\"></span>\n                    <span id=\"onboardingStepTitle\">Welcome</span>\n                </h2>\n                <button id=\"skipOnboarding\" class=\"close-button\" aria-label=\"Skip onboarding\">&times;</button>\n            </div>\n            <div class=\"stream-modal-body\" style=\"text-align: center; padding: 24px;\">\n                <div id=\"onboardingContent\"></div>\n                <div id=\"onboardingInput\" style=\"margin: 20px 0; display: none;\">\n                    <label for=\"onboardingInputField\" id=\"onboardingInputLabel\" style=\"display: block; margin-bottom: 8px; font-weight: bold;\"></label>\n                    <div style=\"display: flex; align-items: center; justify-content: center; gap: 8px;\">\n                        <input type=\"number\" id=\"onboardingInputField\" \n                            style=\"width: 120px; padding: 12px; font-size: 18px; text-align: center; border: 2px solid #d0d7de; border-radius: 8px;\"\n                            aria-describedby=\"onboardingHelpText\">\n                        <span id=\"onboardingInputUnit\" style=\"font-size: 16px; color: #666;\"></span>\n                    </div>\n                    <p id=\"onboardingHelpText\" style=\"margin-top: 8px; font-size: 12px; color: #666;\"></p>\n                </div>\n                <div class=\"onboarding-progress\" style=\"margin: 24px 0;\">\n                    <div id=\"onboardingProgressDots\" style=\"display: flex; justify-content: center; gap: 8px;\"></div>\n                </div>\n                <div class=\"onboarding-buttons\" style=\"display: flex; justify-content: center; gap: 12px; margin-top: 20px;\">\n                    <button id=\"onboardingPrev\" style=\"padding: 12px 24px; border: 1px solid #d0d7de; background: white; border-radius: 8px; cursor: pointer; font-size: 16px;\">\n                         Back\n                    </button>\n                    <button id=\"onboardingNext\" style=\"padding: 12px 24px; border: none; background: #2196F3; color: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;\">\n                        Next \n                    </button>\n                </div>\n            </div>\n        </div>\n    `;\n\n    return modal;\n}\n\n/**\n * Render progress dots\n */\nfunction renderProgressDots(container: HTMLElement, currentStep: number, totalSteps: number): void {\n    container.innerHTML = '';\n    for (let i = 0; i < totalSteps; i++) {\n        const dot = document.createElement('span');\n        dot.style.cssText = `\n            width: 10px;\n            height: 10px;\n            border-radius: 50%;\n            background: ${i === currentStep ? '#2196F3' : '#d0d7de'};\n            transition: background 0.3s ease;\n        `;\n        dot.setAttribute('aria-hidden', 'true');\n        container.appendChild(dot);\n    }\n}\n\n/**\n * Render a step in the onboarding flow\n */\nfunction renderStep(\n    step: OnboardingStep,\n    stepIndex: number,\n    profile: UserProfile,\n    elements: {\n        icon: HTMLElement;\n        title: HTMLElement;\n        content: HTMLElement;\n        inputContainer: HTMLElement;\n        inputField: HTMLInputElement;\n        inputLabel: HTMLElement;\n        inputUnit: HTMLElement;\n        helpText: HTMLElement;\n        prevBtn: HTMLButtonElement;\n        nextBtn: HTMLButtonElement;\n        progressDots: HTMLElement;\n    }\n): void {\n    const {\n        icon,\n        title,\n        content,\n        inputContainer,\n        inputField,\n        inputLabel,\n        inputUnit,\n        helpText,\n        prevBtn,\n        nextBtn,\n        progressDots,\n    } = elements;\n\n    // Update header\n    icon.textContent = step.icon;\n    title.textContent = step.title;\n\n    // Update content\n    content.innerHTML = step.content;\n\n    // Handle input\n    if (step.inputType === 'number' && step.profileKey) {\n        inputContainer.style.display = 'block';\n        inputLabel.textContent = step.inputLabel || '';\n        inputField.placeholder = step.inputPlaceholder || '';\n        inputField.min = String(step.inputMin || 0);\n        inputField.max = String(step.inputMax || 9999);\n        inputUnit.textContent = step.inputUnit || '';\n        helpText.textContent = step.helpText || '';\n\n        // Load existing value\n        const currentValue = profile[step.profileKey];\n        inputField.value = currentValue ? String(currentValue) : '';\n        inputField.focus();\n    } else {\n        inputContainer.style.display = 'none';\n    }\n\n    // Update buttons\n    prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-block';\n\n    if (stepIndex === onboardingSteps.length - 1) {\n        nextBtn.textContent = 'Get Started! ';\n    } else if (step.inputType === 'number') {\n        nextBtn.textContent = 'Next ';\n    } else {\n        nextBtn.textContent = 'Next ';\n    }\n\n    // Update progress dots\n    renderProgressDots(progressDots, stepIndex, onboardingSteps.length);\n\n    // Announce for screen readers\n    announce(`Step ${stepIndex + 1} of ${onboardingSteps.length}: ${step.title}`);\n}\n\n/**\n * Show the onboarding flow\n */\nexport function showOnboarding(forceShow = false): Promise<UserProfile> {\n    return new Promise((resolve) => {\n        const profile = loadUserProfile();\n\n        // Check if onboarding should be shown\n        if (!forceShow && profile.onboardingComplete) {\n            resolve(profile);\n            return;\n        }\n\n        // Create modal if it doesn't exist\n        let modal = document.getElementById('onboardingModal');\n        if (!modal) {\n            modal = createOnboardingModal();\n            document.body.appendChild(modal);\n        }\n\n        // Get elements\n        const icon = selectElement('onboardingIcon');\n        const title = selectElement('onboardingStepTitle');\n        const content = selectElement('onboardingContent');\n        const inputContainer = selectElement('onboardingInput');\n        const inputField = selectElement<HTMLInputElement>('onboardingInputField');\n        const inputLabel = selectElement('onboardingInputLabel');\n        const inputUnit = selectElement('onboardingInputUnit');\n        const helpText = selectElement('onboardingHelpText');\n        const prevBtn = selectElement<HTMLButtonElement>('onboardingPrev');\n        const nextBtn = selectElement<HTMLButtonElement>('onboardingNext');\n        const skipBtn = selectElement<HTMLButtonElement>('skipOnboarding');\n        const progressDots = selectElement('onboardingProgressDots');\n\n        const elements = {\n            icon,\n            title,\n            content,\n            inputContainer,\n            inputField,\n            inputLabel,\n            inputUnit,\n            helpText,\n            prevBtn,\n            nextBtn,\n            progressDots,\n        };\n\n        let currentStep = 0;\n\n        // Save input value for current step\n        const saveCurrentInput = (): void => {\n            const step = onboardingSteps[currentStep];\n            if (step.inputType === 'number' && step.profileKey) {\n                const value = inputField.value ? parseFloat(inputField.value) : null;\n                if (value !== null && step.profileKey !== 'onboardingComplete' && step.profileKey !== 'lastUpdated') {\n                    profile[step.profileKey] = value;\n                }\n            }\n        };\n\n        // Render current step\n        const render = (): void => {\n            renderStep(onboardingSteps[currentStep], currentStep, profile, elements);\n        };\n\n        // Navigation handlers\n        const goNext = (): void => {\n            // Validate input if it's a number step\n            const step = onboardingSteps[currentStep];\n            if (step.inputType === 'number') {\n                if (!inputField.checkValidity()) {\n                    inputField.reportValidity();\n                    return;\n                }\n            }\n\n            saveCurrentInput();\n\n            if (currentStep < onboardingSteps.length - 1) {\n                currentStep++;\n                render();\n            } else {\n                // Complete onboarding\n                profile.onboardingComplete = true;\n                saveUserProfile(profile);\n                modal!.style.display = 'none';\n                showNotification('Profile saved! Ready to ride ', 'success');\n                announce('Onboarding complete. Profile saved.');\n                resolve(profile);\n            }\n        };\n\n        const goPrev = (): void => {\n            saveCurrentInput();\n            if (currentStep > 0) {\n                currentStep--;\n                render();\n            }\n        };\n\n        const skip = (): void => {\n            profile.onboardingComplete = true;\n            saveUserProfile(profile);\n            modal!.style.display = 'none';\n            announce('Onboarding skipped');\n            resolve(profile);\n        };\n\n        // Event listeners\n        nextBtn.addEventListener('click', goNext);\n        prevBtn.addEventListener('click', goPrev);\n        skipBtn.addEventListener('click', skip);\n\n        // Enter key advances\n        inputField.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter') {\n                goNext();\n            }\n        });\n\n        // Show modal\n        modal.style.display = 'flex';\n        render();\n        trapFocus(modal.querySelector('.stream-modal-content')!);\n    });\n}\n\n/**\n * Check if user should see onboarding\n */\nexport function shouldShowOnboarding(): boolean {\n    const profile = loadUserProfile();\n    return !profile.onboardingComplete;\n}\n\n/**\n * Initialize onboarding - shows wizard if first run\n */\nexport function initOnboarding(): void {\n    if (shouldShowOnboarding()) {\n        // Small delay to let the app render first\n        setTimeout(() => {\n            showOnboarding();\n        }, 500);\n    }\n}\n\n/**\n * Calculate power zones based on FTP (Coggan 7-zone model)\n */\nexport function calculatePowerZones(ftp: number): { name: string; min: number; max: number }[] {\n    return [\n        { name: 'Active Recovery', min: 0, max: Math.round(ftp * 0.55) },\n        { name: 'Endurance', min: Math.round(ftp * 0.55), max: Math.round(ftp * 0.75) },\n        { name: 'Tempo', min: Math.round(ftp * 0.75), max: Math.round(ftp * 0.9) },\n        { name: 'Threshold', min: Math.round(ftp * 0.9), max: Math.round(ftp * 1.05) },\n        { name: 'VO2max', min: Math.round(ftp * 1.05), max: Math.round(ftp * 1.2) },\n        { name: 'Anaerobic', min: Math.round(ftp * 1.2), max: Math.round(ftp * 1.5) },\n        { name: 'Neuromuscular', min: Math.round(ftp * 1.5), max: 9999 },\n    ];\n}\n\n/**\n * Calculate heart rate zones based on max HR (5-zone model)\n */\nexport function calculateHrZones(maxHr: number): { name: string; min: number; max: number }[] {\n    return [\n        { name: 'Recovery', min: Math.round(maxHr * 0.5), max: Math.round(maxHr * 0.6) },\n        { name: 'Aerobic', min: Math.round(maxHr * 0.6), max: Math.round(maxHr * 0.7) },\n        { name: 'Tempo', min: Math.round(maxHr * 0.7), max: Math.round(maxHr * 0.8) },\n        { name: 'Threshold', min: Math.round(maxHr * 0.8), max: Math.round(maxHr * 0.9) },\n        { name: 'Anaerobic', min: Math.round(maxHr * 0.9), max: maxHr },\n    ];\n}\n\n/**\n * Get current power zone for a given wattage\n */\nexport function getPowerZone(power: number, ftp: number): { zone: number; name: string } | null {\n    const zones = calculatePowerZones(ftp);\n    for (let i = 0; i < zones.length; i++) {\n        if (power >= zones[i].min && power < zones[i].max) {\n            return { zone: i + 1, name: zones[i].name };\n        }\n    }\n    return null;\n}\n\n/**\n * Get current HR zone for a given heart rate\n */\nexport function getHrZone(hr: number, maxHr: number): { zone: number; name: string } | null {\n    const zones = calculateHrZones(maxHr);\n    for (let i = 0; i < zones.length; i++) {\n        if (hr >= zones[i].min && hr <= zones[i].max) {\n            return { zone: i + 1, name: zones[i].name };\n        }\n    }\n    return null;\n}\n","/**\n * Workout Recovery\n *\n * Handles detection and recovery of interrupted workouts from IndexedDB.\n * Shows a modal to the user when a recoverable workout is found.\n *\n * @module ui/workoutRecovery\n */\n\nimport {\n    loadActiveWorkout,\n    clearActiveWorkout,\n    hasRecoverableWorkout,\n    type ActiveWorkoutRecord,\n} from '../storage/workoutStorage.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\n\n/**\n * Format elapsed time as human-readable string\n */\nfunction formatElapsedTime(ms: number): string {\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n\n    if (hours > 0) {\n        return `${hours}h ${minutes % 60}m`;\n    } else if (minutes > 0) {\n        return `${minutes}m ${seconds % 60}s`;\n    }\n    return `${seconds}s`;\n}\n\n/**\n * Format timestamp as human-readable date/time\n */\nfunction formatTime(timestamp: number): string {\n    return new Date(timestamp).toLocaleString();\n}\n\n/**\n * Create the recovery modal HTML\n */\nfunction createRecoveryModal(workout: ActiveWorkoutRecord): HTMLDialogElement {\n    const modal = document.createElement('dialog');\n    modal.id = 'workout-recovery-modal';\n    modal.className = 'modal';\n    modal.setAttribute('aria-labelledby', 'recovery-modal-title');\n\n    const dataPoints = workout.power.length + workout.heartrate.length + workout.cadence.length;\n    const elapsedTime = workout.lastUpdated - workout.startTime;\n\n    modal.innerHTML = `\n        <div class=\"modal-content\">\n            <h2 id=\"recovery-modal-title\"> Recover Workout?</h2>\n            <p>An interrupted workout was found from your last session.</p>\n            \n            <div class=\"recovery-summary\">\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Started</span>\n                    <span class=\"recovery-stat-value\">${formatTime(workout.startTime)}</span>\n                </div>\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Duration</span>\n                    <span class=\"recovery-stat-value\">${formatElapsedTime(elapsedTime)}</span>\n                </div>\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Data Points</span>\n                    <span class=\"recovery-stat-value\">${dataPoints.toLocaleString()}</span>\n                </div>\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Power Readings</span>\n                    <span class=\"recovery-stat-value\">${workout.power.length.toLocaleString()}</span>\n                </div>\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Heart Rate Readings</span>\n                    <span class=\"recovery-stat-value\">${workout.heartrate.length.toLocaleString()}</span>\n                </div>\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Cadence Readings</span>\n                    <span class=\"recovery-stat-value\">${workout.cadence.length.toLocaleString()}</span>\n                </div>\n                ${\n                    workout.laps.length > 0\n                        ? `\n                <div class=\"recovery-stat\">\n                    <span class=\"recovery-stat-label\">Laps</span>\n                    <span class=\"recovery-stat-value\">${workout.laps.length}</span>\n                </div>\n                `\n                        : ''\n                }\n            </div>\n            \n            <div class=\"modal-actions\">\n                <button type=\"button\" id=\"recovery-restore-btn\" class=\"btn btn-primary\">\n                     Restore Workout\n                </button>\n                <button type=\"button\" id=\"recovery-discard-btn\" class=\"btn btn-secondary\">\n                     Start Fresh\n                </button>\n            </div>\n        </div>\n    `;\n\n    return modal;\n}\n\n/**\n * Add styles for the recovery modal\n */\nfunction addRecoveryStyles(): void {\n    if (document.getElementById('recovery-modal-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'recovery-modal-styles';\n    style.textContent = `\n        #workout-recovery-modal {\n            max-width: 400px;\n        }\n        \n        .recovery-summary {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 0.75rem;\n            margin: 1.5rem 0;\n            padding: 1rem;\n            background: var(--surface-2, #2a2a2a);\n            border-radius: 8px;\n        }\n        \n        .recovery-stat {\n            display: flex;\n            flex-direction: column;\n            gap: 0.25rem;\n        }\n        \n        .recovery-stat-label {\n            font-size: 0.75rem;\n            color: var(--text-muted, #888);\n            text-transform: uppercase;\n            letter-spacing: 0.05em;\n        }\n        \n        .recovery-stat-value {\n            font-size: 1rem;\n            font-weight: 600;\n            color: var(--text-primary, #fff);\n        }\n        \n        #workout-recovery-modal .modal-actions {\n            display: flex;\n            flex-direction: column;\n            gap: 0.75rem;\n            margin-top: 1.5rem;\n        }\n        \n        #workout-recovery-modal .btn {\n            width: 100%;\n            padding: 0.875rem 1.5rem;\n            font-size: 1rem;\n        }\n    `;\n\n    document.head.appendChild(style);\n}\n\n/**\n * Show the recovery modal and wait for user decision\n */\nasync function showRecoveryModal(workout: ActiveWorkoutRecord): Promise<'restore' | 'discard'> {\n    addRecoveryStyles();\n\n    const modal = createRecoveryModal(workout);\n    document.body.appendChild(modal);\n\n    return new Promise((resolve) => {\n        const restoreBtn = modal.querySelector('#recovery-restore-btn') as HTMLButtonElement;\n        const discardBtn = modal.querySelector('#recovery-discard-btn') as HTMLButtonElement;\n\n        const cleanup = () => {\n            modal.close();\n            modal.remove();\n        };\n\n        restoreBtn.addEventListener('click', () => {\n            cleanup();\n            resolve('restore');\n        });\n\n        discardBtn.addEventListener('click', () => {\n            cleanup();\n            resolve('discard');\n        });\n\n        // Handle escape key\n        modal.addEventListener('cancel', (e) => {\n            e.preventDefault(); // Don't close on escape - force user to choose\n        });\n\n        modal.showModal();\n    });\n}\n\n/**\n * Check for and handle workout recovery\n *\n * @param measurementsState - The measurements state to restore to\n * @param timeState - The time state to restore to\n * @returns True if a workout was recovered\n */\nexport async function initWorkoutRecovery(\n    measurementsState: MeasurementsState,\n    timeState: TimeState\n): Promise<boolean> {\n    try {\n        // Check if there's a recoverable workout\n        if (!(await hasRecoverableWorkout())) {\n            return false;\n        }\n\n        // Load the workout data\n        const workout = await loadActiveWorkout();\n        if (!workout) {\n            return false;\n        }\n\n        // Show recovery modal and get user choice\n        const choice = await showRecoveryModal(workout);\n\n        if (choice === 'restore') {\n            // Restore the workout data\n            measurementsState.restore(\n                {\n                    heartrate: workout.heartrate,\n                    power: workout.power,\n                    cadence: workout.cadence,\n                    speed: workout.speed,\n                    distance: workout.distance,\n                    altitude: workout.altitude,\n                    laps: workout.laps,\n                    gps: workout.gps || [],\n                },\n                workout.startTime\n            );\n\n            // Restore time state\n            timeState.startTime = workout.startTime;\n            timeState.running = false; // Don't auto-resume - let user reconnect sensors\n\n            console.log(`Restored workout with ${workout.power.length} power readings`);\n            return true;\n        } else {\n            // User chose to discard\n            await clearActiveWorkout();\n            console.log('User discarded recovered workout');\n            return false;\n        }\n    } catch (error) {\n        console.error('Error during workout recovery:', error);\n        return false;\n    }\n}\n\n/**\n * Clear any pending workout data (for testing or manual cleanup)\n */\nexport async function clearRecoverableWorkout(): Promise<void> {\n    await clearActiveWorkout();\n}\n","/**\n * PWA Install Prompt\n *\n * Handles the PWA installation prompt for supported browsers.\n *\n * @module installPrompt\n */\n\n/**\n * Deferred install prompt event\n */\nlet deferredPrompt: BeforeInstallPromptEvent | null = null;\n\n/**\n * Extended event interface for beforeinstallprompt\n */\ninterface BeforeInstallPromptEvent extends Event {\n    prompt(): Promise<void>;\n    userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;\n}\n\n/**\n * Initialize the PWA install prompt handler.\n *\n * Listens for the beforeinstallprompt event and captures it for later use.\n */\nexport const initInstallPrompt = (): void => {\n    // Skip in test mode\n    if (import.meta.env.MODE === 'test') {\n        return;\n    }\n\n    // Listen for the beforeinstallprompt event\n    window.addEventListener('beforeinstallprompt', (e: Event) => {\n        // Prevent the mini-infobar from appearing on mobile\n        e.preventDefault();\n\n        // Stash the event so it can be triggered later\n        deferredPrompt = e as BeforeInstallPromptEvent;\n\n        // Update install button visibility in settings\n        updateInstallButtonVisibility();\n    });\n\n    // Listen for the app installed event\n    window.addEventListener('appinstalled', () => {\n        console.log('PWA was installed successfully');\n        deferredPrompt = null;\n        updateInstallButtonVisibility();\n    });\n};\n\n/**\n * Check if the app can be installed.\n * @returns true if install is available\n */\nexport const canInstallPwa = (): boolean => {\n    return deferredPrompt !== null;\n};\n\n/**\n * Trigger the PWA install prompt.\n * @returns Promise that resolves to the user's choice outcome\n */\nexport const triggerInstallPrompt = async (): Promise<'accepted' | 'dismissed' | 'unavailable'> => {\n    if (!deferredPrompt) {\n        return 'unavailable';\n    }\n\n    try {\n        // Show the install prompt\n        await deferredPrompt.prompt();\n\n        // Wait for the user to respond to the prompt\n        const { outcome } = await deferredPrompt.userChoice;\n        console.log(`User response to the install prompt: ${outcome}`);\n\n        // Clear the deferredPrompt\n        deferredPrompt = null;\n        updateInstallButtonVisibility();\n\n        return outcome;\n    } catch (error) {\n        console.error('Error triggering install prompt:', error);\n        return 'unavailable';\n    }\n};\n\n/**\n * Update the visibility of install buttons based on availability.\n */\nconst updateInstallButtonVisibility = (): void => {\n    const installButton = document.getElementById('installPwaButton');\n    const installButtonContainer = document.getElementById('installPwaContainer');\n\n    if (installButton) {\n        installButton.style.display = canInstallPwa() ? 'block' : 'none';\n    }\n\n    if (installButtonContainer) {\n        installButtonContainer.style.display = canInstallPwa() ? 'block' : 'none';\n    }\n};\n","/**\n * About Modal\n *\n * Manages the About modal.\n *\n * @module about\n */\n\n/**\n * Initialize the About modal\n */\nexport function initAboutModal(): void {\n    const aboutButton = document.getElementById('aboutButton');\n    const aboutModal = document.getElementById('aboutModal');\n    const closeAboutModal = document.getElementById('closeAboutModal');\n\n    if (!aboutButton || !aboutModal) {\n        return;\n    }\n\n    /**\n     * Open the about modal\n     */\n    const openModal = (): void => {\n        aboutModal.style.display = 'flex';\n        // Close the main menu details element\n        const details = document.querySelector('header details');\n        if (details) {\n            details.removeAttribute('open');\n        }\n    };\n\n    /**\n     * Close the about modal\n     */\n    const closeModal = (): void => {\n        aboutModal.style.display = 'none';\n    };\n\n    // Event Listeners\n    aboutButton.addEventListener('click', openModal);\n    closeAboutModal?.addEventListener('click', closeModal);\n\n    // Close modal when clicking outside\n    window.addEventListener('click', (event: MouseEvent) => {\n        if (event.target === aboutModal) {\n            closeModal();\n        }\n    });\n}\n","/**\n * Wake Lock Handler\n *\n * Keeps the screen awake during workouts using the Screen Wake Lock API.\n *\n * @module wakeLock\n */\n\n/**\n * Initialize wake lock to keep the screen awake.\n *\n * Requests a screen wake lock when the page is visible,\n * and re-requests it if the page visibility changes.\n */\nexport const handleWakeLock = (): void => {\n    let wakeLock: WakeLockSentinel | null = null;\n\n    /**\n     * Request a screen wake lock\n     */\n    const requestWakeLock = async (): Promise<void> => {\n        try {\n            if ('wakeLock' in navigator) {\n                wakeLock = await navigator.wakeLock.request('screen');\n                console.log('Screen wake lock activated');\n\n                // Re-request wake lock if page becomes visible again\n                wakeLock.addEventListener('release', () => {\n                    console.log('Screen wake lock released');\n                });\n            }\n        } catch (err) {\n            console.error('Wake lock request failed:', err);\n        }\n    };\n\n    // Request wake lock when page loads\n    if (document.visibilityState === 'visible') {\n        requestWakeLock();\n    }\n\n    // Re-request wake lock when page becomes visible\n    document.addEventListener('visibilitychange', () => {\n        if (document.visibilityState === 'visible') {\n            requestWakeLock();\n        }\n    });\n};\n","// src/client/build/register.ts\nvar autoUpdateMode = \"true\";\nvar selfDestroying = \"false\";\nvar auto = autoUpdateMode === \"true\";\nvar autoDestroy = selfDestroying === \"true\";\nfunction registerSW(options = {}) {\n  const {\n    immediate = false,\n    onNeedRefresh,\n    onOfflineReady,\n    onRegistered,\n    onRegisteredSW,\n    onRegisterError\n  } = options;\n  let wb;\n  let registerPromise;\n  let sendSkipWaitingMessage;\n  const updateServiceWorker = async (_reloadPage = true) => {\n    await registerPromise;\n    if (!auto) {\n      sendSkipWaitingMessage?.();\n    }\n  };\n  async function register() {\n    if (\"serviceWorker\" in navigator) {\n      wb = await import(\"workbox-window\").then(({ Workbox }) => {\n        return new Workbox(\"/sw.js\", { scope: \"/\", type: \"classic\" });\n      }).catch((e) => {\n        onRegisterError?.(e);\n        return void 0;\n      });\n      if (!wb)\n        return;\n      sendSkipWaitingMessage = () => {\n        wb?.messageSkipWaiting();\n      };\n      if (!autoDestroy) {\n        if (auto) {\n          wb.addEventListener(\"activated\", (event) => {\n            if (event.isUpdate || event.isExternal)\n              window.location.reload();\n          });\n          wb.addEventListener(\"installed\", (event) => {\n            if (!event.isUpdate) {\n              onOfflineReady?.();\n            }\n          });\n        } else {\n          let onNeedRefreshCalled = false;\n          const showSkipWaitingPrompt = () => {\n            onNeedRefreshCalled = true;\n            wb?.addEventListener(\"controlling\", (event) => {\n              if (event.isUpdate)\n                window.location.reload();\n            });\n            onNeedRefresh?.();\n          };\n          wb.addEventListener(\"installed\", (event) => {\n            if (typeof event.isUpdate === \"undefined\") {\n              if (typeof event.isExternal !== \"undefined\") {\n                if (event.isExternal)\n                  showSkipWaitingPrompt();\n                else\n                  !onNeedRefreshCalled && onOfflineReady?.();\n              } else {\n                !onNeedRefreshCalled && onOfflineReady?.();\n              }\n            } else if (!event.isUpdate) {\n              onOfflineReady?.();\n            }\n          });\n          wb.addEventListener(\"waiting\", showSkipWaitingPrompt);\n        }\n      }\n      wb.register({ immediate }).then((r) => {\n        if (onRegisteredSW)\n          onRegisteredSW(\"/sw.js\", r);\n        else\n          onRegistered?.(r);\n      }).catch((e) => {\n        onRegisterError?.(e);\n      });\n    }\n  }\n  registerPromise = register();\n  return updateServiceWorker;\n}\nexport {\n  registerSW\n};\n","/**\n * Service Worker Registration\n *\n * Handles PWA service worker registration using vite-plugin-pwa.\n *\n * @module serviceWorker\n */\n\nimport { registerSW } from 'virtual:pwa-register';\nimport { Capacitor } from '@capacitor/core';\n\n/**\n * Update callback type\n */\ntype UpdateCallback = (reloadPage?: boolean) => Promise<void>;\n\n/**\n * Register the service worker for PWA functionality.\n *\n * In development mode, service workers are disabled to avoid caching issues.\n * In production, registers the service worker and handles updates.\n */\nexport const registerServiceWorker = (): void => {\n    // Capacitor apps should not use service workers. They can cause hard-to-debug\n    // caching and asset-loading issues in Android WebView.\n    if (Capacitor.isNativePlatform()) {\n        console.log('Service Worker disabled on native platform');\n        if ('serviceWorker' in navigator) {\n            navigator.serviceWorker.getRegistrations().then((registrations) => {\n                for (const registration of registrations) {\n                    registration.unregister();\n                }\n            });\n        }\n        return;\n    }\n\n    // Don't register service worker in development to avoid caching issues\n    if (import.meta.env.DEV) {\n        console.log('Service Worker disabled in development mode');\n        // Unregister existing service workers if any to ensure fresh content\n        if ('serviceWorker' in navigator) {\n            navigator.serviceWorker.getRegistrations().then((registrations) => {\n                for (const registration of registrations) {\n                    registration.unregister();\n                    console.log('Unregistered existing service worker');\n                }\n            });\n        }\n        return;\n    }\n\n    // Skip in test mode\n    if (import.meta.env.MODE === 'test') {\n        return;\n    }\n\n    const updateSW = registerSW({\n        onNeedRefresh() {\n            showUpdateNotification(updateSW);\n        },\n        onOfflineReady() {\n            console.log('App ready to work offline');\n        },\n        onRegistered(registration?: ServiceWorkerRegistration) {\n            console.log('Service Worker registered successfully');\n\n            // Check for updates periodically (every hour)\n            if (registration) {\n                setInterval(\n                    () => {\n                        registration.update();\n                    },\n                    60 * 60 * 1000\n                );\n            }\n        },\n        onRegisterError(error: Error) {\n            console.log('Service Worker registration failed:', error);\n        },\n    });\n};\n\n/**\n * Show update notification when a new version is available.\n *\n * @param updateSW - Function to trigger the update\n */\nconst showUpdateNotification = (updateSW: UpdateCallback): void => {\n    const updateContainer = document.getElementById('updateNotification');\n    if (!updateContainer) return;\n\n    updateContainer.style.display = 'block';\n\n    const updateButton = document.getElementById('updateButton');\n    updateButton?.addEventListener(\n        'click',\n        () => {\n            updateSW(true); // Force reload after update\n        },\n        { once: true }\n    );\n\n    const dismissUpdateButton = document.getElementById('dismissUpdate');\n    dismissUpdateButton?.addEventListener(\n        'click',\n        () => {\n            updateContainer.style.display = 'none';\n        },\n        { once: true }\n    );\n};\n","import L from 'leaflet';\nimport type { MeasurementsState } from '../measurements-state.js';\n\nexport class MapComponent {\n    private state: MeasurementsState;\n    private map: L.Map | null = null;\n    private routeLine: L.Polyline | null = null;\n    private currentPosMarker: L.CircleMarker | null = null;\n    private mounted: boolean = false;\n    private animationFrameId: number | null = null;\n    private lastGpsCount: number = 0;\n\n    // Configuration\n    private readonly defaultZoom = 15;\n    private readonly followUser = true;\n\n    constructor(state: MeasurementsState) {\n        this.state = state;\n    }\n\n    public mount(elementId: string): void {\n        const element = document.getElementById(elementId);\n        if (!element) {\n            console.warn(`MapComponent: Element with ID \"${elementId}\" not found.`);\n            return;\n        }\n\n        // Initialize Leaflet map\n        // Start with a world view, will center on GPS update\n        this.map = L.map(elementId);\n\n        // If we have GPS data, use the last point, otherwise 0,0\n        const hasData = this.state.gps.length > 0;\n        const initialLat = hasData ? this.state.gps[this.state.gps.length - 1].lat : 0;\n        const initialLon = hasData ? this.state.gps[this.state.gps.length - 1].lon : 0;\n        const initialZoom = hasData ? this.defaultZoom : 2;\n\n        this.map.setView([initialLat, initialLon], initialZoom);\n\n        // Add OpenStreetMap tile layer\n        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {\n            attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\n        }).addTo(this.map);\n\n        // Create route polyline\n        this.routeLine = L.polyline([], {\n            color: 'var(--color-primary, #007bff)', // Use CSS var if available\n            weight: 5,\n            opacity: 0.7,\n        }).addTo(this.map);\n\n        // Create current position marker (using CircleMarker to avoid icon issues)\n        this.currentPosMarker = L.circleMarker([initialLat, initialLon], {\n            radius: 8,\n            fillColor: 'var(--color-accent, #28a745)',\n            color: '#ffffff',\n            weight: 2,\n            opacity: 1,\n            fillOpacity: 0.8,\n        });\n\n        // Only add marker if we actually have data\n        if (hasData) {\n            this.currentPosMarker.addTo(this.map);\n        }\n\n        this.mounted = true;\n        this.lastGpsCount = 0;\n\n        // Start update loop\n        this.startLoop();\n\n        // Force an immediate update to draw existing path\n        this.update();\n\n        // Handle Map Resize issues\n        setTimeout(() => {\n            this.map?.invalidateSize();\n        }, 100);\n    }\n\n    public unmount(): void {\n        this.mounted = false;\n        if (this.animationFrameId !== null) {\n            cancelAnimationFrame(this.animationFrameId);\n            this.animationFrameId = null;\n        }\n\n        if (this.map) {\n            this.map.remove();\n            this.map = null;\n        }\n        this.routeLine = null;\n        this.currentPosMarker = null;\n    }\n\n    public update(): void {\n        if (!this.mounted || !this.map || !this.routeLine || !this.currentPosMarker) {\n            return;\n        }\n\n        const gpsData = this.state.gps;\n\n        // Optimization: only update if data changed or we haven't drawn fully\n        if (gpsData.length === this.lastGpsCount) {\n            return;\n        }\n\n        const points = gpsData.map((p) => [p.lat, p.lon] as [number, number]);\n\n        // Update polyline\n        this.routeLine.setLatLngs(points);\n\n        if (gpsData.length > 0) {\n            const lastPoint = gpsData[gpsData.length - 1];\n            const latLng: [number, number] = [lastPoint.lat, lastPoint.lon];\n\n            // Update marker\n            this.currentPosMarker.setLatLng(latLng);\n\n            // Ensure marker is on map\n            if (!this.map.hasLayer(this.currentPosMarker)) {\n                this.currentPosMarker.addTo(this.map);\n            }\n\n            // Follow user logic\n            if (this.followUser) {\n                // Only pan if we are reasonably far from center to avoid jitter\n                // Or just use setView if it's the first few points\n                if (this.lastGpsCount === 0) {\n                    this.map.setView(latLng, this.defaultZoom);\n                } else {\n                    // Maybe check distance before panning?\n                    // For now, keep it simple and just pan to keep user in view\n                    // But avoid blocking UI if it updates too fast.\n                    // Since update() is in Raf this should be ok.\n                    this.map.panTo(latLng, { animate: true });\n                }\n            }\n        }\n\n        this.lastGpsCount = gpsData.length;\n    }\n\n    private startLoop(): void {\n        const loop = () => {\n            if (!this.mounted) return;\n            this.update();\n            this.animationFrameId = requestAnimationFrame(loop);\n        };\n        this.animationFrameId = requestAnimationFrame(loop);\n    }\n\n    /**\n     * Call this when container is resized\n     */\n    public resize(): void {\n        this.map?.invalidateSize();\n    }\n}\n","import { MapComponent } from '../ui/map-component.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { ConnectionsState } from '../types/connections.js';\n\n/**\n * Initialize the GPS Map component and toggle controls\n */\nexport function initMap(measurementsState: MeasurementsState, connectionsState: ConnectionsState) {\n    const mapContainerId = 'gpsMap';\n    const toggleBtnId = 'toggleMapBtn';\n    const carouselId = 'dataFieldsCarousel';\n\n    const toggleBtn = document.getElementById(toggleBtnId);\n    const mapContainer = document.getElementById(mapContainerId);\n    const carousel = document.getElementById(carouselId);\n\n    if (!toggleBtn || !mapContainer || !carousel) {\n        console.warn('Map initialization failed: Missing elements');\n        return;\n    }\n\n    const mapComponent = new MapComponent(measurementsState);\n    let isMapVisible = false;\n\n    // Initially hidden\n    toggleBtn.style.display = 'none';\n\n    // Toggle logic\n    toggleBtn.addEventListener('click', () => {\n        isMapVisible = !isMapVisible;\n\n        if (isMapVisible) {\n            // Show Map\n            carousel.style.display = 'none';\n            mapContainer.style.display = 'block';\n            toggleBtn.classList.add('active');\n            toggleBtn.style.background = '#ccc'; // Visual feedback\n\n            // Mount if first time, or just update visibility logic handled internally\n            // Note: MapComponent.mount checks if already mounted\n            mapComponent.mount(mapContainerId);\n\n            // Force resize calculation since it was hidden\n            setTimeout(() => {\n                mapComponent.resize();\n            }, 100);\n        } else {\n            // Show Metrics\n            mapContainer.style.display = 'none';\n            carousel.style.display = 'block';\n            toggleBtn.classList.remove('active');\n            toggleBtn.style.background = ''; // Reset\n\n            // mapComponent.unmount(); // Optional: keep state\n        }\n    });\n\n    // Monitor GPS status to enable the button\n    // Simple polling since ConnectionState doesn't emit events directly in this architecture (yet)\n    setInterval(() => {\n        const hasGpsData = measurementsState.gps.length > 0;\n        const isConnected = connectionsState.gps?.isConnected;\n\n        if (isConnected || hasGpsData) {\n            if (toggleBtn.style.display === 'none') {\n                toggleBtn.style.display = 'inline-block';\n            }\n        }\n    }, 2000);\n}\n","/**\n * Auto-Pause Service\n *\n * Automatically pauses workout recording when the monitored metric\n * (speed, power, or cadence) drops below a configurable threshold.\n * Automatically resumes when the metric exceeds the threshold.\n *\n * @module AutoPauseService\n */\n\nimport { getSettings, type AutoPauseSource } from '../config/settings.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\n\n/**\n * Callbacks for auto-pause/resume actions\n */\nexport interface AutoPauseCallbacks {\n    /** Called when auto-pause triggers */\n    onAutoPause: () => void;\n    /** Called when auto-resume triggers */\n    onAutoResume: () => void;\n}\n\n/**\n * Auto-pause state\n */\ninterface AutoPauseState {\n    /** Whether currently auto-paused */\n    isAutoPaused: boolean;\n    /** Timestamp when metric dropped below threshold */\n    belowThresholdSince: number | null;\n    /** Timer ID for delayed pause */\n    delayTimer: ReturnType<typeof setTimeout> | null;\n}\n\n/**\n * Service that monitors metrics and auto-pauses/resumes workouts\n */\nexport class AutoPauseService {\n    private measurementsState: MeasurementsState;\n    private timeState: TimeState;\n    private callbacks: AutoPauseCallbacks;\n    private state: AutoPauseState;\n    private changeCallback: (() => void) | null = null;\n\n    constructor(measurementsState: MeasurementsState, timeState: TimeState, callbacks: AutoPauseCallbacks) {\n        this.measurementsState = measurementsState;\n        this.timeState = timeState;\n        this.callbacks = callbacks;\n        this.state = {\n            isAutoPaused: false,\n            belowThresholdSince: null,\n            delayTimer: null,\n        };\n    }\n\n    /**\n     * Start monitoring for auto-pause\n     */\n    start(): void {\n        this.stop(); // Clean up any existing subscription\n\n        const settings = getSettings();\n        if (!settings.autoPause.enabled) {\n            console.log('[AutoPause] Disabled, not starting');\n            return;\n        }\n\n        console.log('[AutoPause] Starting with settings:', settings.autoPause);\n\n        // Subscribe to measurement changes\n        this.changeCallback = () => this.checkMetric();\n        this.measurementsState.onChange(this.changeCallback);\n\n        // Also check periodically in case no measurements come in\n        this.startPeriodicCheck();\n    }\n\n    /**\n     * Stop monitoring\n     */\n    stop(): void {\n        if (this.changeCallback) {\n            this.measurementsState.offChange(this.changeCallback);\n            this.changeCallback = null;\n        }\n        this.clearDelayTimer();\n        if (this.intervalId) {\n            clearInterval(this.intervalId);\n            this.intervalId = null;\n        }\n        this.state = {\n            isAutoPaused: false,\n            belowThresholdSince: null,\n            delayTimer: null,\n        };\n        console.log('[AutoPause] Stopped');\n    }\n\n    /**\n     * Check if we're currently auto-paused\n     */\n    get isAutoPaused(): boolean {\n        return this.state.isAutoPaused;\n    }\n\n    /**\n     * Get the current metric value based on source setting\n     */\n    private getCurrentValue(source: AutoPauseSource): number | null {\n        const now = Date.now();\n        const lookbackMs = 5000; // Look at last 5 seconds of data\n        const minTimestamp = now - lookbackMs;\n\n        let measurements: { timestamp: number; value: number }[];\n        switch (source) {\n            case 'speed':\n                measurements = this.measurementsState.speed;\n                break;\n            case 'power':\n                measurements = this.measurementsState.power;\n                break;\n            case 'cadence':\n                measurements = this.measurementsState.cadence;\n                break;\n            default:\n                return null;\n        }\n\n        // Get recent measurements\n        const recentMeasurements = measurements.filter((m) => m.timestamp >= minTimestamp);\n\n        if (recentMeasurements.length === 0) {\n            return null; // No recent data\n        }\n\n        // Use the most recent value\n        const latest = recentMeasurements[recentMeasurements.length - 1];\n        return latest.value;\n    }\n\n    /**\n     * Check the metric and trigger pause/resume if needed\n     */\n    private checkMetric(): void {\n        const settings = getSettings();\n        if (!settings.autoPause.enabled) {\n            return;\n        }\n\n        // Only check when workout is in a valid state\n        if (!this.timeState.startTime) {\n            return; // Workout not started\n        }\n\n        const { source, threshold, delay } = settings.autoPause;\n        const currentValue = this.getCurrentValue(source);\n\n        // Handle case where no data is available\n        if (currentValue === null) {\n            // If we haven't received any data yet, don't auto-pause\n            // This prevents pausing immediately when starting a workout\n            return;\n        }\n\n        const isAboveThreshold = currentValue >= threshold;\n        const now = Date.now();\n\n        if (isAboveThreshold) {\n            // Metric is above threshold\n            this.clearDelayTimer();\n            this.state.belowThresholdSince = null;\n\n            if (this.state.isAutoPaused && !this.timeState.running) {\n                // Resume the workout\n                console.log(`[AutoPause] Resuming - ${source} at ${currentValue.toFixed(1)} (threshold: ${threshold})`);\n                this.state.isAutoPaused = false;\n                this.callbacks.onAutoResume();\n            }\n        } else {\n            // Metric is below threshold\n            if (!this.state.belowThresholdSince) {\n                this.state.belowThresholdSince = now;\n            }\n\n            const timeBelow = now - this.state.belowThresholdSince;\n            const delayMs = delay * 1000;\n\n            if (!this.state.isAutoPaused && this.timeState.running && timeBelow >= delayMs) {\n                // Pause the workout\n                console.log(\n                    `[AutoPause] Pausing - ${source} at ${currentValue.toFixed(1)} (threshold: ${threshold}) for ${(timeBelow / 1000).toFixed(1)}s`\n                );\n                this.state.isAutoPaused = true;\n                this.callbacks.onAutoPause();\n            }\n        }\n    }\n\n    /**\n     * Clear the delay timer\n     */\n    private clearDelayTimer(): void {\n        if (this.state.delayTimer) {\n            clearTimeout(this.state.delayTimer);\n            this.state.delayTimer = null;\n        }\n    }\n\n    /**\n     * Start periodic check (in case no new measurements come in)\n     */\n    private intervalId: ReturnType<typeof setInterval> | null = null;\n\n    private startPeriodicCheck(): void {\n        if (this.intervalId) {\n            clearInterval(this.intervalId);\n        }\n        // Check every second\n        this.intervalId = setInterval(() => {\n            this.checkMetric();\n        }, 1000);\n    }\n\n    /**\n     * Reset the auto-pause state (call when workout is reset)\n     */\n    reset(): void {\n        this.stop();\n        this.state = {\n            isAutoPaused: false,\n            belowThresholdSince: null,\n            delayTimer: null,\n        };\n    }\n\n    /**\n     * Get status info for debugging/display\n     */\n    getStatus(): {\n        enabled: boolean;\n        isAutoPaused: boolean;\n        source: AutoPauseSource;\n        threshold: number;\n        currentValue: number | null;\n    } {\n        const settings = getSettings();\n        return {\n            enabled: settings.autoPause.enabled,\n            isAutoPaused: this.state.isAutoPaused,\n            source: settings.autoPause.source,\n            threshold: settings.autoPause.threshold,\n            currentValue: this.getCurrentValue(settings.autoPause.source),\n        };\n    }\n}\n\n/**\n * Get unit label for auto-pause source\n */\nexport function getAutoPauseSourceUnit(source: AutoPauseSource): string {\n    switch (source) {\n        case 'speed':\n            return 'km/h';\n        case 'power':\n            return 'W';\n        case 'cadence':\n            return 'rpm';\n        default:\n            return '';\n    }\n}\n\n/**\n * Get label for auto-pause source\n */\nexport function getAutoPauseSourceLabel(source: AutoPauseSource): string {\n    switch (source) {\n        case 'speed':\n            return 'Speed';\n        case 'power':\n            return 'Power';\n        case 'cadence':\n            return 'Cadence';\n        default:\n            return source;\n    }\n}\n","/**\n * Auto-Lap Service\n *\n * Automatically marks laps based on distance or time intervals.\n * Integrates with VoiceFeedback for lap announcements.\n *\n * @module AutoLapService\n */\n\nimport { getSettings } from '../config/settings.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState } from '../getInitState.js';\nimport { voiceFeedback } from './VoiceFeedback.js';\n\n/**\n * Calculate total distance from GPS points in meters\n */\nfunction calculateTotalDistanceMeters(gpsPoints: { lat: number; lon: number }[]): number {\n    if (gpsPoints.length < 2) return 0;\n\n    let totalMeters = 0;\n    const R = 6371000; // Earth radius in meters\n\n    for (let i = 1; i < gpsPoints.length; i++) {\n        const prev = gpsPoints[i - 1];\n        const curr = gpsPoints[i];\n\n        // Haversine formula\n        const lat1 = (prev.lat * Math.PI) / 180;\n        const lat2 = (curr.lat * Math.PI) / 180;\n        const deltaLat = ((curr.lat - prev.lat) * Math.PI) / 180;\n        const deltaLon = ((curr.lon - prev.lon) * Math.PI) / 180;\n\n        const a =\n            Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +\n            Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        totalMeters += R * c;\n    }\n\n    return totalMeters;\n}\n\n/**\n * AutoLapService class for automatic lap marking\n */\nexport class AutoLapService {\n    private measurementsState: MeasurementsState | null = null;\n    private timeState: TimeState | null = null;\n    private lastLapDistanceKm: number = 0;\n    private lastLapTimeMs: number = 0;\n    private checkInterval: ReturnType<typeof setInterval> | null = null;\n    private isActive: boolean = false;\n    private onLapCallback: ((lapNumber: number) => void) | null = null;\n\n    /**\n     * Initialize the service with state references\n     */\n    init(measurementsState: MeasurementsState, timeState: TimeState): void {\n        this.measurementsState = measurementsState;\n        this.timeState = timeState;\n    }\n\n    /**\n     * Set callback for when a lap is automatically marked\n     */\n    onLap(callback: (lapNumber: number) => void): void {\n        this.onLapCallback = callback;\n    }\n\n    /**\n     * Start monitoring for auto-lap triggers\n     */\n    start(): void {\n        if (this.isActive || !this.measurementsState || !this.timeState) {\n            return;\n        }\n\n        const settings = getSettings();\n        if (!settings.autoLap.enabled) {\n            return;\n        }\n\n        this.isActive = true;\n        this.lastLapDistanceKm = 0;\n        this.lastLapTimeMs = 0;\n\n        // Check every second\n        this.checkInterval = setInterval(() => this.checkAutoLap(), 1000);\n\n        console.log(`AutoLap started: ${settings.autoLap.source} mode`);\n    }\n\n    /**\n     * Stop monitoring for auto-lap triggers\n     */\n    stop(): void {\n        if (this.checkInterval) {\n            clearInterval(this.checkInterval);\n            this.checkInterval = null;\n        }\n        this.isActive = false;\n        this.lastLapDistanceKm = 0;\n        this.lastLapTimeMs = 0;\n    }\n\n    /**\n     * Reset state (called when workout is discarded)\n     */\n    reset(): void {\n        this.stop();\n    }\n\n    /**\n     * Check if an auto-lap should be triggered\n     */\n    private checkAutoLap(): void {\n        if (!this.measurementsState || !this.timeState || !this.timeState.running) {\n            return;\n        }\n\n        const settings = getSettings();\n        if (!settings.autoLap.enabled) {\n            this.stop();\n            return;\n        }\n\n        if (settings.autoLap.source === 'distance') {\n            this.checkDistanceAutoLap(settings.autoLap.distanceKm);\n        } else if (settings.autoLap.source === 'time') {\n            this.checkTimeAutoLap(settings.autoLap.timeMinutes);\n        }\n    }\n\n    /**\n     * Check for distance-based auto-lap\n     */\n    private checkDistanceAutoLap(intervalKm: number): void {\n        if (!this.measurementsState) return;\n\n        const totalMeters = calculateTotalDistanceMeters(this.measurementsState.gps);\n        const totalKm = totalMeters / 1000;\n\n        // Calculate which km mark we're at\n        const currentInterval = Math.floor(totalKm / intervalKm);\n        const lastInterval = Math.floor(this.lastLapDistanceKm / intervalKm);\n\n        if (currentInterval > lastInterval && totalKm > 0) {\n            this.triggerAutoLap();\n            this.lastLapDistanceKm = totalKm;\n        }\n    }\n\n    /**\n     * Check for time-based auto-lap\n     */\n    private checkTimeAutoLap(intervalMinutes: number): void {\n        if (!this.timeState || !this.timeState.startTime) return;\n\n        const elapsedMs = Date.now() - this.timeState.startTime;\n        const intervalMs = intervalMinutes * 60 * 1000;\n\n        // Calculate which time interval we're at\n        const currentInterval = Math.floor(elapsedMs / intervalMs);\n        const lastInterval = Math.floor(this.lastLapTimeMs / intervalMs);\n\n        if (currentInterval > lastInterval && elapsedMs > 0) {\n            this.triggerAutoLap();\n            this.lastLapTimeMs = elapsedMs;\n        }\n    }\n\n    /**\n     * Trigger an automatic lap\n     */\n    private triggerAutoLap(): void {\n        if (!this.measurementsState || !this.timeState) return;\n\n        // Get previous lap timestamp or start time\n        const laps = this.measurementsState.laps;\n        const lastLapTime = laps.length > 0 ? laps[laps.length - 1].timestamp : this.timeState.startTime || Date.now();\n\n        // Add the lap\n        const lap = this.measurementsState.addLap(this.timeState.startTime);\n\n        // Calculate lap duration\n        const now = lap.timestamp;\n        const durationMs = now - lastLapTime;\n\n        // Calculate average power for the lap\n        const lapPower = this.measurementsState.power.filter((p) => p.timestamp >= lastLapTime && p.timestamp <= now);\n        const avgPower = lapPower.length > 0 ? lapPower.reduce((sum, p) => sum + p.value, 0) / lapPower.length : 0;\n\n        // Voice announcement\n        voiceFeedback.announceLap(lap.number, durationMs, avgPower);\n\n        console.log(`Auto-lap marked: ${lap.number} at ${new Date(lap.timestamp).toISOString()}`);\n\n        // Notify callback\n        if (this.onLapCallback) {\n            this.onLapCallback(lap.number);\n        }\n    }\n\n    /**\n     * Get whether auto-lap is currently active\n     */\n    isAutoLapActive(): boolean {\n        return this.isActive;\n    }\n}\n\n/** Singleton instance */\nexport const autoLapService = new AutoLapService();\n","/**\n * Data Fields Type System\n *\n * Core type definitions for the customizable data fields system.\n * Based on industry standards from Garmin, Wahoo, and Hammerhead devices.\n *\n * @module data-fields/types\n */\n\nimport type { MeasurementsState } from '../measurements-state.js';\n\n// ============================================================================\n// Category Types\n// ============================================================================\n\n/** Data field category for organization and filtering */\nexport type DataFieldCategory =\n    | 'power'\n    | 'cadence'\n    | 'heartrate'\n    | 'speed'\n    | 'distance'\n    | 'elevation'\n    | 'time'\n    | 'laps'\n    | 'energy'\n    | 'environment'\n    | 'device'\n    | 'charts'\n    | 'map';\n\n/** Category metadata for UI display */\nexport interface CategoryInfo {\n    id: DataFieldCategory;\n    name: string;\n    icon: string;\n    description: string;\n}\n\n/** All category metadata */\nexport const CATEGORY_INFO: Record<DataFieldCategory, CategoryInfo> = {\n    power: { id: 'power', name: 'Power', icon: '', description: 'Power meter data and calculations' },\n    cadence: { id: 'cadence', name: 'Cadence', icon: '', description: 'Pedaling cadence metrics' },\n    heartrate: { id: 'heartrate', name: 'Heart Rate', icon: '', description: 'Heart rate monitoring' },\n    speed: { id: 'speed', name: 'Speed & Pace', icon: '', description: 'Speed and pace metrics' },\n    distance: { id: 'distance', name: 'Distance', icon: '', description: 'Distance tracking' },\n    elevation: { id: 'elevation', name: 'Elevation', icon: '', description: 'Altitude and climbing' },\n    time: { id: 'time', name: 'Time', icon: '', description: 'Time and duration' },\n    laps: { id: 'laps', name: 'Laps', icon: '', description: 'Lap-specific metrics' },\n    energy: { id: 'energy', name: 'Energy', icon: '', description: 'Calories and Work' },\n    environment: { id: 'environment', name: 'Environment', icon: '', description: 'Weather and conditions' },\n    device: { id: 'device', name: 'Device', icon: '', description: 'Device and sensor status' },\n    charts: { id: 'charts', name: 'Charts', icon: '', description: 'Graphical data displays' },\n    map: { id: 'map', name: 'Map', icon: '', description: 'Route and location' },\n};\n\n// ============================================================================\n// Size Types\n// ============================================================================\n\n/** Data field size options for layout */\nexport type DataFieldSize =\n    | 'small' // 1x1 - compact, value only (no label)\n    | 'medium' // 1x1 - label + value (default)\n    | 'large' // 2x1 - label + large value\n    | 'wide' // 2x1 - for charts/graphs\n    | 'tall' // 1x2 - vertical layout\n    | 'full'; // 2x2 - maps, large charts\n\n/** Size metadata for UI */\nexport interface SizeInfo {\n    id: DataFieldSize;\n    name: string;\n    gridSpan: { cols: number; rows: number };\n    showLabel: boolean;\n}\n\n/** All size metadata */\nexport const SIZE_INFO: Record<DataFieldSize, SizeInfo> = {\n    small: { id: 'small', name: 'Small', gridSpan: { cols: 1, rows: 1 }, showLabel: false },\n    medium: { id: 'medium', name: 'Medium', gridSpan: { cols: 1, rows: 1 }, showLabel: true },\n    large: { id: 'large', name: 'Large', gridSpan: { cols: 2, rows: 1 }, showLabel: true },\n    wide: { id: 'wide', name: 'Wide', gridSpan: { cols: 2, rows: 1 }, showLabel: true },\n    tall: { id: 'tall', name: 'Tall', gridSpan: { cols: 1, rows: 2 }, showLabel: true },\n    full: { id: 'full', name: 'Full', gridSpan: { cols: 2, rows: 2 }, showLabel: true },\n};\n\n// ============================================================================\n// Source & Update Types\n// ============================================================================\n\n/** Data source type - where the data comes from */\nexport type DataSourceType =\n    | 'sensor' // Direct from Bluetooth sensor\n    | 'gps' // From GPS/location services\n    | 'calculated' // Derived from other data\n    | 'system' // Device info (battery, etc.)\n    | 'workout' // From workout state (laps, time, etc.)\n    | 'external'; // Weather API, etc.\n\n/** Update frequency - how often the field refreshes */\nexport type UpdateFrequency =\n    | 'realtime' // Every measurement (~100ms)\n    | 'second' // Once per second\n    | 'periodic' // Every few seconds (5s)\n    | 'on-change' // Only when value changes\n    | 'manual'; // User triggered\n\n// ============================================================================\n// Workout State Interface (for calculators)\n// ============================================================================\n\n/** Workout state passed to calculators */\nexport interface WorkoutState {\n    isActive: boolean;\n    isPaused: boolean;\n    startTime: number | null;\n    elapsedTime: number; // ms\n    movingTime: number; // ms (excluding paused/stopped)\n    pausedTime: number; // ms\n    currentLap: number;\n    lapStartTime: number | null;\n    lapElapsedTime: number; // ms\n    laps: LapData[];\n}\n\n/** Individual lap data */\nexport interface LapData {\n    lapNumber: number;\n    startTime: number;\n    endTime: number;\n    duration: number; // ms\n    distance: number; // meters\n    avgPower: number | null;\n    avgHeartrate: number | null;\n    avgCadence: number | null;\n    avgSpeed: number | null; // m/s\n    elevationGain: number; // meters\n}\n\n// ============================================================================\n// User Settings Interface (for formatters/colorizers)\n// ============================================================================\n\n/** User settings passed to formatters and colorizers */\nexport interface UserSettings {\n    unitSystem: 'metric' | 'imperial';\n    ftp: number | null; // Functional Threshold Power (watts)\n    maxHr: number | null; // Maximum heart rate (bpm)\n    weight: number | null; // User weight (kg)\n    restingHr: number | null; // Resting heart rate (bpm)\n    showCalories: boolean; // Show calorie estimation\n    targetDistance?: number | null; // Target distance in user units (km/mi)\n\n    // Zone configurations\n    powerZones: ZoneConfig[];\n    hrZones: ZoneConfig[];\n}\n\n/** Check if user is using imperial units */\nexport const isImperial = (settings: UserSettings): boolean => settings.unitSystem === 'imperial';\n\n/** Zone configuration */\nexport interface ZoneConfig {\n    zone: number;\n    name: string;\n    minPercent: number; // % of FTP or MaxHR\n    maxPercent: number;\n    color: string; // CSS color\n}\n\n/** Default power zones (based on Coggan) */\nexport const DEFAULT_POWER_ZONES: ZoneConfig[] = [\n    { zone: 1, name: 'Recovery', minPercent: 0, maxPercent: 55, color: '#9ca3af' },\n    { zone: 2, name: 'Endurance', minPercent: 55, maxPercent: 75, color: '#22c55e' },\n    { zone: 3, name: 'Tempo', minPercent: 75, maxPercent: 90, color: '#eab308' },\n    { zone: 4, name: 'Threshold', minPercent: 90, maxPercent: 105, color: '#f97316' },\n    { zone: 5, name: 'VO2max', minPercent: 105, maxPercent: 120, color: '#ef4444' },\n    { zone: 6, name: 'Anaerobic', minPercent: 120, maxPercent: 150, color: '#a855f7' },\n    { zone: 7, name: 'Neuromuscular', minPercent: 150, maxPercent: 999, color: '#ec4899' },\n];\n\n/** Default HR zones (5-zone model) */\nexport const DEFAULT_HR_ZONES: ZoneConfig[] = [\n    { zone: 1, name: 'Recovery', minPercent: 50, maxPercent: 60, color: '#9ca3af' },\n    { zone: 2, name: 'Aerobic', minPercent: 60, maxPercent: 70, color: '#22c55e' },\n    { zone: 3, name: 'Tempo', minPercent: 70, maxPercent: 80, color: '#eab308' },\n    { zone: 4, name: 'Threshold', minPercent: 80, maxPercent: 90, color: '#f97316' },\n    { zone: 5, name: 'VO2max', minPercent: 90, maxPercent: 100, color: '#ef4444' },\n];\n\n// ============================================================================\n// Calculator & Formatter Types\n// ============================================================================\n\n/** Calculator function for derived/calculated fields */\nexport type DataFieldCalculator = (\n    measurements: MeasurementsState,\n    workoutState: WorkoutState,\n    settings: UserSettings\n) => number | null;\n\n/** Formatter function to convert value to display string */\nexport type DataFieldFormatter = (value: number | null, settings: UserSettings) => string;\n\n/** Zone color result */\nexport interface ZoneColor {\n    bg: string;\n    text: string;\n    border: string;\n    zone: number;\n    zoneName: string;\n}\n\n/** Colorizer function for zone-based coloring */\nexport type DataFieldColorizer = (value: number | null, settings: UserSettings) => ZoneColor | null;\n\n// ============================================================================\n// Data Field Definition\n// ============================================================================\n\n/** Complete data field definition */\nexport interface DataFieldDefinition {\n    /** Unique identifier: 'power-current', 'heartrate-avg', etc. */\n    id: string;\n\n    /** Display name: 'Power', 'Avg Heart Rate', etc. */\n    name: string;\n\n    /** Abbreviated name for small displays: 'PWR', 'Avg HR', etc. */\n    shortName: string;\n\n    /** Category for organization */\n    category: DataFieldCategory;\n\n    /** Description for field picker */\n    description: string;\n\n    /** Unit string (metric): 'W', 'bpm', 'km/h', null for unitless */\n    unit: string | null;\n\n    /** Unit string for imperial: 'mph', 'ft', etc. */\n    unitImperial?: string;\n\n    /** Where the data comes from */\n    sourceType: DataSourceType;\n\n    /** How often the field updates */\n    updateFrequency: UpdateFrequency;\n\n    /** Default size when added to a screen */\n    defaultSize: DataFieldSize;\n\n    /** Sizes this field supports */\n    supportedSizes: DataFieldSize[];\n\n    /** Icon (emoji or class) for display */\n    icon: string;\n\n    /** Required sensors to show this field */\n    requiresSensor?: string[];\n\n    /** Requires GPS to be active */\n    requiresGps?: boolean;\n\n    /** Only available during active workout */\n    requiresWorkoutActive?: boolean;\n\n    /** Calculator for derived fields (optional) */\n    calculator?: DataFieldCalculator;\n\n    /** Formatter to convert value to display string */\n    formatter: DataFieldFormatter;\n\n    /** Colorizer for zone-based coloring (optional) */\n    colorizer?: DataFieldColorizer;\n\n    /** Number of decimal places for default formatting */\n    decimals?: number;\n\n    /** Minimum valid value (for sanity checking) */\n    minValue?: number;\n\n    /** Maximum valid value (for sanity checking) */\n    maxValue?: number;\n}\n\n// ============================================================================\n// Screen & Layout Types\n// ============================================================================\n\n/** A configured data field slot in a screen */\nexport interface DataFieldSlot {\n    /** Unique slot ID within the screen */\n    id: string;\n\n    /** Reference to DataFieldDefinition.id */\n    fieldId: string;\n\n    /** Size override (or default from field) */\n    size: DataFieldSize;\n\n    /** Position/order in the grid (1-based) */\n    position: number;\n}\n\n/** Screen layout options */\nexport type ScreenLayout =\n    | 'auto' // Automatic grid based on field count\n    | 'grid-2' // 2 columns\n    | 'grid-3' // 3 columns\n    | 'grid-4' // 4 columns\n    | 'list' // Vertical list (1 column)\n    | 'custom'; // User-defined positions\n\n/** A complete data screen configuration */\nexport interface DataScreen {\n    /** Unique screen ID */\n    id: string;\n\n    /** Screen name for display */\n    name: string;\n\n    /** Screen icon */\n    icon: string;\n\n    /** Field slots on this screen */\n    slots: DataFieldSlot[];\n\n    /** Layout mode */\n    layout: ScreenLayout;\n}\n\n/** Activity type for profiles */\nexport type ActivityType = 'cycling' | 'running' | 'indoor' | 'custom';\n\n/** Activity profile containing multiple screens */\nexport interface ActivityProfile {\n    /** Unique profile ID */\n    id: string;\n\n    /** Profile name */\n    name: string;\n\n    /** Profile icon */\n    icon: string;\n\n    /** Activity type */\n    activityType: ActivityType;\n\n    /** Screens in this profile */\n    screens: DataScreen[];\n\n    /** Currently active screen index */\n    activeScreenIndex: number;\n}\n\n// ============================================================================\n// Settings Types\n// ============================================================================\n\n/** Data field settings stored in localStorage */\nexport interface DataFieldSettings {\n    /** User's activity profiles */\n    profiles: ActivityProfile[];\n\n    /** Currently active profile ID */\n    activeProfileId: string;\n\n    /** Unit system preference */\n    unitSystem: 'metric' | 'imperial';\n\n    /** Per-field preferences */\n    fieldPreferences: Record<string, FieldPreference>;\n}\n\n/** Per-field user preferences */\nexport interface FieldPreference {\n    /** Show this field in workout summary */\n    showInSummary: boolean;\n\n    /** Announce this field via voice */\n    voiceAnnounce: boolean;\n\n    /** Alert threshold value */\n    alertThreshold?: number;\n\n    /** Alert when above or below threshold */\n    alertType?: 'above' | 'below';\n}\n\n// ============================================================================\n// Event Types\n// ============================================================================\n\n/** Event dispatched when a data field value updates */\nexport interface DataFieldUpdateEvent {\n    fieldId: string;\n    value: number | null;\n    formattedValue: string;\n    timestamp: number;\n}\n\n/** Event dispatched when screen changes */\nexport interface ScreenChangeEvent {\n    profileId: string;\n    screenIndex: number;\n    screen: DataScreen;\n}\n\n// ============================================================================\n// User Settings & State Types\n// ============================================================================\n","/**\n * Data Field Registry\n *\n * Central registry for all data field definitions.\n * Provides lookup, filtering, and category organization.\n *\n * @module data-fields/registry\n */\n\nimport type { DataFieldDefinition, DataFieldCategory, CategoryInfo } from './types.js';\nimport { CATEGORY_INFO } from './types.js';\n\n// ============================================================================\n// Registry Storage\n// ============================================================================\n\n/** Central registry of all data fields */\nconst DATA_FIELD_REGISTRY: Map<string, DataFieldDefinition> = new Map();\n\n/** Track registration order for consistent iteration */\nconst registrationOrder: string[] = [];\n\n// ============================================================================\n// Registration Functions\n// ============================================================================\n\n/**\n * Register a new data field definition\n * @param field - The field definition to register\n * @throws Error if field with same ID already exists\n */\nexport function registerDataField(field: DataFieldDefinition): void {\n    if (DATA_FIELD_REGISTRY.has(field.id)) {\n        console.warn(`Data field '${field.id}' is already registered. Skipping duplicate.`);\n        return;\n    }\n\n    // Validate required properties\n    if (!field.id || !field.name || !field.category || !field.formatter) {\n        throw new Error(`Invalid data field definition: missing required properties for '${field.id}'`);\n    }\n\n    DATA_FIELD_REGISTRY.set(field.id, field);\n    registrationOrder.push(field.id);\n}\n\n/**\n * Register multiple data fields at once\n * @param fields - Array of field definitions\n */\nexport function registerDataFields(fields: DataFieldDefinition[]): void {\n    for (const field of fields) {\n        registerDataField(field);\n    }\n}\n\n/**\n * Unregister a data field (for testing or dynamic removal)\n * @param fieldId - The field ID to remove\n */\nexport function unregisterDataField(fieldId: string): boolean {\n    const removed = DATA_FIELD_REGISTRY.delete(fieldId);\n    if (removed) {\n        const index = registrationOrder.indexOf(fieldId);\n        if (index > -1) {\n            registrationOrder.splice(index, 1);\n        }\n    }\n    return removed;\n}\n\n/**\n * Clear all registered fields (for testing)\n */\nexport function clearRegistry(): void {\n    DATA_FIELD_REGISTRY.clear();\n    registrationOrder.length = 0;\n}\n\n// ============================================================================\n// Lookup Functions\n// ============================================================================\n\n/**\n * Get a data field by ID\n * @param id - The field ID to look up\n * @returns The field definition or undefined\n */\nexport function getDataField(id: string): DataFieldDefinition | undefined {\n    return DATA_FIELD_REGISTRY.get(id);\n}\n\n/**\n * Check if a field exists\n * @param id - The field ID to check\n */\nexport function hasDataField(id: string): boolean {\n    return DATA_FIELD_REGISTRY.has(id);\n}\n\n/**\n * Get all registered data fields\n * @returns Array of all field definitions in registration order\n */\nexport function getAllDataFields(): DataFieldDefinition[] {\n    return registrationOrder.map((id) => DATA_FIELD_REGISTRY.get(id)!);\n}\n\n/**\n * Get the total count of registered fields\n */\nexport function getFieldCount(): number {\n    return DATA_FIELD_REGISTRY.size;\n}\n\n// ============================================================================\n// Category Functions\n// ============================================================================\n\n/**\n * Get all fields in a specific category\n * @param category - The category to filter by\n * @returns Array of field definitions in that category\n */\nexport function getFieldsByCategory(category: DataFieldCategory): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.category === category);\n}\n\n/**\n * Get all categories that have registered fields\n * @returns Map of category to field definitions\n */\nexport function getAllCategories(): Map<DataFieldCategory, DataFieldDefinition[]> {\n    const categories = new Map<DataFieldCategory, DataFieldDefinition[]>();\n\n    for (const field of getAllDataFields()) {\n        const list = categories.get(field.category) || [];\n        list.push(field);\n        categories.set(field.category, list);\n    }\n\n    return categories;\n}\n\n/**\n * Get category info with field counts\n * @returns Array of categories with their field counts\n */\nexport function getCategoriesWithCounts(): Array<CategoryInfo & { count: number }> {\n    const categoryMap = getAllCategories();\n\n    return Object.values(CATEGORY_INFO)\n        .map((info) => ({\n            ...info,\n            count: categoryMap.get(info.id)?.length || 0,\n        }))\n        .filter((c) => c.count > 0);\n}\n\n// ============================================================================\n// Filtering Functions\n// ============================================================================\n\n/**\n * Get fields that require specific sensors\n * @param sensorType - The sensor type ('power', 'heartrate', 'cadence', 'gps')\n */\nexport function getFieldsRequiringSensor(sensorType: string): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.requiresSensor?.includes(sensorType));\n}\n\n/**\n * Get fields that require GPS\n */\nexport function getFieldsRequiringGps(): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.requiresGps === true);\n}\n\n/**\n * Get fields that are always available (no sensor requirements)\n */\nexport function getAlwaysAvailableFields(): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => !f.requiresSensor?.length && !f.requiresGps);\n}\n\n/**\n * Get calculated fields (have a calculator function)\n */\nexport function getCalculatedFields(): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.calculator !== undefined);\n}\n\n/**\n * Get real-time sensor fields (direct from sensors)\n */\nexport function getSensorFields(): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.sourceType === 'sensor');\n}\n\n/**\n * Get fields that require an active workout\n */\nexport function getFieldsRequiringWorkout(): DataFieldDefinition[] {\n    return getAllDataFields().filter((f) => f.requiresWorkoutActive === true);\n}\n\n/**\n * Get fields by their IDs\n */\nexport function getFieldsByIds(ids: string[]): DataFieldDefinition[] {\n    return ids.map((id) => getDataField(id)).filter((f): f is DataFieldDefinition => f !== undefined);\n}\n\n// ============================================================================\n// Search Functions\n// ============================================================================\n\n/**\n * Search fields by name or description\n * @param query - Search query string\n * @returns Matching field definitions\n */\nexport function searchFields(query: string): DataFieldDefinition[] {\n    const lowerQuery = query.toLowerCase().trim();\n    if (!lowerQuery) {\n        return getAllDataFields();\n    }\n\n    return getAllDataFields().filter(\n        (f) =>\n            f.name.toLowerCase().includes(lowerQuery) ||\n            f.shortName.toLowerCase().includes(lowerQuery) ||\n            f.description.toLowerCase().includes(lowerQuery) ||\n            f.id.toLowerCase().includes(lowerQuery)\n    );\n}\n\n// ============================================================================\n// Validation Functions\n// ============================================================================\n\n/**\n * Validate a field ID exists\n * @param fieldId - The field ID to validate\n * @throws Error if field doesn't exist\n */\nexport function validateFieldId(fieldId: string): DataFieldDefinition {\n    const field = getDataField(fieldId);\n    if (!field) {\n        throw new Error(`Unknown data field: '${fieldId}'`);\n    }\n    return field;\n}\n\n/**\n * Validate multiple field IDs\n * @param fieldIds - Array of field IDs to validate\n * @returns Array of valid field definitions\n */\nexport function validateFieldIds(fieldIds: string[]): DataFieldDefinition[] {\n    return fieldIds.map((id) => validateFieldId(id));\n}\n\n// ============================================================================\n// Debug/Development Helpers\n// ============================================================================\n\n/**\n * Get registry statistics for debugging\n */\nexport function getRegistryStats(): {\n    totalFields: number;\n    byCategory: Record<string, number>;\n    bySensor: Record<string, number>;\n    calculated: number;\n    gpsRequired: number;\n} {\n    const fields = getAllDataFields();\n\n    const byCategory: Record<string, number> = {};\n    const bySensor: Record<string, number> = {};\n    let calculated = 0;\n    let gpsRequired = 0;\n\n    for (const field of fields) {\n        // Count by category\n        byCategory[field.category] = (byCategory[field.category] || 0) + 1;\n\n        // Count by required sensor\n        for (const sensor of field.requiresSensor || []) {\n            bySensor[sensor] = (bySensor[sensor] || 0) + 1;\n        }\n\n        // Count calculated\n        if (field.calculator) {\n            calculated++;\n        }\n\n        // Count GPS required\n        if (field.requiresGps) {\n            gpsRequired++;\n        }\n    }\n\n    return {\n        totalFields: fields.length,\n        byCategory,\n        bySensor,\n        calculated,\n        gpsRequired,\n    };\n}\n\n/**\n * Log registry contents for debugging\n */\nexport function debugLogRegistry(): void {\n    const stats = getRegistryStats();\n    console.group(' Data Field Registry');\n    console.log(`Total fields: ${stats.totalFields}`);\n    console.log('By category:', stats.byCategory);\n    console.log('By sensor:', stats.bySensor);\n    console.log(`Calculated fields: ${stats.calculated}`);\n    console.log(`GPS required: ${stats.gpsRequired}`);\n    console.groupEnd();\n}\n","/**\n * Calculation Manager\n *\n * Manages the calculation and updates of derived data fields.\n * Handles update scheduling based on field requirements and\n * efficiently batches calculations to minimize performance impact.\n *\n * @module data-fields/CalculationManager\n */\n\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { DataFieldDefinition, WorkoutState, UserSettings, UpdateFrequency } from './types.js';\nimport { getAllDataFields, getDataField } from './registry.js';\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/** Callback for field value updates */\nexport type FieldUpdateCallback = (fieldId: string, value: number | null) => void;\n\n/** Configuration for the calculation manager */\nexport interface CalculationManagerConfig {\n    /** Enable/disable real-time updates (default: true) */\n    enableRealtime?: boolean;\n    /** Override update intervals in ms (for testing) */\n    updateIntervals?: Partial<Record<UpdateFrequency, number>>;\n}\n\n/** Field calculation result */\ninterface CalculationResult {\n    fieldId: string;\n    value: number | null;\n    timestamp: number;\n}\n\n// ============================================================================\n// Default Update Intervals\n// ============================================================================\n\nconst DEFAULT_UPDATE_INTERVALS: Record<UpdateFrequency, number> = {\n    realtime: 100, // 10Hz - for critical real-time data\n    second: 1000, // 1Hz - once per second\n    periodic: 5000, // Every 5 seconds\n    'on-change': 0, // Manual trigger only\n    manual: 0, // Manual trigger only\n};\n\n// ============================================================================\n// Calculation Manager Class\n// ============================================================================\n\n/**\n * Manages calculated data field updates\n *\n * The CalculationManager schedules and executes calculations for\n * derived data fields (NP, TSS, rolling averages, etc.) based on\n * their update frequency requirements.\n *\n * @example\n * ```typescript\n * const manager = new CalculationManager(measurements, workoutState, settings);\n * manager.onUpdate((fieldId, value) => {\n *     updateUIField(fieldId, value);\n * });\n * manager.start();\n * // ... during workout ...\n * manager.stop();\n * ```\n */\nexport class CalculationManager {\n    private calculatedValues: Map<string, number | null> = new Map();\n    private updateTimers: Map<UpdateFrequency, number> = new Map();\n    private listeners: Set<FieldUpdateCallback> = new Set();\n    private isRunning = false;\n    private config: Required<CalculationManagerConfig>;\n    private fieldsByFrequency: Map<UpdateFrequency, DataFieldDefinition[]> = new Map();\n\n    constructor(\n        private measurements: MeasurementsState,\n        private workoutState: WorkoutState,\n        private settings: UserSettings,\n        config: CalculationManagerConfig = {}\n    ) {\n        this.config = {\n            enableRealtime: config.enableRealtime ?? true,\n            updateIntervals: {\n                ...DEFAULT_UPDATE_INTERVALS,\n                ...config.updateIntervals,\n            },\n        };\n\n        this.categorizeFieldsByFrequency();\n    }\n\n    // ========================================================================\n    // Lifecycle Methods\n    // ========================================================================\n\n    /**\n     * Start the calculation manager\n     *\n     * Sets up update timers for each frequency group and begins\n     * calculating field values.\n     */\n    public start(): void {\n        if (this.isRunning) return;\n        this.isRunning = true;\n\n        // Initial calculation of all fields\n        this.calculateAllFields();\n\n        // Set up timers for each frequency\n        for (const [frequency, fields] of this.fieldsByFrequency) {\n            if (fields.length === 0) continue;\n\n            const interval = this.config.updateIntervals[frequency];\n            if (interval === undefined || interval <= 0) continue; // Skip manual/on-change\n\n            // Skip realtime if disabled\n            if (frequency === 'realtime' && !this.config.enableRealtime) continue;\n\n            const timerId = window.setInterval(() => {\n                this.calculateFieldsForFrequency(frequency);\n            }, interval);\n\n            this.updateTimers.set(frequency, timerId);\n        }\n    }\n\n    /**\n     * Stop the calculation manager\n     *\n     * Clears all update timers and stops calculations.\n     */\n    public stop(): void {\n        if (!this.isRunning) return;\n        this.isRunning = false;\n\n        // Clear all timers\n        for (const timerId of this.updateTimers.values()) {\n            clearInterval(timerId);\n        }\n        this.updateTimers.clear();\n    }\n\n    /**\n     * Pause calculations temporarily\n     */\n    public pause(): void {\n        this.stop();\n    }\n\n    /**\n     * Resume calculations after pause\n     */\n    public resume(): void {\n        if (!this.isRunning) {\n            this.start();\n        }\n    }\n\n    /**\n     * Check if the manager is currently running\n     */\n    public isActive(): boolean {\n        return this.isRunning;\n    }\n\n    // ========================================================================\n    // Update Methods\n    // ========================================================================\n\n    /**\n     * Update the measurements state reference\n     *\n     * Call this when the measurements state is replaced or updated.\n     */\n    public updateMeasurements(measurements: MeasurementsState): void {\n        this.measurements = measurements;\n    }\n\n    /**\n     * Update the workout state reference\n     */\n    public updateWorkoutState(workoutState: WorkoutState): void {\n        this.workoutState = workoutState;\n    }\n\n    /**\n     * Update user settings\n     */\n    public updateSettings(settings: UserSettings): void {\n        this.settings = settings;\n        // Recalculate all fields when settings change\n        if (this.isRunning) {\n            this.calculateAllFields();\n        }\n    }\n\n    // ========================================================================\n    // Event Handling\n    // ========================================================================\n\n    /**\n     * Register a callback for field updates\n     *\n     * @param callback Function called when a field value changes\n     * @returns Unsubscribe function\n     */\n    public onUpdate(callback: FieldUpdateCallback): () => void {\n        this.listeners.add(callback);\n        return () => this.listeners.delete(callback);\n    }\n\n    /**\n     * Remove all update listeners\n     */\n    public removeAllListeners(): void {\n        this.listeners.clear();\n    }\n\n    // ========================================================================\n    // Value Access\n    // ========================================================================\n\n    /**\n     * Get the current calculated value for a field\n     */\n    public getValue(fieldId: string): number | null {\n        return this.calculatedValues.get(fieldId) ?? null;\n    }\n\n    /**\n     * Get all calculated values\n     */\n    public getAllValues(): Map<string, number | null> {\n        return new Map(this.calculatedValues);\n    }\n\n    /**\n     * Get values for specific fields\n     */\n    public getValues(fieldIds: string[]): Map<string, number | null> {\n        const result = new Map<string, number | null>();\n        for (const id of fieldIds) {\n            result.set(id, this.calculatedValues.get(id) ?? null);\n        }\n        return result;\n    }\n\n    // ========================================================================\n    // Manual Calculation\n    // ========================================================================\n\n    /**\n     * Force calculation of a specific field\n     *\n     * Use for 'on-change' or 'manual' fields, or to refresh a value.\n     */\n    public calculateField(fieldId: string): number | null {\n        const field = getDataField(fieldId);\n        if (!field) return null;\n\n        const value = this.executeCalculation(field);\n        this.updateValue(fieldId, value);\n        return value;\n    }\n\n    /**\n     * Force calculation of all fields\n     */\n    public calculateAllFields(): void {\n        const allFields = getAllDataFields();\n        const results: CalculationResult[] = [];\n\n        for (const field of allFields) {\n            if (field.calculator) {\n                const value = this.executeCalculation(field);\n                results.push({\n                    fieldId: field.id,\n                    value,\n                    timestamp: Date.now(),\n                });\n            }\n        }\n\n        // Batch update all values\n        for (const result of results) {\n            this.updateValue(result.fieldId, result.value);\n        }\n    }\n\n    /**\n     * Calculate fields that match a specific frequency\n     */\n    public calculateFieldsForFrequency(frequency: UpdateFrequency): void {\n        const fields = this.fieldsByFrequency.get(frequency);\n        if (!fields) return;\n\n        for (const field of fields) {\n            if (field.calculator) {\n                const value = this.executeCalculation(field);\n                this.updateValue(field.id, value);\n            }\n        }\n    }\n\n    // ========================================================================\n    // Private Methods\n    // ========================================================================\n\n    /**\n     * Categorize all fields by their update frequency\n     */\n    private categorizeFieldsByFrequency(): void {\n        this.fieldsByFrequency.clear();\n\n        // Initialize all frequency buckets\n        const frequencies: UpdateFrequency[] = ['realtime', 'second', 'periodic', 'on-change', 'manual'];\n        for (const freq of frequencies) {\n            this.fieldsByFrequency.set(freq, []);\n        }\n\n        // Categorize fields with calculators\n        const allFields = getAllDataFields();\n        for (const field of allFields) {\n            if (field.calculator) {\n                const list = this.fieldsByFrequency.get(field.updateFrequency);\n                if (list) {\n                    list.push(field);\n                }\n            }\n        }\n    }\n\n    /**\n     * Execute a field's calculator function\n     */\n    private executeCalculation(field: DataFieldDefinition): number | null {\n        if (!field.calculator) return null;\n\n        try {\n            return field.calculator(this.measurements, this.workoutState, this.settings);\n        } catch (error) {\n            console.warn(`Calculation error for field ${field.id}:`, error);\n            return null;\n        }\n    }\n\n    /**\n     * Update a field value and notify listeners\n     */\n    private updateValue(fieldId: string, value: number | null): void {\n        const previousValue = this.calculatedValues.get(fieldId);\n\n        // Only notify if value actually changed\n        if (previousValue !== value) {\n            this.calculatedValues.set(fieldId, value);\n            this.notifyListeners(fieldId, value);\n        }\n    }\n\n    /**\n     * Notify all listeners of a field update\n     */\n    private notifyListeners(fieldId: string, value: number | null): void {\n        for (const listener of this.listeners) {\n            try {\n                listener(fieldId, value);\n            } catch (error) {\n                console.warn(`Error in field update listener:`, error);\n            }\n        }\n    }\n}\n\n// ============================================================================\n// Factory Function\n// ============================================================================\n\n/**\n * Create a new CalculationManager instance\n */\nexport function createCalculationManager(\n    measurements: MeasurementsState,\n    workoutState: WorkoutState,\n    settings: UserSettings,\n    config?: CalculationManagerConfig\n): CalculationManager {\n    return new CalculationManager(measurements, workoutState, settings, config);\n}\n\n// ============================================================================\n// Singleton Instance (optional)\n// ============================================================================\n\nlet globalManager: CalculationManager | null = null;\n\n/**\n * Get or create a global CalculationManager instance\n *\n * Use this for app-wide access to calculated field values.\n */\nexport function getGlobalCalculationManager(): CalculationManager | null {\n    return globalManager;\n}\n\n/**\n * Initialize the global CalculationManager\n */\nexport function initGlobalCalculationManager(\n    measurements: MeasurementsState,\n    workoutState: WorkoutState,\n    settings: UserSettings,\n    config?: CalculationManagerConfig\n): CalculationManager {\n    if (globalManager) {\n        globalManager.stop();\n    }\n    globalManager = createCalculationManager(measurements, workoutState, settings, config);\n    return globalManager;\n}\n\n/**\n * Destroy the global CalculationManager\n */\nexport function destroyGlobalCalculationManager(): void {\n    if (globalManager) {\n        globalManager.stop();\n        globalManager.removeAllListeners();\n        globalManager = null;\n    }\n}\n","/**\n * Default Screen Configurations\n *\n * Pre-configured data screens and activity profiles for common use cases.\n * Users can use these as starting points and customize them.\n *\n * @module data-fields/defaults\n */\n\nimport type { DataScreen, DataFieldSlot, ActivityProfile, DataFieldSettings } from './screens.js';\n\n// ============================================================================\n// Helper to create slots\n// ============================================================================\n\nlet slotCounter = 0;\n\nfunction slot(fieldId: string, size: 'small' | 'medium' | 'large' = 'medium'): DataFieldSlot {\n    slotCounter++;\n    return {\n        id: `default-slot-${slotCounter}`,\n        fieldId,\n        size,\n        position: slotCounter,\n    };\n}\n\nfunction resetSlotCounter(): void {\n    slotCounter = 0;\n}\n\n// ============================================================================\n// Default Cycling Screens\n// ============================================================================\n\n/** Main cycling screen - overview of key metrics */\nfunction createCyclingMainScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-main',\n        name: 'Main',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-current', 'large'),\n            slot('heartrate-current', 'medium'),\n            slot('cadence-current', 'medium'),\n            slot('speed-current', 'medium'),\n            slot('distance-total', 'medium'),\n            slot('time-elapsed', 'medium'),\n        ],\n    };\n}\n\n/** Power-focused screen for training */\nfunction createCyclingPowerScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-power',\n        name: 'Power',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-current', 'large'),\n            slot('power-3s', 'medium'),\n            slot('power-avg', 'medium'),\n            slot('power-normalized', 'medium'),\n            slot('power-max', 'medium'),\n            slot('power-zone', 'medium'),\n        ],\n    };\n}\n\n/** Heart rate focused screen */\nfunction createCyclingHrScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-hr',\n        name: 'Heart Rate',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('heartrate-current', 'large'),\n            slot('heartrate-avg', 'medium'),\n            slot('heartrate-max', 'medium'),\n            slot('heartrate-zone', 'medium'),\n            slot('heartrate-percent-max', 'medium'),\n            slot('calories-burned', 'medium'),\n        ],\n    };\n}\n\n/** Climbing/elevation focused screen */\nfunction createCyclingClimbScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-climb',\n        name: 'Climbing',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('grade-current', 'large'),\n            slot('elevation-current', 'medium'),\n            slot('elevation-gain', 'medium'),\n            slot('elevation-loss', 'medium'),\n            slot('vertical-speed', 'medium'),\n            slot('power-current', 'medium'),\n        ],\n    };\n}\n\n/** Lap-focused screen */\nfunction createCyclingLapScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-laps',\n        name: 'Laps',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('time-lap-number', 'medium'),\n            slot('time-lap', 'large'),\n            slot('distance-lap', 'medium'),\n            slot('power-lap-avg', 'medium'),\n            slot('hr-lap-avg', 'medium'),\n            slot('speed-lap-avg', 'medium'),\n        ],\n    };\n}\n\n/** Minimal screen for casual riding */\nfunction createCyclingSimpleScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'cycling-simple',\n        name: 'Simple',\n        icon: '',\n        layout: 'grid-2',\n        slots: [\n            slot('speed-current', 'large'),\n            slot('distance-total', 'large'),\n            slot('time-elapsed', 'large'),\n            slot('elevation-gain', 'large'),\n        ],\n    };\n}\n\n// ============================================================================\n// Default Indoor/Trainer Screens\n// ============================================================================\n\n/** Main indoor training screen */\nfunction createIndoorMainScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'indoor-main',\n        name: 'Main',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-current', 'large'),\n            slot('heartrate-current', 'medium'),\n            slot('cadence-current', 'medium'),\n            slot('time-elapsed', 'medium'),\n            slot('power-avg', 'medium'),\n            slot('kilojoules', 'medium'),\n        ],\n    };\n}\n\n/** Indoor power screen */\nfunction createIndoorPowerScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'indoor-power',\n        name: 'Power',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-current', 'large'),\n            slot('power-3s', 'medium'),\n            slot('power-10s', 'medium'),\n            slot('power-30s', 'medium'),\n            slot('power-normalized', 'medium'),\n            slot('intensity-factor', 'medium'),\n        ],\n    };\n}\n\n/** TSS/training load screen */\nfunction createIndoorTrainingScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'indoor-training',\n        name: 'Training',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('tss', 'large'),\n            slot('intensity-factor', 'medium'),\n            slot('power-normalized', 'medium'),\n            slot('kilojoules', 'medium'),\n            slot('time-elapsed', 'medium'),\n            slot('power-avg', 'medium'),\n        ],\n    };\n}\n\n/** Zone-focused screen for structured training */\nfunction createIndoorZonesScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'indoor-zones',\n        name: 'Zones',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-zone', 'large'),\n            slot('heartrate-zone', 'large'),\n            slot('power-percent-ftp', 'medium'),\n            slot('heartrate-percent-max', 'medium'),\n            slot('cadence-zone', 'medium'),\n            slot('time-elapsed', 'medium'),\n        ],\n    };\n}\n\n// ============================================================================\n// Default Running Screens\n// ============================================================================\n\n/** Main running screen */\nfunction createRunningMainScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'running-main',\n        name: 'Main',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('pace-current', 'large'),\n            slot('heartrate-current', 'medium'),\n            slot('cadence-current', 'medium'),\n            slot('distance-total', 'medium'),\n            slot('time-elapsed', 'medium'),\n            slot('pace-avg', 'medium'),\n        ],\n    };\n}\n\n/** Running pace screen */\nfunction createRunningPaceScreen(): DataScreen {\n    resetSlotCounter();\n    return {\n        id: 'running-pace',\n        name: 'Pace',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('pace-current', 'large'),\n            slot('pace-avg', 'medium'),\n            slot('speed-current', 'medium'),\n            slot('speed-avg', 'medium'),\n            slot('distance-total', 'medium'),\n            slot('time-elapsed', 'medium'),\n        ],\n    };\n}\n\n// ============================================================================\n// Default Activity Profiles\n// ============================================================================\n\n/** Default outdoor cycling profile */\nexport const DEFAULT_CYCLING_PROFILE: ActivityProfile = {\n    id: 'default-cycling',\n    name: 'Outdoor Cycling',\n    activityType: 'cycling',\n    icon: '',\n    screens: [\n        createCyclingMainScreen(),\n        createCyclingPowerScreen(),\n        createCyclingHrScreen(),\n        createCyclingClimbScreen(),\n        createCyclingLapScreen(),\n    ],\n    activeScreenIndex: 0,\n};\n\n/** Default indoor/trainer profile */\nexport const DEFAULT_INDOOR_PROFILE: ActivityProfile = {\n    id: 'default-indoor',\n    name: 'Indoor Training',\n    activityType: 'indoor',\n    icon: '',\n    screens: [\n        createIndoorMainScreen(),\n        createIndoorPowerScreen(),\n        createIndoorTrainingScreen(),\n        createIndoorZonesScreen(),\n    ],\n    activeScreenIndex: 0,\n};\n\n/** Default running profile */\nexport const DEFAULT_RUNNING_PROFILE: ActivityProfile = {\n    id: 'default-running',\n    name: 'Running',\n    activityType: 'running',\n    icon: '',\n    screens: [createRunningMainScreen(), createRunningPaceScreen()],\n    activeScreenIndex: 0,\n};\n\n/** Simple cycling profile for casual users */\nexport const DEFAULT_SIMPLE_PROFILE: ActivityProfile = {\n    id: 'default-simple',\n    name: 'Simple',\n    activityType: 'cycling',\n    icon: '',\n    screens: [createCyclingSimpleScreen()],\n    activeScreenIndex: 0,\n};\n\n// ============================================================================\n// All Default Profiles\n// ============================================================================\n\n/** All default profiles */\nexport const DEFAULT_PROFILES: ActivityProfile[] = [\n    DEFAULT_CYCLING_PROFILE,\n    DEFAULT_INDOOR_PROFILE,\n    DEFAULT_RUNNING_PROFILE,\n    DEFAULT_SIMPLE_PROFILE,\n];\n\n// ============================================================================\n// Default Settings\n// ============================================================================\n\n/** Default data field settings for new users */\nexport const DEFAULT_DATA_FIELD_SETTINGS: DataFieldSettings = {\n    profiles: [\n        // Clone the default profiles so users can modify them\n        JSON.parse(JSON.stringify(DEFAULT_CYCLING_PROFILE)),\n        JSON.parse(JSON.stringify(DEFAULT_INDOOR_PROFILE)),\n    ],\n    activeProfileId: 'default-cycling',\n    unitSystem: 'metric',\n    fieldPreferences: {},\n    version: 1,\n};\n\n// ============================================================================\n// Profile Factory Functions\n// ============================================================================\n\n/**\n * Create a fresh copy of the default cycling profile\n */\nexport function createDefaultCyclingProfile(): ActivityProfile {\n    return JSON.parse(JSON.stringify(DEFAULT_CYCLING_PROFILE));\n}\n\n/**\n * Create a fresh copy of the default indoor profile\n */\nexport function createDefaultIndoorProfile(): ActivityProfile {\n    return JSON.parse(JSON.stringify(DEFAULT_INDOOR_PROFILE));\n}\n\n/**\n * Create a fresh copy of the default running profile\n */\nexport function createDefaultRunningProfile(): ActivityProfile {\n    return JSON.parse(JSON.stringify(DEFAULT_RUNNING_PROFILE));\n}\n\n/**\n * Get a default profile by activity type\n */\nexport function getDefaultProfileForActivity(activityType: string): ActivityProfile {\n    switch (activityType) {\n        case 'cycling':\n            return createDefaultCyclingProfile();\n        case 'indoor':\n            return createDefaultIndoorProfile();\n        case 'running':\n            return createDefaultRunningProfile();\n        default:\n            return createDefaultCyclingProfile();\n    }\n}\n\n/**\n * Create default settings for a new user\n */\nexport function createDefaultSettings(): DataFieldSettings {\n    return JSON.parse(JSON.stringify(DEFAULT_DATA_FIELD_SETTINGS));\n}\n\n// ============================================================================\n// Migration from Legacy Settings\n// ============================================================================\n\n/**\n * Legacy settings structure (for migration)\n */\ninterface LegacyDisplaySettings {\n    power?: boolean;\n    cadence?: boolean;\n    heartrate?: boolean;\n    speed?: boolean;\n    distance?: boolean;\n    altitude?: boolean;\n}\n\n/**\n * Migrate from legacy display settings to new data field settings\n */\nexport function migrateFromLegacySettings(legacySettings: LegacyDisplaySettings): DataFieldSettings {\n    resetSlotCounter();\n\n    // Build slots based on which fields were enabled\n    const slots: DataFieldSlot[] = [];\n\n    if (legacySettings.power !== false) {\n        slots.push(slot('power-current', 'large'));\n    }\n    if (legacySettings.heartrate !== false) {\n        slots.push(slot('heartrate-current', 'medium'));\n    }\n    if (legacySettings.cadence !== false) {\n        slots.push(slot('cadence-current', 'medium'));\n    }\n    if (legacySettings.speed !== false) {\n        slots.push(slot('speed-current', 'medium'));\n    }\n    if (legacySettings.distance !== false) {\n        slots.push(slot('distance-total', 'medium'));\n    }\n    if (legacySettings.altitude !== false) {\n        slots.push(slot('elevation-current', 'medium'));\n    }\n\n    // If no fields were enabled, use defaults\n    if (slots.length === 0) {\n        return createDefaultSettings();\n    }\n\n    // Create a migrated profile\n    const migratedProfile: ActivityProfile = {\n        id: 'migrated-profile',\n        name: 'Migrated',\n        activityType: 'cycling',\n        icon: '',\n        screens: [\n            {\n                id: 'migrated-main',\n                name: 'Main',\n                icon: '',\n                layout: 'auto',\n                slots: slots.map((s, i) => ({ ...s, position: i + 1 })),\n            },\n        ],\n        activeScreenIndex: 0,\n    };\n\n    return {\n        profiles: [migratedProfile, createDefaultIndoorProfile()],\n        activeProfileId: 'migrated-profile',\n        unitSystem: 'metric',\n        fieldPreferences: {},\n        version: 1,\n    };\n}\n\n// ============================================================================\n// Quick Presets\n// ============================================================================\n\n/** Quick preset: Power-focused 6-field screen */\nexport const PRESET_POWER_FOCUS: DataScreen = (() => {\n    resetSlotCounter();\n    return {\n        id: 'preset-power',\n        name: 'Power Focus',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-3s', 'large'),\n            slot('power-avg', 'medium'),\n            slot('power-normalized', 'medium'),\n            slot('watts-per-kg', 'medium'),\n            slot('cadence-current', 'medium'),\n            slot('heartrate-current', 'medium'),\n        ],\n    };\n})();\n\n/** Quick preset: Endurance ride */\nexport const PRESET_ENDURANCE: DataScreen = (() => {\n    resetSlotCounter();\n    return {\n        id: 'preset-endurance',\n        name: 'Endurance',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('heartrate-zone', 'large'),\n            slot('time-elapsed', 'medium'),\n            slot('distance-total', 'medium'),\n            slot('speed-avg', 'medium'),\n            slot('elevation-gain', 'medium'),\n            slot('calories-burned', 'medium'),\n        ],\n    };\n})();\n\n/** Quick preset: Interval training */\nexport const PRESET_INTERVALS: DataScreen = (() => {\n    resetSlotCounter();\n    return {\n        id: 'preset-intervals',\n        name: 'Intervals',\n        icon: '',\n        layout: 'auto',\n        slots: [\n            slot('power-current', 'large'),\n            slot('time-lap', 'large'),\n            slot('power-lap-avg', 'medium'),\n            slot('heartrate-current', 'medium'),\n            slot('time-lap-number', 'medium'),\n            slot('time-elapsed', 'medium'),\n        ],\n    };\n})();\n\n/** All quick presets */\nexport const SCREEN_PRESETS: DataScreen[] = [PRESET_POWER_FOCUS, PRESET_ENDURANCE, PRESET_INTERVALS];\n","/**\n * Data Fields Manager\n *\n * Integration layer that connects the data fields system with the app's\n * MeasurementsState and UI components. Handles:\n * - Real-time data updates from sensors\n * - Calculated field scheduling\n * - UI component synchronization\n * - Profile/screen management\n *\n * @module DataFieldsManager\n */\n\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { ConnectionsState, TimeState } from '../getInitState.js';\nimport {\n    DEFAULT_HR_ZONES,\n    DEFAULT_POWER_ZONES,\n    type ActivityProfile,\n    type UserSettings,\n    type WorkoutState,\n} from './types.js';\nimport type { ScreenCarouselComponent } from '../components/data-fields/ScreenCarouselComponent.js';\nimport { getDataField } from './registry.js';\nimport { createCalculationManager, type CalculationManager } from './CalculationManager.js';\nimport { DEFAULT_CYCLING_PROFILE } from './defaults.js';\nimport { dataFieldsUpdater } from './AdaptiveUpdater.js';\n\n/**\n * Maps MeasurementsState properties to data field IDs\n */\nconst SENSOR_FIELD_MAP: Record<string, string> = {\n    power: 'power-current',\n    heartrate: 'heartrate-current',\n    cadence: 'cadence-current',\n    speed: 'speed-current',\n    distance: 'distance-total',\n    altitude: 'elevation-current',\n};\n\n/**\n * Data fields manager configuration\n */\nexport interface DataFieldsManagerConfig {\n    measurementsState: MeasurementsState;\n    connectionsState: ConnectionsState;\n    timeState?: TimeState;\n    initialProfile?: ActivityProfile;\n}\n\n/**\n * Data Fields Manager\n *\n * Orchestrates the data fields system, connecting sensor data\n * with UI components and calculated fields.\n */\nexport class DataFieldsManager {\n    private measurementsState: MeasurementsState;\n    private connectionsState: ConnectionsState;\n    private timeState?: TimeState;\n    private calculationManager: CalculationManager;\n    private activeProfile: ActivityProfile;\n    private carouselComponent: ScreenCarouselComponent | null = null;\n    private unsubscribeUpdater: (() => void) | null = null;\n    private listeners: Map<string, Set<(value: number | null) => void>> = new Map();\n\n    constructor(config: DataFieldsManagerConfig) {\n        this.measurementsState = config.measurementsState;\n        this.connectionsState = config.connectionsState;\n        this.timeState = config.timeState;\n        this.activeProfile = config.initialProfile ?? DEFAULT_CYCLING_PROFILE;\n\n        // Create calculation manager\n        this.calculationManager = createCalculationManager(\n            this.measurementsState,\n            this.createWorkoutState(),\n            this.createUserSettings()\n        );\n\n        // Listen to calculation updates\n        this.calculationManager.onUpdate((fieldId, value) => {\n            this.notifyFieldUpdate(fieldId, value);\n            this.updateCarouselField(fieldId, value);\n            // Notify adaptive updater of activity\n            dataFieldsUpdater.notifyDataChange();\n        });\n    }\n\n    /**\n     * Start the data fields manager\n     */\n    public start(): void {\n        // Start calculation manager\n        this.calculationManager.start();\n\n        // Start UI update loop\n        this.startUpdateLoop();\n\n        console.log('[DataFieldsManager] Started');\n    }\n\n    /**\n     * Stop the data fields manager\n     */\n    public stop(): void {\n        // Stop calculation manager\n        this.calculationManager.stop();\n\n        // Stop UI update loop\n        this.stopUpdateLoop();\n\n        console.log('[DataFieldsManager] Stopped');\n    }\n\n    /**\n     * Set the active profile\n     */\n    public setProfile(profile: ActivityProfile): void {\n        this.activeProfile = profile;\n        if (this.carouselComponent) {\n            this.carouselComponent.setProfile(profile);\n        }\n    }\n\n    /**\n     * Get the active profile\n     */\n    public getProfile(): ActivityProfile {\n        return this.activeProfile;\n    }\n\n    /**\n     * Attach to a screen carousel component\n     */\n    public attachToCarousel(carousel: ScreenCarouselComponent): void {\n        this.carouselComponent = carousel;\n        carousel.setProfile(this.activeProfile);\n\n        // Update connection states\n        this.updateSensorConnections();\n    }\n\n    /**\n     * Detach from carousel\n     */\n    public detachFromCarousel(): void {\n        this.carouselComponent = null;\n    }\n\n    /**\n     * Get current value for a data field\n     */\n    public getFieldValue(fieldId: string): number | null {\n        const field = getDataField(fieldId);\n        if (!field) return null;\n\n        // Check if it's a direct sensor field\n        for (const [prop, id] of Object.entries(SENSOR_FIELD_MAP)) {\n            if (id === fieldId) {\n                return this.getSensorValue(prop);\n            }\n        }\n\n        // Otherwise try to calculate it\n        return this.calculationManager.calculateField(fieldId);\n    }\n\n    /**\n     * Subscribe to field value updates\n     */\n    public onFieldUpdate(fieldId: string, callback: (value: number | null) => void): () => void {\n        if (!this.listeners.has(fieldId)) {\n            this.listeners.set(fieldId, new Set());\n        }\n        this.listeners.get(fieldId)!.add(callback);\n\n        // Return unsubscribe function\n        return () => {\n            const set = this.listeners.get(fieldId);\n            if (set) {\n                set.delete(callback);\n                if (set.size === 0) {\n                    this.listeners.delete(fieldId);\n                }\n            }\n        };\n    }\n\n    /**\n     * Get all fields used in the current profile\n     */\n    public getActiveFields(): string[] {\n        const fields = new Set<string>();\n        for (const screen of this.activeProfile.screens) {\n            for (const slot of screen.slots) {\n                fields.add(slot.fieldId);\n            }\n        }\n        return Array.from(fields);\n    }\n\n    // ========================================================================\n    // Private Methods\n    // ========================================================================\n\n    private startUpdateLoop(): void {\n        if (this.unsubscribeUpdater) return;\n\n        this.unsubscribeUpdater = dataFieldsUpdater.subscribe(() => {\n            this.updateSensorFields();\n            this.updateSensorConnections();\n        });\n    }\n\n    private stopUpdateLoop(): void {\n        if (this.unsubscribeUpdater) {\n            this.unsubscribeUpdater();\n            this.unsubscribeUpdater = null;\n        }\n    }\n\n    private updateSensorFields(): void {\n        // Update direct sensor readings\n        for (const [prop, fieldId] of Object.entries(SENSOR_FIELD_MAP)) {\n            const value = this.getSensorValue(prop);\n            this.notifyFieldUpdate(fieldId, value);\n            this.updateCarouselField(fieldId, value);\n        }\n\n        // Update time-based fields\n        if (this.timeState) {\n            const elapsed = this.getElapsedTime();\n            this.notifyFieldUpdate('time-elapsed', elapsed);\n            this.updateCarouselField('time-elapsed', elapsed);\n        }\n    }\n\n    private updateSensorConnections(): void {\n        if (!this.carouselComponent) return;\n\n        // Update connection states based on ConnectionsState\n        const connections = this.connectionsState;\n\n        // Power\n        const powerConnected = connections.power?.isConnected ?? false;\n        this.carouselComponent.setSensorConnected('power', powerConnected);\n\n        // Heart rate\n        const hrConnected = connections.heartrate?.isConnected ?? false;\n        this.carouselComponent.setSensorConnected('heartrate', hrConnected);\n\n        // Cadence\n        const cadenceConnected = connections.cadence?.isConnected ?? false;\n        this.carouselComponent.setSensorConnected('cadence', cadenceConnected);\n\n        // Speed (from GPS or calculated)\n        const gpsConnected = connections.gps?.isConnected ?? false;\n        this.carouselComponent.setSensorConnected('speed', gpsConnected);\n    }\n\n    /**\n     * Get the latest sensor value from measurement arrays\n     */\n    private getSensorValue(property: string): number | null {\n        const state = this.measurementsState;\n\n        switch (property) {\n            case 'power':\n                return this.getLatestValue(state.power);\n            case 'heartrate':\n                return this.getLatestValue(state.heartrate);\n            case 'cadence':\n                return this.getLatestValue(state.cadence);\n            case 'speed':\n                return this.getLatestValue(state.speed);\n            case 'distance':\n                return this.getLatestValue(state.distance);\n            case 'altitude':\n                return this.getLatestValue(state.altitude);\n            default:\n                return null;\n        }\n    }\n\n    /**\n     * Get the latest value from a measurement array\n     */\n    private getLatestValue(measurements: Array<{ value: number; timestamp: number }> | undefined): number | null {\n        if (!measurements || measurements.length === 0) {\n            return null;\n        }\n        return measurements[measurements.length - 1].value;\n    }\n\n    private notifyFieldUpdate(fieldId: string, value: number | null): void {\n        const callbacks = this.listeners.get(fieldId);\n        if (callbacks) {\n            for (const cb of callbacks) {\n                cb(value);\n            }\n        }\n    }\n\n    private updateCarouselField(fieldId: string, value: number | null): void {\n        if (this.carouselComponent) {\n            this.carouselComponent.updateFieldValue(fieldId, value);\n        }\n    }\n\n    private createWorkoutState(): WorkoutState {\n        const laps = this.measurementsState.laps || [];\n        const lapCount = laps.length;\n        const lastLapTimestamp = lapCount > 0 ? laps[lapCount - 1].timestamp : null;\n        const lapStartTime = lastLapTimestamp ?? this.timeState?.startTime ?? null;\n\n        return {\n            isActive: this.timeState?.running ?? false,\n            isPaused: false,\n            startTime: this.timeState?.startTime ?? null,\n            elapsedTime: this.getElapsedTime(),\n            movingTime: this.getElapsedTime(),\n            pausedTime: 0,\n            currentLap: lapCount + 1,\n            lapStartTime,\n            lapElapsedTime: lapStartTime ? Date.now() - lapStartTime : 0,\n            laps: laps.map((lap, idx) => ({\n                lapNumber: lap.number,\n                startTime: idx === 0 ? (this.timeState?.startTime ?? lap.timestamp) : laps[idx - 1].timestamp,\n                endTime: lap.timestamp,\n                duration: lap.elapsedMs ?? 0,\n                distance: 0,\n                avgPower: null,\n                avgHeartrate: null,\n                avgCadence: null,\n                avgSpeed: null,\n                elevationGain: 0,\n            })),\n        };\n    }\n\n    private getElapsedTime(): number {\n        if (!this.timeState?.running || !this.timeState.startTime) {\n            return 0;\n        }\n        return Date.now() - this.timeState.startTime;\n    }\n\n    /**\n     * Create user settings for data field calculations.\n     * These settings are currently hardcoded defaults since\n     * the AppSettings interface doesn't include training zones.\n     * TODO: Add these to settings UI and persist them.\n     */\n    private createUserSettings(): UserSettings {\n        // AppSettings doesn't have training-specific settings yet,\n        // so we use reasonable defaults\n        return {\n            unitSystem: 'metric' as const,\n            ftp: 200, // Functional Threshold Power (watts)\n            maxHr: 190, // Maximum heart rate (bpm)\n            weight: 70, // Rider weight (kg)\n            restingHr: 60, // Resting heart rate (bpm)\n            showCalories: true,\n            // Power zones as percentage of FTP\n            powerZones: DEFAULT_POWER_ZONES,\n            // HR zones as percentage of max HR\n            hrZones: DEFAULT_HR_ZONES,\n        };\n    }\n}\n\n/**\n * Create a new DataFieldsManager instance\n */\nexport function createDataFieldsManager(config: DataFieldsManagerConfig): DataFieldsManager {\n    return new DataFieldsManager(config);\n}\n\n/**\n * Global data fields manager instance\n */\nlet globalManager: DataFieldsManager | null = null;\n\n/**\n * Initialize the global data fields manager\n */\nexport function initGlobalDataFieldsManager(config: DataFieldsManagerConfig): DataFieldsManager {\n    if (globalManager) {\n        globalManager.stop();\n    }\n    globalManager = new DataFieldsManager(config);\n    return globalManager;\n}\n\n/**\n * Get the global data fields manager\n */\nexport function getGlobalDataFieldsManager(): DataFieldsManager | null {\n    return globalManager;\n}\n","/**\n * Data Fields Persistence\n *\n * Handles saving and loading data field configurations to localStorage.\n * Supports:\n * - Activity profiles with custom screens\n * - Field preferences (alerts, voice announcements)\n * - Migration from legacy settings\n *\n * @module data-fields/persistence\n */\n\nimport type { ActivityProfile, DataFieldSettings, FieldPreference } from './types.js';\nimport {\n    DEFAULT_CYCLING_PROFILE,\n    DEFAULT_INDOOR_PROFILE,\n    DEFAULT_RUNNING_PROFILE,\n    DEFAULT_DATA_FIELD_SETTINGS,\n    migrateFromLegacySettings,\n} from './defaults.js';\n\n/** LocalStorage key for data field settings */\nconst STORAGE_KEY = 'bpt-data-fields';\n\n/** LocalStorage key for legacy settings (for migration) */\nconst LEGACY_SETTINGS_KEY = 'bpt-settings';\n\n/** Current schema version for data migration */\nconst SCHEMA_VERSION = 1;\n\n/**\n * Stored settings format with version for migrations\n */\ninterface StoredSettings {\n    version: number;\n    settings: DataFieldSettings;\n}\n\n// ============================================================================\n// Load Functions\n// ============================================================================\n\n/**\n * Load data field settings from localStorage\n *\n * @returns The loaded settings or defaults if none exist\n */\nexport function loadDataFieldSettings(): DataFieldSettings {\n    try {\n        const stored = localStorage.getItem(STORAGE_KEY);\n\n        if (stored) {\n            const parsed = JSON.parse(stored) as StoredSettings;\n\n            // Handle version migrations\n            const migrated = migrateStoredSettings(parsed);\n\n            // Validate loaded settings\n            if (validateSettings(migrated)) {\n                return migrated;\n            }\n\n            console.warn('[DataFields] Invalid stored settings, using defaults');\n            // Overwrite invalid settings to prevent persistent errors\n            saveDataFieldSettings({ ...DEFAULT_DATA_FIELD_SETTINGS });\n            return { ...DEFAULT_DATA_FIELD_SETTINGS };\n        }\n\n        // Try to migrate from legacy settings\n        const legacyStored = localStorage.getItem(LEGACY_SETTINGS_KEY);\n        if (legacyStored) {\n            try {\n                const legacy = JSON.parse(legacyStored);\n                const migrated = migrateFromLegacySettings(legacy);\n                saveDataFieldSettings(migrated);\n                return migrated;\n            } catch {\n                console.warn('[DataFields] Failed to migrate legacy settings');\n            }\n        }\n\n        return { ...DEFAULT_DATA_FIELD_SETTINGS };\n    } catch (error) {\n        console.error('[DataFields] Error loading settings:', error);\n        return { ...DEFAULT_DATA_FIELD_SETTINGS };\n    }\n}\n\n/**\n * Load a specific profile by ID\n */\nexport function loadProfile(profileId: string): ActivityProfile | null {\n    const settings = loadDataFieldSettings();\n    return settings.profiles.find((p) => p.id === profileId) ?? null;\n}\n\n/**\n * Load the currently active profile\n */\nexport function loadActiveProfile(): ActivityProfile {\n    const settings = loadDataFieldSettings();\n    const active = settings.profiles.find((p) => p.id === settings.activeProfileId);\n    return active ?? settings.profiles[0] ?? DEFAULT_CYCLING_PROFILE;\n}\n\n/**\n * Load field preferences for a specific field\n */\nexport function loadFieldPreference(fieldId: string): FieldPreference | null {\n    const settings = loadDataFieldSettings();\n    return settings.fieldPreferences[fieldId] ?? null;\n}\n\n// ============================================================================\n// Save Functions\n// ============================================================================\n\n/**\n * Save data field settings to localStorage\n */\nexport function saveDataFieldSettings(settings: DataFieldSettings): boolean {\n    try {\n        const stored: StoredSettings = {\n            version: SCHEMA_VERSION,\n            settings,\n        };\n\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(stored));\n        return true;\n    } catch (error) {\n        console.error('[DataFields] Error saving settings:', error);\n        return false;\n    }\n}\n\n/**\n * Save a single profile (creates or updates)\n */\nexport function saveProfile(profile: ActivityProfile): boolean {\n    const settings = loadDataFieldSettings();\n\n    const existingIndex = settings.profiles.findIndex((p) => p.id === profile.id);\n    if (existingIndex >= 0) {\n        settings.profiles[existingIndex] = profile;\n    } else {\n        settings.profiles.push(profile);\n    }\n\n    return saveDataFieldSettings(settings);\n}\n\n/**\n * Delete a profile by ID\n *\n * @returns false if trying to delete the last profile\n */\nexport function deleteProfile(profileId: string): boolean {\n    const settings = loadDataFieldSettings();\n\n    // Don't allow deleting the last profile\n    if (settings.profiles.length <= 1) {\n        console.warn('[DataFields] Cannot delete the last profile');\n        return false;\n    }\n\n    const index = settings.profiles.findIndex((p) => p.id === profileId);\n    if (index < 0) {\n        return false;\n    }\n\n    settings.profiles.splice(index, 1);\n\n    // If we deleted the active profile, set a new one\n    if (settings.activeProfileId === profileId) {\n        settings.activeProfileId = settings.profiles[0].id;\n    }\n\n    return saveDataFieldSettings(settings);\n}\n\n/**\n * Set the active profile by ID\n */\nexport function setActiveProfile(profileId: string): boolean {\n    const settings = loadDataFieldSettings();\n\n    const exists = settings.profiles.some((p) => p.id === profileId);\n    if (!exists) {\n        console.warn('[DataFields] Profile not found:', profileId);\n        return false;\n    }\n\n    settings.activeProfileId = profileId;\n    return saveDataFieldSettings(settings);\n}\n\n/**\n * Save field preferences for a specific field\n */\nexport function saveFieldPreference(fieldId: string, preference: FieldPreference): boolean {\n    const settings = loadDataFieldSettings();\n    settings.fieldPreferences[fieldId] = preference;\n    return saveDataFieldSettings(settings);\n}\n\n/**\n * Update the active screen index for a profile\n */\nexport function saveActiveScreenIndex(profileId: string, screenIndex: number): boolean {\n    const settings = loadDataFieldSettings();\n\n    const profile = settings.profiles.find((p) => p.id === profileId);\n    if (!profile) {\n        return false;\n    }\n\n    profile.activeScreenIndex = Math.max(0, Math.min(screenIndex, profile.screens.length - 1));\n    return saveDataFieldSettings(settings);\n}\n\n// ============================================================================\n// Reset Functions\n// ============================================================================\n\n/**\n * Reset all settings to defaults\n */\nexport function resetToDefaults(): boolean {\n    try {\n        localStorage.removeItem(STORAGE_KEY);\n        return true;\n    } catch (error) {\n        console.error('[DataFields] Error resetting settings:', error);\n        return false;\n    }\n}\n\n/**\n * Reset a specific profile to its default configuration\n */\nexport function resetProfileToDefault(profileId: string): boolean {\n    const settings = loadDataFieldSettings();\n\n    const profile = settings.profiles.find((p) => p.id === profileId);\n    if (!profile) {\n        return false;\n    }\n\n    // Find the default profile that matches this activity type\n    const defaults = getDefaultProfileForType(profile.activityType);\n    if (defaults) {\n        const index = settings.profiles.findIndex((p) => p.id === profileId);\n        settings.profiles[index] = { ...defaults, id: profileId };\n        return saveDataFieldSettings(settings);\n    }\n\n    return false;\n}\n\n// ============================================================================\n// Export/Import Functions\n// ============================================================================\n\n/**\n * Export settings as JSON string for backup\n */\nexport function exportSettings(): string {\n    const settings = loadDataFieldSettings();\n    return JSON.stringify(settings, null, 2);\n}\n\n/**\n * Import settings from JSON string\n *\n * @returns true if import was successful\n */\nexport function importSettings(jsonString: string): boolean {\n    try {\n        const parsed = JSON.parse(jsonString) as DataFieldSettings;\n\n        if (!validateSettings(parsed)) {\n            console.error('[DataFields] Invalid settings format');\n            return false;\n        }\n\n        return saveDataFieldSettings(parsed);\n    } catch (error) {\n        console.error('[DataFields] Error importing settings:', error);\n        return false;\n    }\n}\n\n/**\n * Export a single profile as JSON\n */\nexport function exportProfile(profileId: string): string | null {\n    const profile = loadProfile(profileId);\n    if (!profile) {\n        return null;\n    }\n    return JSON.stringify(profile, null, 2);\n}\n\n/**\n * Import a profile from JSON string\n */\nexport function importProfile(jsonString: string): ActivityProfile | null {\n    try {\n        const parsed = JSON.parse(jsonString) as ActivityProfile;\n\n        if (!validateProfile(parsed)) {\n            console.error('[DataFields] Invalid profile format');\n            return null;\n        }\n\n        // Generate new ID to avoid conflicts\n        parsed.id = generateUniqueId();\n\n        // Save the imported profile\n        if (saveProfile(parsed)) {\n            return parsed;\n        }\n\n        return null;\n    } catch (error) {\n        console.error('[DataFields] Error importing profile:', error);\n        return null;\n    }\n}\n\n// ============================================================================\n// Migration Functions\n// ============================================================================\n\n/**\n * Migrate stored settings to current schema version\n */\nfunction migrateStoredSettings(stored: StoredSettings): DataFieldSettings {\n    let settings = stored.settings;\n    let version = stored.version;\n\n    // Apply migrations in order\n    while (version < SCHEMA_VERSION) {\n        switch (version) {\n            case 0:\n                // v0 -> v1: Add fieldPreferences if missing\n                settings.fieldPreferences = settings.fieldPreferences ?? {};\n                break;\n            // Add future migrations here\n        }\n        version++;\n    }\n\n    return settings;\n}\n\n// ============================================================================\n// Validation Functions\n// ============================================================================\n\n/**\n * Validate complete settings object\n */\nfunction validateSettings(settings: unknown): settings is DataFieldSettings {\n    if (!settings || typeof settings !== 'object') {\n        return false;\n    }\n\n    const s = settings as DataFieldSettings; // Safe to cast for property checking after object check\n\n    if (!Array.isArray(s.profiles) || s.profiles.length === 0) {\n        return false;\n    }\n\n    if (typeof s.activeProfileId !== 'string') {\n        return false;\n    }\n\n    if (!['metric', 'imperial'].includes(s.unitSystem)) {\n        return false;\n    }\n\n    // Validate each profile\n    return s.profiles.every(validateProfile);\n}\n\n/**\n * Validate a single profile\n */\nfunction validateProfile(profile: unknown): profile is ActivityProfile {\n    if (!profile || typeof profile !== 'object') {\n        return false;\n    }\n\n    const p = profile as { id?: unknown; name?: unknown; screens?: unknown };\n\n    if (typeof p.id !== 'string' || p.id.length === 0) {\n        return false;\n    }\n\n    if (typeof p.name !== 'string' || p.name.length === 0) {\n        return false;\n    }\n\n    if (!Array.isArray(p.screens) || p.screens.length === 0) {\n        return false;\n    }\n\n    return true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Generate a unique ID for new profiles\n */\nfunction generateUniqueId(): string {\n    return `profile-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\n}\n\n/**\n * Get default profile for an activity type\n */\nfunction getDefaultProfileForType(activityType: string): ActivityProfile | null {\n    switch (activityType) {\n        case 'cycling':\n            return DEFAULT_CYCLING_PROFILE;\n        case 'indoor':\n            return DEFAULT_INDOOR_PROFILE;\n        case 'running':\n            return DEFAULT_RUNNING_PROFILE;\n        default:\n            return DEFAULT_CYCLING_PROFILE;\n    }\n}\n\n// ============================================================================\n// Storage Event Handling\n// ============================================================================\n\n/** Callbacks for storage change events */\ntype StorageChangeCallback = (settings: DataFieldSettings) => void;\nconst storageCallbacks: Set<StorageChangeCallback> = new Set();\n\n/**\n * Subscribe to storage changes (useful for syncing across tabs)\n */\nexport function onStorageChange(callback: StorageChangeCallback): () => void {\n    storageCallbacks.add(callback);\n\n    // Return unsubscribe function\n    return () => {\n        storageCallbacks.delete(callback);\n    };\n}\n\n// Listen for storage events from other tabs\nif (typeof window !== 'undefined') {\n    window.addEventListener('storage', (event) => {\n        if (event.key === STORAGE_KEY && event.newValue) {\n            try {\n                const stored = JSON.parse(event.newValue) as StoredSettings;\n                for (const callback of storageCallbacks) {\n                    callback(stored.settings);\n                }\n            } catch {\n                // Ignore parse errors\n            }\n        }\n    });\n}\n","import { initTimerDisplay, pauseWorkout, resumeWorkout } from '../ui/time.js';\nimport { initDiscardButton, initExportButton, initMetricsToggle, initWorkoutSummaryModal } from '../ui/menu.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { announce } from '../ui/accessibility.js';\nimport { getTimestring } from '../getTimestring.js';\nimport { initMetricsDisplay } from '../initMetricsDisplay.js';\nimport { initStreamViewer } from '../ui/streamViewer.js';\nimport { initStreamingControls } from '../initStreamingControls.js';\nimport { initWorkoutBuilder } from '../ui/workoutBuilder.js';\nimport { initKeyboardNavigation } from '../ui/accessibility.js';\nimport { setupDarkModeToggle } from '../ui/darkMode.js';\nimport { initOnboarding } from '../ui/onboarding.js';\nimport { initLapButton } from '../ui/lap.js';\nimport { initWorkoutRecovery } from '../ui/workoutRecovery.js';\nimport { initInstallPrompt } from '../ui/installPrompt.js';\nimport { initAboutModal } from '../ui/about.js';\nimport { handleWakeLock } from '../ui/wakeLock.js';\nimport { registerServiceWorker } from '../ui/serviceWorker.js';\nimport { initMap } from './map.js';\nimport { AutoPauseService } from '../services/AutoPauseService.js';\nimport { autoLapService } from '../services/AutoLapService.js';\nimport { voiceFeedback } from '../services/VoiceFeedback.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState, ConnectionsState } from '../getInitState.js';\nimport type { ZoneState } from '../zone-state.js';\nimport type { StreamManager } from '../stream-manager.js';\nimport { createDataFieldsManager } from '../data-fields/DataFieldsManager.js';\nimport { DEFAULT_CYCLING_PROFILE } from '../data-fields/defaults.js';\nimport { loadActiveProfile, saveActiveScreenIndex } from '../data-fields/persistence.js';\nimport type { ActivityProfile } from '../data-fields/types.js';\nimport type { ScreenCarouselComponent } from '../components/data-fields/ScreenCarouselComponent.js';\n\n/**\n * Parameters for UI initialization\n */\ninterface UiInitParams {\n    measurementsState: MeasurementsState;\n    timeState: TimeState;\n    connectionsState: ConnectionsState;\n    streamManager: StreamManager;\n}\n\n/**\n * Initialize all User Interface components\n *\n * Sets up:\n * - Metrics displays (Power, HR, Cadence)\n * - Navigation and Menus\n * - Streaming controls and viewer\n * - Workout builder\n * - System features (Wake lock, PWA install, Service Worker)\n * - Accessibility features\n *\n * @param params - State objects and dependencies\n * @returns The initialized ZoneState for zone distribution tracking\n */\nexport function initUi({ measurementsState, timeState, connectionsState, streamManager }: UiInitParams): ZoneState {\n    // Initialize UI components\n    initTimerDisplay(timeState);\n    const zoneState = initMetricsDisplay({ measurementsState });\n\n    // Initialize Map\n    initMap(measurementsState, connectionsState);\n\n    // Initialize Data Fields System\n    const dataFieldsCarousel = document.getElementById('dataFieldsCarousel') as HTMLElement | null;\n    let dataFieldsManager: ReturnType<typeof createDataFieldsManager> | null = null;\n\n    if (dataFieldsCarousel) {\n        try {\n            let activeProfile = loadActiveProfile();\n\n            // Safety check: ensure profile has screens\n            if (!activeProfile.screens || activeProfile.screens.length === 0) {\n                console.warn('[DataFields] Active profile has no screens, using default');\n                // Use default cycling profile as fallback\n                activeProfile = DEFAULT_CYCLING_PROFILE;\n            }\n\n            dataFieldsManager = createDataFieldsManager({\n                measurementsState,\n                connectionsState,\n                timeState,\n                initialProfile: activeProfile,\n            });\n\n            // Start manager immediately to begin calculations\n            dataFieldsManager.start();\n            console.log('[DataFields] Manager initialized with profile:', activeProfile.name);\n\n            // Wait for component upgrade before attaching\n            customElements.whenDefined('bpt-screen-carousel').then(() => {\n                if (dataFieldsManager && dataFieldsCarousel) {\n                    dataFieldsManager.attachToCarousel(dataFieldsCarousel as ScreenCarouselComponent);\n                }\n            });\n\n            // Listen for profile changes from settings\n            document.addEventListener('data-fields-profile-changed', (e: Event) => {\n                const customEvent = e as CustomEvent<{ profile: ActivityProfile }>;\n                if (dataFieldsManager && customEvent.detail?.profile) {\n                    dataFieldsManager.setProfile(customEvent.detail.profile);\n                    console.log('[DataFields] Profile updated from settings');\n                }\n            });\n\n            // Listen for screen changes to persist active screen index\n            dataFieldsCarousel.addEventListener('screen-change', (e: Event) => {\n                const customEvent = e as CustomEvent<{ screenIndex: number }>;\n                if (customEvent.detail && activeProfile) {\n                    saveActiveScreenIndex(activeProfile.id, customEvent.detail.screenIndex);\n                }\n            });\n        } catch (error) {\n            console.error('[DataFields] Failed to initialize:', error);\n        }\n    }\n\n    // PWA & System features\n    handleWakeLock();\n    registerServiceWorker();\n    initInstallPrompt();\n\n    // UI Modules\n    initAboutModal();\n    initStreamViewer();\n    initStreamingControls(streamManager, timeState);\n    initWorkoutBuilder();\n    initKeyboardNavigation();\n\n    const darkModeToggle = document.getElementById('toggleDarkMode') as HTMLInputElement | null;\n    if (darkModeToggle) {\n        setupDarkModeToggle(darkModeToggle);\n    }\n\n    initOnboarding();\n    initLapButton({ measurementsState, timeState });\n\n    // Initialize Auto-Pause Service\n    const autoPauseService = new AutoPauseService(measurementsState, timeState, {\n        onAutoPause: () => pauseWorkout(timeState, true),\n        onAutoResume: () => resumeWorkout(timeState, true),\n    });\n\n    // Initialize Auto-Lap Service\n    autoLapService.init(measurementsState, timeState);\n    autoLapService.onLap((lapNumber) => {\n        const laps = measurementsState.laps;\n        const lap = laps.find((l) => l.number === lapNumber);\n\n        if (lap) {\n            const elapsedStr = lap.elapsedMs ? getTimestring(lap.elapsedMs) : '';\n            const message = `Auto Lap ${lap.number}${elapsedStr ? ` at ${elapsedStr}` : ''}`;\n\n            showNotification(` ${message}`, 'info');\n            announce(message, 'assertive');\n        }\n    });\n\n    // Initialize Enhanced Voice Feedback\n    voiceFeedback.init(measurementsState, timeState);\n\n    // Start auto-pause monitoring when workout starts\n    document.addEventListener('workoutStarted', () => {\n        autoPauseService.start();\n        autoLapService.start();\n        voiceFeedback.startIntervalAnnouncements();\n    });\n\n    // Stop auto-pause monitoring when workout is discarded\n    document.addEventListener('workoutDiscarded', () => {\n        autoPauseService.reset();\n        autoLapService.reset();\n        voiceFeedback.reset();\n    });\n\n    // Re-initialize auto-pause when settings change\n    window.addEventListener('settings-changed', () => {\n        if (timeState.running) {\n            autoPauseService.stop();\n            autoPauseService.start();\n            autoLapService.stop();\n            autoLapService.start();\n            voiceFeedback.stopIntervalAnnouncements();\n            voiceFeedback.startIntervalAnnouncements();\n        }\n    });\n\n    initWorkoutRecovery(measurementsState, timeState).then((recovered) => {\n        if (recovered) {\n            console.log('Workout recovered from previous session');\n            // Update UI to reflect recovered data\n            document.dispatchEvent(new CustomEvent('workout-recovered'));\n        }\n    });\n\n    // Initialize menu controls\n    // Note: Some of these were at the bottom of main.ts before\n    initDiscardButton({ measurementsState, timeState, zoneState });\n    initExportButton(measurementsState, zoneState);\n    initMetricsToggle();\n    initWorkoutSummaryModal({ measurementsState, timeState, zoneState });\n\n    return zoneState;\n}\n","/**\n * Cadence Sensor Connection Module\n *\n * Connects to Bluetooth cadence sensors supporting the Cycling Speed and Cadence Service.\n *\n * @module connect-cadence\n */\n\nimport type { SensorConnection } from './types/bluetooth.js';\nimport { BluetoothFactory } from './services/bluetooth/factory.js';\n\n/**\n * Connect to a cadence sensor.\n *\n * @returns Promise resolving to a sensor connection\n */\nexport const connectCadence = async (): Promise<SensorConnection> => {\n    return BluetoothFactory.connectCadence();\n};\n","/**\n * Heart Rate Sensor Connection Module\n *\n * Connects to Bluetooth heart rate monitors supporting the Heart Rate Service.\n *\n * @module connect-heartrate\n */\n\nimport type { SensorConnection } from './types/bluetooth.js';\nimport { BluetoothFactory } from './services/bluetooth/factory.js';\n\n/**\n * Connect to a heart rate sensor.\n *\n * @returns Promise resolving to a sensor connection\n */\nexport const connectHeartRate = async (): Promise<SensorConnection> => {\n    return BluetoothFactory.connectHeartRate();\n};\n","/**\n * Power Sensor Connection Module\n *\n * Connects to Bluetooth cycling power meters supporting the Cycling Power Service.\n *\n * @module connect-power\n */\n\nimport type { SensorConnection } from './types/bluetooth.js';\nimport { BluetoothFactory } from './services/bluetooth/factory.js';\n\n/**\n * Connect to a power sensor.\n *\n * @returns Promise resolving to a sensor connection\n */\nexport const connectPower = async (): Promise<SensorConnection> => {\n    return BluetoothFactory.connectPower();\n};\n","import type { TreadmillConnection } from './types/bluetooth.js';\nimport { BluetoothFactory } from './services/bluetooth/factory.js';\n\nexport const connectTreadmill = async (): Promise<TreadmillConnection> => {\n    return BluetoothFactory.connectTreadmill();\n};\n","import { registerPlugin } from '@capacitor/core';\nimport type { BackgroundGeolocationPlugin, Location, CallbackError } from '@capacitor-community/background-geolocation';\nimport type { GpsService, GpsListener } from './types.js';\nimport type { GpsPoint } from '../../types/measurements.js';\n\nconst BackgroundGeolocation = registerPlugin<BackgroundGeolocationPlugin>('BackgroundGeolocation');\n\nexport const createNativeGpsService = (): GpsService => {\n    let watcherId: string | null = null;\n\n    return {\n        start: async (listener: GpsListener) => {\n            try {\n                watcherId = await BackgroundGeolocation.addWatcher(\n                    {\n                        backgroundMessage: 'Tracking your ride.',\n                        backgroundTitle: 'Bike Power Tracker',\n                        requestPermissions: true,\n                        stale: false,\n                        distanceFilter: 10,\n                    },\n                    (location: Location | null | undefined, error?: CallbackError | null) => {\n                        if (error) {\n                            if (error.code === 'NOT_AUTHORIZED') {\n                                if (\n                                    window.confirm(\n                                        'This app needs your location, ' +\n                                            'but does not have permission.\\n\\n' +\n                                            'Open settings now?'\n                                    )\n                                ) {\n                                    BackgroundGeolocation.openSettings();\n                                }\n                            }\n                            return console.error(error);\n                        }\n\n                        if (location) {\n                            const point: GpsPoint = {\n                                timestamp: location.time || Date.now(),\n                                lat: location.latitude,\n                                lon: location.longitude,\n                                accuracy: location.accuracy,\n                                altitude: location.altitude,\n                                speed: location.speed,\n                                heading: location.bearing,\n                            };\n                            listener(point);\n                        }\n                    }\n                );\n            } catch (e) {\n                console.error('Error starting native GPS:', e);\n            }\n        },\n        stop: async () => {\n            if (watcherId) {\n                await BackgroundGeolocation.removeWatcher({\n                    id: watcherId,\n                });\n                watcherId = null;\n            }\n        },\n    };\n};\n","import type { GpsService, GpsListener } from './types.js';\nimport type { GpsPoint } from '../../types/measurements.js';\n\nexport const createWebGpsService = (): GpsService => {\n    let watchId: number | null = null;\n\n    return {\n        start: async (listener: GpsListener) => {\n            if (!('geolocation' in navigator)) {\n                console.warn('Geolocation is not supported by this browser.');\n                return;\n            }\n\n            watchId = navigator.geolocation.watchPosition(\n                (position) => {\n                    const point: GpsPoint = {\n                        timestamp: position.timestamp,\n                        lat: position.coords.latitude,\n                        lon: position.coords.longitude,\n                        accuracy: position.coords.accuracy,\n                        altitude: position.coords.altitude,\n                        speed: position.coords.speed,\n                        heading: position.coords.heading,\n                    };\n                    listener(point);\n                },\n                (error) => {\n                    console.error('Error watching position:', error);\n                },\n                {\n                    enableHighAccuracy: true,\n                    timeout: 5000,\n                    maximumAge: 0,\n                }\n            );\n        },\n        stop: async () => {\n            if (watchId !== null) {\n                navigator.geolocation.clearWatch(watchId);\n                watchId = null;\n            }\n        },\n    };\n};\n","import { Capacitor } from '@capacitor/core';\nimport type { GpsService } from './types.js';\nimport { createNativeGpsService } from './native-gps.js';\nimport { createWebGpsService } from './web-gps.js';\n\nexport const GpsFactory = {\n    create: (): GpsService => {\n        if (Capacitor.isNativePlatform()) {\n            return createNativeGpsService();\n        } else {\n            return createWebGpsService();\n        }\n    },\n};\n","import type { GpsPoint } from './types/measurements.js';\nimport { GpsFactory } from './services/gps/factory.js';\nimport type { GpsListener } from './services/gps/types.js';\nimport { Capacitor } from '@capacitor/core';\n\nexport interface GpsConnection {\n    stop: () => Promise<void>;\n    deviceName?: string;\n}\n\nexport const connectGpsMock = async (listener: GpsListener): Promise<GpsConnection> => {\n    const interval = setInterval(() => {\n        const point: GpsPoint = {\n            timestamp: Date.now(),\n            lat: 52.52 + (Math.random() - 0.5) * 0.01,\n            lon: 13.405 + (Math.random() - 0.5) * 0.01,\n            accuracy: 5,\n            speed: (25 + (Math.random() - 0.5) * 5) / 3.6, // ~25 km/h in m/s\n            altitude: 50,\n            heading: 0,\n        };\n        listener(point);\n    }, 1000);\n\n    return {\n        stop: async () => clearInterval(interval),\n        deviceName: 'Mock GPS',\n    };\n};\n\nexport const connectGps = async (listener: GpsListener): Promise<GpsConnection> => {\n    // Use mock GPS only in development/test mode AND when not on native platform\n    // Native platforms should always use real GPS regardless of build mode\n    const useMock =\n        (import.meta.env.MODE === 'development' || import.meta.env.MODE === 'test') && !Capacitor.isNativePlatform();\n\n    if (useMock) {\n        return connectGpsMock(listener);\n    }\n\n    const service = GpsFactory.create();\n    await service.start(listener);\n\n    return {\n        stop: async () => service.stop(),\n        deviceName: 'GPS Sensor',\n    };\n};\n","/**\n * DOM Element References\n *\n * Centralized access to DOM elements used throughout the application.\n *\n * @module elements\n */\n\nimport type { SensorType } from './types/connections.js';\n\n/**\n * Sensor element configuration\n */\nexport interface SensorElements {\n    display: HTMLElement | null;\n    connect: HTMLElement | null;\n}\n\n/**\n * All sensor elements by type\n */\nexport type SensorElementsMap = Record<SensorType, SensorElements>;\n\n/**\n * Get DOM element by ID with null check\n *\n * @param id - Element ID\n * @returns The element or null if not found\n */\nfunction getElement<T extends HTMLElement = HTMLElement>(id: string): T | null {\n    const el = document.getElementById(id) as T | null;\n    if (!el) {\n        // console.warn(`Element with ID \"${id}\" not found`);\n    }\n    return el;\n}\n\n/**\n * Grouped elements by sensor type.\n * Uses getters to lazily retrieve elements from the DOM, ensuring they are found\n * even if this module is imported before the DOM is fully constructed.\n */\nexport const elements: SensorElementsMap = {\n    get power() {\n        return { display: getElement('power'), connect: getElement('connectPower') };\n    },\n    get heartrate() {\n        return { display: getElement('heartrate'), connect: getElement('connectHeartrate') };\n    },\n    get cadence() {\n        return { display: getElement('cadence'), connect: getElement('connectCadence') };\n    },\n    get gps() {\n        return { display: null, connect: getElement('connectGps') };\n    },\n    get speed() {\n        return { display: getElement('speed'), connect: null };\n    },\n    get distance() {\n        return { display: getElement('distance'), connect: null };\n    },\n    get altitude() {\n        return { display: getElement('altitude'), connect: null };\n    },\n    get treadmill() {\n        return { display: getElement('value-incline'), connect: getElement('connectTreadmill') };\n    },\n    get treadmillSpeed() {\n        return { display: getElement('treadmillSpeed'), connect: null };\n    },\n};\n\n/**\n * Get element by ID (type-safe helper)\n */\nexport { getElement };\n","/**\n * Connection Error UI Module\n *\n * Displays user-friendly error messages for Bluetooth connection failures\n * with troubleshooting suggestions and retry functionality.\n *\n * @module connectionError\n */\n\nimport { showModal } from './modal.js';\nimport { announce } from './accessibility.js';\nimport type { MeasurementType } from '../types/measurements.js';\n\n/**\n * Bluetooth error codes and their user-friendly messages\n */\ninterface ErrorInfo {\n    title: string;\n    message: string;\n    suggestions: string[];\n    canRetry: boolean;\n}\n\n/**\n * Sensor type display names\n */\nconst sensorLabels: Record<MeasurementType | 'treadmill', string> = {\n    power: 'Power Meter',\n    heartrate: 'Heart Rate Monitor',\n    cadence: 'Cadence Sensor',\n    speed: 'Speed Sensor',\n    distance: 'Distance Sensor',\n    altitude: 'Altimeter',\n    gps: 'GPS',\n    treadmill: 'Treadmill',\n    treadmillSpeed: 'Treadmill Speed',\n    energy: 'Energy',\n};\n\n/**\n * Sensor type icons\n */\nconst sensorIcons: Record<MeasurementType | 'treadmill', string> = {\n    power: '',\n    heartrate: '',\n    cadence: '',\n    speed: '',\n    distance: '',\n    altitude: '',\n    gps: '',\n    treadmill: '',\n    treadmillSpeed: '',\n    energy: '',\n};\n\n/**\n * Parse a Bluetooth error and return user-friendly information\n */\nfunction parseBluetoothError(error: unknown, sensorType: MeasurementType | 'treadmill'): ErrorInfo {\n    const sensorLabel = sensorLabels[sensorType];\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    const errorName = error instanceof Error ? error.name : '';\n\n    // User cancelled the device selection\n    if (errorMessage.includes('User cancelled') || errorMessage.includes('cancelled the requestDevice')) {\n        return {\n            title: 'Connection Cancelled',\n            message: `${sensorLabel} pairing was cancelled.`,\n            suggestions: ['Click the connect button to try again', 'Make sure your sensor is powered on and in range'],\n            canRetry: true,\n        };\n    }\n\n    // Bluetooth not available\n    if (\n        errorMessage.includes('Bluetooth adapter not available') ||\n        errorMessage.includes('Web Bluetooth API is not available') ||\n        (errorName === 'NotFoundError' && errorMessage.includes('Bluetooth'))\n    ) {\n        return {\n            title: 'Bluetooth Unavailable',\n            message: 'Bluetooth is not available on this device or browser.',\n            suggestions: [\n                'Check that Bluetooth is enabled in your device settings',\n                'Try using Chrome, Edge, or another browser that supports Web Bluetooth',\n                'On macOS, ensure Bluetooth permissions are granted in System Preferences',\n                'On Windows, check that your Bluetooth adapter is working',\n            ],\n            canRetry: false,\n        };\n    }\n\n    // No devices found\n    if (\n        errorMessage.includes('No Bluetooth devices') ||\n        errorMessage.includes('No devices found') ||\n        (errorName === 'NotFoundError' && !errorMessage.includes('Bluetooth'))\n    ) {\n        return {\n            title: 'No Sensors Found',\n            message: `No compatible ${sensorLabel.toLowerCase()} was found nearby.`,\n            suggestions: [\n                'Make sure your sensor is powered on',\n                'Wake up the sensor by spinning the pedals or moving',\n                'Bring the sensor closer to your device',\n                'Check that the sensor battery is not depleted',\n                'Ensure the sensor is not connected to another device',\n            ],\n            canRetry: true,\n        };\n    }\n\n    // GATT connection failed\n    if (\n        errorMessage.includes('GATT') ||\n        errorMessage.includes('Connection failed') ||\n        (errorMessage.includes('connect') && errorMessage.includes('fail'))\n    ) {\n        return {\n            title: 'Connection Failed',\n            message: `Could not connect to the ${sensorLabel.toLowerCase()}.`,\n            suggestions: [\n                'Try moving closer to the sensor',\n                'Power cycle the sensor (turn off and on again)',\n                'Check that no other device is connected to this sensor',\n                'Restart Bluetooth on your device',\n                'If using a phone, try closing other Bluetooth apps',\n            ],\n            canRetry: true,\n        };\n    }\n\n    // Security/permission error\n    if (\n        errorMessage.includes('SecurityError') ||\n        errorMessage.includes('permission') ||\n        errorName === 'SecurityError'\n    ) {\n        return {\n            title: 'Permission Denied',\n            message: 'Bluetooth permission was denied.',\n            suggestions: [\n                'Check your browser settings to allow Bluetooth access',\n                'If prompted, click \"Allow\" to grant Bluetooth permission',\n                'Try refreshing the page and connecting again',\n                'On some browsers, you may need to access this site over HTTPS',\n            ],\n            canRetry: true,\n        };\n    }\n\n    // Network/timeout error\n    if (errorMessage.includes('NetworkError') || errorMessage.includes('timeout') || errorName === 'NetworkError') {\n        return {\n            title: 'Connection Timed Out',\n            message: `The connection to your ${sensorLabel.toLowerCase()} timed out.`,\n            suggestions: [\n                'Make sure the sensor is in range and powered on',\n                'Try moving closer to the sensor',\n                'Power cycle the sensor and try again',\n                'Check for interference from other wireless devices',\n            ],\n            canRetry: true,\n        };\n    }\n\n    // Service not found\n    if (errorMessage.includes('Service') && errorMessage.includes('not found')) {\n        return {\n            title: 'Incompatible Sensor',\n            message: `This device doesn't appear to be a compatible ${sensorLabel.toLowerCase()}.`,\n            suggestions: [\n                'Make sure you selected the correct sensor type',\n                'Check that your sensor supports standard Bluetooth protocols',\n                'Some sensors may require a firmware update',\n                \"Consult your sensor's documentation for compatibility\",\n            ],\n            canRetry: true,\n        };\n    }\n\n    // Generic/unknown error\n    return {\n        title: 'Connection Error',\n        message: `Failed to connect to ${sensorLabel.toLowerCase()}.`,\n        suggestions: [\n            'Make sure the sensor is powered on and nearby',\n            'Try power cycling the sensor',\n            'Restart Bluetooth on your device',\n            'Refresh the page and try again',\n        ],\n        canRetry: true,\n    };\n}\n\n/**\n * Create the error content HTML element\n */\nfunction createErrorContent(errorInfo: ErrorInfo): HTMLElement {\n    const container = document.createElement('div');\n    container.className = 'connection-error-content';\n\n    // Error message\n    const messageEl = document.createElement('p');\n    messageEl.className = 'connection-error-message';\n    messageEl.textContent = errorInfo.message;\n    container.appendChild(messageEl);\n\n    // Troubleshooting section\n    if (errorInfo.suggestions.length > 0) {\n        const troubleshootingEl = document.createElement('div');\n        troubleshootingEl.className = 'connection-error-troubleshooting';\n\n        const titleEl = document.createElement('h3');\n        titleEl.textContent = ' Troubleshooting Tips';\n        troubleshootingEl.appendChild(titleEl);\n\n        const listEl = document.createElement('ul');\n        listEl.setAttribute('role', 'list');\n        errorInfo.suggestions.forEach((suggestion) => {\n            const itemEl = document.createElement('li');\n            itemEl.textContent = suggestion;\n            listEl.appendChild(itemEl);\n        });\n        troubleshootingEl.appendChild(listEl);\n\n        container.appendChild(troubleshootingEl);\n    }\n\n    return container;\n}\n\n/**\n * Show a connection error dialog with troubleshooting suggestions\n *\n * @param error - The error that occurred\n * @param sensorType - The type of sensor that failed to connect\n * @param onRetry - Optional callback for retry button\n * @returns Promise resolving to true if user wants to retry, false otherwise\n */\nexport function showConnectionError(\n    error: unknown,\n    sensorType: MeasurementType | 'treadmill',\n    onRetry?: () => void\n): Promise<boolean> {\n    return new Promise((resolve) => {\n        const errorInfo = parseBluetoothError(error, sensorType);\n        const sensorIcon = sensorIcons[sensorType];\n        const content = createErrorContent(errorInfo);\n\n        // Log the actual error for debugging\n        console.error(`[${sensorType}] Connection error:`, error);\n\n        // Announce to screen readers\n        announce(`${errorInfo.title}. ${errorInfo.message}`, 'assertive');\n\n        let closeModal: (() => void) | null = null;\n\n        const buttons = [];\n\n        // Always add a dismiss button\n        buttons.push({\n            text: 'Dismiss',\n            variant: 'secondary' as const,\n            onClick: () => {\n                closeModal?.();\n                resolve(false);\n            },\n        });\n\n        // Add retry button if applicable\n        if (errorInfo.canRetry) {\n            buttons.push({\n                text: 'Try Again',\n                variant: 'primary' as const,\n                onClick: () => {\n                    closeModal?.();\n                    if (onRetry) {\n                        onRetry();\n                    }\n                    resolve(true);\n                },\n            });\n        }\n\n        closeModal = showModal({\n            title: errorInfo.title,\n            icon: sensorIcon,\n            content,\n            buttons,\n            closeOnOverlay: true,\n            onClose: () => resolve(false),\n        });\n    });\n}\n\n/**\n * Show a reconnection failure notification\n *\n * Called when auto-reconnect has exhausted all attempts.\n *\n * @param sensorType - The type of sensor that failed to reconnect\n * @param onRetry - Optional callback to manually retry connection\n */\nexport function showReconnectionFailed(sensorType: MeasurementType | 'treadmill', onRetry?: () => void): void {\n    const sensorLabel = sensorLabels[sensorType];\n    const sensorIcon = sensorIcons[sensorType];\n\n    const content = document.createElement('div');\n    content.className = 'connection-error-content';\n\n    const messageEl = document.createElement('p');\n    messageEl.className = 'connection-error-message';\n    messageEl.textContent = `Lost connection to your ${sensorLabel.toLowerCase()} and automatic reconnection failed.`;\n    content.appendChild(messageEl);\n\n    const tipsEl = document.createElement('div');\n    tipsEl.className = 'connection-error-troubleshooting';\n\n    const titleEl = document.createElement('h3');\n    titleEl.textContent = ' To reconnect:';\n    tipsEl.appendChild(titleEl);\n\n    const listEl = document.createElement('ul');\n    listEl.setAttribute('role', 'list');\n    [\n        'Make sure the sensor is still powered on',\n        'Move closer to the sensor',\n        'Click \"Try Again\" to reconnect manually',\n    ].forEach((tip) => {\n        const itemEl = document.createElement('li');\n        itemEl.textContent = tip;\n        listEl.appendChild(itemEl);\n    });\n    tipsEl.appendChild(listEl);\n    content.appendChild(tipsEl);\n\n    announce(`${sensorLabel} connection lost. Automatic reconnection failed.`, 'assertive');\n\n    let closeModal: (() => void) | null = null;\n\n    closeModal = showModal({\n        title: 'Connection Lost',\n        icon: sensorIcon,\n        content,\n        buttons: [\n            {\n                text: 'Dismiss',\n                variant: 'secondary',\n                onClick: () => {\n                    closeModal?.();\n                },\n            },\n            {\n                text: 'Try Again',\n                variant: 'primary',\n                onClick: () => {\n                    closeModal?.();\n                    onRetry?.();\n                },\n            },\n        ],\n        closeOnOverlay: true,\n    });\n}\n","/**\n * Connection Button Initialization\n *\n * Sets up Bluetooth sensor connection buttons with connect/disconnect functionality.\n *\n * @module initConnectionButtons\n */\n\nimport { connectCadence } from './connect-cadence.js';\nimport { connectHeartRate } from './connect-heartrate.js';\nimport { connectPower } from './connect-power.js';\nimport { connectTreadmill } from './connect-treadmill.js';\nimport { connectGps, type GpsConnection } from './connect-gps.js';\nimport { elements } from './elements.js';\nimport type { MeasurementsState } from './measurements-state.js';\nimport type { Measurement, TreadmillMeasurement } from './types/measurements.js';\nimport type { ConnectionsState } from './getInitState.js';\nimport type { SensorType } from './types/connections.js';\nimport type { ConnectionStatus, SensorConnection, TreadmillConnection } from './types/bluetooth.js';\nimport { showNotification } from './ui/notifications.js';\nimport { showConnectionError, showReconnectionFailed } from './ui/connectionError.js';\n\n/**\n * Parameters for connection button initialization\n */\ninterface InitConnectionButtonsParams {\n    connectionsState: ConnectionsState;\n    measurementsState: MeasurementsState;\n}\n\n/**\n * Emoji icons for each sensor type\n */\nconst emojis: Record<SensorType, string> = {\n    power: '',\n    heartrate: '',\n    cadence: '',\n    speed: '',\n    distance: '',\n    altitude: '',\n    gps: '',\n    treadmill: '',\n    treadmillSpeed: '',\n};\n\n/**\n * Get formatted sensor type label\n */\nconst getSensorLabel = (key: SensorType): string => {\n    return key.charAt(0).toUpperCase() + key.slice(1);\n};\n\n/**\n * Initialize connection buttons for all sensor types.\n *\n * Sets up click handlers for connect/disconnect buttons that:\n * - Connect to Bluetooth sensors\n * - Update connection state\n * - Register measurement listeners\n * - Update UI to reflect connection status\n * - Display device name when connected\n * - Handle auto-reconnect status updates\n *\n * @param params - Object containing state objects\n */\nexport const initConnectionButtons = ({ connectionsState, measurementsState }: InitConnectionButtonsParams): void => {\n    /**\n     * Update button text based on connection status\n     */\n    const updateButtonText = (\n        key: SensorType,\n        status: 'connected' | 'disconnected' | 'reconnecting',\n        deviceName?: string\n    ): void => {\n        const connectElem = elements[key]?.connect;\n        if (!connectElem) return;\n\n        const label = getSensorLabel(key);\n        const emoji = emojis[key];\n\n        switch (status) {\n            case 'connected':\n                if (deviceName) {\n                    connectElem.textContent = `${emoji} Disconnect ${label} (${deviceName})`;\n                } else {\n                    connectElem.textContent = `${emoji} Disconnect ${label}`;\n                }\n                break;\n            case 'reconnecting':\n                connectElem.textContent = `${emoji} Reconnecting ${label}...`;\n                break;\n            case 'disconnected':\n                connectElem.textContent = `${emoji} Connect ${label}`;\n                break;\n        }\n    };\n\n    /**\n     * Disconnect from a sensor\n     */\n    const disconnectFn = (key: SensorType): void => {\n        const connectionState = connectionsState[key];\n        if (!connectionState) return;\n\n        if (typeof connectionState.disconnect === 'function') {\n            connectionState.disconnect();\n            connectionState.disconnect = null;\n            connectionState.isConnected = false;\n\n            updateButtonText(key, 'disconnected');\n\n            const displayElem = elements[key]?.display;\n            if (displayElem) {\n                displayElem.textContent = '--';\n            }\n        }\n    };\n\n    /**\n     * Handle connection status changes from auto-reconnect\n     */\n    const handleStatusChange =\n        (key: SensorType, deviceName: string) =>\n        (status: ConnectionStatus): void => {\n            const label = getSensorLabel(key);\n\n            switch (status) {\n                case 'connected':\n                    updateButtonText(key, 'connected', deviceName);\n                    showNotification(`${label} sensor reconnected`, 'success');\n                    break;\n                case 'reconnecting':\n                    updateButtonText(key, 'reconnecting');\n                    break;\n                case 'failed':\n                    if (connectionsState[key]) {\n                        connectionsState[key]!.isConnected = false;\n                        connectionsState[key]!.disconnect = null;\n                    }\n                    updateButtonText(key, 'disconnected');\n                    // Show reconnection failed dialog with retry option\n                    showReconnectionFailed(key, () => connectFn(key));\n                    break;\n                case 'disconnected':\n                    // Initial disconnect event, wait for reconnect attempt\n                    break;\n            }\n        };\n\n    /**\n     * Connect to a sensor\n     */\n    const connectFn = async (key: SensorType): Promise<void> => {\n        try {\n            updateButtonText(key, 'reconnecting'); // Show loading state\n\n            let connection: SensorConnection | TreadmillConnection | GpsConnection;\n\n            if (key === 'gps') {\n                // GPS has a different interface - uses listener callback instead of addListener\n                const gpsConnection = await connectGps((point) => {\n                    measurementsState.addGps(point);\n                });\n\n                // Adapt GpsConnection to match expected interface\n                const state = connectionsState[key];\n                if (state) {\n                    state.disconnect = async () => {\n                        await gpsConnection.stop();\n                    };\n                    state.isConnected = true;\n                }\n\n                // Update UI\n                updateButtonText(key, 'connected', gpsConnection.deviceName);\n                showNotification(`Connected to ${getSensorLabel(key)}`, 'success');\n                return; // GPS doesn't have onStatusChange, early return\n            } else if (key === 'treadmill') {\n                connection = await connectTreadmill();\n                connection.addListener((entry: TreadmillMeasurement) => {\n                    measurementsState.addTreadmillData(entry);\n                });\n            } else if (key === 'power') {\n                connection = await connectPower();\n                connection.addListener((entry: Measurement) => {\n                    measurementsState.addPower(entry);\n                });\n            } else if (key === 'heartrate') {\n                connection = await connectHeartRate();\n                connection.addListener((entry: Measurement) => {\n                    measurementsState.addHeartrate(entry);\n                });\n            } else if (key === 'cadence') {\n                connection = await connectCadence();\n                connection.addListener((entry: Measurement) => {\n                    measurementsState.addCadence(entry);\n                });\n            } else {\n                return; // Unsupported type for connection\n            }\n\n            const { disconnect, deviceName, onStatusChange } = connection;\n\n            // Update state\n            const state = connectionsState[key];\n            if (state) {\n                state.disconnect = disconnect;\n                state.isConnected = true;\n            }\n\n            // Update UI\n            updateButtonText(key, 'connected', deviceName);\n            showNotification(`Connected to ${getSensorLabel(key)}`, 'success');\n\n            // Subscribe to status changes for auto-reconnect feedback\n            if (onStatusChange) {\n                onStatusChange(handleStatusChange(key, deviceName || 'Sensor'));\n            }\n        } catch (error) {\n            updateButtonText(key, 'disconnected');\n\n            // Check if user wants to retry\n            const shouldRetry = await showConnectionError(error, key, () => connectFn(key));\n            if (!shouldRetry) {\n                // Reset state just in case\n                if (connectionsState[key]) {\n                    connectionsState[key]!.isConnected = false;\n                }\n            }\n        }\n    };\n\n    /**\n     * Add click listener to a button\n     */\n    const addListener = (key: SensorType): void => {\n        const connectElem = elements[key]?.connect;\n        if (!connectElem) return;\n\n        const handler = (e: Event) => {\n            // Prevent propagation\n            e.stopPropagation();\n\n            const isConnected = connectionsState[key]?.isConnected;\n            if (isConnected) {\n                disconnectFn(key);\n            } else {\n                connectFn(key);\n            }\n        };\n\n        // Add click listener\n        connectElem.addEventListener('click', handler);\n    };\n\n    // Initialize all supported buttons\n    const supportedTypes: SensorType[] = ['power', 'heartrate', 'cadence', 'gps', 'treadmill'];\n    supportedTypes.forEach(addListener);\n};\n","/**\n * Stream Manager\n * Handles streaming workout data to the backend service.\n * Used for live sharing of workout metrics.\n *\n * @module StreamManager\n */\n\nimport { createStream, sendWorkoutData, type CreateStreamResponse } from './api/streamClient.js';\nimport type { MeasurementsState } from './measurements-state.js';\nimport type { TimeState } from './getInitState.js';\nimport type { MeasurementType } from './types/measurements.js';\n\nexport interface StreamStatus {\n    isStreaming: boolean;\n    isPaused: boolean;\n    streamName: string | null;\n}\n\nexport class StreamManager {\n    // Made public readonly to support access from UI checks (temporary fix for existing code)\n    // In a future refactor, prefer getStatus()\n    public isStreaming = false;\n    private isPaused = false;\n    private streamName: string | null = null;\n    private streamInterval: ReturnType<typeof setInterval> | null = null;\n    private measurementsState: MeasurementsState;\n    private timeState: TimeState;\n\n    constructor(measurementsState: MeasurementsState, timeState: TimeState) {\n        this.measurementsState = measurementsState;\n        this.timeState = timeState;\n    }\n\n    /**\n     * Start streaming workout data\n     * @param streamName - Optional custom stream name\n     * @returns Promise resolving to the stream name\n     */\n    async startStreaming(name?: string): Promise<string> {\n        if (this.isStreaming) {\n            return this.streamName!;\n        }\n\n        try {\n            const safeName = name || `workout-${Date.now()}`;\n            const response: CreateStreamResponse = await createStream(safeName);\n\n            if (!response.success) {\n                throw new Error('Failed to create stream');\n            }\n\n            this.streamName = response.streamName;\n            this.isStreaming = true;\n            this.isPaused = false;\n\n            this._startStreamingLoop();\n\n            return this.streamName;\n        } catch (error) {\n            console.error('Failed to start streaming:', error);\n            this.streamName = null;\n            throw error;\n        }\n    }\n\n    /**\n     * Pause the stream (stop sending data but keep stream alive)\n     */\n    pauseStreaming(): void {\n        if (this.isStreaming) {\n            this.isPaused = true;\n        }\n    }\n\n    /**\n     * Resume the stream\n     */\n    resumeStreaming(): void {\n        if (this.isStreaming) {\n            this.isPaused = false;\n        }\n    }\n\n    /**\n     * Stop streaming workout data\n     */\n    async stopStreaming(): Promise<void> {\n        if (!this.isStreaming) {\n            return;\n        }\n\n        this.isStreaming = false;\n        this.isPaused = false;\n\n        if (this.streamInterval) {\n            clearInterval(this.streamInterval);\n            this.streamInterval = null;\n        }\n\n        // We don't delete the stream here so that data persists for a while (handled by server cleanup)\n        this.streamName = null;\n    }\n\n    /**\n     * Get current streaming status\n     */\n    getStatus(): StreamStatus {\n        return {\n            isStreaming: this.isStreaming,\n            isPaused: this.isPaused,\n            streamName: this.streamName,\n        };\n    }\n\n    /**\n     * Start the streaming loop\n     * @private\n     */\n    private _startStreamingLoop(): void {\n        // Send data every 1 second\n        this.streamInterval = setInterval(async () => {\n            if (!this.isStreaming || this.isPaused || !this.timeState.running) {\n                return;\n            }\n\n            try {\n                await this._sendCurrentData();\n            } catch (error) {\n                console.error('Error sending workout data:', error);\n            }\n        }, 1000);\n    }\n\n    /**\n     * Send current workout data\n     * @private\n     */\n    private async _sendCurrentData(): Promise<void> {\n        if (!this.streamName) return;\n\n        const power = this._getLatestValue('power');\n        const cadence = this._getLatestValue('cadence');\n        const heartrate = this._getLatestValue('heartrate');\n        const speed = this._getLatestValue('speed');\n        const distance = this._getLatestValue('distance');\n        const altitude = this._getLatestValue('altitude');\n        const incline = this._getLatestTreadmillIncline();\n\n        // Only send if we have at least one measurement\n        if (\n            power === null &&\n            cadence === null &&\n            heartrate === null &&\n            speed === null &&\n            distance === null &&\n            altitude === null &&\n            incline === null\n        ) {\n            return;\n        }\n\n        const elapsedMs =\n            this.timeState.running && this.timeState.startTime\n                ? Date.now() - this.timeState.startTime\n                : this.timeState.endTime && this.timeState.startTime\n                  ? this.timeState.endTime - this.timeState.startTime\n                  : 0;\n\n        await sendWorkoutData(this.streamName, {\n            timestamp: Date.now(),\n            elapsed: Math.floor(elapsedMs / 1000).toString(),\n            power,\n            cadence,\n            heartrate,\n            speed,\n            distance,\n            altitude,\n            incline,\n        });\n    }\n\n    /**\n     * Get latest value for a measurement type\n     * @private\n     */\n    private _getLatestValue(type: Exclude<MeasurementType, 'gps'>): number | null {\n        // @ts-ignore - dynamic access\n        const array = this.measurementsState[type];\n        if (!Array.isArray(array) || array.length === 0) {\n            return null;\n        }\n\n        // Only send data newer than 5 seconds\n        const latest = array[array.length - 1];\n        if (Date.now() - latest.timestamp > 5000) {\n            return null;\n        }\n\n        return latest.value;\n    }\n\n    /**\n     * Get latest treadmill incline value\n     * @private\n     */\n    private _getLatestTreadmillIncline(): number | null {\n        const array = this.measurementsState.treadmill;\n        if (!Array.isArray(array) || array.length === 0) {\n            return null;\n        }\n\n        // Only send data newer than 5 seconds\n        const latest = array[array.length - 1];\n        if (Date.now() - latest.timestamp > 5000) {\n            return null;\n        }\n\n        return latest.incline;\n    }\n}\n","import { initConnectionButtons } from '../initConnectionButtons.js';\nimport { StreamManager } from '../stream-manager.js';\nimport type { MeasurementsState } from '../measurements-state.js';\nimport type { TimeState, ConnectionsState } from '../getInitState.js';\n\ninterface HardwareInitParams {\n    measurementsState: MeasurementsState;\n    connectionsState: ConnectionsState;\n    timeState: TimeState;\n}\n\nexport function initHardware({ measurementsState, connectionsState, timeState }: HardwareInitParams) {\n    // Initialize Bluetooth connection buttons\n    initConnectionButtons({ connectionsState, measurementsState });\n\n    // Stream manager for live workout streaming\n    const streamManager = new StreamManager(measurementsState, timeState);\n\n    return { streamManager };\n}\n","/**\n * BPT Client - Main Entry Point\n *\n * Progressive Web App for tracking cycling workouts with Bluetooth sensors.\n *\n * This module initializes all application features:\n * - Bluetooth sensor connections (power, cadence, heart rate)\n * - Real-time metrics display\n * - Workout timer\n * - Data export (JSON, TCX, CSV)\n * - Live streaming\n * - PWA features (service worker, install prompt)\n *\n * @module main\n *\n * @description\n * The app uses a state-based architecture with three main state objects:\n * - measurementsState: Tracks workout data (power, cadence, HR measurements)\n * - connectionsState: Tracks Bluetooth connection status\n * - timeState: Tracks recording state and elapsed time\n *\n * @example\n * // State is initialized automatically on app load\n * // Access exposed state in tests:\n * window.measurementsState\n * window.connectionsState\n */\n\nimport './styles/main.css';\n\n// Register Web Components using lazy loader\nimport { registerLazyComponent } from './components/lazyLoader.js';\n\n// Base Components\nregisterLazyComponent('bpt-metric-display', () => import('./components/MetricDisplay.js'));\nregisterLazyComponent('bpt-power-gauge', () => import('./components/PowerGauge.js'));\nregisterLazyComponent('bpt-zone-gauge', () => import('./components/ZoneGauge.js'));\nregisterLazyComponent('bpt-live-chart', () => import('./components/LiveChart.js'));\nregisterLazyComponent('bpt-workout-timer', () => import('./components/WorkoutTimer.js'));\nregisterLazyComponent('bpt-toast', () => import('./components/Toast.js'));\nregisterLazyComponent('bpt-modal', () => import('./components/Modal.js'));\n\n// Data Fields Components\nregisterLazyComponent('bpt-data-field', () => import('./components/data-fields/DataFieldComponent.js'));\nregisterLazyComponent('bpt-data-screen', () => import('./components/data-fields/DataScreenComponent.js'));\nregisterLazyComponent('bpt-screen-carousel', () => import('./components/data-fields/ScreenCarouselComponent.js'));\nregisterLazyComponent('bpt-field-picker', () => import('./components/data-fields/FieldPickerComponent.js'));\nregisterLazyComponent('bpt-screen-editor', () => import('./components/data-fields/ScreenEditorComponent.js'));\nregisterLazyComponent('bpt-profile-settings', () => import('./components/data-fields/ProfileSettingsComponent.js'));\n\nimport './monitoring/performance.js';\nimport { initializeState } from './state/StateProvider.js';\nimport { exposeVariablesDuringTest } from './exposeVariablesDuringTest.js';\nimport { setupRouter } from './init/router.js';\nimport { initUi } from './init/ui.js';\nimport { initHardware } from './init/hardware.js';\nimport './ui/navbar.css';\nimport './ui/map.css';\n\nconst initApp = (): void => {\n    try {\n        // Performance monitoring initialized via import\n\n        /**\n         * Initialize application state\n         */\n        const appState = initializeState();\n        const { measurementsState, connectionsState, timeState } = appState;\n\n        // Expose state for E2E testing\n        exposeVariablesDuringTest({ measurementsState, connectionsState });\n\n        // Initialize Hardware (Sensors & Streaming)\n        const { streamManager } = initHardware({ measurementsState, connectionsState, timeState });\n\n        // Initialize UI\n        initUi({ measurementsState, timeState, connectionsState, streamManager });\n\n        // Initialize Navigation Logic\n        const router = setupRouter();\n        router.start();\n\n        // Expose router to window for global access (navigation)\n        // Using explicit type compatible with window expansion\n        (window as unknown as { router: typeof router }).router = router;\n    } catch (error: unknown) {\n        console.error('Failed to initialize app:', error);\n    }\n};\n\n// Initialize app when DOM is ready\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initApp, { once: true });\n} else {\n    initApp();\n}\n\nconsole.log('Bike Power Tracker initialized');\n"],"file":"index-N21XmhYf.js"}