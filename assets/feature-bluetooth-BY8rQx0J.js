const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CmfhMaTA.js","assets/vendor-core-Dob3nYDb.js","assets/feature-export-7zlEGvkQ.js","assets/vendor-leaflet-3-yx3GaH.js","assets/index-BmzgHFUM.css","assets/achievementNotification-DFJ1pZGR.js","assets/fitnessService-psg4lgYY.js","assets/web-i4aVcvOV.js"])))=>i.map(i=>d[i]);
import{o as Ie}from"./vendor-core-Dob3nYDb.js";const Xe="modulepreload",et=function(n){return"/"+n},ve={},V=function(t,e,s){let r=Promise.resolve();if(e&&e.length>0){let d=function(f){return Promise.all(f.map(m=>Promise.resolve(m).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),l=i?.nonce||i?.getAttribute("nonce");r=d(e.map(f=>{if(f=et(f),f in ve)return;ve[f]=!0;const m=f.endsWith(".css"),c=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${c}`))return;const o=document.createElement("link");if(o.rel=m?"stylesheet":Xe,m||(o.as="script"),o.crossOrigin="",o.href=f,l&&o.setAttribute("nonce",l),document.head.appendChild(o),m)return new Promise((u,h)=>{o.addEventListener("load",u),o.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${f}`)))})}))}function a(i){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=i,window.dispatchEvent(l),!l.defaultPrevented)throw i}return r.then(i=>{for(const l of i||[])l.status==="rejected"&&a(l.reason);return t().catch(a)})};class tt{db=null;initialized=!1;async initialize(){if(!this.initialized)try{this.db=await Ie("bpt-ftp-history",1,{upgrade(t){t.objectStoreNames.contains("history")||t.createObjectStore("history",{keyPath:"date"}).createIndex("date","date")}}),this.initialized=!0}catch(t){console.error("Failed to initialize FTP history DB",t)}}async addEntry(t){if(this.db||await this.initialize(),!!this.db)try{await this.db.put("history",t)}catch(e){console.error("Failed to add FTP history entry",e)}}async getHistory(){if(this.db||await this.initialize(),!this.db)return[];try{return(await this.db.getAllFromIndex("history","date")).sort((e,s)=>s.date-e.date)}catch(t){return console.error("Failed to get FTP history",t),[]}}async getLatestEntry(){if(this.db||await this.initialize(),!!this.db)try{return(await this.db.transaction("history").store.index("date").openCursor(null,"prev"))?.value}catch{return}}}const oe=new tt,ie={weight:75,height:175,age:30,gender:"other",ftp:200,maxHeartrate:190,restingHeartrate:60,units:"metric",dateFormat:"ISO",clockFormat:"24h",energyMethod:"combined",gapThreshold:20,stalenessThreshold:5,powerZoneModel:"7",powerZones:[{name:"Recovery",min:0,max:55,color:"#808080"},{name:"Endurance",min:55,max:75,color:"#2196f3"},{name:"Tempo",min:75,max:90,color:"#4caf50"},{name:"Threshold",min:90,max:105,color:"#ffeb3b"},{name:"VO2max",min:105,max:120,color:"#ff9800"},{name:"Anaerobic",min:120,max:150,color:"#f44336"},{name:"Neuromuscular",min:150,max:1e3,color:"#9c27b0"}],heartrateZones:[{name:"Recovery",min:0,max:60,color:"#808080"},{name:"Endurance",min:60,max:70,color:"#2196f3"},{name:"Tempo",min:70,max:80,color:"#4caf50"},{name:"Threshold",min:80,max:90,color:"#ff9800"},{name:"VO2max",min:90,max:100,color:"#f44336"}]};class nt{settings={...ie};listeners=[];db=null;initialized=!1;async initialize(){if(!this.initialized){try{this.db=await Ie("bpt-settings",1,{upgrade(e){e.createObjectStore("settings")}});const t=await this.db.get("settings","user");if(t)this.settings={...ie,...t};else try{const e=localStorage.getItem("bpt-user-profile");if(e){const s=JSON.parse(e);s.ftp&&(this.settings.ftp=Number(s.ftp)),s.maxHr&&(this.settings.maxHeartrate=Number(s.maxHr)),s.weight&&(this.settings.weight=Number(s.weight))}}catch(e){console.warn("Failed to migrate legacy settings:",e)}}catch(t){console.warn("Settings storage unavailable, using defaults/in-memory:",t)}this.initialized=!0,this.notifyListeners()}}get(t){return this.settings[t]}getAll(){return{...this.settings}}async set(t,e){t==="ftp"&&e!==this.settings.ftp&&oe.addEntry({date:Date.now(),ftp:e,source:"manual"}),this.settings[t]=e,await this.persist(),this.notifyListeners()}async setMultiple(t){t.ftp&&t.ftp!==this.settings.ftp&&oe.addEntry({date:Date.now(),ftp:t.ftp,source:"manual"}),this.settings={...this.settings,...t},await this.persist(),this.notifyListeners()}async updateFtp(t,e="manual"){t!==this.settings.ftp&&(await this.set("ftp",t),oe.addEntry({date:Date.now(),ftp:t,source:e}))}async reset(){this.settings={...ie},await this.persist(),this.notifyListeners()}onChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e!==-1&&this.listeners.splice(e,1)}}async persist(){if(this.db)try{await this.db.put("settings",this.settings,"user")}catch(t){console.error("Failed to save settings:",t)}}notifyListeners(){const t=this.getAll();for(const e of this.listeners)try{e(t)}catch(s){console.error("Settings listener error:",s)}}}const st=new nt;function at(n){if(!n||n.length<30)return null;const t=30;let e=0;for(let i=0;i<t;i++)e+=n[i];let s=0,r=0;for(let i=t-1;i<n.length;i++){i>=t&&(e=e-n[i-t]+n[i]);const l=e/t;s+=Math.pow(l,4),r++}if(r===0)return null;const a=s/r;return Math.round(Math.pow(a,.25))}function rt(n,t){return!t||t===0?0:Number((n/t).toFixed(2))}function ot(n,t){return!t||t===0?1:Number((n/t).toFixed(2))}function it(n){const t=n.reduce((e,s)=>e+s,0);return Math.round(t/1e3)}function ct(n,t){return!t||t===0?0:Number((n/t).toFixed(2))}function lt(n,t,e,s){if(!s||s===0)return 0;const r=n*t*e/(s*3600)*100;return Math.round(r)}function on(n,t,e){const a=n+(e-n)/42,i=t+(e-t)/7,l=a-i;return{ctl:a,atl:i,tsb:l}}class ut{static calculateLaps(t){if(!t.laps||t.laps.length===0)return[];const e=[],s=[...t.power].sort((c,o)=>c.timestamp-o.timestamp),r=[...t.heartrate].sort((c,o)=>c.timestamp-o.timestamp),a=[...t.cadence].sort((c,o)=>c.timestamp-o.timestamp),i=[...t.speed].sort((c,o)=>c.timestamp-o.timestamp),l=[...t.distance].sort((c,o)=>c.timestamp-o.timestamp),d=Math.min(s[0]?.timestamp||1/0,r[0]?.timestamp||1/0,a[0]?.timestamp||1/0);if(d===1/0)return[];let f=d;t.laps.forEach(c=>{const o=c.timestamp,u=s.filter(E=>E.timestamp>=f&&E.timestamp<=o),h=r.filter(E=>E.timestamp>=f&&E.timestamp<=o),w=a.filter(E=>E.timestamp>=f&&E.timestamp<=o),g=i.filter(E=>E.timestamp>=f&&E.timestamp<=o),p=l.filter(E=>E.timestamp<f),v=l.filter(E=>E.timestamp>=f&&E.timestamp<=o);let S=0;if(v.length>0){const E=p.length>0?p[p.length-1].value:0;S=v[v.length-1].value-E}e.push({number:c.number,startTime:f,endTime:o,duration:o-f,avgPower:this.average(u),maxPower:this.max(u),avgHeartRate:this.average(h),maxHeartRate:this.max(h),avgCadence:this.average(w),avgSpeed:this.average(g),distance:S}),f=o});const m=Math.max(s[s.length-1]?.timestamp||0,r[r.length-1]?.timestamp||0);if(m>f+1e3){const c=s.filter(v=>v.timestamp>=f),o=r.filter(v=>v.timestamp>=f),u=a.filter(v=>v.timestamp>=f),h=i.filter(v=>v.timestamp>=f),w=l.filter(v=>v.timestamp<f),g=l.filter(v=>v.timestamp>=f);let p=0;if(g.length>0){const v=w.length>0?w[w.length-1].value:0;p=g[g.length-1].value-v}e.push({number:e.length+1,startTime:f,endTime:m,duration:m-f,avgPower:this.average(c),maxPower:this.max(c),avgHeartRate:this.average(o),maxHeartRate:this.max(o),avgCadence:this.average(u),avgSpeed:this.average(h),distance:p})}return e}static average(t){if(t.length===0)return 0;const e=t.reduce((s,r)=>s+r.value,0);return Math.round(e/t.length)}static max(t){return t.length===0?0:Math.max(...t.map(e=>e.value))}}function dt(n,t,e,s,r){const a=b=>Array.isArray(b.laps);let i=[];a(e)?i=ut.calculateLaps(e):i=[];const l=b=>{if(b.length===0)return{avg:null,max:null,count:0};const y=b.map(C=>C.value),R=y.reduce((C,k)=>C+k,0);return{avg:Math.round(R/y.length),max:Math.max(...y),count:y.length}},d=l(e.power),f=l(e.heartrate),m=l(e.cadence),c=e.power.map(b=>b.value),o=[],u=[1,5,10,30,60,300,1200,3600],h=b=>{if(c.length<b)return 0;let y=0;for(let C=0;C<b;C++)y+=c[C];let R=y/b;for(let C=b;C<c.length;C++)y=y-c[C-b]+c[C],y/b>R&&(R=y/b);return Math.round(R)};for(const b of u)c.length>=b&&o.push({duration:b,watts:h(b)});let w=0,g=0,p=0,v=0,S=0;c.length>0&&(S=it(c));let E=200,P=r;s&&s.getFtp()&&(E=s.getFtp());try{if(typeof localStorage<"u"){const b=localStorage.getItem("bpt-user-profile");if(b){const y=JSON.parse(b);!s?.getFtp()&&y.ftp&&(E=y.ftp),!P&&y.weight&&(P=y.weight)}}}catch(b){console.warn("Error reading profile",b)}if(c.length>0){const b=at(c);if(b){p=b,g=rt(b,E);const y=(t-n)/1e3;w=lt(y,b,g,E),d.avg&&(v=ot(b,d.avg))}}const A={duration:t-n,startTime:n,endTime:t,power:{...d,wattsPerKg:P&&P>0&&d.avg?ct(d.avg,P):void 0},heartrate:f,cadence:m,powerCurve:o.length>0?o:void 0,trainingLoad:w>0?Math.round(w):void 0,intensityFactor:g>0?parseFloat(g.toFixed(2)):void 0,normalizedPower:p>0?p:void 0,variabilityIndex:v>0?v:void 0,work:S>0?S:void 0,laps:i};if(s){const b=s.getPowerZoneDistribution(),y=s.getHrZoneDistribution();b.totalTimeMs>0&&(A.powerZoneDistribution=b),y.totalTimeMs>0&&(A.hrZoneDistribution=y)}return A}const ft="BikeTrackerDB",ht=5,B="activeWorkout",$="completedWorkouts",F="rawDebugData",H="pmcStats";let Z=null;async function U(){return Z||new Promise((n,t)=>{const e=indexedDB.open(ft,ht);e.onerror=()=>{console.error("Failed to open IndexedDB:",e.error),t(e.error)},e.onsuccess=()=>{Z=e.result,n(Z)},e.onupgradeneeded=s=>{const r=s.target.result;if(r.objectStoreNames.contains(B)||r.createObjectStore(B,{keyPath:"id"}),r.objectStoreNames.contains($)||r.createObjectStore($,{keyPath:"id"}).createIndex("startTime","startTime",{unique:!1}),!r.objectStoreNames.contains(F)){const a=r.createObjectStore(F,{keyPath:"id",autoIncrement:!0});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("sensor","sensor",{unique:!1})}r.objectStoreNames.contains(H)||r.createObjectStore(H,{keyPath:"date"})}})}async function gt(){const n=await U();return new Promise((t,e)=>{const a=n.transaction([H],"readonly").objectStore(H).getAll();a.onsuccess=()=>t(a.result||[]),a.onerror=()=>e(a.error)})}async function wt(){const n=await U();return new Promise((t,e)=>{const a=n.transaction([H],"readwrite").objectStore(H).clear();a.onsuccess=()=>t(),a.onerror=()=>e(a.error)})}async function mt(n){const t=await U();return new Promise((e,s)=>{const r=t.transaction([H],"readwrite"),a=r.objectStore(H);let i=0,l=0;if(n.length===0){e();return}n.forEach(d=>{const f=a.put(d);f.onsuccess=()=>{i++,i+l===n.length&&(l>0?s(new Error("Some entries failed to save")):e())},f.onerror=()=>{l++,i+l===n.length&&s(new Error("Entries failed to save"))}}),r.oncomplete=()=>{e()},r.onerror=()=>s(r.error)})}async function Ue(n,t){try{const e=await U(),s={timestamp:Date.now(),sensor:n,data:t};return new Promise((r,a)=>{const d=e.transaction([F],"readwrite").objectStore(F).add(s);d.onsuccess=()=>r(),d.onerror=()=>a(d.error)})}catch(e){console.warn("Could not save debug log:",e)}}async function he(){try{const n=await U();return new Promise((t,e)=>{const i=n.transaction([F],"readonly").objectStore(F).index("timestamp").getAll();i.onsuccess=()=>t(i.result||[]),i.onerror=()=>e(i.error)})}catch(n){return console.warn("Could not load debug logs:",n),[]}}async function Me(){try{const n=await U();return new Promise((t,e)=>{const a=n.transaction([F],"readwrite").objectStore(F).clear();a.onsuccess=()=>t(),a.onerror=()=>e(a.error)})}catch(n){console.warn("Could not clear debug logs:",n)}}async function ge(n,t){try{const e=await U(),s={id:"current",startTime:t??Date.now(),lastUpdated:Date.now(),heartrate:n.heartrate,power:n.power,cadence:n.cadence,speed:n.speed,distance:n.distance,altitude:n.altitude,gps:n.gps,treadmill:n.treadmill||[],laps:n.laps||[]};return new Promise((r,a)=>{const d=e.transaction([B],"readwrite").objectStore(B).put(s);d.onsuccess=()=>r(),d.onerror=()=>a(d.error)})}catch(e){console.warn("Could not save active workout:",e)}}async function Oe(){try{const n=await U();return new Promise((t,e)=>{const a=n.transaction([B],"readwrite").objectStore(B).delete("current");a.onsuccess=()=>t(),a.onerror=()=>e(a.error)})}catch(n){console.warn("Could not clear active workout:",n)}}async function we(){try{const n=await U();return new Promise((t,e)=>{const a=n.transaction([B],"readonly").objectStore(B).get("current");a.onsuccess=()=>{if(a.result){const i=a.result;i.treadmill||(i.treadmill=[]),i.laps||(i.laps=[]),t(i)}else t(null)},a.onerror=()=>e(a.error)})}catch(n){return console.warn("Could not load active workout:",n),null}}async function xe(){if(navigator.storage&&navigator.storage.estimate)try{const n=await navigator.storage.estimate();if(n.quota&&n.usage){const t=n.usage/n.quota*100;t>80&&alert(`⚠️ Storage Warning: You have used ${t.toFixed(1)}% of available storage. Please export and delete old workouts.`)}}catch(n){console.warn("Storage estimate failed",n)}}async function qe(n,t,e,s){await xe();const r=`workout_${t}`;try{const a=await U(),i={id:r,startTime:t,lastUpdated:e,isCompleted:!0,measurements:JSON.parse(JSON.stringify(n)),synced:!1,summary:s?JSON.parse(JSON.stringify(s)):void 0};return new Promise((l,d)=>{const c=a.transaction([$],"readwrite").objectStore($).put(i);c.onsuccess=()=>{l(r),vt(t).catch(o=>{console.warn("Failed to update streak/achievements:",o)})},c.onerror=()=>d(c.error)})}catch(a){throw console.error("Failed to save completed workout:",a),a}}async function vt(n){try{const{goalsStore:t}=await V(async()=>{const{goalsStore:s}=await import("./index-CmfhMaTA.js").then(r=>r.K);return{goalsStore:s}},__vite__mapDeps([0,1,2,3,4])),{checkAndNotifyAchievements:e}=await V(async()=>{const{checkAndNotifyAchievements:s}=await import("./achievementNotification-DFJ1pZGR.js");return{checkAndNotifyAchievements:s}},__vite__mapDeps([5,0,1,2,3,4]));await t.updateStreak(n),await e()}catch(t){console.error("Error in updateStreakAndAchievements:",t)}}async function $e(){try{const n=await U();return new Promise((t,e)=>{const i=n.transaction([$],"readonly").objectStore($).index("startTime").getAll();i.onsuccess=()=>{t((i.result||[]).reverse())},i.onerror=()=>e(i.error)})}catch(n){return console.warn("Could not load workout history:",n),[]}}let G=null,j=null;const pt=(n,t,e)=>{j={measurements:n,startTime:t},G||(G=setTimeout(async()=>{j&&(await ge(j.measurements,j.startTime),j=null),G=null},2e3))},je=async()=>{G&&(clearTimeout(G),G=null),j&&(await ge(j.measurements,j.startTime),j=null)},yt=()=>typeof window<"u"&&"indexedDB"in window,bt=async()=>{await je();const n=await we();if(!n)return null;const t=r=>(r||[]).map(a=>typeof a=="number"?{value:a}:{value:a.value});let e;const s=st.getAll();if(e=dt(n.startTime,n.lastUpdated,{power:t(n.power),heartrate:t(n.heartrate),cadence:t(n.cadence)},void 0,s.weight),await qe({heartrate:n.heartrate,power:n.power,cadence:n.cadence,speed:n.speed,distance:n.distance,altitude:n.altitude,gps:n.gps,treadmill:n.treadmill,laps:n.laps},n.startTime,n.lastUpdated,e),e.trainingLoad>0)try{const{addWorkoutToPMC:r}=await V(async()=>{const{addWorkoutToPMC:a}=await import("./fitnessService-psg4lgYY.js");return{addWorkoutToPMC:a}},__vite__mapDeps([6,1]));await r(new Date(n.startTime),e.trainingLoad)}catch(r){console.error("Failed to update PMC:",r)}return await Oe(),`workout_${n.startTime}`},Et=async()=>!!await we(),St=$e;async function Lt(n){try{const t=await U();return new Promise((e,s)=>{const i=t.transaction([$],"readonly").objectStore($).get(n);i.onsuccess=()=>e(i.result),i.onerror=()=>s(i.error)})}catch(t){console.warn("Could not load workout:",t);return}}async function Ct(n){try{const t=await U();return new Promise((e,s)=>{const i=t.transaction([$],"readwrite").objectStore($).delete(n);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}catch(t){throw console.warn("Could not delete workout:",t),t}}const cn=Object.freeze(Object.defineProperty({__proto__:null,archiveWorkout:bt,checkStorageQuota:xe,clearActiveWorkout:Oe,clearDebugLogs:Me,clearPMCData:wt,deleteCompletedWorkout:Ct,flushPendingSave:je,getCompletedWorkout:Lt,getCompletedWorkouts:St,getDebugLogs:he,getPMCData:gt,getWorkoutHistory:$e,hasRecoverableWorkout:Et,isIndexedDBSupported:yt,loadActiveWorkout:we,openDatabase:U,saveActiveWorkout:ge,saveCompletedWorkout:qe,saveDebugLog:Ue,savePMCData:mt,throttledSave:pt},Symbol.toStringTag,{value:"Module"}));var J;(function(n){n.Unimplemented="UNIMPLEMENTED",n.Unavailable="UNAVAILABLE"})(J||(J={}));class ce extends Error{constructor(t,e,s){super(t),this.message=t,this.code=e,this.data=s}}const Pt=n=>{var t,e;return n?.androidBridge?"android":!((e=(t=n?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||e===void 0)&&e.bridge?"ios":"web"},Dt=n=>{const t=n.CapacitorCustomPlatform||null,e=n.Capacitor||{},s=e.Plugins=e.Plugins||{},r=()=>t!==null?t.name:Pt(n),a=()=>r()!=="web",i=c=>{const o=f.get(c);return!!(o?.platforms.has(r())||l(c))},l=c=>{var o;return(o=e.PluginHeaders)===null||o===void 0?void 0:o.find(u=>u.name===c)},d=c=>n.console.error(c),f=new Map,m=(c,o={})=>{const u=f.get(c);if(u)return console.warn(`Capacitor plugin "${c}" already registered. Cannot register plugins twice.`),u.proxy;const h=r(),w=l(c);let g;const p=async()=>(!g&&h in o?g=typeof o[h]=="function"?g=await o[h]():g=o[h]:t!==null&&!g&&"web"in o&&(g=typeof o.web=="function"?g=await o.web():g=o.web),g),v=(y,R)=>{var C,k;if(w){const O=w?.methods.find(M=>R===M.name);if(O)return O.rtype==="promise"?M=>e.nativePromise(c,R.toString(),M):(M,Y)=>e.nativeCallback(c,R.toString(),M,Y);if(y)return(C=y[R])===null||C===void 0?void 0:C.bind(y)}else{if(y)return(k=y[R])===null||k===void 0?void 0:k.bind(y);throw new ce(`"${c}" plugin is not implemented on ${h}`,J.Unimplemented)}},S=y=>{let R;const C=(...k)=>{const O=p().then(M=>{const Y=v(M,y);if(Y){const z=Y(...k);return R=z?.remove,z}else throw new ce(`"${c}.${y}()" is not implemented on ${h}`,J.Unimplemented)});return y==="addListener"&&(O.remove=async()=>R()),O};return C.toString=()=>`${y.toString()}() { [capacitor code] }`,Object.defineProperty(C,"name",{value:y,writable:!1,configurable:!1}),C},E=S("addListener"),P=S("removeListener"),A=(y,R)=>{const C=E({eventName:y},R),k=async()=>{const M=await C;P({eventName:y,callbackId:M},R)},O=new Promise(M=>C.then(()=>M({remove:k})));return O.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await k()},O},b=new Proxy({},{get(y,R){switch(R){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return w?A:E;case"removeListener":return P;default:return S(R)}}});return s[c]=b,f.set(c,{name:c,proxy:b,platforms:new Set([...Object.keys(o),...w?[h]:[]])}),b};return e.convertFileSrc||(e.convertFileSrc=c=>c),e.getPlatform=r,e.handleError=d,e.isNativePlatform=a,e.isPluginAvailable=i,e.registerPlugin=m,e.Exception=ce,e.DEBUG=!!e.DEBUG,e.isLoggingEnabled=!!e.isLoggingEnabled,e},Rt=n=>n.Capacitor=Dt(n),T=Rt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),se=T.registerPlugin;class me{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,e){let s=!1;this.listeners[t]||(this.listeners[t]=[],s=!0),this.listeners[t].push(e);const a=this.windowListeners[t];a&&!a.registered&&this.addWindowListener(a),s&&this.sendRetainedArgumentsForEvent(t);const i=async()=>this.removeListener(t,e);return Promise.resolve({remove:i})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,e,s){const r=this.listeners[t];if(!r){if(s){let a=this.retainedEventArguments[t];a||(a=[]),a.push(e),this.retainedEventArguments[t]=a}return}r.forEach(a=>a(e))}hasListeners(t){var e;return!!(!((e=this.listeners[t])===null||e===void 0)&&e.length)}registerWindowListener(t,e){this.windowListeners[e]={registered:!1,windowEventName:t,pluginEventName:e,handler:s=>{this.notifyListeners(e,s)}}}unimplemented(t="not implemented"){return new T.Exception(t,J.Unimplemented)}unavailable(t="not available"){return new T.Exception(t,J.Unavailable)}async removeListener(t,e){const s=this.listeners[t];if(!s)return;const r=s.indexOf(e);this.listeners[t].splice(r,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const e=this.retainedEventArguments[t];e&&(delete this.retainedEventArguments[t],e.forEach(s=>{this.notifyListeners(t,s)}))}}const pe=n=>encodeURIComponent(n).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),ye=n=>n.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Tt extends me{async getCookies(){const t=document.cookie,e={};return t.split(";").forEach(s=>{if(s.length<=0)return;let[r,a]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");r=ye(r).trim(),a=ye(a).trim(),e[r]=a}),e}async setCookie(t){try{const e=pe(t.key),s=pe(t.value),r=`; expires=${(t.expires||"").replace("expires=","")}`,a=(t.path||"/").replace("path=",""),i=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${e}=${s||""}${r}; path=${a}; ${i};`}catch(e){return Promise.reject(e)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(e){return Promise.reject(e)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const e of t)document.cookie=e.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}se("CapacitorCookies",{web:()=>new Tt});const _t=async n=>new Promise((t,e)=>{const s=new FileReader;s.onload=()=>{const r=s.result;t(r.indexOf(",")>=0?r.split(",")[1]:r)},s.onerror=r=>e(r),s.readAsDataURL(n)}),Nt=(n={})=>{const t=Object.keys(n);return Object.keys(n).map(r=>r.toLocaleLowerCase()).reduce((r,a,i)=>(r[a]=n[t[i]],r),{})},At=(n,t=!0)=>n?Object.entries(n).reduce((s,r)=>{const[a,i]=r;let l,d;return Array.isArray(i)?(d="",i.forEach(f=>{l=t?encodeURIComponent(f):f,d+=`${a}=${l}&`}),d.slice(0,-1)):(l=t?encodeURIComponent(i):i,d=`${a}=${l}`),`${s}&${d}`},"").substr(1):null,kt=(n,t={})=>{const e=Object.assign({method:n.method||"GET",headers:n.headers},t),r=Nt(n.headers)["content-type"]||"";if(typeof n.data=="string")e.body=n.data;else if(r.includes("application/x-www-form-urlencoded")){const a=new URLSearchParams;for(const[i,l]of Object.entries(n.data||{}))a.set(i,l);e.body=a.toString()}else if(r.includes("multipart/form-data")||n.data instanceof FormData){const a=new FormData;if(n.data instanceof FormData)n.data.forEach((l,d)=>{a.append(d,l)});else for(const l of Object.keys(n.data))a.append(l,n.data[l]);e.body=a;const i=new Headers(e.headers);i.delete("content-type"),e.headers=i}else(r.includes("application/json")||typeof n.data=="object")&&(e.body=JSON.stringify(n.data));return e};class It extends me{async request(t){const e=kt(t,t.webFetchExtra),s=At(t.params,t.shouldEncodeUrlParams),r=s?`${t.url}?${s}`:t.url,a=await fetch(r,e),i=a.headers.get("content-type")||"";let{responseType:l="text"}=a.ok?t:{};i.includes("application/json")&&(l="json");let d,f;switch(l){case"arraybuffer":case"blob":f=await a.blob(),d=await _t(f);break;case"json":d=await a.json();break;default:d=await a.text()}const m={};return a.headers.forEach((c,o)=>{m[o]=c}),{data:d,headers:m,status:a.status,url:a.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}se("CapacitorHttp",{web:()=>new It});var be;(function(n){n.Dark="DARK",n.Light="LIGHT",n.Default="DEFAULT"})(be||(be={}));var Ee;(function(n){n.StatusBar="StatusBar",n.NavigationBar="NavigationBar"})(Ee||(Ee={}));class Ut extends me{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}}se("SystemBars",{web:()=>new Ut});const Be="bpt-settings",Fe={enabled:!1,source:"speed",threshold:3,delay:3},He={promptForNotes:!0,promptForExertion:!0},We={duration:0,enableBeep:!0,enableVoice:!1},Ve={enabled:!1,source:"distance",distanceKm:1,timeMinutes:5},Ge={power:!0,heartrate:!0,cadence:!1,speed:!0,distance:!0,time:!0,pace:!1},Je={timeIntervalMinutes:0,distanceIntervalKm:0,metrics:{...Ge},speechRate:1,voiceURI:null,workoutTargetFeedback:!1,announcementTemplate:null,smartAnnouncements:!1},Ke={enabled:!1,apiKey:"",athleteId:"i",autoUpload:!1},Ye={enabled:!1,volume:.6,style:"electronic",tempoSync:"cadence",fixedBPM:120,intensityMapping:"power",transitionSpeed:"smooth",duckingEnabled:!0,duckingLevel:.2},Se={sportType:"cycling",power:!0,cadence:!0,heartrate:!0,speed:!0,distance:!0,altitude:!0,treadmillSpeed:!1,power3s:!1,highContrast:!1,colorblindPatterns:!1,voiceEnabled:!1,voiceLaps:!0,voiceZones:!0,exportTcx:!0,exportCsv:!0,exportJson:!1,exportFit:!1,autoPause:{...Fe},workoutMetadata:{...He},countdown:{...We},autoLap:{...Ve},enhancedVoice:{...Je},intervals:{...Ke},music:{...Ye},weightKg:75,showCalories:!1,debugMode:!1,mockSensors:!1,wheelCircumferenceMm:2096};function ze(){const n=localStorage.getItem(Be);if(n){const t=JSON.parse(n);return{...Se,...t,autoPause:{...Fe,...t.autoPause||{}},workoutMetadata:{...He,...t.workoutMetadata||{}},countdown:{...We,...t.countdown||{}},autoLap:{...Ve,...t.autoLap||{}},enhancedVoice:{...Je,...t.enhancedVoice||{},metrics:{...Ge,...t.enhancedVoice?.metrics||{}}},intervals:{...Ke,...t.intervals||{}},music:{...Ye,...t.music||{}},weightKg:t.weightKg??75,showCalories:t.showCalories??!1}}return{...Se}}function ln(n){localStorage.setItem(Be,JSON.stringify(n)),window.dispatchEvent(new CustomEvent("settings-changed"))}var Le;(function(n){n[n.SCAN_MODE_LOW_POWER=0]="SCAN_MODE_LOW_POWER",n[n.SCAN_MODE_BALANCED=1]="SCAN_MODE_BALANCED",n[n.SCAN_MODE_LOW_LATENCY=2]="SCAN_MODE_LOW_LATENCY"})(Le||(Le={}));var Ce;(function(n){n[n.CONNECTION_PRIORITY_BALANCED=0]="CONNECTION_PRIORITY_BALANCED",n[n.CONNECTION_PRIORITY_HIGH=1]="CONNECTION_PRIORITY_HIGH",n[n.CONNECTION_PRIORITY_LOW_POWER=2]="CONNECTION_PRIORITY_LOW_POWER"})(Ce||(Ce={}));function Mt(n){return new DataView(Uint8Array.from(n).buffer)}function Ot(n){return Array.from(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}function xt(n){return`0000${n.toString(16).padStart(4,"0")}-0000-1000-8000-00805f9b34fb`}function Ze(n){const t=[];let e,s,r=1,a=0;for(e=0;e<n.length;e++)s=n.charCodeAt(e),(s>47&&s<58||s>64&&s<71||s>96&&s<103)&&(a=a<<4^(s>64?s+9:s)&15,(r^=1)&&t.push(a&255));return Mt(t)}function K(n){return Ot(n).map(t=>{let e=t.toString(16);return e.length==1&&(e="0"+e),e}).join("")}function un(n){if(typeof n=="string")return n;if(typeof n=="number")return xt(n);throw new Error("Invalid UUID")}function dn(n){const t={};if(n)return n.forEach((e,s)=>{t[s.toString()]=e}),t}function Pe(n){if(n!==void 0){if(typeof n=="string"){const t=Ze(n);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}return n instanceof DataView?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n}}function Q(n){if(n!==void 0)return n instanceof DataView?K(n):K(new DataView(n.buffer,n.byteOffset,n.byteLength))}const L=se("BluetoothLe",{web:()=>V(()=>import("./web-i4aVcvOV.js"),__vite__mapDeps([7,1])).then(n=>new n.BluetoothLeWeb)}),qt=()=>{let n=Promise.resolve();return t=>new Promise((e,s)=>{n=n.then(()=>t()).then(e).catch(s)})};function le(n){return n?qt():t=>t()}function N(n){if(typeof n!="string")throw new Error(`Invalid UUID type ${typeof n}. Expected string.`);if(n=n.toLowerCase(),!(n.search(/^[0-9a-f]{8}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{12}$/)>=0))throw new Error(`Invalid UUID format ${n}. Expected 128 bit string (e.g. "0000180d-0000-1000-8000-00805f9b34fb").`);return n}class $t{constructor(){this.scanListener=null,this.eventListeners=new Map,this.queue=le(!0)}enableQueue(){this.queue=le(!0)}disableQueue(){this.queue=le(!1)}async initialize(t){await this.queue(async()=>{await L.initialize(t)})}async isEnabled(){return await this.queue(async()=>(await L.isEnabled()).value)}async requestEnable(){await this.queue(async()=>{await L.requestEnable()})}async enable(){await this.queue(async()=>{await L.enable()})}async disable(){await this.queue(async()=>{await L.disable()})}async startEnabledNotifications(t){await this.queue(async()=>{var e;const s="onEnabledChanged";await((e=this.eventListeners.get(s))===null||e===void 0?void 0:e.remove());const r=await L.addListener(s,a=>{t(a.value)});this.eventListeners.set(s,r),await L.startEnabledNotifications()})}async stopEnabledNotifications(){await this.queue(async()=>{var t;const e="onEnabledChanged";await((t=this.eventListeners.get(e))===null||t===void 0?void 0:t.remove()),this.eventListeners.delete(e),await L.stopEnabledNotifications()})}async isLocationEnabled(){return await this.queue(async()=>(await L.isLocationEnabled()).value)}async openLocationSettings(){await this.queue(async()=>{await L.openLocationSettings()})}async openBluetoothSettings(){await this.queue(async()=>{await L.openBluetoothSettings()})}async openAppSettings(){await this.queue(async()=>{await L.openAppSettings()})}async setDisplayStrings(t){await this.queue(async()=>{await L.setDisplayStrings(t)})}async requestDevice(t){return t=t?this.validateRequestBleDeviceOptions(t):void 0,await this.queue(async()=>await L.requestDevice(t))}async requestLEScan(t,e){t=this.validateRequestBleDeviceOptions(t),await this.queue(async()=>{var s;await((s=this.scanListener)===null||s===void 0?void 0:s.remove()),this.scanListener=await L.addListener("onScanResult",r=>{const a=Object.assign(Object.assign({},r),{manufacturerData:this.convertObject(r.manufacturerData),serviceData:this.convertObject(r.serviceData),rawAdvertisement:r.rawAdvertisement?this.convertValue(r.rawAdvertisement):void 0});e(a)}),await L.requestLEScan(t)})}async stopLEScan(){await this.queue(async()=>{var t;await((t=this.scanListener)===null||t===void 0?void 0:t.remove()),this.scanListener=null,await L.stopLEScan()})}async getDevices(t){if(!Array.isArray(t))throw new Error("deviceIds must be an array");return this.queue(async()=>(await L.getDevices({deviceIds:t})).devices)}async getConnectedDevices(t){if(!Array.isArray(t))throw new Error("services must be an array");return t=t.map(N),this.queue(async()=>(await L.getConnectedDevices({services:t})).devices)}async getBondedDevices(){return this.queue(async()=>(await L.getBondedDevices()).devices)}async connect(t,e,s){await this.queue(async()=>{var r;if(e){const a=`disconnected|${t}`;await((r=this.eventListeners.get(a))===null||r===void 0?void 0:r.remove());const i=await L.addListener(a,()=>{e(t)});this.eventListeners.set(a,i)}await L.connect(Object.assign({deviceId:t},s))})}async createBond(t,e){await this.queue(async()=>{await L.createBond(Object.assign({deviceId:t},e))})}async isBonded(t){return await this.queue(async()=>(await L.isBonded({deviceId:t})).value)}async disconnect(t){await this.queue(async()=>{await L.disconnect({deviceId:t})})}async getServices(t){return await this.queue(async()=>(await L.getServices({deviceId:t})).services)}async discoverServices(t){await this.queue(async()=>{await L.discoverServices({deviceId:t})})}async getMtu(t){return await this.queue(async()=>(await L.getMtu({deviceId:t})).value)}async requestConnectionPriority(t,e){await this.queue(async()=>{await L.requestConnectionPriority({deviceId:t,connectionPriority:e})})}async readRssi(t){return await this.queue(async()=>{const s=await L.readRssi({deviceId:t});return parseFloat(s.value)})}async read(t,e,s,r){return e=N(e),s=N(s),await this.queue(async()=>{const i=await L.read(Object.assign({deviceId:t,service:e,characteristic:s},r));return this.convertValue(i.value)})}async write(t,e,s,r,a){return e=N(e),s=N(s),this.queue(async()=>{if(!r?.buffer)throw new Error("Invalid data.");let i=r;T.getPlatform()!=="web"&&(i=K(r)),await L.write(Object.assign({deviceId:t,service:e,characteristic:s,value:i},a))})}async writeWithoutResponse(t,e,s,r,a){e=N(e),s=N(s),await this.queue(async()=>{if(!r?.buffer)throw new Error("Invalid data.");let i=r;T.getPlatform()!=="web"&&(i=K(r)),await L.writeWithoutResponse(Object.assign({deviceId:t,service:e,characteristic:s,value:i},a))})}async readDescriptor(t,e,s,r,a){return e=N(e),s=N(s),r=N(r),await this.queue(async()=>{const l=await L.readDescriptor(Object.assign({deviceId:t,service:e,characteristic:s,descriptor:r},a));return this.convertValue(l.value)})}async writeDescriptor(t,e,s,r,a,i){return e=N(e),s=N(s),r=N(r),this.queue(async()=>{if(!a?.buffer)throw new Error("Invalid data.");let l=a;T.getPlatform()!=="web"&&(l=K(a)),await L.writeDescriptor(Object.assign({deviceId:t,service:e,characteristic:s,descriptor:r,value:l},i))})}async startNotifications(t,e,s,r,a){e=N(e),s=N(s),await this.queue(async()=>{var i;const l=`notification|${t}|${e}|${s}`;await((i=this.eventListeners.get(l))===null||i===void 0?void 0:i.remove());const d=await L.addListener(l,f=>{r(this.convertValue(f?.value))});this.eventListeners.set(l,d),await L.startNotifications(Object.assign({deviceId:t,service:e,characteristic:s},a))})}async stopNotifications(t,e,s){e=N(e),s=N(s),await this.queue(async()=>{var r;const a=`notification|${t}|${e}|${s}`;await((r=this.eventListeners.get(a))===null||r===void 0?void 0:r.remove()),this.eventListeners.delete(a),await L.stopNotifications({deviceId:t,service:e,characteristic:s})})}validateRequestBleDeviceOptions(t){return t.services&&(t.services=t.services.map(N)),t.optionalServices&&(t.optionalServices=t.optionalServices.map(N)),t.serviceData&&T.getPlatform()!=="web"&&(t.serviceData=t.serviceData.map(e=>Object.assign(Object.assign({},e),{serviceUuid:N(e.serviceUuid),dataPrefix:Q(e.dataPrefix),mask:Q(e.mask)}))),t.manufacturerData&&(T.getPlatform()!=="web"?t.manufacturerData=t.manufacturerData.map(e=>Object.assign(Object.assign({},e),{dataPrefix:Q(e.dataPrefix),mask:Q(e.mask)})):t.manufacturerData=t.manufacturerData.map(e=>Object.assign(Object.assign({},e),{dataPrefix:Pe(e.dataPrefix),mask:Pe(e.mask)}))),t}convertValue(t){return typeof t=="string"?Ze(t):t===void 0?new DataView(new ArrayBuffer(0)):t}convertObject(t){if(t===void 0)return;const e={};for(const s of Object.keys(t))e[s]=this.convertValue(t[s]);return e}}const _=new $t,ue="bpt_last_device_ids",de="bpt_last_device_names",W={getIds(){try{const n=localStorage.getItem(ue);return n?JSON.parse(n):{}}catch(n){return console.warn("Failed to read connection storage",n),{}}},saveId(n,t){const e=this.getIds();e[n]=t;try{localStorage.setItem(ue,JSON.stringify(e))}catch(s){console.warn("Failed to save connection storage",s)}},clearId(n){const t=this.getIds();delete t[n];try{localStorage.setItem(ue,JSON.stringify(t))}catch(e){console.warn("Failed to save connection storage",e)}},getId(n){return this.getIds()[n]},getDeviceNames(){try{const n=localStorage.getItem(de);return n?JSON.parse(n):{}}catch(n){return console.warn("Failed to read device names storage",n),{}}},saveDeviceName(n,t){const e=this.getDeviceNames();e[n]=t;try{localStorage.setItem(de,JSON.stringify(e))}catch(s){console.warn("Failed to save device name",s)}},clearDeviceName(n){const t=this.getDeviceNames();delete t[n];try{localStorage.setItem(de,JSON.stringify(t))}catch(e){console.warn("Failed to clear device name",e)}},getDeviceName(n){return this.getDeviceNames()[n]}},Qe=n=>{const t=n.getUint16(0,!0);let e=2;const s={},r=(t&2)!==0,a=(t&4)!==0,i=(t&8)!==0;if(n.byteLength>=e+2){const l=n.getUint16(e,!0);s.speed=l/100,e+=2}if(r&&n.byteLength>=e+2){const l=n.getUint16(e,!0);s.averageSpeed=l/100,e+=2}if(a&&n.byteLength>=e+3){const l=n.getUint8(e),d=n.getUint8(e+1),f=n.getUint8(e+2),m=l+(d<<8)+(f<<16);s.totalDistance=m,e+=3}if(i&&n.byteLength>=e+4){const l=n.getInt16(e,!0);s.incline=l/10,e+=2;const d=n.getInt16(e,!0);s.rampAngle=d/10,e+=2}return s},ne=(n,t)=>{const e=n.getUint8(t),s=n.getUint8(t+1),r=n.getUint8(t+2);return e+(s<<8)+(r<<16)},jt=n=>{const t=n.getUint16(0,!0);let e=2;const s={},r=(t&2)!==0,a=(t&4)!==0,i=(t&8)!==0,l=(t&16)!==0,d=(t&32)!==0,f=(t&64)!==0,m=(t&256)!==0,c=(t&512)!==0,o=(t&2048)!==0;return n.byteLength>=e+1&&(s.strokeRate=n.getUint8(e)*.5,e+=1),n.byteLength>=e+2&&(s.strokeCount=n.getUint16(e,!0),e+=2),r&&n.byteLength>=e+1&&(s.averageStrokeRate=n.getUint8(e)*.5,e+=1),a&&n.byteLength>=e+3&&(s.totalDistance=ne(n,e),e+=3),i&&n.byteLength>=e+2&&(s.instantaneousPace=n.getUint16(e,!0),e+=2),l&&n.byteLength>=e+2&&(s.averagePace=n.getUint16(e,!0),e+=2),d&&n.byteLength>=e+2&&(s.instantaneousPower=n.getInt16(e,!0),e+=2),f&&n.byteLength>=e+2&&(s.averagePower=n.getInt16(e,!0),e+=2),(t&128)!==0&&n.byteLength>=e+2&&(e+=2),m&&n.byteLength>=e+5&&(s.totalEnergy=n.getUint16(e,!0),e+=5),c&&n.byteLength>=e+1&&(s.heartRate=n.getUint8(e),e+=1),(t&1024)!==0&&n.byteLength>=e+1&&(e+=1),o&&n.byteLength>=e+2&&(s.elapsedTime=n.getUint16(e,!0),e+=2),s},Bt=n=>{const t=ne(n,0);let e=3;const s={},r=(t&2)!==0,a=(t&4)!==0,i=(t&8)!==0,l=(t&16)!==0,d=(t&32)!==0,f=(t&64)!==0,m=(t&128)!==0,c=(t&256)!==0,o=(t&512)!==0,u=(t&1024)!==0,h=(t&2048)!==0,w=(t&8192)!==0;return n.byteLength>=e+2&&(s.speed=n.getUint16(e,!0)/100,e+=2),r&&n.byteLength>=e+2&&(s.averageSpeed=n.getUint16(e,!0)/100,e+=2),a&&n.byteLength>=e+3&&(s.totalDistance=ne(n,e),e+=3),i&&n.byteLength>=e+4&&(s.stepPerMinute=n.getUint16(e,!0),e+=2,s.averageStepRate=n.getUint16(e,!0),e+=2),l&&n.byteLength>=e+2&&(s.strideCount=n.getUint16(e,!0),e+=2),d&&n.byteLength>=e+4&&(s.positiveElevationGain=n.getUint16(e,!0),e+=2,s.negativeElevationGain=n.getUint16(e,!0),e+=2),f&&n.byteLength>=e+4&&(s.incline=n.getInt16(e,!0)/10,e+=2,s.rampAngle=n.getInt16(e,!0)/10,e+=2),m&&n.byteLength>=e+2&&(s.resistanceLevel=n.getInt16(e,!0),e+=2),c&&n.byteLength>=e+2&&(s.instantaneousPower=n.getInt16(e,!0),e+=2),o&&n.byteLength>=e+2&&(s.averagePower=n.getInt16(e,!0),e+=2),u&&n.byteLength>=e+5&&(s.totalEnergy=n.getUint16(e,!0),e+=5),h&&n.byteLength>=e+1&&(s.heartRate=n.getUint8(e),e+=1),(t&4096)!==0&&n.byteLength>=e+1&&(e+=1),w&&n.byteLength>=e+2&&(s.elapsedTime=n.getUint16(e,!0),e+=2),s},Ft=n=>{const t=n.getUint16(0,!0);let e=2;const s={},r=(t&2)!==0,a=(t&4)!==0,i=(t&8)!==0,l=(t&16)!==0,d=(t&32)!==0,f=(t&64)!==0,m=(t&128)!==0,c=(t&256)!==0,o=(t&512)!==0,u=(t&2048)!==0;return n.byteLength>=e+2&&(s.speed=n.getUint16(e,!0)/100,e+=2),r&&n.byteLength>=e+2&&(s.averageSpeed=n.getUint16(e,!0)/100,e+=2),a&&n.byteLength>=e+2&&(s.cadence=n.getUint16(e,!0)/2,e+=2),i&&n.byteLength>=e+2&&(s.averageCadence=n.getUint16(e,!0)/2,e+=2),l&&n.byteLength>=e+3&&(s.totalDistance=ne(n,e),e+=3),d&&n.byteLength>=e+2&&(s.resistanceLevel=n.getInt16(e,!0),e+=2),f&&n.byteLength>=e+2&&(s.instantaneousPower=n.getInt16(e,!0),e+=2),m&&n.byteLength>=e+2&&(s.averagePower=n.getInt16(e,!0),e+=2),c&&n.byteLength>=e+5&&(s.totalEnergy=n.getUint16(e,!0),e+=5),o&&n.byteLength>=e+1&&(s.heartRate=n.getUint8(e),e+=1),(t&1024)!==0&&n.byteLength>=e+1&&(e+=1),u&&n.byteLength>=e+2&&(s.elapsedTime=n.getUint16(e,!0),e+=2),s},Ht=n=>{const t=n.getUint16(0,!0);let e=2;const s={},r=(t&2)!==0,a=(t&4)!==0,i=(t&8)!==0,l=(t&16)!==0,d=(t&32)!==0,f=(t&64)!==0,m=(t&128)!==0,c=(t&256)!==0,o=(t&512)!==0,u=(t&1024)!==0,h=(t&2048)!==0;return r&&n.byteLength>=e+2&&(s.floors=n.getUint16(e,!0),e+=2),a&&n.byteLength>=e+2&&(s.stepCount=n.getUint16(e,!0),e+=2),i&&n.byteLength>=e+2&&(s.stepRate=n.getUint16(e,!0),e+=2),l&&n.byteLength>=e+2&&(s.averageStepRate=n.getUint16(e,!0),e+=2),d&&n.byteLength>=e+2&&(s.positiveElevationGain=n.getUint16(e,!0),e+=2),f&&n.byteLength>=e+2&&(s.instantaneousPower=n.getInt16(e,!0),e+=2),m&&n.byteLength>=e+2&&(s.averagePower=n.getInt16(e,!0),e+=2),c&&n.byteLength>=e+5&&(s.totalEnergy=n.getUint16(e,!0),e+=5),o&&n.byteLength>=e+1&&(s.heartRate=n.getUint8(e),e+=1),u&&n.byteLength>=e+1&&(e+=1),h&&n.byteLength>=e+2&&(s.elapsedTime=n.getUint16(e,!0),e+=2),s},Wt=n=>{const t=n.getUint8(0);let e=1;const r=n.getUint16(e,!0)/256*3.6;e+=2;const a=n.getUint8(e);e+=1;const i={speed:r,cadence:a},l=(t&1)!==0,d=(t&2)!==0;if(l&&n.byteLength>=e+2){const f=n.getUint16(e,!0);i.strideLength=f/100,e+=2}if(d&&n.byteLength>=e+4){const f=n.getUint32(e,!0);i.totalDistance=f/10,e+=4}return i},I={listeners:new Set,isEnabled(){return!!ze().debugMode},async log(n,t){const e=this.bufferToHex(t.buffer);if(this.listeners.forEach(s=>s(n,e)),!!this.isEnabled())try{await Ue(n,e)}catch(s){console.warn("Failed to log debug data",s)}},addListener(n){this.listeners.add(n)},removeListener(n){this.listeners.delete(n)},bufferToHex(n){return[...new Uint8Array(n)].map(t=>t.toString(16).padStart(2,"0")).join("").toUpperCase()},async exportLogs(){const n=await he(),t=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),e=URL.createObjectURL(t),s=document.createElement("a");s.href=e,s.download=`bpt-debug-logs-${Date.now()}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(e)},async clearLogs(){await Me()},async getLogCount(){return(await he()).length}},fe="00001818-0000-1000-8000-00805f9b34fb",De="00002a63-0000-1000-8000-00805f9b34fb",X="0000180d-0000-1000-8000-00805f9b34fb",Re="00002a37-0000-1000-8000-00805f9b34fb",ee="00001816-0000-1000-8000-00805f9b34fb",Te="00002a5b-0000-1000-8000-00805f9b34fb",te="00001826-0000-1000-8000-00805f9b34fb",_e="00002acd-0000-1000-8000-00805f9b34fb",q=5,ae=1e3;let Ne=!1;const re=async()=>{if(!Ne)try{await _.initialize(),Ne=!0}catch(n){throw console.error("Failed to initialize BleClient:",n),n}},Vt=async n=>{const t=[],e=[];let s=n||null,r=!1,a=0,i="Power Sensor";if(await re(),s)i="Restored Power Sensor";else try{const c=await _.requestDevice({services:[fe],optionalServices:[]});s=c.deviceId,i=c.name||"Power Sensor"}catch(c){throw console.error("Error requesting Power device:",c),c}const l=c=>{e.forEach(o=>o(c))},d=async()=>{s&&(await _.connect(s,m),W.saveId("power",s),l("connected"),await _.startNotifications(s,fe,De,c=>{I.log(i,c);const o=c.getInt16(2,!0),u={timestamp:Date.now(),value:o};t.forEach(h=>h(u))}),a=0)},f=async()=>{if(r||a>=q){a>=q&&(console.error("Native Power sensor: Max reconnection attempts reached"),l("failed"));return}a++;const c=ae*Math.pow(2,a-1);console.log(`Native Power sensor: Reconnection attempt ${a}/${q} in ${c}ms`),l("reconnecting"),await new Promise(o=>setTimeout(o,c));try{await d(),console.log("Native Power sensor: Reconnected successfully")}catch(o){console.error("Native Power sensor: Reconnection failed:",o),f()}},m=c=>{c===s&&!r&&(console.log("Native Power sensor: Disconnected"),l("disconnected"),f())};return await d(),{disconnect:async()=>{if(r=!0,s)try{await _.stopNotifications(s,fe,De),await _.disconnect(s)}catch(c){console.error("Error disconnecting native bluetooth:",c)}},addListener:c=>{t.push(c)},deviceName:i,onStatusChange:c=>{e.push(c)}}},Gt=async n=>{const t=[],e=[];let s=n||null,r=!1,a=0,i="Heart Rate Monitor";if(await re(),s)i="Restored HR Monitor";else try{const c=await _.requestDevice({services:[X],optionalServices:[X]});s=c.deviceId,i=c.name||"Heart Rate Monitor"}catch(c){throw console.error("Error requesting Heart Rate device:",c),c}const l=c=>{e.forEach(o=>o(c))},d=async()=>{s&&(await _.connect(s,m),W.saveId("heartrate",s),l("connected"),await _.startNotifications(s,X,Re,c=>{I.log(i,c);const o=c.getUint8(0);let u;o&1?u=c.getUint16(1,!0):u=c.getUint8(1);const h={timestamp:Date.now(),value:u};t.forEach(w=>w(h))}),a=0)},f=async()=>{if(r||a>=q){a>=q&&(console.error("Native Heart Rate sensor: Max reconnection attempts reached"),l("failed"));return}a++;const c=ae*Math.pow(2,a-1);console.log(`Native Heart Rate sensor: Reconnection attempt ${a}/${q} in ${c}ms`),l("reconnecting"),await new Promise(o=>setTimeout(o,c));try{await d(),console.log("Native Heart Rate sensor: Reconnected successfully")}catch(o){console.error("Native Heart Rate sensor: Reconnection failed:",o),f()}},m=c=>{c===s&&!r&&(console.log("Native Heart Rate sensor: Disconnected"),l("disconnected"),f())};return await d(),{disconnect:async()=>{if(r=!0,s)try{await _.stopNotifications(s,X,Re),await _.disconnect(s)}catch(c){console.error("Error disconnecting native bluetooth:",c)}},addListener:c=>{t.push(c)},deviceName:i,onStatusChange:c=>{e.push(c)}}},Jt=async n=>{const t=[],e=[];let s=n||null,r=null,a=null,i=!1,l=0,d="Cadence Sensor";if(await re(),s)d="Restored Cadence Sensor";else try{const u=await _.requestDevice({services:[ee],optionalServices:[ee]});s=u.deviceId,d=u.name||"Cadence Sensor"}catch(u){throw console.error("Error requesting Cadence device:",u),u}const f=u=>{e.forEach(h=>h(u))},m=async()=>{s&&(await _.connect(s,o),W.saveId("cadence",s),f("connected"),await _.startNotifications(s,ee,Te,u=>{I.log(d,u);const h=u.getUint8(0);if(h&2){let w=1;h&1&&(w=7);const g=u.getUint16(w,!0),p=u.getUint16(w+2,!0);if(r!==null&&a!==null){let v=g-r,S=p-a;if(v<0&&(v+=65536),S<0&&(S+=65536),S>0){const E=S/1024,P=Math.round(v/E*60);if(P>=0&&P<300){const A={timestamp:Date.now(),value:P};t.forEach(b=>b(A))}}}r=g,a=p}}),l=0)},c=async()=>{if(i||l>=q){l>=q&&(console.error("Native Cadence sensor: Max reconnection attempts reached"),f("failed"));return}l++;const u=ae*Math.pow(2,l-1);console.log(`Native Cadence sensor: Reconnection attempt ${l}/${q} in ${u}ms`),f("reconnecting"),await new Promise(h=>setTimeout(h,u));try{await m(),console.log("Native Cadence sensor: Reconnected successfully")}catch(h){console.error("Native Cadence sensor: Reconnection failed:",h),c()}},o=u=>{u===s&&!i&&(console.log("Native Cadence sensor: Disconnected"),f("disconnected"),c())};return await m(),{disconnect:async()=>{if(i=!0,s)try{await _.stopNotifications(s,ee,Te),await _.disconnect(s)}catch(u){console.error("Error disconnecting native bluetooth:",u)}},addListener:u=>{t.push(u)},deviceName:d,onStatusChange:u=>{e.push(u)}}},Kt=async n=>{const t=[],e=[];let s=n||null,r=!1,a=0,i="Treadmill";if(await re(),s)i="Restored Treadmill";else try{const c=await _.requestDevice({services:[te],optionalServices:[te]});s=c.deviceId,i=c.name||"Treadmill"}catch(c){throw console.error("Error requesting Treadmill device:",c),c}const l=c=>{e.forEach(o=>o(c))},d=c=>{c===s&&!r&&(console.log("Treadmill: Connection lost, attempting to reconnect..."),l("disconnected"),m())},f=async()=>{s&&(await _.connect(s,d),W.saveId("treadmill",s),l("connected"),await _.startNotifications(s,te,_e,c=>{I.log(i,c);try{const o=Qe(c);if(o.speed!==void 0||o.incline!==void 0){const u={timestamp:Date.now(),speed:o.speed??null,incline:o.incline??null};t.forEach(h=>h(u))}}catch(o){console.error("Error parsing treadmill data",o)}}),a=0)},m=async()=>{if(r)return;if(a>=q){console.error("Treadmill: Max reconnection attempts reached"),l("failed");return}a++;const c=ae*Math.pow(2,a-1);console.log(`Treadmill: Reconnection attempt ${a}/${q} in ${c}ms`),l("reconnecting"),await new Promise(o=>setTimeout(o,c));try{await f(),console.log("Treadmill: Reconnected successfully")}catch(o){console.error("Treadmill: Reconnection failed:",o),m()}};try{await f()}catch(c){if(s)try{await _.disconnect(s)}catch{}throw c}return{disconnect:async()=>{if(r=!0,s)try{await _.stopNotifications(s,te,_e),await _.disconnect(s)}catch(c){console.error("Error disconnecting treadmill",c)}l("disconnected")},addListener:c=>{t.push(c)},deviceName:i,onStatusChange:c=>{e.push(c)}}},D=5,x=1e3,Yt=async n=>{const t=[],e=[];let s=!1,r=0,a=null,i;if(n&&typeof navigator.bluetooth.getDevices=="function")try{i=(await navigator.bluetooth.getDevices()).find(u=>u.id===n)}catch(o){console.warn("Failed to get permitted devices",o)}if(!i){if(n)throw new Error("Device not found in permitted list");i=await navigator.bluetooth.requestDevice({filters:[{services:["cycling_power"]}],optionalServices:["cycling_power"]})}if(!i.gatt)throw new Error("GATT server not available");i.id&&W.saveId("power",i.id);const l=i.name||"Power Sensor",d=o=>{e.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(!h)return;I.log(l,h);const w=h.getInt16(2,!0),g={timestamp:Date.now(),value:w};t.forEach(p=>p(g))},m=async()=>{if(!i.gatt)return;a=await(await(await i.gatt.connect()).getPrimaryService("cycling_power")).getCharacteristic("cycling_power_measurement"),await a.startNotifications(),a.addEventListener("characteristicvaluechanged",f),r=0,d("connected")},c=async()=>{if(s||r>=D){r>=D&&(console.error("Power sensor: Max reconnection attempts reached"),d("failed"));return}r++;const o=x*Math.pow(2,r-1);console.log(`Power sensor: Reconnection attempt ${r}/${D} in ${o}ms`),d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m(),console.log("Power sensor: Reconnected successfully")}catch(u){console.error("Power sensor: Reconnection failed:",u),c()}};return i.addEventListener("gattserverdisconnected",()=>{s||(console.log("Power sensor: Connection lost, attempting to reconnect..."),d("disconnected"),c())}),await m(),{disconnect:()=>{s=!0,a&&(a.removeEventListener("characteristicvaluechanged",f),a.stopNotifications().catch(()=>{})),i.gatt?.disconnect()},addListener:o=>{t.push(o)},deviceName:l,onStatusChange:o=>{e.push(o)}}},zt=async n=>{const t=[],e=[];let s=!1,r=0,a=null,i;if(n&&typeof navigator.bluetooth.getDevices=="function")try{i=(await navigator.bluetooth.getDevices()).find(u=>u.id===n)}catch(o){console.warn("Failed to get permitted devices",o)}if(!i){if(n)throw new Error("Device not found in permitted list");i=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["heart_rate"]})}if(!i.gatt)throw new Error("GATT server not available");i.id&&W.saveId("heartrate",i.id);const l=i.name||"Heart Rate Monitor",d=o=>{e.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(!h)return;I.log(l,h);const w=h.getUint8(0);let g;w&1?g=h.getUint16(1,!0):g=h.getUint8(1);const p={timestamp:Date.now(),value:g};t.forEach(v=>v(p))},m=async()=>{if(!i.gatt)return;a=await(await(await i.gatt.connect()).getPrimaryService("heart_rate")).getCharacteristic("heart_rate_measurement"),await a.startNotifications(),a.addEventListener("characteristicvaluechanged",f),r=0,d("connected")},c=async()=>{if(s||r>=D){r>=D&&(console.error("Heart rate sensor: Max reconnection attempts reached"),d("failed"));return}r++;const o=x*Math.pow(2,r-1);console.log(`Heart rate sensor: Reconnection attempt ${r}/${D} in ${o}ms`),d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m(),console.log("Heart rate sensor: Reconnected successfully")}catch(u){console.error("Heart rate sensor: Reconnection failed:",u),c()}};return i.addEventListener("gattserverdisconnected",()=>{s||(console.log("Heart rate sensor: Connection lost, attempting to reconnect..."),d("disconnected"),c())}),await m(),{disconnect:()=>{s=!0,a&&(a.removeEventListener("characteristicvaluechanged",f),a.stopNotifications().catch(()=>{})),i.gatt?.disconnect()},addListener:o=>{t.push(o)},deviceName:l,onStatusChange:o=>{e.push(o)}}},Zt=async n=>{const t=[],e=[];let s=!1,r=0,a=null,i=null,l=null,d;if(n&&typeof navigator.bluetooth.getDevices=="function")try{d=(await navigator.bluetooth.getDevices()).find(w=>w.id===n)}catch(h){console.warn("Failed to get permitted devices",h)}if(!d){if(n)throw new Error("Device not found in permitted list");d=await navigator.bluetooth.requestDevice({filters:[{services:["cycling_speed_and_cadence"]}],optionalServices:["cycling_speed_and_cadence"]})}if(!d.gatt)throw new Error("GATT server not available");d.id&&W.saveId("cadence",d.id);const f=d.name||"Cadence Sensor",m=h=>{e.forEach(w=>w(h))},c=h=>{const g=h.target.value;if(!g)return;I.log(f,g);const p=g.getUint8(0);if(p&2){let v=1;p&1&&(v=7);const S=g.getUint16(v,!0),E=g.getUint16(v+2,!0);if(i!==null&&l!==null){let P=S-i,A=E-l;if(P<0&&(P+=65536),A<0&&(A+=65536),A>0){const b=A/1024,y=Math.round(P/b*60);if(y>=0&&y<300){const R={timestamp:Date.now(),value:y};t.forEach(C=>C(R))}}}i=S,l=E}},o=async()=>{if(!d.gatt)return;a=await(await(await d.gatt.connect()).getPrimaryService("cycling_speed_and_cadence")).getCharacteristic("csc_measurement"),await a.startNotifications(),a.addEventListener("characteristicvaluechanged",c),r=0,m("connected")},u=async()=>{if(s||r>=D){r>=D&&(console.error("Cadence sensor: Max reconnection attempts reached"),m("failed"));return}r++;const h=x*Math.pow(2,r-1);console.log(`Cadence sensor: Reconnection attempt ${r}/${D} in ${h}ms`),m("reconnecting"),await new Promise(w=>setTimeout(w,h));try{await o(),console.log("Cadence sensor: Reconnected successfully")}catch(w){console.error("Cadence sensor: Reconnection failed:",w),u()}};return d.addEventListener("gattserverdisconnected",()=>{s||(console.log("Cadence sensor: Connection lost, attempting to reconnect..."),m("disconnected"),u())}),await o(),{disconnect:()=>{s=!0,a&&(a.removeEventListener("characteristicvaluechanged",c),a.stopNotifications().catch(()=>{})),d.gatt?.disconnect()},addListener:h=>{t.push(h)},deviceName:f,onStatusChange:h=>{e.push(h)}}},Qt=async n=>{const t=[],e=[];let s=!1,r=0,a=null,i,l;if(n&&typeof navigator.bluetooth.getDevices=="function")try{l=(await navigator.bluetooth.getDevices()).find(h=>h.id===n)}catch(u){console.warn("Failed to get permitted devices",u)}if(!l){if(n)throw new Error("Device not found in permitted list");l=await navigator.bluetooth.requestDevice({filters:[{services:["fitness_machine"]}],optionalServices:["fitness_machine"]})}if(!l.gatt)throw new Error("GATT server not available");l.id&&W.saveId("treadmill",l.id);const d=l.name||"Treadmill",f=u=>{e.forEach(h=>h(u))},m=u=>{const w=u.target.value;if(w){I.log(d,w);try{const g=Qe(w);if(g.speed!==void 0||g.incline!==void 0){const p={timestamp:Date.now(),speed:g.speed??null,incline:g.incline??null};t.forEach(v=>v(p))}}catch(g){console.error("Error parsing treadmill data",g)}}},c=async()=>{if(!l.gatt)return;i=await l.gatt.connect(),a=await(await i.getPrimaryService("fitness_machine")).getCharacteristic("treadmill_data"),await a.startNotifications(),a.addEventListener("characteristicvaluechanged",m),r=0,f("connected")},o=async()=>{if(s||r>=D){r>=D&&(console.error("Treadmill: Max reconnection attempts reached"),f("failed"));return}r++;const u=x*Math.pow(2,r-1);console.log(`Treadmill: Reconnection attempt ${r}/${D} in ${u}ms`),f("reconnecting"),await new Promise(h=>setTimeout(h,u));try{await c(),console.log("Treadmill: Reconnected successfully")}catch(h){console.error("Treadmill: Reconnection failed:",h),o()}};l.addEventListener("gattserverdisconnected",()=>{s||(console.log("Treadmill: Connection lost, attempting to reconnect..."),f("disconnected"),o())});try{await c()}catch(u){throw i&&i.connected&&i.disconnect(),u}return{disconnect:()=>{if(s=!0,a)try{a.stopNotifications(),a.removeEventListener("characteristicvaluechanged",m)}catch{}l.gatt?.connected&&l.gatt.disconnect(),f("disconnected")},addListener:u=>{t.push(u)},deviceName:d,onStatusChange:u=>{e.push(u)}}},Xt=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a;const i=await navigator.bluetooth.requestDevice({filters:[{services:["fitness_machine"]}],optionalServices:["fitness_machine"]}),l=i.name||"Unknown Rower",d=o=>{t.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(h){I.log("rower",h);try{const w=jt(h),g={timestamp:Date.now(),strokeRate:w.strokeRate??null,power:w.instantaneousPower??null};n.forEach(p=>p(g))}catch(w){console.error("Error parsing rower data",w)}}},m=async()=>{if(!i.gatt)return;a=await i.gatt.connect(),r=await(await a.getPrimaryService("fitness_machine")).getCharacteristic("rower_data"),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",f),s=0,d("connected")},c=async()=>{if(e||s>=D){s>=D&&(console.error("Rower: Max reconnection attempts reached"),d("failed"));return}s++;const o=x*Math.pow(2,s-1);console.log(`Rower: Reconnection attempt ${s}/${D} in ${o}ms`),d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m(),console.log("Rower: Reconnected successfully")}catch(u){console.error("Rower: Reconnection failed:",u),c()}};i.addEventListener("gattserverdisconnected",()=>{e||(console.log("Rower: Connection lost, attempting to reconnect..."),d("disconnected"),c())});try{await m()}catch(o){throw a&&a.connected&&a.disconnect(),o}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",f)}catch{}i.gatt?.connected&&i.gatt.disconnect(),d("disconnected")},addListener:o=>{n.push(o)},deviceName:l,onStatusChange:o=>{t.push(o)}}},Ae=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a;const l=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"PM5"}],optionalServices:["ce060030-43e5-11e4-916c-0800200c9a66"]}),d=l.name||"Unknown concept2 Rower",f=u=>{t.forEach(h=>h(u))},m=u=>{const w=u.target.value;if(!w)return;I.log("concept2",w);const g={timestamp:Date.now(),strokeRate:null,power:null};n.forEach(p=>p(g))},c=async()=>{if(!l.gatt)return;a=await l.gatt.connect(),r=await(await a.getPrimaryService("fitness_machine")).getCharacteristic("rower_data"),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",m),s=0,f("connected")},o=async()=>{if(e||s>=D){s>=D&&(console.error("Rower: Max reconnection attempts reached"),f("failed"));return}s++;const u=x*Math.pow(2,s-1);console.log(`Rower: Reconnection attempt ${s}/${D} in ${u}ms`),f("reconnecting"),await new Promise(h=>setTimeout(h,u));try{await c(),console.log("Rower: Reconnected successfully")}catch(h){console.error("Rower: Reconnection failed:",h),o()}};l.addEventListener("gattserverdisconnected",()=>{e||(console.log("Rower: Connection lost, attempting to reconnect..."),f("disconnected"),o())});try{await c()}catch(u){throw a&&a.connected&&a.disconnect(),u}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",m)}catch{}l.gatt?.connected&&l.gatt.disconnect(),f("disconnected")},addListener:u=>{n.push(u)},deviceName:d,onStatusChange:u=>{t.push(u)}}},ke=async()=>{const n=[],t=[],e=[];let s=!1,r=0,a=null,i=null,l=null,d=null,f=null;const m=await navigator.bluetooth.requestDevice({filters:[{services:["cycling_speed_and_cadence"]}],optionalServices:["cycling_speed_and_cadence"]});if(!m.gatt)throw new Error("GATT server not available");const c=m.name||"Speed/Cadence Sensor",o=g=>{e.forEach(p=>p(g))},u=g=>{const v=g.target.value;if(!v)return;I.log(c,v);const S=v.getUint8(0);let E=1;if(S&1){const P=v.getUint32(E,!0);E+=4;const A=v.getUint16(E,!0);if(E+=2,d!==null&&f!==null){let b=P-d,y=A-f;if(b<0&&(b+=4294967296),y<0&&(y+=65536),y>0&&b>0){const R=y/1024,C=ze().wheelCircumferenceMm,k=b*C/1e6/R*3600;if(k>=0&&k<150){const O={timestamp:Date.now(),value:Math.round(k*10)/10};t.forEach(M=>M(O))}}}d=P,f=A}if(S&2){const P=v.getUint16(E,!0);E+=2;const A=v.getUint16(E,!0);if(i!==null&&l!==null){let b=P-i,y=A-l;if(b<0&&(b+=65536),y<0&&(y+=65536),y>0){const R=y/1024,C=Math.round(b/R*60);if(C>=0&&C<300){const k={timestamp:Date.now(),value:C};n.forEach(O=>O(k))}}}i=P,l=A}},h=async()=>{if(!m.gatt)return;a=await(await(await m.gatt.connect()).getPrimaryService("cycling_speed_and_cadence")).getCharacteristic("csc_measurement"),await a.startNotifications(),a.addEventListener("characteristicvaluechanged",u),r=0,o("connected")},w=async()=>{if(s||r>=D){r>=D&&o("failed");return}r++;const g=x*Math.pow(2,r-1);o("reconnecting"),await new Promise(p=>setTimeout(p,g));try{await h()}catch{w()}};return m.addEventListener("gattserverdisconnected",()=>{s||(o("disconnected"),w())}),await h(),{disconnect:()=>{s=!0,a&&(a.removeEventListener("characteristicvaluechanged",u),a.stopNotifications().catch(()=>{})),m.gatt?.disconnect()},addCadenceListener:g=>{n.push(g)},addSpeedListener:g=>{t.push(g)},deviceName:c,onStatusChange:g=>{e.push(g)}}},en=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a;const i=await navigator.bluetooth.requestDevice({filters:[{services:["fitness_machine"]}],optionalServices:["fitness_machine"]});if(!i.gatt)throw new Error("GATT server not available");const l=i.name||"Cross Trainer",d=o=>{t.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(h){I.log(l,h);try{const w=Bt(h),g={timestamp:Date.now(),speed:w.speed??null,stepRate:w.stepPerMinute??null,totalSteps:w.strideCount??null,resistanceLevel:w.resistanceLevel??null,incline:w.incline??null,power:w.instantaneousPower??null};n.forEach(p=>p(g))}catch(w){console.error("Error parsing cross trainer data",w)}}},m=async()=>{if(!i.gatt)return;a=await i.gatt.connect(),r=await(await a.getPrimaryService("fitness_machine")).getCharacteristic(10958),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",f),s=0,d("connected")},c=async()=>{if(e||s>=D){s>=D&&d("failed");return}s++;const o=x*Math.pow(2,s-1);d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m()}catch{c()}};i.addEventListener("gattserverdisconnected",()=>{e||(d("disconnected"),c())});try{await m()}catch(o){throw a&&a.connected&&a.disconnect(),o}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",f)}catch{}i.gatt?.connected&&i.gatt.disconnect(),d("disconnected")},addListener:o=>{n.push(o)},deviceName:l,onStatusChange:o=>{t.push(o)}}},tn=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a=null,i,l=!1;const d=await navigator.bluetooth.requestDevice({filters:[{services:["fitness_machine"]}],optionalServices:["fitness_machine"]});if(!d.gatt)throw new Error("GATT server not available");const f=d.name||"Indoor Bike",m=g=>{t.forEach(p=>p(g))},c=g=>{const v=g.target.value;if(v){I.log(f,v);try{const S=Ft(v),E={timestamp:Date.now(),speed:S.speed??null,cadence:S.cadence??null,resistanceLevel:S.resistanceLevel??null,power:S.instantaneousPower??null};n.forEach(P=>P(E))}catch(S){console.error("Error parsing indoor bike data",S)}}},o=async(g,p)=>{if(!a)throw new Error("Control point not available");const v=new ArrayBuffer(3),S=new DataView(v);S.setUint8(0,g),S.setInt16(1,p,!0),await a.writeValue(v)},u=async(g,p,v,S)=>{if(!a)throw new Error("Control point not available");const E=new ArrayBuffer(7),P=new DataView(E);P.setUint8(0,17),P.setInt16(1,Math.round(g*1e3),!0),P.setInt16(3,Math.round(p*100),!0),P.setUint8(5,Math.round(v*1e4)),P.setUint8(6,Math.round(S*100)),await a.writeValue(E)},h=async()=>{if(!d.gatt)return;i=await d.gatt.connect();const g=await i.getPrimaryService("fitness_machine");r=await g.getCharacteristic(10962),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",c);try{const S=(await(await g.getCharacteristic(10956)).readValue()).getUint32(0,!0);l=(S&8192)!==0,console.log(`Indoor Bike Features: ${S.toString(16)}, Sim Supported: ${l}`)}catch(p){console.warn("Failed to read fitness machine features",p)}try{a=await g.getCharacteristic(10969),await a.startNotifications()}catch{console.log("Indoor bike: Control point not available (ERG mode disabled)"),a=null}s=0,m("connected")},w=async()=>{if(e||s>=D){s>=D&&m("failed");return}s++;const g=x*Math.pow(2,s-1);m("reconnecting"),await new Promise(p=>setTimeout(p,g));try{await h()}catch{w()}};d.addEventListener("gattserverdisconnected",()=>{e||(m("disconnected"),w())});try{await h()}catch(g){throw i&&i.connected&&i.disconnect(),g}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",c)}catch{}if(a)try{a.stopNotifications()}catch{}d.gatt?.connected&&d.gatt.disconnect(),m("disconnected")},addListener:g=>{n.push(g)},deviceName:f,onStatusChange:g=>{t.push(g)},setTargetPower:a?async g=>{await o(5,g)}:void 0,setResistance:a?async g=>{await o(4,g*10)}:void 0,setSimulationParameters:a?async(g,p,v,S)=>{l||console.warn("Indoor bike does not support simulation parameters"),await u(g,p,v,S)}:void 0}},nn=async()=>{const n=[],t=[];let e=!1,s=0,r=null;const a=await navigator.bluetooth.requestDevice({filters:[{services:[6171]},{services:[6173]}],optionalServices:[6171,6173]});if(!a.gatt)throw new Error("GATT server not available");const i=a.name||"Weight Scale",l=o=>{t.forEach(u=>u(o))},d=o=>{const u=o.getUint8(0);let h=1;const w=(u&1)!==0,g=(u&2)!==0,p=(u&4)!==0,v=(u&8)!==0;let S=o.getUint16(h,!0);h+=2,w?S=S*.01*.453592:S=S*.005,g&&(h+=7),p&&(h+=1);let E;return v&&o.byteLength>=h+4&&(E=o.getUint16(h,!0)*.1),{timestamp:Date.now(),weight:Math.round(S*100)/100,bmi:E}},f=o=>{const h=o.target.value;if(h){I.log(i,h);try{const w=d(h);w&&w.weight>0&&n.forEach(g=>g(w))}catch(w){console.error("Error parsing weight data",w)}}},m=async()=>{if(!a.gatt)return;const o=await a.gatt.connect();try{r=await(await o.getPrimaryService(6171)).getCharacteristic(10908)}catch{r=await(await o.getPrimaryService(6173)).getCharacteristic(10909)}await r.startNotifications(),r.addEventListener("characteristicvaluechanged",f),s=0,l("connected")},c=async()=>{if(e||s>=D){s>=D&&l("failed");return}s++;const o=x*Math.pow(2,s-1);l("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m()}catch{c()}};return a.addEventListener("gattserverdisconnected",()=>{e||(l("disconnected"),c())}),await m(),{disconnect:()=>{e=!0,r&&(r.removeEventListener("characteristicvaluechanged",f),r.stopNotifications().catch(()=>{})),a.gatt?.disconnect()},addListener:o=>{n.push(o)},deviceName:i,onStatusChange:o=>{t.push(o)}}},sn=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a;const i=await navigator.bluetooth.requestDevice({filters:[{services:["fitness_machine"]}],optionalServices:["fitness_machine"]});if(!i.gatt)throw new Error("GATT server not available");const l=i.name||"Step Climber",d=o=>{t.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(h){I.log(l,h);try{const w=Ht(h),g={timestamp:Date.now(),...w,power:w.instantaneousPower??null,stepCount:w.stepCount??null,floors:w.floors??null,stepRate:w.stepRate??null};n.forEach(p=>p(g))}catch(w){console.error("Error parsing step climber data",w)}}},m=async()=>{if(!i.gatt)return;a=await i.gatt.connect(),r=await(await a.getPrimaryService("fitness_machine")).getCharacteristic(10959),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",f),s=0,d("connected")},c=async()=>{if(e||s>=D){s>=D&&d("failed");return}s++;const o=x*Math.pow(2,s-1);d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m()}catch{c()}};i.addEventListener("gattserverdisconnected",()=>{e||(d("disconnected"),c())});try{await m()}catch(o){throw a&&a.connected&&a.disconnect(),o}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",f)}catch{}i.gatt?.connected&&i.gatt.disconnect(),d("disconnected")},addListener:o=>{n.push(o)},deviceName:l,onStatusChange:o=>{t.push(o)}}},an=async()=>{const n=[],t=[];let e=!1,s=0,r=null,a;const i=await navigator.bluetooth.requestDevice({filters:[{services:["running_speed_and_cadence"]}],optionalServices:["running_speed_and_cadence"]});if(!i.gatt)throw new Error("GATT server not available");const l=i.name||"RSC Sensor",d=o=>{t.forEach(u=>u(o))},f=o=>{const h=o.target.value;if(h){I.log(l,h);try{const w=Wt(h),g={timestamp:Date.now(),...w};n.forEach(p=>p(g))}catch(w){console.error("Error parsing RSC data",w)}}},m=async()=>{if(!i.gatt)return;a=await i.gatt.connect(),r=await(await a.getPrimaryService("running_speed_and_cadence")).getCharacteristic(10835),await r.startNotifications(),r.addEventListener("characteristicvaluechanged",f),s=0,d("connected")},c=async()=>{if(e||s>=D){s>=D&&d("failed");return}s++;const o=x*Math.pow(2,s-1);d("reconnecting"),await new Promise(u=>setTimeout(u,o));try{await m()}catch{c()}};i.addEventListener("gattserverdisconnected",()=>{e||(d("disconnected"),c())});try{await m()}catch(o){throw a&&a.connected&&a.disconnect(),o}return{disconnect:()=>{if(e=!0,r)try{r.stopNotifications(),r.removeEventListener("characteristicvaluechanged",f)}catch{}i.gatt?.connected&&i.gatt.disconnect(),d("disconnected")},addListener:o=>{n.push(o)},deviceName:l,onStatusChange:o=>{t.push(o)}}},fn={connectPower:async n=>{if(typeof window<"u"&&window.useMockSensors){const{MockPowerSensor:t}=await V(async()=>{const{MockPowerSensor:s}=await import("./mock-DGG0-SkM.js");return{MockPowerSensor:s}},[]),e=new t;return await e.connect(),window.mockSensor=e,e}return T.isNativePlatform()?Vt(n):Yt(n)},connectHeartRate:async n=>{if(typeof window<"u"&&window.useMockSensors){const{MockHeartrateSensor:t}=await V(async()=>{const{MockHeartrateSensor:s}=await import("./mock-DGG0-SkM.js");return{MockHeartrateSensor:s}},[]),e=new t;return await e.connect(),window.mockSensor=e,e}return T.isNativePlatform()?Gt(n):zt(n)},connectCadence:async n=>{if(typeof window<"u"&&window.useMockSensors){const{MockCadenceSensor:t}=await V(async()=>{const{MockCadenceSensor:s}=await import("./mock-DGG0-SkM.js");return{MockCadenceSensor:s}},[]),e=new t;return await e.connect(),window.mockSensor=e,e}return T.isNativePlatform()?Jt(n):Zt(n)},connectSpeed:async()=>{if(T.isNativePlatform())throw new Error("Native speed connection not implemented");return ke()},connectTreadmill:async n=>T.isNativePlatform()?Kt(n):Qt(n),connectRowing:async()=>{if(T.isNativePlatform())throw new Error("Native rowing connection not implemented");return Xt()},connectConcept2:async()=>{if(T.isNativePlatform())throw new Error("Native rowing connection not implemented");return Ae()},connectSkiErg:async()=>{if(T.isNativePlatform())throw new Error("Native ski erg connection not implemented");return Ae()},connectCsc:async()=>{if(T.isNativePlatform())throw new Error("Native CSC connection not implemented");return ke()},connectRunningSensor:async()=>{if(T.isNativePlatform())throw new Error("Native RSC connection not implemented");return an()},connectCrossTrainer:async()=>{if(T.isNativePlatform())throw new Error("Native cross trainer connection not implemented");return en()},connectIndoorBike:async()=>{if(T.isNativePlatform())throw new Error("Native indoor bike connection not implemented");return tn()},connectWeightScale:async()=>{if(T.isNativePlatform())throw new Error("Native weight scale connection not implemented");return nn()},connectStepClimber:async()=>{if(T.isNativePlatform())throw new Error("Native step climber connection not implemented");return sn()}};export{We as A,fn as B,T as C,He as D,Fe as E,gt as F,wt as G,on as H,mt as I,un as J,dn as K,Ze as L,cn as M,me as W,V as _,dt as a,qe as b,Oe as c,$e as d,St as e,je as f,ze as g,Lt as h,yt as i,oe as j,Ct as k,bt as l,Et as m,we as n,W as o,ln as p,Je as q,se as r,st as s,pt as t,Ge as u,I as v,Se as w,Ye as x,Ke as y,Ve as z};
//# sourceMappingURL=feature-bluetooth-BY8rQx0J.js.map
