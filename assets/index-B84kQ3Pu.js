const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-CJGXvFlo.js","assets/feature-bluetooth-WlFmxkI9.js","assets/HistoryView-DlKmdFTE.js","assets/vendor-core-Dob3nYDb.js","assets/feature-export-7zlEGvkQ.js","assets/vendor-leaflet-3-yx3GaH.js","assets/WorkoutsView-COFh_3vB.js","assets/SettingsView-k6xUfe0o.js","assets/screens-D6jiR1Sk.js","assets/PlansView-DKWPP074.js","assets/DebugView-BFoX_IKj.js","assets/MetricDisplay-BfXrPd_G.js","assets/shared-DoXdG5VT.js","assets/elementCache-Cg-Rl8c9.js","assets/PowerGauge-qRg1R1d9.js","assets/ZoneGauge-ipmL3gGm.js","assets/LiveChart-Cwz1YVA7.js","assets/WorkoutTimer-Be8nDo8q.js","assets/Modal-CQ5JUH4A.js","assets/DataFieldComponent-Dcvj5OLm.js","assets/DataScreenComponent-BF5-kXqr.js","assets/ScreenCarouselComponent-BovDvLZo.js","assets/FieldPickerComponent-d7Wn2bpv.js","assets/ScreenEditorComponent-BujVgPqb.js","assets/ProfileSettingsComponent-Bv4PusqM.js"])))=>i.map(i=>d[i]);
import{i as Je,f as Xe,t as Yt,c as yt,r as vt,_ as T,C as Oe,g as x,a as jt,h as Gt,l as Jt,B as ke}from"./feature-bluetooth-WlFmxkI9.js";import{o as Xt}from"./vendor-core-Dob3nYDb.js";import{m as wt,g as bt}from"./feature-export-7zlEGvkQ.js";import{r as Qt,g as en}from"./vendor-leaflet-3-yx3GaH.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const Ve=new Map,fe=new Set;let Ne=null;function $(n,e){const t=n.toUpperCase();if(customElements.get(n)){console.warn(`Component ${n} is already defined.`);return}Ve.set(t,e),Ne||tn(),St(t)}function tn(){Ne=new MutationObserver(n=>{let e=!1;for(const t of n)if(t.addedNodes.length>0){e=!0;break}e&&nn()}),Ne.observe(document.body,{childList:!0,subtree:!0})}function nn(){for(const n of Ve.keys())fe.has(n)||St(n)}function St(n){document.querySelector(n)&&sn(n)}async function sn(n){if(fe.has(n))return;fe.add(n);const e=Ve.get(n);if(e)try{await e()}catch(t){console.error(`Failed to lazy load component ${n}:`,t),fe.delete(n)}}class on{metrics=[];marks=new Map;constructor(){typeof window<"u"&&"PerformanceObserver"in window&&(this.observeWebVitals(),this.observeLongTasks())}observeWebVitals(){try{new PerformanceObserver(t=>{for(const s of t.getEntries())s.name==="first-contentful-paint"&&this.record("FCP",s.startTime)}).observe({entryTypes:["paint"]}),new PerformanceObserver(t=>{const s=t.getEntries(),o=s[s.length-1];this.record("LCP",o.startTime)}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(t=>{for(const s of t.getEntries())if(s.processingStart){const o=s.processingStart-s.startTime;this.record("FID",o)}}).observe({entryTypes:["first-input"]});let e=0;new PerformanceObserver(t=>{for(const s of t.getEntries())s.hadRecentInput||(e+=s.value,this.record("CLS",e))}).observe({entryTypes:["layout-shift"]})}catch(e){console.warn("PerformanceObserver not supported or failed to start",e)}}observeLongTasks(){try{new PerformanceObserver(e=>{for(const t of e.getEntries())t.duration>50&&this.record("LongTask",t.duration)}).observe({entryTypes:["longtask"]})}catch{}}mark(e){typeof performance>"u"||this.marks.set(e,performance.now())}measure(e,t){if(typeof performance>"u")return 0;const s=this.marks.get(t);if(s===void 0)return 0;const o=performance.now()-s;return this.record(e,o),o}record(e,t){this.metrics.push({name:e,value:t,timestamp:Date.now()})}getMetrics(){return[...this.metrics]}getSummary(){const e={};for(const t of this.metrics)e[t.name]||(e[t.name]={total:0,max:0,count:0}),e[t.name].total+=t.value,e[t.name].max=Math.max(e[t.name].max,t.value),e[t.name].count++;return Object.fromEntries(Object.entries(e).map(([t,s])=>[t,{avg:s.total/s.count,max:s.max,count:s.count}]))}}new on;const U={heartrate:{min:0,max:300},power:{min:0,max:3e3},cadence:{min:0,max:300},speed:{min:0,max:150},distance:{min:0,max:1e6},altitude:{min:-500,max:9e3}},Le={weight:75,height:175,age:30,gender:"other",ftp:200,maxHeartrate:190,restingHeartrate:60,units:"metric",dateFormat:"ISO",clockFormat:"24h",energyMethod:"combined",gapThreshold:20,stalenessThreshold:5,powerZones:[{name:"Recovery",min:0,max:55,color:"#808080"},{name:"Endurance",min:55,max:75,color:"#2196f3"},{name:"Tempo",min:75,max:90,color:"#4caf50"},{name:"Threshold",min:90,max:105,color:"#ffeb3b"},{name:"VO2max",min:105,max:120,color:"#ff9800"},{name:"Anaerobic",min:120,max:150,color:"#f44336"},{name:"Neuromuscular",min:150,max:1e3,color:"#9c27b0"}],heartrateZones:[{name:"Recovery",min:0,max:60,color:"#808080"},{name:"Endurance",min:60,max:70,color:"#2196f3"},{name:"Tempo",min:70,max:80,color:"#4caf50"},{name:"Threshold",min:80,max:90,color:"#ff9800"},{name:"VO2max",min:90,max:100,color:"#f44336"}]};class an{settings={...Le};listeners=[];db=null;initialized=!1;async initialize(){if(!this.initialized){try{this.db=await Xt("bpt-settings",1,{upgrade(t){t.createObjectStore("settings")}});const e=await this.db.get("settings","user");e&&(this.settings={...Le,...e})}catch(e){console.warn("Settings storage unavailable, using defaults/in-memory:",e)}this.initialized=!0,this.notifyListeners()}}get(e){return this.settings[e]}getAll(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.persist(),this.notifyListeners()}async setMultiple(e){this.settings={...this.settings,...e},await this.persist(),this.notifyListeners()}async reset(){this.settings={...Le},await this.persist(),this.notifyListeners()}onChange(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t!==-1&&this.listeners.splice(t,1)}}async persist(){if(this.db)try{await this.db.put("settings",this.settings,"user")}catch(e){console.error("Failed to save settings:",e)}}notifyListeners(){const e=this.getAll();for(const t of this.listeners)try{t(e)}catch(s){console.error("Settings listener error:",s)}}}const j=new an;class rn{handlers=new Map;on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{this.handlers.get(e)?.delete(t)}}emit(e,t){const s=this.handlers.get(e);if(s)for(const o of s)try{o(t)}catch(a){console.error(`Event handler error for ${e}:`,a)}}off(e,t){this.handlers.get(e)?.delete(t)}clear(){this.handlers.clear()}}const G=new rn;class cn{lastPoint=null;totalDistance=0;lapDistance=0;constructor(){G.on("gps:update",e=>{this.handleGPSUpdate(e)}),G.on("lap:complete",()=>{this.lapDistance=0}),G.on("workout:start",()=>{this.reset()})}handleGPSUpdate(e){const t={latitude:e.latitude,longitude:e.longitude,timestamp:e.timestamp};if(this.lastPoint){const s=this.calculateDistance(this.lastPoint,t),o=(t.timestamp-this.lastPoint.timestamp)/1e3;if(o>0){const a=50*o;s<=a&&(this.totalDistance+=s,this.lapDistance+=s,G.emit("distance:update",{timestamp:t.timestamp,value:this.totalDistance}))}}this.lastPoint=t}calculateDistance(e,t){const o=e.latitude*Math.PI/180,a=t.latitude*Math.PI/180,i=(t.latitude-e.latitude)*Math.PI/180,c=(t.longitude-e.longitude)*Math.PI/180,r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(o)*Math.cos(a)*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}reset(){this.lastPoint=null,this.totalDistance=0,this.lapDistance=0}setTotalDistance(e){this.totalDistance=e}getTotalDistance(){return this.totalDistance}getLapDistance(){return this.lapDistance}}const Qe=new cn;function ln(n,e){return n<=0||e<=0?0:n*e/1e3}function dn(n,e,t){if(n<=0||e<=0||t<=0)return 0;const s=30,o=t/60,a=s*.2017,i=e*.1988,c=n*.6309,r=(a+i+c-55.0969)/4.184;return Math.max(0,r*o)}const un={minInterval:100,maxInterval:1e3,idleInterval:2e3,visibilityAware:!0};class mn{config;currentInterval;lastDataChange=0;updateTimer=null;isVisible=!0;subscribers=new Set;cleanupVisibilityListener=null;constructor(e={}){if(this.config={...un,...e},this.currentInterval=this.config.minInterval,this.config.visibilityAware&&typeof document<"u"){const t=this.handleVisibilityChange.bind(this);document.addEventListener("visibilitychange",t),this.cleanupVisibilityListener=()=>document.removeEventListener("visibilitychange",t)}}handleVisibilityChange(){typeof document>"u"||(this.isVisible=document.visibilityState==="visible",this.isVisible?(this.currentInterval=this.config.minInterval,this.scheduleUpdate()):this.currentInterval=this.config.maxInterval)}notifyDataChange(){this.lastDataChange=Date.now(),this.currentInterval>this.config.minInterval&&(this.currentInterval=this.config.minInterval,this.scheduleUpdate())}subscribe(e){return this.subscribers.add(e),this.subscribers.size===1&&this.scheduleUpdate(),()=>{this.subscribers.delete(e),this.subscribers.size===0&&this.updateTimer&&(clearTimeout(this.updateTimer),this.updateTimer=null)}}scheduleUpdate(){this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.update()},this.currentInterval),this.updateTimer&&typeof this.updateTimer=="object"&&"unref"in this.updateTimer&&this.updateTimer.unref()}update(){const e=Date.now();for(const s of this.subscribers)try{s()}catch(o){console.error("Update callback error:",o)}const t=e-this.lastDataChange;t>5e3?this.currentInterval=Math.min(this.currentInterval*1.5,this.config.idleInterval):t<1e3&&(this.currentInterval=this.config.minInterval),this.isVisible||(this.currentInterval=this.config.maxInterval),this.subscribers.size>0&&this.scheduleUpdate()}destroy(){this.updateTimer&&clearTimeout(this.updateTimer),this.subscribers.clear(),this.cleanupVisibilityListener&&this.cleanupVisibilityListener()}}const ve=new mn({minInterval:100,maxInterval:1e3,idleInterval:2e3,visibilityAware:!0});class pn{heartrate=[];power=[];cadence=[];speed=[];distance=[];altitude=[];energy=[];gps=[];treadmill=[];treadmillSpeed=[];laps=[];_persistenceEnabled;_startTime=null;_onChangeCallbacks=[];_lastEnergyTime=0;_lastPowerTime=0;_totalEnergy=0;constructor(e=!0){this._persistenceEnabled=e&&Je(),ve.subscribe(()=>{this._dispatchUpdates()}),j.onChange(t=>{this.onSettingsChange(t)}),G.on("distance:update",t=>{this._startTime&&this.addDistance({timestamp:t.timestamp,value:t.value})}),typeof window<"u"&&typeof window.addEventListener=="function"&&typeof document<"u"&&(window.addEventListener("beforeunload",()=>{Xe()}),document.addEventListener("visibilitychange",()=>{document.hidden&&Xe()}))}setStartTime(e){this._startTime=e}getStartTime(){return this._startTime}onChange(e){this._onChangeCallbacks.push(e)}offChange(e){const t=this._onChangeCallbacks.indexOf(e);t>-1&&this._onChangeCallbacks.splice(t,1)}get userWeight(){return j.get("weight")}get gapThreshold(){return j.get("gapThreshold")*1e3}onSettingsChange(e){}_updateEnergy(e,t,s){const o=j.get("energyMethod");if(o==="power"&&s!=="power"||o==="heartrate"&&s!=="heartrate")return;if(o==="combined")if(s==="heartrate"){if(e-this._lastPowerTime<this.gapThreshold)return}else s==="power"&&(this._lastPowerTime=e);if(this._lastEnergyTime===0||e-this._lastEnergyTime>this.gapThreshold){this._lastEnergyTime=e;return}const a=(e-this._lastEnergyTime)/1e3;if(a<=0)return;let i=0;s==="power"?i=ln(t,a):i=dn(t,this.userWeight,a),i>0&&(this._totalEnergy+=i,this.energy.push({timestamp:e,value:this._totalEnergy})),this._lastEnergyTime=e}_dispatchUpdates(){for(const e of this._onChangeCallbacks)try{e(this)}catch(t){console.error("State change callback error:",t)}}_notifyChange(){ve.notifyDataChange(),this._persistenceEnabled&&Yt(this.toJSON(),this._startTime)}addHeartrate(e){const{min:t,max:s}=U.heartrate;if(e.value<=t||e.value>=s){console.warn(`Invalid heartrate value: ${e.value}`);return}this.heartrate.push({timestamp:e.timestamp,value:e.value}),(this._lastPowerTime===0||e.timestamp-this._lastPowerTime>5e3)&&this._updateEnergy(e.timestamp,e.value,"heartrate"),this._notifyChange()}addPower(e){const{min:t,max:s}=U.power;if(e.value<t||e.value>=s){console.warn(`Invalid power value: ${e.value}`);return}this.power.push({timestamp:e.timestamp,value:e.value}),this._lastPowerTime=e.timestamp,this._updateEnergy(e.timestamp,e.value,"power"),this._notifyChange()}addCadence(e){const{min:t,max:s}=U.cadence;if(e.value<t||e.value>=s){console.warn(`Invalid cadence value: ${e.value}`);return}this.cadence.push({timestamp:e.timestamp,value:e.value}),this._notifyChange()}addSpeed(e){const{min:t,max:s}=U.speed;if(e.value<t||e.value>=s){console.warn(`Invalid speed value: ${e.value}`);return}this.speed.push({timestamp:e.timestamp,value:e.value}),this._notifyChange()}addDistance(e){const{min:t,max:s}=U.distance;if(e.value<t||e.value>=s){console.warn(`Invalid distance value: ${e.value}`);return}this.distance.push({timestamp:e.timestamp,value:e.value}),this._notifyChange()}addAltitude(e){const{min:t,max:s}=U.altitude;if(e.value<t||e.value>=s){console.warn(`Invalid altitude value: ${e.value}`);return}this.altitude.push({timestamp:e.timestamp,value:e.value}),this._notifyChange()}addTreadmillSpeed(e){const{min:t,max:s}=U.speed;if(e.value<t||e.value>=s){console.warn(`Invalid treadmill speed value: ${e.value}`);return}this.treadmillSpeed.push({timestamp:e.timestamp,value:e.value}),this._notifyChange()}addGps(e){this.gps.push(e),G.emit("gps:update",{timestamp:e.timestamp,latitude:e.lat,longitude:e.lon,altitude:e.altitude!==null?e.altitude:void 0}),e.speed!==null&&this.addSpeed({timestamp:e.timestamp,value:e.speed*3.6}),e.altitude!==null&&this.addAltitude({timestamp:e.timestamp,value:e.altitude}),this._notifyChange()}add(e,t){switch(e){case"heartrate":this.addHeartrate(t);break;case"power":this.addPower(t);break;case"cadence":this.addCadence(t);break;case"speed":this.addSpeed(t);break;case"distance":this.addDistance(t);break;case"altitude":this.addAltitude(t);break;case"treadmillSpeed":this.addTreadmillSpeed(t);break;default:throw new Error(`Unknown measurement type: ${e}`)}}async clear(e=!0){this.heartrate=[],this.power=[],this.cadence=[],this.speed=[],this.distance=[],this.altitude=[],this.treadmillSpeed=[],this.laps=[],this._startTime=null,e&&this._persistenceEnabled&&await yt(),this._notifyChange()}addLap(e){const t=Date.now(),s=this.laps.length+1,o={timestamp:t,number:s,elapsedMs:e?t-e:void 0};return this.laps.push(o),this._notifyChange(),o}getLapCount(){return this.laps.length}toJSON(){return{heartrate:[...this.heartrate],power:[...this.power],cadence:[...this.cadence],speed:[...this.speed],distance:[...this.distance],altitude:[...this.altitude],treadmillSpeed:[...this.treadmillSpeed],gps:[...this.gps],laps:[...this.laps]}}restore(e,t){this.heartrate=[...e.heartrate||[]],this.power=[...e.power||[]],this.cadence=[...e.cadence||[]],this.speed=[...e.speed||[]],this.distance=[...e.distance||[]],this.altitude=[...e.altitude||[]],this.treadmillSpeed=[...e.treadmillSpeed||[]],this.laps=[...e.laps||[]],this._startTime=t,this.distance.length>0?Qe.setTotalDistance(this.distance[this.distance.length-1].value):Qe.setTotalDistance(0);for(const s of this._onChangeCallbacks)try{s(this)}catch(o){console.error("State change callback error:",o)}}setPersistenceEnabled(e){this._persistenceEnabled=e&&Je()}hasData(){return this.heartrate.length>0||this.power.length>0||this.cadence.length>0}getCounts(){return{heartrate:this.heartrate.length,power:this.power.length,cadence:this.cadence.length,speed:this.speed.length,distance:this.distance.length,altitude:this.altitude.length,gps:this.gps.length,treadmillSpeed:this.treadmillSpeed.length,energy:this.energy.length}}addTreadmillData(e){if(this.treadmill.push(e),e.speed!=null){const t={timestamp:e.timestamp,value:e.speed};this.addTreadmillSpeed(t),this.addSpeed(t)}e.speed==null&&this._notifyChange()}}let de=null;function hn(){return de?(console.warn("State already initialized"),de):(de={measurementsState:new pn,connectionsState:{power:{isConnected:!1,disconnect:null},heartrate:{isConnected:!1,disconnect:null},cadence:{isConnected:!1,disconnect:null},speed:{isConnected:!1,disconnect:null},gps:{isConnected:!1,disconnect:null},treadmill:{isConnected:!1,disconnect:null}},timeState:{running:!1,startTime:null,endTime:null},settings:j},j.initialize(),de)}function fn({measurementsState:n,connectionsState:e}){typeof window<"u"&&(window.bike=n,window.connectionsState=e)}const et=vt("App",{web:()=>T(()=>import("./web-CJGXvFlo.js"),__vite__mapDeps([0,1])).then(n=>new n.AppWeb)});class gn{views=new Map;lazyViews=new Map;routes=[];currentViewId=null;container;isNative;constructor(e){this.container=e,this.isNative=Oe.isNativePlatform(),window.addEventListener("popstate",()=>{this.handleLocationChange()}),this.isNative&&window.addEventListener("hashchange",()=>{this.handleLocationChange()}),this.isNative&&et.addListener("backButton",({canGoBack:t})=>{t?window.history.back():et.exitApp()})}registerView(e){this.views.set(e.id,e);let t=document.getElementById(`page-${e.id}`);t||(t=document.createElement("div"),t.id=`page-${e.id}`,t.className="page-view",t.style.display="none",this.container.appendChild(t)),e.init(t)}registerLazyView(e,t){this.lazyViews.set(e,t)}addRoute(e,t){this.routes.push({path:e,viewId:t})}navigate(e,t=!1){this.isNative?t?window.location.replace("#"+e):window.location.hash=e:(t?window.history.replaceState({},"",e):window.history.pushState({},"",e),this.handleLocationChange())}start(){this.isNative&&(window.location.hash||(window.location.hash="/")),this.handleLocationChange()}back(){window.history.back()}async handleLocationChange(){let e;if(this.isNative){const s=window.location.hash;e=s?s.slice(1):"/",(!e||e==="")&&(e="/")}else e=window.location.pathname,(e.endsWith("/index.html")||e.endsWith(".html"))&&(e="/");let t=this.routes.find(s=>s.path===e);t||(t=this.routes.find(s=>s.path==="/")||this.routes[0]),t&&await this.switchView(t.viewId)}async switchView(e){if(this.currentViewId===e)return;if(!this.views.has(e)){const s=this.lazyViews.get(e);if(s)try{const o=await s();this.registerView(o)}catch(o){console.error(`Failed to load view for ${e}:`,o);return}else{console.warn(`View ${e} not registered.`);return}}if(this.currentViewId){const s=this.views.get(this.currentViewId);if(s){s.onLeave();const o=document.getElementById(`page-${this.currentViewId}`);o&&(o.style.display="none")}}const t=this.views.get(e);if(t){const s=document.getElementById(`page-${e}`);s&&(s.style.display=""),t.onEnter(),this.currentViewId=e,window.dispatchEvent(new CustomEvent("route-changed",{detail:{viewId:e}}))}}}class yn{id="dashboard";init(e){console.log("Dashboard View initialized")}onEnter(){console.log("Entered Dashboard View")}onLeave(){console.log("Left Dashboard View")}}var k=(n=>(n.Dashboard="dashboard",n.History="history",n.Workouts="workouts",n.Settings="settings",n.Plans="plans",n.Debug="debug",n))(k||{});class vn{container;router;constructor(e){this.router=e,this.container=document.createElement("nav"),this.container.id="bottom-nav",this.container.className="bottom-nav",this.render(),document.body.appendChild(this.container),window.addEventListener("route-changed",t=>{const s=t.detail;this.setActive(s.viewId)})}render(){this.container.innerHTML=`
            <button class="nav-item active" data-target="${k.Dashboard}" data-testid="nav-dashboard">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button class="nav-item" data-target="${k.History}" data-testid="nav-history">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">History</span>
            </button>
            <button class="nav-item" data-target="${k.Workouts}" data-testid="nav-workouts">
                <span class="nav-icon">üèãÔ∏è</span>
                <span class="nav-label">Workouts</span>
            </button>
            <button class="nav-item" data-target="${k.Plans}" data-testid="nav-plans">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">Plans</span>
            </button>
            <button class="nav-item" data-target="${k.Settings}" data-testid="nav-settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </button>
            <button class="nav-item" data-target="${k.Debug}" data-testid="nav-debug">
                <span class="nav-icon">üòÑ</span>
                <span class="nav-label">Debug</span>
            </button>
        `,this.container.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target;t===k.Dashboard?this.router.navigate("/"):t&&this.router.navigate("/"+t)})})}setActive(e){this.container.querySelectorAll(".nav-item").forEach(t=>{t.dataset.target===e?(t.classList.add("active"),t.setAttribute("aria-current","page")):(t.classList.remove("active"),t.removeAttribute("aria-current"))})}}function B(n){const e=document.getElementById(n);if(!e)throw new Error(`Critical DOM element missing: #${n}. Ensure index.html is correct.`);return e}function wn(){const n=new gn(B("mainContent")),e=new yn;n.registerView(e),n.registerLazyView(k.History,()=>T(()=>import("./HistoryView-DlKmdFTE.js"),__vite__mapDeps([2,1,3,4,5])).then(a=>new a.HistoryView)),n.registerLazyView(k.Workouts,()=>T(()=>import("./WorkoutsView-COFh_3vB.js"),__vite__mapDeps([6,1,3,4,5])).then(a=>new a.WorkoutsView)),n.registerLazyView(k.Settings,()=>T(()=>import("./SettingsView-k6xUfe0o.js"),__vite__mapDeps([7,1,8,3,4,5])).then(a=>new a.SettingsView)),n.registerLazyView(k.Plans,()=>T(()=>import("./PlansView-DKWPP074.js"),__vite__mapDeps([9,1,3,4,5])).then(a=>new a.PlansView)),n.registerLazyView(k.Debug,()=>T(()=>import("./DebugView-BFoX_IKj.js"),__vite__mapDeps([10,1,3,4,5])).then(a=>new a.DebugView)),n.addRoute("/",k.Dashboard),n.addRoute("/history",k.History),n.addRoute("/workouts",k.Workouts),n.addRoute("/plans",k.Plans),n.addRoute("/settings",k.Settings),n.addRoute("/debug",k.Debug),new vn(n);const t=document.getElementById("settingsButton");t&&t.addEventListener("click",()=>{n.navigate("/settings");const a=document.querySelector("nav details");a&&(a.open=!1)});const s=document.getElementById("workoutsButton");s&&s.addEventListener("click",()=>{n.navigate("/workouts");const a=document.querySelector("nav details");a&&(a.open=!1)});const o=document.getElementById("plansButton");return o&&o.addEventListener("click",()=>{n.navigate("/plans");const a=document.querySelector("nav details");a&&(a.open=!1)}),n}const we=n=>{const e=Math.floor(n/1e3),t=Math.floor(e/3600),s=Math.floor(e%3600/60),o=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`};function y(n,e="polite"){const t=document.getElementById("srAnnouncements");t&&(t.setAttribute("aria-live",e),t.textContent=n,setTimeout(()=>{t.textContent=""},1e3))}const Et=[];function z(n){Et.push(n)}function bn(n){const e=n.target;if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable){n.key==="Escape"&&e.blur();return}for(const t of Et){const s=n.key.toLowerCase()===t.key.toLowerCase(),o=t.ctrl?n.ctrlKey||n.metaKey:!n.ctrlKey&&!n.metaKey,a=t.shift?n.shiftKey:!n.shiftKey,i=t.alt?n.altKey:!n.altKey;if(s&&o&&a&&i){n.preventDefault(),t.action();return}}}function Sn(){z({key:" ",description:"Start/pause/resume workout (context-aware)",action:()=>{const e=document.getElementById("startButton"),t=document.getElementById("pauseButton"),s=document.getElementById("resumeButton");e&&e.style.display!=="none"?e.click():t&&t.style.display!=="none"?t.click():s&&s.style.display!=="none"&&s.click()}}),z({key:"Escape",description:"Close modal or menu",action:()=>{const e=document.querySelectorAll('.stream-modal[style*="display: block"], .stream-modal:not([style*="display: none"])');for(const s of e)if(s.style.display!=="none"){const o=s.querySelector(".close-button");if(o){o.click(),y("Dialog closed");return}}const t=document.querySelector("details[open]");t&&(t.removeAttribute("open"),y("Menu closed"))}}),z({key:"m",description:"Toggle menu",action:()=>{const e=document.querySelector("header details");if(e)if(e.hasAttribute("open"))e.removeAttribute("open"),y("Menu closed");else{e.setAttribute("open",""),y("Menu opened");const s=e.querySelector("#controls button");s&&s.focus()}}}),z({key:"s",description:"Open settings",action:()=>{const e=document.getElementById("settingsButton");e&&(e.click(),y("Settings opened"))}}),z({key:"h",description:"Open workout history",action:()=>{const e=window.router;if(e)e.navigate("/history"),y("Workout history opened");else{const t=document.getElementById("workoutHistoryButton");t&&(t.click(),y("Workout history opened"))}}}),z({key:"e",description:"Export workout data",action:()=>{const e=document.getElementById("exportData");e&&e.click()}}),z({key:"l",description:"Mark lap",action:()=>{const e=document.getElementById("lapButton");e&&e.click()}}),document.addEventListener("keydown",bn);const n=document.querySelector("header summary");n&&n.setAttribute("aria-keyshortcuts","M"),console.log("Keyboard navigation initialized")}function En(n){const e=n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(e.length===0)return;const t=e[0],s=e[e.length-1];t.focus(),n.addEventListener("keydown",o=>{o.key==="Tab"&&(o.shiftKey?document.activeElement===t&&(o.preventDefault(),s.focus()):document.activeElement===s&&(o.preventDefault(),t.focus()))})}function be(n){const e=document.getElementById("startButton"),t=document.getElementById("pauseButton"),s=document.getElementById("resumeButton"),o=document.getElementById("stopButton");e&&e.setAttribute("aria-label","Start workout"),t&&t.setAttribute("aria-label","Pause workout"),s&&s.setAttribute("aria-label","Resume workout"),o&&o.setAttribute("aria-label","Stop and save workout");const a=document.getElementById("workoutControls");a&&a.setAttribute("data-workout-state",n)}const Tn=(n,e,t)=>Array.from({length:t}).map((s,o)=>{const a=n+o*e;return{type:"active",duration:60,target:{type:"power",unit:"watts",value:a},name:`Step ${o+1}`,description:`${a} Watts`}}),Cn={id:"ramp-test",name:"Ramp Test",description:"Standard Ramp Test to estimate FTP. Start at 100W, increase by 20W every minute until failure.",tags:["test","ftp"],category:"Testing",steps:[{type:"warmup",duration:300,target:{type:"open",unit:"watts",min:80,max:120},description:"Free warmup"},...Tn(100,20,25)]},kn={id:"sweet-spot-3x10",name:"Sweet Spot 3x10",description:"Classic Sweet Spot workout. 3 intervals of 10 minutes at 90% FTP.",tags:["sweet-spot","aerobic"],category:"Sweet Spot",steps:[{type:"warmup",duration:600,target:{type:"power",unit:"percent_ftp",value:50},name:"Warmup"},{type:"active",duration:600,target:{type:"power",unit:"percent_ftp",value:90},name:"Sweet Spot"},{type:"recovery",duration:300,target:{type:"power",unit:"percent_ftp",value:50},name:"Recovery"},{type:"active",duration:600,target:{type:"power",unit:"percent_ftp",value:90},name:"Sweet Spot"},{type:"recovery",duration:300,target:{type:"power",unit:"percent_ftp",value:50},name:"Recovery"},{type:"active",duration:600,target:{type:"power",unit:"percent_ftp",value:90},name:"Sweet Spot"},{type:"cooldown",duration:600,target:{type:"power",unit:"percent_ftp",value:50},name:"Cooldown"}]},In={id:"vo2-30-30",name:"VO2 Max 30/30s",description:"High intensity intervals. 2 sets of 8x 30s ON / 30s OFF.",tags:["vo2max","hiit"],category:"VO2 Max",steps:[{type:"warmup",duration:600,target:{type:"power",unit:"percent_ftp",value:50},name:"Warmup"},{type:"warmup",duration:60,target:{type:"power",unit:"percent_ftp",value:100},name:"Opener"},{type:"rest",duration:120,target:{type:"power",unit:"percent_ftp",value:50},name:"Recover"},...Array.from({length:8}).flatMap((n,e)=>[{type:"active",duration:30,target:{type:"power",unit:"percent_ftp",value:120},name:`Rep ${e+1}`},{type:"rest",duration:30,target:{type:"power",unit:"percent_ftp",value:50},name:"Float"}]),{type:"rest",duration:300,target:{type:"power",unit:"percent_ftp",value:50},name:"Set Recovery"},...Array.from({length:8}).flatMap((n,e)=>[{type:"active",duration:30,target:{type:"power",unit:"percent_ftp",value:120},name:`Rep ${e+1}`},{type:"rest",duration:30,target:{type:"power",unit:"percent_ftp",value:50},name:"Float"}]),{type:"cooldown",duration:600,target:{type:"power",unit:"percent_ftp",value:40},name:"Cooldown"}]},xn=[Cn,kn,In];function Ln(n){return n.steps.reduce((e,t)=>e+t.duration,0)}const Tt="bpt-user-profile",Me={ftp:null,maxHr:null,weight:null,onboardingComplete:!1,lastUpdated:null};function Ue(){try{if(typeof localStorage>"u")return{...Me};const n=localStorage.getItem(Tt);if(n)return{...Me,...JSON.parse(n)}}catch(n){console.warn("Failed to load user profile:",n)}return{...Me}}function tt(n){try{if(typeof localStorage>"u"){console.warn("localStorage not available, profile not saved");return}n.lastUpdated=Date.now(),localStorage.setItem(Tt,JSON.stringify(n))}catch(e){console.warn("Failed to save user profile:",e)}}class Mn{audioCtx=null;gainNode=null;isMuted=!1;constructor(){}init(){this.ensureContext()}ensureContext(){if(!this.audioCtx){const e=window.AudioContext||window.webkitAudioContext;e&&(this.audioCtx=new e,this.gainNode=this.audioCtx.createGain(),this.gainNode.connect(this.audioCtx.destination),this.gainNode.gain.value=.5)}this.audioCtx&&this.audioCtx.state==="suspended"&&this.audioCtx.resume()}setMuted(e){this.isMuted=e}beep(e=440,t=200,s="sine"){if(this.isMuted||(this.ensureContext(),!this.audioCtx||!this.gainNode))return;const o=this.audioCtx.createOscillator(),a=this.audioCtx.createGain();o.type=s,o.frequency.setValueAtTime(e,this.audioCtx.currentTime),a.gain.setValueAtTime(0,this.audioCtx.currentTime),a.gain.linearRampToValueAtTime(.5,this.audioCtx.currentTime+.01),a.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+t/1e3),o.connect(a),a.connect(this.gainNode),o.start(),o.stop(this.audioCtx.currentTime+t/1e3)}playCountdown(){this.beep(440,150)}playStart(){this.beep(880,400)}playSuccess(){if(this.isMuted||(this.ensureContext(),!this.audioCtx||!this.gainNode))return;const e=this.audioCtx.currentTime;this.scheduleNote(523.25,e,.1),this.scheduleNote(659.25,e+.1,.1),this.scheduleNote(783.99,e+.2,.2)}scheduleNote(e,t,s){if(!this.audioCtx||!this.gainNode)return;const o=this.audioCtx.createOscillator(),a=this.audioCtx.createGain();o.frequency.value=e,a.gain.setValueAtTime(0,t),a.gain.linearRampToValueAtTime(.3,t+.01),a.gain.exponentialRampToValueAtTime(.001,t+s),o.connect(a),a.connect(this.gainNode),o.start(t),o.stop(t+s)}speak(e){if(this.isMuted||!window.speechSynthesis)return;window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.rate=1,t.pitch=1,t.volume=1,window.speechSynthesis.speak(t)}}const ge=new Mn;class _n{state;timerInterval=null;onStateChange=null;userFtp=200;constructor(e,t){if(t?.userFtp)this.userFtp=t.userFtp;else try{const o=Ue();o.ftp&&(this.userFtp=o.ftp)}catch{}const s=e.steps.reduce((o,a)=>o+a.duration,0);this.state={workout:e,isRunning:!1,isPaused:!0,isFinished:!1,currentStepIndex:0,startTime:null,stepElapsedTime:0,stepTimeRemaining:e.steps[0].duration,totalElapsedTime:0,totalDuration:s,currentStep:e.steps[0],nextStep:e.steps.length>1?e.steps[1]:null,totalSteps:e.steps.length,currentAbsoluteTarget:void 0},this.updateCurrentTarget()}getWorkoutName(){return this.state.workout.name}setCallback(e){this.onStateChange=e,e(this.state)}start(){this.state.isFinished||this.state.isRunning&&!this.state.isPaused||(this.state.startTime||(this.state.startTime=Date.now()),this.state.isRunning=!0,this.state.isPaused=!1,this.emitState(),this.timerInterval=setInterval(()=>{this.tick()},1e3))}pause(){this.state.isPaused=!0,this.state.isRunning=!1,this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.emitState()}nextStep(){this.advanceStep()}stop(){this.pause(),this.onStateChange=null}tick(){this.state.isPaused||this.state.isFinished||(this.state.stepElapsedTime++,this.state.totalElapsedTime++,this.state.stepTimeRemaining=Math.max(0,this.state.currentStep.duration-this.state.stepElapsedTime),this.updateCurrentTarget(),this.state.stepTimeRemaining<=3&&this.state.stepTimeRemaining>0&&this.safePlaySound("countdown"),this.state.stepElapsedTime>=this.state.currentStep.duration?this.advanceStep():this.emitState())}advanceStep(){const e=this.state.currentStepIndex+1;if(e>=this.state.workout.steps.length){this.finish();return}this.state.currentStepIndex=e,this.state.currentStep=this.state.workout.steps[e],this.state.nextStep=e+1<this.state.workout.steps.length?this.state.workout.steps[e+1]:null,this.state.stepElapsedTime=0,this.state.stepTimeRemaining=this.state.currentStep.duration,this.updateCurrentTarget(),this.safePlaySound("start"),this.emitState()}finish(){this.state.isFinished=!0,this.state.isRunning=!1,this.pause(),this.safePlaySound("success"),this.emitState()}safePlaySound(e){try{e==="countdown"&&ge.playCountdown(),e==="start"&&ge.playStart(),e==="success"&&ge.playSuccess()}catch{}}updateCurrentTarget(){const e=this.state.currentStep;if(e.rampStart&&e.rampEnd){const t=this.resolveValue(e.rampStart.value,e.rampStart.unit),s=this.resolveValue(e.rampEnd.value,e.rampEnd.unit);if(t!==null&&s!==null){const o=this.state.stepElapsedTime/e.duration,a=t+(s-t)*o;this.state.currentAbsoluteTarget={type:e.rampStart.type,unit:"watts",value:Math.round(a),min:Math.round(a-5),max:Math.round(a+5)}}}else if(e.target){const t=this.resolveValue(e.target.value,e.target.unit),s=this.resolveValue(e.target.min,e.target.unit),o=this.resolveValue(e.target.max,e.target.unit);t!==null||s!==null&&o!==null?(this.state.currentAbsoluteTarget={type:e.target.type,unit:"watts",value:t||(s+o)/2,min:s||(t?t-10:0),max:o||(t?t+10:999)},e.target.type==="heartrate"&&(this.state.currentAbsoluteTarget.unit="bpm")):this.state.currentAbsoluteTarget=void 0}else this.state.currentAbsoluteTarget=void 0}resolveValue(e,t){return e===void 0?null:t==="watts"||t==="bpm"||t==="rpm"?e:t==="percent_ftp"?Math.round(this.userFtp*(e/100)):e}emitState(){this.onStateChange&&this.onStateChange({...this.state})}getState(){return{...this.state}}}const te="https://api.bikepowertracker.com",An="super-secret-bike-tracker-key";async function ie(n){try{const e=await n.json();return{status:n.status,message:e.error||e.message||"Unknown error",code:e.code,details:e.details}}catch{return{status:n.status,message:n.statusText||"Unknown error"}}}function ne(n={}){const e={...n};return e["X-API-Key"]=An,e}async function Pn(){try{const n=await fetch(`${te}/health`,{headers:ne()});return n.ok?(await n.json()).database==="connected":!1}catch{return!1}}async function Mi({streamName:n,title:e,sport:t="cycling",userId:s}){const o=await fetch(`${te}/api/workouts`,{method:"POST",headers:ne({"Content-Type":"application/json"}),body:JSON.stringify({streamName:n,title:e,sport:t,userId:s})});if(!o.ok){const a=await ie(o);throw new Error(a.message)}return o.json()}async function Dn({page:n=1,limit:e=20,status:t,userId:s,startDate:o,endDate:a,sport:i}={}){const c=new URLSearchParams;c.set("page",n.toString()),c.set("limit",e.toString()),t&&c.set("status",t),s&&c.set("userId",s),o&&c.set("startDate",o.toISOString()),a&&c.set("endDate",a.toISOString()),i&&c.set("sport",i);const r=await fetch(`${te}/api/workouts?${c}`,{headers:ne()});if(!r.ok){const l=await ie(r);throw new Error(l.message)}return r.json()}async function _i(n,e=!1){const t=new URLSearchParams;e&&t.set("includeTelemetry","true");const s=await fetch(`${te}/api/workouts/${n}?${t}`,{headers:ne()});if(!s.ok){const o=await ie(s);throw new Error(o.message)}return s.json()}async function Ai(n,e=!0){const t=await fetch(`${te}/api/workouts/${n}/complete`,{method:"POST",headers:ne({"Content-Type":"application/json"}),body:JSON.stringify({archiveTelemetry:e})});if(!t.ok){const s=await ie(t);throw new Error(s.message)}return t.json()}async function Pi(n){const e=await fetch(`${te}/api/workouts/${n}`,{method:"DELETE",headers:ne()});if(!e.ok){const t=await ie(e);throw new Error(t.message)}return e.json()}function Bn(n){if(!n)return"--";const e=Math.floor(n/3600),t=Math.floor(n%3600/60),s=n%60;return e>0?`${e}h ${t}m`:t>0?`${t}m ${s}s`:`${s}s`}function Di(n){return n?new Date(n).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"--"}const Ct="bpt_custom_workouts";function ze(){try{const n=localStorage.getItem(Ct);return n?JSON.parse(n):[]}catch(n){return console.error("Failed to load custom workouts",n),[]}}function kt(n){const e=ze(),t=e.findIndex(s=>s.id===n.id);t>=0?e[t]=n:e.push(n),It(e)}function $n(n){const t=ze().filter(s=>s.id!==n);It(t)}function It(n){try{localStorage.setItem(Ct,JSON.stringify(n))}catch(e){console.error("Failed to save custom workouts",e),alert("Failed to save workout. Storage might be full.")}}let P=null;function Bi(){On(),Nn(),Ie()}function Nn(){const n=document.getElementById("importWorkoutBtn"),e=document.getElementById("importWorkoutInput");n&&e&&(n.addEventListener("click",()=>{e.click()}),e.addEventListener("change",t=>{const s=t.target.files;s&&s.length>0&&(Fn(s[0]),e.value="")}))}async function Fn(n){try{const e=await n.text(),t=JSON.parse(e);if(!t.name||!Array.isArray(t.steps))throw new Error("Invalid workout format");t.id=crypto.randomUUID(),t.tags=[...t.tags||[],"imported"],kt(t),Ie(),y(`Imported workout: ${t.name}`,"assertive")}catch(e){console.error("Import failed",e),alert("Failed to import workout: Invalid file format.")}}function Rn(n){const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2)),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${n.name.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.json`),document.body.appendChild(t),t.click(),t.remove()}function Ie(){const n=document.getElementById("workoutList");if(!n)return;n.innerHTML="";const e=ze();if(e.length>0){const t=document.createElement("h3");t.textContent="My Workouts",t.style.margin="0 0 8px 0",t.style.fontSize="1rem",t.style.color="var(--color-text-secondary)",n.appendChild(t),e.forEach(a=>nt(a,n,!0));const s=document.createElement("hr");s.style.margin="16px 0",s.style.border="0",s.style.borderTop="1px solid var(--color-border)",n.appendChild(s);const o=document.createElement("h3");o.textContent="Library",o.style.margin="0 0 8px 0",o.style.fontSize="1rem",o.style.color="var(--color-text-secondary)",n.appendChild(o)}xn.forEach(t=>nt(t,n,!1))}function nt(n,e,t){const s=Ln(n),o=document.createElement("div");o.className="workout-item",o.setAttribute("role","button"),o.setAttribute("tabindex","0"),o.style.position="relative";let a="";a+=`<button class="export-workout-btn" aria-label="Export ${n.name}" title="Export JSON" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">üì§</button>`,t&&(a+=`<button class="delete-workout-btn" aria-label="Delete ${n.name}" title="Delete" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--color-error);">üóëÔ∏è</button>`);const i="position: absolute; right: 10px; top: 10px; display: flex; gap: 8px; z-index: 2;";o.innerHTML=`
        <div class="workout-item-header">
            <span class="workout-item-title">${n.name}</span>
            <span class="workout-item-duration">‚è±Ô∏è ${Bn(s*1e3)}</span>
        </div>
        <div class="workout-item-desc">${n.description}</div>
        <div class="workout-tags">
            ${(n.tags||[]).map(r=>`<span class="workout-tag">${r}</span>`).join("")}
        </div>
        <div style="${i}">
            ${a}
        </div>
    `,o.querySelector(".export-workout-btn")?.addEventListener("click",r=>{r.stopPropagation(),Rn(n)}),t&&o.querySelector(".delete-workout-btn")?.addEventListener("click",l=>{l.stopPropagation(),confirm(`Delete workout "${n.name}"?`)&&($n(n.id),Ie(),y(`Deleted workout: ${n.name}`,"assertive"))}),o.addEventListener("click",r=>{if(r.target.tagName==="BUTTON")return;st(n);const l=document.getElementById("workoutSelectionModal");l&&(l.style.display="none")}),o.addEventListener("keydown",r=>{if(r.key==="Enter"||r.key===" "){r.preventDefault(),st(n);const l=document.getElementById("workoutSelectionModal");l&&(l.style.display="none")}}),e.appendChild(o)}function st(n,e){if(P){if(!confirm("A workout is already active. Stop it and start this one?"))return;P.stop()}ge.init(),P=new _n(n);let t=!1;P.setCallback(o=>{Vn(o),o.isFinished&&!t&&e&&(t=!0,e())});const s=document.getElementById("workoutPlayerOverlay");s&&(s.style.display="block"),y(`Starting workout: ${n.name}. Ready to start.`,"assertive")}function On(){const n=document.getElementById("workoutPlayerOverlay"),e=document.getElementById("wpMinimize"),t=document.getElementById("wpClose"),s=document.getElementById("wpSkip");n&&(t?.addEventListener("click",()=>{P&&confirm("Stop current workout?")&&(P.stop(),P=null,n.style.display="none",y("Workout stopped","polite"))}),e?.addEventListener("click",()=>{const o=n.querySelector(".workout-player-body");if(o){const a=o.style.display==="none";o.style.display=a?"block":"none",e.textContent=a?"_":"‚ñ°"}}),s?.addEventListener("click",()=>{P&&(P.nextStep(),y("Skipped to next step","polite"))}))}function Vn(n){const e=document.getElementById("wpWorkoutName"),t=document.getElementById("wpStepDescription"),s=document.getElementById("wpStepTime"),o=document.getElementById("wpStepDuration"),a=document.getElementById("wpTargetPower"),i=document.getElementById("wpNextStep"),c=document.getElementById("wpProgress");if(e&&(e.textContent=n.workout.name),n.currentStep){t&&(t.textContent=n.currentStep.description||n.currentStep.name||n.currentStep.type.toUpperCase());const r=n.currentStep.duration-n.stepElapsedTime;s&&(s.textContent=_e(Math.max(0,r))),o&&(o.textContent=_e(n.currentStep.duration)),a&&(a.textContent=n.currentAbsoluteTarget?.value?Math.round(n.currentAbsoluteTarget.value).toString():"--")}if(i)if(n.nextStep){const r=Un(n.nextStep);i.textContent=`${n.nextStep.type} (${_e(n.nextStep.duration)}${r})`}else i.textContent="Finish";if(c){const r=n.stepElapsedTime/n.currentStep.duration*100;c.style.width=`${Math.min(100,Math.max(0,r))}%`,n.currentStep.type==="active"?c.style.backgroundColor="#ff9800":n.currentStep.type==="rest"||n.currentStep.type==="warmup"?c.style.backgroundColor="#2196F3":c.style.backgroundColor="#4CAF50"}if(n.isFinished){const r=document.getElementById("workoutPlayerOverlay");r&&(r.style.display="none"),P=null,alert("Workout Complete!"),y("Workout Complete!","assertive")}}function _e(n){const e=Math.floor(n/60),t=n%60;return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function Un(n){const e=n.target;return e&&e.value?` @ ~${e.value}${e.unit==="percent_ftp"?"%":"W"}`:""}function xt(){P&&P.start()}function Lt(){P&&P.pause()}class zn extends HTMLElement{shadow;_initialized=!1;constructor(){super(),this.shadow=this.attachShadow({mode:"open"})}connectedCallback(){this._initialized||(this.render(),this.setupEventListeners(),this._initialized=!0),this.onConnected()}disconnectedCallback(){this.onDisconnected()}attributeChangedCallback(e,t,s){t!==s&&this._initialized&&this.onAttributeChanged(e,t,s)}getBaseStyles(){return`
            :host {
                display: block;
                box-sizing: border-box;
            }
            
            :host([hidden]) {
                display: none;
            }
            
            *,
            *::before,
            *::after {
                box-sizing: inherit;
            }
            
            /* Respect reduced motion preferences */
            @media (prefers-reduced-motion: reduce) {
                *,
                *::before,
                *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }
        `}render(){this.shadow.innerHTML=`
            <style>
                ${this.getBaseStyles()}
                ${this.getStyles()}
            </style>
            ${this.getTemplate()}
        `}setupEventListeners(){}onConnected(){}onDisconnected(){}onAttributeChanged(e,t,s){}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}))}query(e){return this.shadow.querySelector(e)}queryAll(e){return this.shadow.querySelectorAll(e)}}const ot={info:{bg:"#1d4ed8",icon:"‚ÑπÔ∏è"},success:{bg:"#15803d",icon:"‚úÖ"},error:{bg:"#b91c1c",icon:"‚ùå"},warning:{bg:"#a16207",icon:"‚ö†Ô∏è"}};class V extends zn{timeoutId=null;static get observedAttributes(){return["message","type","duration","dismissible"]}getStyles(){return`
            :host {
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%) translateY(-20px);
                z-index: 10001;
                opacity: 0;
                transition: transform 0.3s ease, opacity 0.3s ease;
                pointer-events: none;
            }

            :host(.stacked) {
                position: relative;
                top: auto;
                left: auto;
                transform: translateX(100%); /* Start from right */
                margin-bottom: 10px;
                pointer-events: auto; /* Container handles layout */
                opacity: 0;
            }
            
            :host(.visible) {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                pointer-events: auto;
            }

            :host(.stacked.visible) {
                transform: translateX(0);
                opacity: 1;
            }
            
            :host(.hiding) {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }

            :host(.stacked.hiding) {
                transform: translateX(100%);
                opacity: 0;
            }
            
            .toast {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 20px;
                border-radius: 8px;
                background-color: var(--toast-bg, #1d4ed8);
                color: white;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                max-width: 90vw;
            }
            
            .icon {
                font-size: 18px;
                flex-shrink: 0;
            }
            
            .message {
                flex: 1;
            }
            
            .dismiss-btn {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0 4px;
                opacity: 0.8;
                transition: opacity 0.2s ease;
                flex-shrink: 0;
            }
            
            .dismiss-btn:hover {
                opacity: 1;
            }
            
            .dismiss-btn:focus-visible {
                outline: 2px solid white;
                outline-offset: 2px;
            }
            
            /* Reduced motion */
            @media (prefers-reduced-motion: reduce) {
                :host {
                    transition: none;
                }
            }
        `}getTemplate(){const e=this.getAttribute("message")||"",t=this.getAttribute("type")||"info",s=this.getAttribute("dismissible")!=="false",o=ot[t]||ot.info;return this.style.setProperty("--toast-bg",o.bg),`
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <span class="icon" aria-hidden="true">${o.icon}</span>
                <span class="message">${e}</span>
                ${s?`
                    <button class="dismiss-btn" aria-label="Dismiss notification">&times;</button>
                `:""}
            </div>
        `}setupEventListeners(){const e=this.query(".dismiss-btn");e&&e.addEventListener("click",()=>this.dismiss())}onConnected(){requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.classList.add("visible")})});const e=parseInt(this.getAttribute("duration")||"3000",10);e>0&&(this.timeoutId=window.setTimeout(()=>this.dismiss(),e))}onDisconnected(){this.timeoutId&&clearTimeout(this.timeoutId)}onAttributeChanged(e,t,s){this.render(),this.setupEventListeners()}dismiss(){this.timeoutId&&clearTimeout(this.timeoutId),this.classList.remove("visible"),this.classList.add("hiding"),setTimeout(()=>{this.remove()},300)}static show(e,t="info",s={}){const o=document.createElement("bpt-toast");return o.setAttribute("message",e),o.setAttribute("type",t),s.duration!==void 0&&o.setAttribute("duration",String(s.duration)),s.dismissible!==void 0&&o.setAttribute("dismissible",String(s.dismissible)),document.body.appendChild(o),o}static info(e,t){return V.show(e,"info",t)}static success(e,t){return V.show(e,"success",t)}static error(e,t){return V.show(e,"error",t)}static warning(e,t){return V.show(e,"warning",t)}}customElements.define("bpt-toast",V);const Wn=Object.freeze(Object.defineProperty({__proto__:null,Toast:V},Symbol.toStringTag,{value:"Module"}));function E(n,e="info",t=3e3){if(customElements.get("bpt-toast")){V.show(n,e,{duration:t});return}const s=document.createElement("div"),o=e==="error"?"#b91c1c":e==="success"?"#15803d":e==="warning"?"#a16207":"#1d4ed8";s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.style.cssText=`
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: ${o};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1001;
    font-size: 14px;
    max-width: 90%;
    text-align: center;
    font-weight: 500;
  `,s.textContent=n,document.body.appendChild(s),setTimeout(()=>{window.matchMedia("(prefers-reduced-motion: reduce)").matches?s.remove():(s.style.opacity="0",s.style.transition="opacity 0.3s ease",setTimeout(()=>s.remove(),300))},t)}function at(n){if(n.length<2)return 0;let e=0;const t=6371e3;for(let s=1;s<n.length;s++){const o=n[s-1],a=n[s],i=o.lat*Math.PI/180,c=a.lat*Math.PI/180,r=(a.lat-o.lat)*Math.PI/180,l=(a.lon-o.lon)*Math.PI/180,u=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i)*Math.cos(c)*Math.sin(l/2)*Math.sin(l/2),d=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));e+=t*d}return e/1e3}class Hn{synth;voice=null;measurementsState=null;timeState=null;lastTimeIntervalMs=0;lastDistanceIntervalKm=0;checkInterval=null;isActive=!1;constructor(){if(typeof window<"u"?this.synth=window.speechSynthesis||null:this.synth=null,!this.synth){console.warn("Speech Synthesis not supported on this device");return}this.synth.onvoiceschanged!==void 0&&(this.synth.onvoiceschanged=()=>this.loadVoice()),this.loadVoice()}init(e,t){this.measurementsState=e,this.timeState=t}startIntervalAnnouncements(){if(this.isActive||!this.measurementsState||!this.timeState)return;const e=x();e.enhancedVoice.timeIntervalMinutes===0&&e.enhancedVoice.distanceIntervalKm===0||(this.isActive=!0,this.lastTimeIntervalMs=0,this.lastDistanceIntervalKm=0,this.checkInterval=setInterval(()=>this.checkIntervalAnnouncements(),1e3),console.log("Enhanced voice announcements started"))}stopIntervalAnnouncements(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.isActive=!1,this.lastTimeIntervalMs=0,this.lastDistanceIntervalKm=0}reset(){this.stopIntervalAnnouncements()}loadVoice(){if(!this.synth)return;const e=this.synth.getVoices();this.voice=e.find(t=>t.lang.startsWith("en"))||e[0]||null}formatTimeForSpeech(e){const t=Math.floor(e/1e3),s=Math.floor(t/3600),o=Math.floor(t%3600/60),a=t%60,i=[];return s>0&&i.push(`${s} hour${s!==1?"s":""}`),o>0&&i.push(`${o} minute${o!==1?"s":""}`),(a>0||i.length===0)&&i.push(`${a} second${a!==1?"s":""}`),i.join(" ")}formatTimeShort(e){const t=Math.floor(e/1e3),s=Math.floor(t/3600),o=Math.floor(t%3600/60);return s>0?`${s} hour${s!==1?"s":""} ${o} minute${o!==1?"s":""}`:`${o} minute${o!==1?"s":""}`}speak(e){if(!this.synth)return;const t=x();if(!t.voiceEnabled)return;this.synth.speaking&&this.synth.cancel();const s=new SpeechSynthesisUtterance(e);this.voice&&(s.voice=this.voice),s.rate=t.enhancedVoice.speechRate,this.synth.speak(s)}announceLap(e,t,s){if(!this.synth||!x().voiceLaps)return;const a=this.formatTimeForSpeech(t),i=`Lap ${e}. Time ${a}. Average Power ${Math.round(s)} watts.`;this.speak(i)}announceZoneChange(e){if(!this.synth||!x().voiceZones)return;const s=`Entering ${e} Zone`;this.speak(s)}announceCountdown(e){if(!this.synth||!x().countdown.enableVoice)return;const s=e===0?"Go!":`${e}`;this.speak(s)}checkIntervalAnnouncements(){if(!this.measurementsState||!this.timeState||!this.timeState.running)return;const e=x();e.enhancedVoice.timeIntervalMinutes>0&&this.checkTimeAnnouncement(e.enhancedVoice.timeIntervalMinutes),e.enhancedVoice.distanceIntervalKm>0&&this.checkDistanceAnnouncement(e.enhancedVoice.distanceIntervalKm)}checkTimeAnnouncement(e){if(!this.timeState||!this.timeState.startTime)return;const t=Date.now()-this.timeState.startTime,s=e*60*1e3,o=Math.floor(t/s),a=Math.floor(this.lastTimeIntervalMs/s);o>a&&t>0&&(this.announceCurrentMetrics("time"),this.lastTimeIntervalMs=t)}checkDistanceAnnouncement(e){if(!this.measurementsState)return;const t=at(this.measurementsState.gps),s=Math.floor(t/e),o=Math.floor(this.lastDistanceIntervalKm/e);s>o&&t>0&&(this.announceCurrentMetrics("distance"),this.lastDistanceIntervalKm=t)}getCurrentMetrics(){const e={power:null,heartrate:null,cadence:null,speedKmh:null,distanceKm:null,elapsedMs:0};if(!this.measurementsState||!this.timeState)return e;const t=Date.now(),s=t-5e3,o=this.measurementsState.power.filter(r=>r.timestamp>s);o.length>0&&(e.power=Math.round(o[o.length-1].value));const a=this.measurementsState.heartrate.filter(r=>r.timestamp>s);a.length>0&&(e.heartrate=Math.round(a[a.length-1].value));const i=this.measurementsState.cadence.filter(r=>r.timestamp>s);i.length>0&&(e.cadence=Math.round(i[i.length-1].value));const c=this.measurementsState.speed.filter(r=>r.timestamp>s);return c.length>0&&(e.speedKmh=Math.round(c[c.length-1].value*10)/10),e.distanceKm=Math.round(at(this.measurementsState.gps)*100)/100,this.timeState.startTime&&(e.elapsedMs=t-this.timeState.startTime),e}announceCurrentMetrics(e){const s=x().enhancedVoice.metrics,o=this.getCurrentMetrics(),a=[];if(e==="time"&&s.time?a.push(this.formatTimeShort(o.elapsedMs)):e==="distance"&&s.distance&&o.distanceKm!==null&&a.push(`${o.distanceKm.toFixed(1)} kilometers`),s.power&&o.power!==null&&a.push(`power ${o.power} watts`),s.heartrate&&o.heartrate!==null&&a.push(`heart rate ${o.heartrate}`),s.speed&&o.speedKmh!==null&&a.push(`speed ${o.speedKmh.toFixed(1)} k p h`),s.cadence&&o.cadence!==null&&a.push(`cadence ${o.cadence}`),e==="time"&&s.distance&&o.distanceKm!==null&&o.distanceKm>0&&a.push(`distance ${o.distanceKm.toFixed(1)} kilometers`),e==="distance"&&s.time&&a.push(`time ${this.formatTimeShort(o.elapsedMs)}`),a.length>0){const i=a.join(". ")+".";this.speak(i),console.log(`Voice announcement (${e}): ${i}`)}}}const O=new Hn;async function Zn(n){const e=x(),t=e.countdown.duration;if(t===0){n();return}return new Promise(s=>{const o=qn();document.body.appendChild(o);let a=t,i,c=!1;const r=p=>{const h=o.querySelector(".countdown__number");h&&(h.textContent=p===0?"GO!":p.toString(),h.className="countdown__number",requestAnimationFrame(()=>{h.classList.add("countdown__number--pulse")})),e.countdown.enableVoice&&O.announceCountdown(p),e.countdown.enableBeep&&Kn(p===0);const f=p===0?"Go! Workout starting":`${p}`;y(f,"assertive")},l=o.querySelector(".countdown__cancel"),u=()=>{c=!0,clearInterval(i),document.body.removeChild(o),y("Countdown cancelled","assertive"),s()};l?.addEventListener("click",u);const d=p=>{p.key==="Escape"&&(u(),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d),r(a),i=window.setInterval(()=>{a--,a>=0&&r(a),a<0&&(clearInterval(i),document.removeEventListener("keydown",d),c||(document.body.removeChild(o),n()),s())},1e3)})}function qn(){const n=document.createElement("div");return n.className="countdown-overlay",n.setAttribute("role","alertdialog"),n.setAttribute("aria-labelledby","countdownTitle"),n.setAttribute("aria-live","assertive"),n.innerHTML=`
        <div class="countdown__backdrop"></div>
        <div class="countdown__content">
            <h2 id="countdownTitle" class="countdown__title">Get Ready!</h2>
            <div class="countdown__number"></div>
            <button class="countdown__cancel" aria-label="Cancel countdown">
                Cancel (ESC)
            </button>
        </div>
    `,n}function Kn(n=!1){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.frequency.value=n?880:440,t.type="sine",s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)}catch(e){console.warn("Failed to play beep:",e)}}function Yn(n){return n.startTime?n.running?"recording":"paused":"idle"}function oe(n,e){const{startButton:t,pauseButton:s,resumeButton:o,stopButton:a}=n;switch(t.style.display="none",s.style.display="none",o.style.display="none",a.style.display="none",e){case"idle":t.style.display="inline-flex";break;case"recording":s.style.display="inline-flex";break;case"paused":o.style.display="inline-flex",a.style.display="inline-flex";break}}let ae=null;function Mt(n,e=!1){!n.running||!n.startTime||(n.running=!1,n.endTime=Date.now(),Lt(),ae&&oe(ae,"paused"),be("paused"),e?(E("‚è∏Ô∏è Auto-paused","info"),y("Auto paused due to low activity","polite")):y("Workout paused. Press resume to continue or stop to save.","assertive"))}function _t(n,e=!1){if(!(n.running||!n.startTime)){if(n.endTime&&n.startTime){const t=Date.now()-n.endTime;n.startTime+=t}n.endTime=null,n.running=!0,xt(),ae&&oe(ae,"recording"),be("recording"),e?(E("‚ñ∂Ô∏è Auto-resumed","info"),y("Auto resumed","polite")):y("Workout resumed","assertive")}}const jn=n=>{const e=document.getElementById("startButton"),t=document.getElementById("pauseButton"),s=document.getElementById("resumeButton"),o=document.getElementById("stopButton"),a=document.getElementById("time");if(!e||!t||!s||!o||!a){console.warn("Workout control elements not found in DOM");return}const i={startButton:e,pauseButton:t,resumeButton:s,stopButton:o};ae=i,setInterval(()=>{let r="00:00:00";if(n.startTime&&n.running){const l=Date.now()-n.startTime;r=we(l)}else if(n.startTime&&n.endTime){const l=n.endTime-n.startTime;r=we(l)}a.textContent!==r&&(a.textContent=r)},100),oe(i,Yn(n));const c=(r,l)=>{const u=d=>{d.stopPropagation(),d.preventDefault(),l()};r.addEventListener("click",u)};c(e,()=>{console.log("[time.ts] Start button clicked"),Zn(()=>{n.startTime=Date.now(),n.endTime=null,n.running=!0,xt(),oe(i,"recording"),be("recording"),y("Workout started","assertive"),document.dispatchEvent(new CustomEvent("workoutStarted"))})}),c(t,()=>{Mt(n,!1)}),c(s,()=>{_t(n,!1)}),c(o,()=>{n.running=!1,Lt(),oe(i,"paused"),be("paused"),y("Workout stopped and saved. Press resume to continue or export your data.","assertive");const r=new CustomEvent("workoutComplete",{detail:{startTime:n.startTime,endTime:n.endTime,duration:n.endTime&&n.startTime?n.endTime-n.startTime:0}});document.dispatchEvent(r)})};function Gn(n,e){if(e.length===0)return 1;let t=1;for(const s of e)if(n>=s.timestamp)t=s.number+1;else break;return t}const Jn=n=>{const e=wt(n);if(!e||e.length===0)return"";const t=n.laps||[],s="timestamp,lap,power,cadence,heartrate,speed,distance,altitude,lat,lon",o=e.map(a=>{const i=new Date(a.timestamp).toISOString(),c=Gn(a.timestamp,t),r=a.power!==null?Math.round(a.power):"",l=a.cadence!==null?Math.round(a.cadence):"",u=a.heartrate!==null?Math.round(a.heartrate):"",d=a.speed!==null?a.speed.toFixed(1):"",p=a.distance!==null?Math.round(a.distance):"",h=a.altitude!==null?Math.round(a.altitude):"",f=a.lat!==null?a.lat.toFixed(6):"",g=a.lon!==null?a.lon.toFixed(6):"";return`${i},${c},${r},${l},${u},${d},${p},${h},${f},${g}`});return[s,...o].join(`
`)},Xn=32,it=2067,Qn=0,es=1,ts=34,ns=18,ss=19,os=20,as=21,F=0,Ae=2,W=132,I=134,is=0,rs=1,cs=2,ls=3,ds=4,us=253,ms=3,ps=4,hs=7,fs=253,gs=2,ys=7,vs=8,ws=9,bs=11,Ss=5,Es=6,Ts=0,Cs=1,ks=253,Is=2,xs=7,Ls=8,Ms=9,_s=11,As=0,Ps=1,Ds=253,Bs=0,$s=1,Ns=253,Fs=0,Rs=1,Os=2,Vs=3,Us=4,zs=5,Ws=4,Hs=255,Zs=2,qs=1,Ks=11,Ys=6,rt=0,ct=0,js=8,Gs=9,Js=26,Xs=0,ue=1,Qs=0,eo=Date.UTC(1989,11,31,0,0,0);function lt(n,e,t){const s=[0,52225,55297,5120,61441,15360,10240,58369,40961,27648,30720,46081,20480,39937,34817,17408];let o=0;for(let a=e;a<t;a++){const i=n[a];let c=s[o&15];o=o>>4&4095,o=o^c^s[i&15],c=s[o&15],o=o>>4&4095,o=o^c^s[i>>4&15]}return o}function Pe(n){return Math.round((n-eo)/1e3)}class to{buffer=[];definedMessages=new Map;writeHeader(){this.buffer.push(14),this.buffer.push(Xn),this.buffer.push(it&255),this.buffer.push(it>>8&255),this.buffer.push(0,0,0,0),this.buffer.push(46,70,73,84),this.buffer.push(0,0)}writeDefinition(e,t,s){this.buffer.push(64|e&15),this.buffer.push(0),this.buffer.push(0),this.buffer.push(t&255),this.buffer.push(t>>8&255),this.buffer.push(s.length);for(const o of s)this.buffer.push(o.fieldDefNum),this.buffer.push(o.size),this.buffer.push(o.baseType);this.definedMessages.set(e,!0)}writeData(e,t){this.buffer.push(e&15);for(const s of t);}writeUint8(e){this.buffer.push(e&255)}writeUint16(e){this.buffer.push(e&255),this.buffer.push(e>>8&255)}writeUint32(e){this.buffer.push(e&255),this.buffer.push(e>>8&255),this.buffer.push(e>>16&255),this.buffer.push(e>>24&255)}writeDataHeader(e){this.buffer.push(e&15)}finalize(){const e=new Uint8Array(this.buffer),t=this.buffer.length-14;e[4]=t&255,e[5]=t>>8&255,e[6]=t>>16&255,e[7]=t>>24&255;const s=lt(e,0,12);e[12]=s&255,e[13]=s>>8&255;const o=lt(e,0,e.length),a=new Uint8Array(e.length+2);return a.set(e),a[e.length]=o&255,a[e.length+1]=o>>8&255,a}getBuffer(){return this.buffer}}function no(n){switch(n){case"running":return{sport:qs,subSport:rt};case"walking":return{sport:Ks,subSport:rt};default:return{sport:Zs,subSport:Ys}}}const We=(n,e)=>{const t=wt(n);if(!t||t.length===0)return null;const s=no(e),o=new to;o.writeHeader();const a=t[0].timestamp,i=t[t.length-1].timestamp,c=Pe(a),r=Pe(i),l=(i-a)/1e3,u=Math.round(l*1e3),d=t.filter(S=>S.energy!==null),p=d.length>0?Math.round(d[d.length-1].energy-(d[0].energy||0)):0,h=t.filter(S=>S.distance!==null),f=h.length>0&&h[h.length-1].distance>(h[0].distance||0)?Math.round(h[h.length-1].distance-(h[0].distance||0)):0,g=0,w=1,v=2,C=3,_=4,N=5,A=6;o.writeDefinition(g,Qn,[{fieldDefNum:is,size:1,baseType:F},{fieldDefNum:rs,size:2,baseType:W},{fieldDefNum:cs,size:2,baseType:W},{fieldDefNum:ls,size:4,baseType:I},{fieldDefNum:ds,size:4,baseType:I}]),o.writeDataHeader(g),o.writeUint8(Ws),o.writeUint16(Hs),o.writeUint16(1),o.writeUint32(12345678),o.writeUint32(c),o.writeDefinition(w,es,[{fieldDefNum:0,size:2,baseType:W},{fieldDefNum:1,size:1,baseType:Ae}]),o.writeDataHeader(w),o.writeUint16(100),o.writeUint8(1),o.writeDefinition(v,as,[{fieldDefNum:Ds,size:4,baseType:I},{fieldDefNum:Bs,size:1,baseType:F},{fieldDefNum:$s,size:1,baseType:F}]),o.writeDataHeader(v),o.writeUint32(c),o.writeUint8(ct),o.writeUint8(Xs),o.writeDefinition(C,os,[{fieldDefNum:us,size:4,baseType:I},{fieldDefNum:ms,size:1,baseType:Ae},{fieldDefNum:ps,size:1,baseType:Ae},{fieldDefNum:hs,size:2,baseType:W}]);for(const S of t){const M=Pe(S.timestamp);o.writeDataHeader(C),o.writeUint32(M),o.writeUint8(S.heartrate!==null?Math.min(255,Math.round(S.heartrate)):255),o.writeUint8(S.cadence!==null?Math.min(255,Math.round(S.cadence)):255),o.writeUint16(S.power!==null?Math.round(S.power):65535)}return o.writeDataHeader(v),o.writeUint32(r),o.writeUint8(ct),o.writeUint8(ue),o.writeDefinition(_,ss,[{fieldDefNum:ks,size:4,baseType:I},{fieldDefNum:Is,size:4,baseType:I},{fieldDefNum:xs,size:4,baseType:I},{fieldDefNum:Ls,size:4,baseType:I},{fieldDefNum:Ms,size:4,baseType:I},{fieldDefNum:_s,size:2,baseType:W},{fieldDefNum:As,size:1,baseType:F},{fieldDefNum:Ps,size:1,baseType:F}]),o.writeDataHeader(_),o.writeUint32(r),o.writeUint32(c),o.writeUint32(u),o.writeUint32(u),o.writeUint32(f),o.writeUint16(p),o.writeUint8(Gs),o.writeUint8(ue),o.writeDefinition(N,ns,[{fieldDefNum:fs,size:4,baseType:I},{fieldDefNum:gs,size:4,baseType:I},{fieldDefNum:ys,size:4,baseType:I},{fieldDefNum:vs,size:4,baseType:I},{fieldDefNum:ws,size:4,baseType:I},{fieldDefNum:bs,size:2,baseType:W},{fieldDefNum:Ss,size:1,baseType:F},{fieldDefNum:Es,size:1,baseType:F},{fieldDefNum:Ts,size:1,baseType:F},{fieldDefNum:Cs,size:1,baseType:F}]),o.writeDataHeader(N),o.writeUint32(r),o.writeUint32(c),o.writeUint32(u),o.writeUint32(u),o.writeUint32(f),o.writeUint16(p),o.writeUint8(s.sport),o.writeUint8(s.subSport),o.writeUint8(js),o.writeUint8(ue),o.writeDefinition(A,ts,[{fieldDefNum:Ns,size:4,baseType:I},{fieldDefNum:Fs,size:4,baseType:I},{fieldDefNum:Rs,size:2,baseType:W},{fieldDefNum:Os,size:1,baseType:F},{fieldDefNum:Vs,size:1,baseType:F},{fieldDefNum:Us,size:1,baseType:F},{fieldDefNum:zs,size:4,baseType:I}]),o.writeDataHeader(A),o.writeUint32(r),o.writeUint32(u),o.writeUint16(1),o.writeUint8(Qs),o.writeUint8(Js),o.writeUint8(ue),o.writeUint32(r),o.finalize()};function so(n){const e=document.createElement("div");e.className="custom-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","modal-title");const t=n.icon?`${n.icon} ${n.title}`:n.title;e.innerHTML=`
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-container">
            <div class="custom-modal-header">
                <h2 id="modal-title">${t}</h2>
                <button class="modal-close-btn" aria-label="Close dialog">&times;</button>
            </div>
            <div class="custom-modal-body"></div>
            <div class="custom-modal-footer"></div>
        </div>
    `;const s=e.querySelector(".custom-modal-body");typeof n.content=="string"?s.innerHTML=n.content:s.appendChild(n.content);const o=e.querySelector(".custom-modal-footer");return n.buttons.forEach((a,i)=>{const c=document.createElement("button");c.textContent=a.text,c.className=`modal-btn modal-btn-${a.variant}`,c.addEventListener("click",a.onClick),(a.variant==="primary"||i===0&&!n.buttons.some(r=>r.variant==="primary"))&&c.setAttribute("data-autofocus","true"),o.appendChild(c)}),e}function oo(n){const e=n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),t=e[0],s=e[e.length-1],o=a=>{a.key==="Tab"&&(a.shiftKey?document.activeElement===t&&(a.preventDefault(),s?.focus()):document.activeElement===s&&(a.preventDefault(),t?.focus()))};return n.addEventListener("keydown",o),()=>n.removeEventListener("keydown",o)}function re(n){const e=so(n),t=document.activeElement;document.body.appendChild(e),e.offsetHeight,e.classList.add("modal-visible");const s=oo(e),o=e.querySelector("[data-autofocus]");setTimeout(()=>{o?.focus()},50);const a=()=>{e.classList.remove("modal-visible"),setTimeout(()=>{e.remove(),s(),t?.focus(),n.onClose?.()},200)};e.querySelector(".modal-close-btn")?.addEventListener("click",a),n.closeOnOverlay!==!1&&e.querySelector(".custom-modal-overlay")?.addEventListener("click",a);const c=l=>{l.key==="Escape"&&(l.preventDefault(),a())};document.addEventListener("keydown",c);const r=n.onClose;return n.onClose=()=>{document.removeEventListener("keydown",c),r?.()},y(`${n.title} dialog opened`,"polite"),a}function At(n,e,t={}){return new Promise(s=>{const{confirmText:o="Confirm",cancelText:a="Cancel",confirmVariant:i="primary",icon:c}=t;let r=null;r=re({title:n,content:`<p class="modal-message">${e}</p>`,icon:c,buttons:[{text:a,variant:"secondary",onClick:()=>{r?.(),s(!1)}},{text:o,variant:i,onClick:()=>{r?.(),s(!0)}}],onClose:()=>s(!1)})})}function ao(n,e,t,s){const o=p=>{if(p.length===0)return{avg:null,max:null,count:0};const h=p.map(g=>g.value),f=h.reduce((g,w)=>g+w,0);return{avg:Math.round(f/h.length),max:Math.max(...h),count:h.length}},a=t.power.map(p=>p.value),i=[],c=[1,5,10,30,60,300,1200,3600],r=p=>{if(a.length<p)return 0;let h=0;for(let g=0;g<p;g++)h+=a[g];let f=h/p;for(let g=p;g<a.length;g++)h=h-a[g-p]+a[g],h/p>f&&(f=h/p);return Math.round(f)};for(const p of c)a.length>=p&&i.push({duration:p,watts:r(p)});let l=0,u=0;try{const p=localStorage.getItem("bpt-user-profile");if(p&&a.length>0){const f=JSON.parse(p).ftp||200,g=[];let w=0;for(let v=0;v<a.length;v++)w+=a[v],v>=30&&(w-=a[v-30]),v>=29&&g.push(w/30);if(g.length>0){const v=g.map(A=>Math.pow(A,4)),C=v.reduce((A,S)=>A+S,0)/v.length,_=Math.pow(C,.25);u=_/f,l=(e-n)/1e3*_*u/(f*3600)*100}}}catch(p){console.warn("Error calculating TSS",p)}const d={duration:e-n,startTime:n,endTime:e,power:o(t.power),heartrate:o(t.heartrate),cadence:o(t.cadence),powerCurve:i.length>0?i:void 0,trainingLoad:l>0?Math.round(l):void 0,intensityFactor:u>0?parseFloat(u.toFixed(2)):void 0};if(s){const p=s.getPowerZoneDistribution(),h=s.getHrZoneDistribution();p.totalTimeMs>0&&(d.powerZoneDistribution=p),h.totalTimeMs>0&&(d.hrZoneDistribution=h)}return d}function io(n){const e=Math.floor(n/1e3),t=Math.floor(e/3600),s=Math.floor(e%3600/60),o=e%60,a=[];return t>0&&a.push(`${t}h`),s>0&&a.push(`${s}m`),(o>0||a.length===0)&&a.push(`${o}s`),a.join(" ")}function ro(n){const e=Math.floor(n/60),t=n%60;return`${e}:${String(t).padStart(2,"0")}`}const co={1:"#3b82f6",2:"#22c55e",3:"#eab308",4:"#f97316",5:"#ef4444",6:"#a855f7",7:"#ec4899"};function dt(n,e){const t=document.createElement("div");if(t.className="zone-distribution",n.zones.filter(a=>a.timeInZoneMs>0).length===0)return t;const o=Math.max(...n.zones.map(a=>a.timeInZoneMs));return t.innerHTML=`
        <h4 class="zone-distribution-title">${e}</h4>
        <div class="zone-chart">
            ${n.zones.map(a=>{const i=o>0?a.timeInZoneMs/o*100:0,c=Math.round(a.timeInZoneMs/1e3),r=co[a.zone]||"#888",l=ro(c);return`
                    <div class="zone-bar-row" title="${a.name}: ${l}">
                        <span class="zone-bar-label">Z${a.zone}</span>
                        <div class="zone-bar-container">
                            <div class="zone-bar" style="width: ${Math.max(i,2)}%; background-color: ${r};" aria-valuenow="${c}" aria-label="${a.name}"></div>
                        </div>
                        <span class="zone-bar-time">${l}</span>
                    </div>
                `}).join("")}
        </div>
    `,t}function lo(n,e=[]){const t=document.createElement("div");t.className="workout-summary";const s=(a,i)=>a!==null?`${a}${i}`:"--";let o="";if(e.length>0&&(o=`
            <div class="summary-records" style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--color-accent); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: var(--color-accent); display: flex; align-items: center; gap: 8px;">
                    üèÜ New Personal Records!
                </h4>
                <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
                    ${e.map(a=>`<li style="margin-bottom: 4px;">üÜï ${a}</li>`).join("")}
                </ul>
            </div>
        `),t.innerHTML=`
        ${o}
        <div class="summary-duration">
            <span class="summary-label">Duration</span>
            <span class="summary-value">${io(n.duration)}</span>
        </div>
        <div class="summary-grid">
            <div class="summary-metric">
                <span class="summary-metric-icon">‚ö°</span>
                <span class="summary-metric-label">Power</span>
                <div class="summary-metric-values">
                    <span class="summary-avg">Avg: ${s(n.power.avg,"W")}</span>
                    <span class="summary-max">Max: ${s(n.power.max,"W")}</span>
                </div>
            </div>
            <div class="summary-metric">
                <span class="summary-metric-icon">‚ù§Ô∏è</span>
                <span class="summary-metric-label">Heart Rate</span>
                <div class="summary-metric-values">
                    <span class="summary-avg">Avg: ${s(n.heartrate.avg," bpm")}</span>
                    <span class="summary-max">Max: ${s(n.heartrate.max," bpm")}</span>
                </div>
            </div>
            <div class="summary-metric">
                <span class="summary-metric-icon">üö¥</span>
                <span class="summary-metric-label">Cadence</span>
                <div class="summary-metric-values">
                    <span class="summary-avg">Avg: ${s(n.cadence.avg," rpm")}</span>
                    <span class="summary-max">Max: ${s(n.cadence.max," rpm")}</span>
                </div>
            </div>
        </div>
        <div class="summary-samples">
            <span class="summary-samples-text">
                ${n.power.count+n.heartrate.count+n.cadence.count} data points recorded
            </span>
        </div>
    `,n.powerZoneDistribution&&n.powerZoneDistribution.totalTimeMs>0){const a=dt(n.powerZoneDistribution,"‚ö° Power Zone Distribution");t.appendChild(a)}if(n.hrZoneDistribution&&n.hrZoneDistribution.totalTimeMs>0){const a=dt(n.hrZoneDistribution,"‚ù§Ô∏è Heart Rate Zone Distribution");t.appendChild(a)}return t}function uo(n,e,t=[]){return new Promise(s=>{let o=null;const a=lo(n,t);o=re({title:"Workout Complete",content:a,icon:"üèÅ",closeOnOverlay:!1,buttons:[{text:"üóëÔ∏è Discard",variant:"danger",onClick:()=>{o?.(),e.onDiscard(),s("discard")}},{text:"‚ñ∂Ô∏è Keep Recording",variant:"secondary",onClick:()=>{o?.(),e.onKeepRecording(),s("keep")}},{text:"üíæ Save & Finish",variant:"primary",onClick:()=>{o?.(),e.onExport(),s("export")}}],onClose:()=>{e.onKeepRecording(),s("keep")}})})}const De={1:{label:"1 - Very Light",description:"Barely any effort",color:"#3b82f6"},2:{label:"2 - Light",description:"Easy breathing",color:"#22c55e"},3:{label:"3 - Light",description:"Could do this all day",color:"#22c55e"},4:{label:"4 - Moderate",description:"Comfortable effort",color:"#84cc16"},5:{label:"5 - Moderate",description:"Starting to breathe harder",color:"#eab308"},6:{label:"6 - Hard",description:"Can speak in sentences",color:"#eab308"},7:{label:"7 - Hard",description:"Can only speak in phrases",color:"#f97316"},8:{label:"8 - Very Hard",description:"Difficult to maintain",color:"#ef4444"},9:{label:"9 - Very Hard",description:"Almost maximal effort",color:"#dc2626"},10:{label:"10 - Maximum",description:"All-out effort",color:"#991b1b"}};function Q(n){const e=n?new Date(n):new Date,t=e.getHours();let s="Morning";t>=12&&t<17?s="Afternoon":t>=17&&t<21?s="Evening":(t>=21||t<5)&&(s="Night");const o=e.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${s} Ride - ${o}`}function mo(n){const e=document.createElement("div");e.className="rpe-selector",e.innerHTML=`
        <label class="metadata-label">Perceived Exertion (RPE)</label>
        <div class="rpe-grid">
            ${[1,2,3,4,5,6,7,8,9,10].map(s=>{const o=De[s];return`
                    <button type="button"
                        class="rpe-button ${n===s?"selected":""}"
                        data-rpe="${s}"
                        title="${o.label}: ${o.description}"
                        style="--rpe-color: ${o.color};">
                        ${s}
                    </button>
                `}).join("")}
        </div>
        <div class="rpe-description" id="rpeDescription">
            Select how hard the workout felt
        </div>
    `;const t=e.querySelectorAll(".rpe-button");return t.forEach(s=>{s.addEventListener("click",()=>{t.forEach(i=>i.classList.remove("selected")),s.classList.add("selected");const o=parseInt(s.getAttribute("data-rpe")||"5",10),a=e.querySelector("#rpeDescription");a&&(a.textContent=`${De[o].label}: ${De[o].description}`)})}),e}function po(n,e,t){const s=document.createElement("div");s.className="workout-metadata-form";const o=document.createElement("div");if(o.className="metadata-field",o.innerHTML=`
        <label class="metadata-label" for="workoutTitle">Workout Title</label>
        <input type="text"
            id="workoutTitle"
            class="metadata-input"
            value="${Q(n)}"
            placeholder="Enter workout title..."
            maxlength="100">
    `,s.appendChild(o),e){const a=document.createElement("div");a.className="metadata-field",a.innerHTML=`
            <label class="metadata-label" for="workoutNotes">Notes (optional)</label>
            <textarea
                id="workoutNotes"
                class="metadata-textarea"
                placeholder="How did the workout go? Any observations..."
                rows="3"
                maxlength="1000"></textarea>
        `,s.appendChild(a)}if(t){const a=document.createElement("div");a.className="metadata-field",a.appendChild(mo()),s.appendChild(a)}return s}function ho(n){const e=n.querySelector("#workoutTitle"),t=n.querySelector("#workoutNotes"),s=n.querySelector(".rpe-button.selected"),o={title:e?.value.trim()||Q()};if(t?.value.trim()&&(o.notes=t.value.trim()),s){const a=parseInt(s.getAttribute("data-rpe")||"0",10);a>=1&&a<=10&&(o.perceivedExertion=a)}return o}function Pt(n){const e=x(),{promptForNotes:t,promptForExertion:s}=e.workoutMetadata;return!t&&!s?Promise.resolve({title:Q(n)}):new Promise(o=>{let a=null;const i=po(n,t,s);a=re({title:"Workout Details",content:i,icon:"üìù",closeOnOverlay:!1,buttons:[{text:"Skip",variant:"secondary",onClick:()=>{a?.(),o({title:Q(n)})}},{text:"Save",variant:"primary",onClick:()=>{const c=ho(i);a?.(),o(c)}}],onClose:()=>{o({title:Q(n)})}}),setTimeout(()=>{const c=i.querySelector("#workoutTitle");c?.focus(),c?.select()},100)})}function Dt(){const n=x();return n.workoutMetadata.promptForNotes||n.workoutMetadata.promptForExertion}const fo=Object.freeze(Object.defineProperty({__proto__:null,generateDefaultTitle:Q,shouldShowMetadataModal:Dt,showWorkoutMetadataModal:Pt},Symbol.toStringTag,{value:"Module"})),go=5e3;function yo(n){const{message:e,onUndo:t,onExpire:s,timeout:o=go,icon:a="üóëÔ∏è"}=n;document.querySelector(".undo-notification")?.remove();const c=document.createElement("div");c.className="undo-notification",c.setAttribute("role","alert"),c.setAttribute("aria-live","assertive");const r=Math.ceil(o/1e3);let l=r;c.innerHTML=`
        <div class="undo-notification-content">
            <span class="undo-notification-icon" aria-hidden="true">${a}</span>
            <span class="undo-notification-message">${e}</span>
        </div>
        <div class="undo-notification-actions">
            <button class="undo-notification-btn" type="button">
                Undo <span class="undo-countdown">(${l}s)</span>
            </button>
        </div>
        <div class="undo-progress-bar">
            <div class="undo-progress-fill"></div>
        </div>
    `,document.body.appendChild(c);const u=c.querySelector(".undo-notification-btn"),d=c.querySelector(".undo-countdown"),p=c.querySelector(".undo-progress-fill"),h=window.matchMedia("(prefers-reduced-motion: reduce)").matches;h||(p.style.transition=`width ${o}ms linear`,p.offsetHeight),p.style.width="0%",requestAnimationFrame(()=>{c.classList.add("undo-notification-visible")});let f=!1,g=null,w=null;const v=(C=!1)=>{g&&(clearInterval(g),g=null),w&&(clearTimeout(w),w=null),h?(c.remove(),C&&!f&&s&&s()):(c.classList.remove("undo-notification-visible"),c.classList.add("undo-notification-hiding"),setTimeout(()=>{c.remove(),C&&!f&&s&&s()},200))};return g=setInterval(()=>{l--,l>0?d.textContent=`(${l}s)`:g&&clearInterval(g)},1e3),w=setTimeout(()=>{v(!0)},o),u.addEventListener("click",()=>{f=!0,v(!1),t(),y("Action undone","assertive")}),u.focus(),y(`${e} Press undo within ${r} seconds to restore.`,"assertive"),()=>v(!1)}function vo(n,e){return{power:[...n.power],heartrate:[...n.heartrate],cadence:[...n.cadence],startTime:e.startTime,endTime:e.endTime,running:e.running}}function wo(n,e,t){e.power=[...n.power],e.heartrate=[...n.heartrate],e.cadence=[...n.cadence],t.startTime=n.startTime,t.endTime=n.endTime,t.running=n.running}function bo({measurementsState:n,timeState:e}){const t=document.getElementById("lapButton"),s=document.getElementById("lapCounter"),o=document.getElementById("lapCount"),a=document.getElementById("startButton"),i=document.getElementById("pauseButton"),c=document.getElementById("resumeButton"),r=document.getElementById("stopButton");if(!t||!s||!o){console.warn("Lap button elements not found in DOM");return}const l=()=>{const h=n.getLapCount();o.textContent=String(h),s.style.display=h>0?"block":"none"},u=()=>{const h=e.running&&e.startTime!==null;t.style.display=h?"inline-flex":"none"},d=()=>{if(!e.running||!e.startTime)return;const h=n.laps,f=h.length>0?h[h.length-1].timestamp:e.startTime,g=n.addLap(e.startTime);l();const w=g.timestamp,v=w-f,C=n.power.filter(S=>S.timestamp>=f&&S.timestamp<=w),_=C.length>0?C.reduce((S,M)=>S+M.value,0)/C.length:0;O.announceLap(g.number,v,_);const N=g.elapsedMs?we(g.elapsedMs):"",A=`Lap ${g.number}${N?` at ${N}`:""}`;E(`üèÅ ${A}`,"info"),y(A,"assertive"),console.log(`Lap marked: ${g.number} at ${new Date(g.timestamp).toISOString()}`)};t.addEventListener("click",d);const p=new MutationObserver(()=>{u()});[a,i,c,r].forEach(h=>{h&&p.observe(h,{attributes:!0,attributeFilter:["style"]})}),u(),l(),a?.addEventListener("click",()=>{setTimeout(u,10)}),i?.addEventListener("click",()=>{setTimeout(u,10)}),c?.addEventListener("click",()=>{setTimeout(u,10)}),r?.addEventListener("click",()=>{setTimeout(()=>{u()},10)}),console.log("Lap button initialized")}function So(){const n=document.getElementById("lapCounter"),e=document.getElementById("lapCount");n&&e&&(e.textContent="0",n.style.display="none")}class Eo{state={maxPower:0,maxHr:0,longestDuration:0,longestDistance:0,powerCurve:{}};constructor(e){this.processHistory(e)}processHistory(e){e.forEach(t=>{const s=To(t);s.power?.max&&s.power.max>this.state.maxPower&&(this.state.maxPower=s.power.max),s.heartrate?.max&&s.heartrate.max>this.state.maxHr&&(this.state.maxHr=s.heartrate.max),t.duration&&t.duration>this.state.longestDuration&&(this.state.longestDuration=t.duration),s.powerCurve&&s.powerCurve.forEach(o=>{const a=this.state.powerCurve[o.duration]||0;o.watts>a&&(this.state.powerCurve[o.duration]=o.watts)})})}checkNewRecords(e){const t=[];if(e.power.max&&e.power.max>this.state.maxPower&&t.push(`Max Power: ${e.power.max} W`),e.heartrate.max&&e.heartrate.max>this.state.maxHr&&t.push(`Max Heart Rate: ${e.heartrate.max} bpm`),e.duration&&e.duration>this.state.longestDuration&&t.push(`Longest Ride: ${Co(e.duration)}`),e.powerCurve){const s=[1,5,60,300,1200,3600],o={1:"1s Power",5:"5s Power",60:"1m Power",300:"5m Power",1200:"20m Power",3600:"1h Power"};e.powerCurve.forEach(a=>{if(s.includes(a.duration)){const i=this.state.powerCurve[a.duration]||0;if(a.watts>i){if(a.duration===1&&t.some(c=>c.startsWith("Max Power")))return;t.push(`${o[a.duration]}: ${a.watts} W`)}}})}return t}}function To(n){if(!n.summary)return{};if(typeof n.summary=="string")try{return JSON.parse(n.summary)}catch{return{}}return n.summary}function Co(n){const e=Math.floor(n/1e3),t=Math.floor(e/3600),s=Math.floor(e%3600/60),o=e%60;return t>0?`${t}h ${s}m`:`${s}m ${o}s`}class ko{static API_BASE="https://intervals.icu/api/v1";static async uploadWorkout(e,t){const s=x();if(!(!s.intervals.enabled||!s.intervals.apiKey))try{const o=We(e);if(!o){console.warn("[Intervals] No data to upload");return}const a=new Blob([o],{type:"application/fit"}),i=new FormData;i.append("file",a,t);const c=s.intervals.athleteId||"i",r=`${this.API_BASE}/athlete/${c}/activities`,l=btoa(`API_KEY:${s.intervals.apiKey}`);E("Uploading to Intervals.icu...","info");const u=await fetch(r,{method:"POST",headers:{Authorization:`Basic ${l}`},body:i});if(u.ok){const d=await u.json();console.log("[Intervals] Upload success:",d),E("Uploaded to Intervals.icu! üöÄ","success")}else{const d=await u.text();console.error("[Intervals] Upload failed:",u.status,d),E(`Upload failed: ${u.status}`,"error")}}catch(o){console.error("[Intervals] Network error:",o),E("Upload network error","error")}}}const ut={power:!0,cadence:!0,heartrate:!0,exportTcx:!0,exportCsv:!0,exportJson:!1,exportFit:!1},Io="https://www.strava.com/upload/select";class J{static instance;accessToken=null;constructor(){}static getInstance(){return J.instance||(J.instance=new J),J.instance}isConnected(){return!!this.accessToken}async handleUpload(e,t){try{let s,o;const a=new Date().toISOString().slice(0,10),i=new Date().toISOString().slice(11,16).replace(":","-"),c=`bike-power-tracker-${a}-${i}`;try{const r=We(e,void 0);if(r)s=new Blob([r],{type:"application/octet-stream"}),o=`${c}.fit`;else throw new Error("No FIT data generated")}catch(r){console.warn("FIT generation failed, falling back to TCX",r);const l=bt(e);s=new Blob([l],{type:"application/vnd.garmin.tcx+xml"}),o=`${c}.tcx`}this.downloadFile(s,o),this.openStravaUpload(),y("Workout file downloaded. Please upload closely in the new Strava tab.","assertive")}catch(s){console.error("Strava upload preparation failed:",s),alert("Failed to prepare Strava upload.")}}downloadFile(e,t){const s=URL.createObjectURL(e),o=document.createElement("a");o.href=s,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(s),100)}openStravaUpload(){window.open(Io,"_blank")}}const xo=J.getInstance(),Lo=()=>{const n=document.getElementById("toggleYourMetrics"),e=document.getElementById("yourMetrics");n&&e&&(n.checked=e.style.display!=="none",n.addEventListener("change",o=>{const a=o.target;e.style.display=a.checked?"flex":"none"}));const t=document.getElementById("toggleStreamMetrics"),s=document.getElementById("streamMetrics");t&&s&&(t.checked=s.style.display!=="none",t.addEventListener("change",o=>{const a=o.target;s.style.display=a.checked?"flex":"none"}))},Mo=({measurementsState:n,timeState:e,zoneState:t})=>{const s=document.getElementById("discardButton");if(!s){console.warn("Discard button not found in DOM");return}((a,i)=>{const c=r=>{r.stopPropagation(),i()};a.addEventListener("click",c)})(s,async()=>{if(!(n.power.length>0||n.heartrate.length>0||n.cadence.length>0||e.startTime!==null)){Se(n,e);return}const i=n.power.length+n.heartrate.length+n.cadence.length;if(await At("Discard Workout",`Are you sure you want to discard this workout? You have ${i} data points that will be deleted. You'll have 5 seconds to undo this action.`,{confirmText:"Discard",cancelText:"Keep Data",confirmVariant:"danger",icon:"üóëÔ∏è"})){const r=vo(n,e);Se(n,e),t&&t.reset(),document.dispatchEvent(new CustomEvent("workout-discarded")),So(),yo({message:"Workout data discarded",icon:"üóëÔ∏è",timeout:5e3,onUndo:()=>{wo(r,n,e),_o(r),y("Workout data restored","polite")},onExpire:()=>{y("Discard complete","polite")}})}})};function _o(n){const e=document.getElementById("startButton"),t=document.getElementById("pauseButton"),s=document.getElementById("resumeButton"),o=document.getElementById("stopButton"),a=document.getElementById("time");if(n.running?(e&&(e.style.display="none"),t&&(t.style.display="inline-flex"),s&&(s.style.display="none"),o&&(o.style.display="inline-flex")):n.startTime!==null&&(e&&(e.style.display="none"),t&&(t.style.display="none"),s&&(s.style.display="inline-flex"),o&&(o.style.display="inline-flex")),a&&n.startTime!==null){const i=(n.endTime||Date.now())-n.startTime,c=Math.floor(i/1e3),r=Math.floor(c/3600),l=Math.floor(c%3600/60),u=c%60;a.textContent=`${String(r).padStart(2,"0")}:${String(l).padStart(2,"0")}:${String(u).padStart(2,"0")}`}}function Se(n,e){e.running=!1,e.startTime=null,e.endTime=null,n.power=[],n.heartrate=[],n.cadence=[];const t=document.getElementById("startButton"),s=document.getElementById("pauseButton"),o=document.getElementById("resumeButton"),a=document.getElementById("stopButton");t&&(t.style.display="inline-flex"),s&&(s.style.display="none"),o&&(o.style.display="none"),a&&(a.style.display="none");const i=document.getElementById("time");i&&(i.textContent="00:00:00")}function Bt(){const n=new Date;return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}-${String(n.getHours()).padStart(2,"0")}-${String(n.getMinutes()).padStart(2,"0")}-${String(n.getSeconds()).padStart(2,"0")}`}function me(n,e){const t=URL.createObjectURL(n),s=document.createElement("a");s.href=t,s.download=e,s.click(),URL.revokeObjectURL(t)}const Ao=(n,e)=>{const t=document.getElementById("exportData");if(!t){console.warn("Export button not found in DOM");return}((o,a)=>{const i=c=>{c.stopPropagation(),a()};o.addEventListener("click",i)})(t,()=>{try{const o=localStorage.getItem("bpt-settings"),a=o?{...ut,...JSON.parse(o)}:ut,i=Bt(),c=$t(),r=c?.title?c.title.replace(/[^a-z0-9]+/gi,"-").substring(0,30).toLowerCase():"workout";At("Export Options","Choose an action for your workout data:",{confirmText:"Download Files",confirmVariant:"primary",cancelText:"Upload to Strava",icon:"üíæ"}).then(l=>{if(l){if(a.exportJson){const u={metadata:c?{title:c.title,notes:c.notes||null,perceivedExertion:c.perceivedExertion||null}:null,power:n.power,heartrate:n.heartrate,cadence:n.cadence};if(e){const h=e.toJSON();(h.powerZones.some(f=>f.timeInZoneMs>0)||h.hrZones.some(f=>f.timeInZoneMs>0))&&(u.zoneDistribution={power:h.powerZones.map(f=>({zone:f.zone,name:f.name,timeSeconds:Math.round(f.timeInZoneMs/1e3)})),hr:h.hrZones.map(f=>({zone:f.zone,name:f.name,timeSeconds:Math.round(f.timeInZoneMs/1e3)}))})}const d=JSON.stringify(u,null,2),p=new Blob([d],{type:"application/json"});me(p,`${r}-${i}.json`)}if(a.exportCsv){const u=Jn(n),d=new Blob([u],{type:"text/csv"});me(d,`${r}-${i}.csv`)}if(a.exportTcx){const u=bt(n),d=new Blob([u],{type:"application/vnd.garmin.tcx+xml"});me(d,`${r}-${i}.tcx`)}try{const u=We(n,void 0);if(u){const d=new Blob([u],{type:"application/octet-stream"});me(d,`${r}-${i}.fit`)}}catch{}y("Workout files downloaded","assertive")}else xo.handleUpload(n,c||void 0)})}catch(o){console.error("Export failed:",o),E("Failed to export data","error")}})};let Ee=null;function $t(){return Ee}function mt(){Ee=null}const Po=({measurementsState:n,timeState:e,zoneState:t})=>{document.addEventListener("workoutComplete",async s=>{const o=s.detail;if(!(n.power.length>0||n.heartrate.length>0||n.cadence.length>0)&&!o.startTime)return;const i=ao(o.startTime||e.startTime||Date.now(),o.endTime||e.endTime||Date.now(),n,t);let c=[];try{if(await Pn()){const r=await Dn({limit:1e3});c=new Eo(r.workouts).checkNewRecords(i),c.length>0&&y(`Congratulations! You set ${c.length} new personal records!`,"assertive")}}catch(r){console.warn("Failed to check for PRs:",r)}await uo(i,{onExport:async()=>{if(Dt())Ee=await Pt(o.startTime||e.startTime);else{const{generateDefaultTitle:l}=await T(async()=>{const{generateDefaultTitle:u}=await Promise.resolve().then(()=>fo);return{generateDefaultTitle:u}},void 0);Ee={title:l(o.startTime||e.startTime)}}try{await jt(),y("Workout saved to local history","polite");const l=x();if(l.intervals&&l.intervals.enabled&&l.intervals.autoUpload)try{const u=$t(),d=u?.title?u.title.replace(/[^a-z0-9]+/gi,"-").substring(0,30).toLowerCase():"workout",p=Bt();await ko.uploadWorkout(n,`${d}-${p}.fit`)}catch(u){console.error("Intervals auto-upload failed",u)}}catch(l){console.error("Failed to save to local history",l),y("Failed to save to local history","assertive")}document.getElementById("exportData")?.click(),Se(n,e),mt()},onDiscard:()=>{Se(n,e),mt(),y("Workout discarded","polite")},onKeepRecording:()=>{document.getElementById("resumeButton")?.click()}},c)})},Do="bpt-user-profile";function Bo(){try{const n=localStorage.getItem(Do);if(n)return JSON.parse(n)}catch(n){console.warn("Failed to load user profile:",n)}return{ftp:null,maxHr:null}}function Nt(n){return[{name:"Active Recovery",min:0,max:Math.round(n*.55)},{name:"Endurance",min:Math.round(n*.55),max:Math.round(n*.75)},{name:"Tempo",min:Math.round(n*.75),max:Math.round(n*.9)},{name:"Threshold",min:Math.round(n*.9),max:Math.round(n*1.05)},{name:"VO2max",min:Math.round(n*1.05),max:Math.round(n*1.2)},{name:"Anaerobic",min:Math.round(n*1.2),max:Math.round(n*1.5)},{name:"Neuromuscular",min:Math.round(n*1.5),max:9999}]}function Ft(n){return[{name:"Recovery",min:Math.round(n*.5),max:Math.round(n*.6)},{name:"Aerobic",min:Math.round(n*.6),max:Math.round(n*.7)},{name:"Tempo",min:Math.round(n*.7),max:Math.round(n*.8)},{name:"Threshold",min:Math.round(n*.8),max:Math.round(n*.9)},{name:"Anaerobic",min:Math.round(n*.9),max:n}]}function $o(n,e){const t=Nt(e);for(let s=0;s<t.length;s++)if(n>=t[s].min&&n<t[s].max)return{zone:s+1,name:t[s].name};return null}function No(n,e){const t=Ft(e);for(let s=0;s<t.length;s++)if(n>=t[s].min&&n<=t[s].max)return{zone:s+1,name:t[s].name};return null}class Fo{_powerZones=[];_hrZones=[];_lastPowerZone=null;_lastHrZone=null;_lastUpdateTime=null;_ftp=null;_maxHr=null;_currentPowerZone=null;_currentHrZone=null;_onChangeCallbacks=[];constructor(){this.loadProfile()}loadProfile(){const e=Bo();if(this._ftp=e.ftp,this._maxHr=e.maxHr,this._ftp){const t=Nt(this._ftp);this._powerZones=t.map((s,o)=>({zone:o+1,name:s.name,min:s.min,max:s.max,timeInZoneMs:0}))}if(this._maxHr){const t=Ft(this._maxHr);this._hrZones=t.map((s,o)=>({zone:o+1,name:s.name,min:s.min,max:s.max,timeInZoneMs:0}))}}onChange(e){this._onChangeCallbacks.push(e)}offChange(e){const t=this._onChangeCallbacks.indexOf(e);t>-1&&this._onChangeCallbacks.splice(t,1)}_notifyChange(){for(const e of this._onChangeCallbacks)try{e()}catch(t){console.error("Zone state change callback error:",t)}}updatePower(e,t=Date.now()){if(!this._ftp)return null;const s=$o(e,this._ftp);if(!s)return null;const o=s.zone;if(this._lastUpdateTime!==null&&this._lastPowerZone!==null){const r=t-this._lastUpdateTime,l=this._powerZones[this._lastPowerZone-1];l&&r>0&&r<5e3&&(l.timeInZoneMs+=r)}this._lastPowerZone=o,this._lastUpdateTime=t;const a=this._powerZones[o-1],i=a.max-a.min,c=i>0?Math.min(100,Math.max(0,(e-a.min)/i*100)):50;return this._currentPowerZone={zone:o,name:s.name,percentInZone:c},this._notifyChange(),this._currentPowerZone}updateHeartRate(e,t=Date.now()){if(!this._maxHr)return null;const s=No(e,this._maxHr);if(!s)return null;const o=s.zone;if(this._lastUpdateTime!==null&&this._lastHrZone!==null){const r=t-this._lastUpdateTime,l=this._hrZones[this._lastHrZone-1];l&&r>0&&r<5e3&&(l.timeInZoneMs+=r)}this._lastHrZone=o,(this._lastUpdateTime===null||t-this._lastUpdateTime>50)&&(this._lastUpdateTime=t);const a=this._hrZones[o-1],i=a.max-a.min,c=i>0?Math.min(100,Math.max(0,(e-a.min)/i*100)):50;return this._currentHrZone={zone:o,name:s.name,percentInZone:c},this._notifyChange(),this._currentHrZone}getCurrentPowerZone(){return this._currentPowerZone}getCurrentHrZone(){return this._currentHrZone}getPowerZoneDistribution(){const e=this._powerZones.reduce((t,s)=>t+s.timeInZoneMs,0);return{zones:[...this._powerZones],totalTimeMs:e}}getHrZoneDistribution(){const e=this._hrZones.reduce((t,s)=>t+s.timeInZoneMs,0);return{zones:[...this._hrZones],totalTimeMs:e}}hasPowerZones(){return this._ftp!==null&&this._ftp>0}hasHrZones(){return this._maxHr!==null&&this._maxHr>0}getFtp(){return this._ftp}getMaxHr(){return this._maxHr}reset(){this._powerZones.forEach(e=>e.timeInZoneMs=0),this._hrZones.forEach(e=>e.timeInZoneMs=0),this._lastPowerZone=null,this._lastHrZone=null,this._lastUpdateTime=null,this._currentPowerZone=null,this._currentHrZone=null,this._notifyChange()}toJSON(){return{powerZones:[...this._powerZones],hrZones:[...this._hrZones],ftp:this._ftp,maxHr:this._maxHr}}}const pt=5e3,Ro=100;let K;function Oo(){let n=document.getElementById("powerLiveChart"),e=document.getElementById("hrLiveChart"),t=document.getElementById("liveChartsContainer");if(!t){const s=document.getElementById("yourMetrics");if(s){t=document.createElement("div"),t.id="liveChartsContainer",t.className="live-charts-container",t.style.display="none";const o=document.getElementById("dataFieldsCarousel");o&&o.nextSibling?s.insertBefore(t,o.nextSibling):s.appendChild(t)}}return t&&(n||(n=document.createElement("bpt-live-chart"),n.id="powerLiveChart",n.setAttribute("type","power"),n.setAttribute("duration","60"),t.appendChild(n)),e||(e=document.createElement("bpt-live-chart"),e.id="hrLiveChart",e.setAttribute("type","heartrate"),e.setAttribute("duration","60"),t.appendChild(e))),{powerChart:n,hrChart:e}}function Vo(n){let e=document.getElementById("toggleLiveCharts");if(!e){const t=document.getElementById("topBarControls");if(t){e=document.createElement("button"),e.id="toggleLiveCharts",e.className="workout-btn workout-btn-chart",e.setAttribute("aria-label","Toggle live charts"),e.setAttribute("title","Toggle Charts"),e.innerHTML="üìä",e.style.display="none";const s=document.querySelector(".workout-controls");s?t.insertBefore(e,s):t.appendChild(e)}}return e&&e.setAttribute("aria-pressed",n?"true":"false"),e}const Uo=({measurementsState:n})=>{K=new Fo;const{powerChart:e,hrChart:t}=Oo();let s=localStorage.getItem("bpt-charts-visible")==="true";const o=Vo(s),a=document.getElementById("liveChartsContainer");a&&(a.style.display=s?"flex":"none"),o&&o.addEventListener("click",()=>{s=!s,localStorage.setItem("bpt-charts-visible",s?"true":"false"),o.setAttribute("aria-pressed",s?"true":"false"),a&&(a.style.display=s?"flex":"none")});let i=0,c=0,r=null,l=null;const u=()=>{if(e&&n.power.length>i){for(let p=i;p<n.power.length;p++){const h=n.power[p];e.addDataPoint(h.value,h.timestamp)}i=n.power.length}if(t&&n.heartrate.length>c){for(let p=c;p<n.heartrate.length;p++){const h=n.heartrate[p];t.addDataPoint(h.value,h.timestamp)}c=n.heartrate.length}},d=()=>{if(n.power.length>0){const p=n.power[n.power.length-1];if(Date.now()-p.timestamp<pt){const h=K.updatePower(p.value,p.timestamp),f=h?.zone??null;f!==r&&(f!==null&&r!==null&&O.announceZoneChange(h.name),r=f)}}if(n.heartrate.length>0){const p=n.heartrate[n.heartrate.length-1];if(Date.now()-p.timestamp<pt){const h=K.updateHeartRate(p.value,p.timestamp),f=h?.zone??null;f!==l&&(f!==null&&l!==null&&O.announceZoneChange(h.name),l=f)}}};return setInterval(()=>{d(),u()},Ro),document.addEventListener("workoutStarted",()=>{o&&(o.style.display="inline-flex")}),document.addEventListener("workoutStopped",()=>{o&&(o.style.display="none")}),window.addEventListener("storage",p=>{p.key==="bpt-user-profile"&&K.loadProfile()}),document.addEventListener("workout-discarded",()=>{K.reset(),i=0,c=0,e&&e.clear(),t&&t.clear()}),K},ce="https://api.bikepowertracker.com",zo="super-secret-bike-tracker-key";function xe(n={}){const e={...n};return e["X-API-Key"]=zo,e}async function Wo(n){const e=await fetch(`${ce}/api/streams/create`,{method:"POST",headers:xe({"Content-Type":"application/json"}),body:JSON.stringify({streamName:n})});if(!e.ok){const t=await e.json();throw new Error(t.error||"Failed to create stream")}return e.json()}async function Ho(){const n=await fetch(`${ce}/api/streams`,{headers:xe()});if(!n.ok){const e=await n.text();throw new Error(e||"Failed to list streams")}return n.json()}async function Zo(n,e,t="anonymous"){const s=await fetch(`${ce}/api/streams/${n}/messages`,{method:"POST",headers:xe({"Content-Type":"application/json"}),body:JSON.stringify({message:e,author:t})});if(!s.ok){const o=await s.json();throw new Error(o.error||"Failed to add message")}return s.json()}function He(n,e,t,s){const o=new AbortController;let a=!0;const i={close:()=>{a=!1,o.abort()},get active(){return a}};return(async()=>{try{const c=await fetch(n,{method:"GET",headers:xe({Accept:"text/event-stream","Cache-Control":"no-cache"}),signal:o.signal});if(!c.ok)throw new Error(`SSE connection failed: ${c.status} ${c.statusText}`);if(!c.body)throw new Error("SSE response has no body");const r=c.body.getReader(),l=new TextDecoder;let u="";for(;a;){const{done:d,value:p}=await r.read();if(d)break;u+=l.decode(p,{stream:!0});const h=u.split(`

`);u=h.pop()||"";for(const f of h){if(!f.trim())continue;const g=f.match(/^data:\s*(.+)$/m);if(g)try{const w=JSON.parse(g[1]);w.type==="connected"&&t?t(w):w.type==="message"&&e(w)}catch(w){console.error("Error parsing SSE data:",w)}}}}catch(c){if(c.name==="AbortError")return;console.error("SSE connection error:",c),s&&s(c)}finally{a=!1}})(),i}function qo(n,e,t,s){const o=`${ce}/api/streams/${n}/listen`;return He(o,e,t,s)}function Ko(n,e,t){const s=`${ce}/api/streams/listenAll`;return He(s,n,e,t)}async function Yo(n,e){const t=JSON.stringify({power:e.power??null,cadence:e.cadence??null,heartrate:e.heartrate??null,speed:e.speed??null,distance:e.distance??null,altitude:e.altitude??null,incline:e.incline??null,timestamp:e.timestamp,elapsed:e.elapsed,dataType:"workout_metrics"});return Zo(n,t,"bike-power-tracker")}class jo{modal=null;currentConnection=null;streamMetricsSection=null;allStreamsMetricsSection=null;allStreamsConnection=null;streamCards=new Map;streamRows=new Map;isCompactView=!1;constructor(){this.initModal(),this.initInlineViewer(),this.initAllStreamsViewer()}initInlineViewer(){if(this.streamMetricsSection=document.getElementById("streamMetrics"),!this.streamMetricsSection){console.warn("Stream metrics section not found in DOM");return}const e=document.getElementById("closeStreamView");e&&e.addEventListener("click",()=>this.disconnectFromStream())}initAllStreamsViewer(){if(this.allStreamsMetricsSection=document.getElementById("allStreamsMetrics"),!this.allStreamsMetricsSection){console.warn("All streams metrics section not found in DOM");return}const e=document.getElementById("closeAllStreamsView");e&&e.addEventListener("click",()=>this.disconnectFromAllStreams());const t=document.getElementById("toggleViewBtn");t&&t.addEventListener("click",()=>this.toggleAllStreamsView())}toggleAllStreamsView(){this.isCompactView=!this.isCompactView;const e=document.getElementById("allStreamsGrid"),t=document.getElementById("allStreamsList"),s=document.getElementById("toggleViewBtn");this.isCompactView?(e&&(e.style.display="none"),t&&(t.style.display="flex"),s&&(s.textContent="üî≤",s.title="Toggle grid view",s.classList.add("active"))):(e&&(e.style.display="grid"),t&&(t.style.display="none"),s&&(s.textContent="üìã",s.title="Toggle compact view",s.classList.remove("active")))}initModal(){const e=document.createElement("div");e.id="streamViewerModal",e.className="stream-modal",e.innerHTML=`
      <div class="stream-modal-content">
        <div class="stream-modal-header">
          <h2>üåê Live Streams</h2>
          <button id="closeStreamModal" class="close-button">&times;</button>
        </div>
        <div class="stream-modal-body">
          <div class="stream-list-container">
            <div class="stream-list-controls" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <button id="refreshStreamList" class="refresh-button">üîÑ Refresh List</button>
              <button id="viewAllStreamsBtn" class="connect-button" style="background-color: #4CAF50;">üëÅÔ∏è View All Streams</button>
            </div>
            <div id="streamsList" class="streams-list">
              <p class="loading">Loading streams...</p>
            </div>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e),this.modal=e,this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("closeStreamModal"),t=document.getElementById("refreshStreamList"),s=document.getElementById("viewAllStreamsBtn");e&&e.addEventListener("click",()=>this.close()),t&&t.addEventListener("click",()=>this.refreshStreamList()),s&&s.addEventListener("click",()=>this.connectToAllStreams()),this.modal&&this.modal.addEventListener("click",o=>{o.target===this.modal&&this.close()})}async open(){this.modal&&(this.modal.style.display="flex"),await this.refreshStreamList()}close(){this.modal&&(this.modal.style.display="none")}async refreshStreamList(){const e=document.getElementById("streamsList");if(e){e.innerHTML='<p class="loading">Loading streams...</p>';try{const{streams:t}=await Ho();if(t.length===0){e.innerHTML='<p class="no-streams">No active streams found</p>';return}e.innerHTML="",t.forEach(s=>{const o=this.createStreamItem(s);e.appendChild(o)})}catch(t){console.error("Failed to load streams:",t);const s=t instanceof Error?t.message:"Unknown error";e.innerHTML=`<p class="error">Failed to load streams: ${s}</p>`}}}createStreamItem(e){const t=document.createElement("div");t.className="stream-item";const o=e.name.startsWith("workout-")?"üö¥":"üí¨";return t.innerHTML=`
      <div class="stream-item-info">
        <div class="stream-item-name">${o} ${e.name}</div>
        <div class="stream-item-meta">
          ${e.length} message${e.length!==1?"s":""}
        </div>
      </div>
      <button class="connect-button" data-stream="${e.name}">
        üëÅÔ∏è View
      </button>
    `,t.querySelector(".connect-button")?.addEventListener("click",()=>{this.connectToStream(e.name)}),t}connectToStream(e){if(this.disconnectFromStream(),!this.streamMetricsSection){console.error("Stream metrics section not available");return}this.streamMetricsSection.style.display="flex";const t=document.getElementById("toggleStreamMetrics");t&&(t.checked=!0);const s=document.getElementById("streamTitle"),o=document.getElementById("streamStatus");s&&(s.textContent=e),o&&(o.textContent="Connecting...",o.className="status-badge connecting"),this.close();const a=this.streamMetricsSection.querySelector("reaction-panel");a&&(a.stream=e),this.currentConnection=qo(e,i=>this.handleStreamMessage(i),()=>this.handleStreamConnected(),i=>this.handleStreamError(i))}connectToAllStreams(){if(this.disconnectFromStream(),this.disconnectFromAllStreams(),!this.allStreamsMetricsSection){console.error("All streams metrics section not available");return}this.allStreamsMetricsSection.style.display="flex",this.close();const e=document.getElementById("allStreamsGrid"),t=document.getElementById("allStreamsList");e&&(e.innerHTML=""),t&&(t.innerHTML=""),this.streamCards.clear(),this.streamRows.clear();const s=document.getElementById("allStreamsStatus");s&&(s.textContent="Connecting...",s.className="status-badge connecting"),this.allStreamsConnection=Ko(o=>this.handleAllStreamsMessage(o),()=>this.handleAllStreamsConnected(),o=>this.handleAllStreamsError(o))}handleAllStreamsConnected(){console.log("Connected to all streams");const e=document.getElementById("allStreamsStatus");e&&(e.textContent="üü¢ Connected",e.className="status-badge connected")}handleAllStreamsError(e){console.error("All streams error:",e);const t=document.getElementById("allStreamsStatus");t&&(this.allStreamsConnection&&this.allStreamsConnection.active?(t.textContent="üîÑ Reconnecting...",t.className="status-badge reconnecting"):(t.textContent="üî¥ Error",t.className="status-badge error"))}disconnectFromAllStreams(){this.allStreamsConnection&&(this.allStreamsConnection.close(),this.allStreamsConnection=null),this.allStreamsMetricsSection&&(this.allStreamsMetricsSection.style.display="none");const e=document.getElementById("yourMetrics");e&&(e.style.display="flex")}handleAllStreamsMessage(e){try{const t=e.stream,s=typeof e.data=="string"?JSON.parse(e.data):e.data;this.updateStreamCard(t,s)}catch(t){console.error("Error parsing stream message:",t,e)}}updateStreamCard(e,t){const s=document.getElementById("allStreamsGrid"),o=document.getElementById("allStreamsList");let a={};try{t.message?a=JSON.parse(t.message):a=t}catch{}if(s){let i=this.streamCards.get(e);if(i||(i=document.createElement("div"),i.className="stream-card",i.innerHTML=`
          <div class="stream-card-name" title="${e}">${e}</div>
          <div class="stream-card-power">--</div>
          <div class="stream-card-secondary">
            <div class="stream-card-metric">
              <span>CAD</span>
              <span class="card-cadence">--</span>
            </div>
            <div class="stream-card-metric">
              <span>HR</span>
              <span class="card-heartrate">--</span>
            </div>
          </div>
        `,s.appendChild(i),this.streamCards.set(e,i)),a.power!==void 0&&a.power!==null){const c=i.querySelector(".stream-card-power");c&&(c.textContent=String(a.power))}if(a.cadence!==void 0&&a.cadence!==null){const c=i.querySelector(".card-cadence");c&&(c.textContent=String(a.cadence))}if(a.heartrate!==void 0&&a.heartrate!==null){const c=i.querySelector(".card-heartrate");c&&(c.textContent=String(a.heartrate))}}if(o){let i=this.streamRows.get(e);if(i||(i=document.createElement("div"),i.className="stream-row",i.innerHTML=`
          <span class="stream-row-name" title="${e}">${e}</span>
          <span class="stream-row-power">--</span>
        `,o.appendChild(i),this.streamRows.set(e,i)),a.power!==void 0&&a.power!==null){const c=i.querySelector(".stream-row-power");c&&(c.textContent=String(a.power))}}}disconnectFromStream(){if(this.disconnectFromAllStreams(),this.currentConnection&&(this.currentConnection.close(),this.currentConnection=null),this.streamMetricsSection){this.streamMetricsSection.style.display="none";const t=document.getElementById("toggleStreamMetrics");t&&(t.checked=!1)}const e=document.getElementById("yourMetrics");e&&(e.style.display="flex"),this.resetViewer()}handleStreamConnected(){const e=document.getElementById("streamStatus");e&&(e.textContent="üü¢ Connected",e.className="status-badge connected")}handleStreamMessage(e){try{const t=e.data?.message,s=typeof t=="string"?JSON.parse(t):e.data;(s.dataType==="workout_metrics"||s.power!==void 0||s.cadence!==void 0||s.heartrate!==void 0)&&this.updateMetrics(s);const o=document.getElementById("streamLastUpdate");if(o){const a=new Date;o.textContent=`Last update: ${a.toLocaleTimeString()}`}}catch(t){console.error("Error parsing stream message:",t,e)}}updateMetrics(e){const t=document.getElementById("streamPower"),s=document.getElementById("streamCadence"),o=document.getElementById("streamHeartrate"),a=document.getElementById("streamSpeed"),i=document.getElementById("streamDistance"),c=document.getElementById("streamAltitude"),r=document.getElementById("streamElapsed");t&&e.power!==null&&e.power!==void 0&&(t.textContent=String(e.power)),s&&e.cadence!==null&&e.cadence!==void 0&&(s.textContent=String(e.cadence)),o&&e.heartrate!==null&&e.heartrate!==void 0&&(o.textContent=String(e.heartrate)),a&&e.speed!==null&&e.speed!==void 0&&(a.textContent=String(e.speed)),i&&e.distance!==null&&e.distance!==void 0&&(i.textContent=String(e.distance)),c&&e.altitude!==null&&e.altitude!==void 0&&(c.textContent=String(e.altitude)),r&&e.elapsed&&(r.textContent=e.elapsed)}handleStreamError(e){console.error("Stream error:",e);const t=document.getElementById("streamStatus");t&&(this.currentConnection&&this.currentConnection.active?(t.textContent="üîÑ Reconnecting...",t.className="status-badge reconnecting"):(t.textContent="üî¥ Error",t.className="status-badge error"))}resetViewer(){["streamPower","streamCadence","streamHeartrate","streamSpeed","streamDistance","streamAltitude","streamElapsed"].forEach(s=>{const o=document.getElementById(s);o&&(o.textContent="--")});const t=document.getElementById("streamLastUpdate");t&&(t.textContent="Waiting for data...")}}function Go(){const n=new jo,e=document.getElementById("viewStreamsButton");return e&&e.addEventListener("click",()=>n.open()),n}class Jo{connection=null;callbacks=new Set;streamName=null;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=2e3;async start(e){this.streamName=e,this.reconnectAttempts=0,await this.connect()}stop(){this.connection&&(this.connection.close(),this.connection=null),this.streamName=null,this.reconnectAttempts=0}onReaction(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}async connect(){if(!this.streamName)return;const t=`https://api.bikepowertracker.com/api/streams/${this.streamName}/reactions/listen`;this.connection=He(t,s=>this.handleMessage(s),()=>console.log("Connected to reaction stream"),s=>this.handleError(s))}handleMessage(e){const t=e;if(t.type==="reaction"){const s={id:t.id,type:t.data.type,content:t.data.content,viewerId:t.data.viewerId,viewerName:t.data.viewerName,timestamp:parseInt(t.data.timestamp)};this.callbacks.forEach(o=>o(s))}}handleError(e){if(console.error("Reaction listener error:",e),this.reconnectAttempts<this.maxReconnectAttempts&&this.streamName){this.reconnectAttempts++;const t=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>this.connect(),t)}}}function Xo(n,e){let t=null,s=null;const o=async b=>{t&&t.stop(),t=new Jo,await t.start(b),s&&s.remove(),s=document.createElement("reaction-display"),document.body.appendChild(s),t.onReaction(R=>s?.addNotification(R))},a=()=>{t&&(t.stop(),t=null),s&&(s.remove(),s=null)},i=document.getElementById("startStreamButton"),c=document.getElementById("streamNameModal"),r=document.getElementById("closeStreamNameModal"),l=document.getElementById("cancelStreamName"),u=document.getElementById("confirmStreamName"),d=document.getElementById("streamNameInput"),p=document.getElementById("activeStreamToolbar"),h=document.getElementById("toolbarStreamName"),f=document.getElementById("streamPlayPauseBtn"),g=document.getElementById("streamStopBtn"),w=document.querySelector(".stream-indicator"),v=b=>{p&&(b.isStreaming?(p.style.display="flex",document.body.classList.add("has-stream-toolbar"),h&&(h.textContent=b.streamName),f&&(b.isPaused?(f.textContent="‚ñ∂Ô∏è",f.title="Resume Stream",w?.classList.add("paused")):(f.textContent="‚è∏Ô∏è",f.title="Pause Stream",w?.classList.remove("paused")))):(p.style.display="none",document.body.classList.remove("has-stream-toolbar")))};if(!i){console.warn("Start stream button not found in DOM");return}const C=()=>{c&&(c.style.display="none"),d&&(d.value="")},_=async()=>{const b=d?.value.trim()||"";try{const R=await n.startStreaming(b||void 0);i.textContent="üî¥ Stop Streaming",i.classList.add("streaming"),v(n.getStatus()),E(`Streaming to: ${R}`,"success"),await o(R),C()}catch(R){console.error("Failed to start streaming:",R);const Kt=R instanceof Error?R.message:"Unknown error";E("Failed to start streaming: "+Kt,"error")}},N=async()=>{try{await n.stopStreaming(),a(),i.textContent="üì° Start Streaming",i.classList.remove("streaming"),v(n.getStatus()),E("Streaming stopped","info")}catch(b){console.error(b),E("Error stopping stream","error")}};f&&f.addEventListener("click",()=>{n.getStatus().isPaused?(n.resumeStreaming(),E("Stream Resumed","success")):(n.pauseStreaming(),E("Stream Paused","info")),v(n.getStatus())}),g&&g.addEventListener("click",async()=>{confirm("Stop streaming?")&&await N()}),r&&r.addEventListener("click",C),l&&l.addEventListener("click",C),u&&u.addEventListener("click",_),d&&d.addEventListener("keypress",b=>{b.key==="Enter"&&_()}),c&&c.addEventListener("click",b=>{b.target===c&&C()}),i.addEventListener("click",async()=>{if(n.isStreaming)await N();else if(c)c.style.display="flex",d?.focus();else try{const b=await n.startStreaming();i.textContent="üî¥ Stop Streaming",i.classList.add("streaming"),v(n.getStatus()),E(`Streaming to: ${b}`,"success"),await o(b)}catch(b){console.error("Failed to start streaming:",b);const R=b instanceof Error?b.message:"Unknown error";E("Failed to start streaming: "+R,"error")}});const A=document.getElementById("pauseButton"),S=document.getElementById("stopButton"),M=()=>{e.running===!1&&n.isStreaming&&setTimeout(()=>{!e.running&&n.isStreaming&&(n.stopStreaming(),i.textContent="üì° Start Streaming",i.classList.remove("streaming"),v(n.getStatus()))},100)};A&&A.addEventListener("click",M),S&&S.addEventListener("click",M)}let q=[];function Qo(){const n=document.getElementById("createWorkoutBtn"),e=document.getElementById("closeBuilderModal"),t=document.getElementById("wbCancel"),s=document.getElementById("wbSave"),o=document.getElementById("wbAddStepRef");n&&n.addEventListener("click",ea),e&&e.addEventListener("click",Fe),t&&t.addEventListener("click",Fe),s&&s.addEventListener("click",sa),o&&o.addEventListener("click",na);const a=document.getElementById("wbTargetType");a&&a.addEventListener("change",()=>{const i=document.getElementById("wbTargetValue");i&&(i.parentElement.style.display=a.value==="open"?"none":"block")})}function ea(){const n=document.getElementById("workoutBuilderModal"),e=document.getElementById("workoutSelectionModal");e&&(e.style.display="none"),n&&(n.style.display="flex",ta())}function Fe(){const n=document.getElementById("workoutBuilderModal");n&&(n.style.display="none")}function ta(){q=[],document.getElementById("wbName").value="",document.getElementById("wbDesc").value="",Ze()}function na(){const n=document.getElementById("wbStepType").value,e=document.getElementById("wbStepDuration").value,t=document.getElementById("wbTargetType").value,s=document.getElementById("wbTargetValue").value,o=parseInt(e,10),a=t;if(isNaN(o)||o<=0){alert("Invalid duration");return}let i;if(a!=="open"&&(i=parseInt(s,10),isNaN(i))){alert("Invalid target value");return}const r={type:n,duration:o,target:{type:a==="open"?"open":"power",unit:a==="percent_ftp"?"percent_ftp":"watts",value:i},description:`${Rt(n)} (${Ot(o)})`};q.push(r),Ze(),y(`Added step: ${r.description}`,"polite")}function Ze(){const n=document.getElementById("wbStepsList");if(n){if(q.length===0){n.innerHTML=`<div class="wb-step-empty" style="text-align: center; color: var(--color-text-secondary); padding: 1rem; border: 1px dashed var(--color-border);">
                        No steps added yet.
                    </div>`;return}n.innerHTML="",q.forEach((e,t)=>{const s=document.createElement("div");s.className="wb-step-item",s.style.background="var(--card-bg-hover)",s.style.padding="8px",s.style.borderRadius="4px",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.border="1px solid var(--color-border)";const o=e.target,a=!o||o.type==="open"?"Open effort":`${o.value} ${o.unit==="percent_ftp"?"%":"W"}`;s.innerHTML=`
            <div>
                <strong>${t+1}. ${Rt(e.type)}</strong> - ${Ot(e.duration)}
                <div style="font-size: 0.85em; color: var(--color-text-secondary)">${a}</div>
            </div>
            <button class="remove-step-btn" data-index="${t}" style="color: var(--color-error); background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
        `,n.appendChild(s)}),n.querySelectorAll(".remove-step-btn").forEach(e=>{e.addEventListener("click",t=>{const s=parseInt(t.target.getAttribute("data-index")||"-1",10);s>=0&&(q.splice(s,1),Ze())})})}}function sa(){const n=document.getElementById("wbName").value.trim(),e=document.getElementById("wbDesc").value.trim();if(!n){alert("Please enter a workout name");return}if(q.length===0){alert("Please add at least one step");return}const t={id:crypto.randomUUID(),name:n,description:e,steps:q,tags:["custom"]};kt(t),Ie(),Fe(),y(`Workout saved: ${n}`,"assertive")}function Rt(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Ot(n){const e=Math.floor(n/60),t=n%60;return e>0?`${e}m ${t}s`:`${t}s`}const qe="bpt-dark-mode";function Vt(){try{const n=localStorage.getItem(qe);return n==="light"||n==="dark"||n==="system"?n:null}catch{return null}}function oa(n){try{localStorage.setItem(qe,n)}catch{}}function Ke(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function X(n){document.documentElement.setAttribute("data-theme",n)}function Ut(n){return n==="system"?Ke()?"dark":"light":n}function aa(){const n=Vt();if(n){const t=Ut(n);return X(t),t==="dark"}const e=Ke();return e&&X("dark"),e}function ia(n){const e=aa();n.checked=e,n.addEventListener("change",()=>{const s=n.checked?"dark":"light";X(s),oa(s),y(`Dark mode ${n.checked?"enabled":"disabled"}`)}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",s=>{const o=Vt();if(!o||o==="system"){const a=s.matches?"dark":"light";X(a),n.checked=s.matches,y(`Dark mode ${s.matches?"enabled":"disabled"}`)}}),window.addEventListener("storage",s=>{if(s.key===qe){const o=s.newValue;if(o){const a=Ut(o);X(a),n.checked=a==="dark"}else{const a=Ke();X(a?"dark":"light"),n.checked=a}}})}const H=[{id:"welcome",title:"Welcome to Bike Power Tracker!",icon:"üö¥",content:`
            <p>Let's set up your profile for personalized training zones and better workout analysis.</p>
            <p>This will only take a minute, and you can update these settings anytime.</p>
        `},{id:"ftp",title:"Functional Threshold Power (FTP)",icon:"‚ö°",content:`
            <p>Your FTP is the highest power you can sustain for about an hour.</p>
            <p>If you don't know your FTP, you can skip this and do an FTP test later.</p>
        `,inputType:"number",inputLabel:"Your FTP",inputPlaceholder:"e.g., 200",inputUnit:"watts",inputMin:50,inputMax:500,profileKey:"ftp",helpText:"Typical range: 100-400W for recreational to elite cyclists"},{id:"maxhr",title:"Maximum Heart Rate",icon:"‚ù§Ô∏è",content:`
            <p>Your max HR is used to calculate heart rate training zones.</p>
            <p>A common estimate is 220 minus your age, but actual max HR varies.</p>
        `,inputType:"number",inputLabel:"Your Max HR",inputPlaceholder:"e.g., 185",inputUnit:"bpm",inputMin:100,inputMax:230,profileKey:"maxHr",helpText:"If unsure, use 220 - your age as a starting point"},{id:"weight",title:"Body Weight",icon:"‚öñÔ∏è",content:`
            <p>Your weight is used to calculate power-to-weight ratio (W/kg), an important metric for climbing.</p>
        `,inputType:"number",inputLabel:"Your Weight",inputPlaceholder:"e.g., 70",inputUnit:"kg",inputMin:30,inputMax:200,profileKey:"weight",helpText:"Used for calculating watts per kilogram (W/kg)"},{id:"sensors",title:"Connect Your Sensors",icon:"üì°",content:`
            <p>Bike Power Tracker works with Bluetooth cycling sensors:</p>
            <ul style="text-align: left; margin: 16px auto; max-width: 280px;">
                <li><strong>‚ö° Power Meter</strong> - Measures your power output in watts</li>
                <li><strong>üö¥ Cadence Sensor</strong> - Tracks your pedaling speed (RPM)</li>
                <li><strong>‚ù§Ô∏è Heart Rate Monitor</strong> - Monitors your heart rate</li>
            </ul>
            <p>Use the menu (‚ò∞) to connect your sensors before starting a workout.</p>
        `},{id:"shortcuts",title:"Keyboard Shortcuts",icon:"‚å®Ô∏è",content:`
            <p>Quick access to common actions:</p>
            <table style="margin: 16px auto; text-align: left; border-collapse: collapse;">
                <tr><td style="padding: 4px 12px;"><kbd>Space</kbd></td><td>Start/pause workout</td></tr>
                <tr><td style="padding: 4px 12px;"><kbd>L</kbd></td><td>Mark lap</td></tr>
                <tr><td style="padding: 4px 12px;"><kbd>M</kbd></td><td>Open menu</td></tr>
                <tr><td style="padding: 4px 12px;"><kbd>S</kbd></td><td>Open settings</td></tr>
                <tr><td style="padding: 4px 12px;"><kbd>E</kbd></td><td>Export data</td></tr>
                <tr><td style="padding: 4px 12px;"><kbd>Escape</kbd></td><td>Close modal</td></tr>
            </table>
        `},{id:"done",title:"You're All Set!",icon:"üéâ",content:`
            <p>Your profile has been saved. You can update your settings anytime from the menu.</p>
            <p>Ready to start your first workout? Connect a sensor and press the <strong>‚ñ∂Ô∏è Start</strong> button!</p>
        `}];function ra(){const n=document.createElement("div");return n.id="onboardingModal",n.className="stream-modal",n.setAttribute("role","dialog"),n.setAttribute("aria-labelledby","onboardingTitle"),n.setAttribute("aria-modal","true"),n.style.display="none",n.innerHTML=`
        <div class="stream-modal-content onboarding-modal" style="max-width: 480px;">
            <div class="stream-modal-header">
                <h2 id="onboardingTitle">
                    <span id="onboardingIcon">üö¥</span>
                    <span id="onboardingStepTitle">Welcome</span>
                </h2>
                <button id="skipOnboarding" class="close-button" aria-label="Skip onboarding">&times;</button>
            </div>
            <div class="stream-modal-body" style="text-align: center; padding: 24px;">
                <div id="onboardingContent"></div>
                <div id="onboardingInput" style="margin: 20px 0; display: none;">
                    <label for="onboardingInputField" id="onboardingInputLabel" style="display: block; margin-bottom: 8px; font-weight: bold;"></label>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <input type="number" id="onboardingInputField" 
                            style="width: 120px; padding: 12px; font-size: 18px; text-align: center; border: 2px solid #d0d7de; border-radius: 8px;"
                            aria-describedby="onboardingHelpText">
                        <span id="onboardingInputUnit" style="font-size: 16px; color: #666;"></span>
                    </div>
                    <p id="onboardingHelpText" style="margin-top: 8px; font-size: 12px; color: #666;"></p>
                </div>
                <div class="onboarding-progress" style="margin: 24px 0;">
                    <div id="onboardingProgressDots" style="display: flex; justify-content: center; gap: 8px;"></div>
                </div>
                <div class="onboarding-buttons" style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
                    <button id="onboardingPrev" style="padding: 12px 24px; border: 1px solid #d0d7de; background: white; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚Üê Back
                    </button>
                    <button id="onboardingNext" style="padding: 12px 24px; border: none; background: #2196F3; color: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    `,n}function ca(n,e,t){n.innerHTML="";for(let s=0;s<t;s++){const o=document.createElement("span");o.style.cssText=`
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: ${s===e?"#2196F3":"#d0d7de"};
            transition: background 0.3s ease;
        `,o.setAttribute("aria-hidden","true"),n.appendChild(o)}}function la(n,e,t,s){const{icon:o,title:a,content:i,inputContainer:c,inputField:r,inputLabel:l,inputUnit:u,helpText:d,prevBtn:p,nextBtn:h,progressDots:f}=s;if(o.textContent=n.icon,a.textContent=n.title,i.innerHTML=n.content,n.inputType==="number"&&n.profileKey){c.style.display="block",l.textContent=n.inputLabel||"",r.placeholder=n.inputPlaceholder||"",r.min=String(n.inputMin||0),r.max=String(n.inputMax||9999),u.textContent=n.inputUnit||"",d.textContent=n.helpText||"";const g=t[n.profileKey];r.value=g?String(g):"",r.focus()}else c.style.display="none";p.style.display=e===0?"none":"inline-block",e===H.length-1?h.textContent="Get Started! üöÄ":(n.inputType,h.textContent="Next ‚Üí"),ca(f,e,H.length),y(`Step ${e+1} of ${H.length}: ${n.title}`)}function da(n=!1){return new Promise(e=>{const t=Ue();if(!n&&t.onboardingComplete){e(t);return}let s=document.getElementById("onboardingModal");s||(s=ra(),document.body.appendChild(s));const o=B("onboardingIcon"),a=B("onboardingStepTitle"),i=B("onboardingContent"),c=B("onboardingInput"),r=B("onboardingInputField"),l=B("onboardingInputLabel"),u=B("onboardingInputUnit"),d=B("onboardingHelpText"),p=B("onboardingPrev"),h=B("onboardingNext"),f=B("skipOnboarding"),g=B("onboardingProgressDots"),w={icon:o,title:a,content:i,inputContainer:c,inputField:r,inputLabel:l,inputUnit:u,helpText:d,prevBtn:p,nextBtn:h,progressDots:g};let v=0;const C=()=>{const M=H[v];if(M.inputType==="number"&&M.profileKey){const b=r.value?parseFloat(r.value):null;b!==null&&M.profileKey!=="onboardingComplete"&&M.profileKey!=="lastUpdated"&&(t[M.profileKey]=b)}},_=()=>{la(H[v],v,t,w)},N=()=>{if(H[v].inputType==="number"&&!r.checkValidity()){r.reportValidity();return}C(),v<H.length-1?(v++,_()):(t.onboardingComplete=!0,tt(t),s.style.display="none",E("Profile saved! Ready to ride üö¥","success"),y("Onboarding complete. Profile saved."),e(t))},A=()=>{C(),v>0&&(v--,_())},S=()=>{t.onboardingComplete=!0,tt(t),s.style.display="none",y("Onboarding skipped"),e(t)};h.addEventListener("click",N),p.addEventListener("click",A),f.addEventListener("click",S),r.addEventListener("keydown",M=>{M.key==="Enter"&&N()}),s.style.display="flex",_(),En(s.querySelector(".stream-modal-content"))})}function ua(){return!Ue().onboardingComplete}function ma(){ua()&&setTimeout(()=>{da()},500)}function pa(n){const e=Math.floor(n/1e3),t=Math.floor(e/60),s=Math.floor(t/60);return s>0?`${s}h ${t%60}m`:t>0?`${t}m ${e%60}s`:`${e}s`}function ha(n){return new Date(n).toLocaleString()}function fa(n){const e=document.createElement("dialog");e.id="workout-recovery-modal",e.className="modal",e.setAttribute("aria-labelledby","recovery-modal-title");const t=n.power.length+n.heartrate.length+n.cadence.length,s=n.lastUpdated-n.startTime;return e.innerHTML=`
        <div class="modal-content">
            <h2 id="recovery-modal-title">üîÑ Recover Workout?</h2>
            <p>An interrupted workout was found from your last session.</p>
            
            <div class="recovery-summary">
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Started</span>
                    <span class="recovery-stat-value">${ha(n.startTime)}</span>
                </div>
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Duration</span>
                    <span class="recovery-stat-value">${pa(s)}</span>
                </div>
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Data Points</span>
                    <span class="recovery-stat-value">${t.toLocaleString()}</span>
                </div>
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Power Readings</span>
                    <span class="recovery-stat-value">${n.power.length.toLocaleString()}</span>
                </div>
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Heart Rate Readings</span>
                    <span class="recovery-stat-value">${n.heartrate.length.toLocaleString()}</span>
                </div>
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Cadence Readings</span>
                    <span class="recovery-stat-value">${n.cadence.length.toLocaleString()}</span>
                </div>
                ${n.laps.length>0?`
                <div class="recovery-stat">
                    <span class="recovery-stat-label">Laps</span>
                    <span class="recovery-stat-value">${n.laps.length}</span>
                </div>
                `:""}
            </div>
            
            <div class="modal-actions">
                <button type="button" id="recovery-restore-btn" class="btn btn-primary">
                    ‚úì Restore Workout
                </button>
                <button type="button" id="recovery-discard-btn" class="btn btn-secondary">
                    ‚úï Start Fresh
                </button>
            </div>
        </div>
    `,e}function ga(){if(document.getElementById("recovery-modal-styles"))return;const n=document.createElement("style");n.id="recovery-modal-styles",n.textContent=`
        #workout-recovery-modal {
            max-width: 400px;
        }
        
        .recovery-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--surface-2, #2a2a2a);
            border-radius: 8px;
        }
        
        .recovery-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .recovery-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted, #888);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .recovery-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }
        
        #workout-recovery-modal .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        #workout-recovery-modal .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }
    `,document.head.appendChild(n)}async function ya(n){ga();const e=fa(n);return document.body.appendChild(e),new Promise(t=>{const s=e.querySelector("#recovery-restore-btn"),o=e.querySelector("#recovery-discard-btn"),a=()=>{e.close(),e.remove()};s.addEventListener("click",()=>{a(),t("restore")}),o.addEventListener("click",()=>{a(),t("discard")}),e.addEventListener("cancel",i=>{i.preventDefault()}),e.showModal()})}async function va(n,e){try{if(!await Gt())return!1;const t=await Jt();return t?await ya(t)==="restore"?(n.restore({heartrate:t.heartrate,power:t.power,cadence:t.cadence,speed:t.speed,distance:t.distance,altitude:t.altitude,laps:t.laps,gps:t.gps||[]},t.startTime),e.startTime=t.startTime,e.running=!1,console.log(`Restored workout with ${t.power.length} power readings`),!0):(await yt(),console.log("User discarded recovered workout"),!1):!1}catch(t){return console.error("Error during workout recovery:",t),!1}}let Z=null;const wa=()=>{window.addEventListener("beforeinstallprompt",n=>{n.preventDefault(),Z=n,Re()}),window.addEventListener("appinstalled",()=>{console.log("PWA was installed successfully"),Z=null,Re()})},ht=()=>Z!==null,$i=async()=>{if(!Z)return"unavailable";try{await Z.prompt();const{outcome:n}=await Z.userChoice;return console.log(`User response to the install prompt: ${n}`),Z=null,Re(),n}catch(n){return console.error("Error triggering install prompt:",n),"unavailable"}},Re=()=>{const n=document.getElementById("installPwaButton"),e=document.getElementById("installPwaContainer");n&&(n.style.display=ht()?"block":"none"),e&&(e.style.display=ht()?"block":"none")};function ba(){const n=document.getElementById("aboutButton"),e=document.getElementById("aboutModal"),t=document.getElementById("closeAboutModal");if(!n||!e)return;const s=()=>{e.style.display="flex";const a=document.querySelector("header details");a&&a.removeAttribute("open")},o=()=>{e.style.display="none"};n.addEventListener("click",s),t?.addEventListener("click",o),window.addEventListener("click",a=>{a.target===e&&o()})}const Sa=()=>{let n=null;const e=async()=>{try{"wakeLock"in navigator&&(n=await navigator.wakeLock.request("screen"),console.log("Screen wake lock activated"),n.addEventListener("release",()=>{console.log("Screen wake lock released")}))}catch(t){console.error("Wake lock request failed:",t)}};document.visibilityState==="visible"&&e(),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e()})};function Ea(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:s,onRegistered:o,onRegisteredSW:a,onRegisterError:i}=n;let c,r;const l=async(d=!0)=>{await r};async function u(){if("serviceWorker"in navigator){if(c=await T(async()=>{const{Workbox:d}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:d}},[]).then(({Workbox:d})=>new d("/sw.js",{scope:"/",type:"classic"})).catch(d=>{i?.(d)}),!c)return;c.addEventListener("activated",d=>{(d.isUpdate||d.isExternal)&&window.location.reload()}),c.addEventListener("installed",d=>{d.isUpdate||s?.()}),c.register({immediate:e}).then(d=>{a?a("/sw.js",d):o?.(d)}).catch(d=>{i?.(d)})}}return r=u(),l}const Ta=()=>{if(Oe.isNativePlatform()){console.log("Service Worker disabled on native platform"),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{for(const t of e)t.unregister()});return}const n=Ea({onNeedRefresh(){Ca(n)},onOfflineReady(){console.log("App ready to work offline")},onRegistered(e){console.log("Service Worker registered successfully"),e&&setInterval(()=>{e.update()},3600*1e3)},onRegisterError(e){console.log("Service Worker registration failed:",e)}})},Ca=n=>{const e=document.getElementById("updateNotification");if(!e)return;e.style.display="block",document.getElementById("updateButton")?.addEventListener("click",()=>{n(!0)},{once:!0}),document.getElementById("dismissUpdate")?.addEventListener("click",()=>{e.style.display="none"},{once:!0})};var ka=Qt();const pe=en(ka);class Ia{state;map=null;routeLine=null;currentPosMarker=null;mounted=!1;animationFrameId=null;lastGpsCount=0;defaultZoom=15;followUser=!0;constructor(e){this.state=e}mount(e){if(!document.getElementById(e)){console.warn(`MapComponent: Element with ID "${e}" not found.`);return}this.map=pe.map(e);const s=this.state.gps.length>0,o=s?this.state.gps[this.state.gps.length-1].lat:0,a=s?this.state.gps[this.state.gps.length-1].lon:0,i=s?this.defaultZoom:2;this.map.setView([o,a],i),pe.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map),this.routeLine=pe.polyline([],{color:"var(--color-primary, #007bff)",weight:5,opacity:.7}).addTo(this.map),this.currentPosMarker=pe.circleMarker([o,a],{radius:8,fillColor:"var(--color-accent, #28a745)",color:"#ffffff",weight:2,opacity:1,fillOpacity:.8}),s&&this.currentPosMarker.addTo(this.map),this.mounted=!0,this.lastGpsCount=0,this.startLoop(),this.update(),setTimeout(()=>{this.map?.invalidateSize()},100)}unmount(){this.mounted=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.map&&(this.map.remove(),this.map=null),this.routeLine=null,this.currentPosMarker=null}update(){if(!this.mounted||!this.map||!this.routeLine||!this.currentPosMarker)return;const e=this.state.gps;if(e.length===this.lastGpsCount)return;const t=e.map(s=>[s.lat,s.lon]);if(this.routeLine.setLatLngs(t),e.length>0){const s=e[e.length-1],o=[s.lat,s.lon];this.currentPosMarker.setLatLng(o),this.map.hasLayer(this.currentPosMarker)||this.currentPosMarker.addTo(this.map),this.followUser&&(this.lastGpsCount===0?this.map.setView(o,this.defaultZoom):this.map.panTo(o,{animate:!0}))}this.lastGpsCount=e.length}startLoop(){const e=()=>{this.mounted&&(this.update(),this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e)}resize(){this.map?.invalidateSize()}}function xa(n,e){const t="gpsMap",s="toggleMapBtn",o="dataFieldsCarousel",a=document.getElementById(s),i=document.getElementById(t),c=document.getElementById(o);if(!a||!i||!c){console.warn("Map initialization failed: Missing elements");return}const r=new Ia(n);let l=!1;a.style.display="none",a.addEventListener("click",()=>{l=!l,l?(c.style.display="none",i.style.display="block",a.classList.add("active"),a.style.background="#ccc",r.mount(t),setTimeout(()=>{r.resize()},100)):(i.style.display="none",c.style.display="block",a.classList.remove("active"),a.style.background="")}),setInterval(()=>{const u=n.gps.length>0;(e.gps?.isConnected||u)&&a.style.display==="none"&&(a.style.display="inline-block")},2e3)}class La{measurementsState;timeState;callbacks;state;changeCallback=null;constructor(e,t,s){this.measurementsState=e,this.timeState=t,this.callbacks=s,this.state={isAutoPaused:!1,belowThresholdSince:null,delayTimer:null}}start(){this.stop();const e=x();if(!e.autoPause.enabled){console.log("[AutoPause] Disabled, not starting");return}console.log("[AutoPause] Starting with settings:",e.autoPause),this.changeCallback=()=>this.checkMetric(),this.measurementsState.onChange(this.changeCallback),this.startPeriodicCheck()}stop(){this.changeCallback&&(this.measurementsState.offChange(this.changeCallback),this.changeCallback=null),this.clearDelayTimer(),this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.state={isAutoPaused:!1,belowThresholdSince:null,delayTimer:null},console.log("[AutoPause] Stopped")}get isAutoPaused(){return this.state.isAutoPaused}getCurrentValue(e){const o=Date.now()-5e3;let a;switch(e){case"speed":a=this.measurementsState.speed;break;case"power":a=this.measurementsState.power;break;case"cadence":a=this.measurementsState.cadence;break;default:return null}const i=a.filter(r=>r.timestamp>=o);return i.length===0?null:i[i.length-1].value}checkMetric(){const e=x();if(!e.autoPause.enabled||!this.timeState.startTime)return;const{source:t,threshold:s,delay:o}=e.autoPause,a=this.getCurrentValue(t);if(a===null)return;const i=a>=s,c=Date.now();if(i)this.clearDelayTimer(),this.state.belowThresholdSince=null,this.state.isAutoPaused&&!this.timeState.running&&(console.log(`[AutoPause] Resuming - ${t} at ${a.toFixed(1)} (threshold: ${s})`),this.state.isAutoPaused=!1,this.callbacks.onAutoResume());else{this.state.belowThresholdSince||(this.state.belowThresholdSince=c);const r=c-this.state.belowThresholdSince,l=o*1e3;!this.state.isAutoPaused&&this.timeState.running&&r>=l&&(console.log(`[AutoPause] Pausing - ${t} at ${a.toFixed(1)} (threshold: ${s}) for ${(r/1e3).toFixed(1)}s`),this.state.isAutoPaused=!0,this.callbacks.onAutoPause())}}clearDelayTimer(){this.state.delayTimer&&(clearTimeout(this.state.delayTimer),this.state.delayTimer=null)}intervalId=null;startPeriodicCheck(){this.intervalId&&clearInterval(this.intervalId),this.intervalId=setInterval(()=>{this.checkMetric()},1e3)}reset(){this.stop(),this.state={isAutoPaused:!1,belowThresholdSince:null,delayTimer:null}}getStatus(){const e=x();return{enabled:e.autoPause.enabled,isAutoPaused:this.state.isAutoPaused,source:e.autoPause.source,threshold:e.autoPause.threshold,currentValue:this.getCurrentValue(e.autoPause.source)}}}function Ni(n){switch(n){case"speed":return"km/h";case"power":return"W";case"cadence":return"rpm";default:return""}}function Ma(n){if(n.length<2)return 0;let e=0;const t=6371e3;for(let s=1;s<n.length;s++){const o=n[s-1],a=n[s],i=o.lat*Math.PI/180,c=a.lat*Math.PI/180,r=(a.lat-o.lat)*Math.PI/180,l=(a.lon-o.lon)*Math.PI/180,u=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i)*Math.cos(c)*Math.sin(l/2)*Math.sin(l/2),d=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));e+=t*d}return e}class _a{measurementsState=null;timeState=null;lastLapDistanceKm=0;lastLapTimeMs=0;checkInterval=null;isActive=!1;onLapCallback=null;init(e,t){this.measurementsState=e,this.timeState=t}onLap(e){this.onLapCallback=e}start(){if(this.isActive||!this.measurementsState||!this.timeState)return;const e=x();e.autoLap.enabled&&(this.isActive=!0,this.lastLapDistanceKm=0,this.lastLapTimeMs=0,this.checkInterval=setInterval(()=>this.checkAutoLap(),1e3),console.log(`AutoLap started: ${e.autoLap.source} mode`))}stop(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.isActive=!1,this.lastLapDistanceKm=0,this.lastLapTimeMs=0}reset(){this.stop()}checkAutoLap(){if(!this.measurementsState||!this.timeState||!this.timeState.running)return;const e=x();if(!e.autoLap.enabled){this.stop();return}e.autoLap.source==="distance"?this.checkDistanceAutoLap(e.autoLap.distanceKm):e.autoLap.source==="time"&&this.checkTimeAutoLap(e.autoLap.timeMinutes)}checkDistanceAutoLap(e){if(!this.measurementsState)return;const s=Ma(this.measurementsState.gps)/1e3,o=Math.floor(s/e),a=Math.floor(this.lastLapDistanceKm/e);o>a&&s>0&&(this.triggerAutoLap(),this.lastLapDistanceKm=s)}checkTimeAutoLap(e){if(!this.timeState||!this.timeState.startTime)return;const t=Date.now()-this.timeState.startTime,s=e*60*1e3,o=Math.floor(t/s),a=Math.floor(this.lastLapTimeMs/s);o>a&&t>0&&(this.triggerAutoLap(),this.lastLapTimeMs=t)}triggerAutoLap(){if(!this.measurementsState||!this.timeState)return;const e=this.measurementsState.laps,t=e.length>0?e[e.length-1].timestamp:this.timeState.startTime||Date.now(),s=this.measurementsState.addLap(this.timeState.startTime),o=s.timestamp,a=o-t,i=this.measurementsState.power.filter(r=>r.timestamp>=t&&r.timestamp<=o),c=i.length>0?i.reduce((r,l)=>r+l.value,0)/i.length:0;O.announceLap(s.number,a,c),console.log(`Auto-lap marked: ${s.number} at ${new Date(s.timestamp).toISOString()}`),this.onLapCallback&&this.onLapCallback(s.number)}isAutoLapActive(){return this.isActive}}const Y=new _a,Fi=n=>n.unitSystem==="imperial",Aa=[{zone:1,name:"Recovery",minPercent:0,maxPercent:55,color:"#9ca3af"},{zone:2,name:"Endurance",minPercent:55,maxPercent:75,color:"#22c55e"},{zone:3,name:"Tempo",minPercent:75,maxPercent:90,color:"#eab308"},{zone:4,name:"Threshold",minPercent:90,maxPercent:105,color:"#f97316"},{zone:5,name:"VO2max",minPercent:105,maxPercent:120,color:"#ef4444"},{zone:6,name:"Anaerobic",minPercent:120,maxPercent:150,color:"#a855f7"},{zone:7,name:"Neuromuscular",minPercent:150,maxPercent:999,color:"#ec4899"}],Pa=[{zone:1,name:"Recovery",minPercent:50,maxPercent:60,color:"#9ca3af"},{zone:2,name:"Aerobic",minPercent:60,maxPercent:70,color:"#22c55e"},{zone:3,name:"Tempo",minPercent:70,maxPercent:80,color:"#eab308"},{zone:4,name:"Threshold",minPercent:80,maxPercent:90,color:"#f97316"},{zone:5,name:"VO2max",minPercent:90,maxPercent:100,color:"#ef4444"}],Te=new Map,zt=[];function Ri(n){if(Te.has(n.id)){console.warn(`Data field '${n.id}' is already registered. Skipping duplicate.`);return}if(!n.id||!n.name||!n.category||!n.formatter)throw new Error(`Invalid data field definition: missing required properties for '${n.id}'`);Te.set(n.id,n),zt.push(n.id)}function Wt(n){return Te.get(n)}function ee(){return zt.map(n=>Te.get(n))}function Oi(n){return ee().filter(e=>e.category===n)}function Vi(){const n=new Map;for(const e of ee()){const t=n.get(e.category)||[];t.push(e),n.set(e.category,t)}return n}function Ui(n){const e=n.toLowerCase().trim();return e?ee().filter(t=>t.name.toLowerCase().includes(e)||t.shortName.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)||t.id.toLowerCase().includes(e)):ee()}const Da={realtime:100,second:1e3,periodic:5e3,"on-change":0,manual:0};class Ba{constructor(e,t,s,o={}){this.measurements=e,this.workoutState=t,this.settings=s,this.config={enableRealtime:o.enableRealtime??!0,updateIntervals:{...Da,...o.updateIntervals}},this.categorizeFieldsByFrequency()}calculatedValues=new Map;updateTimers=new Map;listeners=new Set;isRunning=!1;config;fieldsByFrequency=new Map;start(){if(!this.isRunning){this.isRunning=!0,this.calculateAllFields();for(const[e,t]of this.fieldsByFrequency){if(t.length===0)continue;const s=this.config.updateIntervals[e];if(s===void 0||s<=0||e==="realtime"&&!this.config.enableRealtime)continue;const o=window.setInterval(()=>{this.calculateFieldsForFrequency(e)},s);this.updateTimers.set(e,o)}}}stop(){if(this.isRunning){this.isRunning=!1;for(const e of this.updateTimers.values())clearInterval(e);this.updateTimers.clear()}}pause(){this.stop()}resume(){this.isRunning||this.start()}isActive(){return this.isRunning}updateMeasurements(e){this.measurements=e}updateWorkoutState(e){this.workoutState=e}updateSettings(e){this.settings=e,this.isRunning&&this.calculateAllFields()}onUpdate(e){return this.listeners.add(e),()=>this.listeners.delete(e)}removeAllListeners(){this.listeners.clear()}getValue(e){return this.calculatedValues.get(e)??null}getAllValues(){return new Map(this.calculatedValues)}getValues(e){const t=new Map;for(const s of e)t.set(s,this.calculatedValues.get(s)??null);return t}calculateField(e){const t=Wt(e);if(!t)return null;const s=this.executeCalculation(t);return this.updateValue(e,s),s}calculateAllFields(){const e=ee(),t=[];for(const s of e)if(s.calculator){const o=this.executeCalculation(s);t.push({fieldId:s.id,value:o,timestamp:Date.now()})}for(const s of t)this.updateValue(s.fieldId,s.value)}calculateFieldsForFrequency(e){const t=this.fieldsByFrequency.get(e);if(t){for(const s of t)if(s.calculator){const o=this.executeCalculation(s);this.updateValue(s.id,o)}}}categorizeFieldsByFrequency(){this.fieldsByFrequency.clear();const e=["realtime","second","periodic","on-change","manual"];for(const s of e)this.fieldsByFrequency.set(s,[]);const t=ee();for(const s of t)if(s.calculator){const o=this.fieldsByFrequency.get(s.updateFrequency);o&&o.push(s)}}executeCalculation(e){if(!e.calculator)return null;try{return e.calculator(this.measurements,this.workoutState,this.settings)}catch(t){return console.warn(`Calculation error for field ${e.id}:`,t),null}}updateValue(e,t){this.calculatedValues.get(e)!==t&&(this.calculatedValues.set(e,t),this.notifyListeners(e,t))}notifyListeners(e,t){for(const s of this.listeners)try{s(e,t)}catch(o){console.warn("Error in field update listener:",o)}}}function $a(n,e,t,s){return new Ba(n,e,t,s)}let ye=0;function m(n,e="medium"){return ye++,{id:`default-slot-${ye}`,fieldId:n,size:e,position:ye}}function L(){ye=0}function Na(){return L(),{id:"cycling-main",name:"Main",icon:"üö¥",layout:"auto",slots:[m("power-current","large"),m("heartrate-current","medium"),m("cadence-current","medium"),m("speed-current","medium"),m("distance-total","medium"),m("time-elapsed","medium")]}}function Fa(){return L(),{id:"cycling-power",name:"Power",icon:"‚ö°",layout:"auto",slots:[m("power-current","large"),m("power-3s","medium"),m("power-avg","medium"),m("power-normalized","medium"),m("power-max","medium"),m("power-zone","medium")]}}function Ra(){return L(),{id:"cycling-hr",name:"Heart Rate",icon:"‚ù§Ô∏è",layout:"auto",slots:[m("heartrate-current","large"),m("heartrate-avg","medium"),m("heartrate-max","medium"),m("heartrate-zone","medium"),m("heartrate-percent-max","medium"),m("calories-burned","medium")]}}function Oa(){return L(),{id:"cycling-climb",name:"Climbing",icon:"‚õ∞Ô∏è",layout:"auto",slots:[m("grade-current","large"),m("elevation-current","medium"),m("elevation-gain","medium"),m("elevation-loss","medium"),m("vertical-speed","medium"),m("power-current","medium")]}}function Va(){return L(),{id:"cycling-laps",name:"Laps",icon:"üèÅ",layout:"auto",slots:[m("time-lap-number","medium"),m("time-lap","large"),m("distance-lap","medium"),m("power-lap-avg","medium"),m("hr-lap-avg","medium"),m("speed-lap-avg","medium")]}}function Ua(){return L(),{id:"cycling-simple",name:"Simple",icon:"üìä",layout:"grid-2",slots:[m("speed-current","large"),m("distance-total","large"),m("time-elapsed","large"),m("elevation-gain","large")]}}function za(){return L(),{id:"indoor-main",name:"Main",icon:"üè†",layout:"auto",slots:[m("power-current","large"),m("heartrate-current","medium"),m("cadence-current","medium"),m("time-elapsed","medium"),m("power-avg","medium"),m("kilojoules","medium")]}}function Wa(){return L(),{id:"indoor-power",name:"Power",icon:"‚ö°",layout:"auto",slots:[m("power-current","large"),m("power-3s","medium"),m("power-10s","medium"),m("power-30s","medium"),m("power-normalized","medium"),m("intensity-factor","medium")]}}function Ha(){return L(),{id:"indoor-training",name:"Training",icon:"üìà",layout:"auto",slots:[m("tss","large"),m("intensity-factor","medium"),m("power-normalized","medium"),m("kilojoules","medium"),m("time-elapsed","medium"),m("power-avg","medium")]}}function Za(){return L(),{id:"indoor-zones",name:"Zones",icon:"üéØ",layout:"auto",slots:[m("power-zone","large"),m("heartrate-zone","large"),m("power-percent-ftp","medium"),m("heartrate-percent-max","medium"),m("cadence-zone","medium"),m("time-elapsed","medium")]}}function qa(){return L(),{id:"running-main",name:"Main",icon:"üèÉ",layout:"auto",slots:[m("pace-current","large"),m("heartrate-current","medium"),m("cadence-current","medium"),m("distance-total","medium"),m("time-elapsed","medium"),m("pace-avg","medium")]}}function Ka(){return L(),{id:"running-pace",name:"Pace",icon:"‚è±Ô∏è",layout:"auto",slots:[m("pace-current","large"),m("pace-avg","medium"),m("speed-current","medium"),m("speed-avg","medium"),m("distance-total","medium"),m("time-elapsed","medium")]}}const le={id:"default-cycling",name:"Outdoor Cycling",activityType:"cycling",icon:"üö¥",screens:[Na(),Fa(),Ra(),Oa(),Va()],activeScreenIndex:0},Ye={id:"default-indoor",name:"Indoor Training",activityType:"indoor",icon:"üè†",screens:[za(),Wa(),Ha(),Za()],activeScreenIndex:0},Ya={id:"default-running",name:"Running",activityType:"running",icon:"üèÉ",screens:[qa(),Ka()],activeScreenIndex:0},ja={id:"default-simple",name:"Simple",activityType:"cycling",icon:"üìä",screens:[Ua()],activeScreenIndex:0},zi=[le,Ye,Ya,ja],se={profiles:[JSON.parse(JSON.stringify(le)),JSON.parse(JSON.stringify(Ye))],activeProfileId:"default-cycling",unitSystem:"metric",fieldPreferences:{},version:1};function Ga(){return JSON.parse(JSON.stringify(Ye))}function Ja(){return JSON.parse(JSON.stringify(se))}function Xa(n){L();const e=[];return n.power!==!1&&e.push(m("power-current","large")),n.heartrate!==!1&&e.push(m("heartrate-current","medium")),n.cadence!==!1&&e.push(m("cadence-current","medium")),n.speed!==!1&&e.push(m("speed-current","medium")),n.distance!==!1&&e.push(m("distance-total","medium")),n.altitude!==!1&&e.push(m("elevation-current","medium")),e.length===0?Ja():{profiles:[{id:"migrated-profile",name:"Migrated",activityType:"cycling",icon:"üö¥",screens:[{id:"migrated-main",name:"Main",icon:"üìä",layout:"auto",slots:e.map((s,o)=>({...s,position:o+1}))}],activeScreenIndex:0},Ga()],activeProfileId:"migrated-profile",unitSystem:"metric",fieldPreferences:{},version:1}}L(),m("power-3s","large"),m("power-avg","medium"),m("power-normalized","medium"),m("watts-per-kg","medium"),m("cadence-current","medium"),m("heartrate-current","medium");L(),m("heartrate-zone","large"),m("time-elapsed","medium"),m("distance-total","medium"),m("speed-avg","medium"),m("elevation-gain","medium"),m("calories-burned","medium");L(),m("power-current","large"),m("time-lap","large"),m("power-lap-avg","medium"),m("heartrate-current","medium"),m("time-lap-number","medium"),m("time-elapsed","medium");const ft={power:"power-current",heartrate:"heartrate-current",cadence:"cadence-current",speed:"speed-current",distance:"distance-total",altitude:"elevation-current"};class Qa{measurementsState;connectionsState;timeState;calculationManager;activeProfile;carouselComponent=null;unsubscribeUpdater=null;listeners=new Map;constructor(e){this.measurementsState=e.measurementsState,this.connectionsState=e.connectionsState,this.timeState=e.timeState,this.activeProfile=e.initialProfile??le,this.calculationManager=$a(this.measurementsState,this.createWorkoutState(),this.createUserSettings()),this.calculationManager.onUpdate((t,s)=>{this.notifyFieldUpdate(t,s),this.updateCarouselField(t,s),ve.notifyDataChange()})}start(){this.calculationManager.start(),this.startUpdateLoop(),console.log("[DataFieldsManager] Started")}stop(){this.calculationManager.stop(),this.stopUpdateLoop(),console.log("[DataFieldsManager] Stopped")}setProfile(e){this.activeProfile=e,this.carouselComponent&&this.carouselComponent.setProfile(e)}getProfile(){return this.activeProfile}attachToCarousel(e){this.carouselComponent=e,e.setProfile(this.activeProfile),this.updateSensorConnections()}detachFromCarousel(){this.carouselComponent=null}getFieldValue(e){if(!Wt(e))return null;for(const[s,o]of Object.entries(ft))if(o===e)return this.getSensorValue(s);return this.calculationManager.calculateField(e)}onFieldUpdate(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{const s=this.listeners.get(e);s&&(s.delete(t),s.size===0&&this.listeners.delete(e))}}getActiveFields(){const e=new Set;for(const t of this.activeProfile.screens)for(const s of t.slots)e.add(s.fieldId);return Array.from(e)}startUpdateLoop(){this.unsubscribeUpdater||(this.unsubscribeUpdater=ve.subscribe(()=>{this.updateSensorFields(),this.updateSensorConnections()}))}stopUpdateLoop(){this.unsubscribeUpdater&&(this.unsubscribeUpdater(),this.unsubscribeUpdater=null)}updateSensorFields(){for(const[e,t]of Object.entries(ft)){const s=this.getSensorValue(e);this.notifyFieldUpdate(t,s),this.updateCarouselField(t,s)}if(this.timeState){const e=this.getElapsedTime();this.notifyFieldUpdate("time-elapsed",e),this.updateCarouselField("time-elapsed",e)}}updateSensorConnections(){if(!this.carouselComponent)return;const e=this.connectionsState,t=e.power?.isConnected??!1;this.carouselComponent.setSensorConnected("power",t);const s=e.heartrate?.isConnected??!1;this.carouselComponent.setSensorConnected("heartrate",s);const o=e.cadence?.isConnected??!1;this.carouselComponent.setSensorConnected("cadence",o);const a=e.gps?.isConnected??!1;this.carouselComponent.setSensorConnected("speed",a)}getSensorValue(e){const t=this.measurementsState;switch(e){case"power":return this.getLatestValue(t.power);case"heartrate":return this.getLatestValue(t.heartrate);case"cadence":return this.getLatestValue(t.cadence);case"speed":return this.getLatestValue(t.speed);case"distance":return this.getLatestValue(t.distance);case"altitude":return this.getLatestValue(t.altitude);default:return null}}getLatestValue(e){return!e||e.length===0?null:e[e.length-1].value}notifyFieldUpdate(e,t){const s=this.listeners.get(e);if(s)for(const o of s)o(t)}updateCarouselField(e,t){this.carouselComponent&&this.carouselComponent.updateFieldValue(e,t)}createWorkoutState(){const e=this.measurementsState.laps||[],t=e.length,o=(t>0?e[t-1].timestamp:null)??this.timeState?.startTime??null;return{isActive:this.timeState?.running??!1,isPaused:!1,startTime:this.timeState?.startTime??null,elapsedTime:this.getElapsedTime(),movingTime:this.getElapsedTime(),pausedTime:0,currentLap:t+1,lapStartTime:o,lapElapsedTime:o?Date.now()-o:0,laps:e.map((a,i)=>({lapNumber:a.number,startTime:i===0?this.timeState?.startTime??a.timestamp:e[i-1].timestamp,endTime:a.timestamp,duration:a.elapsedMs??0,distance:0,avgPower:null,avgHeartrate:null,avgCadence:null,avgSpeed:null,elevationGain:0}))}}getElapsedTime(){return!this.timeState?.running||!this.timeState.startTime?0:Date.now()-this.timeState.startTime}createUserSettings(){return{unitSystem:"metric",ftp:200,maxHr:190,weight:70,restingHr:60,showCalories:!0,powerZones:Aa,hrZones:Pa}}}function ei(n){return new Qa(n)}const je="bpt-data-fields",ti="bpt-settings",Ht=1;function Ge(){try{const n=localStorage.getItem(je);if(n){const t=JSON.parse(n),s=oi(t);return ai(s)?s:(console.warn("[DataFields] Invalid stored settings, using defaults"),Ce({...se}),{...se})}const e=localStorage.getItem(ti);if(e)try{const t=JSON.parse(e),s=Xa(t);return Ce(s),s}catch{console.warn("[DataFields] Failed to migrate legacy settings")}return{...se}}catch(n){return console.error("[DataFields] Error loading settings:",n),{...se}}}function ni(){const n=Ge();return n.profiles.find(t=>t.id===n.activeProfileId)??n.profiles[0]??le}function Ce(n){try{const e={version:Ht,settings:n};return localStorage.setItem(je,JSON.stringify(e)),!0}catch(e){return console.error("[DataFields] Error saving settings:",e),!1}}function Wi(n){const e=Ge(),t=e.profiles.findIndex(s=>s.id===n.id);return t>=0?e.profiles[t]=n:e.profiles.push(n),Ce(e)}function si(n,e){const t=Ge(),s=t.profiles.find(o=>o.id===n);return s?(s.activeScreenIndex=Math.max(0,Math.min(e,s.screens.length-1)),Ce(t)):!1}function oi(n){let e=n.settings,t=n.version;for(;t<Ht;)t===0&&(e.fieldPreferences=e.fieldPreferences??{}),t++;return e}function ai(n){if(!n||typeof n!="object")return!1;const e=n;return!Array.isArray(e.profiles)||e.profiles.length===0||typeof e.activeProfileId!="string"||!["metric","imperial"].includes(e.unitSystem)?!1:e.profiles.every(ii)}function ii(n){if(!n||typeof n!="object")return!1;const e=n;return!(typeof e.id!="string"||e.id.length===0||typeof e.name!="string"||e.name.length===0||!Array.isArray(e.screens)||e.screens.length===0)}const ri=new Set;typeof window<"u"&&window.addEventListener("storage",n=>{if(n.key===je&&n.newValue)try{const e=JSON.parse(n.newValue);for(const t of ri)t(e.settings)}catch{}});function ci({measurementsState:n,timeState:e,connectionsState:t,streamManager:s}){jn(e);const o=Uo({measurementsState:n});xa(n,t);const a=document.getElementById("dataFieldsCarousel");let i=null;if(a)try{let l=ni();(!l.screens||l.screens.length===0)&&(console.warn("[DataFields] Active profile has no screens, using default"),l=le),i=ei({measurementsState:n,connectionsState:t,timeState:e,initialProfile:l}),i.start(),console.log("[DataFields] Manager initialized with profile:",l.name),customElements.whenDefined("bpt-screen-carousel").then(()=>{i&&a&&i.attachToCarousel(a)}),document.addEventListener("data-fields-profile-changed",u=>{const d=u;i&&d.detail?.profile&&(i.setProfile(d.detail.profile),console.log("[DataFields] Profile updated from settings"))}),a.addEventListener("screen-change",u=>{const d=u;d.detail&&l&&si(l.id,d.detail.screenIndex)})}catch(l){console.error("[DataFields] Failed to initialize:",l)}Sa(),Ta(),wa(),ba(),Go(),Xo(s,e),Qo(),Sn();const c=document.getElementById("toggleDarkMode");c&&ia(c),ma(),bo({measurementsState:n,timeState:e});const r=new La(n,e,{onAutoPause:()=>Mt(e,!0),onAutoResume:()=>_t(e,!0)});return Y.init(n,e),Y.onLap(l=>{const d=n.laps.find(p=>p.number===l);if(d){const p=d.elapsedMs?we(d.elapsedMs):"",h=`Auto Lap ${d.number}${p?` at ${p}`:""}`;E(`üèÅ ${h}`,"info"),y(h,"assertive")}}),O.init(n,e),document.addEventListener("workoutStarted",()=>{r.start(),Y.start(),O.startIntervalAnnouncements()}),document.addEventListener("workoutDiscarded",()=>{r.reset(),Y.reset(),O.reset()}),window.addEventListener("settings-changed",()=>{e.running&&(r.stop(),r.start(),Y.stop(),Y.start(),O.stopIntervalAnnouncements(),O.startIntervalAnnouncements())}),va(n,e).then(l=>{l&&(console.log("Workout recovered from previous session"),document.dispatchEvent(new CustomEvent("workout-recovered")))}),Mo({measurementsState:n,timeState:e,zoneState:o}),Ao(n,o),Lo(),Po({measurementsState:n,timeState:e,zoneState:o}),o}const li=async()=>ke.connectCadence(),di=async()=>ke.connectHeartRate(),ui=async()=>ke.connectPower(),mi=async()=>ke.connectTreadmill(),Be=vt("BackgroundGeolocation"),pi=()=>{let n=null;return{start:async e=>{try{n=await Be.addWatcher({backgroundMessage:"Tracking your ride.",backgroundTitle:"Bike Power Tracker",requestPermissions:!0,stale:!1,distanceFilter:10},(t,s)=>{if(s)return s.code==="NOT_AUTHORIZED"&&window.confirm(`This app needs your location, but does not have permission.

Open settings now?`)&&Be.openSettings(),console.error(s);if(t){const o={timestamp:t.time||Date.now(),lat:t.latitude,lon:t.longitude,accuracy:t.accuracy,altitude:t.altitude,speed:t.speed,heading:t.bearing};e(o)}})}catch(t){console.error("Error starting native GPS:",t)}},stop:async()=>{n&&(await Be.removeWatcher({id:n}),n=null)}}},hi=()=>{let n=null;return{start:async e=>{if(!("geolocation"in navigator)){console.warn("Geolocation is not supported by this browser.");return}n=navigator.geolocation.watchPosition(t=>{const s={timestamp:t.timestamp,lat:t.coords.latitude,lon:t.coords.longitude,accuracy:t.coords.accuracy,altitude:t.coords.altitude,speed:t.coords.speed,heading:t.coords.heading};e(s)},t=>{console.error("Error watching position:",t)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},stop:async()=>{n!==null&&(navigator.geolocation.clearWatch(n),n=null)}}},fi={create:()=>Oe.isNativePlatform()?pi():hi()},gi=async n=>{const e=fi.create();return await e.start(n),{stop:async()=>e.stop(),deviceName:"GPS Sensor"}};function D(n){return document.getElementById(n)}const $e={get power(){return{display:D("power"),connect:D("connectPower")}},get heartrate(){return{display:D("heartrate"),connect:D("connectHeartrate")}},get cadence(){return{display:D("cadence"),connect:D("connectCadence")}},get gps(){return{display:null,connect:D("connectGps")}},get speed(){return{display:D("speed"),connect:null}},get distance(){return{display:D("distance"),connect:null}},get altitude(){return{display:D("altitude"),connect:null}},get treadmill(){return{display:D("value-incline"),connect:D("connectTreadmill")}},get treadmillSpeed(){return{display:D("treadmillSpeed"),connect:null}}},Zt={power:"Power Meter",heartrate:"Heart Rate Monitor",cadence:"Cadence Sensor",speed:"Speed Sensor",distance:"Distance Sensor",altitude:"Altimeter",gps:"GPS",treadmill:"Treadmill",treadmillSpeed:"Treadmill Speed",energy:"Energy"},qt={power:"‚ö°",heartrate:"‚ù§Ô∏è",cadence:"üö¥",speed:"üí®",distance:"üìè",altitude:"üèîÔ∏è",gps:"üìç",treadmill:"üèÉ",treadmillSpeed:"üèÉ",energy:"üî•"};function yi(n,e){const t=Zt[e],s=n instanceof Error?n.message:String(n),o=n instanceof Error?n.name:"";return s.includes("User cancelled")||s.includes("cancelled the requestDevice")?{title:"Connection Cancelled",message:`${t} pairing was cancelled.`,suggestions:["Click the connect button to try again","Make sure your sensor is powered on and in range"],canRetry:!0}:s.includes("Bluetooth adapter not available")||s.includes("Web Bluetooth API is not available")||o==="NotFoundError"&&s.includes("Bluetooth")?{title:"Bluetooth Unavailable",message:"Bluetooth is not available on this device or browser.",suggestions:["Check that Bluetooth is enabled in your device settings","Try using Chrome, Edge, or another browser that supports Web Bluetooth","On macOS, ensure Bluetooth permissions are granted in System Preferences","On Windows, check that your Bluetooth adapter is working"],canRetry:!1}:s.includes("No Bluetooth devices")||s.includes("No devices found")||o==="NotFoundError"&&!s.includes("Bluetooth")?{title:"No Sensors Found",message:`No compatible ${t.toLowerCase()} was found nearby.`,suggestions:["Make sure your sensor is powered on","Wake up the sensor by spinning the pedals or moving","Bring the sensor closer to your device","Check that the sensor battery is not depleted","Ensure the sensor is not connected to another device"],canRetry:!0}:s.includes("GATT")||s.includes("Connection failed")||s.includes("connect")&&s.includes("fail")?{title:"Connection Failed",message:`Could not connect to the ${t.toLowerCase()}.`,suggestions:["Try moving closer to the sensor","Power cycle the sensor (turn off and on again)","Check that no other device is connected to this sensor","Restart Bluetooth on your device","If using a phone, try closing other Bluetooth apps"],canRetry:!0}:s.includes("SecurityError")||s.includes("permission")||o==="SecurityError"?{title:"Permission Denied",message:"Bluetooth permission was denied.",suggestions:["Check your browser settings to allow Bluetooth access",'If prompted, click "Allow" to grant Bluetooth permission',"Try refreshing the page and connecting again","On some browsers, you may need to access this site over HTTPS"],canRetry:!0}:s.includes("NetworkError")||s.includes("timeout")||o==="NetworkError"?{title:"Connection Timed Out",message:`The connection to your ${t.toLowerCase()} timed out.`,suggestions:["Make sure the sensor is in range and powered on","Try moving closer to the sensor","Power cycle the sensor and try again","Check for interference from other wireless devices"],canRetry:!0}:s.includes("Service")&&s.includes("not found")?{title:"Incompatible Sensor",message:`This device doesn't appear to be a compatible ${t.toLowerCase()}.`,suggestions:["Make sure you selected the correct sensor type","Check that your sensor supports standard Bluetooth protocols","Some sensors may require a firmware update","Consult your sensor's documentation for compatibility"],canRetry:!0}:{title:"Connection Error",message:`Failed to connect to ${t.toLowerCase()}.`,suggestions:["Make sure the sensor is powered on and nearby","Try power cycling the sensor","Restart Bluetooth on your device","Refresh the page and try again"],canRetry:!0}}function vi(n){const e=document.createElement("div");e.className="connection-error-content";const t=document.createElement("p");if(t.className="connection-error-message",t.textContent=n.message,e.appendChild(t),n.suggestions.length>0){const s=document.createElement("div");s.className="connection-error-troubleshooting";const o=document.createElement("h3");o.textContent="üí° Troubleshooting Tips",s.appendChild(o);const a=document.createElement("ul");a.setAttribute("role","list"),n.suggestions.forEach(i=>{const c=document.createElement("li");c.textContent=i,a.appendChild(c)}),s.appendChild(a),e.appendChild(s)}return e}function wi(n,e,t){return new Promise(s=>{const o=yi(n,e),a=qt[e],i=vi(o);console.error(`[${e}] Connection error:`,n),y(`${o.title}. ${o.message}`,"assertive");let c=null;const r=[];r.push({text:"Dismiss",variant:"secondary",onClick:()=>{c?.(),s(!1)}}),o.canRetry&&r.push({text:"Try Again",variant:"primary",onClick:()=>{c?.(),t&&t(),s(!0)}}),c=re({title:o.title,icon:a,content:i,buttons:r,closeOnOverlay:!0,onClose:()=>s(!1)})})}function bi(n,e){const t=Zt[n],s=qt[n],o=document.createElement("div");o.className="connection-error-content";const a=document.createElement("p");a.className="connection-error-message",a.textContent=`Lost connection to your ${t.toLowerCase()} and automatic reconnection failed.`,o.appendChild(a);const i=document.createElement("div");i.className="connection-error-troubleshooting";const c=document.createElement("h3");c.textContent="üí° To reconnect:",i.appendChild(c);const r=document.createElement("ul");r.setAttribute("role","list"),["Make sure the sensor is still powered on","Move closer to the sensor",'Click "Try Again" to reconnect manually'].forEach(u=>{const d=document.createElement("li");d.textContent=u,r.appendChild(d)}),i.appendChild(r),o.appendChild(i),y(`${t} connection lost. Automatic reconnection failed.`,"assertive");let l=null;l=re({title:"Connection Lost",icon:s,content:o,buttons:[{text:"Dismiss",variant:"secondary",onClick:()=>{l?.()}},{text:"Try Again",variant:"primary",onClick:()=>{l?.(),e?.()}}],closeOnOverlay:!0})}const Si={power:"‚ö°",heartrate:"‚ù§Ô∏è",cadence:"üö¥",speed:"üí®",distance:"üìè",altitude:"üèîÔ∏è",gps:"üìç",treadmill:"üèÉ",treadmillSpeed:"üèÉ"},he=n=>n.charAt(0).toUpperCase()+n.slice(1),Ei=({connectionsState:n,measurementsState:e})=>{const t=(r,l,u)=>{const d=$e[r]?.connect;if(!d)return;const p=he(r),h=Si[r];switch(l){case"connected":u?d.textContent=`${h} Disconnect ${p} (${u})`:d.textContent=`${h} Disconnect ${p}`;break;case"reconnecting":d.textContent=`${h} Reconnecting ${p}...`;break;case"disconnected":d.textContent=`${h} Connect ${p}`;break}},s=r=>{const l=n[r];if(l&&typeof l.disconnect=="function"){l.disconnect(),l.disconnect=null,l.isConnected=!1,t(r,"disconnected");const u=$e[r]?.display;u&&(u.textContent="--")}},o=(r,l)=>u=>{const d=he(r);switch(u){case"connected":t(r,"connected",l),E(`${d} sensor reconnected`,"success");break;case"reconnecting":t(r,"reconnecting");break;case"failed":n[r]&&(n[r].isConnected=!1,n[r].disconnect=null),t(r,"disconnected"),bi(r,()=>a(r));break}},a=async r=>{try{t(r,"reconnecting");let l;if(r==="gps"){const f=await gi(w=>{e.addGps(w)}),g=n[r];g&&(g.disconnect=async()=>{await f.stop()},g.isConnected=!0),t(r,"connected",f.deviceName),E(`Connected to ${he(r)}`,"success");return}else if(r==="treadmill")l=await mi(),l.addListener(f=>{e.addTreadmillData(f)});else if(r==="power")l=await ui(),l.addListener(f=>{e.addPower(f)});else if(r==="heartrate")l=await di(),l.addListener(f=>{e.addHeartrate(f)});else if(r==="cadence")l=await li(),l.addListener(f=>{e.addCadence(f)});else return;const{disconnect:u,deviceName:d,onStatusChange:p}=l,h=n[r];h&&(h.disconnect=u,h.isConnected=!0),t(r,"connected",d),E(`Connected to ${he(r)}`,"success"),p&&p(o(r,d||"Sensor"))}catch(l){t(r,"disconnected"),await wi(l,r,()=>a(r))||n[r]&&(n[r].isConnected=!1)}},i=r=>{const l=$e[r]?.connect;if(!l)return;const u=d=>{d.stopPropagation(),n[r]?.isConnected?s(r):a(r)};l.addEventListener("click",u)};["power","heartrate","cadence","gps","treadmill"].forEach(i)};class Ti{isStreaming=!1;isPaused=!1;streamName=null;streamInterval=null;measurementsState;timeState;constructor(e,t){this.measurementsState=e,this.timeState=t}async startStreaming(e){if(this.isStreaming)return this.streamName;try{const t=e||`workout-${Date.now()}`,s=await Wo(t);if(!s.success)throw new Error("Failed to create stream");return this.streamName=s.streamName,this.isStreaming=!0,this.isPaused=!1,this._startStreamingLoop(),this.streamName}catch(t){throw console.error("Failed to start streaming:",t),this.streamName=null,t}}pauseStreaming(){this.isStreaming&&(this.isPaused=!0)}resumeStreaming(){this.isStreaming&&(this.isPaused=!1)}async stopStreaming(){this.isStreaming&&(this.isStreaming=!1,this.isPaused=!1,this.streamInterval&&(clearInterval(this.streamInterval),this.streamInterval=null),this.streamName=null)}getStatus(){return{isStreaming:this.isStreaming,isPaused:this.isPaused,streamName:this.streamName}}_startStreamingLoop(){this.streamInterval=setInterval(async()=>{if(!(!this.isStreaming||this.isPaused||!this.timeState.running))try{await this._sendCurrentData()}catch(e){console.error("Error sending workout data:",e)}},1e3)}async _sendCurrentData(){if(!this.streamName)return;const e=this._getLatestValue("power"),t=this._getLatestValue("cadence"),s=this._getLatestValue("heartrate"),o=this._getLatestValue("speed"),a=this._getLatestValue("distance"),i=this._getLatestValue("altitude"),c=this._getLatestTreadmillIncline();if(e===null&&t===null&&s===null&&o===null&&a===null&&i===null&&c===null)return;const r=this.timeState.running&&this.timeState.startTime?Date.now()-this.timeState.startTime:this.timeState.endTime&&this.timeState.startTime?this.timeState.endTime-this.timeState.startTime:0;await Yo(this.streamName,{timestamp:Date.now(),elapsed:Math.floor(r/1e3).toString(),power:e,cadence:t,heartrate:s,speed:o,distance:a,altitude:i,incline:c})}_getLatestValue(e){const t=this.measurementsState[e];if(!Array.isArray(t)||t.length===0)return null;const s=t[t.length-1];return Date.now()-s.timestamp>5e3?null:s.value}_getLatestTreadmillIncline(){const e=this.measurementsState.treadmill;if(!Array.isArray(e)||e.length===0)return null;const t=e[e.length-1];return Date.now()-t.timestamp>5e3?null:t.incline}}function Ci({measurementsState:n,connectionsState:e,timeState:t}){return Ei({connectionsState:e,measurementsState:n}),{streamManager:new Ti(n,t)}}$("bpt-metric-display",()=>T(()=>import("./MetricDisplay-BfXrPd_G.js"),__vite__mapDeps([11,12,13,1,3,4,5])));$("bpt-power-gauge",()=>T(()=>import("./PowerGauge-qRg1R1d9.js"),__vite__mapDeps([14,12,13,1,3,4,5])));$("bpt-zone-gauge",()=>T(()=>import("./ZoneGauge-ipmL3gGm.js"),__vite__mapDeps([15,12,1,3,4,5])));$("bpt-live-chart",()=>T(()=>import("./LiveChart-Cwz1YVA7.js"),__vite__mapDeps([16,1,3,4,5])));$("bpt-workout-timer",()=>T(()=>import("./WorkoutTimer-Be8nDo8q.js"),__vite__mapDeps([17,1,3,4,5])));$("bpt-toast",()=>T(()=>Promise.resolve().then(()=>Wn),void 0));$("bpt-modal",()=>T(()=>import("./Modal-CQ5JUH4A.js"),__vite__mapDeps([18,1,3,4,5])));$("bpt-data-field",()=>T(()=>import("./DataFieldComponent-Dcvj5OLm.js"),__vite__mapDeps([19,1,3,4,5])));$("bpt-data-screen",()=>T(()=>import("./DataScreenComponent-BF5-kXqr.js"),__vite__mapDeps([20,19,1,3,4,5])));$("bpt-screen-carousel",()=>T(()=>import("./ScreenCarouselComponent-BovDvLZo.js"),__vite__mapDeps([21,20,19,1,3,4,5])));$("bpt-field-picker",()=>T(()=>import("./FieldPickerComponent-d7Wn2bpv.js"),__vite__mapDeps([22,1,3,4,5])));$("bpt-screen-editor",()=>T(()=>import("./ScreenEditorComponent-BujVgPqb.js"),__vite__mapDeps([23,8,22,1,3,4,5])));$("bpt-profile-settings",()=>T(()=>import("./ProfileSettingsComponent-Bv4PusqM.js"),__vite__mapDeps([24,8,23,22,1,3,4,5])));const gt=()=>{try{const n=hn(),{measurementsState:e,connectionsState:t,timeState:s}=n;fn({measurementsState:e,connectionsState:t});const{streamManager:o}=Ci({measurementsState:e,connectionsState:t,timeState:s});ci({measurementsState:e,timeState:s,connectionsState:t,streamManager:o});const a=wn();a.start(),window.router=a}catch(n){console.error("Failed to initialize app:",n)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",gt,{once:!0}):gt();console.log("Bike Power Tracker initialized");export{Ue as A,zn as B,tt as C,Aa as D,Wi as E,ze as F,st as G,k as V,xn as W,Pa as a,ni as b,zi as c,Ui as d,Vi as e,Oi as f,Wt as g,Bn as h,Fi as i,ao as j,Pn as k,Ge as l,Dn as m,Di as n,_i as o,Pi as p,y as q,Ri as r,Ce as s,Mi as t,Ai as u,Bi as v,Qo as w,Ie as x,$i as y,Ni as z};
//# sourceMappingURL=index-B84kQ3Pu.js.map
