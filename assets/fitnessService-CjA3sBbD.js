import{E as p,e as N,F as y,G as m,H as C}from"./feature-bluetooth-CV0r-lfI.js";import"./vendor-core-Dob3nYDb.js";async function D(){console.log("PMC Recalculation started");const r=await N();if(await y(),r.length===0){console.log("PMC Recalculation: No workouts found.");return}const i=new Map;if(r.forEach(a=>{const o=new Date(a.startTime).toISOString().split("T")[0];let e=0;const l=a;l.summary&&l.summary.trainingLoad?e=l.summary.trainingLoad:l.trainingLoad&&(e=l.trainingLoad),e>0&&i.set(o,(i.get(o)||0)+e)}),i.size===0){console.log("PMC Recalculation: No workouts with TSS found from "+r.length+" workouts.");return}const u=Array.from(i.keys()).sort(),t=new Date(u[0]),d=new Date;t.setUTCHours(0,0,0,0),d.setUTCHours(0,0,0,0);const w=[];let c=0,s=0;const n=new Date(t);for(;n<=d;){const a=n.toISOString().split("T")[0],o=i.get(a)||0,{ctl:e,atl:l,tsb:g}=m(c,s,o);w.push({date:a,tss:o,ctl:Number(e.toFixed(2)),atl:Number(l.toFixed(2)),tsb:Number(g.toFixed(2))}),c=e,s=l,n.setUTCDate(n.getUTCDate()+1)}await C(w)}async function P(r,i){if(i<=0)return;const u=r.toISOString().split("T")[0];let t=await p();if(t.length===0&&(await D(),t=await p(),t.length===0)){const{ctl:s,atl:n,tsb:a}=m(0,0,i);await C([{date:u,tss:i,ctl:Number(s.toFixed(2)),atl:Number(n.toFixed(2)),tsb:Number(a.toFixed(2))}]);return}const d=t.findIndex(s=>s.date===u);let w=!1,c=0;if(d!==-1)t[d].tss+=i,c=d;else{const s=t[t.length-1],n=new Date(s.date),a=new Date(u);if(a>n)w=!0,c=t.length;else if(a<new Date(t[0].date)){await D();return}else{await D();return}}if(w){const s=t[t.length-1];let n=s.ctl,a=s.atl;const o=new Date(s.date);o.setUTCDate(o.getUTCDate()+1);const e=new Date(u),l=new Date;l.setUTCHours(0,0,0,0);const g=e>l?e:l,f=[];for(;o<=g;){const b=o.toISOString().split("T")[0],h=b===u?i:0,{ctl:T,atl:x,tsb:S}=m(n,a,h);f.push({date:b,tss:h,ctl:Number(T.toFixed(2)),atl:Number(x.toFixed(2)),tsb:Number(S.toFixed(2))}),n=T,a=x,o.setUTCDate(o.getUTCDate()+1)}await C(f)}else{let s=c>0?t[c-1].ctl:0,n=c>0?t[c-1].atl:0;const a=[];for(let o=c;o<t.length;o++){const e=t[o],{ctl:l,atl:g,tsb:f}=m(s,n,e.tss);e.ctl=Number(l.toFixed(2)),e.atl=Number(g.toFixed(2)),e.tsb=Number(f.toFixed(2)),a.push(e),s=e.ctl,n=e.atl}await C(a)}}async function U(){try{let r=await p();return r.length===0&&(console.log("No PMC data found, attempting recalculation..."),await D(),r=await p()),r}catch(r){return console.error("Failed to get PMC data:",r),[]}}export{P as addWorkoutToPMC,U as getClientPMCData,D as recalculatePMC};
//# sourceMappingURL=fitnessService-CjA3sBbD.js.map
